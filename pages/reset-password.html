<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Reset Password â€” CardFlow</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#FAFBFC">
    <script>(function(){var t=localStorage.getItem("cardflow-theme");if(!t&&window.matchMedia&&window.matchMedia("(prefers-color-scheme:dark)").matches)t="dark";if(t==="dark")document.documentElement.setAttribute("data-theme","dark");})()</script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="stylesheet" href="/theme.css">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .auth-container{
            width:100%;
            max-width:400px;
        }
        .auth-logo{
            text-align:center;
            margin-bottom:40px;
        }
        .auth-logo h1{
            font-size:28px;
            font-weight:700;
            background:linear-gradient(135deg,var(--accent),var(--accent-light));
            -webkit-background-clip:text;
            -webkit-text-fill-color:transparent;
            background-clip:text;
        }
        .auth-logo p{
            color:var(--text-muted);
            font-size:14px;
            margin-top:8px;
        }
        .auth-card{
            background:var(--bg-card);
            border-radius:16px;
            padding:32px 24px;
            border:1px solid var(--border);
        }
        .auth-card h2{
            font-size:20px;
            font-weight:600;
            margin-bottom:24px;
            text-align:center;
        }
        .form-group{
            margin-bottom:16px;
        }
        .form-group label{
            display:block;
            font-size:13px;
            font-weight:500;
            color:var(--text-secondary);
            margin-bottom:6px;
        }
        .form-group input{
            width:100%;
            padding:12px 16px;
            background:var(--bg-elevated);
            border:1.5px solid var(--border);
            border-radius:10px;
            color:var(--text-primary);
            font-family:inherit;
            font-size:15px;
            outline:none;
            transition:border-color .2s;
        }
        .form-group input:focus{
            border-color:var(--accent);
        }
        .form-group input::placeholder{
            color:var(--text-muted);
        }
        .btn-primary{
            width:100%;
            padding:13px;
            background:var(--accent);
            color:#fff;
            border:none;
            border-radius:10px;
            font-family:inherit;
            font-size:15px;
            font-weight:600;
            cursor:pointer;
            transition:opacity .2s;
            margin-top:8px;
        }
        .btn-primary:active{opacity:.8}
        .btn-primary:disabled{opacity:.5;cursor:not-allowed}
        .error-msg{
            background:rgba(239,68,68,.1);
            border:1px solid rgba(239,68,68,.3);
            color:#fca5a5;
            padding:10px 14px;
            border-radius:8px;
            font-size:13px;
            margin-bottom:16px;
            display:none;
        }
        .error-msg.show{display:block}
        .success-msg{
            background:rgba(16,185,129,.1);
            border:1px solid rgba(16,185,129,.3);
            color:#6ee7b7;
            padding:10px 14px;
            border-radius:8px;
            font-size:13px;
            margin-bottom:16px;
            display:none;
        }
        .success-msg.show{display:block}
        .auth-footer{
            text-align:center;
            margin-top:20px;
            font-size:14px;
            color:var(--text-muted);
        }
        .auth-footer a{
            color:var(--accent-light);
            text-decoration:none;
            font-weight:500;
        }
        .auth-footer a:hover{text-decoration:underline}
        .pw-toggle{
            position:absolute;
            right:12px;
            top:50%;
            transform:translateY(-50%);
            background:none;
            border:none;
            cursor:pointer;
            padding:4px;
            color:var(--text-muted);
            display:flex;
            align-items:center;
        }
        .pw-toggle:hover{color:var(--text-secondary)}
        .pw-toggle svg{width:20px;height:20px}
        .pw-wrapper{position:relative}
        .pw-wrapper input{padding-right:44px}
    </style>
    <script src="/theme.js" defer></script>
</head>
<body>
<div class="auth-container">
    <div class="auth-logo">
        <h1>CardFlow</h1>
        <p>Set your new password</p>
    </div>
    <div class="auth-card">
        <h2>Reset Password</h2>
        <div id="errorMsg" class="error-msg"></div>
        <div id="successMsg" class="success-msg"></div>
        <form id="resetForm" onsubmit="handleReset(event)">
            <div class="form-group">
                <label for="password">New Password</label>
                <div class="pw-wrapper">
                    <input type="password" id="password" placeholder="At least 6 characters" required autocomplete="new-password" minlength="6">
                    <button type="button" class="pw-toggle" onclick="togglePw(this)" aria-label="Show password">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                    </button>
                </div>
            </div>
            <div class="form-group">
                <label for="confirmPassword">Confirm Password</label>
                <div class="pw-wrapper">
                    <input type="password" id="confirmPassword" placeholder="Re-enter your password" required autocomplete="new-password">
                    <button type="button" class="pw-toggle" onclick="togglePw(this)" aria-label="Show password">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                    </button>
                </div>
            </div>
            <button type="submit" class="btn-primary" id="resetBtn">Reset Password</button>
        </form>
    </div>
    <div class="auth-footer">
        <a href="login">Back to login</a>
    </div>
</div>

<script>
function escHtml(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}

function togglePw(btn) {
    var input = btn.parentElement.querySelector('input');
    var show = input.type === 'password';
    input.type = show ? 'text' : 'password';
    btn.innerHTML = show
        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>'
        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>';
    btn.setAttribute('aria-label', show ? 'Hide password' : 'Show password');
}

var token = new URLSearchParams(window.location.search).get('token');

if (!token) {
    document.getElementById('resetForm').style.display = 'none';
    var el = document.getElementById('errorMsg');
    el.textContent = 'Missing reset token. Please use the link from your email.';
    el.classList.add('show');
} else {
    document.getElementById('password').focus();
}

function handleReset(e) {
    e.preventDefault();
    var errorEl = document.getElementById('errorMsg');
    var successEl = document.getElementById('successMsg');
    errorEl.classList.remove('show');
    successEl.classList.remove('show');

    var password = document.getElementById('password').value;
    var confirm = document.getElementById('confirmPassword').value;

    if (password.length < 6) {
        errorEl.textContent = 'Password must be at least 6 characters.';
        errorEl.classList.add('show');
        return;
    }
    if (password !== confirm) {
        errorEl.textContent = 'Passwords do not match.';
        errorEl.classList.add('show');
        return;
    }

    var btn = document.getElementById('resetBtn');
    btn.disabled = true;
    btn.textContent = 'Resetting...';

    fetch('/api/auth/reset-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token: token, password: password })
    })
    .then(function(r) { return r.json().then(function(d) { return { ok: r.ok, data: d }; }); })
    .then(function(result) {
        if (result.ok) {
            document.getElementById('resetForm').style.display = 'none';
            successEl.innerHTML = escHtml(result.data.message || 'Password has been reset.') + ' <a href="login" style="color:var(--accent-light);text-decoration:underline">Log in now</a>';
            successEl.classList.add('show');
        } else {
            btn.disabled = false;
            btn.textContent = 'Reset Password';
            errorEl.textContent = result.data.error || 'Failed to reset password.';
            errorEl.classList.add('show');
        }
    })
    .catch(function() {
        btn.disabled = false;
        btn.textContent = 'Reset Password';
        errorEl.textContent = 'Failed to reset password. Please try again.';
        errorEl.classList.add('show');
    });
}
</script>
</body>
</html>
