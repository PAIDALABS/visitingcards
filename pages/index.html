<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Digital Business Card — CardFlow</title>
    <meta name="description" content="View and save this digital business card. Tap to connect, share contact details instantly, and capture leads with CardFlow.">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#FAFBFC">
    <script>(function(){var t=localStorage.getItem("cardflow-theme");if(!t&&window.matchMedia&&window.matchMedia("(prefers-color-scheme:dark)").matches)t="dark";if(t==="dark")document.documentElement.setAttribute("data-theme","dark");})()</script>
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" href="/favicon-32.png">
    <meta property="og:title" content="Digital Business Card">
    <meta property="og:description" content="Tap to connect. Share your digital business card instantly.">
    <meta property="og:type" content="profile">
    <meta property="og:image" content="https://card.cardflow.cloud/icon-512.png">
    <meta property="og:url" content="https://card.cardflow.cloud">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Digital Business Card — CardFlow">
    <meta name="twitter:description" content="Tap to connect. Share your digital business card instantly.">
    <meta name="twitter:image" content="https://card.cardflow.cloud/icon-512.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"></noscript>
    <link rel="stylesheet" href="/theme.css">

    <style>
        /* Body: light page wrapper for visitor card */
        body{
            min-height:100vh;
            min-height:100dvh;
        }
        /* Force dark palette on card display areas regardless of theme */
        #waiting, .hero, .card-body, .card-section {
            --accent: #14B8A6;
            --accent-light: #2DD4BF;
            --accent-glow: rgba(20,184,166,.25);
            --accent-subtle: rgba(20,184,166,.08);
            --accent-secondary: #2DD4BF;
            --success: #10B981;
            --text-primary: #F1F5F9;
            --text-secondary: #94A3B8;
            --text-muted: #64748B;
            --border: #2E3345;
            --glass-bg: rgba(255,255,255,.03);
            --glass-border: rgba(255,255,255,.08);
            --glass-hover: rgba(255,255,255,.12);
            --glass-text: rgba(255,255,255,.5);
        }

        /* ── Waiting Screen ── */
        #waiting{
            background:linear-gradient(160deg,var(--bg-card) 0%,var(--bg-base) 100%);
            min-height:100vh;
            min-height:100dvh;
            display:flex;
            flex-direction:column;
            position:relative;
            overflow:hidden;
        }
        #waiting::before{
            content:'';
            position:absolute;
            top:-50%;left:-50%;
            width:200%;height:200%;
            background:radial-gradient(circle at 30% 30%,var(--accent-subtle) 0%,transparent 50%),
                        radial-gradient(circle at 70% 70%,var(--accent-subtle) 0%,transparent 40%);
            pointer-events:none;
        }
        .wait-header{
            padding:48px 24px 32px;
            padding-top:calc(48px + env(safe-area-inset-top));
            display:flex;
            flex-direction:column;
            align-items:center;
            text-align:center;
            position:relative;
            z-index:1;
        }
        .wait-avatar{
            width:96px;
            height:96px;
            border-radius:50%;
            background:linear-gradient(135deg,var(--accent),var(--accent-secondary));
            border:3px solid var(--glass-hover);
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:30px;
            font-weight:700;
            color:#fff;
            letter-spacing:1px;
            position:relative;
            margin-bottom:24px;
            box-shadow:0 8px 32px var(--accent-glow);
        }
        .wait-avatar::after{
            content:'';
            position:absolute;
            inset:-12px;
            border-radius:50%;
            border:2px solid var(--accent-glow);
            animation:ping 2s ease-out infinite;
        }
        @keyframes ping{
            0%{transform:scale(1);opacity:.6}
            100%{transform:scale(1.5);opacity:0}
        }
        .wait-text{
            color:var(--text-primary);
            font-size:20px;
            font-weight:600;
            margin-bottom:8px;
            letter-spacing:-.3px;
        }
        .wait-sub{
            color:var(--text-muted);
            font-size:14px;
            display:flex;
            align-items:center;
            gap:8px;
        }
        .dots{display:inline-flex;gap:5px}
        .dots span{
            width:6px;
            height:6px;
            border-radius:50%;
            background:var(--accent);
            animation:dot 1.4s ease-in-out infinite;
        }
        .dots span:nth-child(2){animation-delay:.2s}
        .dots span:nth-child(3){animation-delay:.4s}
        @keyframes dot{
            0%,80%,100%{opacity:.3;transform:scale(1)}
            40%{opacity:1;transform:scale(1.3)}
        }
        .wait-phone{
            margin-top:24px;
            display:inline-flex;
            align-items:center;
            gap:10px;
            background:var(--glass-border);
            padding:14px 22px;
            border-radius:14px;
            text-decoration:none;
            border:1px solid var(--border);
            backdrop-filter:blur(10px);
            -webkit-backdrop-filter:blur(10px);
            transition:all .2s ease;
        }
        .wait-phone:active{transform:scale(.97);background:var(--glass-hover)}
        .wait-phone svg{width:18px;height:18px;fill:var(--accent)}
        .wait-phone span{color:var(--text-secondary);font-size:15px;font-weight:500}

        /* ── Timeout notice ── */
        .timeout-notice{
            display:none;
            margin-top:24px;
            text-align:center;
            padding:0 24px;
        }
        .timeout-notice.show{display:block}
        .timeout-notice p{
            font-size:14px;
            color:var(--text-muted);
            margin-bottom:4px;
        }

        /* ── Share form ── */
        .wait-form{
            flex:1;
            padding:24px;
            padding-bottom:calc(32px + env(safe-area-inset-bottom));
            position:relative;
            z-index:1;
        }
        .wait-form-title{
            font-size:11px;
            font-weight:600;
            color:var(--text-muted);
            text-transform:uppercase;
            letter-spacing:2px;
            margin-bottom:20px;
            text-align:center;
        }
        .wf-field{margin-bottom:12px}
        .wf-field input{
            width:100%;
            padding:15px 18px;
            border:1.5px solid var(--border);
            border-radius:14px;
            font-family:inherit;
            font-size:16px;
            color:var(--text-primary);
            background:var(--glass-bg);
            outline:none;
            -webkit-appearance:none;
            transition:all .2s ease;
        }
        .wf-field input::placeholder{color:var(--text-muted)}
        .wf-field input:focus{
            border-color:var(--accent);
            background:var(--accent-subtle);
            box-shadow:0 0 0 3px var(--accent-subtle);
        }
        .wf-row{display:flex;gap:12px;margin-bottom:16px}
        .wf-photo-btn{
            display:flex;
            align-items:center;
            gap:10px;
            padding:14px 18px;
            border:1.5px solid var(--border);
            border-radius:14px;
            background:var(--glass-bg);
            font-family:inherit;
            font-size:14px;
            color:var(--text-muted);
            cursor:pointer;
            flex:1;
            transition:all .2s ease;
        }
        .wf-photo-btn:active{border-color:var(--accent);background:var(--accent-subtle)}
        .wf-photo-btn svg{width:20px;height:20px;fill:var(--text-muted)}
        .wf-preview{
            width:52px;
            height:52px;
            border-radius:12px;
            object-fit:cover;
            display:none;
            border:2px solid var(--accent);
        }
        .wf-scan-btn{
            display:flex;
            align-items:center;
            justify-content:center;
            gap:12px;
            width:100%;
            padding:16px 18px;
            border:2px dashed var(--glass-hover);
            border-radius:16px;
            background:linear-gradient(135deg,var(--accent-subtle),var(--accent-subtle));
            font-family:inherit;
            font-size:15px;
            font-weight:600;
            color:var(--text-secondary);
            cursor:pointer;
            margin-bottom:16px;
            transition:all .2s ease;
        }
        .wf-scan-btn:active{transform:scale(.98);border-color:var(--accent)}
        .wf-scan-btn svg{width:24px;height:24px;fill:var(--accent)}
        .wf-scan-btn.scanning{
            border-color:var(--accent);
            background:linear-gradient(135deg,var(--accent-subtle),var(--accent-subtle));
            color:var(--accent);
        }
        .wf-scan-btn.scanning svg{fill:var(--accent);animation:pulse-icon 1s ease-in-out infinite}
        @keyframes pulse-icon{0%,100%{opacity:1}50%{opacity:.4}}
        .wf-scan-status{
            font-size:13px;
            color:var(--accent);
            text-align:center;
            margin-bottom:12px;
            display:none;
        }
        .wf-scan-status.show{display:block}
        .wf-or{
            text-align:center;
            font-size:13px;
            color:var(--text-muted);
            margin-bottom:16px;
            cursor:pointer;
            padding:10px;
            display:flex;
            align-items:center;
            justify-content:center;
            gap:8px;
            transition:color .2s;
        }
        .wf-or:active{color:var(--text-secondary)}
        .wf-or svg{width:16px;height:16px;fill:currentColor;transition:transform .3s}
        .wf-or.open svg{transform:rotate(180deg)}
        .wf-manual{
            max-height:0;
            overflow:hidden;
            transition:max-height .3s ease;
        }
        .wf-manual.open{max-height:400px}
        .wf-submit{
            width:100%;
            padding:17px;
            border:none;
            border-radius:14px;
            font-family:inherit;
            font-size:16px;
            font-weight:600;
            color:#fff;
            background:linear-gradient(135deg,var(--accent),var(--accent-secondary));
            cursor:pointer;
            -webkit-tap-highlight-color:transparent;
            box-shadow:0 4px 20px var(--accent-glow);
            transition:all .2s ease;
        }
        .wf-submit:active{transform:scale(.98);box-shadow:0 2px 12px var(--accent-glow)}
        .wf-submit.sent{background:linear-gradient(135deg,var(--success),#059669)}
        .wf-submit:disabled{opacity:.5;box-shadow:none}

        /* ── Card Screen ── */
        #card{display:none}
        #card.show{display:block;animation:cardFadeIn .5s ease}
        @keyframes cardFadeIn{from{opacity:0}to{opacity:1}}
        .hero{
            padding:56px 28px 40px;
            padding-top:calc(56px + env(safe-area-inset-top));
            text-align:center;
            position:relative;
            overflow:hidden;
        }
        .hero::before{
            content:'';
            position:absolute;
            top:-50%;left:-50%;
            width:200%;height:200%;
            background:radial-gradient(circle at 30% 20%,var(--glass-hover) 0%,transparent 50%);
            pointer-events:none;
        }
        .hero::after{
            content:'';
            position:absolute;
            bottom:0;left:0;right:0;
            height:80px;
            background:linear-gradient(transparent,var(--glass-bg));
            pointer-events:none;
        }
        .avatar{
            width:110px;
            height:110px;
            border-radius:50%;
            background:var(--glass-hover);
            backdrop-filter:blur(12px);
            -webkit-backdrop-filter:blur(12px);
            border:3px solid var(--glass-hover);
            display:flex;
            align-items:center;
            justify-content:center;
            margin:0 auto 28px;
            font-size:38px;
            font-weight:700;
            color:#fff;
            letter-spacing:2px;
            overflow:hidden;
            box-shadow:0 12px 40px rgba(0,0,0,.25),0 0 0 1px var(--glass-hover) inset;
            position:relative;
            z-index:1;
            animation:avatarPop .6s cubic-bezier(.34,1.56,.64,1) .1s both;
        }
        @keyframes avatarPop{from{transform:scale(.8);opacity:0}to{transform:scale(1);opacity:1}}
        .avatar img{width:100%;height:100%;object-fit:cover}
        .avatar-logo{width:75px;height:75px;object-fit:contain;filter:brightness(1.05)}
        .avatar.avatar-branded{
            background:linear-gradient(135deg,var(--accent),var(--accent-secondary));
            border-color:var(--text-muted);
            box-shadow:0 12px 40px var(--accent-glow),0 0 0 1px var(--glass-hover) inset;
        }
        .avatar-mark{
            position:absolute;inset:0;
            display:flex;align-items:center;justify-content:center;
            opacity:.12;
            pointer-events:none;
        }
        .avatar-mark svg{width:80%;height:80%}
        .avatar-initials{
            position:relative;z-index:1;
            font-size:36px;font-weight:700;letter-spacing:3px;
            color:#fff;
            text-shadow:0 2px 12px rgba(0,0,0,.25);
        }
        .hero h1{
            color:#fff;
            font-size:28px;
            font-weight:700;
            letter-spacing:1.5px;
            text-transform:uppercase;
            margin-bottom:10px;
            text-shadow:0 2px 12px rgba(0,0,0,.2);
            position:relative;
            z-index:1;
            animation:textSlideUp .5s ease .2s both;
        }
        .verified-badge{display:inline-flex;align-items:center;vertical-align:middle;margin-left:4px}
        .verified-badge svg{filter:drop-shadow(0 0 6px rgba(5,150,105,.5))}
        .hero p{
            color:var(--text-primary);
            font-size:15px;
            font-weight:500;
            position:relative;
            z-index:1;
            animation:textSlideUp .5s ease .3s both;
        }
        @keyframes textSlideUp{from{transform:translateY(16px);opacity:0}to{transform:translateY(0);opacity:1}}

        /* ── Quick Actions ── */
        .quick-actions{
            display:flex;
            justify-content:center;
            gap:20px;
            padding:32px 24px 16px;
            animation:actionsSlide .5s ease .35s both;
        }
        @keyframes actionsSlide{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
        .action-btn{
            display:flex;
            flex-direction:column;
            align-items:center;
            gap:10px;
            text-decoration:none;
            min-width:72px;
            transition:transform .2s ease;
        }
        .action-btn .ic{
            width:58px;
            height:58px;
            border-radius:50%;
            display:flex;
            align-items:center;
            justify-content:center;
            box-shadow:0 4px 16px rgba(0,0,0,.08),0 1px 3px rgba(0,0,0,.04);
            transition:all .2s ease;
        }
        .action-btn:active{transform:scale(.92)}
        .action-btn:active .ic{box-shadow:0 2px 8px rgba(0,0,0,.06)}
        .action-btn .ic svg{width:24px;height:24px}
        .action-btn span{font-size:13px;font-weight:600;letter-spacing:.3px}

        /* ── Social Links ── */
        .social-row{
            display:flex;
            justify-content:center;
            gap:14px;
            padding:20px 24px 12px;
            animation:actionsSlide .5s ease .4s both;
        }
        .social-link{
            width:46px;
            height:46px;
            border-radius:50%;
            display:flex;
            align-items:center;
            justify-content:center;
            text-decoration:none;
            box-shadow:0 2px 10px rgba(0,0,0,.06);
            transition:all .2s ease;
        }
        .social-link:active{transform:scale(.85)}
        .social-link svg{width:22px;height:22px}

        /* ── Save Contact ── */
        .save-contact{padding:24px 24px 20px;animation:actionsSlide .5s ease .45s both}
        .save-btn{
            display:flex;
            align-items:center;
            justify-content:center;
            gap:12px;
            width:100%;
            padding:17px 24px;
            color:#fff;
            border:none;
            border-radius:16px;
            font-family:inherit;
            font-size:16px;
            font-weight:600;
            cursor:pointer;
            box-shadow:0 8px 24px rgba(0,0,0,.18),0 2px 6px rgba(0,0,0,.08);
            -webkit-tap-highlight-color:transparent;
            transition:all .2s ease;
            position:relative;
            overflow:hidden;
        }
        .save-btn::before{
            content:'';
            position:absolute;
            top:0;left:0;right:0;bottom:0;
            background:linear-gradient(180deg,var(--glass-hover) 0%,transparent 50%);
            pointer-events:none;
        }
        .save-btn:active{transform:scale(.97);box-shadow:0 4px 16px rgba(0,0,0,.15)}
        .save-btn svg{width:22px;height:22px;fill:#fff}

        /* ── About ── */
        .about{padding:32px 24px;animation:sectionSlide .5s ease .5s both}
        @keyframes sectionSlide{from{transform:translateY(24px);opacity:0}to{transform:translateY(0);opacity:1}}
        .section-title{
            font-size:11px;
            font-weight:700;
            text-transform:uppercase;
            letter-spacing:2px;
            margin-bottom:16px;
        }
        .about p{font-size:15px;line-height:1.8;color:#475569;letter-spacing:.1px}
        .about-text{position:relative}
        .about-text.collapsed{max-height:100px;overflow:hidden}
        .about-text.collapsed::after{
            content:'';
            position:absolute;
            bottom:0;
            left:0;
            right:0;
            height:60px;
            background:linear-gradient(transparent,#fff);
        }
        .view-more{
            display:none;
            background:none;
            border:none;
            font-family:inherit;
            font-size:14px;
            font-weight:600;
            cursor:pointer;
            padding:10px 0;
            margin-top:8px;
            transition:opacity .2s;
        }
        .view-more:active{opacity:.6}
        .view-more.show{display:inline-block}

        /* ── Contact Details ── */
        .contact-details{padding:12px 24px 36px;animation:sectionSlide .5s ease .55s both}
        .contact-item{
            display:flex;
            align-items:center;
            gap:16px;
            padding:16px 0;
            border-bottom:1px solid #f1f5f9;
            text-decoration:none;
            color:inherit;
            transition:all .2s ease;
        }
        .contact-item:last-child{border-bottom:none}
        .contact-item:active{opacity:.7;transform:translateX(4px)}
        .contact-item .ib{
            width:48px;
            height:48px;
            border-radius:14px;
            display:flex;
            align-items:center;
            justify-content:center;
            flex-shrink:0;
        }
        .contact-item .ib svg{width:20px;height:20px}
        .contact-item .detail{display:flex;flex-direction:column;gap:3px;min-width:0}
        .contact-item .label{
            font-size:12px;
            font-weight:600;
            color:#607085;
            text-transform:uppercase;
            letter-spacing:.5px;
        }
        .contact-item .value{font-size:15px;color:#1e293b;word-break:break-word;font-weight:500}

        /* ── Footer ── */
        .footer{
            text-align:center;
            padding:28px;
            padding-bottom:calc(28px + env(safe-area-inset-bottom));
            background:linear-gradient(180deg,#f8fafc,#f1f5f9);
            animation:sectionSlide .5s ease .6s both;
        }
        .footer p{font-size:12px;color:#607085;font-weight:500;letter-spacing:.3px}
        .share-section{
            padding:24px;
            background:linear-gradient(180deg,#f8fafc,#f1f5f9);
            animation:sectionSlide .5s ease .55s both;
        }
        .share-btn{
            display:flex;
            align-items:center;
            justify-content:center;
            gap:10px;
            width:100%;
            padding:16px 24px;
            border-radius:16px;
            background:linear-gradient(135deg,var(--accent),var(--accent-secondary));
            color:#fff;
            font-weight:600;
            font-size:15px;
            border:none;
            cursor:pointer;
            font-family:inherit;
            box-shadow:0 4px 20px var(--accent-glow);
            transition:all .2s ease;
        }
        .share-btn:active{transform:scale(.97);box-shadow:0 2px 12px var(--accent-glow)}
        .share-btn svg{width:22px;height:22px;fill:#fff}
        .powered-by{
            margin-top:20px;
            margin-bottom:8px;
            font-size:12px;
            color:#607085;
            text-align:center;
        }
        .powered-by a{
            color:var(--accent);
            text-decoration:none;
            font-weight:600;
        }

        /* ── Exchange Section ── */
        .exchange-section{
            padding:0 24px 16px;
            text-align:center;
        }
        .exchange-btn{
            display:inline-flex;
            align-items:center;
            gap:6px;
            padding:12px 28px;
            background:linear-gradient(135deg,#10b981,#059669);
            color:#fff;
            border:none;
            border-radius:14px;
            font-size:15px;
            font-weight:600;
            cursor:pointer;
            box-shadow:0 4px 20px rgba(16,185,129,.35);
            transition:all .2s ease;
            width:100%;
            justify-content:center;
        }
        .exchange-btn:active{transform:scale(.97)}
        .exchange-btn.exchanged{background:#059669;opacity:.8;cursor:default}
        .exchange-btn:disabled{opacity:.7;cursor:wait}
        .exchange-cta{
            display:flex;
            align-items:center;
            gap:8px;
            justify-content:center;
            padding:14px 20px;
            border:2px dashed var(--accent-glow);
            border-radius:14px;
            color:var(--accent);
            font-size:14px;
            font-weight:600;
            text-decoration:none;
            transition:all .2s ease;
        }
        .exchange-cta:hover{border-color:var(--accent);background:var(--accent-subtle)}

        /* ── Fixed Bottom Bar ── */
        .fixed-bottom-bar{
            position:fixed;
            bottom:0;left:0;right:0;
            z-index:100;
            background:var(--bg-sticky);
            backdrop-filter:blur(16px);
            -webkit-backdrop-filter:blur(16px);
            border-top:1px solid #e2e8f0;
            padding:12px 20px;
            padding-bottom:calc(12px + env(safe-area-inset-bottom));
            transform:translateY(100%);
            transition:transform .4s cubic-bezier(.4,0,.2,1);
        }
        .fixed-bottom-bar.show{transform:translateY(0)}
        .fixed-bottom-inner{
            max-width:480px;
            margin:0 auto;
            display:flex;
            gap:10px;
        }
        .fixed-save-btn{
            flex:1;
            display:flex;
            align-items:center;
            justify-content:center;
            gap:10px;
            padding:15px 20px;
            color:#fff;
            border:none;
            border-radius:14px;
            font-family:inherit;
            font-size:16px;
            font-weight:600;
            cursor:pointer;
            box-shadow:0 4px 16px rgba(0,0,0,.15);
            transition:all .2s ease;
        }
        .fixed-save-btn:active{transform:scale(.97)}
        .fixed-save-btn svg{width:20px;height:20px;fill:#fff}
        .fixed-share-btn{
            width:50px;
            height:50px;
            display:flex;
            align-items:center;
            justify-content:center;
            border:1.5px solid #e2e8f0;
            border-radius:14px;
            background:#fff;
            cursor:pointer;
            flex-shrink:0;
            transition:all .2s ease;
        }
        .fixed-share-btn:active{transform:scale(.92);background:#f8fafc}
        .fixed-share-btn svg{width:20px;height:20px}

        /* ── Social Proof ── */
        .social-proof{
            display:flex;
            align-items:center;
            justify-content:center;
            gap:6px;
            padding:8px 16px;
            font-size:13px;
            color:var(--text-secondary);
            animation:textSlideUp .5s ease .35s both;
        }
        .social-proof svg{width:14px;height:14px;fill:var(--glass-text)}

        /* ── Lead Capture Modal ── */
        .lead-modal-overlay{
            position:fixed;
            inset:0;
            background:rgba(0,0,0,.6);
            z-index:200;
            display:none;
            align-items:flex-end;
            justify-content:center;
            backdrop-filter:blur(4px);
            -webkit-backdrop-filter:blur(4px);
        }
        .lead-modal-overlay.show{display:flex}
        .lead-modal{
            width:100%;
            max-width:480px;
            max-height:80vh;
            overflow-y:auto;
            background:#fff;
            border-radius:24px 24px 0 0;
            padding:28px 24px;
            padding-bottom:calc(28px + env(safe-area-inset-bottom));
            transform:translateY(100%);
            transition:transform .35s cubic-bezier(.4,0,.2,1);
        }
        .lead-modal-overlay.show .lead-modal{transform:translateY(0)}
        .lead-modal-close{
            position:absolute;
            top:16px;right:20px;
            width:32px;height:32px;
            border-radius:50%;
            background:#f1f5f9;
            border:none;
            display:flex;
            align-items:center;
            justify-content:center;
            cursor:pointer;
        }
        .lead-modal-close svg{width:18px;height:18px;fill:#64748b}
        .lead-modal-header{
            text-align:center;
            margin-bottom:20px;
            position:relative;
        }
        .lead-modal-header h3{
            font-size:18px;
            font-weight:700;
            color:#1e293b;
            margin-bottom:6px;
        }
        .lead-modal-header p{
            font-size:14px;
            color:#64748b;
        }

        /* ── CTA Banner ── */
        .cf-cta-banner{
            position:fixed;
            bottom:-100px;
            left:0;right:0;
            background:linear-gradient(135deg,var(--bg-elevated),#134e4a);
            border-top:1px solid var(--accent-glow);
            padding:16px 20px;
            z-index:9998;
            transition:bottom .4s ease;
        }
        .cf-cta-banner.show{bottom:0}
        .cta-inner{
            max-width:480px;
            margin:0 auto;
            display:flex;
            align-items:center;
            justify-content:center;
            gap:10px;
            flex-wrap:wrap;
            font-family:Inter,-apple-system,sans-serif;
            font-size:14px;
            color:var(--text-primary);
        }
        .cta-create-btn{
            background:var(--accent);
            color:#fff;
            border:none;
            padding:8px 18px;
            border-radius:10px;
            font-size:13px;
            font-weight:600;
            text-decoration:none;
            cursor:pointer;
        }
        .cta-dismiss{
            background:transparent;
            color:var(--text-muted);
            border:1px solid var(--glass-hover);
            padding:6px 12px;
            border-radius:8px;
            font-size:12px;
            cursor:pointer;
        }

        /* ── Product Gallery ── */
        .products{
            background:#fff;
            padding:24px;
            animation:sectionSlide .5s ease .45s both;
        }
        .products-scroll{
            display:flex;
            gap:14px;
            overflow-x:auto;
            scroll-snap-type:x mandatory;
            -webkit-overflow-scrolling:touch;
            padding-bottom:8px;
            margin:-4px;
            padding:4px;
        }
        .products-scroll::-webkit-scrollbar{display:none}
        .product-card{
            flex:0 0 150px;
            scroll-snap-align:start;
            background:#fff;
            border-radius:16px;
            overflow:hidden;
            box-shadow:0 2px 12px rgba(0,0,0,.08);
            border:1px solid #f1f5f9;
        }
        .product-img{
            width:100%;
            height:110px;
            object-fit:cover;
            background:linear-gradient(135deg,#f1f5f9,#e2e8f0);
        }
        .product-info{
            padding:12px;
        }
        .product-name{
            font-size:13px;
            font-weight:600;
            color:#1e293b;
            margin-bottom:4px;
            line-height:1.3;
            display:-webkit-box;
            -webkit-line-clamp:2;
            -webkit-box-orient:vertical;
            overflow:hidden;
        }
        .product-price{
            font-size:12px;
            color:#64748b;
            margin-bottom:10px;
            font-weight:500;
        }
        .enquire-btn{
            width:100%;
            padding:10px;
            border-radius:10px;
            border:none;
            font-size:12px;
            font-weight:600;
            cursor:pointer;
            font-family:inherit;
            transition:all .2s;
        }
        .enquire-btn:active{transform:scale(.96)}

        /* ── Transitions ── */
        #waiting.hide-out{
            opacity:0;
            transform:scale(.96);
            transition:all .3s ease-out;
            pointer-events:none;
        }

        /* ── Card-page Lead Form ── */
        .card-lead-section{
            padding:0 24px 8px;
        }
        .card-lead-toggle{
            width:100%;
            display:flex;
            align-items:center;
            justify-content:center;
            gap:8px;
            padding:14px 20px;
            border:2px dashed var(--accent-glow);
            border-radius:14px;
            background:rgba(99,102,241,.04);
            color:var(--accent);
            font-family:inherit;
            font-size:14px;
            font-weight:600;
            cursor:pointer;
            transition:all .2s ease;
        }
        .card-lead-toggle:active{transform:scale(.97)}
        .card-lead-toggle:hover{border-color:var(--accent-glow);background:var(--accent-subtle)}
        .card-lead-toggle svg{width:18px;height:18px;fill:currentColor;transition:transform .3s}
        .card-lead-toggle.open{border-color:var(--accent);background:var(--accent-subtle);border-style:solid}
        .card-lead-toggle.open svg.arrow{transform:rotate(180deg)}
        .card-lead-form{
            max-height:0;
            overflow:hidden;
            transition:max-height .35s ease;
        }
        .card-lead-form.open{max-height:800px}
        .card-lead-form-inner{padding:16px 0 0}
        .clf-scan-btn{
            width:100%;
            display:flex;
            align-items:center;
            justify-content:center;
            gap:8px;
            padding:14px 20px;
            border:2px solid var(--accent);
            border-radius:12px;
            background:#fff;
            color:var(--accent);
            font-family:inherit;
            font-size:15px;
            font-weight:600;
            cursor:pointer;
            transition:all .2s ease;
        }
        .clf-scan-btn:active{transform:scale(.97)}
        .clf-scan-btn:hover{background:rgba(99,102,241,.06)}
        .clf-scan-btn svg{width:20px;height:20px;fill:currentColor;flex-shrink:0}
        .clf-scan-btn.scanning{opacity:.7;pointer-events:none}
        .clf-scan-status{
            text-align:center;
            font-size:13px;
            color:var(--accent);
            margin-top:8px;
            display:none;
        }
        .clf-scan-status.show{display:block}
        .clf-or{
            text-align:center;
            font-size:13px;
            color:var(--accent);
            margin:14px 0;
            cursor:pointer;
            font-weight:500;
        }
        .clf-or:hover{text-decoration:underline}
        .clf-manual{max-height:0;overflow:hidden;transition:max-height .3s ease}
        .clf-manual.open{max-height:400px}
        .clf-preview{
            width:100%;
            max-height:120px;
            object-fit:cover;
            border-radius:10px;
            margin-bottom:10px;
            display:none;
        }
        .clf-field{margin-bottom:10px}
        .clf-field input{
            width:100%;
            padding:14px 16px;
            border:1.5px solid #e2e8f0;
            border-radius:12px;
            font-family:inherit;
            font-size:15px;
            color:#1e293b;
            background:#f8fafc;
            outline:none;
            transition:all .2s ease;
        }
        .clf-field input::placeholder{color:#94a3b8}
        .clf-field input:focus{border-color:var(--accent);background:#fff;box-shadow:0 0 0 3px var(--accent-subtle)}
        .clf-submit{
            width:100%;
            padding:14px;
            border:none;
            border-radius:12px;
            font-family:inherit;
            font-size:15px;
            font-weight:600;
            color:#fff;
            background:linear-gradient(135deg,var(--accent),var(--accent-secondary));
            cursor:pointer;
            margin-top:4px;
            transition:all .2s ease;
            box-shadow:0 4px 16px var(--accent-glow);
        }
        .clf-submit:active{transform:scale(.98)}
        .clf-submit.sent{background:linear-gradient(135deg,#10b981,#059669)}
        .clf-submit:disabled{opacity:.5}
        .card-lead-sent{
            display:flex;
            align-items:center;
            justify-content:center;
            gap:8px;
            padding:14px 20px;
            background:rgba(16,185,129,.08);
            border:1px solid rgba(16,185,129,.2);
            border-radius:14px;
            color:#059669;
            font-size:14px;
            font-weight:600;
        }
        .card-lead-sent svg{width:18px;height:18px;fill:#10b981}
        @media(max-width:380px){
            .action-btn span{font-size:10px}
            .save-btn{font-size:15px;padding:14px 18px}
            .hero{padding:28px 16px 32px;padding-top:calc(28px + env(safe-area-inset-top))}
        }
    </style>
    <script src="/theme.js" defer></script>
</head>
<body>
<div class="container">
    <!-- Waiting Screen (hidden immediately for dashboard previews) -->
    <script>if(new URLSearchParams(location.search).get('preview')==='1')document.write('<style>#waiting{display:none!important}#card{display:block!important}</style>')</script>
    <div id="waiting">
        <div class="wait-header">
            <div class="wait-avatar" id="waitAvatar"></div>
            <div class="wait-text" id="waitText">Connecting...</div>
            <div class="wait-sub">Preparing your card <span class="dots"><span></span><span></span><span></span></span></div>
            <a href="#" class="wait-phone" id="waitPhone" style="display:none">
                <svg viewBox="0 0 24 24"><path d="M6.62 10.79a15.05 15.05 0 0 0 6.59 6.59l2.2-2.2a1 1 0 0 1 1.01-.24c1.12.37 2.33.57 3.58.57a1 1 0 0 1 1 1V20a1 1 0 0 1-1 1A17 17 0 0 1 3 4a1 1 0 0 1 1-1h3.5a1 1 0 0 1 1 1c0 1.25.2 2.46.57 3.58a1 1 0 0 1-.24 1.01l-2.2 2.2z"/></svg>
                <span id="waitPhoneText"></span>
            </a>
            <!-- Timeout notice -->
            <div class="timeout-notice" id="timeoutNotice">
                <p>Loading your card...</p>
            </div>
        </div>
        <div class="wait-form">
            <div class="wait-form-title">While you wait — share your card</div>

            <!-- Share card photo button -->
            <label class="wf-scan-btn" id="scanBtn" for="scanPhoto">
                <svg viewBox="0 0 24 24"><path d="M9 3L7.17 5H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2h-3.17L15 3H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg>
                Share my business card
            </label>
            <input type="file" id="scanPhoto" accept="image/*" capture="environment" style="display:none" onchange="scanCard(this)">
            <div class="wf-scan-status" id="scanStatus">Scanning card...</div>

            <div class="wf-or" id="manualToggle" onclick="toggleManual()">
                <span>— or fill manually —</span>
                <svg viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
            </div>

            <div class="wf-manual" id="manualFields">
                <div class="wf-field"><input type="text" id="vName" placeholder="Your name" autocomplete="name"></div>
                <div class="wf-field"><input type="tel" id="vPhone" placeholder="Phone number" autocomplete="tel"></div>
                <div class="wf-field"><input type="email" id="vEmail" placeholder="Email" autocomplete="email"></div>
                <div class="wf-field"><input type="text" id="vCompany" placeholder="Company" autocomplete="organization"></div>
                <div class="wf-row">
                    <label class="wf-photo-btn" for="vPhoto">
                        <svg viewBox="0 0 24 24"><path d="M9 3L7.17 5H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2h-3.17L15 3H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg>
                        Attach photo
                    </label>
                    <input type="file" id="vPhoto" accept="image/*" capture="environment" style="display:none" onchange="previewPhoto(this)">
                    <img class="wf-preview" id="photoPreview">
                </div>
                <button class="wf-submit" id="submitBtn" onclick="submitLead()">Share my details</button>
            </div>
        </div>
    </div>

    <!-- Card Display -->
    <div id="card"></div>
</div>

<script>
// Inline from common.js (only escHtml needed on visitor page)
function escHtml(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}
var escapeHtml=escHtml;
// Safety timeout for loader
setTimeout(function() {
    var w = document.getElementById('waiting');
    if (w && w.style.display !== 'none') {
        var wt = document.getElementById('waitText');
        var ws = document.getElementById('waitSub') || w.querySelector('.wait-sub');
        if (wt) wt.textContent = 'Taking longer than expected...';
        if (ws) ws.innerHTML = '<a href="javascript:location.reload()" style="color:var(--accent);text-decoration:underline">Tap to retry</a>';
    }
}, 10000);

// Debug logging (enable with ?debug=1)
var CF_DEBUG = location.search.indexOf('debug=1') !== -1;
function cfLog(tag, msg, data) {
    if (!CF_DEBUG) return;
    var ts = new Date().toISOString().substr(11, 12);
    console.log('[CF ' + ts + '] [' + tag + '] ' + msg, data || '');
}

// Public API helper
function publicFetch(path, options) {
    options = options || {};
    options.headers = options.headers || {};
    if (options.body && typeof options.body === 'object') {
        options.headers['Content-Type'] = 'application/json';
        options.body = JSON.stringify(options.body);
    }
    return fetch('/api/public' + path, options);
}

// ═══ DYNAMIC CARD STORAGE (loaded from Firebase per user) ═══
var CARDS = {};
var TOKENS = {};

// Reserved paths that should NOT be treated as usernames
var RESERVED_PATHS = ['login','signup','admin','pricing','landing','reset-password','cookies','disclaimer','privacy','refund','terms','api','sw.js','manifest.json','icons','favicon.ico','robots.txt','sitemap.xml','apple-touch-icon.png','icon-192.png','icon-512.png','.well-known'];

// ── Route resolution ──
var resolvedUserId = null;
var resolvedCardId = null;
var resolvedUsername = null;
var directCard = null;
var isNfcMode = false;
var wasNfcRedirect = false;
var visitSource = (new URLSearchParams(window.location.search)).get('nfc') === '1' ? 'nfc' : (document.referrer ? 'link' : 'qr');
var resolvedUserPlan = 'free';

// ── Visitor info ──
var ua = navigator.userAgent;
var device = /iPhone/.test(ua)?'iPhone':/Android/.test(ua)?'Android':/iPad/.test(ua)?'iPad':'Desktop';
var browser = /CriOS|Chrome/.test(ua)?'Chrome':/Safari/.test(ua)?'Safari':/Firefox/.test(ua)?'Firefox':'Other';

// ── Session ──
var sid = Date.now().toString(36) + Math.random().toString(36).substr(2,5);
var leadSubmitted = false;
var cardPhotoData = null;
var timeoutTimer = null;
var defaultTimeoutCard = null;
var visitorId = null;
var nfcES = null;

// ── Persistent visitor identity ──
function initVisitor() {
    var stored = null;
    try { stored = localStorage.getItem('cf_vid'); } catch(e) {}
    if (!stored) {
        var m = document.cookie.match(/(?:^|;\s*)cf_vid=([^;]+)/);
        if (m) stored = m[1];
    }
    return publicFetch('/visitors', {method:'POST', body:{visitorId:stored||null, device:device, browser:browser}})
        .then(function(r){ return r.json(); })
        .then(function(d){
            if (d && d.visitorId) {
                visitorId = d.visitorId;
                try { localStorage.setItem('cf_vid', visitorId); } catch(e) {}
                document.cookie = 'cf_vid=' + visitorId + ';path=/;max-age=31536000;SameSite=Lax;Secure';
            }
        })
        .catch(function(){});
}

// ── Security helpers ── (escapeHtml provided by common.js)
function sanitizeColor(c) {
    if (!c) return '';
    if (/^#[0-9a-fA-F]{3,8}$/.test(c)) return c;
    if (/^rgb\(\s*\d{1,3}\s*,\s*\d{1,3}\s*,\s*\d{1,3}\s*\)$/.test(c)) return c;
    if (/^rgba\(\s*\d{1,3}\s*,\s*\d{1,3}\s*,\s*\d{1,3}\s*,\s*[\d.]+\s*\)$/.test(c)) return c;
    return '#1B1464';
}
function sanitizeUrl(url) {
    if (!url) return '';
    var s = String(url).trim();
    if (/^(https?:\/\/|mailto:|tel:)/i.test(s)) return s;
    return '';
}

// ── Path-based routing ──
function resolveRoute() {
    var path = window.location.pathname.replace(/^\/+|\/+$/g, ''); // trim slashes
    var urlParams = new URLSearchParams(window.location.search);
    var legacyToken = urlParams.get('c');
    var nfcParam = urlParams.get('nfc');
    var parts = path.split('/').filter(function(p) { return p; });

    // ?c=token — resolve card token to user + card
    if (legacyToken) {
        return publicFetch('/token/' + legacyToken)
            .then(function(r) { return r.json(); })
            .then(function(result) {
                if (result && result.userId) {
                    resolvedUserId = result.userId;
                    resolvedUsername = result.username || null;
                    visitSource = document.referrer ? 'link' : 'qr';
                    return loadUserCards(result.userId).then(function() {
                        if (result.cardId) resolvedCardId = result.cardId;
                    });
                }
                showError('Card not found');
            }).catch(function() { showError('Card not found'); });
    }

    // Check if path is reserved
    if (parts.length > 0 && RESERVED_PATHS.indexOf(parts[0]) !== -1) {
        return Promise.resolve(); // Let static file serve
    }

    // Path: /username or /username/cardname
    if (parts.length >= 1) {
        var username = parts[0].toLowerCase();
        var cardSlug = parts.length >= 2 ? parts[1] : null;

        // Use server-injected userId if available (skips a full API round-trip)
        var metaUid = document.querySelector('meta[name="cf-user-id"]');
        var uidPromise = metaUid && metaUid.content
            ? Promise.resolve(metaUid.content)
            : publicFetch('/username/' + username).then(function(r) { return r.json(); });

        return uidPromise
            .then(function(userId) {
                if (!userId) { showError('User not found'); return; }
                resolvedUserId = userId;
                resolvedUsername = username;

                if (nfcParam === '1') {
                    isNfcMode = true;
                }

                return loadUserCards(userId).then(function() {
                    if (cardSlug) {
                        resolvedCardId = cardSlug;
                        if (nfcParam === '1') { visitSource = 'nfc'; wasNfcRedirect = true; }
                        else { visitSource = document.referrer ? 'link' : 'qr'; }
                    } else if (!isNfcMode) {
                        // Load default card or first card
                        visitSource = document.referrer ? 'link' : 'qr';
                    }
                });
            }).catch(function() { showError('User not found'); });
    }

    // No path - show error or redirect
    showError('No card specified');
    return Promise.resolve();
}

function loadUserCards(userId) {
    return Promise.all([
        publicFetch('/user/' + userId + '/cards').then(function(r) { return r.json(); }).catch(function() { return null; }),
        publicFetch('/user/' + userId + '/settings').then(function(r) { return r.json(); }).catch(function() { return null; }),
        publicFetch('/user/' + userId + '/profile').then(function(r) { return r.json(); }).catch(function() { return null; })
    ]).then(function(results) {
        var cardsData = results[0];
        var defaultCard = results[1] ? results[1].defaultCard : null;
        var profile = results[2];
        defaultTimeoutCard = defaultCard || null;

        if (cardsData && typeof cardsData === 'object') {
            for (var id in cardsData) {
                var fc = cardsData[id];
                if (fc && typeof fc === 'object' && (fc.name || fc.company)) {
                    if (!fc.color1 && fc.color) { fc.color1 = fc.color; fc.color2 = darkenColor(fc.color); }
                    if (!fc.accent) fc.accent = fc.color1 || '#1B1464';
                    if (!fc.accentLight) fc.accentLight = lightenColor(fc.accent);
                    if (!fc.phoneDisplay && fc.phone) fc.phoneDisplay = fc.phone;
                    if (!fc.whatsapp && fc.phone) fc.whatsapp = fc.phone.replace(/[^0-9]/g,'');
                    if (!fc.addressQuery && fc.address) fc.addressQuery = fc.address.replace(/[,\s]+/g, '+');
                    if (!fc.websiteDisplay && fc.website) fc.websiteDisplay = fc.website.replace(/^https?:\/\//,'').replace(/\/$/,'');
                    if (!fc.vcardAdr && fc.address) fc.vcardAdr = ';;'+fc.address.replace(/,/g,'\\,')+';;;;';
                    if (!fc.bio) fc.bio = '';
                    if (!fc.token) fc.token = id;
                    CARDS[id] = fc;
                    TOKENS[fc.token] = id;
                }
            }
        }

        // Update waiting screen with user info
        if (profile) {
            if (profile.plan) resolvedUserPlan = profile.plan;
            var waitText = document.getElementById('waitText');
            var waitAvatar = document.getElementById('waitAvatar');
            if (waitText && profile.name) {
                waitText.textContent = 'Connecting with ' + profile.name.split(' ')[0];
            }
            if (waitAvatar && profile.name) {
                waitAvatar.textContent = profile.name.split(' ').map(function(n){return n[0]}).join('').substring(0,2).toUpperCase();
            }
        }

        // Set phone on waiting screen from first card
        var cardIds = Object.keys(CARDS);
        if (cardIds.length > 0) {
            var firstCard = CARDS[cardIds[0]];
            if (firstCard && firstCard.phone) {
                var waitPhone = document.getElementById('waitPhone');
                var waitPhoneText = document.getElementById('waitPhoneText');
                if (waitPhone && waitPhoneText) {
                    waitPhone.href = 'tel:' + firstCard.phone;
                    waitPhoneText.textContent = firstCard.phoneDisplay || firstCard.phone;
                    waitPhone.style.display = '';
                }
            }
        }

        // If no specific card resolved and not NFC mode:
        // - If only 1 card, show it directly
        // - If multiple cards, enter NFC-like picker flow so owner can choose
        if (!resolvedCardId && !isNfcMode && cardIds.length > 0) {
            if (cardIds.length === 1) {
                resolvedCardId = cardIds[0];
            } else {
                // Multiple cards + no specific card = let owner pick
                isNfcMode = true;
            }
        }
    });
}

function showError(msg) {
    document.getElementById('waiting').style.display = 'none';
    var el = document.getElementById('card');
    el.innerHTML = '<div style="text-align:center;padding:60px 24px;color:#64748b"><p style="font-size:18px;margin-bottom:8px">' + escHtml(msg) + '</p><a href="/" style="color:var(--accent)">Go to homepage</a></div>';
    el.classList.add('show');
}

function darkenColor(hex) {
    if (!hex || hex[0] !== '#') return '#0D0D3B';
    if (hex.length === 4) hex = '#' + hex[1]+hex[1] + hex[2]+hex[2] + hex[3]+hex[3];
    var r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
    r = Math.floor(r*0.6); g = Math.floor(g*0.6); b = Math.floor(b*0.6);
    return '#'+r.toString(16).padStart(2,'0')+g.toString(16).padStart(2,'0')+b.toString(16).padStart(2,'0');
}

function lightenColor(hex) {
    if (!hex || hex[0] !== '#') return '#EEF0FF';
    if (hex.length === 4) hex = '#' + hex[1]+hex[1] + hex[2]+hex[2] + hex[3]+hex[3];
    var r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
    r = Math.min(255, r+Math.floor((255-r)*0.85)); g = Math.min(255, g+Math.floor((255-g)*0.85)); b = Math.min(255, b+Math.floor((255-b)*0.85));
    return '#'+r.toString(16).padStart(2,'0')+g.toString(16).padStart(2,'0')+b.toString(16).padStart(2,'0');
}

// ── Owner detection (skip taps/analytics for own previews) ──
var isOwnerPreview = false;
function detectOwnerPreview() {
    // Check preview query param (set by dashboard iframe preview)
    if (new URLSearchParams(window.location.search).get('preview') === '1') { isOwnerPreview = true; return; }
    // Check localStorage for logged-in owner
    try {
        var _t = localStorage.getItem('token');
        var _u = _t ? JSON.parse(localStorage.getItem('user') || 'null') : null;
        if (_u && _u.id === resolvedUserId) isOwnerPreview = true;
    } catch(e) {}
}

// ── Analytics helper (user-scoped) ──
function trackEvent(cardId, category, action) {
    if (!resolvedUserId || isOwnerPreview) return;
    var payload = {ts:Date.now(), source:visitSource, action:action, device:device, browser:browser, sid:sid, visitorId:visitorId};
    publicFetch('/user/'+resolvedUserId+'/analytics/'+cardId+'/'+category, {method:'POST', body:payload}).catch(function(){});
}

// ── Main init: runs after route resolved and cards loaded ──
function initCardFlow() {
    if (!resolvedUserId) return;
    cfLog('INIT', 'initCardFlow userId=' + resolvedUserId + ' cardId=' + resolvedCardId + ' nfc=' + isNfcMode + ' cards=' + Object.keys(CARDS).length + ' source=' + visitSource);

    if (resolvedCardId && CARDS[resolvedCardId]) {
        directCard = resolvedCardId;
        if (!isOwnerPreview) {
            publicFetch('/user/'+resolvedUserId+'/taps', {method:'POST', body:{
                id:sid, status:'direct', card:directCard, source:visitSource, ts:Date.now(),
                visitorId:visitorId,
                visitor:{device:device,browser:browser,lang:navigator.language||'',screen:screen.width+'x'+screen.height}
            }}).catch(function(){});
            // Notify admin of NFC tap (even though card was auto-shown via default)
            if (wasNfcRedirect) {
                publicFetch('/user/'+resolvedUserId+'/latest', {method:'PUT', body:{
                    sessionId:sid, ts:Date.now(), card:directCard, source:'nfc',
                    visitor:{device:device,browser:browser}
                }}).catch(function(){});
            }
        }
        // Skip waiting screen — show card immediately for direct/QR links
        document.getElementById('waiting').style.display = 'none';
        showCard(directCard, true);
    } else if (isNfcMode) {
        // Determine if we can show a card instantly (default card or single card)
        var allCardIds = Object.keys(CARDS);
        var instantCard = (defaultTimeoutCard && CARDS[defaultTimeoutCard]) ? defaultTimeoutCard
                        : (allCardIds.length === 1 ? allCardIds[0] : null);

        if (instantCard) {
            // Show card instantly — no waiting screen
            cfLog('INIT', 'Instant card: ' + instantCard);
            directCard = instantCard;
            visitSource = 'nfc';
            if (!isOwnerPreview) {
                publicFetch('/user/'+resolvedUserId+'/taps', {method:'POST', body:{
                    id:sid, status:'direct', card:instantCard, source:'nfc', ts:Date.now(),
                    visitorId:visitorId,
                    visitor:{device:device,browser:browser,lang:navigator.language||'',screen:screen.width+'x'+screen.height}
                }}).catch(function(){});
                publicFetch('/user/'+resolvedUserId+'/latest', {method:'PUT', body:{
                    sessionId:sid, ts:Date.now(), card:instantCard, source:'nfc',
                    visitor:{device:device,browser:browser}
                }}).catch(function(){});
            }
            document.getElementById('waiting').style.display = 'none';
            showCard(instantCard, true);
        } else {
            // Multiple cards, no default — NFC waiting/picker flow
            cfLog('INIT', 'NFC waiting mode, ' + allCardIds.length + ' cards, no default');
            if (!isOwnerPreview) {
                publicFetch('/user/'+resolvedUserId+'/taps', {method:'POST', body:{
                    id:sid, status:'waiting', ts:Date.now(), source:'nfc',
                    visitorId:visitorId,
                    visitor:{device:device,browser:browser,lang:navigator.language||'',screen:screen.width+'x'+screen.height}
                }}).catch(function(){});
                publicFetch('/user/'+resolvedUserId+'/latest', {method:'PUT', body:{
                    sessionId:sid, ts:Date.now(), visitor:{device:device,browser:browser}
                }}).catch(function(){});
            }

            // Card received handler — cleans up SSE + polling
            var cardReceived = false;
            function onCardReceived(cardId) {
                if (cardReceived) return;
                cardReceived = true;
                cfLog('RECV', 'Card received: ' + cardId);
                if (nfcES) { nfcES.close(); nfcES = null; }
                if (tapPollTimer) clearInterval(tapPollTimer);
                clearTimeout(timeoutTimer);
                clearTimeout(maxTimer);
                showCard(cardId);
            }

            // SSE message handler (shared across connect + retry)
            function handleSSEMessage(e) {
                cfLog('SSE', 'Visitor SSE message', e.data.substring(0, 100));
                try {
                    var val = JSON.parse(e.data);
                    if (val && val.card && CARDS[val.card]) onCardReceived(val.card);
                } catch(err) { cfLog('SSE', 'Parse error: ' + err.message); }
            }

            // Open SSE connection with auto-retry
            function openVisitorSSE() {
                cfLog('SSE', 'Opening visitor SSE: tap/' + resolvedUserId + '/' + sid);
                nfcES = new EventSource('/api/public/sse/tap/'+resolvedUserId+'/'+sid);
                nfcES.onopen = function() { cfLog('SSE', 'Visitor SSE connected'); };
                nfcES.onmessage = handleSSEMessage;
                nfcES.onerror = function() {
                    cfLog('SSE', 'Visitor SSE error, readyState=' + (nfcES ? nfcES.readyState : 'null'));
                    if (nfcES && nfcES.readyState === 2) {
                        nfcES.close(); nfcES = null;
                        // Retry after 2s if card not yet received
                        if (!cardReceived) setTimeout(function() { if (!cardReceived) openVisitorSSE(); }, 2000);
                    }
                };
            }
            openVisitorSSE();

            // Start polling IMMEDIATELY alongside SSE (belt + suspenders)
            var tapPollTimer = setInterval(function() {
                if (cardReceived) return;
                publicFetch('/user/'+resolvedUserId+'/taps/'+sid).then(function(r){ return r.json(); }).then(function(tap) {
                    if (tap && tap.card && CARDS[tap.card]) {
                        cfLog('POLL', 'Card received via poll: ' + tap.card);
                        onCardReceived(tap.card);
                    }
                }).catch(function(){});
            }, 3000);

            // Soft timeout (45s) — show notice but keep SSE + polling alive
            timeoutTimer = setTimeout(function() {
                cfLog('TIMEOUT', '45s soft timeout');
                if (!cardReceived) document.getElementById('timeoutNotice').classList.add('show');
            }, 45000);

            // Hard timeout (3 min) — give up entirely
            var maxTimer = setTimeout(function() {
                cfLog('TIMEOUT', '3min hard timeout');
                if (nfcES) { nfcES.close(); nfcES = null; }
                if (tapPollTimer) clearInterval(tapPollTimer);
                if (!cardReceived) publicFetch('/user/'+resolvedUserId+'/taps/'+sid, {method:'PATCH', body:{timeout:true}}).catch(function(){});
            }, 180000);
        }
    } else {
        showError('Card not found');
    }
}

// Start visitor tracking + route resolution in parallel
Promise.all([initVisitor(), resolveRoute()]).then(function() {
    detectOwnerPreview();
    initCardFlow();
});

// ── Toggle manual input section ──
function toggleManual() {
    document.getElementById('manualToggle').classList.toggle('open');
    document.getElementById('manualFields').classList.toggle('open');
}

// ── Card Scan with OCR (server-side LLM → client Tesseract fallback) ──
function scanCard(input) {
    if (!input.files || !input.files[0]) return;

    var scanBtn = document.getElementById('scanBtn');
    var scanStatus = document.getElementById('scanStatus');
    var checkSvg = '<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>';

    var cameraSvg = '<svg viewBox="0 0 24 24"><path d="M9 3L7.17 5H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2h-3.17L15 3H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg>';

    // Show preview immediately from raw file
    var preview = document.getElementById('photoPreview');
    var rawUrl = URL.createObjectURL(input.files[0]);
    preview.src = rawUrl;
    preview.style.display = 'block';

    scanBtn.classList.add('scanning');
    scanBtn.innerHTML = checkSvg + 'Sending...';
    scanStatus.textContent = 'Uploading your card photo...';
    scanStatus.classList.add('show');

    var file = input.files[0];
    var reader = new FileReader();

    reader.onload = function(e) {
        var img = new Image();
        img.onload = function() {
            var canvas = document.createElement('canvas');
            var max = 800, w = img.width, h = img.height;
            if (w > max || h > max) {
                if (w > h) { h = Math.round(h*max/w); w = max; } else { w = Math.round(w*max/h); h = max; }
            }
            canvas.width = w; canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
            var imageData = canvas.toDataURL('image/jpeg', 0.7);
            cardPhotoData = imageData;
            cfLog('SCAN', 'Image compressed: ' + Math.round(imageData.length/1024) + 'KB');

            if (!resolvedUserId) { showScanFallback(imageData, scanBtn, scanStatus, cameraSvg); return; }
            var data = {ts:Date.now(),source:visitSource,card:directCard||'',visitorId:visitorId,visitor:{device:device,browser:browser},photo:imageData};
            cfLog('SCAN', 'Sending card image as lead');
            publicFetch('/user/'+resolvedUserId+'/leads/'+sid, {method:'PUT', body:data})
                .then(function(r) {
                    if (r.status === 403) {
                        scanBtn.classList.remove('scanning');
                        scanBtn.innerHTML = checkSvg + 'Sent!';
                        scanStatus.textContent = 'This person\'s inbox is full.';
                        return;
                    }
                    if (!r.ok) return r.json().then(function(err) { throw new Error(err.error || 'Server error ' + r.status); });
                    leadSubmitted = true;
                    scanBtn.classList.remove('scanning');
                    scanBtn.innerHTML = checkSvg + 'Card shared!';
                    scanStatus.textContent = 'Your card has been shared with ' + (resolvedUsername || 'the card owner') + '.';
                    publicFetch('/user/'+resolvedUserId+'/taps/'+sid, {method:'PATCH', body:{lead:{photo:true}}}).catch(function(){});
                    cfLog('SCAN', 'Card image sent successfully');
                })
                .catch(function(err) {
                    cfLog('SCAN', 'Send failed: ' + err.message);
                    showScanFallback(imageData, scanBtn, scanStatus, cameraSvg);
                });
        };
        img.onerror = function() { showScanFallback(null, scanBtn, scanStatus, cameraSvg); };
        img.src = e.target.result;
    };
    reader.onerror = function() { showScanFallback(null, scanBtn, scanStatus, cameraSvg); };
    reader.readAsDataURL(file);
    input.value = '';
}

function showScanFallback(imageData, scanBtn, scanStatus, cameraSvg) {
    scanBtn.classList.remove('scanning');
    scanBtn.innerHTML = (cameraSvg || '') + 'Share my business card';
    scanStatus.textContent = 'Could not send. Try again or fill manually.';
    if (imageData) cardPhotoData = imageData;
    if (imageData) {
        var preview = document.getElementById('photoPreview');
        preview.src = imageData; preview.style.display = 'block';
    }
    if (!document.getElementById('manualFields').classList.contains('open')) toggleManual();
}

function runClientOCR(imageData, onSuccess, onError) {
    Tesseract.recognize(imageData, 'eng', {
        logger: function(m) {
            if (m.status === 'recognizing text') {
                var pct = Math.round(m.progress * 100);
                var el = document.getElementById('scanStatus') || document.getElementById('clfScanStatus');
                if (el) el.textContent = 'Reading... ' + pct + '%';
            }
        }
    }).then(function(result) {
        var text = result.data.text;
        var parsed = parseBusinessCard(text);
        onSuccess(parsed, text);
    }).catch(function(err) {
        console.error('Client OCR error:', err);
        onError();
    });
}

// ── Parse business card text ──
function parseBusinessCard(text) {
    var result = {name: '', phone: '', email: '', company: ''};
    var lines = text.split('\n').map(function(l) { return l.trim(); }).filter(function(l) { return l.length > 0; });

    // Email pattern
    var emailMatch = text.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/i);
    if (emailMatch) result.email = emailMatch[0].toLowerCase();

    // Phone patterns (various formats)
    var phonePatterns = [
        /\+?\d{1,3}[-.\s]?\(?\d{2,4}\)?[-.\s]?\d{3,4}[-.\s]?\d{3,4}/,
        /\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}/,
        /\d{10,12}/
    ];
    for (var i = 0; i < phonePatterns.length; i++) {
        var phoneMatch = text.match(phonePatterns[i]);
        if (phoneMatch) {
            result.phone = phoneMatch[0].replace(/[^\d+]/g, '');
            if (result.phone.length >= 10) break;
        }
    }

    // Common company indicators
    var companyKeywords = ['pvt', 'ltd', 'llc', 'inc', 'corp', 'limited', 'private', 'solutions', 'services', 'technologies', 'tech', 'group', 'consulting', 'enterprises', 'industries', 'international', 'global'];

    // Find name and company from lines
    for (var j = 0; j < lines.length; j++) {
        var line = lines[j];
        var lineLower = line.toLowerCase();

        // Skip lines that are email/phone/url
        if (line.includes('@') || /^\+?\d[\d\s.-]{8,}$/.test(line) || /^(www\.|http)/i.test(line)) continue;

        // Check if line looks like company name
        var isCompany = companyKeywords.some(function(kw) { return lineLower.includes(kw); });
        if (isCompany && !result.company) {
            result.company = line;
            continue;
        }

        // First substantial text line (2+ words, no special chars) is likely the name
        if (!result.name && /^[A-Za-z\s.'-]{3,40}$/.test(line)) {
            var words = line.split(/\s+/);
            if (words.length >= 1 && words.length <= 4) {
                // Looks like a name
                result.name = line.split(' ').map(function(w) {
                    return w.charAt(0).toUpperCase() + w.slice(1).toLowerCase();
                }).join(' ');
            }
        }
    }

    return result;
}

// ── Lead form ──
function previewPhoto(input) {
    if (!input.files || !input.files[0]) return;
    var reader = new FileReader();
    reader.onload = function(e) {
        var img = new Image();
        img.onload = function() {
            var canvas = document.createElement('canvas');
            var max = 800, w = img.width, h = img.height;
            if (w > max || h > max) {
                if (w > h) { h = h*max/w; w = max; } else { w = w*max/h; h = max; }
            }
            canvas.width = w; canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
            cardPhotoData = canvas.toDataURL('image/jpeg', 0.6);
            var p = document.getElementById('photoPreview');
            p.src = cardPhotoData; p.style.display = 'block';
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(input.files[0]);
}

function getLeadData() {
    var name = document.getElementById('vName').value.trim();
    var phone = document.getElementById('vPhone').value.trim();
    var email = document.getElementById('vEmail').value.trim();
    var company = document.getElementById('vCompany').value.trim();
    if (!name && !phone && !email) return null;
    var data = {name:name,phone:phone,email:email,company:company,ts:Date.now(),source:visitSource,card:directCard||'',visitorId:visitorId,visitor:{device:device,browser:browser}};
    if (cardPhotoData) data.photo = cardPhotoData;
    return data;
}

function submitLead() {
    var data = getLeadData();
    if (!data) return;
    var btn = document.getElementById('submitBtn');
    btn.textContent = 'Sharing...';
    btn.disabled = true;
    if (resolvedUserId) {
        publicFetch('/user/'+resolvedUserId+'/leads/'+sid, {method:'PUT', body:data})
            .then(function(r) {
                if (r.status === 403) {
                    return r.json().then(function(body) {
                        if (body && body.error === 'lead_limit') {
                            btn.textContent = 'Could not share — limit reached';
                            btn.disabled = false;
                        } else {
                            btn.textContent = 'Failed to share. Try again.';
                            btn.disabled = false;
                        }
                        throw new Error('blocked');
                    });
                }
                if (!r.ok) throw new Error('fail');
                leadSubmitted = true;
                btn.textContent = 'Shared!';
                btn.classList.add('sent');
                publicFetch('/user/'+resolvedUserId+'/taps/'+sid, {method:'PATCH', body:{lead:data}}).catch(function(){});
            })
            .catch(function(err) {
                if (err.message === 'blocked') return;
                btn.textContent = 'Failed to share. Try again.';
                btn.disabled = false;
            });
    }
}

// ── Card-page lead form ──
function toggleCardLeadForm() {
    var toggle = document.getElementById('cardLeadToggle');
    var form = document.getElementById('cardLeadForm');
    if (toggle) toggle.classList.toggle('open');
    if (form) form.classList.toggle('open');
}

function submitCardLead() {
    var name = (document.getElementById('clfName').value || '').trim();
    var phone = (document.getElementById('clfPhone').value || '').trim();
    var email = (document.getElementById('clfEmail').value || '').trim();
    var company = (document.getElementById('clfCompany').value || '').trim();
    if (!name && !phone && !email) return;
    var data = {name:name, phone:phone, email:email, company:company, source:visitSource, ts:Date.now(), device:device, browser:browser};
    if (cardPhotoData) data.photo = cardPhotoData;
    var btn = document.getElementById('clfSubmitBtn');
    btn.textContent = 'Sharing...';
    btn.disabled = true;
    if (resolvedUserId) {
        publicFetch('/user/'+resolvedUserId+'/leads/'+sid, {method:'PUT', body:data})
            .then(function(r) {
                if (r.status === 403) {
                    return r.json().then(function(body) {
                        btn.textContent = (body && body.error === 'lead_limit') ? 'Could not share — limit reached' : 'Failed. Try again.';
                        btn.disabled = false;
                        throw new Error('blocked');
                    });
                }
                if (!r.ok) throw new Error('fail');
                leadSubmitted = true;
                btn.textContent = 'Shared!';
                btn.classList.add('sent');
                publicFetch('/user/'+resolvedUserId+'/taps/'+sid, {method:'PATCH', body:{lead:data}}).catch(function(){});
                // Replace form with confirmation
                var section = document.querySelector('.card-lead-section');
                if (section) section.innerHTML = '<div class="card-lead-sent"><svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>Your details have been shared</div>';
            })
            .catch(function(err) {
                if (err.message === 'blocked') return;
                btn.textContent = 'Failed. Try again.';
                btn.disabled = false;
            });
    }
}

function toggleClfManual() {
    var m = document.getElementById('clfManual');
    if (m) m.classList.toggle('open');
}

function scanCardLead(input) {
    if (!input.files || !input.files[0]) return;

    var scanBtn = document.getElementById('clfScanBtn');
    var scanStatus = document.getElementById('clfScanStatus');
    var checkSvg = '<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>';
    var cameraSvg = '<svg viewBox="0 0 24 24"><path d="M9 3L7.17 5H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2h-3.17L15 3H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg>';

    // Show preview immediately
    var clfPreview = document.getElementById('clfPreview');
    if (clfPreview) { clfPreview.src = URL.createObjectURL(input.files[0]); clfPreview.style.display = 'block'; }

    scanBtn.classList.add('scanning');
    scanBtn.innerHTML = checkSvg + 'Sending...';
    scanStatus.textContent = 'Uploading your card photo...';
    scanStatus.classList.add('show');

    var file = input.files[0];
    var reader = new FileReader();

    reader.onload = function(e) {
        var img = new Image();
        img.onload = function() {
            var canvas = document.createElement('canvas');
            var max = 800, w = img.width, h = img.height;
            if (w > max || h > max) {
                if (w > h) { h = Math.round(h*max/w); w = max; } else { w = Math.round(w*max/h); h = max; }
            }
            canvas.width = w; canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
            var imageData = canvas.toDataURL('image/jpeg', 0.7);
            cardPhotoData = imageData;
            cfLog('SCAN', 'Image compressed: ' + Math.round(imageData.length/1024) + 'KB (card page)');

            if (!resolvedUserId) {
                scanBtn.classList.remove('scanning');
                scanBtn.innerHTML = cameraSvg + 'Share my business card';
                scanStatus.textContent = 'Could not send. Please fill manually.';
                var manual = document.getElementById('clfManual');
                if (manual && !manual.classList.contains('open')) manual.classList.add('open');
                return;
            }
            var data = {ts:Date.now(),source:visitSource,card:directCard||'',visitorId:visitorId,visitor:{device:device,browser:browser},photo:imageData};
            cfLog('SCAN', 'Sending card image as lead (card page)');
            publicFetch('/user/'+resolvedUserId+'/leads/'+sid, {method:'PUT', body:data})
                .then(function(r) {
                    if (r.status === 403) {
                        scanBtn.classList.remove('scanning');
                        scanBtn.innerHTML = checkSvg + 'Sent!';
                        scanStatus.textContent = 'This person\'s inbox is full.';
                        return;
                    }
                    if (!r.ok) return r.json().then(function(err) { throw new Error(err.error || 'Server error'); });
                    leadSubmitted = true;
                    scanBtn.classList.remove('scanning');
                    scanBtn.innerHTML = checkSvg + 'Card shared!';
                    scanStatus.textContent = 'Your card has been shared with ' + (resolvedUsername || 'the card owner') + '.';
                    publicFetch('/user/'+resolvedUserId+'/taps/'+sid, {method:'PATCH', body:{lead:{photo:true}}}).catch(function(){});
                    var section = document.querySelector('.card-lead-section');
                    if (section) section.innerHTML = '<div class="card-lead-sent"><svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>Your card has been shared</div>';
                    cfLog('SCAN', 'Card image sent successfully (card page)');
                })
                .catch(function(err) {
                    cfLog('SCAN', 'Send failed (card page): ' + err.message);
                    scanBtn.classList.remove('scanning');
                    scanBtn.innerHTML = cameraSvg + 'Share my business card';
                    scanStatus.textContent = 'Could not send. Try again or fill manually.';
                    var manual = document.getElementById('clfManual');
                    if (manual && !manual.classList.contains('open')) manual.classList.add('open');
                });
        };
        img.onerror = function() {
            scanBtn.classList.remove('scanning');
            scanBtn.innerHTML = cameraSvg + 'Share my business card';
            scanStatus.textContent = 'Could not read image. Try again.';
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
    input.value = '';
}

// ── Render card ──
function showCard(id, skipWait) {
    var c = CARDS[id];
    if (!c) return;

    // Ensure defaults for optional fields (raw values for logic)
    var name = c.name || 'Business Card';
    var title = c.title || '';
    var company = c.company || '';
    var phone = (c.phone || '').replace(/[^0-9+\-() ]/g,'');
    var phoneDisplay = c.phoneDisplay || phone;
    var email = c.email || '';
    var address = c.address || '';
    var addressQuery = c.addressQuery || '';
    var website = c.website || '';
    var websiteDisplay = c.websiteDisplay || '';
    var whatsapp = (c.whatsapp || phone).replace(/[^0-9]/g,'');
    var bio = c.bio || '';
    // Sanitize colors to prevent CSS injection
    var color1 = sanitizeColor(c.color1 || c.color) || '#1B1464';
    var color2 = sanitizeColor(c.color2) || '#0D0D3B';
    var accent = sanitizeColor(c.accent) || color1;
    var accentLight = sanitizeColor(c.accentLight) || '#EEF0FF';
    // HTML-escaped versions for display in innerHTML
    var eName = escapeHtml(name);
    var eTitle = escapeHtml(title);
    var eCompany = escapeHtml(company);
    var ePhoneDisplay = escapeHtml(phoneDisplay);
    var eEmail = escapeHtml(email);
    var eAddress = escapeHtml(address);
    var eWebsiteDisplay = escapeHtml(websiteDisplay || website);
    var eBio = escapeHtml(bio);

    // Haptic feedback
    if (navigator.vibrate) navigator.vibrate(50);

    // Track view
    trackEvent(id, 'views', 'view');

    // Record card view in visitor profile (skip for owner previews)
    if (visitorId && resolvedUserId && !isOwnerPreview) {
        publicFetch('/visitors/'+visitorId+'/viewed', {method:'PATCH', body:{ownerId:resolvedUserId, cardId:id}}).catch(function(){});
    }

    // Track which card was shown (stored in tap, not lead — lead only created on form submit)
    if (resolvedUserId && !isOwnerPreview) publicFetch('/user/'+resolvedUserId+'/taps/'+sid, {method:'PATCH', body:{card:id}}).catch(function(){});

    var wa = encodeURIComponent('Hi '+(name.split(' ')[0])+', I got your card!');
    var waitEl = document.getElementById('waiting');
    if (!skipWait) {
        waitEl.classList.add('hide-out');
        setTimeout(function(){ waitEl.style.display = 'none'; }, 300);
    }
    var el = document.getElementById('card');

    // Avatar: profile photo > company logo > initials
    var avatarContent;
    if (c.photo && sanitizeUrl(c.photo)) {
        avatarContent = '<img src="'+escapeHtml(c.photo)+'" alt="'+eName+'">';
    } else if (c.logo && sanitizeUrl(c.logo)) {
        avatarContent = '<img class="avatar-logo" src="'+escapeHtml(c.logo)+'" alt="'+eCompany+'">';
    } else {
        var initials = name.split(' ').map(function(n){return n[0]}).join('').substring(0,2).toUpperCase();
        avatarContent = '<div class="avatar-mark"><svg viewBox="0 0 512 512"><path d="M340 108H172C148 108 128 128 128 152V360C128 384 148 404 172 404H340C306 370 286 318 286 256C286 194 306 142 340 108Z" fill="white"/><circle cx="372" cy="256" r="24" fill="white"/></svg></div><span class="avatar-initials">'+(escapeHtml(initials) || 'CF')+'</span>';
    }

    // Build card HTML
    var eSubtitle = [eTitle, eCompany].filter(function(s){return s}).join(' &middot; ');
    var avatarClass = (!c.photo && !c.logo) ? 'avatar avatar-branded' : 'avatar';
    var h = '<section class="hero" style="background:linear-gradient(160deg,'+color1+','+color2+')">'+
        '<div class="'+avatarClass+'">'+avatarContent+'</div>'+
        '<h1>'+eName+(c.verified_at ? ' <span class="verified-badge" title="Verified"><svg viewBox="0 0 24 24" width="20" height="20" fill="none"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z" fill="#059669"/><path d="M9 12l2 2 4-4" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg></span>' : '')+'</h1>'+(eSubtitle ? '<p>'+eSubtitle+'</p>' : '')+
        '<div class="social-proof" id="socialProof" style="display:none"><svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg><span id="socialProofText"></span></div>'+
        '</section>';

    h += '<div class="quick-actions">';
    if (phone) h += '<a href="tel:'+escapeHtml(phone)+'" class="action-btn" style="color:'+accent+'" onclick="trackClick(\''+id+'\',\'call\')"><div class="ic" style="background:'+accentLight+'"><svg viewBox="0 0 24 24" fill="'+accent+'"><path d="M6.62 10.79a15.05 15.05 0 0 0 6.59 6.59l2.2-2.2a1 1 0 0 1 1.01-.24c1.12.37 2.33.57 3.58.57a1 1 0 0 1 1 1V20a1 1 0 0 1-1 1A17 17 0 0 1 3 4a1 1 0 0 1 1-1h3.5a1 1 0 0 1 1 1c0 1.25.2 2.46.57 3.58a1 1 0 0 1-.24 1.01l-2.2 2.2z"/></svg></div><span>Call</span></a>';
    if (whatsapp) h += '<a href="https://wa.me/'+escapeHtml(whatsapp)+'?text='+wa+'" class="action-btn" target="_blank" rel="noopener" style="color:'+accent+'" onclick="trackClick(\''+id+'\',\'whatsapp\')"><div class="ic" style="background:'+accentLight+'"><svg viewBox="0 0 24 24" fill="'+accent+'"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51l-.57-.01c-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347zM12.05 21.785h-.01a9.87 9.87 0 0 1-5.031-1.378l-.361-.214-3.741.981.998-3.648-.235-.374A9.86 9.86 0 0 1 2.15 12.01C2.15 6.558 6.558 2.15 12.05 2.15c2.634 0 5.122 1.03 6.988 2.898a9.825 9.825 0 0 1 2.893 6.994c-.003 5.45-4.437 9.884-9.88 9.884v-.14zM20.52 3.449C18.24 1.245 15.24 0 12.05 0 5.464 0 .104 5.334.1 11.893a11.793 11.793 0 0 0 1.587 5.946L0 24l6.305-1.654a11.882 11.882 0 0 0 5.683 1.448h.005c6.585 0 11.946-5.336 11.949-11.896a11.81 11.81 0 0 0-3.48-8.397z"/></svg></div><span>WhatsApp</span></a>';
    if (email) h += '<a href="mailto:'+escapeHtml(email)+'" class="action-btn" style="color:'+accent+'" onclick="trackClick(\''+id+'\',\'email\')"><div class="ic" style="background:'+accentLight+'"><svg viewBox="0 0 24 24" fill="'+accent+'"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg></div><span>Email</span></a>';
    h += '</div>';

    // Social Links
    var socials = '';
    if (c.linkedin && sanitizeUrl(c.linkedin)) socials += '<a href="'+escapeHtml(c.linkedin)+'" target="_blank" rel="noopener" aria-label="LinkedIn" class="social-link" style="background:'+accentLight+'" onclick="trackClick(\''+id+'\',\'linkedin\')"><svg viewBox="0 0 24 24" fill="'+accent+'"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg></a>';
    if (c.instagram && sanitizeUrl(c.instagram)) socials += '<a href="'+escapeHtml(c.instagram)+'" target="_blank" rel="noopener" aria-label="Instagram" class="social-link" style="background:'+accentLight+'" onclick="trackClick(\''+id+'\',\'instagram\')"><svg viewBox="0 0 24 24" fill="'+accent+'"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741 0 8.333.014 7.053.072 2.695.272.273 2.69.073 7.052.014 8.333 0 8.741 0 12c0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24c3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98C15.668.014 15.259 0 12 0zm0 5.838a6.162 6.162 0 1 0 0 12.324 6.162 6.162 0 0 0 0-12.324zM12 16a4 4 0 1 1 0-8 4 4 0 0 1 0 8zm6.406-11.845a1.44 1.44 0 1 0 0 2.881 1.44 1.44 0 0 0 0-2.881z"/></svg></a>';
    if (c.twitter && sanitizeUrl(c.twitter)) socials += '<a href="'+escapeHtml(c.twitter)+'" target="_blank" rel="noopener" aria-label="X (Twitter)" class="social-link" style="background:'+accentLight+'" onclick="trackClick(\''+id+'\',\'twitter\')"><svg viewBox="0 0 24 24" fill="'+accent+'"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></a>';
    if (c.calendly && sanitizeUrl(c.calendly)) socials += '<a href="'+escapeHtml(c.calendly)+'" target="_blank" rel="noopener" aria-label="Book a meeting" class="social-link" style="background:'+accentLight+'" onclick="trackClick(\''+id+'\',\'calendly\')"><svg viewBox="0 0 24 24" fill="'+accent+'"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11zM9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2z"/></svg></a>';
    if (socials) {
        h += '<div class="social-row">'+socials+'</div>';
    }

    // Save Contact is in fixed bottom bar — no inline button needed

    // About
    if (bio) {
        var bioLong = bio.length > 180;
        h += '<section class="about"><h2 class="section-title" style="color:'+accent+'">About</h2><div class="about-text'+(bioLong?' collapsed':'')+'" id="aboutText"><p>'+eBio.replace(/\n/g, '<br>')+'</p></div>';
        if (bioLong) h += '<button class="view-more show" style="color:'+accent+'" onclick="toggleBio()">View more</button>';
        h += '</section>';
    }

    // Products / Services
    if (c.products && c.products.length > 0) {
        h += '<section class="products"><h2 class="section-title" style="color:'+accent+'">Products & Services</h2><div class="products-scroll">';
        c.products.forEach(function(p) {
            var pName = escapeHtml(p.name);
            var pPrice = escapeHtml(p.price);
            var pImage = (p.image && sanitizeUrl(p.image)) ? escapeHtml(p.image) : '';
            var pNameAttr = escapeHtml(p.name.replace(/'/g,''));
            h += '<div class="product-card">'+(pImage ? '<img class="product-img" src="'+pImage+'" alt="'+pName+'" onerror="this.style.display=\'none\'">' : '')+'<div class="product-info"><div class="product-name">'+pName+'</div><div class="product-price">'+pPrice+'</div><button class="enquire-btn" style="background:'+accentLight+';color:'+accent+'" onclick="enquireProduct(\''+esc(id)+'\',\''+pNameAttr+'\')">Enquire</button></div></div>';
        });
        h += '</div></section>';
    }

    if (phone || email || address || website) {
        h += '<section class="contact-details"><h2 class="section-title" style="color:'+accent+'">Contact</h2>';
        if (phone) h += '<a href="tel:'+escapeHtml(phone)+'" class="contact-item" onclick="trackClick(\''+id+'\',\'call\')"><div class="ib" style="background:'+accentLight+'"><svg viewBox="0 0 24 24" fill="'+accent+'"><path d="M6.62 10.79a15.05 15.05 0 0 0 6.59 6.59l2.2-2.2a1 1 0 0 1 1.01-.24c1.12.37 2.33.57 3.58.57a1 1 0 0 1 1 1V20a1 1 0 0 1-1 1A17 17 0 0 1 3 4a1 1 0 0 1 1-1h3.5a1 1 0 0 1 1 1c0 1.25.2 2.46.57 3.58a1 1 0 0 1-.24 1.01l-2.2 2.2z"/></svg></div><div class="detail"><span class="label">Phone</span><span class="value">'+ePhoneDisplay+'</span></div></a>';
        if (email) h += '<a href="mailto:'+escapeHtml(email)+'" class="contact-item" onclick="trackClick(\''+id+'\',\'email\')"><div class="ib" style="background:'+accentLight+'"><svg viewBox="0 0 24 24" fill="'+accent+'"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg></div><div class="detail"><span class="label">Email</span><span class="value">'+eEmail+'</span></div></a>';
        if (address) h += '<a href="https://maps.google.com/?q='+encodeURIComponent(addressQuery||address)+'" class="contact-item" target="_blank" rel="noopener"><div class="ib" style="background:'+accentLight+'"><svg viewBox="0 0 24 24" fill="'+accent+'"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5z"/></svg></div><div class="detail"><span class="label">Address</span><span class="value">'+eAddress+'</span></div></a>';
        if (website && sanitizeUrl(website)) h += '<a href="'+escapeHtml(website)+'" class="contact-item" target="_blank" rel="noopener" onclick="trackClick(\''+id+'\',\'website\')"><div class="ib" style="background:'+accentLight+'"><svg viewBox="0 0 24 24" fill="'+accent+'"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zm6.93 6h-2.95a15.65 15.65 0 0 0-1.38-3.56A8.03 8.03 0 0 1 18.92 8zM12 4.04c.83 1.2 1.48 2.53 1.91 3.96h-3.82c.43-1.43 1.08-2.76 1.91-3.96zM4.26 14C4.1 13.36 4 12.69 4 12s.1-1.36.26-2h3.38c-.08.66-.14 1.32-.14 2s.06 1.34.14 2H4.26zm.82 2h2.95c.32 1.25.78 2.45 1.38 3.56A7.987 7.987 0 0 1 5.08 16zm2.95-8H5.08a7.987 7.987 0 0 1 4.33-3.56A15.65 15.65 0 0 0 8.03 8zM12 19.96c-.83-1.2-1.48-2.53-1.91-3.96h3.82c-.43 1.43-1.08 2.76-1.91 3.96zM14.34 14H9.66c-.09-.66-.16-1.32-.16-2s.07-1.35.16-2h4.68c.09.65.16 1.32.16 2s-.07 1.34-.16 2zm.25 5.56c.6-1.11 1.06-2.31 1.38-3.56h2.95a8.03 8.03 0 0 1-4.33 3.56zM16.36 14c.08-.66.14-1.32.14-2s-.06-1.34-.14-2h3.38c.16.64.26 1.31.26 2s-.1 1.36-.26 2h-3.38z"/></svg></div><div class="detail"><span class="label">Website</span><span class="value">'+eWebsiteDisplay+'</span></div></a>';
        h += '</section>';
    }

    // Share is in fixed bottom bar

    // Exchange section
    var cfToken = null;
    var cfUser = null;
    try { cfToken = localStorage.getItem('token'); if (cfToken) cfUser = JSON.parse(localStorage.getItem('user') || 'null'); } catch(e) {}
    if (cfToken && cfUser && cfUser.id !== resolvedUserId) {
        h += '<section class="exchange-section">'+
            '<button class="exchange-btn" id="exchangeBtn" onclick="exchangeCard(\''+esc(id)+'\')">'+
            '<svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M21 9l-4-4v3h-7v2h7v3M7 11l-4 4l4 4v-3h7v-2H7v-3z"/></svg>'+
            ' Exchange my card</button></section>';
    } else if (!cfToken) {
        h += '<section class="exchange-section">'+
            '<a href="/signup?ref='+encodeURIComponent(resolvedUsername||'exchange')+'" class="exchange-cta">'+
            '<svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M21 9l-4-4v3h-7v2h7v3M7 11l-4 4l4 4v-3h7v-2H7v-3z"/></svg>'+
            ' Create your free card to exchange</a></section>';
    }

    // Lead form — keep an inline fallback for users who scroll down
    if (leadSubmitted) {
        h += '<section class="card-lead-section"><div class="card-lead-sent"><svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>Your details have been shared</div></section>';
    } else {
        h += '<section class="card-lead-section">';
        h += '<button class="card-lead-toggle" id="cardLeadToggle" onclick="toggleCardLeadForm()"><svg viewBox="0 0 24 24"><path d="M21 9l-4-4v3h-7v2h7v3M7 11l-4 4l4 4v-3h7v-2H7v-3z"/></svg> Share your details back<svg class="arrow" viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6z"/></svg></button>';
        h += '<div class="card-lead-form" id="cardLeadForm"><div class="card-lead-form-inner">';
        h += '<button class="clf-scan-btn" id="clfScanBtn" onclick="document.getElementById(\'clfFileInput\').click()"><svg viewBox="0 0 24 24"><path d="M9.5 6.5v3h-3v-3h3M11 5H5v6h6V5zm-1.5 9.5v3h-3v-3h3M11 13H5v6h6v-6zm6.5-6.5v3h-3v-3h3M19 5h-6v6h6V5zm-6 8h1.5v1.5H13V13zm1.5 1.5H16V16h-1.5v-1.5zM16 13h1.5v1.5H16V13zm-3 3h1.5v1.5H13V16zm1.5 1.5H16V19h-1.5v-1.5zM16 16h1.5v1.5H16V16zm1.5-1.5H19V16h-1.5v-1.5zm0 3H19V19h-1.5v-1.5zM19 13h-1.5v1.5H19V13z"/></svg>Scan my business card</button>';
        h += '<input type="file" id="clfFileInput" accept="image/*" capture="environment" style="display:none" onchange="scanCardLead(this)">';
        h += '<div class="clf-scan-status" id="clfScanStatus"></div>';
        h += '<div class="clf-or" onclick="toggleClfManual()">or fill manually</div>';
        h += '<div class="clf-manual" id="clfManual">';
        h += '<img class="clf-preview" id="clfPreview">';
        h += '<div class="clf-field"><input type="text" id="clfName" placeholder="Your name" autocomplete="name"></div>';
        h += '<div class="clf-field"><input type="tel" id="clfPhone" placeholder="Phone number" autocomplete="tel"></div>';
        h += '<div class="clf-field"><input type="email" id="clfEmail" placeholder="Email" autocomplete="email"></div>';
        h += '<div class="clf-field"><input type="text" id="clfCompany" placeholder="Company" autocomplete="organization"></div>';
        h += '</div>';
        h += '<button class="clf-submit" id="clfSubmitBtn" onclick="submitCardLead()">Share my details</button>';
        h += '</div></div></section>';
    }

    // Enhanced powered-by footer with stronger CTA
    var refParam = encodeURIComponent(resolvedUsername||'powered');
    h += '<div style="text-align:center;padding:24px 24px 16px;background:linear-gradient(180deg,#f8fafc,#f1f5f9)">';
    h += '<a href="/signup?ref='+refParam+'" style="display:inline-flex;align-items:center;gap:8px;padding:12px 24px;background:linear-gradient(135deg,var(--accent),var(--accent-secondary));color:#fff;border-radius:12px;font-size:14px;font-weight:600;text-decoration:none;box-shadow:0 4px 16px var(--accent-glow);transition:all .2s">Create your free card</a>';
    h += '<p style="margin-top:12px;font-size:12px;color:#607085">Made with <a href="/signup?ref='+refParam+'" style="color:var(--accent);text-decoration:none;font-weight:600">CardFlow</a></p>';
    h += '</div>';
    h += '<footer class="footer" style="padding-bottom:calc(90px + env(safe-area-inset-bottom))"><p>'+(eCompany || eName)+' &copy; ' + new Date().getFullYear() + '</p></footer>';

    // Fixed bottom bar
    h += '<div class="fixed-bottom-bar" id="fixedBottomBar"><div class="fixed-bottom-inner">';
    h += '<button class="fixed-save-btn" style="background:linear-gradient(135deg,'+color1+','+color2+')" onclick="saveContact(\''+esc(id)+'\');trackClick(\''+esc(id)+'\',\'save_contact\')"><svg viewBox="0 0 24 24"><path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2v9.67z"/></svg>Save Contact</button>';
    h += '<button class="fixed-share-btn" aria-label="Share card" onclick="shareCard(\''+esc(id)+'\')"><svg viewBox="0 0 24 24" fill="#64748b"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/></svg></button>';
    h += '</div></div>';
    el.innerHTML = h;
    el.classList.add('show');
    document.title = name + ' — CardFlow';

    // Show fixed bottom bar after a brief delay
    setTimeout(function(){
        var bar = document.getElementById('fixedBottomBar');
        if (bar) bar.classList.add('show');
    }, 800);

    // Fetch social proof (view count)
    if (resolvedUserId) {
        publicFetch('/user/'+resolvedUserId+'/analytics/'+id+'/views/count')
            .then(function(r){ return r.json(); })
            .then(function(d){
                var count = (d && d.count) ? d.count : 0;
                if (count >= 5) {
                    var proofEl = document.getElementById('socialProof');
                    var proofText = document.getElementById('socialProofText');
                    if (proofEl && proofText) {
                        proofText.textContent = count + ' people viewed this card';
                        proofEl.style.display = '';
                    }
                }
            }).catch(function(){});
    }

    // Pre-fill card-page form from waiting-screen inputs
    var wName = document.getElementById('vName');
    var wPhone = document.getElementById('vPhone');
    var wEmail = document.getElementById('vEmail');
    var wCompany = document.getElementById('vCompany');
    var hasWaitData = false;
    if (wName && wName.value) { var cf = document.getElementById('clfName'); if (cf) cf.value = wName.value; hasWaitData = true; }
    if (wPhone && wPhone.value) { var cf2 = document.getElementById('clfPhone'); if (cf2) cf2.value = wPhone.value; hasWaitData = true; }
    if (wEmail && wEmail.value) { var cf3 = document.getElementById('clfEmail'); if (cf3) cf3.value = wEmail.value; hasWaitData = true; }
    if (wCompany && wCompany.value) { var cf4 = document.getElementById('clfCompany'); if (cf4) cf4.value = wCompany.value; hasWaitData = true; }
    // If waiting screen had data or a scanned photo, open manual fields and show preview
    if (hasWaitData || cardPhotoData) {
        var clfM = document.getElementById('clfManual');
        if (clfM && !clfM.classList.contains('open')) clfM.classList.add('open');
        if (cardPhotoData) {
            var clfP = document.getElementById('clfPreview');
            if (clfP) { clfP.src = cardPhotoData; clfP.style.display = 'block'; }
            var clfSB = document.getElementById('clfScanBtn');
            if (clfSB) clfSB.innerHTML = '<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>Card scanned!';
        }
    }

    // Auto-submit lead data if any was filled on waiting screen
    if (!leadSubmitted && resolvedUserId) {
        var data = getLeadData();
        if (data) {
            publicFetch('/user/'+resolvedUserId+'/leads/'+sid, {method:'PUT', body:data}).catch(function(){});
            publicFetch('/user/'+resolvedUserId+'/taps/'+sid, {method:'PATCH', body:{lead:data}}).catch(function(){});
            leadSubmitted = true;
        }
    }

    // Timed lead capture modal — show after 30 seconds if no lead submitted
    if (!leadSubmitted) {
        setTimeout(function(){
            if (leadSubmitted) return;
            showLeadModal(id, name);
        }, 30000);
    }
}

// ── Lead capture modal ──
function showLeadModal(cardId, cardName) {
    if (document.getElementById('leadModalOverlay')) return;
    var firstName = (cardName || 'them').split(' ')[0];
    var overlay = document.createElement('div');
    overlay.id = 'leadModalOverlay';
    overlay.className = 'lead-modal-overlay';
    overlay.innerHTML =
        '<div class="lead-modal"><div class="lead-modal-header">'+
        '<button class="lead-modal-close" onclick="closeLeadModal()"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>'+
        '<h3>Stay connected with '+escapeHtml(firstName)+'</h3>'+
        '<p>Share your details so '+escapeHtml(firstName)+' can reach you too</p>'+
        '</div>'+
        '<div class="clf-field"><input type="text" id="lmName" placeholder="Your name" autocomplete="name"></div>'+
        '<div class="clf-field"><input type="tel" id="lmPhone" placeholder="Phone number" autocomplete="tel"></div>'+
        '<div class="clf-field"><input type="email" id="lmEmail" placeholder="Email" autocomplete="email"></div>'+
        '<button class="clf-submit" id="lmSubmitBtn" onclick="submitLeadModal(\''+esc(cardId)+'\')">Share my details</button>'+
        '</div>';
    document.body.appendChild(overlay);
    // Tap outside to close
    overlay.addEventListener('click', function(e){ if (e.target === overlay) closeLeadModal(); });
    requestAnimationFrame(function(){ overlay.classList.add('show'); });
}

function closeLeadModal() {
    var overlay = document.getElementById('leadModalOverlay');
    if (!overlay) return;
    overlay.classList.remove('show');
    setTimeout(function(){ if (overlay.parentNode) overlay.remove(); }, 350);
}

function submitLeadModal(cardId) {
    var name = (document.getElementById('lmName').value || '').trim();
    var phone = (document.getElementById('lmPhone').value || '').trim();
    var email = (document.getElementById('lmEmail').value || '').trim();
    if (!name && !phone && !email) return;
    var data = {name:name, phone:phone, email:email, source:visitSource, ts:Date.now(), device:device, browser:browser, visitorId:visitorId};
    var btn = document.getElementById('lmSubmitBtn');
    btn.textContent = 'Sharing...';
    btn.disabled = true;
    if (resolvedUserId) {
        publicFetch('/user/'+resolvedUserId+'/leads/'+sid, {method:'PUT', body:data})
            .then(function(r){
                if (r.status === 403) { btn.textContent = 'Limit reached'; btn.disabled = false; throw new Error('blocked'); }
                if (!r.ok) throw new Error('fail');
                leadSubmitted = true;
                btn.textContent = 'Shared!';
                btn.classList.add('sent');
                publicFetch('/user/'+resolvedUserId+'/taps/'+sid, {method:'PATCH', body:{lead:data}}).catch(function(){});
                setTimeout(closeLeadModal, 1200);
            })
            .catch(function(err){
                if (err.message === 'blocked') return;
                btn.textContent = 'Failed. Try again.';
                btn.disabled = false;
            });
    }
}

function trackClick(cardId, action) {
    if (navigator.vibrate) navigator.vibrate(30);
    trackEvent(cardId, 'clicks', action);
}

function enquireProduct(cardId, productName) {
    var c = CARDS[cardId];
    if (!c) return;
    var whatsapp = c.whatsapp || (c.phone || '').replace(/[^0-9]/g,'');
    if (!whatsapp) return;
    if (navigator.vibrate) navigator.vibrate(30);
    trackEvent(cardId, 'clicks', 'product_enquiry');
    var msg = encodeURIComponent("Hi, I'm interested in: " + productName);
    window.open('https://wa.me/' + whatsapp + '?text=' + msg, '_blank');
}

function shareCard(cardId) {
    var c = CARDS[cardId];
    if (!c) return;
    var name = c.name || 'Business Card';
    trackEvent(cardId, 'clicks', 'share');
    var shareUrl = resolvedUsername ? (window.location.origin + '/' + resolvedUsername + '/' + cardId) : (window.location.origin + '/?c=' + (c.token || ''));
    var shareText = 'Check out ' + name + "'s digital business card:";

    // Try native share first (mobile)
    if (navigator.share) {
        navigator.share({
            title: name + ' - Digital Card',
            text: shareText,
            url: shareUrl
        }).then(function(){ showCtaBanner(); }).catch(function(){});
    } else {
        // Fallback to WhatsApp
        var waUrl = 'https://wa.me/?text=' + encodeURIComponent(shareText + ' ' + shareUrl);
        window.open(waUrl, '_blank');
        showCtaBanner();
    }
}

function exchangeCard(recipientCardId) {
    var btn = document.getElementById('exchangeBtn');
    if (!btn || btn.disabled) return;
    btn.disabled = true;
    btn.textContent = 'Exchanging...';
    var cfToken = null;
    try { cfToken = localStorage.getItem('token'); } catch(e) {}
    if (!cfToken || !resolvedUserId) { btn.disabled = false; btn.innerHTML = '<svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M21 9l-4-4v3h-7v2h7v3M7 11l-4 4l4 4v-3h7v-2H7v-3z"/></svg> Exchange my card'; return; }

    // Fetch user's own cards to find one to exchange
    fetch('/api/cards', {headers:{'Authorization':'Bearer '+cfToken}})
        .then(function(r) { return r.json(); })
        .then(function(cards) {
            var cardIds = Object.keys(cards);
            if (cardIds.length === 0) {
                btn.textContent = 'No cards to exchange';
                setTimeout(function(){ btn.disabled = false; btn.innerHTML = '<svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M21 9l-4-4v3h-7v2h7v3M7 11l-4 4l4 4v-3h7v-2H7v-3z"/></svg> Exchange my card'; }, 2000);
                return;
            }
            // Auto-select first/only card
            var myCardId = cardIds[0];

            return publicFetch('/exchange', {method:'POST', body:{
                token: cfToken,
                senderCardId: myCardId,
                recipientUserId: resolvedUserId,
                recipientCardId: recipientCardId,
                visitorId: visitorId
            }}).then(function(r) { return r.json(); });
        })
        .then(function(result) {
            if (result && (result.success || result.message)) {
                btn.textContent = 'Card exchanged!';
                btn.classList.add('exchanged');
            } else {
                btn.textContent = (result && result.error) || 'Exchange failed';
                setTimeout(function(){ btn.disabled = false; btn.innerHTML = '<svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M21 9l-4-4v3h-7v2h7v3M7 11l-4 4l4 4v-3h7v-2H7v-3z"/></svg> Exchange my card'; }, 2000);
            }
        })
        .catch(function() {
            btn.textContent = 'Exchange failed';
            setTimeout(function(){ btn.disabled = false; btn.innerHTML = '<svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M21 9l-4-4v3h-7v2h7v3M7 11l-4 4l4 4v-3h7v-2H7v-3z"/></svg> Exchange my card'; }, 2000);
        });
}

function toggleBio() {
    var t = document.getElementById('aboutText');
    var btn = t.nextElementSibling;
    if (t.classList.contains('collapsed')) {
        t.classList.remove('collapsed');
        btn.textContent = 'View less';
    } else {
        t.classList.add('collapsed');
        btn.textContent = 'View more';
    }
}

function vcardEscape(s) {
    if (!s) return '';
    return String(s).replace(/\\/g,'\\\\').replace(/;/g,'\\;').replace(/,/g,'\\,').replace(/\n/g,'\\n');
}
function saveContact(id) {
    var c = CARDS[id];
    if (!c) return;
    var name = c.name || 'Contact';
    var p = name.split(' ');
    var last = p.length > 1 ? vcardEscape(p.pop()) : '';
    var first = vcardEscape(p.join(' '));
    var lines = ['BEGIN:VCARD','VERSION:3.0','N:'+last+';'+first+';;;','FN:'+vcardEscape(name)];
    if (c.company) lines.push('ORG:'+vcardEscape(c.company));
    if (c.title) lines.push('TITLE:'+vcardEscape(c.title));
    if (c.phone) lines.push('TEL;TYPE=CELL:'+c.phone.replace(/[^0-9+\-() ]/g,''));
    if (c.email) lines.push('EMAIL;TYPE=INTERNET:'+c.email);
    if (c.vcardAdr) lines.push('ADR;TYPE=WORK:'+c.vcardAdr);
    if (c.website) lines.push('URL:'+c.website);
    lines.push('END:VCARD');
    var b = new Blob([lines.join('\r\n')],{type:'text/vcard;charset=utf-8'});
    var u = URL.createObjectURL(b);
    var a = document.createElement('a');
    a.href = u; a.download = name.replace(/\s/g,'_')+'.vcf';
    document.body.appendChild(a); a.click();
    setTimeout(function(){ document.body.removeChild(a); URL.revokeObjectURL(u); },100);
    showCtaBanner();
}

function showCtaBanner() {
    try { if (localStorage.getItem('token')) return; } catch(e) {}
    if (document.getElementById('cfCtaBanner')) return;
    var ref = encodeURIComponent(resolvedUsername || 'cta');
    var banner = document.createElement('div');
    banner.id = 'cfCtaBanner';
    banner.className = 'cf-cta-banner';
    banner.innerHTML = '<div class="cta-inner"><span>Want your own digital card?</span><a href="/signup?ref='+ref+'" class="cta-create-btn">Create free card</a><button onclick="this.parentNode.parentNode.remove()" class="cta-dismiss">Maybe later</button></div>';
    document.body.appendChild(banner);
    setTimeout(function(){ banner.classList.add('show'); }, 50);
    setTimeout(function(){ if (banner.parentNode) banner.remove(); }, 15000);
}

// ── SSE cleanup on page unload ──
window.addEventListener('beforeunload', function() {
    if (typeof nfcES !== 'undefined' && nfcES) { nfcES.close(); nfcES = null; }
});
</script>
<!-- Cookie Consent Banner -->
<div id="cookieBanner" style="display:none;position:fixed;top:0;left:0;right:0;background:var(--bg-elevated);border-bottom:1px solid var(--glass-hover);padding:14px 20px;z-index:9999;font-family:Inter,-apple-system,sans-serif;border-radius:0 0 12px 12px">
<div style="max-width:480px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
<p style="margin:0;font-size:12px;color:var(--text-secondary);flex:1;min-width:180px">We use cookies to improve your experience. <a href="/cookies" style="color:var(--accent);text-decoration:underline">Read our cookie policy</a>.</p>
<div style="display:flex;gap:8px;flex-shrink:0">
<button onclick="acceptCookies()" style="background:var(--accent);color:#fff;border:none;padding:6px 16px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer">Accept</button>
<button onclick="declineCookies()" style="background:transparent;color:var(--text-secondary);border:1px solid var(--glass-hover);padding:6px 12px;border-radius:8px;font-size:12px;cursor:pointer">Decline</button>
</div></div></div>
<script>
function acceptCookies(){localStorage.setItem('cookie_consent','accepted');document.getElementById('cookieBanner').style.display='none'}
function declineCookies(){localStorage.setItem('cookie_consent','declined');document.getElementById('cookieBanner').style.display='none'}
if(!localStorage.getItem('cookie_consent'))document.getElementById('cookieBanner').style.display='';
</script>
</body>
</html>
