<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CardFlow Admin</title>
    <script>
    // Force clear old service worker caches on first load after migration
    if (!localStorage.getItem('v68_cleared')) {
        if ('caches' in window) caches.keys().then(function(k){k.forEach(function(n){caches.delete(n)})});
        if (navigator.serviceWorker) navigator.serviceWorker.getRegistrations().then(function(r){r.forEach(function(sw){sw.unregister()})});
        localStorage.setItem('v68_cleared', '1');
        window.location.reload(true);
    }
    // JWT Auth - replaces Firebase Auth
    var authToken = localStorage.getItem('token');
    var currentUser = null;
    var currentUserProfile = null;

    // Auth helper: fetch with JWT token
    function apiFetch(path, options) {
        options = options || {};
        options.headers = options.headers || {};
        if (authToken) options.headers['Authorization'] = 'Bearer ' + authToken;
        if (options.body && typeof options.body === 'object') {
            options.headers['Content-Type'] = 'application/json';
            options.body = JSON.stringify(options.body);
        }
        return fetch('/api' + path, options).then(function(r) {
            if (r.status === 401) { localStorage.removeItem('token'); localStorage.removeItem('user'); location.href = '/login.html'; }
            return r;
        });
    }

    // Redirect to login if not authenticated
    if (!authToken) {
        window.location.href = 'login.html';
    } else {
        fetch('/api/auth/me', {
            headers: { 'Authorization': 'Bearer ' + authToken, 'Cache-Control': 'no-cache' }
        }).then(function(r) {
            if (r.status === 401 || r.status === 403) {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = 'login.html';
                throw new Error('unauthorized');
            }
            return r.json();
        }).then(function(profile) {
            if (!profile || profile.error) {
                localStorage.removeItem('token');
                window.location.href = 'login.html';
                return;
            }
            if (!profile.username) {
                window.location.href = 'signup.html?setup=1';
                return;
            }
            currentUser = { uid: profile.id, email: profile.email };
            currentUserProfile = profile;
            initApp();
        }).catch(function(err) {
            if (err.message === 'unauthorized') return;
            console.error('Failed to load profile:', err);
        });
    }

    function initApp() {
        var ac = document.getElementById('appContainer');
        ac.style.display = '';
        requestAnimationFrame(function(){ ac.classList.add('visible'); });
        var ls = document.getElementById('loadingScreen');
        if (ls) { ls.classList.add('fade-out'); setTimeout(function(){ ls.remove(); }, 300); }
        initCardElements();
        loadStats();
        loadCardsFromFirebase();
        loadDefaultCard();
        startListeningForTaps();
        checkReviewQueue();
        setInterval(checkReviewQueue, 30000);
        updateNotifUI();
        // Re-register push subscription on init if notifications already granted
        if ('Notification' in window && Notification.permission === 'granted') {
            subscribeToPush();
        }
        updateStatusBadges();
        updateInstallButton();
        setTimeout(generateQR, 100);
        updateQsBadge();
        setTimeout(function() {
            if (!isInStandaloneMode() && !localStorage.getItem('installModalDismissed')) {
                showInstallModal();
            }
        }, 3000);
        // Show user name in UI
        var userNameEl = document.getElementById('userName');
        if (userNameEl && currentUserProfile) {
            userNameEl.textContent = currentUserProfile.name || currentUser.email;
        }
        // Update plan label
        var planLabel = document.getElementById('currentPlanLabel');
        if (planLabel && currentUserProfile) {
            var plan = currentUserProfile.plan || 'free';
            planLabel.textContent = plan.charAt(0).toUpperCase() + plan.slice(1) + ' plan';
        }
        // Populate sidebar user info
        var sidebarName = document.getElementById('sidebarUserName');
        if (sidebarName && currentUserProfile) {
            sidebarName.textContent = currentUserProfile.username || currentUserProfile.name || currentUser.email;
        }
        var sidebarBadge = document.getElementById('sidebarPlanBadge');
        if (sidebarBadge && currentUserProfile) {
            var sPlan = currentUserProfile.plan || 'free';
            sidebarBadge.textContent = sPlan.charAt(0).toUpperCase() + sPlan.slice(1);
        }
        // Navigate to dashboard
        navigateTo('dashboard');
    }

    function logout() {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.href = 'login.html';
    }
    </script>
    <!-- iOS PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Cards">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1a1a2e">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="apple-touch-startup-image" href="apple-touch-icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        :root{
            --bg-base:#0c0c18;
            --bg-card:#14142a;
            --bg-elevated:#1c1c3a;
            --bg-hover:#242450;
            --accent:#6366f1;
            --accent-light:#818cf8;
            --accent-glow:rgba(99,102,241,.3);
            --success:#10b981;
            --warning:#f59e0b;
            --danger:#ef4444;
            --text-primary:#f8fafc;
            --text-secondary:#cbd5e1;
            --text-muted:#64748b;
            --border:#1e293b;
        }
        *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
        html{height:100%}
        body{
            font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
            background:var(--bg-base);
            color:var(--text-primary);
            height:100%;
            -webkit-font-smoothing:antialiased;
            -webkit-text-size-adjust:100%;
            -webkit-tap-highlight-color:transparent;
            line-height:1.5;
        }
        button,a,input,select{-webkit-tap-highlight-color:transparent;touch-action:manipulation}

        /* ── Pull to Refresh ── */
        .ptr-indicator{
            position:fixed;
            top:0;left:50%;
            transform:translateX(-50%) translateY(-50px);
            width:40px;height:40px;
            border-radius:50%;
            background:var(--bg-elevated);
            display:flex;
            align-items:center;
            justify-content:center;
            box-shadow:0 4px 20px rgba(0,0,0,.4);
            z-index:9999;
            transition:transform .2s ease;
            border:1px solid var(--border);
            opacity:0;
            pointer-events:none;
        }
        .ptr-indicator.show{opacity:1}
        .ptr-indicator.pulling{transform:translateX(-50%) translateY(24px)}
        .ptr-indicator.refreshing{transform:translateX(-50%) translateY(24px)}
        .ptr-indicator svg{width:22px;height:22px;fill:var(--accent);transition:transform .3s}
        .ptr-indicator.pulling svg{transform:rotate(180deg)}
        .ptr-indicator.refreshing svg{animation:ptr-spin .6s linear infinite}
        @keyframes ptr-spin{to{transform:rotate(360deg)}}

        /* ── Screens ── */
        .screen{
            position:fixed;
            inset:0;
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
            padding:24px;
            padding-top:calc(24px + env(safe-area-inset-top));
            padding-bottom:calc(24px + env(safe-area-inset-bottom));
            transition:opacity .25s ease-out,transform .25s ease-out;
        }
        .screen.hidden{opacity:0;pointer-events:none;transform:scale(.97)}

        /* ── Idle Screen ── */
        #idle .pulse-ring{
            width:88px;
            height:88px;
            border-radius:50%;
            border:2px solid rgba(255,255,255,.1);
            display:flex;
            align-items:center;
            justify-content:center;
            position:relative;
            margin-bottom:20px;
        }
        #idle .pulse-ring::before{
            content:'';
            position:absolute;
            inset:0;
            border-radius:50%;
            border:2px solid rgba(255,255,255,.08);
            animation:pulse 2s ease-out infinite;
        }
        @keyframes pulse{0%{transform:scale(1);opacity:.5}100%{transform:scale(1.6);opacity:0}}
        #idle .nfc-icon svg{width:36px;height:36px;fill:rgba(255,255,255,.4)}
        /* ── Status Header ── */
        .status-header{
            display:flex;
            align-items:center;
            gap:16px;
            width:100%;
            max-width:360px;
            padding:16px;
            background:rgba(255,255,255,.03);
            border-radius:16px;
            margin-bottom:20px;
        }
        .status-icon{
            width:48px;
            height:48px;
            border-radius:12px;
            background:rgba(255,255,255,.08);
            display:flex;
            align-items:center;
            justify-content:center;
            position:relative;
            cursor:pointer;
            flex-shrink:0;
        }
        .status-icon:active{transform:scale(.95)}
        .status-icon svg{width:24px;height:24px;fill:rgba(255,255,255,.5)}
        .status-icon.notif-on{background:rgba(34,197,94,.15)}
        .status-icon.notif-on svg{fill:#4ade80}
        .status-dot{
            position:absolute;
            top:4px;right:4px;
            width:10px;height:10px;
            border-radius:50%;
            background:#ef4444;
            border:2px solid #1a1a2e;
            display:none;
        }
        .status-dot.on{background:#4ade80;display:block}
        .status-dot.off{background:#ef4444;display:block}
        .status-text{flex:1;min-width:0}
        .status-text h2{font-size:16px;font-weight:600;color:rgba(255,255,255,.9);margin:0}
        .status-text p{font-size:12px;color:rgba(255,255,255,.4);margin:0;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .status-stat{
            text-align:center;
            padding:8px 12px;
            background:rgba(255,255,255,.05);
            border-radius:10px;
            cursor:pointer;
            flex-shrink:0;
        }
        .status-stat:active{transform:scale(.95)}
        .stat-num{display:block;font-size:20px;font-weight:700;color:#fff}
        .stat-label{font-size:10px;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:.5px}

        /* ── QR Card ── */
        .qr-card{
            background:rgba(255,255,255,.03);
            border-radius:20px;
            padding:16px;
            width:100%;
            max-width:280px;
            margin-bottom:24px;
        }
        .qr-card-header{
            display:flex;
            align-items:center;
            gap:8px;
            margin-bottom:12px;
        }
        .qr-card-header select{
            flex:1;
            background:rgba(255,255,255,.08) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='rgba(255,255,255,0.6)'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E") no-repeat right 10px center;
            color:#fff;
            border:none;
            border-radius:8px;
            padding:10px 32px 10px 12px;
            font-family:inherit;
            font-size:13px;
            font-weight:500;
            outline:none;
            -webkit-appearance:none;
            appearance:none;
            cursor:pointer;
        }
        .qr-card-header select option{background:#252538;color:#fff}
        .qr-share-btn{
            width:40px;height:40px;
            border-radius:10px;
            border:none;
            background:rgba(255,255,255,.08);
            cursor:pointer;
            display:flex;
            align-items:center;
            justify-content:center;
        }
        .qr-share-btn:active{transform:scale(.95)}
        .qr-share-btn svg{width:18px;height:18px;fill:rgba(255,255,255,.6)}
        .qr-canvas-wrap{
            background:#fff;
            border-radius:14px;
            padding:12px;
            display:block;
            cursor:pointer;
            margin:0 auto;
            width:fit-content;
        }
        .qr-canvas-wrap:active{transform:scale(.97)}
        .qr-canvas-wrap canvas{display:block}
        .qr-copy-btn{
            width:100%;
            margin-top:12px;
            padding:12px;
            border:none;
            border-radius:10px;
            background:rgba(255,255,255,.08);
            color:rgba(255,255,255,.7);
            font-family:inherit;
            font-size:13px;
            font-weight:500;
            cursor:pointer;
            display:flex;
            align-items:center;
            justify-content:center;
            gap:8px;
        }
        .qr-copy-btn:active{transform:scale(.98)}
        .qr-copy-btn svg{width:16px;height:16px;fill:currentColor}
        .qr-copy-btn.copied{background:rgba(34,197,94,.15);color:#4ade80}
        .qr-btn-row{display:flex;gap:8px;margin-top:12px}
        .qr-btn-row .qr-copy-btn{flex:1}

        /* ── Action Grid ── */
        .action-grid{
            display:grid;
            grid-template-columns:repeat(3,1fr);
            gap:10px;
            width:100%;
            max-width:320px;
        }
        .action-btn{
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
            gap:6px;
            padding:16px 8px;
            border-radius:14px;
            border:none;
            background:rgba(255,255,255,.05);
            color:rgba(255,255,255,.7);
            font-family:inherit;
            font-size:11px;
            font-weight:500;
            cursor:pointer;
            position:relative;
        }
        .action-btn:active{transform:scale(.95);background:rgba(255,255,255,.08)}
        .action-btn svg{width:22px;height:22px;fill:currentColor;opacity:.7}
        .action-btn span{opacity:.8}
        .action-btn.active{background:rgba(249,115,22,.15);color:#fdba74}
        .action-btn.active svg{fill:#fdba74;opacity:1}
        .action-badge{
            position:absolute;
            top:6px;right:6px;
            min-width:18px;height:18px;
            border-radius:9px;
            background:#f97316;
            color:#fff;
            font-size:10px;
            font-weight:700;
            display:none;
            align-items:center;
            justify-content:center;
            padding:0 5px;
        }
        .action-badge.show{display:flex}

        /* ── Version Tag ── */
        .version-tag{
            position:fixed;
            bottom:8px;
            right:12px;
            font-size:10px;
            color:rgba(255,255,255,.15);
            cursor:pointer;
            padding:4px 8px;
        }
        .version-tag:active{color:rgba(255,255,255,.4)}

        /* ── Settings Modal ── */
        .settings-modal{
            position:fixed;
            inset:0;
            background:rgba(0,0,0,.85);
            display:none;
            align-items:flex-end;
            justify-content:center;
            z-index:200;
            padding:0;
        }
        .settings-modal.show{display:flex}
        .settings-sheet{
            background:#252538;
            border-radius:20px 20px 0 0;
            padding:24px;
            padding-bottom:calc(24px + env(safe-area-inset-bottom));
            width:100%;
            max-width:500px;
            max-height:80vh;
            overflow-y:auto;
        }
        .settings-title{font-size:18px;font-weight:600;margin-bottom:20px;text-align:center}
        .settings-item{
            display:flex;
            align-items:center;
            gap:14px;
            padding:14px;
            background:rgba(255,255,255,.05);
            border-radius:12px;
            margin-bottom:10px;
            cursor:pointer;
        }
        .settings-item:active{background:rgba(255,255,255,.08)}
        .settings-item svg{width:22px;height:22px;fill:rgba(255,255,255,.5);flex-shrink:0}
        .settings-item-text{flex:1}
        .settings-item-text strong{display:block;font-size:14px;font-weight:500}
        .settings-item-text small{font-size:12px;color:rgba(255,255,255,.4)}
        .settings-close{
            width:100%;
            padding:14px;
            border:none;
            border-radius:12px;
            background:rgba(255,255,255,.1);
            color:#fff;
            font-family:inherit;
            font-size:14px;
            font-weight:500;
            cursor:pointer;
            margin-top:10px;
        }

        /* ── Legacy support ── */
        .idle-btn{
            font-size:13px;
            padding:10px 18px;
            border-radius:10px;
            cursor:pointer;
            border:none;
            font-family:inherit;
            font-weight:500;
        }
        .idle-btn:active{transform:scale(.95)}
        .notif-on{background:rgba(34,197,94,.15);color:#4ade80}
        .notif-off{background:rgba(255,255,255,.08);color:rgba(255,255,255,.5)}
        .notif-test{background:rgba(34,197,94,.1);color:#4ade80;padding:10px 12px}
        .leads-btn{background:rgba(255,255,255,.08);color:rgba(255,255,255,.6)}
        .qs-btn{background:rgba(249,115,22,.15);color:#fb923c}
        .qs-active{background:rgba(249,115,22,.25);color:#fdba74}
        .analytics-btn{background:rgba(251,191,36,.12);color:#fbbf24}
        .storage-btn{background:rgba(20,184,166,.12);color:#2dd4bf}
        .review-btn{background:rgba(249,115,22,.12);color:#fb923c}
        .review-btn.has-items{background:rgba(249,115,22,.25);color:#fdba74;position:relative}
        .review-badge{position:absolute;top:-4px;right:-4px;background:#f97316;color:#fff;font-size:10px;font-weight:700;min-width:18px;height:18px;border-radius:9px;display:flex;align-items:center;justify-content:center;padding:0 5px}
        .default-btn{background:rgba(236,72,153,.12);color:#f472b6}
        .default-active{background:rgba(236,72,153,.2);color:#f9a8d4}
        .install-btn{background:linear-gradient(135deg,#f97316,#8b5cf6);color:#fff;display:flex;align-items:center;gap:6px}
        .install-btn svg{width:16px;height:16px;fill:currentColor}
        .install-btn.installed{background:rgba(34,197,94,.15);color:#4ade80}

        /* ── Install Modal ── */
        .install-modal{
            position:fixed;
            inset:0;
            background:rgba(0,0,0,.85);
            display:none;
            align-items:center;
            justify-content:center;
            z-index:250;
            padding:24px;
            backdrop-filter:blur(8px);
            -webkit-backdrop-filter:blur(8px);
        }
        .install-modal.show{display:flex}
        .install-modal-content{
            background:linear-gradient(180deg,#252538,#1a1a2e);
            border-radius:24px;
            padding:32px 24px;
            max-width:340px;
            width:100%;
            text-align:center;
            border:1px solid rgba(255,255,255,.1);
        }
        .install-icon{
            width:80px;
            height:80px;
            border-radius:20px;
            background:linear-gradient(135deg,#f97316,#8b5cf6);
            display:flex;
            align-items:center;
            justify-content:center;
            margin:0 auto 20px;
            box-shadow:0 8px 32px rgba(249,115,22,.3);
        }
        .install-icon svg{width:40px;height:40px;fill:#fff}
        .install-modal h3{font-size:22px;font-weight:700;margin-bottom:8px}
        .install-modal p{font-size:14px;color:rgba(255,255,255,.6);margin-bottom:24px;line-height:1.6}
        .install-steps{text-align:left;margin-bottom:24px}
        .install-step{
            display:flex;
            align-items:center;
            gap:14px;
            padding:14px 0;
            border-bottom:1px solid rgba(255,255,255,.06);
        }
        .install-step:last-child{border-bottom:none}
        .install-step-num{
            width:28px;
            height:28px;
            border-radius:50%;
            background:rgba(249,115,22,.2);
            color:#fdba74;
            font-size:13px;
            font-weight:700;
            display:flex;
            align-items:center;
            justify-content:center;
            flex-shrink:0;
        }
        .install-step-text{font-size:14px;color:rgba(255,255,255,.8)}
        .install-step-text svg{width:18px;height:18px;fill:#60a5fa;vertical-align:middle;margin:0 2px}
        .install-primary-btn{
            width:100%;
            padding:16px;
            border:none;
            border-radius:14px;
            background:linear-gradient(135deg,#f97316,#8b5cf6);
            color:#fff;
            font-family:inherit;
            font-size:16px;
            font-weight:600;
            cursor:pointer;
            margin-bottom:12px;
        }
        .install-primary-btn:active{transform:scale(.98);opacity:.9}
        .install-secondary-btn{
            width:100%;
            padding:14px;
            border:none;
            border-radius:12px;
            background:rgba(255,255,255,.08);
            color:rgba(255,255,255,.6);
            font-family:inherit;
            font-size:14px;
            font-weight:500;
            cursor:pointer;
        }
        .install-secondary-btn:active{opacity:.7}
        .install-features{
            display:flex;
            justify-content:center;
            gap:20px;
            margin-bottom:24px;
        }
        .install-feature{text-align:center}
        .install-feature svg{width:24px;height:24px;fill:#4ade80;margin-bottom:6px}
        .install-feature span{display:block;font-size:11px;color:rgba(255,255,255,.5)}

        .default-badge{
            margin-top:8px;
            font-size:12px;
            padding:6px 14px;
            border-radius:8px;
            background:rgba(236,72,153,.15);
            color:#f472b6;
            display:none;
        }
        .default-badge.show{display:inline-block}

        /* ── Fullscreen QR ── */
        .qr-fullscreen{
            position:fixed;
            inset:0;
            background:rgba(0,0,0,.9);
            display:none;
            align-items:center;
            justify-content:center;
            z-index:200;
            flex-direction:column;
            gap:24px;
        }
        .qr-fullscreen.show{display:flex}
        .qr-fullscreen .qr-full-wrap{background:#fff;border-radius:20px;padding:24px}
        .qr-fullscreen .qr-full-wrap canvas{display:block}
        .qr-fullscreen .qr-card-name{color:#fff;font-size:18px;font-weight:600}
        .qr-fullscreen .qr-close{
            background:rgba(255,255,255,.1);
            border:none;
            color:#fff;
            font-size:15px;
            padding:12px 28px;
            border-radius:12px;
            cursor:pointer;
            font-family:inherit;
            font-weight:500;
        }
        .qr-fullscreen .qr-close:active{opacity:.7}

        /* ── Picker Screen ── */
        #picker{background:linear-gradient(180deg,#1a1a2e,#252538)}
        .pick-alert{
            font-size:11px;
            color:#4ade80;
            text-transform:uppercase;
            letter-spacing:3px;
            margin-bottom:8px;
            animation:pickAlertPulse 1.5s ease-in-out infinite;
        }
        @keyframes pickAlertPulse{0%,100%{opacity:1}50%{opacity:.5}}
        .pick-title{font-size:24px;font-weight:700;margin-bottom:6px}
        .pick-visitor{font-size:13px;color:rgba(255,255,255,.4);margin-bottom:28px}
        .pick-cards{display:flex;flex-direction:column;gap:12px;width:100%;max-width:360px}
        .pick-btn{
            width:100%;
            padding:18px 20px;
            border-radius:16px;
            border:none;
            color:#fff;
            font-family:inherit;
            font-size:16px;
            font-weight:600;
            cursor:pointer;
            text-align:left;
            position:relative;
            opacity:0;
            transform:translateY(20px);
            box-shadow:0 4px 20px rgba(0,0,0,.3);
            transition:transform .15s ease,box-shadow .15s ease;
        }
        .pick-btn.animate-in{animation:pickBtnIn .4s cubic-bezier(.34,1.56,.64,1) forwards}
        @keyframes pickBtnIn{to{opacity:1;transform:translateY(0)}}
        .pick-btn:active{transform:scale(.97);box-shadow:0 2px 10px rgba(0,0,0,.2)}
        .pick-btn small{display:block;font-weight:400;font-size:12px;opacity:.7;margin-top:2px}
        .pick-btn::after{content:'\2192';position:absolute;right:18px;top:50%;transform:translateY(-50%);font-size:18px;opacity:.6;transition:transform .2s ease}
        .pick-btn:hover::after{transform:translateY(-50%) translateX(4px)}
        .skip-btn{
            margin-top:24px;
            padding:14px 28px;
            border:none;
            border-radius:12px;
            background:rgba(255,255,255,.06);
            color:rgba(255,255,255,.4);
            font-family:inherit;
            font-size:14px;
            cursor:pointer;
            opacity:0;
            animation:skipBtnIn .3s ease .6s forwards;
        }
        @keyframes skipBtnIn{to{opacity:1}}
        .skip-btn:active{opacity:.7;transform:scale(.97)}

        /* ── Sent Screen ── */
        #sent{transition:opacity .3s ease,transform .3s ease}
        #sent .check{
            width:80px;
            height:80px;
            border-radius:50%;
            background:rgba(34,197,94,.15);
            display:flex;
            align-items:center;
            justify-content:center;
            margin-bottom:20px;
            position:relative;
            animation:checkPop .5s cubic-bezier(.34,1.56,.64,1) forwards;
        }
        @keyframes checkPop{from{transform:scale(0)}to{transform:scale(1)}}
        #sent .check::before{
            content:'';
            position:absolute;
            inset:-4px;
            border-radius:50%;
            border:2px solid rgba(74,222,128,.3);
            animation:checkRing .6s ease-out forwards;
        }
        @keyframes checkRing{from{transform:scale(.8);opacity:0}to{transform:scale(1);opacity:1}}
        #sent .check svg{
            width:40px;height:40px;fill:#4ade80;
            stroke:#4ade80;stroke-width:0;
            animation:checkDraw .4s ease .2s forwards;
            stroke-dasharray:50;stroke-dashoffset:50;
        }
        @keyframes checkDraw{to{stroke-dashoffset:0}}
        #sent h2{font-size:22px;font-weight:600;margin-bottom:4px;animation:fadeUp .4s ease .15s both}
        #sent .sent-sub{font-size:14px;color:rgba(255,255,255,.5);animation:fadeUp .4s ease .2s both}
        .sent-auto{font-size:13px;color:rgba(255,255,255,.4);margin-top:6px;animation:fadeUp .4s ease .25s both}
        @keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        .return-progress{
            width:120px;height:3px;
            background:rgba(255,255,255,.1);
            border-radius:3px;
            margin-top:20px;
            overflow:hidden;
            animation:fadeUp .4s ease .3s both;
        }
        .return-progress-bar{
            height:100%;
            background:linear-gradient(90deg,#4ade80,#22c55e);
            border-radius:3px;
            animation:returnProgress 1.5s linear forwards;
        }
        @keyframes returnProgress{from{width:0}to{width:100%}}
        .return-text{font-size:11px;color:rgba(255,255,255,.3);margin-top:8px;animation:fadeUp .4s ease .35s both}
        .lead-card{
            background:rgba(255,255,255,.05);
            border-radius:14px;
            padding:18px;
            text-align:left;
            margin-top:20px;
            max-width:340px;
            width:100%;
        }
        .lead-card .lc-label{font-size:11px;text-transform:uppercase;letter-spacing:1px;color:rgba(255,255,255,.4);margin-bottom:8px}
        .lead-card .lc-name{font-size:17px;font-weight:600}
        .lead-card .lc-company{font-size:14px;color:rgba(255,255,255,.5);margin-top:2px}
        .lead-card .lc-contact{margin-top:10px;font-size:14px}
        .lead-card a{color:#4ade80;text-decoration:none}
        .lead-card a:active{opacity:.7}
        .lead-card img{width:100%;border-radius:10px;margin-top:12px;max-height:200px;object-fit:contain}

        /* ── Card Preview Modal ── */
        .preview-modal{
            position:fixed;
            inset:0;
            background:rgba(0,0,0,.85);
            backdrop-filter:blur(10px);
            -webkit-backdrop-filter:blur(10px);
            z-index:2000;
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
            padding:20px;
            opacity:0;
            pointer-events:none;
            transition:opacity .3s ease;
        }
        .preview-modal.show{opacity:1;pointer-events:auto}
        .preview-modal.show .preview-phone{animation:previewSlideUp .4s cubic-bezier(.34,1.56,.64,1) forwards}
        .preview-phone{
            width:100%;
            max-width:340px;
            height:70vh;
            max-height:680px;
            background:#000;
            border-radius:40px;
            padding:12px;
            box-shadow:0 25px 80px rgba(0,0,0,.5),inset 0 0 0 3px #333;
            position:relative;
            transform:translateY(40px);
            opacity:0;
        }
        @keyframes previewSlideUp{to{transform:translateY(0);opacity:1}}
        .preview-phone::before{
            content:'';
            position:absolute;
            top:8px;left:50%;
            transform:translateX(-50%);
            width:80px;height:24px;
            background:#1a1a1a;
            border-radius:14px;
            z-index:10;
        }
        .preview-iframe{
            width:100%;
            height:100%;
            border:none;
            border-radius:30px;
            background:#fff;
        }
        .preview-close{
            position:absolute;
            top:-60px;right:0;
            width:48px;height:48px;
            border-radius:50%;
            background:rgba(255,255,255,.1);
            border:none;
            cursor:pointer;
            display:flex;
            align-items:center;
            justify-content:center;
        }
        .preview-close:active{transform:scale(.9)}
        .preview-close svg{width:24px;height:24px;fill:#fff}
        .preview-actions{
            display:flex;
            gap:12px;
            margin-top:20px;
            opacity:0;
            animation:fadeUp .3s ease .3s forwards;
        }
        .preview-action-btn{
            padding:12px 24px;
            border-radius:12px;
            border:none;
            font-family:inherit;
            font-size:14px;
            font-weight:500;
            cursor:pointer;
            display:flex;
            align-items:center;
            gap:8px;
        }
        .preview-action-btn.primary{background:#4ade80;color:#000}
        .preview-action-btn.secondary{background:rgba(255,255,255,.1);color:#fff}
        .preview-action-btn:active{transform:scale(.95)}
        .preview-action-btn svg{width:18px;height:18px;fill:currentColor}

        /* ── Leads Dashboard ── */
        #leads{
            display:none;
        }
        .leads-header{
            position:sticky;
            top:0;
            background:rgba(26,26,46,.95);
            backdrop-filter:blur(12px);
            -webkit-backdrop-filter:blur(12px);
            padding:16px 20px;
            padding-top:calc(16px + env(safe-area-inset-top));
            display:flex;
            align-items:center;
            gap:12px;
            border-bottom:1px solid rgba(255,255,255,.06);
            z-index:10;
        }
        .leads-back{
            width:40px;
            height:40px;
            border-radius:50%;
            background:rgba(255,255,255,.08);
            border:none;
            display:flex;
            align-items:center;
            justify-content:center;
            cursor:pointer;
        }
        .leads-back:active{transform:scale(.9);opacity:.8}
        .leads-back svg{width:20px;height:20px;fill:rgba(255,255,255,.6)}

        /* ── Floating Back Button (thumb-friendly) ── */
        .float-back{
            position:fixed;
            bottom:24px;
            left:20px;
            height:48px;
            padding:0 18px 0 14px;
            border-radius:24px;
            background:linear-gradient(135deg,#f97316,#ea580c);
            border:none;
            display:flex;
            align-items:center;
            gap:8px;
            cursor:pointer;
            box-shadow:0 4px 20px rgba(249,115,22,.4),0 2px 8px rgba(0,0,0,.2);
            z-index:50;
            margin-bottom:env(safe-area-inset-bottom);
            animation:floatIn .4s ease;
            transition:transform .2s,box-shadow .2s;
        }
        @keyframes floatIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        .float-back:hover{transform:translateY(-2px);box-shadow:0 6px 24px rgba(249,115,22,.5),0 4px 12px rgba(0,0,0,.2)}
        .float-back:active{transform:scale(.95)}
        .float-back svg{width:20px;height:20px;fill:#fff;flex-shrink:0}
        .float-back span{color:#fff;font-size:14px;font-weight:600;white-space:nowrap}

        /* Swipe hint indicator */
        .swipe-hint{
            position:fixed;
            left:0;top:50%;
            transform:translateY(-50%);
            width:4px;
            height:80px;
            background:linear-gradient(180deg,transparent,rgba(249,115,22,.3),transparent);
            border-radius:0 4px 4px 0;
            pointer-events:none;
            opacity:0;
            transition:opacity .3s;
        }
        .panel-swiping .swipe-hint{opacity:1}

        /* ── Cards Management ── */
        #cardsPanel{
            display:none;
        }
        .card-item{
            display:flex;
            align-items:center;
            gap:14px;
            padding:16px 20px;
            background:rgba(255,255,255,.03);
            margin:8px 12px;
            border-radius:14px;
            border-left:4px solid;
        }
        .card-item-color{
            width:40px;height:40px;
            border-radius:10px;
            flex-shrink:0;
        }
        .card-item-info{flex:1;min-width:0}
        .card-item-name{font-size:15px;font-weight:600}
        .card-item-sub{font-size:12px;color:rgba(255,255,255,.4);margin-top:2px}
        .card-item-actions{display:flex;gap:8px}
        .card-item-btn{
            width:36px;height:36px;
            border-radius:10px;
            border:none;
            background:rgba(255,255,255,.08);
            cursor:pointer;
            display:flex;
            align-items:center;
            justify-content:center;
        }
        .card-item-btn:active{transform:scale(.9)}
        .card-item-btn svg{width:18px;height:18px;fill:rgba(255,255,255,.5)}
        .card-item-btn.delete-btn:active svg{fill:#f87171}
        .add-card-btn{
            display:flex;
            align-items:center;
            justify-content:center;
            gap:8px;
            margin:16px 12px;
            padding:16px;
            border-radius:14px;
            border:2px dashed rgba(255,255,255,.15);
            background:transparent;
            color:rgba(255,255,255,.5);
            font-family:inherit;
            font-size:14px;
            font-weight:500;
            cursor:pointer;
            width:calc(100% - 24px);
        }
        .add-card-btn:active{border-color:rgba(249,115,22,.4);color:#f97316}
        .add-card-btn svg{width:20px;height:20px;fill:currentColor}

        /* Card Edit Modal */
        .card-edit-modal{
            position:fixed;inset:0;
            background:rgba(0,0,0,.85);
            z-index:250;
            display:none;
            align-items:center;
            justify-content:center;
            padding:20px;
        }
        .card-edit-modal.show{display:flex}
        .card-edit-content{
            background:#252538;
            border-radius:20px;
            width:100%;
            max-width:400px;
            max-height:90vh;
            overflow-y:auto;
        }
        .card-edit-header{
            padding:20px;
            border-bottom:1px solid rgba(255,255,255,.06);
            display:flex;
            justify-content:space-between;
            align-items:center;
        }
        .card-edit-header h3{font-size:17px;font-weight:600}
        .card-edit-close{background:none;border:none;color:rgba(255,255,255,.5);font-size:24px;cursor:pointer}
        .card-edit-body{padding:20px}
        .card-edit-field{margin-bottom:16px}
        .card-edit-field label{display:block;font-size:12px;color:rgba(255,255,255,.4);margin-bottom:6px;text-transform:uppercase}
        .card-edit-field input{
            width:100%;
            padding:14px;
            border:1px solid rgba(255,255,255,.1);
            border-radius:12px;
            background:rgba(255,255,255,.05);
            color:#fff;
            font-family:inherit;
            font-size:15px;
        }
        .card-edit-field input:focus{outline:none;border-color:rgba(249,115,22,.5)}
        .color-picker-row{display:flex;gap:10px;flex-wrap:wrap}
        .color-picker-opt{
            width:44px;height:44px;
            border-radius:12px;
            border:3px solid transparent;
            cursor:pointer;
        }
        .color-picker-opt:active{transform:scale(.9)}
        .color-picker-opt.selected{border-color:#fff}
        .card-edit-footer{
            padding:16px 20px;
            border-top:1px solid rgba(255,255,255,.06);
            display:flex;
            gap:10px;
        }
        .card-edit-save{
            flex:1;
            padding:14px;
            border:none;
            border-radius:12px;
            background:#f97316;
            color:#fff;
            font-family:inherit;
            font-size:15px;
            font-weight:600;
            cursor:pointer;
        }
        .card-edit-save:active{opacity:.8}
        .card-edit-cancel{
            padding:14px 20px;
            border:1px solid rgba(255,255,255,.1);
            border-radius:12px;
            background:transparent;
            color:rgba(255,255,255,.6);
            font-family:inherit;
            font-size:15px;
            cursor:pointer;
        }
        .card-edit-full{max-width:520px}
        .card-edit-scrollable{max-height:50vh;overflow-y:auto}
        .card-edit-tabs{display:flex;padding:0 12px;border-bottom:1px solid rgba(255,255,255,.06);overflow-x:auto}
        .card-tab{
            padding:12px 16px;
            border:none;
            background:none;
            color:rgba(255,255,255,.4);
            font-family:inherit;
            font-size:13px;
            font-weight:500;
            cursor:pointer;
            border-bottom:2px solid transparent;
            white-space:nowrap;
        }
        .card-tab.active{color:#f97316;border-bottom-color:#f97316}
        .card-tab-content{display:none}
        .card-tab-content.active{display:block}
        .card-edit-row{display:flex;gap:12px}
        .card-edit-row .card-edit-field{flex:1}
        .card-edit-field textarea{
            width:100%;
            padding:14px;
            border:1px solid rgba(255,255,255,.1);
            border-radius:12px;
            background:rgba(255,255,255,.05);
            color:#fff;
            font-family:inherit;
            font-size:14px;
            resize:vertical;
        }
        .card-edit-field textarea:focus{outline:none;border-color:rgba(249,115,22,.5)}
        .field-hint{display:block;font-size:11px;color:rgba(255,255,255,.3);margin-top:4px}
        .products-editor{padding:8px 0}
        .product-item{
            background:rgba(255,255,255,.03);
            border:1px solid rgba(255,255,255,.08);
            border-radius:12px;
            padding:12px;
            margin-bottom:10px;
        }
        .product-item-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
        .product-item-title{font-size:12px;font-weight:600;color:rgba(255,255,255,.6)}
        .remove-product{
            background:none;border:none;color:#f87171;cursor:pointer;font-size:18px;padding:0 4px;
        }
        .product-item input{
            width:100%;
            padding:10px;
            border:1px solid rgba(255,255,255,.08);
            border-radius:8px;
            background:rgba(255,255,255,.03);
            color:#fff;
            font-family:inherit;
            font-size:13px;
            margin-bottom:6px;
        }
        .product-item input:focus{outline:none;border-color:rgba(249,115,22,.4)}
        .add-product-btn{
            display:flex;
            align-items:center;
            justify-content:center;
            gap:6px;
            width:100%;
            padding:12px;
            border:2px dashed rgba(255,255,255,.1);
            border-radius:12px;
            background:transparent;
            color:rgba(255,255,255,.4);
            font-family:inherit;
            font-size:13px;
            cursor:pointer;
        }
        .add-product-btn:hover{border-color:rgba(249,115,22,.3);color:#f97316}
        .add-product-btn svg{width:18px;height:18px;fill:currentColor}

        .leads-header h2{font-size:18px;font-weight:600}
        .leads-header span{font-size:13px;color:rgba(255,255,255,.4);margin-left:auto}

        .leads-toolbar{
            position:sticky;
            top:73px;
            background:rgba(26,26,46,.95);
            backdrop-filter:blur(12px);
            -webkit-backdrop-filter:blur(12px);
            padding:12px 20px;
            display:flex;
            gap:10px;
            z-index:10;
            border-bottom:1px solid rgba(255,255,255,.04);
        }
        .leads-search{
            flex:1;
            min-width:100px;
            padding:12px 16px;
            border:1px solid rgba(255,255,255,.1);
            border-radius:12px;
            background:rgba(255,255,255,.05);
            color:#fff;
            font-family:inherit;
            font-size:14px;
            outline:none;
        }
        .leads-search::placeholder{color:rgba(255,255,255,.3)}
        .leads-search:focus{border-color:rgba(255,255,255,.2);background:rgba(255,255,255,.08)}
        .csv-btn{
            padding:12px 18px;
            border:none;
            border-radius:12px;
            background:rgba(249,115,22,.15);
            color:#fb923c;
            font-family:inherit;
            font-size:13px;
            font-weight:600;
            cursor:pointer;
        }
        .csv-btn:active{transform:scale(.95)}
        .import-btn{
            display:inline-flex;
            align-items:center;
            gap:6px;
            padding:12px 16px;
            border:none;
            border-radius:12px;
            background:rgba(74,222,128,.15);
            color:#4ade80;
            font-family:inherit;
            font-size:13px;
            font-weight:600;
            cursor:pointer;
        }
        .import-btn svg{width:16px;height:16px;fill:#4ade80}
        .import-btn:active{transform:scale(.95)}

        /* ── Import Review Modal ── */
        .import-modal{position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:200;display:none;flex-direction:column}
        .import-modal.show{display:flex}
        .import-header{padding:16px 20px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;gap:12px}
        .import-header h3{flex:1;font-size:17px;font-weight:600}
        .import-header button{background:none;border:none;color:rgba(255,255,255,.5);font-size:14px;cursor:pointer;padding:8px 12px}
        .import-header .save-all-btn{background:#f97316;color:#fff;border-radius:10px;font-weight:600}
        .import-list{flex:1;overflow-y:auto;padding:12px}
        .import-item{background:rgba(255,255,255,.04);border-radius:14px;padding:16px;margin-bottom:12px}
        .import-item-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
        .import-item-name{font-size:16px;font-weight:600}
        .import-item-remove{background:none;border:none;color:#f87171;font-size:12px;cursor:pointer;padding:4px 8px}
        .import-field{margin-bottom:10px}
        .import-field label{display:block;font-size:10px;color:rgba(255,255,255,.4);margin-bottom:4px;text-transform:uppercase}
        .import-field input{width:100%;padding:10px 12px;border:1px solid rgba(255,255,255,.1);border-radius:8px;background:rgba(255,255,255,.04);color:#fff;font-family:inherit;font-size:14px}
        .import-field input:focus{outline:none;border-color:rgba(249,115,22,.5)}
        .import-card-select{width:100%;padding:10px 12px;border:1px solid rgba(255,255,255,.1);border-radius:8px;background:rgba(255,255,255,.04);color:#fff;font-family:inherit;font-size:14px}
        .import-count{font-size:13px;color:rgba(255,255,255,.4)}

        /* ── Filter Bar ── */
        .filter-bar{
            position:sticky;
            top:122px;
            background:rgba(26,26,46,.95);
            backdrop-filter:blur(8px);
            -webkit-backdrop-filter:blur(8px);
            padding:8px 20px 12px;
            display:flex;
            gap:8px;
            z-index:10;
            overflow-x:auto;
            scrollbar-width:none;
        }
        .filter-bar::-webkit-scrollbar{display:none}
        .filter-chip{
            font-size:12px;
            padding:8px 14px;
            border-radius:20px;
            border:1px solid rgba(255,255,255,.1);
            background:transparent;
            color:rgba(255,255,255,.5);
            cursor:pointer;
            white-space:nowrap;
            font-family:inherit;
            flex-shrink:0;
        }
        .filter-chip:active{transform:scale(.95)}
        .filter-chip.active{background:rgba(249,115,22,.2);border-color:rgba(249,115,22,.4);color:#fdba74}
        .card-filter-bar{top:166px;padding-top:0;gap:6px}
        .card-filter-bar .filter-label{font-size:11px;color:rgba(255,255,255,.35);padding:8px 4px 8px 0;flex-shrink:0}
        .card-chip{padding:6px 12px;font-size:11px;border-width:2px;border-left-width:3px}
        .card-chip.active{background:rgba(255,255,255,.08)}

        /* ── Edit Lead Modal ── */
        .edit-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.85);z-index:200;display:none;align-items:center;justify-content:center;padding:20px}
        .edit-modal.show{display:flex}
        .edit-modal-content{background:#252538;border-radius:20px;width:100%;max-width:400px;max-height:90vh;overflow-y:auto}
        .edit-modal-header{padding:20px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;justify-content:space-between;align-items:center}
        .edit-modal-header h3{font-size:17px;font-weight:600}
        .edit-modal-close{background:none;border:none;color:rgba(255,255,255,.5);font-size:24px;cursor:pointer;padding:0 8px}
        .edit-modal-body{padding:20px}
        .edit-field{margin-bottom:14px}
        .edit-field label{display:block;font-size:11px;color:rgba(255,255,255,.4);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
        .edit-field input,.edit-field textarea{width:100%;padding:12px 14px;border:1px solid rgba(255,255,255,.1);border-radius:10px;background:rgba(255,255,255,.04);color:#fff;font-family:inherit;font-size:14px}
        .edit-field input:focus,.edit-field textarea:focus{outline:none;border-color:rgba(249,115,22,.5);background:rgba(255,255,255,.06)}
        .edit-field textarea{resize:vertical;min-height:60px}
        .edit-modal-footer{padding:16px 20px;border-top:1px solid rgba(255,255,255,.06);display:flex;gap:10px}
        .edit-save-btn{flex:1;padding:14px;border:none;border-radius:12px;background:#f97316;color:#fff;font-family:inherit;font-size:15px;font-weight:600;cursor:pointer}
        .edit-save-btn:active{opacity:.8}
        .edit-cancel-btn{padding:14px 20px;border:1px solid rgba(255,255,255,.1);border-radius:12px;background:transparent;color:rgba(255,255,255,.6);font-family:inherit;font-size:15px;cursor:pointer}

        /* ── Reminder Banner ── */
        .reminder-banner{display:none;padding:14px 20px;background:rgba(251,146,60,.1);border-bottom:1px solid rgba(251,146,60,.2)}
        .reminder-banner.show{display:block}
        .reminder-banner-title{font-size:13px;font-weight:600;color:#fb923c;margin-bottom:8px}
        .reminder-item{font-size:13px;color:rgba(255,255,255,.6);padding:6px 0;display:flex;justify-content:space-between;align-items:center}
        .reminder-item a{color:#fb923c;text-decoration:none;font-weight:500}
        .reminder-dismiss{background:none;border:none;color:rgba(255,255,255,.4);font-size:12px;cursor:pointer;padding:4px 8px;font-family:inherit}

        /* ── Lead Item ── */
        .lead-item{padding:18px 20px;border-bottom:1px solid rgba(255,255,255,.06);background:rgba(255,255,255,.02);margin:8px 12px;border-radius:14px}
        .lead-item .li-top{display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
        .lead-item .li-name{font-size:17px;font-weight:600}
        .lead-item .li-company{font-size:13px;color:rgba(255,255,255,.5);margin-top:2px}
        .lead-item .li-card-badge{font-size:10px;padding:4px 10px;border-radius:8px;background:rgba(255,255,255,.08);color:rgba(255,255,255,.5)}
        .lead-item .li-contact{margin-top:10px;font-size:14px;color:rgba(255,255,255,.6)}
        .lead-item .li-contact a{color:rgba(255,255,255,.7);text-decoration:none}
        .lead-item .li-address{font-size:13px;color:rgba(255,255,255,.4);margin-top:6px}
        .lead-item .li-time{font-size:11px;color:rgba(255,255,255,.3);margin-top:10px}
        .lead-item .li-source{font-size:10px;color:rgba(255,255,255,.25);margin-left:8px;text-transform:uppercase}
        .lead-item .li-photo{width:100%;max-height:160px;object-fit:contain;border-radius:10px;margin-top:12px}
        .leads-empty{text-align:center;padding:60px 24px;color:rgba(255,255,255,.4);font-size:15px}
        .li-quick-actions{display:flex;gap:8px;margin-top:12px}
        .li-quick-btn{display:inline-flex;align-items:center;gap:6px;padding:10px 16px;border:none;border-radius:10px;font-family:inherit;font-size:13px;font-weight:500;cursor:pointer;text-decoration:none;color:#fff}
        .li-quick-btn svg{width:18px;height:18px;fill:currentColor}
        .li-quick-btn.call-btn{background:rgba(96,165,250,.2);color:#60a5fa}
        .li-quick-btn.wa-btn{background:rgba(74,222,128,.2);color:#4ade80}
        .li-quick-btn.email-btn{background:rgba(251,191,36,.2);color:#fbbf24}
        .li-quick-btn:active{transform:scale(.95);opacity:.8}

        /* ── Status Badge ── */
        .status-badge{
            font-size:11px;
            padding:4px 10px;
            border-radius:8px;
            font-weight:600;
            cursor:pointer;
            border:none;
            font-family:inherit;
        }
        .status-badge:active{transform:scale(.9)}
        .status-new{background:rgba(59,130,246,.15);color:#60a5fa}
        .status-contacted{background:rgba(251,191,36,.15);color:#fbbf24}
        .status-qualified{background:rgba(168,85,247,.15);color:#c084fc}
        .status-won{background:rgba(34,197,94,.15);color:#4ade80}
        .status-lost{background:rgba(239,68,68,.12);color:#f87171}

        /* ── Score Badges ── */
        .score-badge{font-size:10px;padding:3px 8px;border-radius:6px;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
        .score-hot{background:linear-gradient(135deg,#ef4444,#f97316);color:#fff;animation:pulse-hot 2s infinite}
        .score-warm{background:rgba(251,191,36,.2);color:#fbbf24}
        .score-cool{background:rgba(96,165,250,.15);color:#60a5fa}
        @keyframes pulse-hot{0%,100%{box-shadow:0 0 0 0 rgba(249,115,22,.4)}50%{box-shadow:0 0 0 4px rgba(249,115,22,0)}}
        .lead-actions-row{display:flex;flex-wrap:wrap;gap:4px;margin-top:6px}
        .action-chip{font-size:9px;padding:2px 6px;border-radius:4px;background:rgba(255,255,255,.08);color:rgba(255,255,255,.5)}

        /* ── Tags ── */
        .tag-row{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
        .tag-chip{font-size:11px;padding:4px 10px;border-radius:12px;background:rgba(249,115,22,.12);color:#fdba74;cursor:pointer;border:none;font-family:inherit}
        .tag-chip:active{transform:scale(.93)}
        .add-tag-btn{font-size:11px;padding:4px 10px;border-radius:12px;background:rgba(255,255,255,.05);color:rgba(255,255,255,.4);cursor:pointer;border:1px dashed rgba(255,255,255,.15);font-family:inherit}
        .add-tag-btn:active{transform:scale(.95)}

        /* ── Notes ── */
        .lead-note{margin-top:10px}
        .lead-note textarea{
            width:100%;
            padding:10px 12px;
            border:1px solid rgba(255,255,255,.1);
            border-radius:10px;
            background:rgba(255,255,255,.04);
            color:rgba(255,255,255,.8);
            font-family:inherit;
            font-size:13px;
            resize:vertical;
            min-height:40px;
            outline:none;
        }
        .lead-note textarea::placeholder{color:rgba(255,255,255,.25)}
        .lead-note textarea:focus{border-color:rgba(255,255,255,.2);background:rgba(255,255,255,.06)}
        .lead-note-saved{font-size:11px;color:rgba(34,197,94,.7);display:none;margin-top:4px}

        /* ── Reminder ── */
        .lead-reminder{margin-top:8px;display:flex;align-items:center;gap:8px}
        .lead-reminder input[type="date"]{
            background:rgba(255,255,255,.06);
            border:1px solid rgba(255,255,255,.1);
            border-radius:8px;
            color:rgba(255,255,255,.7);
            font-family:inherit;
            font-size:12px;
            padding:6px 10px;
            outline:none;
        }
        .lead-reminder input[type="date"]::-webkit-calendar-picker-indicator{filter:invert(.6)}
        .remind-btn{font-size:12px;padding:6px 12px;border-radius:8px;border:none;background:rgba(251,146,60,.12);color:#fb923c;cursor:pointer;font-family:inherit}
        .remind-set{font-size:11px;color:#fb923c}
        .followup-send{font-size:11px;padding:5px 10px;border-radius:6px;border:none;background:#25D366;color:#fff;cursor:pointer;font-family:inherit;display:inline-flex;align-items:center;gap:4px}
        .followup-send svg{width:12px;height:12px;fill:#fff}
        .reminder-overdue{color:#f87171!important}
        .due-reminders{
            background:linear-gradient(135deg,rgba(251,146,60,.15),rgba(249,115,22,.1));
            border:1px solid rgba(249,115,22,.2);
            border-radius:12px;
            padding:14px 16px;
            margin:0 20px 12px;
        }
        .due-reminders-title{font-size:13px;font-weight:600;color:#fb923c;margin-bottom:10px;display:flex;align-items:center;gap:6px}
        .due-reminders-title svg{width:16px;height:16px;fill:#fb923c}
        .due-item{
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:8px 0;
            border-bottom:1px solid rgba(255,255,255,.05);
        }
        .due-item:last-child{border-bottom:none}
        .due-item-info{flex:1}
        .due-item-name{font-size:13px;font-weight:500;color:rgba(255,255,255,.9)}
        .due-item-date{font-size:11px;color:#fb923c}
        .template-select{
            font-size:11px;
            padding:4px 8px;
            border-radius:6px;
            background:rgba(255,255,255,.08);
            border:1px solid rgba(255,255,255,.1);
            color:rgba(255,255,255,.7);
            font-family:inherit;
            margin-right:6px;
        }

        /* ── Lead Actions ── */
        .lead-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
        .save-lead-btn{
            display:inline-flex;
            align-items:center;
            gap:6px;
            padding:10px 16px;
            border:none;
            border-radius:10px;
            background:rgba(74,222,128,.15);
            color:#4ade80;
            font-family:inherit;
            font-size:13px;
            font-weight:600;
            cursor:pointer;
        }
        .save-lead-btn:active{transform:scale(.96)}
        .save-lead-btn svg{width:16px;height:16px;fill:#4ade80}
        .del-lead-btn{
            display:inline-flex;
            align-items:center;
            gap:6px;
            padding:10px 14px;
            border:none;
            border-radius:10px;
            background:rgba(239,68,68,.1);
            color:#f87171;
            font-family:inherit;
            font-size:13px;
            font-weight:600;
            cursor:pointer;
        }
        .del-lead-btn:active{transform:scale(.96)}
        .del-lead-btn svg{width:14px;height:14px;fill:#f87171}
        .edit-lead-btn{
            display:inline-flex;
            align-items:center;
            gap:6px;
            padding:10px 14px;
            border:none;
            border-radius:10px;
            background:rgba(249,115,22,.15);
            color:#fdba74;
            font-family:inherit;
            font-size:13px;
            font-weight:600;
            cursor:pointer;
        }
        .edit-lead-btn:active{transform:scale(.96)}
        .edit-lead-btn svg{width:14px;height:14px;fill:#fdba74}

        /* ── Quick Send Modal ── */
        .qs-modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:flex-end;justify-content:center;z-index:100}
        .qs-modal.show{display:flex}
        .qs-sheet{
            background:#252538;
            border-radius:20px 20px 0 0;
            width:100%;
            max-width:480px;
            padding:28px 20px calc(28px + env(safe-area-inset-bottom));
        }
        .qs-sheet h3{font-size:18px;font-weight:600;margin-bottom:6px}
        .qs-sheet .qs-sub{font-size:13px;color:rgba(255,255,255,.4);margin-bottom:20px}
        .qs-opt{
            width:100%;
            padding:16px 18px;
            border:1px solid rgba(255,255,255,.08);
            border-radius:14px;
            background:rgba(255,255,255,.04);
            color:#fff;
            font-family:inherit;
            font-size:15px;
            font-weight:500;
            cursor:pointer;
            margin-bottom:10px;
            text-align:left;
        }
        .qs-opt:active{transform:scale(.98)}
        .qs-opt.selected{border-color:rgba(249,115,22,.5);background:rgba(249,115,22,.12)}
        .qs-opt small{display:block;font-size:12px;font-weight:400;color:rgba(255,255,255,.4);margin-top:3px}
        .qs-off{
            text-align:center;
            padding:14px;
            border:none;
            background:none;
            color:rgba(255,255,255,.4);
            font-family:inherit;
            font-size:14px;
            cursor:pointer;
            width:100%;
            margin-top:8px;
        }
        .qs-off:active{color:rgba(255,255,255,.6)}

        /* ── Tag Modal ── */
        .tag-modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:flex-end;justify-content:center;z-index:100}
        .tag-modal.show{display:flex}
        .tag-sheet{
            background:#252538;
            border-radius:20px 20px 0 0;
            width:100%;
            max-width:480px;
            padding:28px 20px calc(28px + env(safe-area-inset-bottom));
        }
        .tag-sheet h3{font-size:18px;font-weight:600;margin-bottom:16px}
        .tag-options{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:20px}
        .tag-option{
            padding:10px 18px;
            border-radius:20px;
            border:1px solid rgba(255,255,255,.1);
            background:rgba(255,255,255,.04);
            color:rgba(255,255,255,.6);
            font-family:inherit;
            font-size:14px;
            cursor:pointer;
        }
        .tag-option:active{transform:scale(.95)}
        .tag-option.selected{border-color:rgba(249,115,22,.5);background:rgba(249,115,22,.15);color:#fdba74}
        .tag-custom{display:flex;gap:10px;margin-bottom:20px}
        .tag-custom input{
            flex:1;
            padding:12px 16px;
            border:1px solid rgba(255,255,255,.1);
            border-radius:12px;
            background:rgba(255,255,255,.05);
            color:#fff;
            font-family:inherit;
            font-size:14px;
            outline:none;
        }
        .tag-custom input::placeholder{color:rgba(255,255,255,.3)}
        .tag-custom input:focus{border-color:rgba(255,255,255,.2)}
        .tag-custom button{
            padding:12px 20px;
            border:none;
            border-radius:12px;
            background:rgba(249,115,22,.2);
            color:#fb923c;
            font-family:inherit;
            font-size:14px;
            font-weight:600;
            cursor:pointer;
        }
        .tag-custom button:active{transform:scale(.95)}
        .tag-done{
            width:100%;
            padding:14px;
            border:none;
            border-radius:12px;
            background:rgba(34,197,94,.15);
            color:#4ade80;
            font-family:inherit;
            font-size:15px;
            font-weight:600;
            cursor:pointer;
        }
        .tag-done:active{transform:scale(.97)}

        /* ── Analytics Dashboard ── */
        #analytics{
            display:none;
        }
        .analytics-header{
            position:sticky;
            top:0;
            background:rgba(26,26,46,.95);
            backdrop-filter:blur(12px);
            -webkit-backdrop-filter:blur(12px);
            padding:16px 20px;
            padding-top:calc(16px + env(safe-area-inset-top));
            display:flex;
            align-items:center;
            gap:12px;
            border-bottom:1px solid rgba(255,255,255,.06);
            z-index:10;
        }
        .analytics-header h2{font-size:18px;font-weight:600}
        .analytics-content{padding:20px}
        .analytics-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:24px}
        .analytics-card{background:rgba(255,255,255,.04);border-radius:14px;padding:20px;text-align:center}
        .analytics-card .ac-num{font-size:32px;font-weight:700;color:rgba(255,255,255,.85)}
        .analytics-card .ac-label{font-size:12px;color:rgba(255,255,255,.4);margin-top:4px}
        .analytics-section{margin-bottom:28px}
        .analytics-section h3{font-size:15px;font-weight:600;color:rgba(255,255,255,.6);margin-bottom:14px}
        .analytics-bar{display:flex;align-items:center;gap:12px;margin-bottom:10px}
        .analytics-bar .ab-label{font-size:13px;color:rgba(255,255,255,.5);width:90px;flex-shrink:0}
        .analytics-bar .ab-track{flex:1;height:8px;background:rgba(255,255,255,.06);border-radius:4px;overflow:hidden}
        .analytics-bar .ab-fill{height:100%;border-radius:4px}
        .analytics-bar .ab-count{font-size:13px;color:rgba(255,255,255,.5);width:40px;text-align:right;flex-shrink:0}
        .chart-container{background:rgba(255,255,255,.04);border-radius:14px;padding:20px;margin-bottom:24px}
        .chart-container canvas{width:100%;height:180px}
        .card-perf-item{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid rgba(255,255,255,.04)}
        .card-perf-item:last-child{border-bottom:none}
        .card-perf-name{font-size:14px;font-weight:500}
        .card-perf-stats{font-size:13px;color:rgba(255,255,255,.4)}

        /* ── Storage Dashboard ── */
        #storage{
            display:none;
        }
        .storage-card{background:rgba(255,255,255,.04);border-radius:14px;padding:20px;margin-bottom:16px}
        .storage-card h4{font-size:14px;font-weight:600;color:rgba(255,255,255,.7);margin-bottom:12px}
        .storage-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.04)}
        .storage-row:last-child{border-bottom:none}
        .storage-label{font-size:13px;color:rgba(255,255,255,.5)}
        .storage-value{font-size:14px;font-weight:600;color:rgba(255,255,255,.8)}
        .storage-bar{margin-top:12px}
        .storage-bar-track{height:8px;background:rgba(255,255,255,.08);border-radius:4px;overflow:hidden}
        .storage-bar-fill{height:100%;border-radius:4px;background:linear-gradient(90deg,#2dd4bf,#14b8a6)}
        .storage-bar-label{display:flex;justify-content:space-between;font-size:11px;color:rgba(255,255,255,.4);margin-top:6px}
        .cost-free{color:#4ade80}
        .cost-paid{color:#fbbf24}
        .storage-note{font-size:12px;color:rgba(255,255,255,.35);margin-top:16px;line-height:1.6}

        /* ── Review Queue ── */
        #reviewQueue{
            display:none;
        }
        .review-item{padding:20px;border-bottom:1px solid rgba(255,255,255,.06)}
        .review-img{width:100%;max-height:250px;object-fit:contain;border-radius:12px;background:rgba(0,0,0,.3);margin-bottom:16px}
        .review-ocr-btn{
            width:100%;
            padding:12px;
            border:none;
            border-radius:10px;
            background:rgba(249,115,22,.15);
            color:#fb923c;
            font-family:inherit;
            font-size:14px;
            font-weight:600;
            cursor:pointer;
            margin-bottom:16px;
            display:flex;
            align-items:center;
            justify-content:center;
            gap:8px;
        }
        .review-ocr-btn:active{transform:scale(.97)}
        .review-ocr-btn.scanning{opacity:.7}
        .review-ocr-btn svg{width:18px;height:18px;fill:currentColor}
        .review-field{margin-bottom:10px}
        .review-field label{display:block;font-size:11px;color:rgba(255,255,255,.4);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px}
        .review-field input{
            width:100%;
            padding:12px 14px;
            border:1px solid rgba(255,255,255,.1);
            border-radius:10px;
            background:rgba(255,255,255,.05);
            color:#fff;
            font-family:inherit;
            font-size:14px;
            outline:none;
        }
        .review-field input:focus{border-color:rgba(255,255,255,.25);background:rgba(255,255,255,.08)}
        .review-field input::placeholder{color:rgba(255,255,255,.25)}
        .review-field textarea{
            width:100%;
            padding:12px 14px;
            border:1px solid rgba(255,255,255,.1);
            border-radius:10px;
            background:rgba(255,255,255,.05);
            color:#fff;
            font-family:inherit;
            font-size:14px;
            outline:none;
            resize:vertical;
            min-height:60px;
        }
        .review-field textarea:focus{border-color:rgba(255,255,255,.25);background:rgba(255,255,255,.08)}
        .review-field textarea::placeholder{color:rgba(255,255,255,.25)}
        .review-actions{display:flex;gap:10px;margin-top:16px}
        .review-save{
            flex:1;
            padding:14px;
            border:none;
            border-radius:10px;
            background:rgba(34,197,94,.15);
            color:#4ade80;
            font-family:inherit;
            font-size:14px;
            font-weight:600;
            cursor:pointer;
        }
        .review-save:active{transform:scale(.97)}
        .review-skip{
            padding:14px 20px;
            border:none;
            border-radius:10px;
            background:rgba(255,255,255,.06);
            color:rgba(255,255,255,.5);
            font-family:inherit;
            font-size:14px;
            font-weight:500;
            cursor:pointer;
        }
        .review-skip:active{transform:scale(.97)}
        .review-time{font-size:11px;color:rgba(255,255,255,.3);margin-bottom:12px}

        /* ── Scan Modal ── */
        .scan-modal{position:fixed;inset:0;background:rgba(0,0,0,.9);z-index:300;display:none;flex-direction:column}
        .scan-modal.show{display:flex}
        .scan-header{padding:16px 20px;padding-top:calc(16px + env(safe-area-inset-top));display:flex;align-items:center;gap:12px;border-bottom:1px solid rgba(255,255,255,.1)}
        .scan-header h3{flex:1;font-size:17px;font-weight:600}
        .scan-close{background:none;border:none;color:rgba(255,255,255,.6);font-size:14px;cursor:pointer;padding:8px 12px}
        .scan-options{display:flex;gap:12px;padding:20px;justify-content:center}
        .scan-option{
            flex:1;max-width:160px;
            padding:24px 16px;
            border-radius:16px;
            border:2px solid rgba(255,255,255,.1);
            background:rgba(255,255,255,.04);
            color:#fff;
            font-family:inherit;
            text-align:center;
            cursor:pointer;
        }
        .scan-option:active{transform:scale(.97);border-color:rgba(255,255,255,.2)}
        .scan-option.active{border-color:#4ade80;background:rgba(74,222,128,.1)}
        .scan-option svg{width:40px;height:40px;fill:rgba(255,255,255,.5);margin-bottom:12px}
        .scan-option.active svg{fill:#4ade80}
        .scan-option-title{font-size:15px;font-weight:600;margin-bottom:4px}
        .scan-option-desc{font-size:12px;color:rgba(255,255,255,.4)}
        .scan-camera{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;position:relative}
        .scan-camera video{width:100%;max-width:400px;border-radius:16px;background:#000}
        .scan-camera canvas{display:none}
        .scan-viewfinder{
            position:absolute;
            width:250px;height:250px;
            border:2px solid rgba(74,222,128,.5);
            border-radius:16px;
            pointer-events:none;
        }
        .scan-viewfinder::before,.scan-viewfinder::after{
            content:'';position:absolute;
            width:30px;height:30px;
            border:3px solid #4ade80;
        }
        .scan-viewfinder::before{top:-2px;left:-2px;border-right:none;border-bottom:none;border-radius:16px 0 0 0}
        .scan-viewfinder::after{bottom:-2px;right:-2px;border-left:none;border-top:none;border-radius:0 0 16px 0}
        .scan-status{margin-top:16px;font-size:14px;color:rgba(255,255,255,.5);text-align:center}
        .scan-capture-btn{
            margin-top:20px;
            padding:16px 40px;
            border-radius:14px;
            border:none;
            background:#4ade80;
            color:#000;
            font-family:inherit;
            font-size:16px;
            font-weight:600;
            cursor:pointer;
        }
        .scan-capture-btn:active{transform:scale(.97)}
        .scan-capture-btn:disabled{opacity:.5}
        .scan-result{padding:20px;overflow-y:auto}
        .scan-result-card{background:rgba(255,255,255,.05);border-radius:14px;padding:20px}
        .scan-result-title{font-size:13px;color:rgba(255,255,255,.4);text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}
        .scan-result-field{margin-bottom:12px}
        .scan-result-field label{display:block;font-size:11px;color:rgba(255,255,255,.4);margin-bottom:4px}
        .scan-result-field input{
            width:100%;padding:12px;
            border:1px solid rgba(255,255,255,.1);
            border-radius:10px;
            background:rgba(255,255,255,.05);
            color:#fff;font-family:inherit;font-size:14px;
        }
        .scan-result-field input:focus{outline:none;border-color:rgba(74,222,128,.5)}
        .scan-result-actions{display:flex;gap:10px;margin-top:16px}
        .scan-save-btn{
            flex:1;padding:14px;border:none;border-radius:12px;
            background:#4ade80;color:#000;
            font-family:inherit;font-size:15px;font-weight:600;cursor:pointer;
        }
        .scan-save-btn:active{transform:scale(.97)}
        .scan-retry-btn{
            padding:14px 20px;border:none;border-radius:12px;
            background:rgba(255,255,255,.1);color:#fff;
            font-family:inherit;font-size:15px;cursor:pointer;
        }

        /* ═══ SaaS LAYOUT ═══ */

        /* ── App Shell ── */
        .app-shell{display:flex;height:100dvh;overflow:hidden}

        /* ── Sidebar ── */
        .sidebar{
            width:240px;
            flex-shrink:0;
            background:var(--bg-card);
            border-right:1px solid var(--border);
            display:flex;
            flex-direction:column;
            padding:0;
            overflow-y:auto;
        }
        .sidebar-brand{
            padding:20px 20px 16px;
            display:flex;
            align-items:center;
            gap:10px;
            border-bottom:1px solid var(--border);
        }
        .sidebar-brand-icon{
            width:36px;height:36px;
            border-radius:10px;
            background:linear-gradient(135deg,var(--accent),#8b5cf6);
            display:flex;align-items:center;justify-content:center;
            flex-shrink:0;
        }
        .sidebar-brand-icon svg{width:20px;height:20px;fill:#fff}
        .sidebar-brand-name{font-size:17px;font-weight:700;color:var(--text-primary)}

        .sidebar-nav{flex:1;padding:12px 10px}
        .nav-item{
            display:flex;
            align-items:center;
            gap:12px;
            padding:10px 14px;
            border-radius:10px;
            border:none;
            background:none;
            color:var(--text-secondary);
            font-family:inherit;
            font-size:14px;
            font-weight:500;
            cursor:pointer;
            width:100%;
            text-align:left;
            margin-bottom:2px;
            transition:background .15s,color .15s;
        }
        .nav-item:hover{background:var(--bg-hover);color:var(--text-primary)}
        .nav-item.active{background:rgba(99,102,241,.15);color:var(--accent-light)}
        .nav-item svg{width:20px;height:20px;fill:currentColor;flex-shrink:0;opacity:.7}
        .nav-item.active svg{opacity:1}
        .nav-item-label{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

        .sidebar-user{
            padding:16px;
            border-top:1px solid var(--border);
            display:flex;
            align-items:center;
            gap:10px;
        }
        .sidebar-user-info{flex:1;min-width:0}
        .sidebar-user-name{font-size:13px;font-weight:600;color:var(--text-primary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .sidebar-plan-badge{
            display:inline-block;
            font-size:10px;
            padding:2px 8px;
            border-radius:6px;
            background:rgba(99,102,241,.15);
            color:var(--accent-light);
            text-transform:capitalize;
            font-weight:600;
            margin-top:2px;
        }
        .sidebar-signout{
            width:32px;height:32px;
            border-radius:8px;
            border:none;
            background:rgba(239,68,68,.1);
            cursor:pointer;
            display:flex;align-items:center;justify-content:center;
            flex-shrink:0;
        }
        .sidebar-signout svg{width:16px;height:16px;fill:#f87171}
        .sidebar-signout:hover{background:rgba(239,68,68,.2)}

        /* ── Main Content ── */
        .main-content{
            flex:1;
            overflow-y:auto;
            -webkit-overflow-scrolling:touch;
            background:var(--bg-base);
            position:relative;
        }

        /* ── Pages ── */
        .page{display:none;padding:24px;min-height:100%}
        .page.active{display:block}
        .page-header{
            display:flex;
            align-items:center;
            justify-content:space-between;
            margin-bottom:24px;
        }
        .page-header h1{font-size:24px;font-weight:700}

        /* ── Bottom Tab Bar (mobile) ── */
        .bottom-tabs{
            display:none;
            position:fixed;
            bottom:0;left:0;right:0;
            background:var(--bg-card);
            border-top:1px solid var(--border);
            padding:4px 0;
            padding-bottom:calc(4px + env(safe-area-inset-bottom));
            z-index:100;
        }
        .tab-item{
            flex:1;
            display:flex;
            flex-direction:column;
            align-items:center;
            gap:2px;
            padding:6px 0;
            border:none;
            background:none;
            color:var(--text-muted);
            font-family:inherit;
            font-size:10px;
            font-weight:500;
            cursor:pointer;
        }
        .tab-item svg{width:22px;height:22px;fill:currentColor}
        .tab-item.active{color:var(--accent-light)}

        /* ── Dashboard Stats ── */
        .stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:28px}
        .stat-card{
            background:var(--bg-card);
            border-radius:14px;
            padding:18px;
            border:1px solid var(--border);
        }
        .stat-card-icon{
            width:36px;height:36px;
            border-radius:10px;
            display:flex;align-items:center;justify-content:center;
            margin-bottom:10px;
        }
        .stat-card-icon svg{width:20px;height:20px;fill:currentColor}
        .stat-card-value{font-size:26px;font-weight:700;color:var(--text-primary)}
        .stat-card-label{font-size:12px;color:var(--text-muted);margin-top:2px}

        /* ── Dashboard Sections ── */
        .dash-section{margin-bottom:28px}
        .dash-section-header{
            display:flex;
            align-items:center;
            justify-content:space-between;
            margin-bottom:14px;
        }
        .dash-section-title{font-size:16px;font-weight:600;color:var(--text-primary)}
        .dash-section-link{font-size:13px;color:var(--accent-light);cursor:pointer;background:none;border:none;font-family:inherit}
        .dash-section-link:hover{text-decoration:underline}

        /* ── Dashboard Card Tiles ── */
        .dash-cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}
        .dash-card-tile{
            background:var(--bg-card);
            border-radius:14px;
            padding:18px;
            border:1px solid var(--border);
            border-left:4px solid;
            display:flex;
            align-items:center;
            gap:14px;
        }
        .dash-card-tile-info{flex:1;min-width:0}
        .dash-card-tile-name{font-size:15px;font-weight:600;color:var(--text-primary)}
        .dash-card-tile-sub{font-size:12px;color:var(--text-muted);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .dash-card-tile-actions{display:flex;gap:6px}
        .dash-tile-btn{
            width:32px;height:32px;
            border-radius:8px;
            border:none;
            background:rgba(255,255,255,.06);
            cursor:pointer;
            display:flex;align-items:center;justify-content:center;
        }
        .dash-tile-btn:hover{background:rgba(255,255,255,.1)}
        .dash-tile-btn:active{transform:scale(.9)}
        .dash-tile-btn svg{width:16px;height:16px;fill:var(--text-secondary)}

        /* ── Activity Feed ── */
        .activity-list{display:flex;flex-direction:column;gap:0}
        .activity-item{
            display:flex;
            align-items:flex-start;
            gap:12px;
            padding:12px 0;
            border-bottom:1px solid var(--border);
        }
        .activity-item:last-child{border-bottom:none}
        .activity-dot{
            width:8px;height:8px;
            border-radius:50%;
            background:var(--accent);
            margin-top:6px;
            flex-shrink:0;
        }
        .activity-text{flex:1;min-width:0}
        .activity-name{font-size:14px;font-weight:500;color:var(--text-primary)}
        .activity-detail{font-size:12px;color:var(--text-muted);margin-top:1px}
        .activity-time{font-size:11px;color:var(--text-muted);flex-shrink:0;margin-top:4px}

        /* ── Settings Page ── */
        .settings-section{margin-bottom:28px}
        .settings-section-title{
            font-size:11px;
            text-transform:uppercase;
            letter-spacing:1px;
            color:var(--text-muted);
            font-weight:600;
            margin-bottom:10px;
            padding-left:4px;
        }
        .settings-group{
            background:var(--bg-card);
            border-radius:14px;
            border:1px solid var(--border);
            overflow:hidden;
        }
        .settings-group .settings-item{
            margin-bottom:0;
            border-radius:0;
            background:transparent;
            border-bottom:1px solid var(--border);
        }
        .settings-group .settings-item:last-child{border-bottom:none}

        /* ── Responsive ── */
        @media(max-width:767px){
            .sidebar{display:none}
            .bottom-tabs{display:flex}
            .page{padding:16px;padding-bottom:calc(80px + env(safe-area-inset-bottom))}
            .stats-row{grid-template-columns:1fr 1fr;gap:10px}
            .stat-card{padding:14px}
            .stat-card-value{font-size:22px}
            .dash-cards-grid{grid-template-columns:1fr}
            .page-header h1{font-size:20px}
        }
        @media(min-width:768px) and (max-width:1024px){
            .sidebar{width:68px}
            .sidebar-brand-name{display:none}
            .sidebar-brand{justify-content:center;padding:16px 8px}
            .nav-item{justify-content:center;padding:12px}
            .nav-item-label{display:none}
            .sidebar-user{flex-direction:column;padding:12px 8px;gap:6px}
            .sidebar-user-info{display:none}
            .sidebar-signout{width:36px;height:36px}
        }

        /* Loading Screen */
        #loadingScreen{position:fixed;inset:0;z-index:99999;background:var(--bg-base);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:24px;transition:opacity 0.3s ease}
        #loadingScreen.fade-out{opacity:0;pointer-events:none}
        .loading-logo{font-size:28px;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--accent-light));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
        .loading-spinner{width:32px;height:32px;border:3px solid var(--bg-elevated);border-top-color:var(--accent);border-radius:50%;animation:lspin 0.8s linear infinite}
        @keyframes lspin{to{transform:rotate(360deg)}}

        /* App Container Fade-in */
        #appContainer{opacity:0;transition:opacity 0.3s ease}
        #appContainer.visible{opacity:1}

        /* Skeleton Loaders */
        .skeleton{background:var(--bg-elevated);border-radius:6px;position:relative;overflow:hidden}
        .skeleton::after{content:'';position:absolute;inset:0;background:linear-gradient(90deg,transparent,rgba(255,255,255,.04),transparent);animation:shimmer 1.5s infinite}
        @keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
        .skeleton-tile{background:var(--bg-card);border-radius:12px;padding:16px;border-left:3px solid var(--bg-elevated)}

        /* Onboarding Welcome */
        .onboarding-welcome{background:var(--bg-card);border-radius:16px;padding:32px 24px;max-width:480px;margin:0 auto;text-align:center}
        .onboarding-icon{font-size:40px;margin-bottom:12px}
        .onboarding-welcome h2{font-size:22px;font-weight:700;color:var(--text-primary);margin:0 0 8px}
        .onboarding-welcome p{color:var(--text-muted);font-size:14px;margin:0 0 24px;line-height:1.5}
        .onboarding-steps{display:flex;flex-direction:column;gap:0;position:relative;text-align:left;margin:0 auto 24px;max-width:260px}
        .onboarding-step{display:flex;align-items:center;gap:12px;padding:10px 0;position:relative}
        .onboarding-step:not(:last-child)::after{content:'';position:absolute;left:15px;top:38px;width:2px;height:calc(100% - 28px);background:var(--bg-elevated)}
        .onboarding-step-num{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:600;background:var(--bg-elevated);color:var(--text-muted);flex-shrink:0}
        .onboarding-step.done .onboarding-step-num{background:rgba(16,185,129,.15);color:var(--success)}
        .onboarding-step.active .onboarding-step-num{background:rgba(99,102,241,.15);color:var(--accent-light)}
        .onboarding-step.done>div:last-child{color:var(--text-muted)}
        .onboarding-step.active>div:last-child{color:var(--text-primary);font-weight:600}
        .onboarding-step>div:last-child{color:var(--text-muted);font-size:14px}
        .onboarding-cta{width:100%;padding:14px;background:linear-gradient(135deg,var(--accent),#8b5cf6);color:#fff;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;animation:obpulse 2s ease-in-out infinite}
        @keyframes obpulse{0%,100%{box-shadow:0 0 0 0 rgba(99,102,241,.4)}50%{box-shadow:0 0 0 8px rgba(99,102,241,0)}}
    </style>
</head>
<body>
<div id="loadingScreen">
    <div class="loading-logo">CardFlow</div>
    <div class="loading-spinner"></div>
</div>
<div id="appContainer" style="display:none">
    <!-- NFC Overlay Screens (high z-index, stay full-screen) -->
    <div id="picker" class="screen hidden">
        <div class="pick-alert">NEW TAP</div>
        <div class="pick-title">Someone tapped your card!</div>
        <div class="pick-visitor" id="visitor-info"></div>
        <div class="pick-cards" id="pickerCards"></div>
        <button class="skip-btn" onclick="skipCard()">Skip — Don't share a card</button>
    </div>

    <div id="sent" class="screen hidden">
        <div class="check"><svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg></div>
        <h2>Card sent!</h2>
        <div class="sent-sub" id="sent-detail"></div>
        <div class="sent-auto" id="sent-auto"></div>
        <div id="lead-display"></div>
        <div class="return-progress" id="returnProgress"><div class="return-progress-bar"></div></div>
        <div class="return-text" id="returnText">Returning to home...</div>
        <button class="idle-btn leads-btn" style="margin-top:16px" onclick="goBackNow()">Back now</button>
    </div>

    <!-- Pull to Refresh Indicator -->
    <div class="ptr-indicator" id="ptrIndicator">
        <svg viewBox="0 0 24 24"><path d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
    </div>

    <!-- ═══ APP SHELL ═══ -->
    <div class="app-shell">
        <!-- Sidebar (desktop/tablet) -->
        <aside class="sidebar">
            <div class="sidebar-brand">
                <div class="sidebar-brand-icon"><svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V6h16v12zM6 10h2v2H6zm0 4h8v2H6zm10 0h2v2h-2zm-6-4h8v2h-8z"/></svg></div>
                <span class="sidebar-brand-name">CardFlow</span>
            </div>
            <nav class="sidebar-nav">
                <button class="nav-item active" onclick="navigateTo('dashboard')">
                    <svg viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>
                    <span class="nav-item-label">Dashboard</span>
                </button>
                <button class="nav-item" onclick="navigateTo('cards')">
                    <svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V6h16v12zM6 10h2v2H6zm0 4h8v2H6zm10 0h2v2h-2zm-6-4h8v2h-8z"/></svg>
                    <span class="nav-item-label">Cards</span>
                </button>
                <button class="nav-item" onclick="navigateTo('leads')">
                    <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                    <span class="nav-item-label">Leads</span>
                </button>
                <button class="nav-item" onclick="navigateTo('analytics')">
                    <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>
                    <span class="nav-item-label">Analytics</span>
                </button>
                <button class="nav-item" onclick="navigateTo('settings')">
                    <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                    <span class="nav-item-label">Settings</span>
                </button>
            </nav>
            <div class="sidebar-user">
                <div class="sidebar-user-info">
                    <div class="sidebar-user-name" id="sidebarUserName">User</div>
                    <div class="sidebar-plan-badge" id="sidebarPlanBadge">Free</div>
                </div>
                <button class="sidebar-signout" onclick="logout()" title="Sign out">
                    <svg viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
                </button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content" id="mainContent">

            <!-- ═══ DASHBOARD PAGE ═══ -->
            <div class="page active" id="page-dashboard">
                <div class="page-header">
                    <h1>Dashboard</h1>
                    <div style="display:flex;align-items:center;gap:8px">
                        <div class="status-icon" id="notifBtn" onclick="requestNotif()" style="width:36px;height:36px;border-radius:10px">
                            <svg viewBox="0 0 24 24" style="width:20px;height:20px"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg>
                            <span class="status-dot" id="notifDot"></span>
                        </div>
                    </div>
                </div>

                <!-- Stats Row -->
                <div class="stats-row">
                    <div class="stat-card">
                        <div class="stat-card-icon" style="background:rgba(99,102,241,.15);color:#818cf8"><svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></div>
                        <div class="stat-card-value" id="dashLeadCount"><div class="skeleton" style="width:40px;height:28px;display:inline-block"></div></div>
                        <div class="stat-card-label">Total Leads</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-icon" style="background:rgba(74,222,128,.15);color:#4ade80"><svg viewBox="0 0 24 24"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg></div>
                        <div class="stat-card-value" id="dashTapsToday"><div class="skeleton" style="width:40px;height:28px;display:inline-block"></div></div>
                        <div class="stat-card-label">Taps Today</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-icon" style="background:rgba(251,191,36,.15);color:#fbbf24"><svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V6h16v12z"/></svg></div>
                        <div class="stat-card-value" id="dashCardCount"><div class="skeleton" style="width:40px;height:28px;display:inline-block"></div></div>
                        <div class="stat-card-label">Active Cards</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-icon" style="background:rgba(168,85,247,.15);color:#c084fc"><svg viewBox="0 0 24 24"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg></div>
                        <div class="stat-card-value" id="dashPlan">Free</div>
                        <div class="stat-card-label">Plan</div>
                    </div>
                </div>

                <!-- Lead Usage Bar (free plan only) -->
                <div id="leadUsageBar" style="display:none;background:rgba(255,255,255,.05);border-radius:12px;padding:14px 16px;margin-bottom:16px">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                        <span style="font-size:13px;font-weight:600;color:var(--text-primary)">Leads this month</span>
                        <span id="leadUsageText" style="font-size:13px;color:var(--text-muted)">0 / 25</span>
                    </div>
                    <div style="height:6px;background:rgba(255,255,255,.08);border-radius:3px;overflow:hidden">
                        <div id="leadUsageFill" style="height:100%;width:0%;background:linear-gradient(90deg,#6366f1,#8b5cf6);border-radius:3px;transition:width .5s ease"></div>
                    </div>
                    <div id="leadUsageWarning" style="display:none;margin-top:8px;font-size:12px;color:#f59e0b"></div>
                </div>

                <!-- Pro Trial Banner (free plan only, dismissible) -->
                <div id="proTrialBanner" style="display:none;background:linear-gradient(135deg,rgba(99,102,241,.12),rgba(168,85,247,.12));border:1px solid rgba(99,102,241,.2);border-radius:14px;padding:16px;margin-bottom:16px;position:relative">
                    <button onclick="dismissProBanner()" style="position:absolute;top:10px;right:12px;background:none;border:none;color:rgba(255,255,255,.3);font-size:18px;cursor:pointer;padding:4px;line-height:1">&times;</button>
                    <div style="display:flex;align-items:center;gap:12px">
                        <div style="width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#6366f1,#8b5cf6);display:flex;align-items:center;justify-content:center;flex-shrink:0">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="#fff"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>
                        </div>
                        <div style="flex:1;min-width:0">
                            <div style="font-size:14px;font-weight:700;color:#fff;margin-bottom:2px">Try Pro free for 14 days</div>
                            <div style="font-size:12px;color:rgba(255,255,255,.5)">5 cards, unlimited leads, full analytics, remove branding</div>
                        </div>
                    </div>
                    <button onclick="showUpgradeModal('Try Pro free for 14 days — no credit card required.')" style="margin-top:12px;width:100%;background:#6366f1;color:#fff;border:none;padding:10px;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer">Start Free Trial</button>
                </div>

                <!-- Onboarding Welcome (hidden by default, shown for new users with 0 cards) -->
                <div class="onboarding-welcome" id="onboardingWelcome" style="display:none">
                    <div class="onboarding-icon">👋</div>
                    <h2>Welcome to CardFlow!</h2>
                    <p>Create your first digital business card in under a minute.</p>
                    <div class="onboarding-steps">
                        <div class="onboarding-step done" id="obStep1">
                            <div class="onboarding-step-num">✓</div>
                            <div>Account created</div>
                        </div>
                        <div class="onboarding-step active" id="obStep2">
                            <div class="onboarding-step-num">2</div>
                            <div>Create your first card</div>
                        </div>
                        <div class="onboarding-step" id="obStep3">
                            <div class="onboarding-step-num">3</div>
                            <div>Share with someone</div>
                        </div>
                    </div>
                    <button class="onboarding-cta" onclick="openCardEdit()">+ Create Your First Card</button>
                </div>

                <!-- Quick Share Section -->
                <div class="dash-section" id="dashQuickShare">
                    <div class="dash-section-header">
                        <span class="dash-section-title">Quick Share</span>
                        <button class="dash-section-link" onclick="openScanModal()">Scan Contact</button>
                    </div>
                    <div style="display:flex;gap:16px;flex-wrap:wrap;align-items:flex-start">
                        <div class="qr-card" style="max-width:260px;margin:0">
                            <div class="qr-card-header">
                                <select id="qrCardSelect" data-card-select onchange="generateQR()"></select>
                                <button class="qr-share-btn" onclick="shareCardLink()" title="Share">
                                    <svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/></svg>
                                </button>
                            </div>
                            <div class="qr-canvas-wrap" onclick="showFullscreenQR()">
                                <canvas id="qrCanvas"></canvas>
                            </div>
                            <div class="qr-btn-row">
                                <button class="qr-copy-btn" id="copyLinkBtn" onclick="copyCardLink()">
                                    <svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                                    Copy
                                </button>
                                <button class="qr-copy-btn" onclick="previewCard()">
                                    <svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
                                    Preview
                                </button>
                            </div>
                        </div>
                        <div style="display:flex;flex-direction:column;gap:8px;flex:1;min-width:180px">
                            <p id="statusBadges" style="font-size:13px;color:var(--text-muted)"></p>
                            <div class="default-badge" id="defaultBadge"></div>
                        </div>
                    </div>
                </div>

                <!-- Your Cards Section -->
                <div class="dash-section" id="dashCardsSection">
                    <div class="dash-section-header">
                        <span class="dash-section-title">Your Cards</span>
                        <button class="dash-section-link" onclick="navigateTo('cards')">Manage All</button>
                    </div>
                    <div class="dash-cards-grid" id="dashCardTiles">
                        <div class="dash-card-tile skeleton-tile"><div class="skeleton" style="height:48px"></div></div>
                        <div class="dash-card-tile skeleton-tile"><div class="skeleton" style="height:48px"></div></div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="dash-section" id="dashActivitySection">
                    <div class="dash-section-header">
                        <span class="dash-section-title">Recent Activity</span>
                        <button class="dash-section-link" onclick="navigateTo('leads')">View All</button>
                    </div>
                    <div class="activity-list" id="dashActivityFeed">
                        <div class="activity-item"><div class="skeleton" style="width:100%;height:16px"></div></div>
                        <div class="activity-item"><div class="skeleton" style="width:85%;height:16px"></div></div>
                        <div class="activity-item"><div class="skeleton" style="width:92%;height:16px"></div></div>
                    </div>
                </div>

                <div class="version-tag" onclick="showDebugMenu()" style="position:static;text-align:right;padding:8px 0">v68</div>
            </div>

            <!-- ═══ CARDS PAGE ═══ -->
            <div class="page" id="page-cards">
                <div class="page-header">
                    <h1>Manage Cards</h1>
                </div>
                <div id="cardsPanel">
                    <div id="cardsList"></div>
                    <button class="add-card-btn" onclick="openCardEdit()">
                        <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                        Add New Card
                    </button>
                </div>
            </div>

            <!-- ═══ LEADS PAGE ═══ -->
            <div class="page" id="page-leads">
                <div id="leads">
                    <div class="page-header">
                        <h1>Leads</h1>
                        <span id="leads-count" style="font-size:14px;color:var(--text-muted)"></span>
                    </div>
                    <div class="leads-toolbar" style="position:static;padding:0 0 12px;background:transparent;backdrop-filter:none">
                        <input class="leads-search" id="leadSearch" type="text" placeholder="Search leads, notes..." oninput="filterLeads()">
                        <button class="import-btn" onclick="startImport()">
                            <svg viewBox="0 0 24 24"><path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/></svg>
                            Import
                        </button>
                        <input type="file" id="importVcf" accept=".vcf,text/vcard" style="display:none" onchange="importFromVcf(this)">
                        <button class="csv-btn" onclick="exportCSV()">Export</button>
                        <button class="csv-btn" id="scoreSortBtn" onclick="toggleScoreSort()" title="Sort by engagement score">Score ↓</button>
                    </div>
                    <div class="filter-bar" id="filterBar" style="position:static;background:transparent;backdrop-filter:none;padding:0 0 8px">
                        <button class="filter-chip active" data-filter="all" onclick="setFilter('all')">All</button>
                        <button class="filter-chip" data-filter="score-hot" onclick="setFilter('score-hot')">Hot</button>
                        <button class="filter-chip" data-filter="score-warm" onclick="setFilter('score-warm')">Warm</button>
                        <button class="filter-chip" data-filter="status-new" onclick="setFilter('status-new')">New</button>
                        <button class="filter-chip" data-filter="status-contacted" onclick="setFilter('status-contacted')">Contacted</button>
                        <button class="filter-chip" data-filter="status-qualified" onclick="setFilter('status-qualified')">Qualified</button>
                        <button class="filter-chip" data-filter="status-won" onclick="setFilter('status-won')">Won</button>
                        <button class="filter-chip" data-filter="status-lost" onclick="setFilter('status-lost')">Lost</button>
                    </div>
                    <div class="filter-bar card-filter-bar" id="cardFilterBar" style="position:static;background:transparent;backdrop-filter:none;padding:0 0 8px"></div>
                    <div class="reminder-banner" id="reminderBanner"></div>
                    <div id="leads-list"></div>
                </div>
            </div>

            <!-- ═══ ANALYTICS PAGE ═══ -->
            <div class="page" id="page-analytics">
                <div id="analytics">
                    <div class="page-header">
                        <h1>Analytics</h1>
                    </div>
                    <div class="analytics-content" id="analyticsContent">
                        <div class="leads-empty">Loading analytics...</div>
                    </div>
                </div>
            </div>

            <!-- ═══ SETTINGS PAGE ═══ -->
            <div class="page" id="page-settings">
                <div class="page-header">
                    <h1>Settings</h1>
                </div>

                <!-- Profile Section -->
                <div class="settings-section">
                    <div class="settings-section-title">Profile</div>
                    <div class="settings-group">
                        <div class="settings-item" onclick="navigateTo('cards')">
                            <svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V6h16v12zM6 10h2v2H6zm0 4h8v2H6zm10 0h2v2h-2zm-6-4h8v2h-8z"/></svg>
                            <div class="settings-item-text"><strong>Manage Cards</strong><small>Add, edit, or remove business cards</small></div>
                        </div>
                        <div class="settings-item" onclick="openQuickSend()">
                            <svg viewBox="0 0 24 24"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>
                            <div class="settings-item-text"><strong>Quick Send</strong><small id="qsLabel">Auto-send a card on tap</small></div>
                        </div>
                        <div class="settings-item" onclick="openDefaultCard()">
                            <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                            <div class="settings-item-text"><strong id="defaultLabel">Default Card</strong><small>Card shown if you don't respond in 45s</small></div>
                        </div>
                    </div>
                </div>

                <!-- Billing Section -->
                <div class="settings-section">
                    <div class="settings-section-title">Billing</div>
                    <div class="settings-group">
                        <div class="settings-item" onclick="showBillingPanel()" style="cursor:pointer">
                            <svg viewBox="0 0 24 24"><path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/></svg>
                            <div class="settings-item-text"><strong>Billing & Plan</strong><small id="currentPlanLabel">Free plan</small></div>
                        </div>
                    </div>
                </div>

                <!-- Notifications Section -->
                <div class="settings-section">
                    <div class="settings-section-title">Notifications</div>
                    <div class="settings-group">
                        <div class="settings-item" onclick="requestNotif()">
                            <svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg>
                            <div class="settings-item-text"><strong id="settingsNotifLabel">Enable Notifications</strong><small>Get alerts when someone taps your card</small></div>
                        </div>
                        <div class="settings-item" onclick="showInstallModal()">
                            <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                            <div class="settings-item-text"><strong>Install App</strong><small>Add to home screen for notifications</small></div>
                        </div>
                    </div>
                </div>

                <!-- Storage Section (inline) -->
                <div class="settings-section" id="settingsStorageSection">
                    <div class="settings-section-title">Storage</div>
                    <div class="settings-group">
                        <div style="padding:16px" id="storageContent">
                            <div style="font-size:14px;color:var(--text-muted)">Tap to load storage info</div>
                        </div>
                    </div>
                    <button class="dash-section-link" onclick="loadStorageData()" style="margin-top:8px;display:block">Load Storage Info</button>
                </div>

                <!-- Review Queue Section (inline) -->
                <div class="settings-section" id="settingsReviewSection">
                    <div class="settings-section-title">Review Queue <span id="reviewCount" style="color:var(--accent-light)"></span></div>
                    <div class="settings-group">
                        <div style="padding:16px" id="reviewQueue">
                            <div id="reviewList"><div style="font-size:14px;color:var(--text-muted)">No cards to review</div></div>
                        </div>
                    </div>
                </div>

                <!-- App Section -->
                <div class="settings-section">
                    <div class="settings-section-title">App</div>
                    <div class="settings-group">
                        <div class="settings-item" onclick="checkForUpdates()">
                            <svg viewBox="0 0 24 24"><path d="M21 10.12h-6.78l2.74-2.82c-2.73-2.7-7.15-2.8-9.88-.1-2.73 2.71-2.73 7.08 0 9.79s7.15 2.71 9.88 0C18.32 15.65 19 14.08 19 12.1h2c0 1.98-.88 4.55-2.64 6.29-3.51 3.48-9.21 3.48-12.72 0-3.5-3.47-3.5-9.12 0-12.6 3.51-3.47 9.14-3.47 12.65 0L21 3v7.12z"/></svg>
                            <div class="settings-item-text"><strong style="color:#4ade80">Check for Updates</strong><small>Download and install latest version</small></div>
                        </div>
                        <div class="settings-item" onclick="refreshApp()">
                            <svg viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                            <div class="settings-item-text"><strong style="color:#f87171">Reset & Refresh App</strong><small>Clear cache and reload latest version</small></div>
                        </div>
                    </div>
                </div>

                <!-- Danger Zone -->
                <div class="settings-section">
                    <div class="settings-section-title">Danger Zone</div>
                    <div class="settings-group">
                        <div class="settings-item" onclick="logout()">
                            <svg viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
                            <div class="settings-item-text"><strong style="color:#f87171">Sign Out</strong><small id="userName">Sign out of your account</small></div>
                        </div>
                        <div class="settings-item" onclick="deleteAccount()">
                            <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" fill="#f87171"/></svg>
                            <div class="settings-item-text"><strong style="color:#f87171">Delete Account</strong><small>Permanently delete all data (cannot be undone)</small></div>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div><!-- /app-shell -->

    <!-- Bottom Tab Bar (mobile) -->
    <nav class="bottom-tabs" id="bottomTabs">
        <button class="tab-item active" onclick="navigateTo('dashboard')">
            <svg viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>
            <span>Home</span>
        </button>
        <button class="tab-item" onclick="navigateTo('cards')">
            <svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V6h16v12z"/></svg>
            <span>Cards</span>
        </button>
        <button class="tab-item" onclick="navigateTo('leads')">
            <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
            <span>Leads</span>
        </button>
        <button class="tab-item" onclick="navigateTo('analytics')">
            <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>
            <span>Analytics</span>
        </button>
        <button class="tab-item" onclick="navigateTo('settings')">
            <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58z"/></svg>
            <span>Settings</span>
        </button>
    </nav>

    <!-- Card Edit Modal (Comprehensive) -->
    <div class="card-edit-modal" id="cardEditModal" onclick="if(event.target===this)closeCardEdit()">
        <div class="card-edit-content card-edit-full">
            <div class="card-edit-header">
                <h3 id="cardEditTitle">Add Card</h3>
                <button class="card-edit-close" onclick="closeCardEdit()">&times;</button>
            </div>
            <div class="card-edit-tabs">
                <button class="card-tab active" onclick="showCardTab('basic')">Basic</button>
                <button class="card-tab" onclick="showCardTab('contact')">Contact</button>
                <button class="card-tab" onclick="showCardTab('social')">Social</button>
                <button class="card-tab" onclick="showCardTab('brand')">Branding</button>
                <button class="card-tab" onclick="showCardTab('products')">Products</button>
            </div>
            <div class="card-edit-body card-edit-scrollable">
                <input type="hidden" id="cardEditId">

                <!-- Basic Tab -->
                <div class="card-tab-content active" id="tab-basic">
                    <div class="card-edit-field">
                        <label>Your Name *</label>
                        <input type="text" id="cardName" placeholder="e.g. John Doe">
                    </div>
                    <div class="card-edit-row">
                        <div class="card-edit-field">
                            <label>Job Title *</label>
                            <input type="text" id="cardTitle" placeholder="e.g. CEO">
                        </div>
                        <div class="card-edit-field">
                            <label>Company *</label>
                            <input type="text" id="cardCompany" placeholder="e.g. Acme Inc.">
                        </div>
                    </div>
                    <div class="card-edit-field">
                        <label>Admin Subtitle</label>
                        <input type="text" id="cardEditSubtitle" placeholder="e.g. Director — Singapore (for admin display)">
                    </div>
                    <div class="card-edit-field">
                        <label>Bio / About</label>
                        <textarea id="cardBio" rows="3" placeholder="Brief description about you or your company..."></textarea>
                    </div>
                </div>

                <!-- Contact Tab -->
                <div class="card-tab-content" id="tab-contact">
                    <div class="card-edit-row">
                        <div class="card-edit-field">
                            <label>Phone *</label>
                            <input type="tel" id="cardPhone" placeholder="+91 9876543210">
                        </div>
                        <div class="card-edit-field">
                            <label>WhatsApp Number</label>
                            <input type="text" id="cardWhatsapp" placeholder="919876543210 (no +)">
                        </div>
                    </div>
                    <div class="card-edit-field">
                        <label>Email *</label>
                        <input type="email" id="cardEmail" placeholder="hello@example.com">
                    </div>
                    <div class="card-edit-field">
                        <label>Address</label>
                        <textarea id="cardAddress" rows="2" placeholder="Full address for display"></textarea>
                    </div>
                    <div class="card-edit-row">
                        <div class="card-edit-field">
                            <label>Website</label>
                            <input type="url" id="cardWebsite" placeholder="https://example.com">
                        </div>
                        <div class="card-edit-field">
                            <label>Website Display</label>
                            <input type="text" id="cardWebsiteDisplay" placeholder="example.com">
                        </div>
                    </div>
                </div>

                <!-- Social Tab -->
                <div class="card-tab-content" id="tab-social">
                    <div class="card-edit-field">
                        <label>LinkedIn URL</label>
                        <input type="url" id="cardLinkedin" placeholder="https://linkedin.com/in/yourprofile">
                    </div>
                    <div class="card-edit-field">
                        <label>Instagram URL</label>
                        <input type="url" id="cardInstagram" placeholder="https://instagram.com/yourhandle">
                    </div>
                    <div class="card-edit-field">
                        <label>Twitter / X URL</label>
                        <input type="url" id="cardTwitter" placeholder="https://twitter.com/yourhandle">
                    </div>
                    <div class="card-edit-field">
                        <label>Calendly URL</label>
                        <input type="url" id="cardCalendly" placeholder="https://calendly.com/yourlink">
                    </div>
                </div>

                <!-- Branding Tab -->
                <div class="card-tab-content" id="tab-brand">
                    <div class="card-edit-field">
                        <label>Brand Color</label>
                        <div class="color-picker-row" id="colorPicker">
                            <div class="color-picker-opt" data-color="#1B1464" style="background:#1B1464"></div>
                            <div class="color-picker-opt" data-color="#0E7490" style="background:#0E7490"></div>
                            <div class="color-picker-opt" data-color="#065F46" style="background:#065F46"></div>
                            <div class="color-picker-opt" data-color="#8B6914" style="background:#8B6914"></div>
                            <div class="color-picker-opt" data-color="#7C3AED" style="background:#7C3AED"></div>
                            <div class="color-picker-opt" data-color="#DC2626" style="background:#DC2626"></div>
                            <div class="color-picker-opt" data-color="#0891B2" style="background:#0891B2"></div>
                            <div class="color-picker-opt" data-color="#4F46E5" style="background:#4F46E5"></div>
                        </div>
                        <input type="color" id="cardCustomColor" style="margin-top:8px" onchange="selectedColor=this.value;updateColorPicker()">
                    </div>
                    <div class="card-edit-field">
                        <label>Logo URL</label>
                        <input type="url" id="cardLogo" placeholder="https://example.com/logo.png">
                        <small class="field-hint">Company logo shown on card avatar</small>
                    </div>
                    <div class="card-edit-field">
                        <label>Profile Photo URL</label>
                        <input type="url" id="cardPhoto" placeholder="https://example.com/photo.jpg">
                        <small class="field-hint">Your headshot (takes priority over logo)</small>
                    </div>
                </div>

                <!-- Products Tab -->
                <div class="card-tab-content" id="tab-products">
                    <div class="products-editor">
                        <div id="productsContainer"></div>
                        <button class="add-product-btn" onclick="addProductField()">
                            <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                            Add Product
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-edit-footer">
                <button class="card-edit-cancel" onclick="closeCardEdit()">Cancel</button>
                <button class="card-edit-save" onclick="saveCard()">Save Card</button>
            </div>
        </div>
    </div>

    <!-- Fullscreen QR -->
    <div class="qr-fullscreen" id="qrFullscreen" onclick="if(event.target===this)closeFullscreenQR()">
        <div class="qr-card-name" id="qrFullName"></div>
        <div class="qr-full-wrap">
            <canvas id="qrFullCanvas"></canvas>
        </div>
        <button class="qr-close" onclick="closeFullscreenQR()">Close</button>
    </div>

    <!-- Quick Send Modal -->
    <div class="qs-modal" id="qsModal" onclick="if(event.target===this)closeQuickSend()">
        <div class="qs-sheet">
            <h3>Quick Send</h3>
            <p class="qs-sub">Auto-send a card when someone taps — no picking needed</p>
            <div id="qsOptions"></div>
        </div>
    </div>

    <!-- Default Card Modal -->
    <div class="qs-modal" id="defaultModal" onclick="if(event.target===this)closeDefaultCard()">
        <div class="qs-sheet">
            <h3>Default Timeout Card</h3>
            <p class="qs-sub">Card shown to visitors if you don't respond in 45 seconds</p>
            <div id="defaultOptions"></div>
        </div>
    </div>

    <!-- Tag Modal -->
    <div class="tag-modal" id="tagModal" onclick="if(event.target===this)closeTagModal()">
        <div class="tag-sheet">
            <h3>Add Tags</h3>
            <div class="tag-options" id="tagOptions"></div>
            <div class="tag-custom">
                <input type="text" id="customTagInput" placeholder="Custom tag...">
                <button onclick="addCustomTag()">Add</button>
            </div>
            <button class="tag-done" onclick="saveTagsAndClose()">Done</button>
        </div>
    </div>

    <!-- Edit Lead Modal -->
    <div class="edit-modal" id="editModal" onclick="if(event.target===this)closeEditModal()">
        <div class="edit-modal-content">
            <div class="edit-modal-header">
                <h3>Edit Lead</h3>
                <button class="edit-modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="edit-modal-body">
                <input type="hidden" id="editLeadId">
                <div class="edit-field"><label>Name</label><input type="text" id="editName" placeholder="Full name"></div>
                <div class="edit-field"><label>Company</label><input type="text" id="editCompany" placeholder="Company name"></div>
                <div class="edit-field"><label>Phone</label><input type="tel" id="editPhone" placeholder="Phone number"></div>
                <div class="edit-field"><label>Email</label><input type="email" id="editEmail" placeholder="Email address"></div>
                <div class="edit-field"><label>Address</label><textarea id="editAddress" placeholder="Address (optional)" rows="2"></textarea></div>
            </div>
            <div class="edit-modal-footer">
                <button class="edit-cancel-btn" onclick="closeEditModal()">Cancel</button>
                <button class="edit-save-btn" onclick="saveEditedLead()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Import Contacts Modal -->
    <div class="import-modal" id="importModal">
        <div class="import-header">
            <button onclick="closeImportModal()">Cancel</button>
            <h3>Import Contacts</h3>
            <span class="import-count" id="importCount"></span>
            <button class="save-all-btn" onclick="saveAllImported()">Save All</button>
        </div>
        <div class="import-list" id="importList"></div>
    </div>

    <!-- Scan Modal -->
    <div class="scan-modal" id="scanModal">
        <div class="scan-header">
            <h3 id="scanTitle">Scan Contact</h3>
            <button class="scan-close" onclick="closeScanModal()">Cancel</button>
        </div>
        <div class="scan-options" id="scanOptions">
            <button class="scan-option" onclick="startQrScan()">
                <svg viewBox="0 0 24 24"><path d="M3 11h8V3H3v8zm2-6h4v4H5V5zm8-2v8h8V3h-8zm6 6h-4V5h4v4zM3 21h8v-8H3v8zm2-6h4v4H5v-4zm13-2h-2v2h2v-2zm-2 4h2v2h-2v-2zm2 2h2v2h-2v-2zm0-4h2v2h-2v-2zm2 2h2v2h-2v-2zm0-4h2v2h-2V9zm-4 8h2v2h-2v-2zm2 2h2v2h-2v-2z"/></svg>
                <div class="scan-option-title">QR Code</div>
                <div class="scan-option-desc">Scan their QR</div>
            </button>
            <button class="scan-option" onclick="startCardScan()">
                <svg viewBox="0 0 24 24"><path d="M21 3H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H3V5h18v14zM5 15h14v2H5zm0-4h14v2H5zm0-4h6v2H5z"/></svg>
                <div class="scan-option-title">Business Card</div>
                <div class="scan-option-desc">Photo + OCR</div>
            </button>
        </div>
        <div class="scan-camera" id="scanCamera" style="display:none">
            <video id="scanVideo" autoplay playsinline></video>
            <canvas id="scanCanvas"></canvas>
            <div class="scan-viewfinder" id="scanViewfinder"></div>
            <div class="scan-status" id="scanStatus">Point camera at QR code</div>
            <button class="scan-capture-btn" id="scanCaptureBtn" onclick="captureCard()" style="display:none">Capture</button>
        </div>
        <div class="scan-result" id="scanResult" style="display:none">
            <div class="scan-result-card">
                <div class="scan-result-title">Scanned Contact</div>
                <div class="scan-result-field"><label>Name</label><input type="text" id="scanName" placeholder="Full name"></div>
                <div class="scan-result-field"><label>Company</label><input type="text" id="scanCompany" placeholder="Company"></div>
                <div class="scan-result-field"><label>Phone</label><input type="tel" id="scanPhone" placeholder="Phone number"></div>
                <div class="scan-result-field"><label>Email</label><input type="email" id="scanEmail" placeholder="Email address"></div>
                <div class="scan-result-actions">
                    <button class="scan-retry-btn" onclick="retryScan()">Scan Again</button>
                    <button class="scan-save-btn" onclick="saveScannedContact()">Save to Leads</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Billing Panel -->
    <div class="settings-modal" id="billingPanel" onclick="if(event.target===this)hideBillingPanel()">
        <div class="settings-sheet">
            <div class="settings-title">Billing & Plan</div>
            <div style="padding:16px 0;text-align:center">
                <div style="font-size:14px;color:rgba(255,255,255,.5);margin-bottom:4px">Current Plan</div>
                <div id="billingCurrentPlan" style="font-size:24px;font-weight:700;color:#6366f1;text-transform:capitalize">Free</div>
                <div id="billingPlanStatus" style="font-size:13px;color:rgba(255,255,255,.5);margin-top:4px"></div>
            </div>
            <div id="billingUpgradeSection" style="display:flex;flex-direction:column;gap:8px;padding:0 0 16px">
                <button class="settings-item" onclick="startCheckout('pro','monthly')" style="border:1px solid rgba(99,102,241,.3);cursor:pointer;background:none">
                    <svg viewBox="0 0 24 24" fill="#6366f1"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>
                    <div class="settings-item-text">
                        <strong style="color:#6366f1">Upgrade to Pro</strong>
                        <small>$10/mo — 5 cards, unlimited leads, full analytics</small>
                    </div>
                </button>
                <button class="settings-item" onclick="startCheckout('business','monthly')" style="border:1px solid rgba(168,85,247,.3);cursor:pointer;background:none">
                    <svg viewBox="0 0 24 24" fill="#a855f7"><path d="M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-8v-2h2v-2h-2v-2h2v-2h-2V9h8v10zm-2-8h-2v2h2v-2zm0 4h-2v2h2v-2z"/></svg>
                    <div class="settings-item-text">
                        <strong style="color:#a855f7">Upgrade to Business</strong>
                        <small>$25/mo — Unlimited cards, teams, custom domain, API</small>
                    </div>
                </button>
            </div>
            <div id="billingManageSection" style="display:none">
                <button class="settings-item" onclick="openBillingPortal()" style="border:1px solid rgba(99,102,241,.3);cursor:pointer;background:none">
                    <svg viewBox="0 0 24 24" fill="#6366f1"><path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/></svg>
                    <div class="settings-item-text">
                        <strong style="color:#6366f1">Manage Billing</strong>
                        <small>Update payment method, view invoices, cancel</small>
                    </div>
                </button>
            </div>
            <button class="settings-close" onclick="hideBillingPanel()">Close</button>
        </div>
    </div>

    <!-- Upgrade Modal -->
    <div class="settings-modal" id="upgradeModal" onclick="if(event.target===this)hideUpgradeModal()">
        <div class="settings-sheet" style="max-height:90vh">
            <div style="text-align:center;margin-bottom:20px">
                <div style="width:56px;height:56px;border-radius:16px;background:linear-gradient(135deg,#6366f1,#8b5cf6);display:inline-flex;align-items:center;justify-content:center;margin-bottom:12px">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="#fff"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>
                </div>
                <h3 style="font-size:20px;font-weight:700;margin:0 0 4px">Upgrade Your Plan</h3>
                <p id="upgradeModalReason" style="font-size:14px;color:rgba(255,255,255,.5);margin:0"></p>
            </div>
            <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:16px">
                <div style="background:rgba(99,102,241,.08);border:1px solid rgba(99,102,241,.25);border-radius:14px;padding:16px;cursor:pointer" onclick="startCheckout('pro','monthly',event)">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                        <span style="font-size:16px;font-weight:700;color:#6366f1">Pro</span>
                        <span style="font-size:16px;font-weight:700;color:#fff">$10<span style="font-size:12px;font-weight:400;color:rgba(255,255,255,.5)">/mo</span></span>
                    </div>
                    <div style="display:flex;flex-direction:column;gap:4px;font-size:13px;color:rgba(255,255,255,.7)">
                        <span>5 digital cards</span>
                        <span>Unlimited leads</span>
                        <span>Full analytics & branding removal</span>
                    </div>
                    <div style="margin-top:12px;background:#6366f1;color:#fff;text-align:center;padding:10px;border-radius:10px;font-size:14px;font-weight:600">Start 14-Day Free Trial</div>
                </div>
                <div style="background:rgba(168,85,247,.08);border:1px solid rgba(168,85,247,.25);border-radius:14px;padding:16px;cursor:pointer" onclick="startCheckout('business','monthly',event)">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                        <span style="font-size:16px;font-weight:700;color:#a855f7">Business</span>
                        <span style="font-size:16px;font-weight:700;color:#fff">$25<span style="font-size:12px;font-weight:400;color:rgba(255,255,255,.5)">/mo</span></span>
                    </div>
                    <div style="display:flex;flex-direction:column;gap:4px;font-size:13px;color:rgba(255,255,255,.7)">
                        <span>Unlimited cards</span>
                        <span>Everything in Pro</span>
                        <span>Dedicated support & lead export</span>
                    </div>
                    <div style="margin-top:12px;background:#a855f7;color:#fff;text-align:center;padding:10px;border-radius:10px;font-size:14px;font-weight:600">Start 14-Day Free Trial</div>
                </div>
            </div>
            <p style="text-align:center;font-size:12px;color:rgba(255,255,255,.4);margin:0 0 12px">Join 500+ professionals using CardFlow to grow their network</p>
            <button class="settings-close" onclick="hideUpgradeModal()">Maybe Later</button>
        </div>
    </div>

</div><!-- /appContainer -->

<script>
// Database URL removed - now using Express API
var BASE_URL = 'https://card.cardflow.cloud';

// ═══ NAVIGATION ═══
var currentPage = 'dashboard';

function navigateTo(page) {
    currentPage = page;
    // Hide all pages
    document.querySelectorAll('.page').forEach(function(p) { p.classList.remove('active'); });
    // Deactivate all nav items
    document.querySelectorAll('.nav-item').forEach(function(n) { n.classList.remove('active'); });
    document.querySelectorAll('.tab-item').forEach(function(t) { t.classList.remove('active'); });

    // Show target page
    var target = document.getElementById('page-' + page);
    if (target) target.classList.add('active');

    // Activate matching nav/tab items
    var navItems = document.querySelectorAll('.nav-item');
    var tabItems = document.querySelectorAll('.tab-item');
    var pageMap = ['dashboard','cards','leads','analytics','settings'];
    var idx = pageMap.indexOf(page);
    if (idx >= 0) {
        if (navItems[idx]) navItems[idx].classList.add('active');
        if (tabItems[idx]) tabItems[idx].classList.add('active');
    }

    // Scroll main content to top
    var mc = document.getElementById('mainContent');
    if (mc) mc.scrollTop = 0;

    // Trigger page-specific loading
    if (page === 'dashboard') loadDashboard();
    else if (page === 'leads') loadLeadsPage();
    else if (page === 'analytics') {
        var ac = document.getElementById('analyticsContent');
        if (ac) ac.innerHTML = '<div class="leads-empty">Loading analytics...</div>';
        loadAnalyticsData();
    }
    else if (page === 'cards') renderCardsList();
    else if (page === 'settings') { updateNotifUI(); loadStorageData(); loadReviewItems(); }
}

// ═══ DASHBOARD ═══
function loadDashboard() {
    // Stats
    Promise.all([
        apiFetch('/leads').then(function(r){return r.json()}),
        apiFetch('/taps').then(function(r){return r.json()})
    ]).then(function(results) {
        var leads = results[0] || {};
        var taps = results[1] || {};
        var leadCount = 0;
        for (var k in leads) {
            if (leads[k] && (leads[k].name || leads[k].phone || leads[k].email)) leadCount++;
        }
        // Count today's taps
        var todayStr = new Date().toISOString().slice(0,10);
        var tapsToday = 0;
        for (var tk in taps) {
            if (taps[tk] && taps[tk].ts) {
                var tapDate = new Date(taps[tk].ts).toISOString().slice(0,10);
                if (tapDate === todayStr) tapsToday++;
            }
        }
        var el = document.getElementById('dashLeadCount');
        if (el) el.textContent = leadCount;
        var tt = document.getElementById('dashTapsToday');
        if (tt) tt.textContent = tapsToday;
        var cc = document.getElementById('dashCardCount');
        if (cc) cc.textContent = CARD_IDS.length;
        var pp = document.getElementById('dashPlan');
        if (pp) pp.textContent = (getUserPlan() || 'free').charAt(0).toUpperCase() + (getUserPlan() || 'free').slice(1);

        // Lead usage bar for free plan
        var usageBar = document.getElementById('leadUsageBar');
        if (usageBar && getUserPlan() === 'free') {
            usageBar.style.display = '';
            apiFetch('/leads/month-count').then(function(r){return r.json()}).then(function(data){
                var count = data.count || 0;
                var limit = 25;
                var pct = Math.min(100, Math.round((count / limit) * 100));
                var text = document.getElementById('leadUsageText');
                var fill = document.getElementById('leadUsageFill');
                var warn = document.getElementById('leadUsageWarning');
                if (text) text.textContent = count + ' / ' + limit;
                if (fill) fill.style.width = pct + '%';
                if (pct >= 100 && fill) fill.style.background = 'linear-gradient(90deg,#ef4444,#f97316)';
                else if (pct >= 80 && fill) fill.style.background = 'linear-gradient(90deg,#f59e0b,#f97316)';
                if (warn) {
                    if (pct >= 100) { warn.style.display = ''; warn.innerHTML = 'Limit reached. <a href="#" onclick="showUpgradeModal(\'You\\\'ve hit your 25 lead/month limit. Upgrade for unlimited leads.\');return false" style="color:#6366f1;font-weight:600;text-decoration:underline">Upgrade for unlimited leads</a>'; }
                    else if (pct >= 80) { warn.style.display = ''; warn.textContent = 'Almost at your monthly limit. Consider upgrading.'; }
                    else { warn.style.display = 'none'; }
                }
            }).catch(function(){});
        } else if (usageBar) {
            usageBar.style.display = 'none';
        }

        // Also update the old lead count stat
        var oldEl = document.getElementById('leadCount');
        if (oldEl) {
            var numEl = oldEl.querySelector('.stat-num');
            if (numEl) numEl.textContent = leadCount;
        }

        // Render recent activity
        renderRecentActivity(leads);
    }).catch(function() {});

    // Render card tiles
    renderDashCardTiles();

    // Show pro trial banner for free users
    maybeShowProBanner();
}

function renderDashCardTiles() {
    var container = document.getElementById('dashCardTiles');
    if (!container) return;
    if (CARD_IDS.length === 0) {
        container.innerHTML = '<div style="padding:24px;text-align:center;color:var(--text-muted)"><p>No cards yet.</p><button onclick="openCardEdit()" style="margin-top:8px;background:var(--accent);color:#fff;border:none;padding:10px 20px;border-radius:10px;font-size:14px;cursor:pointer">+ Create Card</button></div>';
        return;
    }
    var html = '';
    CARD_IDS.forEach(function(id) {
        var c = CARDS[id];
        html += '<div class="dash-card-tile" style="border-left-color:' + sanitizeColor(c.color) + '">';
        html += '<div class="dash-card-tile-info"><div class="dash-card-tile-name">' + escapeHtml(c.name) + '</div>';
        html += '<div class="dash-card-tile-sub">' + escapeHtml(c.subtitle || c.title + ' — ' + c.company) + '</div></div>';
        html += '<div class="dash-card-tile-actions">';
        html += '<button class="dash-tile-btn" onclick="openCardEdit(\'' + id + '\')" title="Edit"><svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a.996.996 0 0 0 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg></button>';
        html += '<button class="dash-tile-btn" onclick="previewCardById(\'' + id + '\')" title="Preview"><svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg></button>';
        html += '<button class="dash-tile-btn" onclick="shareCardById(\'' + id + '\')" title="Share"><svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/></svg></button>';
        html += '</div></div>';
    });
    container.innerHTML = html;
}

function renderRecentActivity(leads) {
    var container = document.getElementById('dashActivityFeed');
    if (!container) return;
    var items = [];
    for (var k in leads) {
        var l = leads[k];
        if (l && (l.name || l.phone || l.email)) {
            l._id = k;
            items.push(l);
        }
    }
    items.sort(function(a, b) { return (b.ts || 0) - (a.ts || 0); });
    items = items.slice(0, 8);

    if (items.length === 0) {
        container.innerHTML = '<div style="padding:24px;text-align:center;color:var(--text-muted);font-size:14px">No activity yet. Share your card to start capturing leads.</div>';
        return;
    }

    var html = '';
    items.forEach(function(l) {
        html += '<div class="activity-item">';
        html += '<div class="activity-dot"></div>';
        html += '<div class="activity-text">';
        html += '<div class="activity-name">' + escapeHtml(l.name || l.phone || l.email || 'Unknown') + '</div>';
        var detail = [];
        if (l.company) detail.push(escapeHtml(l.company));
        if (l.card && NAMES[l.card]) detail.push(escapeHtml(NAMES[l.card]));
        if (detail.length) html += '<div class="activity-detail">' + detail.join(' · ') + '</div>';
        html += '</div>';
        if (l.ts) html += '<div class="activity-time">' + timeAgo(l.ts) + '</div>';
        html += '</div>';
    });
    container.innerHTML = html;
}

function timeAgo(ts) {
    var now = Date.now();
    var diff = now - ts;
    if (diff < 60000) return 'just now';
    if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
    if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
    if (diff < 604800000) return Math.floor(diff / 86400000) + 'd ago';
    return new Date(ts).toLocaleDateString('en-IN', {day: 'numeric', month: 'short'});
}

function previewCardById(cardId) {
    if (!cardId || !CARDS[cardId]) return;
    if (!currentUserProfile || !currentUserProfile.username) {
        alert('Please complete your profile setup first.');
        return;
    }
    currentPreviewUrl = getCardUrl(cardId);
    document.getElementById('previewFrame').src = currentPreviewUrl;
    document.getElementById('previewModal').classList.add('show');
}

function shareCardById(cardId) {
    if (!cardId || !CARDS[cardId]) return;
    var url = getCardUrl(cardId);
    if (navigator.share) {
        navigator.share({ title: CARDS[cardId].name + ' — Digital Card', url: url }).catch(function() {});
    } else {
        navigator.clipboard.writeText(url).then(function() { alert('Link copied!'); });
    }
}

function loadLeadsPage() {
    document.getElementById('leads-list').innerHTML = '<div class="leads-empty">Loading...</div>';
    document.getElementById('leadSearch').value = '';
    activeFilter = 'all';
    document.querySelectorAll('.filter-chip').forEach(function(c) { c.classList.toggle('active', c.dataset.filter === 'all'); });
    // Reuse existing lead loading logic
    showLeadsData();
}

// ── Security helpers ──
function escapeHtml(str) {
    if (!str) return '';
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}
function sanitizeColor(c) {
    if (!c) return '';
    if (/^#[0-9a-fA-F]{3,8}$/.test(c)) return c;
    if (/^rgb\(\s*\d{1,3}\s*,\s*\d{1,3}\s*,\s*\d{1,3}\s*\)$/.test(c)) return c;
    return '#1B1464';
}

// ═══ CARDS - loaded dynamically from Firebase ═══
var CARDS = {};

// Plan limits
var PLAN_LIMITS = {
    free: { cards: 1, leadsPerMonth: 25 },
    pro: { cards: 5, leadsPerMonth: -1 },
    business: { cards: -1, leadsPerMonth: -1 }
};

function getUserPlan() {
    return (currentUserProfile && currentUserProfile.plan) || 'free';
}

function canAddCard() {
    var plan = getUserPlan();
    var limit = PLAN_LIMITS[plan] ? PLAN_LIMITS[plan].cards : 1;
    if (limit === -1) return true;
    return CARD_IDS.length < limit;
}
var CARD_IDS = Object.keys(CARDS);

// Legacy compatibility aliases
var NAMES = {}; var CARD_COLORS = {}; var TOKEN_BY_CARD = {}; var TOKENS = {};
CARD_IDS.forEach(function(id) {
    var c = CARDS[id];
    NAMES[id] = c.name;
    CARD_COLORS[id] = c.color;
    TOKEN_BY_CARD[id] = c.token;
    TOKENS[c.token] = id;
});

// Helper: Get card URL (path-based when username available)
function getCardUrl(cardId) {
    var c = CARDS[cardId];
    if (!c) return BASE_URL;
    if (currentUserProfile && currentUserProfile.username) {
        return BASE_URL + '/' + currentUserProfile.username + '/' + cardId;
    }
    return c.token ? BASE_URL + '?c=' + c.token : BASE_URL;
}

var PRESET_TAGS = ['Hot Lead','Follow Up','Customer','Partner','Event'];
var STATUS_OPTIONS = ['new','contacted','qualified','won','lost'];
var STATUS_LABELS = {new:'New',contacted:'Contacted',qualified:'Qualified',won:'Won',lost:'Lost'};

// Lead scoring weights
var SCORE_WEIGHTS = {
    save_contact: 5,
    whatsapp: 4,
    call: 4,
    email: 3,
    website: 3,
    linkedin: 2,
    instagram: 2,
    twitter: 2,
    calendly: 3,
    product_enquiry: 4,
    view: 1
};
var leadScores = {}; // {sessionId: {score: N, actions: [...]}}

// Follow-up message templates
var FOLLOWUP_TEMPLATES = {
    day1: "Hi {name}, great connecting with you! Just wanted to make sure you saved my contact. Let me know if you need anything.",
    day3: "Hi {name}, hope you're doing well! Following up from our recent meeting. Would love to continue the conversation.",
    day7: "Hi {name}, quick reminder - I'm here if you need any assistance. Feel free to reach out anytime!",
    custom: "Hi {name}, "
};

function getFollowupMessage(template, lead) {
    var name = lead.name ? lead.name.split(' ')[0] : 'there';
    var msg = FOLLOWUP_TEMPLATES[template] || FOLLOWUP_TEMPLATES.custom;
    return msg.replace('{name}', name);
}

function calculateLeadScore(actions) {
    var score = 0;
    var seen = {};
    actions.forEach(function(a) {
        var action = a.action || a;
        var weight = SCORE_WEIGHTS[action] || 1;
        if (!seen[action]) {
            score += weight;
            seen[action] = true;
        } else {
            score += Math.ceil(weight / 2); // Diminishing returns for repeat actions
        }
    });
    return score;
}

function getScoreLabel(score) {
    if (score >= 10) return {label: 'Hot', class: 'score-hot'};
    if (score >= 5) return {label: 'Warm', class: 'score-warm'};
    if (score >= 1) return {label: 'Cool', class: 'score-cool'};
    return {label: '', class: ''};
}

var currentSession = null;
var ready = false;
var lastSeenSession = localStorage.getItem('lastSeenSession') || null;
var allLeads = [];
var activeFilter = 'all';
var tagModalLeadId = null;
var tagModalTags = [];

// ═══ DYNAMIC CARD HTML GENERATION ═══
function initCardElements() {
    // Populate all card selects
    var selectHtml = '';
    CARD_IDS.forEach(function(id) {
        selectHtml += '<option value="'+id+'">'+CARDS[id].name+'</option>';
    });
    document.querySelectorAll('[data-card-select]').forEach(function(sel) {
        sel.innerHTML = selectHtml;
    });

    // Populate picker buttons
    var pickerHtml = '';
    CARD_IDS.forEach(function(id) {
        var c = CARDS[id];
        pickerHtml += '<button class="pick-btn" style="background:'+escapeHtml(c.gradient)+'" onclick="selectCard(\''+id+'\')">'+escapeHtml(c.name)+'<small>'+escapeHtml(c.subtitle)+'</small></button>';
    });
    var pickerEl = document.getElementById('pickerCards');
    if (pickerEl) pickerEl.innerHTML = pickerHtml;

    // Populate Quick Send options
    var qsHtml = '';
    CARD_IDS.forEach(function(id) {
        var c = CARDS[id];
        qsHtml += '<button class="qs-opt" data-card="'+id+'" onclick="setQuickSend(\''+id+'\')">'+escapeHtml(c.name)+'<small>'+escapeHtml(c.subtitle)+'</small></button>';
    });
    qsHtml += '<button class="qs-off" onclick="setQuickSend(\'\')">Turn off Quick Send</button>';
    var qsEl = document.getElementById('qsOptions');
    if (qsEl) qsEl.innerHTML = qsHtml;

    // Populate Default Card options
    var defaultHtml = '';
    CARD_IDS.forEach(function(id) {
        var c = CARDS[id];
        defaultHtml += '<button class="qs-opt" data-default="'+id+'" onclick="setDefaultCard(\''+id+'\')">'+escapeHtml(c.name)+'<small>'+escapeHtml(c.subtitle)+'</small></button>';
    });
    defaultHtml += '<button class="qs-off" onclick="setDefaultCard(\'\')">No default (visitor waits)</button>';
    var defaultEl = document.getElementById('defaultOptions');
    if (defaultEl) defaultEl.innerHTML = defaultHtml;

    // Populate card filter chips
    var filterHtml = '<span class="filter-label">Card:</span>';
    CARD_IDS.forEach(function(id) {
        var c = CARDS[id];
        filterHtml += '<button class="filter-chip card-chip" data-filter="card-'+id+'" onclick="setFilter(\'card-'+id+'\')" style="border-color:'+sanitizeColor(c.color)+'">'+escapeHtml(c.name.split(' ')[0])+'</button>';
    });
    var filterEl = document.getElementById('cardFilterBar');
    if (filterEl) filterEl.innerHTML = filterHtml;
}

// ═══ CARD MANAGEMENT ═══
var editingCardId = null;
var selectedColor = '#1B1464';

function generateToken() {
    var chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
    var token = '';
    for (var i = 0; i < 10; i++) token += chars[Math.floor(Math.random() * chars.length)];
    return token;
}

function darkenColor(hex) {
    var r = parseInt(hex.slice(1,3), 16);
    var g = parseInt(hex.slice(3,5), 16);
    var b = parseInt(hex.slice(5,7), 16);
    r = Math.floor(r * 0.6); g = Math.floor(g * 0.6); b = Math.floor(b * 0.6);
    return '#' + r.toString(16).padStart(2,'0') + g.toString(16).padStart(2,'0') + b.toString(16).padStart(2,'0');
}

function showCardsPanel() {
    navigateTo('cards');
}

function hideCardsPanel() {
    navigateTo('dashboard');
}

function renderCardsList() {
    var html = '';
    CARD_IDS.forEach(function(id) {
        var c = CARDS[id];
        html += '<div class="card-item" style="border-color:'+sanitizeColor(c.color)+'">';
        html += '<div class="card-item-color" style="background:'+escapeHtml(c.gradient)+'"></div>';
        html += '<div class="card-item-info"><div class="card-item-name">'+escapeHtml(c.name)+'</div><div class="card-item-sub">'+escapeHtml(c.subtitle)+'</div></div>';
        html += '<div class="card-item-actions">';
        html += '<button class="card-item-btn" onclick="openCardEdit(\''+id+'\')"><svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a.996.996 0 0 0 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg></button>';
        html += '<button class="card-item-btn delete-btn" onclick="deleteCard(\''+id+'\')"><svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button>';
        html += '</div></div>';
    });
    document.getElementById('cardsList').innerHTML = html || '<div class="leads-empty">No cards yet. Add your first card!</div>';
}

var editingProducts = [];

function showCardTab(tabName) {
    document.querySelectorAll('.card-tab').forEach(function(t){ t.classList.remove('active'); });
    document.querySelectorAll('.card-tab-content').forEach(function(c){ c.classList.remove('active'); });
    document.querySelector('.card-tab[onclick*="'+tabName+'"]').classList.add('active');
    document.getElementById('tab-'+tabName).classList.add('active');
}

function openCardEdit(cardId) {
    // Check plan limit for new cards
    if (!cardId && !canAddCard()) {
        var plan = getUserPlan();
        var limit = PLAN_LIMITS[plan] ? PLAN_LIMITS[plan].cards : 1;
        showUpgradeModal('Your ' + plan + ' plan allows ' + limit + ' card(s). Upgrade to create more.');
        return;
    }
    editingCardId = cardId || null;
    document.getElementById('cardEditTitle').textContent = cardId ? 'Edit Card' : 'Add Card';
    showCardTab('basic');

    if (cardId && CARDS[cardId]) {
        var c = CARDS[cardId];
        document.getElementById('cardEditId').value = cardId;
        // Basic
        document.getElementById('cardName').value = c.name || '';
        document.getElementById('cardTitle').value = c.title || '';
        document.getElementById('cardCompany').value = c.company || '';
        document.getElementById('cardEditSubtitle').value = c.subtitle || '';
        document.getElementById('cardBio').value = c.bio || '';
        // Contact
        document.getElementById('cardPhone').value = c.phone || '';
        document.getElementById('cardWhatsapp').value = c.whatsapp || '';
        document.getElementById('cardEmail').value = c.email || '';
        document.getElementById('cardAddress').value = c.address || '';
        document.getElementById('cardWebsite').value = c.website || '';
        document.getElementById('cardWebsiteDisplay').value = c.websiteDisplay || '';
        // Social
        document.getElementById('cardLinkedin').value = c.linkedin || '';
        document.getElementById('cardInstagram').value = c.instagram || '';
        document.getElementById('cardTwitter').value = c.twitter || '';
        document.getElementById('cardCalendly').value = c.calendly || '';
        // Brand
        selectedColor = c.color || c.color1 || '#1B1464';
        document.getElementById('cardCustomColor').value = selectedColor;
        document.getElementById('cardLogo').value = c.logo || '';
        document.getElementById('cardPhoto').value = c.photo || '';
        // Products
        editingProducts = c.products ? JSON.parse(JSON.stringify(c.products)) : [];
    } else {
        // Clear all fields for new card
        ['cardName','cardTitle','cardCompany','cardEditSubtitle','cardBio','cardPhone','cardWhatsapp',
         'cardEmail','cardAddress','cardWebsite','cardWebsiteDisplay','cardLinkedin','cardInstagram',
         'cardTwitter','cardCalendly','cardLogo','cardPhoto'].forEach(function(id){
            var el = document.getElementById(id);
            if (el) el.value = '';
        });
        document.getElementById('cardEditId').value = '';
        selectedColor = '#1B1464';
        document.getElementById('cardCustomColor').value = selectedColor;
        editingProducts = [];
    }

    updateColorPicker();
    renderProductsEditor();
    document.getElementById('cardEditModal').classList.add('show');
}

function closeCardEdit() {
    document.getElementById('cardEditModal').classList.remove('show');
    editingCardId = null;
    editingProducts = [];
}

function updateColorPicker() {
    document.querySelectorAll('.color-picker-opt').forEach(function(opt) {
        opt.classList.toggle('selected', opt.dataset.color === selectedColor);
        opt.onclick = function() {
            selectedColor = opt.dataset.color;
            document.getElementById('cardCustomColor').value = selectedColor;
            updateColorPicker();
        };
    });
}

function renderProductsEditor() {
    var html = '';
    editingProducts.forEach(function(p, i) {
        html += '<div class="product-item"><div class="product-item-header"><span class="product-item-title">Product '+(i+1)+'</span><button class="remove-product" onclick="removeProduct('+i+')">&times;</button></div>'+
            '<input type="text" placeholder="Product name" value="'+(p.name||'')+'" onchange="editingProducts['+i+'].name=this.value">'+
            '<input type="text" placeholder="Price (e.g. $100/unit)" value="'+(p.price||'')+'" onchange="editingProducts['+i+'].price=this.value">'+
            '<input type="text" placeholder="Image URL" value="'+(p.image||'')+'" onchange="editingProducts['+i+'].image=this.value">'+
            '</div>';
    });
    document.getElementById('productsContainer').innerHTML = html;
}

function addProductField() {
    editingProducts.push({name:'', price:'', image:''});
    renderProductsEditor();
}

function removeProduct(idx) {
    editingProducts.splice(idx, 1);
    renderProductsEditor();
}

function saveCard() {
    var name = document.getElementById('cardName').value.trim();
    var title = document.getElementById('cardTitle').value.trim();
    var company = document.getElementById('cardCompany').value.trim();
    var subtitle = document.getElementById('cardEditSubtitle').value.trim() || (title + ' — ' + company);

    if (!name) { alert('Please enter your name'); showCardTab('basic'); return; }
    if (!title) { alert('Please enter a job title'); showCardTab('basic'); return; }
    if (!company) { alert('Please enter a company name'); showCardTab('basic'); return; }

    // Plan limit check for new cards
    if (!editingCardId && !canAddCard()) {
        var plan = getUserPlan();
        var limit = PLAN_LIMITS[plan] ? PLAN_LIMITS[plan].cards : 1;
        showUpgradeModal('Your ' + plan + ' plan allows ' + limit + ' card(s). Upgrade to create more.');
        closeCardEdit();
        return;
    }

    var cardId = editingCardId || company.toLowerCase().replace(/[^a-z0-9]/g, '').substring(0, 15) + Date.now().toString(36).slice(-4);
    var token = (CARDS[cardId] && CARDS[cardId].token) || generateToken();
    var phone = document.getElementById('cardPhone').value.trim();
    var website = document.getElementById('cardWebsite').value.trim();
    var address = document.getElementById('cardAddress').value.trim();

    // Auto-generate derived fields
    var phoneDisplay = phone;
    var whatsapp = document.getElementById('cardWhatsapp').value.trim() || phone.replace(/[^0-9]/g,'');
    var websiteDisplay = document.getElementById('cardWebsiteDisplay').value.trim() || website.replace(/^https?:\/\//, '').replace(/\/$/, '');
    var addressQuery = address.replace(/\s+/g, '+').replace(/,/g, '');

    // Compute color variations
    var color1 = selectedColor;
    var color2 = darkenColor(selectedColor);
    var accent = selectedColor;
    var accentLight = lightenColor(selectedColor);

    var cardData = {
        name: name,
        title: title,
        company: company,
        subtitle: subtitle,
        color: selectedColor,
        color1: color1,
        color2: color2,
        accent: accent,
        accentLight: accentLight,
        gradient: 'linear-gradient(135deg,' + color1 + ',' + color2 + ')',
        token: token,
        phone: phone,
        phoneDisplay: phoneDisplay,
        whatsapp: whatsapp,
        email: document.getElementById('cardEmail').value.trim(),
        address: address,
        addressQuery: addressQuery,
        website: website,
        websiteDisplay: websiteDisplay,
        bio: document.getElementById('cardBio').value.trim(),
        logo: document.getElementById('cardLogo').value.trim(),
        photo: document.getElementById('cardPhoto').value.trim(),
        linkedin: document.getElementById('cardLinkedin').value.trim(),
        instagram: document.getElementById('cardInstagram').value.trim(),
        twitter: document.getElementById('cardTwitter').value.trim(),
        calendly: document.getElementById('cardCalendly').value.trim(),
        products: editingProducts.filter(function(p){ return p.name; }),
        vcardAdr: ';;'+address.replace(/,/g,'\\,')+';;;;'
    };

    // Save card
    apiFetch('/cards/' + cardId, {
        method: 'PUT',
        body: cardData
    }).then(function() {
        // Update local data
        CARDS[cardId] = cardData;
        if (CARD_IDS.indexOf(cardId) === -1) CARD_IDS.push(cardId);
        rebuildCardMaps();
        initCardElements();
        renderCardsList();
        closeCardEdit();
        generateQR();
        // Hide onboarding after first card is created
        var ob = document.getElementById('onboardingWelcome');
        if (ob) ob.style.display = 'none';
        var qs = document.getElementById('dashQuickShare');
        if (qs) qs.style.display = '';
        var cs = document.getElementById('dashCardsSection');
        if (cs) cs.style.display = '';
        var as = document.getElementById('dashActivitySection');
        if (as) as.style.display = '';
        loadDashboard();
    }).catch(function(err) {
        alert('Failed to save: ' + err.message);
    });
}

function lightenColor(hex) {
    var r = parseInt(hex.slice(1,3), 16);
    var g = parseInt(hex.slice(3,5), 16);
    var b = parseInt(hex.slice(5,7), 16);
    // Create a light tint
    r = Math.min(255, r + Math.floor((255 - r) * 0.85));
    g = Math.min(255, g + Math.floor((255 - g) * 0.85));
    b = Math.min(255, b + Math.floor((255 - b) * 0.85));
    return '#' + r.toString(16).padStart(2,'0') + g.toString(16).padStart(2,'0') + b.toString(16).padStart(2,'0');
}

function deleteCard(cardId) {
    if (!CARDS[cardId]) return;
    if (!confirm('Delete "' + CARDS[cardId].name + '"? This cannot be undone.')) return;

    apiFetch('/cards/' + cardId, { method: 'DELETE' }).then(function() {
        delete CARDS[cardId];
        CARD_IDS = CARD_IDS.filter(function(id) { return id !== cardId; });
        rebuildCardMaps();
        initCardElements();
        renderCardsList();
        generateQR();
        if (CARD_IDS.length === 0) showFirstCardPrompt();
    }).catch(function(err) {
        alert('Failed to delete: ' + err.message);
    });
}

function rebuildCardMaps() {
    NAMES = {}; CARD_COLORS = {}; TOKEN_BY_CARD = {}; TOKENS = {};
    CARD_IDS.forEach(function(id) {
        var c = CARDS[id];
        NAMES[id] = c.name;
        CARD_COLORS[id] = c.color;
        TOKEN_BY_CARD[id] = c.token;
        TOKENS[c.token] = id;
    });
}

function loadCardsFromFirebase() {
    apiFetch('/cards').then(function(r) { return r.json(); }).then(function(data) {
        if (data && typeof data === 'object' && Object.keys(data).length > 0) {
            // Load cards from Firebase
            var loadedCards = {};
            var loadedIds = [];
            for (var id in data) {
                if (data.hasOwnProperty(id)) {
                    var c = data[id];
                    if (c && typeof c === 'object' && c.name) {
                        // Ensure all required fields exist
                        if (!c.gradient && c.color) {
                            c.gradient = 'linear-gradient(135deg,' + c.color + ',' + darkenColor(c.color) + ')';
                        }
                        if (!c.token) c.token = generateToken();
                        if (!c.subtitle) c.subtitle = '';
                        loadedCards[id] = c;
                        loadedIds.push(id);
                    }
                }
            }
            if (loadedIds.length > 0) {
                CARDS = loadedCards;
                CARD_IDS = loadedIds;
                rebuildCardMaps();
                initCardElements();
                generateQR();
                console.log('Loaded ' + loadedIds.length + ' cards');
            } else {
                seedDefaultCards();
            }
        } else {
            // No cards in Firebase - seed with defaults
            seedDefaultCards();
        }
    }).catch(function(err) {
        // Use default cards if Firebase fails
        console.log('Error loading cards:', err);
        rebuildCardMaps();
        initCardElements();
        generateQR();
    });
}

function seedDefaultCards() {
    // New user — no cards yet. Show the create-card prompt.
    CARDS = {};
    CARD_IDS = [];
    rebuildCardMaps();
    initCardElements();
    showFirstCardPrompt();
    // Show onboarding on dashboard
    var ob = document.getElementById('onboardingWelcome');
    if (ob) ob.style.display = '';
    var qs = document.getElementById('dashQuickShare');
    if (qs) qs.style.display = 'none';
    var cs = document.getElementById('dashCardsSection');
    if (cs) cs.style.display = 'none';
    var as = document.getElementById('dashActivitySection');
    if (as) as.style.display = 'none';
}

function showFirstCardPrompt() {
    var cardsList = document.getElementById('cardsList');
    if (cardsList) {
        cardsList.innerHTML = '<div class="leads-empty" style="padding:32px;text-align:center">' +
            '<p style="font-size:18px;font-weight:600;margin-bottom:8px">Welcome! Create your first card</p>' +
            '<p style="color:rgba(255,255,255,.6);margin-bottom:16px">Set up your digital business card to start sharing and capturing leads.</p>' +
            '<button onclick="openCardEdit()" style="background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff;border:none;padding:12px 24px;border-radius:12px;font-size:15px;cursor:pointer;font-weight:600">+ Create Card</button>' +
            '</div>';
    }
    // Also show the cards panel automatically for first-time users
    var cardsPanel = document.getElementById('cardsPanel');
    if (cardsPanel && !cardsPanel.classList.contains('show')) {
        showCardsPanel();
    }
}

// Legacy migration removed (now using VPS/PostgreSQL)
function migrateData() { alert('Migration is handled server-side.'); }

// Migration no longer needed (already on VPS)
function checkMigrationNeeded() {}

// ── Billing / Stripe ──

function showBillingPanel() {
    var plan = getUserPlan();
    var planEl = document.getElementById('billingCurrentPlan');
    var statusEl = document.getElementById('billingPlanStatus');
    var upgradeEl = document.getElementById('billingUpgradeSection');
    var manageEl = document.getElementById('billingManageSection');

    if (planEl) planEl.textContent = plan.charAt(0).toUpperCase() + plan.slice(1);

    if (plan === 'free') {
        upgradeEl.style.display = '';
        manageEl.style.display = 'none';
        if (statusEl) statusEl.textContent = '1 card, 25 leads/month';
    } else {
        upgradeEl.style.display = 'none';
        manageEl.style.display = '';
        if (statusEl) {
            var limits = PLAN_LIMITS[plan] || {};
            var cardsText = limits.cards === -1 ? 'Unlimited' : limits.cards;
            var leadsText = limits.leadsPerMonth === -1 ? 'Unlimited' : limits.leadsPerMonth;
            statusEl.textContent = cardsText + ' cards, ' + leadsText + ' leads/month';
        }
    }

    // Update settings label too
    var label = document.getElementById('currentPlanLabel');
    if (label) label.textContent = plan.charAt(0).toUpperCase() + plan.slice(1) + ' plan';

    document.getElementById('billingPanel').classList.add('show');
}

function hideBillingPanel() {
    document.getElementById('billingPanel').classList.remove('show');
}

function showUpgradeModal(reason) {
    var el = document.getElementById('upgradeModalReason');
    if (el) el.textContent = reason || 'Unlock more features to grow your network.';
    document.getElementById('upgradeModal').classList.add('show');
}

function hideUpgradeModal() {
    document.getElementById('upgradeModal').classList.remove('show');
}

function dismissProBanner() {
    document.getElementById('proTrialBanner').style.display = 'none';
    localStorage.setItem('proTrialBannerDismissed', Date.now());
}

function maybeShowProBanner() {
    if (getUserPlan() !== 'free') return;
    var banner = document.getElementById('proTrialBanner');
    if (!banner) return;
    var dismissed = localStorage.getItem('proTrialBannerDismissed');
    // Show again after 7 days
    if (dismissed && (Date.now() - parseInt(dismissed, 10)) < 7 * 24 * 60 * 60 * 1000) return;
    banner.style.display = '';
}

function startCheckout(plan, interval, event) {
    var btn = event ? event.target.closest('.settings-item') : null;
    if (btn) btn.style.opacity = '0.5';

    apiFetch('/billing/create-checkout', {
        method: 'POST',
        body: { plan: plan, interval: interval }
    }).then(function(r) { return r.json(); }).then(function(data) {
        if (data.url) {
            window.location.href = data.url;
        }
    }).catch(function(err) {
        alert('Failed to start checkout: ' + err.message);
        if (btn) btn.style.opacity = '';
    });
}

function openBillingPortal() {
    apiFetch('/billing/create-portal', {
        method: 'POST',
        body: {}
    }).then(function(r) { return r.json(); }).then(function(data) {
        if (data.url) {
            window.location.href = data.url;
        }
    }).catch(function(err) {
        alert('Failed to open billing portal: ' + err.message);
    });
}

// Check for billing success/cancel URL params
(function() {
    var params = new URLSearchParams(window.location.search);
    var billing = params.get('billing');
    if (billing === 'success') {
        // Reload profile to get updated plan
        setTimeout(function() {
            apiFetch('/auth/me').then(function(r) { return r.json(); }).then(function(profile) {
                if (profile) {
                    currentUserProfile = profile;
                    var label = document.getElementById('currentPlanLabel');
                    if (label) label.textContent = (profile.plan || 'free').charAt(0).toUpperCase() + (profile.plan || 'free').slice(1) + ' plan';
                }
            });
        }, 2000);
        // Clean URL
        window.history.replaceState({}, '', 'admin.html');
    } else if (billing === 'cancelled') {
        window.history.replaceState({}, '', 'admin.html');
    }
})();

// ── Account Deletion (GDPR) ──
function deleteAccount() {
    if (!currentUser) return;
    if (!confirm('Are you sure you want to delete your account? ALL your cards, leads, analytics, and settings will be permanently deleted. This cannot be undone.')) return;
    if (!confirm('This is your FINAL warning. Type "DELETE" in the next prompt to confirm.')) return;
    var confirmation = prompt('Type DELETE to permanently remove your account:');
    if (confirmation !== 'DELETE') { alert('Account deletion cancelled.'); return; }

    // Delete account via API (CASCADE handles all related data)
    apiFetch('/auth/account', { method: 'DELETE' }).then(function(r) {
        if (!r.ok) throw new Error('Failed to delete');
        localStorage.clear();
        alert('Your account has been deleted.');
        window.location.href = 'landing.html';
    }).catch(function(err) {
        alert('Failed to delete account: ' + err.message);
    });
}

function show(id) {
    if (id === 'idle') {
        // Just hide picker/sent overlays, dashboard is always the base
        document.querySelectorAll('.screen').forEach(function(s){ s.classList.add('hidden'); });
        return;
    }

    document.querySelectorAll('.screen').forEach(function(s){ s.classList.add('hidden'); });
    var el = document.getElementById(id);
    if (el) el.classList.remove('hidden');

    // Animate picker buttons with stagger
    if (id === 'picker') {
        var btns = document.querySelectorAll('.pick-btn');
        btns.forEach(function(btn, i) {
            btn.classList.remove('animate-in');
            btn.style.animationDelay = (i * 0.08) + 's';
            setTimeout(function(){ btn.classList.add('animate-in'); }, 10);
        });
    }

    // Reset sent screen animations
    if (id === 'sent') {
        var progress = document.getElementById('returnProgress');
        var text = document.getElementById('returnText');
        if (progress) progress.style.display = 'block';
        if (text) text.style.display = 'block';
    }
}

// ── Wake Lock ──
var wakeLock = null;
function requestWakeLock() {
    if (!('wakeLock' in navigator)) return;
    navigator.wakeLock.request('screen').then(function(wl){ wakeLock = wl; }).catch(function(){});
}
document.addEventListener('visibilitychange', function(){
    if (document.visibilityState === 'visible') requestWakeLock();
});
requestWakeLock();

// ── Notifications (iOS-compatible) ──
function isIOSDevice() {
    return /iPhone|iPad|iPod/.test(navigator.userAgent);
}
function isRunningAsPWA() {
    return (window.matchMedia('(display-mode: standalone)').matches) ||
           (window.navigator.standalone === true);
}

function debugNotifications() {
    var info = [];
    info.push('=== DEBUG v13 ===');
    info.push('iOS: ' + isIOSDevice());
    info.push('PWA: ' + isRunningAsPWA());
    info.push('standalone: ' + window.navigator.standalone);
    info.push('Notification exists: ' + ('Notification' in window));
    if ('Notification' in window) {
        info.push('Permission: ' + Notification.permission);
    }
    info.push('SW support: ' + ('serviceWorker' in navigator));
    info.push('Push support: ' + ('PushManager' in window));
    info.push('Protocol: ' + location.protocol);
    info.push('Host: ' + location.host);

    var msg = info.join('\n');
    alert(msg);

    // Try to force request permission with user gesture
    if ('Notification' in window && Notification.permission === 'default') {
        alert('Requesting permission NOW...');
        Notification.requestPermission().then(function(p) {
            alert('Permission result: ' + p);
        }).catch(function(e) {
            alert('Permission error: ' + e);
        });
    }
}

function forceResetAndRequest() {
    // Direct permission request with user gesture
    if (!('Notification' in window)) {
        alert('Notification API not available on this device');
        return;
    }

    alert('Current permission: ' + Notification.permission + '\n\nTapping OK will request permission...');

    try {
        Notification.requestPermission().then(function(permission) {
            alert('Result: ' + permission);
            updateNotifUI(permission);
            if (permission === 'granted') {
                new Notification('It works!', {body: 'Notifications are now enabled'});
            }
        }).catch(function(err) {
            alert('Error: ' + err.message);
        });
    } catch(e) {
        alert('Exception: ' + e.message);
    }
}

function requestNotif() {
    // iOS requires PWA mode for notifications
    if (isIOSDevice() && !isRunningAsPWA()) {
        alert('iPhone Notifications Require Installation\n\nTo receive notifications:\n1. Tap the Share button (box with arrow)\n2. Tap "Add to Home Screen"\n3. Open the app from your Home Screen\n4. Then tap this button again');
        return;
    }

    if (!('Notification' in window)) {
        alert('Notifications not supported on this device.\n\nMake sure you\'re using iOS 16.4 or later.');
        return;
    }

    // If already denied, show instructions
    if (Notification.permission === 'denied') {
        var msg = 'Notifications are blocked.\n\n';
        if (isIOSDevice()) {
            msg += 'To fix on iPhone:\n\n';
            msg += '1. Open the Settings app\n';
            msg += '2. Tap Notifications\n';
            msg += '3. Scroll down to find "Cards"\n';
            msg += '4. Enable "Allow Notifications"\n\n';
            msg += 'If not found there, try:\n';
            msg += 'Settings → Apps → Cards → Notifications\n\n';
            msg += 'Or: Delete this app, clear Safari data, and re-install.';
        } else if (/Android/.test(navigator.userAgent)) {
            msg += '1. Tap the lock icon in the URL bar\n2. Tap "Site settings"\n3. Set Notifications to "Allow"';
        } else {
            msg += '1. Click the lock icon in the URL bar\n2. Find "Notifications"\n3. Change to "Allow"';
        }
        alert(msg);
        return;
    }

    // Request permission
    Notification.requestPermission().then(function(permission) {
        updateNotifUI(permission);
        if (permission === 'granted') {
            // Send a test notification + register push subscription
            sendTestNotification();
            subscribeToPush();
        }
    }).catch(function(err) {
        console.log('Notification permission error:', err);
        alert('Could not request notification permission. Error: ' + err.message);
    });
}

function sendTestNotification() {
    if (navigator.serviceWorker && navigator.serviceWorker.controller) {
        navigator.serviceWorker.ready.then(function(reg) {
            reg.showNotification('Notifications Enabled!', {
                body: 'You will now receive alerts when someone taps your card',
                icon: 'icon-192.png',
                badge: 'icon-192.png',
                tag: 'test-notif',
                vibrate: [100, 50, 100]
            });
        });
    } else {
        new Notification('Notifications Enabled!', {
            body: 'You will now receive alerts when someone taps your card',
            icon: 'icon-192.png',
            tag: 'test-notif'
        });
    }
}

function subscribeToPush() {
    if (!navigator.serviceWorker) return;
    fetch('/api/public/vapid-key').then(function(r) { return r.json(); }).then(function(data) {
        if (!data.publicKey) return;
        // Convert base64url to Uint8Array
        var padding = '='.repeat((4 - data.publicKey.length % 4) % 4);
        var base64 = (data.publicKey + padding).replace(/-/g, '+').replace(/_/g, '/');
        var raw = atob(base64);
        var key = new Uint8Array(raw.length);
        for (var i = 0; i < raw.length; i++) key[i] = raw.charCodeAt(i);

        navigator.serviceWorker.ready.then(function(reg) {
            return reg.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: key
            });
        }).then(function(subscription) {
            // Save subscription to server
            apiFetch('/settings', {
                method: 'PATCH',
                body: { push_subscription: subscription.toJSON() }
            }).catch(function(err) { console.error('Failed to save push subscription:', err); });
        }).catch(function(err) {
            console.log('Push subscription failed:', err.message);
        });
    }).catch(function(err) {
        console.log('VAPID key fetch failed:', err.message);
    });
}

function updateNotifUI(permission) {
    var perm = permission || (('Notification' in window) ? Notification.permission : 'default');
    var icon = document.getElementById('notifBtn');
    var dot = document.getElementById('notifDot');
    var settingsLabel = document.getElementById('settingsNotifLabel');

    if (!icon || !dot) return;

    // Special case: iOS not running as PWA
    if (isIOSDevice() && !isRunningAsPWA()) {
        icon.className = 'status-icon';
        dot.className = 'status-dot off';
        if (settingsLabel) settingsLabel.textContent = 'Install App First';
        return;
    }

    // Notification API not available
    if (!('Notification' in window)) {
        icon.className = 'status-icon';
        dot.className = 'status-dot';
        if (settingsLabel) settingsLabel.textContent = 'Not Supported';
        return;
    }

    if (perm === 'granted') {
        icon.className = 'status-icon notif-on';
        dot.className = 'status-dot on';
        if (settingsLabel) settingsLabel.textContent = 'Notifications On';
    } else if (perm === 'denied') {
        icon.className = 'status-icon';
        dot.className = 'status-dot off';
        if (settingsLabel) settingsLabel.textContent = 'Notifications Blocked';
    } else {
        icon.className = 'status-icon';
        dot.className = 'status-dot';
        if (settingsLabel) settingsLabel.textContent = 'Enable Notifications';
    }
}

function updateStatusBadges() {
    var el = document.getElementById('statusBadges');
    if (!el) return;

    var parts = [];
    var qs = getQuickSend();
    if (qs && CARDS[qs]) parts.push('Quick: ' + CARDS[qs].name.split(' ')[0]);
    if (currentDefaultCard && CARDS[currentDefaultCard]) parts.push('Fallback: ' + CARDS[currentDefaultCard].name.split(' ')[0]);

    el.textContent = parts.length ? parts.join(' · ') : 'NFC + QR ready';
}

function showSettings() {
    navigateTo('settings');
}
function hideSettings() {
    navigateTo('dashboard');
}

function checkForUpdates() {
    hideSettings();
    showUpdateToast('Checking for updates...');
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistration().then(function(reg) {
            if (reg) {
                reg.update().then(function() {
                    // Check if there's a waiting worker
                    if (reg.waiting) {
                        showUpdateToast('Installing update...');
                        reg.waiting.postMessage({type: 'SKIP_WAITING'});
                    } else if (reg.installing) {
                        showUpdateToast('Update found, installing...');
                    } else {
                        showUpdateToast('Already up to date!');
                        setTimeout(function(){ hideUpdateToast(); }, 2000);
                    }
                });
            } else {
                showUpdateToast('No service worker found');
                setTimeout(function(){ hideUpdateToast(); }, 2000);
            }
        });
    } else {
        location.reload(true);
    }
}

function hideUpdateToast() {
    var toast = document.querySelector('.update-toast');
    if (toast) toast.remove();
}

function refreshApp() {
    if (!confirm('This will clear all cached data and reload the app. Continue?')) return;

    // Clear caches
    if ('caches' in window) {
        caches.keys().then(function(names) {
            names.forEach(function(name) {
                caches.delete(name);
            });
        });
    }

    // Unregister service worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(function(registrations) {
            registrations.forEach(function(reg) {
                reg.unregister();
            });
        });
    }

    // Clear localStorage (except important settings)
    var token = localStorage.getItem('token');
    var user = localStorage.getItem('user');
    var quickSend = localStorage.getItem('quickSendCard');
    localStorage.clear();
    if (token) localStorage.setItem('token', token);
    if (user) localStorage.setItem('user', user);
    if (quickSend) localStorage.setItem('quickSendCard', quickSend);

    // Reload
    setTimeout(function() {
        location.reload(true);
    }, 500);
}

function showDebugMenu() {
    var info = [];
    info.push('=== DEBUG v16 ===');
    info.push('iOS: ' + isIOSDevice());
    info.push('PWA: ' + isRunningAsPWA());
    info.push('Notif: ' + (('Notification' in window) ? Notification.permission : 'N/A'));
    info.push('SW: ' + ('serviceWorker' in navigator));
    info.push('Push: ' + ('PushManager' in window));

    var action = confirm(info.join('\n') + '\n\nTap OK to force request permission');
    if (action) {
        forceResetAndRequest();
    }
}

function notify(title, body) {
    if (!('Notification' in window) || Notification.permission !== 'granted') return;
    if (navigator.serviceWorker && navigator.serviceWorker.controller) {
        navigator.serviceWorker.ready.then(function(reg) {
            reg.showNotification(title || 'Someone tapped your card!', {
                body: body || 'Tap to select which card to share',
                vibrate: [100,50,100,50,200],
                tag: 'nfc-tap',
                requireInteraction: true,
                renotify: true
            });
        });
    } else {
        var n = new Notification(title, {body:body,tag:'nfc-tap',requireInteraction:true});
        n.onclick = function(){ window.focus(); n.close(); };
    }
}

function buzz() {
    if (navigator.vibrate) navigator.vibrate([100,50,100,50,200]);
    try {
        var ctx = new (window.AudioContext||window.webkitAudioContext)();
        var o = ctx.createOscillator(), g = ctx.createGain();
        o.connect(g); g.connect(ctx.destination);
        o.frequency.value = 880; o.type = 'sine'; g.gain.value = 0.3;
        o.start(); g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.3);
        o.stop(ctx.currentTime+0.3);
    } catch(e){}
}

// ── Tap Stats ──
function loadStats() {
    apiFetch('/leads').then(function(r){return r.json()}).then(function(data) {
        var count = 0;
        if (data) {
            for (var k in data) {
                var l = data[k];
                // Only count leads with actual contact info
                if (l && (l.name || l.phone || l.email)) count++;
            }
        }
        var el = document.getElementById('leadCount');
        if (el) el.querySelector('.stat-num').textContent = count;
    }).catch(function(){});
}

// Note: initCardElements, loadStats, loadCardsFromFirebase called from initApp() after auth

// ── QR Code Generation ──
function drawQR(canvas, url, size, darkColor) {
    if (typeof qrcode === 'undefined') return false;
    try {
        var qr = qrcode(0, 'M');
        qr.addData(url);
        qr.make();
        var ctx = canvas.getContext('2d');
        var moduleCount = qr.getModuleCount();
        var cellSize = Math.floor(size / moduleCount);
        var offset = Math.floor((size - cellSize * moduleCount) / 2);
        canvas.width = size;
        canvas.height = size;
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, size, size);
        ctx.fillStyle = darkColor || '#1B1464';
        for (var row = 0; row < moduleCount; row++) {
            for (var col = 0; col < moduleCount; col++) {
                if (qr.isDark(row, col)) {
                    ctx.fillRect(offset + col * cellSize, offset + row * cellSize, cellSize, cellSize);
                }
            }
        }
        return true;
    } catch(e) {
        console.log('QR Error:', e);
        return false;
    }
}

function generateQR() {
    if (typeof qrcode === 'undefined') { setTimeout(generateQR, 200); return; }
    var cardId = document.getElementById('qrCardSelect').value;
    var card = CARDS[cardId];
    if (!card) return;
    drawQR(document.getElementById('qrCanvas'), getCardUrl(cardId), 180, card.color);
}

function showFullscreenQR() {
    var cardId = document.getElementById('qrCardSelect').value;
    var card = CARDS[cardId];
    if (!card) return;
    document.getElementById('qrFullName').textContent = card.name;
    drawQR(document.getElementById('qrFullCanvas'), getCardUrl(cardId), 280, card.color);
    document.getElementById('qrFullscreen').classList.add('show');
}

function closeFullscreenQR() {
    document.getElementById('qrFullscreen').classList.remove('show');
}

function copyCardLink() {
    var cardId = document.getElementById('qrCardSelect').value;
    navigator.clipboard.writeText(getCardUrl(cardId)).then(function(){
        var btn = document.getElementById('copyLinkBtn');
        btn.classList.add('copied');
        btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>Copied!';
        setTimeout(function(){
            btn.classList.remove('copied');
            btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>Copy Link';
        },2000);
    });
}

function shareCardLink() {
    var cardId = document.getElementById('qrCardSelect').value;
    if (navigator.share) {
        navigator.share({title:CARDS[cardId].name+' — Digital Card',url:getCardUrl(cardId)}).catch(function(){});
    } else {
        copyCardLink();
    }
}

var currentPreviewUrl = '';
function previewCard() {
    var cardId = document.getElementById('qrCardSelect').value;
    if (!cardId || !CARDS[cardId]) return;
    if (!currentUserProfile || !currentUserProfile.username) {
        alert('Please complete your profile setup first.');
        return;
    }
    currentPreviewUrl = getCardUrl(cardId);
    document.getElementById('previewFrame').src = currentPreviewUrl;
    document.getElementById('previewModal').classList.add('show');
}
function closePreview() {
    var modal = document.getElementById('previewModal');
    var frame = document.getElementById('previewFrame');
    modal.classList.remove('show');
    setTimeout(function(){ frame.src = ''; }, 300);
}
function openInNewTab() {
    if (currentPreviewUrl) window.open(currentPreviewUrl, '_blank');
    closePreview();
}

// Note: generateQR called from initApp() after auth

// ── Quick Send ──
function getQuickSend() { return localStorage.getItem('quickSendCard') || ''; }
function updateQsBadge() {
    var qs = getQuickSend();
    var btn = document.getElementById('qsBtn');
    var label = document.getElementById('qsLabel');
    if (btn && qs && NAMES[qs]) {
        btn.classList.add('active');
        if (label) label.textContent = 'Quick: ON';
    } else if (btn) {
        btn.classList.remove('active');
        if (label) label.textContent = 'Quick Send';
    }
    document.querySelectorAll('.qs-opt').forEach(function(o){
        o.classList.toggle('selected', o.dataset.card === qs);
    });
    updateStatusBadges();
}
function openQuickSend() { document.getElementById('qsModal').classList.add('show'); updateQsBadge(); }
function closeQuickSend() { document.getElementById('qsModal').classList.remove('show'); }
function setQuickSend(card) {
    if (card) localStorage.setItem('quickSendCard', card);
    else localStorage.removeItem('quickSendCard');
    updateQsBadge();
    closeQuickSend();
}
// Note: updateQsBadge called from initApp() after auth

// ── Default Card (for timeout) ──
var currentDefaultCard = '';
function loadDefaultCard() {
    apiFetch('/settings').then(function(r){return r.json()}).then(function(s){ return s && s.defaultCard; }).then(function(card) {
        currentDefaultCard = card || '';
        updateDefaultBadge();
    }).catch(function(){});
}
function updateDefaultBadge() {
    var btn = document.getElementById('defaultBtn');
    var label = document.getElementById('defaultLabel');
    if (btn && currentDefaultCard && NAMES[currentDefaultCard]) {
        btn.classList.add('active');
        if (label) label.textContent = 'Default: ON';
    } else if (btn) {
        btn.classList.remove('active');
        if (label) label.textContent = 'Default';
    }
    document.querySelectorAll('[data-default]').forEach(function(o){
        o.classList.toggle('selected', o.dataset.default === currentDefaultCard);
    });
    updateStatusBadges();
}
function openDefaultCard() { document.getElementById('defaultModal').classList.add('show'); updateDefaultBadge(); }
function closeDefaultCard() { document.getElementById('defaultModal').classList.remove('show'); }
function setDefaultCard(card) {
    currentDefaultCard = card;
    apiFetch('/settings',{method:'PATCH',body:{defaultCard:card || null}});
    updateDefaultBadge();
    closeDefaultCard();
}
// Note: loadDefaultCard called from initApp() after auth

// ── Listen for taps ──
var es = null;
function startListeningForTaps() {
    if (!currentUser || !authToken) return;
    if (es) es.close();
    es = new EventSource('/api/sse/taps?token=' + authToken);
    es.onmessage = function(e) {
        try { handleTapEvent({ data: e.data }); } catch(err) {}
    };
}
function handleTapEvent(e) {
    var val = JSON.parse(e.data);
    if (!val || !val.sessionId) return;

    // Skip initial load on first connect
    if (!ready) { ready = true; return; }

    // Skip if we've already seen this session (prevents duplicate notifications on reconnect/refresh)
    if (val.sessionId === lastSeenSession) return;

    // Check if this tap is recent (within last 30 seconds) to avoid old data on reconnect
    if (val.ts && typeof val.ts === 'number') {
        var age = Date.now() - val.ts;
        if (age > 30000) return; // Ignore taps older than 30 seconds
    }

    // New session - save it
    lastSeenSession = val.sessionId;
    localStorage.setItem('lastSeenSession', val.sessionId);

    currentSession = val.sessionId;
    var vi = val.visitor;
    document.getElementById('visitor-info').textContent = vi ? (vi.device+' · '+vi.browser) : '';
    buzz();

    var qs = getQuickSend();
    if (qs && NAMES[qs]) {
        notify('Card auto-sent!', NAMES[qs]+' shared via Quick Send');
        selectCard(qs, true);
        return;
    }

    notify('Someone tapped your card!','Tap to select which card to share');
    show('picker');
}

// ── Select card ──
var leadReceived = false;
var returnTimer = null;

function goBackNow() {
    if (returnTimer) clearTimeout(returnTimer);
    show('idle');
    loadStats();
}

function selectCard(cardId, auto) {
    if (!currentSession) return;
    apiFetch('/taps/'+currentSession,{method:'PATCH',body:{card:cardId,status:'selected'}});
    apiFetch('/leads/'+currentSession,{method:'PATCH',body:{card:cardId}});

    document.getElementById('sent-detail').textContent = NAMES[cardId]+' card shared';
    document.getElementById('sent-auto').textContent = auto ? '(Quick Send)' : '';
    document.getElementById('lead-display').innerHTML = '';
    leadReceived = false;
    show('sent');
    loadStats();

    // Reset progress bar animation
    var progress = document.getElementById('returnProgress');
    var progressBar = progress ? progress.querySelector('.return-progress-bar') : null;
    if (progressBar) {
        progressBar.style.animation = 'none';
        progressBar.offsetHeight; // Force reflow
        progressBar.style.animation = 'returnProgress 1.5s linear forwards';
    }

    // Auto return unless lead received
    if (returnTimer) clearTimeout(returnTimer);
    returnTimer = setTimeout(function(){
        if (!leadReceived) { show('idle'); loadStats(); }
    }, 1500);

    var sid = currentSession;
    var leadES = new EventSource('/api/sse/lead/'+sid+'?token='+authToken);
    leadES.onmessage = function(ev) { handleLead(ev); };
    setTimeout(function(){ if(leadES) leadES.close(); },60000);
    function handleLead(ev) {
        var lead = JSON.parse(ev.data);
        if (!lead) return;
        if (typeof lead === 'string') return;
        if (!lead.name && !lead.phone && !lead.email) return;
        leadES.close();
        leadReceived = true;
        clearTimeout(returnTimer);
        buzz();
        notify('Lead received!', lead.name + (lead.company?' — '+lead.company:''));
        document.getElementById('sent-auto').textContent = 'Lead saved!';
        // Hide progress bar when lead received
        var progress = document.getElementById('returnProgress');
        var returnText = document.getElementById('returnText');
        if (progress) progress.style.display = 'none';
        if (returnText) returnText.style.display = 'none';

        var html = '<div class="lead-card"><div class="lc-label">Lead received</div>';
        if (lead.name) html += '<div class="lc-name">'+escapeHtml(lead.name)+'</div>';
        if (lead.company) html += '<div class="lc-company">'+escapeHtml(lead.company)+'</div>';
        html += '<div class="lc-contact">';
        if (lead.phone) html += '<div><a href="tel:'+escapeHtml(lead.phone)+'">'+escapeHtml(lead.phone)+'</a></div>';
        if (lead.email) html += '<div><a href="mailto:'+escapeHtml(lead.email)+'">'+escapeHtml(lead.email)+'</a></div>';
        html += '</div>';
        if (lead.photo) html += '<img src="'+escapeHtml(lead.photo)+'">';
        html += '<div class="lead-actions"><button class="save-lead-btn" onclick="saveLead(\''+esc(lead.name||'')+'\',\''+esc(lead.phone||'')+'\',\''+esc(lead.email||'')+'\',\''+esc(lead.company||'')+'\')"><svg viewBox="0 0 24 24"><path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2v9.67z"/></svg>Save to Contacts</button></div>';
        html += '</div>';
        document.getElementById('lead-display').innerHTML = html;
    }
}

function skipCard() {
    if (!currentSession) { show('idle'); return; }
    apiFetch('/taps/'+currentSession,{method:'PATCH',body:{status:'skipped'}});
    currentSession = null;
    show('idle');
    loadStats();
}

// ── Leads Dashboard ──
var sortByScore = false;

function showLeads() {
    navigateTo('leads');
}

function showLeadsData() {
    // Fetch both leads and analytics
    Promise.all([
        apiFetch('/leads').then(function(r){return r.json()}),
        apiFetch('/analytics').then(function(r){return r.json()})
    ]).then(function(results) {
        var data = results[0];
        var analytics = results[1] || {};

        // Aggregate analytics by session ID
        leadScores = {};
        for (var cardId in analytics) {
            var cardAnalytics = analytics[cardId];
            if (cardAnalytics && cardAnalytics.clicks) {
                for (var clickId in cardAnalytics.clicks) {
                    var click = cardAnalytics.clicks[clickId];
                    if (click && click.sid) {
                        if (!leadScores[click.sid]) leadScores[click.sid] = {score: 0, actions: []};
                        leadScores[click.sid].actions.push(click);
                    }
                }
            }
            if (cardAnalytics && cardAnalytics.views) {
                for (var viewId in cardAnalytics.views) {
                    var view = cardAnalytics.views[viewId];
                    if (view && view.sid) {
                        if (!leadScores[view.sid]) leadScores[view.sid] = {score: 0, actions: []};
                        leadScores[view.sid].actions.push({action: 'view', ts: view.ts});
                    }
                }
            }
        }
        // Calculate scores
        for (var sid in leadScores) {
            leadScores[sid].score = calculateLeadScore(leadScores[sid].actions);
        }

        if (!data) { allLeads=[]; renderLeads([]); return; }

        var items = [];
        for (var k in data) {
            var l = data[k];
            if (!l || (!l.name && !l.phone && !l.email)) continue;
            l._id = k;
            if (!l.status) l.status = 'new';
            if (!l.tags) l.tags = [];
            if (typeof l.tags === 'string') l.tags = [l.tags];
            // Attach score
            l.score = leadScores[k] ? leadScores[k].score : 0;
            l.actions = leadScores[k] ? leadScores[k].actions : [];
            items.push(l);
        }

        if (sortByScore) {
            items.sort(function(a,b){ return (b.score||0)-(a.score||0); });
        } else {
            items.sort(function(a,b){ return (b.ts||0)-(a.ts||0); });
        }
        allLeads = items;
        renderLeads(items);
        checkReminders();
    }).catch(function(){
        document.getElementById('leads-list').innerHTML = '<div class="leads-empty">Failed to load</div>';
    });
}

function toggleScoreSort() {
    sortByScore = !sortByScore;
    var btn = document.getElementById('scoreSortBtn');
    if (btn) btn.classList.toggle('active', sortByScore);
    if (sortByScore) {
        allLeads.sort(function(a,b){ return (b.score||0)-(a.score||0); });
    } else {
        allLeads.sort(function(a,b){ return (b.ts||0)-(a.ts||0); });
    }
    renderLeads(filterLeadsData());
}

function renderLeads(items) {
    var list = document.getElementById('leads-list');
    document.getElementById('leads-count').textContent = items.length+' total';
    if (items.length === 0) { list.innerHTML = '<div class="leads-empty">No leads yet</div>'; return; }

    var html = '';
    items.forEach(function(l) {
        var statusClass = 'status-'+(l.status||'new');
        var statusLabel = STATUS_LABELS[l.status||'new'] || 'New';
        var scoreInfo = getScoreLabel(l.score || 0);

        html += '<div class="lead-item" data-id="'+escapeHtml(l._id)+'"><div class="li-top"><div>';
        if (l.name) html += '<div class="li-name">'+escapeHtml(l.name)+'</div>';
        if (l.company) html += '<div class="li-company">'+escapeHtml(l.company)+'</div>';
        html += '</div><div style="display:flex;gap:6px;align-items:center">';
        if (scoreInfo.label) html += '<span class="score-badge '+scoreInfo.class+'">'+escapeHtml(scoreInfo.label)+'</span>';
        if (l.card && NAMES[l.card]) html += '<span class="li-card-badge">'+escapeHtml(NAMES[l.card])+'</span>';
        html += '<button class="status-badge '+statusClass+'" onclick="cycleStatus(\''+l._id+'\')">'+statusLabel+'</button>';
        html += '</div></div>';

        html += '<div class="li-contact">';
        if (l.phone) html += '<div>'+escapeHtml(l.phone)+'</div>';
        if (l.email) html += '<div>'+escapeHtml(l.email)+'</div>';
        html += '</div>';
        if (l.address) html += '<div class="li-address">'+escapeHtml(l.address)+'</div>';

        // Quick action buttons
        if (l.phone || l.email) {
            html += '<div class="li-quick-actions">';
            if (l.phone) {
                html += '<a href="tel:'+escapeHtml(l.phone)+'" class="li-quick-btn call-btn"><svg viewBox="0 0 24 24"><path d="M6.62 10.79a15.05 15.05 0 0 0 6.59 6.59l2.2-2.2a1 1 0 0 1 1.01-.24c1.12.37 2.33.57 3.58.57a1 1 0 0 1 1 1V20a1 1 0 0 1-1 1A17 17 0 0 1 3 4a1 1 0 0 1 1-1h3.5a1 1 0 0 1 1 1c0 1.25.2 2.46.57 3.58a1 1 0 0 1-.24 1.01l-2.2 2.2z"/></svg>Call</a>';
                var waNum = l.phone.replace(/[^0-9]/g,'');
                if (waNum.length === 10) waNum = '91'+waNum;
                var waMsg = encodeURIComponent('Hi'+(l.name?' '+l.name.split(' ')[0]:'')+', ');
                html += '<a href="https://wa.me/'+waNum+'?text='+waMsg+'" target="_blank" class="li-quick-btn wa-btn"><svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51l-.57-.01c-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347zM12.05 21.785h-.01a9.87 9.87 0 0 1-5.031-1.378l-.361-.214-3.741.981.998-3.648-.235-.374A9.86 9.86 0 0 1 2.15 12.01C2.15 6.558 6.558 2.15 12.05 2.15c2.634 0 5.122 1.03 6.988 2.898a9.825 9.825 0 0 1 2.893 6.994c-.003 5.45-4.437 9.884-9.88 9.884v-.14z"/></svg>WhatsApp</a>';
            }
            if (l.email) html += '<a href="mailto:'+escapeHtml(l.email)+'" class="li-quick-btn email-btn"><svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>Email</a>';
            html += '</div>';
        }

        if (l.ts) {
            var d = new Date(l.ts);
            html += '<div class="li-time">'+d.toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'})+' '+d.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'});
            if (l.source) html += '<span class="li-source">'+escapeHtml(l.source)+'</span>';
            html += '</div>';
        }

        // Show visitor actions
        if (l.actions && l.actions.length > 0) {
            var actionCounts = {};
            l.actions.forEach(function(a) {
                var action = a.action || 'view';
                actionCounts[action] = (actionCounts[action] || 0) + 1;
            });
            html += '<div class="lead-actions-row">';
            var actionLabels = {call:'Called',whatsapp:'WhatsApp',email:'Emailed',save_contact:'Saved Contact',website:'Website',linkedin:'LinkedIn',instagram:'Instagram',twitter:'Twitter',view:'Viewed'};
            for (var action in actionCounts) {
                var label = actionLabels[action] || action;
                var count = actionCounts[action];
                html += '<span class="action-chip">'+label+(count > 1 ? ' ×'+count : '')+'</span>';
            }
            html += '</div>';
        }

        html += '<div class="tag-row">';
        if (l.tags && l.tags.length) {
            l.tags.forEach(function(t){
                html += '<span class="tag-chip" onclick="removeTag(\''+l._id+'\',\''+esc(t)+'\')">'+escapeHtml(t)+' &times;</span>';
            });
        }
        html += '<button class="add-tag-btn" onclick="openTagModal(\''+l._id+'\')">+ Tag</button></div>';

        html += '<div class="lead-note"><textarea placeholder="Add notes..." onblur="saveNote(\''+l._id+'\',this)" rows="1">'+escapeHtml(l.notes||'')+'</textarea><div class="lead-note-saved" id="note-saved-'+l._id+'">Saved</div></div>';

        html += '<div class="lead-reminder">';
        if (l.reminder && l.reminder.date && !l.reminder.done) {
            var isOverdue = new Date(l.reminder.date) < new Date().setHours(0,0,0,0);
            html += '<span class="remind-set'+(isOverdue?' reminder-overdue':'')+'">Reminder: '+l.reminder.date+(isOverdue?' (Overdue)':'')+'</span>';
            if (l.phone) {
                html += '<select class="template-select" id="tpl-'+l._id+'"><option value="day1">Day 1</option><option value="day3">Day 3</option><option value="day7">Day 7</option><option value="custom">Custom</option></select>';
                html += '<button class="followup-send" onclick="sendFollowup(\''+l._id+'\')"><svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51l-.57-.01c-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/></svg>Send</button>';
            }
            html += '<button class="remind-btn" onclick="dismissReminder(\''+l._id+'\')">Done</button>';
        } else {
            html += '<input type="date" id="remind-date-'+l._id+'">';
            html += '<button class="remind-btn" onclick="setReminder(\''+l._id+'\')">Remind me</button>';
        }
        html += '</div>';

        if (l.photo) html += '<img class="li-photo" src="'+escapeHtml(l.photo)+'">';

        html += '<div class="lead-actions">';
        html += '<button class="edit-lead-btn" onclick="openEditModal(\''+l._id+'\')"><svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a.996.996 0 0 0 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>Edit</button>';
        html += '<button class="save-lead-btn" onclick="saveLead(\''+esc(l.name||'')+'\',\''+esc(l.phone||'')+'\',\''+esc(l.email||'')+'\',\''+esc(l.company||'')+'\')"><svg viewBox="0 0 24 24"><path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2v9.67z"/></svg>Save</button>';
        html += '<button class="del-lead-btn" onclick="deleteLead(\''+l._id+'\')"><svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>Delete</button>';
        html += '</div></div>';
    });
    list.innerHTML = html;
}

function filterLeads() {
    renderLeads(filterLeadsData());
}

function filterLeadsData() {
    var q = document.getElementById('leadSearch').value.toLowerCase().trim();
    var filtered = allLeads;

    if (activeFilter !== 'all') {
        if (activeFilter === 'score-hot') {
            filtered = filtered.filter(function(l){ return (l.score||0) >= 10; });
        } else if (activeFilter === 'score-warm') {
            filtered = filtered.filter(function(l){ return (l.score||0) >= 5 && (l.score||0) < 10; });
        } else if (activeFilter.indexOf('status-') === 0) {
            var st = activeFilter.replace('status-','');
            filtered = filtered.filter(function(l){ return (l.status||'new') === st; });
        } else if (activeFilter.indexOf('tag-') === 0) {
            var tag = activeFilter.replace('tag-','');
            filtered = filtered.filter(function(l){ return l.tags && l.tags.indexOf(tag) !== -1; });
        } else if (activeFilter.indexOf('card-') === 0) {
            var card = activeFilter.replace('card-','');
            filtered = filtered.filter(function(l){ return l.card === card; });
        }
    }

    if (q) {
        filtered = filtered.filter(function(l){
            return (l.name||'').toLowerCase().indexOf(q)!==-1 ||
                   (l.company||'').toLowerCase().indexOf(q)!==-1 ||
                   (l.phone||'').indexOf(q)!==-1 ||
                   (l.email||'').toLowerCase().indexOf(q)!==-1 ||
                   (l.notes||'').toLowerCase().indexOf(q)!==-1;
        });
    }
    return filtered;
}

function setFilter(f) {
    activeFilter = f;
    document.querySelectorAll('.filter-chip').forEach(function(c){ c.classList.toggle('active', c.dataset.filter === f); });
    filterLeads();
}

function cycleStatus(id) {
    var lead = allLeads.find(function(l){ return l._id === id; });
    if (!lead) return;
    var idx = STATUS_OPTIONS.indexOf(lead.status||'new');
    var next = STATUS_OPTIONS[(idx+1) % STATUS_OPTIONS.length];
    lead.status = next;
    apiFetch('/leads/'+id,{method:'PATCH',body:{status:next}});
    filterLeads();
}

function saveNote(id, textarea) {
    var note = textarea.value.trim();
    var lead = allLeads.find(function(l){ return l._id === id; });
    if (lead) lead.notes = note;
    apiFetch('/leads/'+id,{method:'PATCH',body:{notes:note}});
    var saved = document.getElementById('note-saved-'+id);
    if (saved) { saved.style.display = 'block'; setTimeout(function(){ saved.style.display = 'none'; },1500); }
}

function openTagModal(id) {
    tagModalLeadId = id;
    var lead = allLeads.find(function(l){ return l._id === id; });
    tagModalTags = lead && lead.tags ? lead.tags.slice() : [];

    var html = '';
    PRESET_TAGS.forEach(function(t){
        var sel = tagModalTags.indexOf(t) !== -1 ? ' selected' : '';
        html += '<button class="tag-option'+sel+'" onclick="toggleTagOption(this,\''+esc(t)+'\')">'+escapeHtml(t)+'</button>';
    });
    document.getElementById('tagOptions').innerHTML = html;
    document.getElementById('customTagInput').value = '';
    document.getElementById('tagModal').classList.add('show');
}
function closeTagModal() { document.getElementById('tagModal').classList.remove('show'); }

function toggleTagOption(btn, tag) {
    var idx = tagModalTags.indexOf(tag);
    if (idx !== -1) { tagModalTags.splice(idx,1); btn.classList.remove('selected'); }
    else { tagModalTags.push(tag); btn.classList.add('selected'); }
}

function addCustomTag() {
    var input = document.getElementById('customTagInput');
    var tag = input.value.trim();
    if (!tag || tagModalTags.indexOf(tag) !== -1) return;
    tagModalTags.push(tag);
    input.value = '';
    var opts = document.getElementById('tagOptions');
    opts.innerHTML += '<button class="tag-option selected" onclick="toggleTagOption(this,\''+esc(tag)+'\')">'+escapeHtml(tag)+'</button>';
}

function saveTagsAndClose() {
    if (!tagModalLeadId) return;
    var lead = allLeads.find(function(l){ return l._id === tagModalLeadId; });
    if (lead) lead.tags = tagModalTags.slice();
    apiFetch('/leads/'+tagModalLeadId,{method:'PATCH',body:{tags:tagModalTags}});
    closeTagModal();
    filterLeads();
}

function removeTag(id, tag) {
    var lead = allLeads.find(function(l){ return l._id === id; });
    if (!lead || !lead.tags) return;
    var idx = lead.tags.indexOf(tag);
    if (idx !== -1) lead.tags.splice(idx,1);
    apiFetch('/leads/'+id,{method:'PATCH',body:{tags:lead.tags}});
    filterLeads();
}

function setReminder(id) {
    var input = document.getElementById('remind-date-'+id);
    if (!input || !input.value) return;
    var reminder = {date:input.value, done:false};
    var lead = allLeads.find(function(l){ return l._id === id; });
    if (lead) lead.reminder = reminder;
    apiFetch('/leads/'+id,{method:'PATCH',body:{reminder:reminder}});
    filterLeads();
}

function dismissReminder(id) {
    var lead = allLeads.find(function(l){ return l._id === id; });
    if (lead && lead.reminder) lead.reminder.done = true;
    apiFetch('/leads/'+id,{method:'PATCH',body:{reminder:{date:lead.reminder.date,done:true}}});
    filterLeads();
    checkReminders();
}

function sendFollowup(id) {
    var lead = allLeads.find(function(l){ return l._id === id; });
    if (!lead || !lead.phone) return;
    var tplSelect = document.getElementById('tpl-'+id);
    var template = tplSelect ? tplSelect.value : 'day1';
    var msg = getFollowupMessage(template, lead);
    var phone = lead.phone.replace(/[^0-9]/g,'');
    if (phone.length === 10) phone = '91'+phone;
    window.open('https://wa.me/'+phone+'?text='+encodeURIComponent(msg), '_blank');
    // Mark as followed up
    apiFetch('/leads/'+id,{method:'PATCH',body:{lastFollowup:{ts:Date.now(),template:template}}});
}

function checkReminders() {
    var today = new Date().toISOString().slice(0,10);
    var overdue = allLeads.filter(function(l){
        return l.reminder && l.reminder.date && !l.reminder.done && l.reminder.date <= today;
    });
    var banner = document.getElementById('reminderBanner');
    if (overdue.length === 0) { banner.classList.remove('show'); banner.innerHTML = ''; return; }

    var html = '<div class="reminder-banner-title">Overdue Reminders ('+overdue.length+')</div>';
    overdue.forEach(function(l){
        html += '<div class="reminder-item"><span>'+(l.name||'Unknown')+' — '+l.reminder.date+'</span><button class="reminder-dismiss" onclick="dismissReminder(\''+l._id+'\')">Dismiss</button></div>';
    });
    banner.innerHTML = html;
    banner.classList.add('show');

    if ('Notification' in window && Notification.permission === 'granted' && overdue.length > 0) {
        notify('Follow-up Reminder', overdue.length+' lead(s) need follow-up today');
    }
}

setInterval(function(){
    if (allLeads.length > 0) checkReminders();
}, 60000);

function deleteLead(id) {
    if (!confirm('Delete this lead?')) return;
    apiFetch('/leads/'+id,{method:'DELETE'}).then(function(){
        var el = document.querySelector('.lead-item[data-id="'+id+'"]');
        if (el) { el.style.opacity='0'; setTimeout(function(){el.remove()},200); }
        allLeads = allLeads.filter(function(l){ return l._id !== id; });
        document.getElementById('leads-count').textContent = allLeads.length+' total';
        if (allLeads.length === 0) document.getElementById('leads-list').innerHTML = '<div class="leads-empty">No leads yet</div>';
        loadStats();
    });
}

// ── Edit Lead ──
function openEditModal(id) {
    var lead = allLeads.find(function(l){ return l._id === id; });
    if (!lead) return;
    document.getElementById('editLeadId').value = id;
    document.getElementById('editName').value = lead.name || '';
    document.getElementById('editCompany').value = lead.company || '';
    document.getElementById('editPhone').value = lead.phone || '';
    document.getElementById('editEmail').value = lead.email || '';
    document.getElementById('editAddress').value = lead.address || '';
    document.getElementById('editModal').classList.add('show');
}

function closeEditModal() {
    document.getElementById('editModal').classList.remove('show');
}

function saveEditedLead() {
    var id = document.getElementById('editLeadId').value;
    var updates = {
        name: document.getElementById('editName').value.trim(),
        company: document.getElementById('editCompany').value.trim(),
        phone: document.getElementById('editPhone').value.trim(),
        email: document.getElementById('editEmail').value.trim(),
        address: document.getElementById('editAddress').value.trim()
    };

    apiFetch('/leads/'+id,{method:'PATCH',body:updates}).then(function(){
        // Update local data
        var lead = allLeads.find(function(l){ return l._id === id; });
        if (lead) {
            lead.name = updates.name;
            lead.company = updates.company;
            lead.phone = updates.phone;
            lead.email = updates.email;
            lead.address = updates.address;
        }
        closeEditModal();
        filterLeads(); // Re-render
    });
}

function exportCSV() {
    if (!allLeads.length) { alert('No leads to export'); return; }
    var rows = [['Name','Phone','Email','Company','Card','Status','Score','Tags','Notes','Actions','Source','Date']];
    allLeads.forEach(function(l){
        var date = l.ts ? new Date(l.ts).toISOString() : '';
        var actions = (l.actions||[]).map(function(a){return a.action||'view'}).join(', ');
        rows.push([
            '"'+(l.name||'').replace(/"/g,'""')+'"',
            '"'+(l.phone||'')+'"',
            '"'+(l.email||'')+'"',
            '"'+(l.company||'').replace(/"/g,'""')+'"',
            '"'+(NAMES[l.card]||l.card||'')+'"',
            '"'+(STATUS_LABELS[l.status]||'New')+'"',
            (l.score||0),
            '"'+((l.tags||[]).join(', ')).replace(/"/g,'""')+'"',
            '"'+(l.notes||'').replace(/"/g,'""')+'"',
            '"'+actions+'"',
            '"'+(l.source||'nfc')+'"',
            '"'+date+'"'
        ]);
    });
    var csv = rows.map(function(r){return r.join(',')}).join('\n');
    var blob = new Blob([csv],{type:'text/csv;charset=utf-8'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url; a.download = 'leads_'+new Date().toISOString().slice(0,10)+'.csv';
    document.body.appendChild(a); a.click();
    setTimeout(function(){ document.body.removeChild(a); URL.revokeObjectURL(url); },100);
}

// ── Import Contacts ──
var importedContacts = [];

function startImport() {
    // Try Contact Picker API first (Android Chrome)
    if ('contacts' in navigator && 'ContactsManager' in window) {
        navigator.contacts.select(
            ['name', 'email', 'tel', 'address', 'organization'],
            {multiple: true}
        ).then(function(contacts) {
            if (!contacts || contacts.length === 0) return;
            importedContacts = contacts.map(function(c) {
                return {
                    name: c.name && c.name[0] ? c.name[0] : '',
                    phone: c.tel && c.tel[0] ? c.tel[0] : '',
                    email: c.email && c.email[0] ? c.email[0] : '',
                    company: c.organization && c.organization[0] ? c.organization[0] : '',
                    address: c.address && c.address[0] ? formatAddress(c.address[0]) : '',
                    card: CARD_IDS[0] || ''
                };
            });
            renderImportList();
            document.getElementById('importModal').classList.add('show');
        }).catch(function(err) {
            console.log('Contact picker error:', err);
            document.getElementById('importVcf').click();
        });
    } else {
        // Fallback to VCF file picker
        document.getElementById('importVcf').click();
    }
}

function formatAddress(addr) {
    if (typeof addr === 'string') return addr;
    var parts = [];
    if (addr.streetAddress) parts.push(addr.streetAddress);
    if (addr.locality) parts.push(addr.locality);
    if (addr.region) parts.push(addr.region);
    if (addr.postalCode) parts.push(addr.postalCode);
    if (addr.country) parts.push(addr.country);
    return parts.join(', ');
}

function importFromVcf(input) {
    if (!input.files || !input.files[0]) return;
    var file = input.files[0];
    var reader = new FileReader();
    reader.onload = function(e) {
        var vcf = e.target.result;
        importedContacts = parseVCF(vcf);
        if (importedContacts.length === 0) {
            alert('No contacts found in file');
            return;
        }
        renderImportList();
        document.getElementById('importModal').classList.add('show');
    };
    reader.readAsText(file);
    input.value = '';
}

function parseVCF(vcf) {
    var contacts = [];
    var cards = vcf.split('BEGIN:VCARD');
    cards.forEach(function(card) {
        if (!card.trim()) return;
        var contact = {name:'',phone:'',email:'',company:'',address:'',card:CARD_IDS[0]||''};

        // Name
        var fnMatch = card.match(/FN[;:]([^\r\n]+)/i);
        if (fnMatch) contact.name = fnMatch[1].replace(/^[^:]*:/,'').trim();
        if (!contact.name) {
            var nMatch = card.match(/\nN[;:]([^\r\n]+)/i);
            if (nMatch) {
                var parts = nMatch[1].replace(/^[^:]*:/,'').split(';');
                contact.name = ((parts[1]||'')+' '+(parts[0]||'')).trim();
            }
        }

        // Phone
        var telMatch = card.match(/TEL[;:][^\r\n]*?(\+?[\d\s\-()]+)/i);
        if (telMatch) contact.phone = telMatch[1].replace(/[\s\-()]/g,'').trim();

        // Email
        var emailMatch = card.match(/EMAIL[;:]([^\r\n]+)/i);
        if (emailMatch) contact.email = emailMatch[1].replace(/^[^:]*:/,'').trim();

        // Company
        var orgMatch = card.match(/ORG[;:]([^\r\n]+)/i);
        if (orgMatch) contact.company = orgMatch[1].replace(/^[^:]*:/,'').split(';')[0].trim();

        // Address
        var adrMatch = card.match(/ADR[;:]([^\r\n]+)/i);
        if (adrMatch) {
            var adrParts = adrMatch[1].replace(/^[^:]*:/,'').split(';').filter(function(p){return p.trim()});
            contact.address = adrParts.join(', ').trim();
        }

        if (contact.name || contact.phone || contact.email) {
            contacts.push(contact);
        }
    });
    return contacts;
}

function renderImportList() {
    var html = '';
    importedContacts.forEach(function(c, i) {
        html += '<div class="import-item" data-index="'+i+'">';
        html += '<div class="import-item-header"><span class="import-item-name">'+(c.name||'Contact '+(i+1))+'</span>';
        html += '<button class="import-item-remove" onclick="removeImportItem('+i+')">Remove</button></div>';
        html += '<div class="import-field"><label>Name</label><input type="text" value="'+esc(c.name)+'" onchange="updateImportField('+i+',\'name\',this.value)"></div>';
        html += '<div class="import-field"><label>Phone</label><input type="tel" value="'+esc(c.phone)+'" onchange="updateImportField('+i+',\'phone\',this.value)"></div>';
        html += '<div class="import-field"><label>Email</label><input type="email" value="'+esc(c.email)+'" onchange="updateImportField('+i+',\'email\',this.value)"></div>';
        html += '<div class="import-field"><label>Company</label><input type="text" value="'+esc(c.company)+'" onchange="updateImportField('+i+',\'company\',this.value)"></div>';
        html += '<div class="import-field"><label>Address</label><input type="text" value="'+esc(c.address)+'" onchange="updateImportField('+i+',\'address\',this.value)"></div>';
        html += '<div class="import-field"><label>Assign to Card</label><select class="import-card-select" onchange="updateImportField('+i+',\'card\',this.value)">';
        CARD_IDS.forEach(function(cid) {
            html += '<option value="'+cid+'"'+(c.card===cid?' selected':'')+'>'+CARDS[cid].name+'</option>';
        });
        html += '</select></div></div>';
    });
    document.getElementById('importList').innerHTML = html;
    document.getElementById('importCount').textContent = importedContacts.length + ' contacts';
}

function updateImportField(index, field, value) {
    if (importedContacts[index]) {
        importedContacts[index][field] = value;
        if (field === 'name') {
            document.querySelector('.import-item[data-index="'+index+'"] .import-item-name').textContent = value || 'Contact '+(index+1);
        }
    }
}

function removeImportItem(index) {
    importedContacts.splice(index, 1);
    renderImportList();
    if (importedContacts.length === 0) closeImportModal();
}

function closeImportModal() {
    document.getElementById('importModal').classList.remove('show');
    importedContacts = [];
}

function saveAllImported() {
    if (importedContacts.length === 0) return;
    var saved = 0;
    var validContacts = importedContacts.filter(function(c) {
        return c.name || c.phone || c.email;
    });
    var total = validContacts.length;
    if (total === 0) { closeImportModal(); return; }

    validContacts.forEach(function(c) {
        var id = Date.now().toString(36) + Math.random().toString(36).substr(2,5);
        var lead = {
            name: c.name,
            phone: c.phone,
            email: c.email,
            company: c.company,
            address: c.address,
            card: c.card,
            status: 'new',
            tags: [],
            source: 'import',
            ts: Date.now()
        };
        apiFetch('/leads/'+id,{method:'PUT',body:lead}).then(function(){
            saved++;
            if (saved === total) {
                closeImportModal();
                showLeads(); // Refresh leads list
            }
        });
    });
}

function hideLeads() {
    navigateTo('dashboard');
}

// ── Analytics Dashboard ──
function showAnalytics() {
    navigateTo('analytics');
}

function hideAnalytics() {
    navigateTo('dashboard');
}

function loadAnalyticsData() {
    Promise.all([
        apiFetch('/analytics').then(function(r){return r.json()}),
        apiFetch('/leads').then(function(r){return r.json()})
    ]).then(function(results) {
        var analytics = results[0] || {};
        var leads = results[1] || {};
        renderAnalytics(analytics, leads);
    }).catch(function(){
        document.getElementById('analyticsContent').innerHTML = '<div class="leads-empty">Failed to load analytics</div>';
    });
}

function renderAnalytics(analytics, leads) {
    var totalViews = 0, totalClicks = 0, totalLeads = 0;
    var sourceCount = {nfc:0,qr:0,link:0,timeout:0};
    var clickCount = {call:0,email:0,whatsapp:0,linkedin:0,instagram:0,twitter:0,save_contact:0,website:0};
    var cardViews = {};
    var cardClicks = {};
    var dailyViews = {};

    for (var k in leads) {
        if (leads[k] && (leads[k].name || leads[k].phone || leads[k].email)) totalLeads++;
    }

    CARD_IDS.forEach(function(cid) {
        var cardData = analytics[cid] || {};
        cardViews[cid] = 0;
        cardClicks[cid] = 0;

        var views = cardData.views || {};
        for (var vk in views) {
            totalViews++;
            cardViews[cid]++;
            var v = views[vk];
            if (v.source && sourceCount.hasOwnProperty(v.source)) sourceCount[v.source]++;
            if (v.ts) {
                var day = new Date(v.ts).toISOString().slice(0,10);
                dailyViews[day] = (dailyViews[day]||0) + 1;
            }
        }

        var clicks = cardData.clicks || {};
        for (var ck in clicks) {
            totalClicks++;
            cardClicks[cid]++;
            var cl = clicks[ck];
            if (cl.action && clickCount.hasOwnProperty(cl.action)) clickCount[cl.action]++;
        }
    });

    var convRate = totalViews > 0 ? Math.round((totalLeads/totalViews)*100) : 0;

    var html = '';
    html += '<div class="analytics-grid">';
    html += '<div class="analytics-card"><div class="ac-num">'+totalViews+'</div><div class="ac-label">Total Views</div></div>';
    html += '<div class="analytics-card"><div class="ac-num">'+totalClicks+'</div><div class="ac-label">Total Clicks</div></div>';
    html += '<div class="analytics-card"><div class="ac-num">'+totalLeads+'</div><div class="ac-label">Leads Captured</div></div>';
    html += '<div class="analytics-card"><div class="ac-num">'+convRate+'%</div><div class="ac-label">Conversion Rate</div></div>';
    html += '</div>';

    var isFree = getUserPlan() === 'free';

    if (isFree) {
        // Show blurred teaser for detailed analytics
        html += '<div style="position:relative;margin-top:16px">';
        html += '<div style="filter:blur(5px);pointer-events:none;opacity:.5;user-select:none">';
        html += '<div class="chart-container"><canvas width="400" height="180"></canvas></div>';
        html += '<div class="analytics-section"><h3>Views by Source</h3>';
        html += makeBar('NFC', 42, 42, '#60a5fa');
        html += makeBar('QR Code', 28, 42, '#a78bfa');
        html += makeBar('Direct Link', 15, 42, '#34d399');
        html += '</div>';
        html += '<div class="analytics-section"><h3>Click Breakdown</h3>';
        html += makeBar('Call', 35, 35, '#60a5fa');
        html += makeBar('WhatsApp', 22, 35, '#4ade80');
        html += makeBar('Email', 18, 35, '#fbbf24');
        html += '</div>';
        html += '</div>';
        html += '<div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(15,15,26,.6);border-radius:12px">';
        html += '<div style="width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,#6366f1,#8b5cf6);display:flex;align-items:center;justify-content:center;margin-bottom:12px"><svg width="24" height="24" viewBox="0 0 24 24" fill="#fff"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1s3.1 1.39 3.1 3.1v2z"/></svg></div>';
        html += '<div style="font-size:16px;font-weight:700;color:#fff;margin-bottom:4px">Unlock Full Analytics</div>';
        html += '<div style="font-size:13px;color:rgba(255,255,255,.5);margin-bottom:16px;text-align:center;max-width:260px">See detailed view sources, click breakdowns, and card performance with Pro.</div>';
        html += '<button onclick="showUpgradeModal(\'Upgrade to see detailed analytics — sources, clicks, and card performance.\')" style="background:#6366f1;color:#fff;border:none;padding:10px 24px;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer">Upgrade to Pro</button>';
        html += '</div></div>';
    } else {
        html += '<div class="chart-container"><canvas id="viewsChart" width="400" height="180"></canvas></div>';

        html += '<div class="analytics-section"><h3>Views by Source</h3>';
        var maxSource = Math.max(sourceCount.nfc, sourceCount.qr, sourceCount.link, 1);
        html += makeBar('NFC', sourceCount.nfc, maxSource, '#60a5fa');
        html += makeBar('QR Code', sourceCount.qr, maxSource, '#a78bfa');
        html += makeBar('Direct Link', sourceCount.link, maxSource, '#34d399');
        html += makeBar('Timeout', sourceCount.timeout, maxSource, '#fb923c');
        html += '</div>';

        html += '<div class="analytics-section"><h3>Click Breakdown</h3>';
        var actions = ['call','whatsapp','email','website','linkedin','save_contact'];
        var actionLabels = {call:'Call',whatsapp:'WhatsApp',email:'Email',website:'Website',linkedin:'LinkedIn',save_contact:'Save Contact'};
        var maxClick = Math.max.apply(null, actions.map(function(a){return clickCount[a]||0}).concat([1]));
        var actionColors = {call:'#60a5fa',whatsapp:'#4ade80',email:'#fbbf24',website:'#a78bfa',linkedin:'#38bdf8',save_contact:'#f472b6'};
        actions.forEach(function(a){
            html += makeBar(actionLabels[a], clickCount[a]||0, maxClick, actionColors[a]||'#60a5fa');
        });
        html += '</div>';

        html += '<div class="analytics-section"><h3>Card Performance</h3>';
        CARD_IDS.forEach(function(cid){
            html += '<div class="card-perf-item"><span class="card-perf-name" style="color:'+sanitizeColor(CARD_COLORS[cid])+'">'+escapeHtml(NAMES[cid])+'</span><span class="card-perf-stats">'+
                (cardViews[cid]||0)+' views · '+(cardClicks[cid]||0)+' clicks</span></div>';
        });
        html += '</div>';
    }

    document.getElementById('analyticsContent').innerHTML = html;
    if (!isFree) setTimeout(function(){ drawDailyChart(dailyViews); }, 50);
}

function makeBar(label, count, max, color) {
    var pct = max > 0 ? Math.round((count/max)*100) : 0;
    return '<div class="analytics-bar"><span class="ab-label">'+label+'</span><div class="ab-track"><div class="ab-fill" style="width:'+pct+'%;background:'+color+'"></div></div><span class="ab-count">'+count+'</span></div>';
}

function drawDailyChart(dailyViews) {
    var canvas = document.getElementById('viewsChart');
    if (!canvas) return;
    var ctx = canvas.getContext('2d');
    var w = canvas.parentElement.clientWidth - 40;
    canvas.width = w * 2;
    canvas.height = 180 * 2;
    canvas.style.width = w + 'px';
    canvas.style.height = '180px';
    ctx.scale(2,2);

    var days = [];
    var labels = [];
    var values = [];
    for (var i = 6; i >= 0; i--) {
        var d = new Date();
        d.setDate(d.getDate() - i);
        var key = d.toISOString().slice(0,10);
        days.push(key);
        labels.push(d.toLocaleDateString('en-IN',{day:'numeric',month:'short'}));
        values.push(dailyViews[key] || 0);
    }

    var maxVal = Math.max.apply(null, values.concat([1]));
    var chartW = w - 50;
    var chartH = 140;
    var startX = 40;
    var startY = 10;

    ctx.strokeStyle = 'rgba(255,255,255,0.06)';
    ctx.lineWidth = 0.5;
    for (var g = 0; g <= 4; g++) {
        var gy = startY + chartH - (g/4)*chartH;
        ctx.beginPath();
        ctx.moveTo(startX, gy);
        ctx.lineTo(startX + chartW, gy);
        ctx.stroke();
    }

    ctx.fillStyle = 'rgba(255,255,255,0.3)';
    ctx.font = '10px Inter';
    ctx.textAlign = 'right';
    for (var g = 0; g <= 4; g++) {
        var val = Math.round((g/4)*maxVal);
        var gy = startY + chartH - (g/4)*chartH;
        ctx.fillText(val, startX - 8, gy + 3);
    }

    var barW = chartW / 7;
    ctx.beginPath();
    var points = [];
    for (var i = 0; i < 7; i++) {
        var x = startX + barW * i + barW/2;
        var y = startY + chartH - (values[i]/maxVal)*chartH;
        points.push({x:x,y:y});
        if (i === 0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
    }
    ctx.strokeStyle = '#60a5fa';
    ctx.lineWidth = 2;
    ctx.stroke();

    ctx.lineTo(points[6].x, startY + chartH);
    ctx.lineTo(points[0].x, startY + chartH);
    ctx.closePath();
    var gradient = ctx.createLinearGradient(0, startY, 0, startY + chartH);
    gradient.addColorStop(0, 'rgba(96,165,250,0.2)');
    gradient.addColorStop(1, 'rgba(96,165,250,0)');
    ctx.fillStyle = gradient;
    ctx.fill();

    points.forEach(function(p){
        ctx.beginPath();
        ctx.arc(p.x, p.y, 4, 0, Math.PI*2);
        ctx.fillStyle = '#60a5fa';
        ctx.fill();
    });

    ctx.fillStyle = 'rgba(255,255,255,0.35)';
    ctx.font = '10px Inter';
    ctx.textAlign = 'center';
    for (var i = 0; i < 7; i++) {
        ctx.fillText(labels[i], startX + barW*i + barW/2, startY + chartH + 18);
    }
}

// ── Storage Dashboard ──
function showStorage() {
    navigateTo('settings');
    setTimeout(function() {
        var el = document.getElementById('settingsStorageSection');
        if (el) el.scrollIntoView({behavior: 'smooth'});
    }, 100);
    loadStorageData();
}

function hideStorage() {
    navigateTo('dashboard');
}

function loadStorageData() {
    // Fetch all data to calculate size
    Promise.all([
        apiFetch('/leads').then(function(r){return r.text()}),
        apiFetch('/taps').then(function(r){return r.text()}),
        apiFetch('/analytics').then(function(r){return r.text()}),
        apiFetch('/settings').then(function(r){return r.text()}),
        apiFetch('/auth/me').then(function(r){return r.text()})
    ]).then(function(results) {
        var leadsData = results[0] || '{}';
        var tapsData = results[1] || '{}';
        var analyticsData = results[2] || '{}';
        var settingsData = results[3] || '{}';
        var latestData = results[4] || '{}';

        // Calculate sizes in bytes
        var leadsSize = new Blob([leadsData]).size;
        var tapsSize = new Blob([tapsData]).size;
        var analyticsSize = new Blob([analyticsData]).size;
        var settingsSize = new Blob([settingsData]).size;
        var latestSize = new Blob([latestData]).size;
        var totalSize = leadsSize + tapsSize + analyticsSize + settingsSize + latestSize;

        // Count records
        var leads = JSON.parse(leadsData) || {};
        var taps = JSON.parse(tapsData) || {};
        var leadsCount = Object.keys(leads).length;
        var tapsCount = Object.keys(taps).length;

        // Firebase free tier: 1 GB storage, 10 GB/month download
        var freeStorageLimit = 1024 * 1024 * 1024; // 1 GB
        var freeDownloadLimit = 10 * 1024 * 1024 * 1024; // 10 GB
        var storagePercent = (totalSize / freeStorageLimit) * 100;

        // Estimated monthly downloads (rough: assume 100 page loads * total data)
        var estimatedMonthlyDownload = totalSize * 100;
        var downloadPercent = (estimatedMonthlyDownload / freeDownloadLimit) * 100;

        // Cost calculation (Blaze plan: $5/GB stored, $1/GB downloaded beyond free tier)
        var storageCost = totalSize > freeStorageLimit ? ((totalSize - freeStorageLimit) / (1024*1024*1024)) * 5 : 0;
        var downloadCost = estimatedMonthlyDownload > freeDownloadLimit ? ((estimatedMonthlyDownload - freeDownloadLimit) / (1024*1024*1024)) * 1 : 0;
        var totalCost = storageCost + downloadCost;

        renderStorage({
            leadsSize: leadsSize,
            tapsSize: tapsSize,
            analyticsSize: analyticsSize,
            settingsSize: settingsSize,
            totalSize: totalSize,
            leadsCount: leadsCount,
            tapsCount: tapsCount,
            storagePercent: storagePercent,
            downloadPercent: downloadPercent,
            estimatedMonthlyDownload: estimatedMonthlyDownload,
            storageCost: storageCost,
            downloadCost: downloadCost,
            totalCost: totalCost,
            freeStorageLimit: freeStorageLimit,
            freeDownloadLimit: freeDownloadLimit
        });
    }).catch(function(err){
        document.getElementById('storageContent').innerHTML = '<div class="leads-empty">Failed to load storage data</div>';
    });
}

function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    var k = 1024;
    var sizes = ['B', 'KB', 'MB', 'GB'];
    var i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function renderStorage(data) {
    var html = '';

    // Storage Overview
    html += '<div class="storage-card"><h4>Storage Used</h4>';
    html += '<div class="storage-row"><span class="storage-label">Leads data</span><span class="storage-value">'+formatBytes(data.leadsSize)+'</span></div>';
    html += '<div class="storage-row"><span class="storage-label">Tap sessions</span><span class="storage-value">'+formatBytes(data.tapsSize)+'</span></div>';
    html += '<div class="storage-row"><span class="storage-label">Analytics</span><span class="storage-value">'+formatBytes(data.analyticsSize)+'</span></div>';
    html += '<div class="storage-row"><span class="storage-label">Settings</span><span class="storage-value">'+formatBytes(data.settingsSize)+'</span></div>';
    html += '<div class="storage-row" style="border-top:1px solid rgba(255,255,255,.1);padding-top:12px;margin-top:8px"><span class="storage-label" style="font-weight:600;color:rgba(255,255,255,.7)">Total</span><span class="storage-value" style="color:#2dd4bf">'+formatBytes(data.totalSize)+'</span></div>';
    html += '</div>';

    // Records Count
    html += '<div class="storage-card"><h4>Records</h4>';
    html += '<div class="storage-row"><span class="storage-label">Total leads</span><span class="storage-value">'+data.leadsCount+'</span></div>';
    html += '<div class="storage-row"><span class="storage-label">Total tap sessions</span><span class="storage-value">'+data.tapsCount+'</span></div>';
    html += '</div>';

    // Free Tier Usage
    html += '<div class="storage-card"><h4>Free Tier Usage</h4>';
    html += '<div class="storage-bar"><div class="storage-bar-track"><div class="storage-bar-fill" style="width:'+Math.min(data.storagePercent, 100)+'%"></div></div>';
    html += '<div class="storage-bar-label"><span>Storage: '+formatBytes(data.totalSize)+' / 1 GB</span><span>'+data.storagePercent.toFixed(4)+'%</span></div></div>';
    html += '<div class="storage-bar" style="margin-top:16px"><div class="storage-bar-track"><div class="storage-bar-fill" style="width:'+Math.min(data.downloadPercent, 100)+'%"></div></div>';
    html += '<div class="storage-bar-label"><span>Est. downloads: '+formatBytes(data.estimatedMonthlyDownload)+' / 10 GB</span><span>'+data.downloadPercent.toFixed(4)+'%</span></div></div>';
    html += '</div>';

    // Cost Estimate
    html += '<div class="storage-card"><h4>Estimated Monthly Cost</h4>';
    if (data.totalCost === 0) {
        html += '<div class="storage-row"><span class="storage-label">Status</span><span class="storage-value cost-free">Within free tier</span></div>';
        html += '<div class="storage-row"><span class="storage-label">Monthly cost</span><span class="storage-value cost-free">$0.00</span></div>';
    } else {
        html += '<div class="storage-row"><span class="storage-label">Storage overage</span><span class="storage-value cost-paid">$'+data.storageCost.toFixed(2)+'</span></div>';
        html += '<div class="storage-row"><span class="storage-label">Download overage</span><span class="storage-value cost-paid">$'+data.downloadCost.toFixed(2)+'</span></div>';
        html += '<div class="storage-row"><span class="storage-label">Total</span><span class="storage-value cost-paid">$'+data.totalCost.toFixed(2)+'/mo</span></div>';
    }
    html += '</div>';

    // Info Note
    html += '<p class="storage-note">Firebase Spark (free) plan includes 1 GB storage and 10 GB/month downloads. Blaze plan charges $5/GB stored and $1/GB downloaded beyond free limits. Download estimate assumes ~100 page loads/month.</p>';

    document.getElementById('storageContent').innerHTML = html;
}

// ── Review Queue ──
var reviewItems = [];

function checkReviewQueue() {
    if (!currentUser) return;
    apiFetch('/leads').then(function(r){return r.json()}).then(function(data) {
        var count = 0;
        if (data) {
            for (var k in data) {
                var l = data[k];
                // Only count items that have BOTH needsReview AND cardImage
                if (l && l.needsReview && l.cardImage) {
                    count++;
                }
            }
        }
        var badge = document.getElementById('reviewBadge');
        if (badge) {
            if (count > 0) {
                badge.textContent = count;
                badge.classList.add('show');
            } else {
                badge.classList.remove('show');
            }
        }
    }).catch(function(){});
}

function showReviewQueue() {
    navigateTo('settings');
    setTimeout(function() {
        var el = document.getElementById('settingsReviewSection');
        if (el) el.scrollIntoView({behavior: 'smooth'});
    }, 100);
    loadReviewItems();
}

function hideReviewQueue() {
    navigateTo('dashboard');
    checkReviewQueue();
}

function loadReviewItems() {
    apiFetch('/leads').then(function(r){return r.json()}).then(function(data) {
        if (!data) { reviewItems = []; renderReviewItems(); return; }

        var items = [];
        for (var k in data) {
            var l = data[k];
            if (l && l.needsReview && l.cardImage) {
                l._id = k;
                items.push(l);
            }
        }
        items.sort(function(a,b){ return (b.ts||0)-(a.ts||0); });
        reviewItems = items;
        renderReviewItems();
    }).catch(function(){
        document.getElementById('reviewList').innerHTML = '<div class="leads-empty">Failed to load</div>';
    });
}

function renderReviewItems() {
    var list = document.getElementById('reviewList');
    document.getElementById('reviewCount').textContent = reviewItems.length + ' pending';

    if (reviewItems.length === 0) {
        list.innerHTML = '<div class="leads-empty">No cards to review</div>';
        return;
    }

    var html = '';
    reviewItems.forEach(function(item, idx) {
        var timeStr = item.ts ? new Date(item.ts).toLocaleString('en-IN', {day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'}) : '';

        html += '<div class="review-item" data-id="'+item._id+'" data-idx="'+idx+'">';
        html += '<div class="review-time">'+timeStr+' · '+(item.visitor?item.visitor.device:'Unknown')+'</div>';
        html += '<img class="review-img" src="'+item.cardImage+'" id="reviewImg'+idx+'">';
        html += '<button class="review-ocr-btn" onclick="runOCR('+idx+')" id="ocrBtn'+idx+'"><svg viewBox="0 0 24 24"><path d="M9.5 6.5v3h-3v-3h3M11 5H5v6h6V5zm-1.5 9.5v3h-3v-3h3M11 13H5v6h6v-6zm6.5-6.5v3h-3v-3h3M19 5h-6v6h6V5z"/></svg>Extract text with OCR</button>';
        html += '<div class="review-field"><label>Name</label><input type="text" id="revName'+idx+'" placeholder="Full name"></div>';
        html += '<div class="review-field"><label>Phone</label><input type="tel" id="revPhone'+idx+'" placeholder="Phone number"></div>';
        html += '<div class="review-field"><label>Email</label><input type="email" id="revEmail'+idx+'" placeholder="Email address"></div>';
        html += '<div class="review-field"><label>Company</label><input type="text" id="revCompany'+idx+'" placeholder="Company name"></div>';
        html += '<div class="review-field"><label>Address</label><textarea id="revAddress'+idx+'" placeholder="Address (optional)" rows="2"></textarea></div>';
        html += '<div class="review-actions">';
        html += '<button class="review-save" onclick="saveReview('+idx+')">Save Lead</button>';
        html += '<button class="review-skip" onclick="skipReview('+idx+')">Skip</button>';
        html += '</div></div>';
    });
    list.innerHTML = html;
}

function runOCR(idx) {
    var item = reviewItems[idx];
    if (!item) return;

    var btn = document.getElementById('ocrBtn'+idx);
    btn.classList.add('scanning');
    btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M9.5 6.5v3h-3v-3h3M11 5H5v6h6V5zm-1.5 9.5v3h-3v-3h3M11 13H5v6h6v-6zm6.5-6.5v3h-3v-3h3M19 5h-6v6h6V5z"/></svg>Scanning...';

    Tesseract.recognize(item.cardImage, 'eng', {
        logger: function(m) {
            if (m.status === 'recognizing text') {
                var pct = Math.round(m.progress * 100);
                btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M9.5 6.5v3h-3v-3h3M11 5H5v6h6V5zm-1.5 9.5v3h-3v-3h3M11 13H5v6h6v-6zm6.5-6.5v3h-3v-3h3M19 5h-6v6h6V5z"/></svg>'+pct+'%';
            }
        }
    }).then(function(result) {
        var text = result.data.text;
        parseAndFillReview(idx, text);
        btn.classList.remove('scanning');
        btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>Done! Edit below.';
    }).catch(function(err) {
        console.error('OCR error:', err);
        btn.classList.remove('scanning');
        btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M9.5 6.5v3h-3v-3h3M11 5H5v6h6V5z"/></svg>OCR failed - fill manually';
    });
}

function parseAndFillReview(idx, text) {
    var lines = text.split('\n').map(function(l){ return l.trim(); }).filter(function(l){ return l.length > 0; });
    var fullText = text.replace(/\n/g, ' ');

    // Extract email
    var emailMatch = fullText.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/);
    if (emailMatch) {
        document.getElementById('revEmail'+idx).value = emailMatch[0].toLowerCase();
    }

    // Extract phone - try multiple patterns
    var phonePatterns = [
        /(?:\+?91[-.\s]?)?[6-9]\d{9}/,
        /(?:\+?1[-.\s]?)?\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}/,
        /(?:\+?\d{1,3}[-.\s]?)?\d{2,4}[-.\s]?\d{3,4}[-.\s]?\d{3,4}/
    ];
    for (var i = 0; i < phonePatterns.length; i++) {
        var phoneMatch = fullText.match(phonePatterns[i]);
        if (phoneMatch) {
            var phone = phoneMatch[0].replace(/[^\d+]/g, '');
            if (phone.length >= 10) {
                document.getElementById('revPhone'+idx).value = phoneMatch[0].trim();
                break;
            }
        }
    }

    // Company keywords (prioritized)
    var companyKeywords = ['pvt','ltd','llc','inc','corp','limited','private','company','solutions','technologies','services','group','enterprises','industries','exports','imports','trading','consulting','associates','partners','infra','infrastructure','developers','builders','realty','real estate','properties'];
    var companyFound = '';

    // First pass: Look for lines with company keywords
    for (var i = 0; i < lines.length; i++) {
        var line = lines[i];
        var lower = line.toLowerCase();
        if (line.indexOf('@') !== -1) continue;
        if (lower.indexOf('www') !== -1) continue;
        var hasCompanyWord = companyKeywords.some(function(w){ return lower.indexOf(w) !== -1; });
        if (hasCompanyWord && line.length > 3 && line.length < 60) {
            companyFound = line;
            break;
        }
    }

    // Second pass: If no company found, look for ALL CAPS lines (common for company names)
    if (!companyFound) {
        for (var i = 0; i < Math.min(lines.length, 8); i++) {
            var line = lines[i];
            if (line.indexOf('@') !== -1) continue;
            if (/\d{5,}/.test(line)) continue;
            // Check if mostly uppercase
            var upperCount = (line.match(/[A-Z]/g) || []).length;
            var letterCount = (line.match(/[a-zA-Z]/g) || []).length;
            if (letterCount > 4 && upperCount / letterCount > 0.7 && line.length > 5 && line.length < 50) {
                companyFound = line;
                break;
            }
        }
    }

    if (companyFound) {
        document.getElementById('revCompany'+idx).value = companyFound;
    }

    // Extract name - look for proper case names (not all caps, not company)
    var nameSkipWords = ['pvt','ltd','llc','inc','corp','limited','private','company','solutions','technologies','services','www','http','email','phone','tel','fax','address','mobile','office','director','manager','ceo','founder','mr','mrs','ms','dr'];
    for (var i = 0; i < Math.min(lines.length, 8); i++) {
        var line = lines[i];
        var lower = line.toLowerCase();
        if (line.indexOf('@') !== -1) continue;
        if (lower.indexOf('www') !== -1) continue;
        if (/\d{5,}/.test(line)) continue;
        if (line === companyFound) continue;

        var hasSkipWord = nameSkipWords.some(function(w){ return lower.indexOf(w) !== -1; });
        if (hasSkipWord) continue;

        var words = line.split(/\s+/).filter(function(w){ return w.length > 1; });
        if (words.length >= 2 && words.length <= 5) {
            var letterRatio = (line.replace(/[^a-zA-Z\s.]/g, '').length / line.length);
            // Check for proper case (not ALL CAPS)
            var upperCount = (line.match(/[A-Z]/g) || []).length;
            var letterCount = (line.match(/[a-zA-Z]/g) || []).length;
            var isAllCaps = letterCount > 4 && upperCount / letterCount > 0.8;

            if (letterRatio > 0.8 && !isAllCaps) {
                document.getElementById('revName'+idx).value = line;
                break;
            }
        }
    }

    // Extract address - look for lines with address indicators
    var addressKeywords = ['road','street','lane','nagar','colony','sector','block','floor','building','tower','plot','no.','pin','zip','-','avenue','apt','apartment','suite','city','state'];
    var addressLines = [];
    for (var i = 0; i < lines.length; i++) {
        var line = lines[i];
        var lower = line.toLowerCase();
        if (line.indexOf('@') !== -1) continue;
        var hasAddressWord = addressKeywords.some(function(w){ return lower.indexOf(w) !== -1; });
        // Also check for PIN code pattern
        var hasPinCode = /\b\d{6}\b/.test(line) || /\b\d{5}\b/.test(line);
        if ((hasAddressWord || hasPinCode) && line.length > 5) {
            addressLines.push(line);
        }
    }
    if (addressLines.length > 0) {
        document.getElementById('revAddress'+idx).value = addressLines.join(', ');
    }
}

function saveReview(idx) {
    var item = reviewItems[idx];
    if (!item) return;

    var name = document.getElementById('revName'+idx).value.trim();
    var phone = document.getElementById('revPhone'+idx).value.trim();
    var email = document.getElementById('revEmail'+idx).value.trim();
    var company = document.getElementById('revCompany'+idx).value.trim();
    var address = document.getElementById('revAddress'+idx).value.trim();

    // Update lead with extracted data, remove image, mark as reviewed
    var updateData = {
        name: name,
        phone: phone,
        email: email,
        company: company,
        address: address,
        needsReview: null, // delete this field
        cardImage: null,   // delete image to save space
        reviewedAt: Date.now()
    };

    apiFetch('/leads/'+item._id, {method:'PATCH', body:updateData}).then(function() {
        // Remove from list
        reviewItems.splice(idx, 1);
        renderReviewItems();
        loadStats();

        // Offer to save to contacts
        if (name || phone || email) {
            if (confirm('Lead saved! Add "' + (name || phone || email) + '" to your contacts?')) {
                saveLeadWithAddress(name, phone, email, company, address);
            }
        }
    });
}

function saveLeadWithAddress(name, phone, email, company, address) {
    var parts = (name || '').split(' ');
    var last = parts.length > 1 ? parts.pop() : '';
    var first = parts.join(' ') || name;
    var lines = ['BEGIN:VCARD','VERSION:3.0'];
    if (name) { lines.push('N:'+last+';'+first+';;;'); lines.push('FN:'+name); }
    if (company) lines.push('ORG:'+company);
    if (phone) lines.push('TEL;TYPE=CELL:'+phone);
    if (email) lines.push('EMAIL;TYPE=INTERNET:'+email);
    if (address) lines.push('ADR;TYPE=WORK:;;'+address.replace(/,/g,';')+';;;;');
    lines.push('END:VCARD');
    var blob = new Blob([lines.join('\n')], {type:'text/vcard;charset=utf-8'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = (name||'contact').replace(/\s/g,'_')+'.vcf';
    document.body.appendChild(a); a.click();
    setTimeout(function(){ document.body.removeChild(a); URL.revokeObjectURL(url); },100);
}

function skipReview(idx) {
    var item = reviewItems[idx];
    if (!item) return;

    // Just remove needsReview flag but keep the image
    apiFetch('/leads/'+item._id, {method:'PATCH', body:{needsReview:null}}).then(function() {
        reviewItems.splice(idx, 1);
        renderReviewItems();
    });
}

// Note: checkReviewQueue + interval called from initApp() after auth

function esc(s) { return s.replace(/\\/g,'\\\\').replace(/'/g,"\\'"); }

function saveLead(name, phone, email, company) {
    var parts = name.split(' ');
    var last = parts.length > 1 ? parts.pop() : '';
    var first = parts.join(' ') || name;
    var lines = ['BEGIN:VCARD','VERSION:3.0'];
    if (name) { lines.push('N:'+last+';'+first+';;;'); lines.push('FN:'+name); }
    if (company) lines.push('ORG:'+company);
    if (phone) lines.push('TEL;TYPE=CELL:'+phone);
    if (email) lines.push('EMAIL;TYPE=INTERNET:'+email);
    lines.push('END:VCARD');
    var blob = new Blob([lines.join('\n')], {type:'text/vcard;charset=utf-8'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = (name||'contact').replace(/\s/g,'_')+'.vcf';
    document.body.appendChild(a); a.click();
    setTimeout(function(){ document.body.removeChild(a); URL.revokeObjectURL(url); },100);
}

// ── Scan Modal ──
var scanStream = null;
var scanMode = null; // 'qr' or 'card'
var scanInterval = null;

function openScanModal() {
    document.getElementById('scanModal').classList.add('show');
    document.getElementById('scanOptions').style.display = 'flex';
    document.getElementById('scanCamera').style.display = 'none';
    document.getElementById('scanResult').style.display = 'none';
    document.getElementById('scanTitle').textContent = 'Scan Contact';
}

function closeScanModal() {
    document.getElementById('scanModal').classList.remove('show');
    stopScanCamera();
}

function stopScanCamera() {
    if (scanInterval) { clearInterval(scanInterval); scanInterval = null; }
    if (scanStream) {
        scanStream.getTracks().forEach(function(t){ t.stop(); });
        scanStream = null;
    }
    var video = document.getElementById('scanVideo');
    if (video) video.srcObject = null;
}

function startQrScan() {
    scanMode = 'qr';
    document.getElementById('scanOptions').style.display = 'none';
    document.getElementById('scanCamera').style.display = 'flex';
    document.getElementById('scanTitle').textContent = 'Scan QR Code';
    document.getElementById('scanStatus').textContent = 'Point camera at QR code...';
    document.getElementById('scanCaptureBtn').style.display = 'none';
    document.getElementById('scanViewfinder').style.display = 'block';

    startCamera(function() {
        // Start scanning for QR codes
        scanInterval = setInterval(scanForQR, 200);
    });
}

function startCardScan() {
    scanMode = 'card';
    document.getElementById('scanOptions').style.display = 'none';
    document.getElementById('scanCamera').style.display = 'flex';
    document.getElementById('scanTitle').textContent = 'Scan Business Card';
    document.getElementById('scanStatus').textContent = 'Position card in frame, then tap Capture';
    document.getElementById('scanCaptureBtn').style.display = 'block';
    document.getElementById('scanViewfinder').style.display = 'none';

    startCamera();
}

function startCamera(callback) {
    var video = document.getElementById('scanVideo');
    navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
    }).then(function(stream) {
        scanStream = stream;
        video.srcObject = stream;
        video.play();
        if (callback) setTimeout(callback, 500);
    }).catch(function(err) {
        document.getElementById('scanStatus').textContent = 'Camera error: ' + err.message;
    });
}

function scanForQR() {
    if (typeof jsQR === 'undefined') return;
    var video = document.getElementById('scanVideo');
    var canvas = document.getElementById('scanCanvas');
    var ctx = canvas.getContext('2d');

    if (video.readyState !== video.HAVE_ENOUGH_DATA) return;

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);

    var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    var code = jsQR(imageData.data, imageData.width, imageData.height);

    if (code && code.data) {
        stopScanCamera();
        processQrData(code.data);
    }
}

function processQrData(data) {
    document.getElementById('scanStatus').textContent = 'QR found! Processing...';

    // Try to parse vCard
    if (data.indexOf('BEGIN:VCARD') !== -1) {
        var contact = parseVCard(data);
        showScanResult(contact);
        return;
    }

    // Try to parse MECARD
    if (data.indexOf('MECARD:') === 0) {
        var contact = parseMeCard(data);
        showScanResult(contact);
        return;
    }

    // URL - might be a digital card
    if (data.indexOf('http') === 0) {
        showScanResult({ name: '', company: '', phone: '', email: '', url: data });
        document.getElementById('scanStatus').textContent = 'URL found: ' + data;
        return;
    }

    // Plain text - put in name field
    showScanResult({ name: data, company: '', phone: '', email: '' });
}

function parseVCard(data) {
    var contact = { name: '', company: '', phone: '', email: '' };
    var lines = data.split(/\r?\n/);
    lines.forEach(function(line) {
        if (line.indexOf('FN:') === 0) contact.name = line.substring(3);
        else if (line.indexOf('ORG:') === 0) contact.company = line.substring(4).split(';')[0];
        else if (line.indexOf('TEL') === 0) contact.phone = line.split(':').pop();
        else if (line.indexOf('EMAIL') === 0) contact.email = line.split(':').pop();
    });
    return contact;
}

function parseMeCard(data) {
    var contact = { name: '', company: '', phone: '', email: '' };
    var parts = data.replace('MECARD:', '').split(';');
    parts.forEach(function(p) {
        if (p.indexOf('N:') === 0) contact.name = p.substring(2).replace(/,/g, ' ');
        else if (p.indexOf('ORG:') === 0) contact.company = p.substring(4);
        else if (p.indexOf('TEL:') === 0) contact.phone = p.substring(4);
        else if (p.indexOf('EMAIL:') === 0) contact.email = p.substring(6);
    });
    return contact;
}

function captureCard() {
    var video = document.getElementById('scanVideo');
    var canvas = document.getElementById('scanCanvas');
    var ctx = canvas.getContext('2d');

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);

    stopScanCamera();
    document.getElementById('scanStatus').textContent = 'Processing with OCR...';
    document.getElementById('scanCaptureBtn').disabled = true;

    // Use Tesseract for OCR
    if (typeof Tesseract !== 'undefined') {
        Tesseract.recognize(canvas, 'eng').then(function(result) {
            var text = result.data.text;
            var contact = extractContactFromOCR(text);
            showScanResult(contact);
        }).catch(function(err) {
            document.getElementById('scanStatus').textContent = 'OCR failed: ' + err.message;
            document.getElementById('scanCaptureBtn').disabled = false;
        });
    } else {
        document.getElementById('scanStatus').textContent = 'OCR not available';
    }
}

function extractContactFromOCR(text) {
    var contact = { name: '', company: '', phone: '', email: '' };
    var lines = text.split('\n').map(function(l){ return l.trim(); }).filter(function(l){ return l; });

    // Find email
    var emailMatch = text.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/);
    if (emailMatch) contact.email = emailMatch[0].toLowerCase();

    // Find phone
    var phoneMatch = text.match(/[\+]?[\d\s\-\(\)]{10,}/);
    if (phoneMatch) contact.phone = phoneMatch[0].replace(/[^\d+]/g, '');

    // First substantial line is usually name
    for (var i = 0; i < lines.length; i++) {
        var line = lines[i];
        if (line.length > 2 && !line.match(/@/) && !line.match(/^\d/)) {
            if (!contact.name) contact.name = line;
            else if (!contact.company && line !== contact.name) { contact.company = line; break; }
        }
    }

    return contact;
}

function showScanResult(contact) {
    document.getElementById('scanCamera').style.display = 'none';
    document.getElementById('scanResult').style.display = 'block';
    document.getElementById('scanName').value = contact.name || '';
    document.getElementById('scanCompany').value = contact.company || '';
    document.getElementById('scanPhone').value = contact.phone || '';
    document.getElementById('scanEmail').value = contact.email || '';
    document.getElementById('scanTitle').textContent = 'Review Contact';
}

function retryScan() {
    document.getElementById('scanResult').style.display = 'none';
    document.getElementById('scanOptions').style.display = 'flex';
    document.getElementById('scanTitle').textContent = 'Scan Contact';
}

function saveScannedContact() {
    var contact = {
        name: document.getElementById('scanName').value.trim(),
        company: document.getElementById('scanCompany').value.trim(),
        phone: document.getElementById('scanPhone').value.trim(),
        email: document.getElementById('scanEmail').value.trim(),
        ts: Date.now(),
        source: 'scanned'
    };

    if (!contact.name && !contact.phone && !contact.email) {
        alert('Please enter at least a name, phone, or email');
        return;
    }

    // Save lead
    var scanLeadId = Date.now().toString(36) + Math.random().toString(36).substr(2,5);
    apiFetch('/leads/' + scanLeadId, {
        method: 'PUT',
        body: contact
    }).then(function() {
        closeScanModal();
        loadStats();
        alert('Contact saved to leads!');
    }).catch(function(err) {
        alert('Failed to save: ' + err.message);
    });
}

// ── Swipe Navigation ──
function initSwipeNav() {
    var panels = [
        { el: document.getElementById('leads'), hide: hideLeads },
        { el: document.getElementById('analytics'), hide: hideAnalytics },
        { el: document.getElementById('storage'), hide: hideStorage },
        { el: document.getElementById('reviewQueue'), hide: hideReviewQueue },
        { el: document.getElementById('cardsPanel'), hide: hideCardsPanel }
    ];

    panels.forEach(function(panel) {
        if (!panel.el) return;
        var startX = 0, startY = 0, swiping = false;

        panel.el.addEventListener('touchstart', function(e) {
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            swiping = startX < 50; // Only from left edge
            if (swiping) panel.el.classList.add('panel-swiping');
        }, { passive: true });

        panel.el.addEventListener('touchmove', function(e) {
            if (!swiping) return;
            var diffX = e.touches[0].clientX - startX;
            var diffY = Math.abs(e.touches[0].clientY - startY);
            // Cancel if scrolling vertically
            if (diffY > 30) { swiping = false; panel.el.classList.remove('panel-swiping'); }
        }, { passive: true });

        panel.el.addEventListener('touchend', function(e) {
            panel.el.classList.remove('panel-swiping');
            if (!swiping) return;
            var endX = e.changedTouches[0].clientX;
            var diffX = endX - startX;
            // Swipe right from left edge = go back
            if (diffX > 80) panel.hide();
            swiping = false;
        }, { passive: true });
    });
}
// Note: initSwipeNav, updateNotifUI, updateStatusBadges called from initApp() after auth

// ── Auto-updating Service Worker ──
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').then(function(reg) {
        console.log('ServiceWorker registered:', reg.scope);

        // If there's already a waiting worker, activate it immediately
        if (reg.waiting) {
            console.log('Waiting worker found, activating...');
            reg.waiting.postMessage({type: 'SKIP_WAITING'});
        }

        // Check for updates immediately on load
        reg.update();

        // Check for updates every 30 seconds
        setInterval(function() {
            reg.update();
        }, 30000);

        // Listen for new service worker
        reg.addEventListener('updatefound', function() {
            var newWorker = reg.installing;
            console.log('New service worker found, installing...');

            newWorker.addEventListener('statechange', function() {
                if (newWorker.state === 'installed') {
                    if (navigator.serviceWorker.controller) {
                        // New version available - force activate
                        console.log('New version ready, activating...');
                        newWorker.postMessage({type: 'SKIP_WAITING'});
                        showUpdateToast();
                    }
                }
            });
        });
    }).catch(function(err) {
        console.log('ServiceWorker registration failed:', err);
    });

    // Reload when controller changes (new SW activated)
    var refreshing = false;
    navigator.serviceWorker.addEventListener('controllerchange', function() {
        if (refreshing) return;
        refreshing = true;
        console.log('Controller changed, reloading...');
        location.reload();
    });
}

function showUpdateToast(msg) {
    var existing = document.querySelector('.update-toast');
    if (existing) existing.remove();
    var toast = document.createElement('div');
    toast.className = 'update-toast';
    toast.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#4ade80;color:#000;padding:12px 24px;border-radius:12px;font-size:14px;font-weight:500;z-index:9999;animation:fadeIn .3s';
    toast.textContent = msg || 'Updating to latest version...';
    document.body.appendChild(toast);
}

// ── App Install System ──
var deferredPrompt = null;

function isIOS() {
    return /iPhone|iPad|iPod/.test(navigator.userAgent);
}
function isAndroid() {
    return /Android/.test(navigator.userAgent);
}
function isInStandaloneMode() {
    return (window.matchMedia('(display-mode: standalone)').matches) ||
           (window.navigator.standalone === true);
}

// Capture the beforeinstallprompt event for Chrome/Android
window.addEventListener('beforeinstallprompt', function(e) {
    e.preventDefault();
    deferredPrompt = e;
    updateInstallButton();
});

// Update install button based on state
function updateInstallButton() {
    var btn = document.getElementById('installBtn');
    if (!btn) return;
    if (isInStandaloneMode()) {
        btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>Installed';
        btn.classList.add('installed');
        btn.onclick = null;
    }
}

function showInstallModal() {
    if (isInStandaloneMode()) {
        return; // Already installed
    }

    var modal = document.getElementById('installModal');
    var content = document.getElementById('installModalContent');

    if (isIOS()) {
        // iOS instructions
        content.innerHTML = '\
            <div class="install-icon"><svg viewBox="0 0 24 24"><path d="M17 1.01L7 1c-1.1 0-2 .9-2 2v18c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-1.99-2-1.99zM17 19H7V5h10v14z"/></svg></div>\
            <h3>Install Cards App</h3>\
            <p>Get instant notifications when someone taps your NFC card</p>\
            <div class="install-features">\
                <div class="install-feature"><svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg><span>Notifications</span></div>\
                <div class="install-feature"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg><span>Works Offline</span></div>\
                <div class="install-feature"><svg viewBox="0 0 24 24"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg><span>Instant</span></div>\
            </div>\
            <div class="install-steps">\
                <div class="install-step"><span class="install-step-num">1</span><span class="install-step-text">Tap <svg viewBox="0 0 24 24"><path d="M16 5l-1.42 1.42-1.59-1.59V16h-1.98V4.83L9.42 6.42 8 5l4-4 4 4zm4 5v11c0 1.1-.9 2-2 2H6c-1.1 0-2-.9-2-2V10c0-1.1.9-2 2-2h3v2H6v11h12V10h-3V8h3c1.1 0 2 .9 2 2z"/></svg> Share at the bottom</span></div>\
                <div class="install-step"><span class="install-step-num">2</span><span class="install-step-text">Scroll down, tap <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg> Add to Home Screen</span></div>\
                <div class="install-step"><span class="install-step-num">3</span><span class="install-step-text">Tap Add in the top right</span></div>\
            </div>\
            <button class="install-secondary-btn" onclick="closeInstallModal(true)">Got it</button>\
        ';
    } else if (deferredPrompt) {
        // Chrome/Android with native prompt available
        content.innerHTML = '\
            <div class="install-icon"><svg viewBox="0 0 24 24"><path d="M17 1.01L7 1c-1.1 0-2 .9-2 2v18c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-1.99-2-1.99zM17 19H7V5h10v14z"/></svg></div>\
            <h3>Install Cards App</h3>\
            <p>Get instant notifications when someone taps your NFC card</p>\
            <div class="install-features">\
                <div class="install-feature"><svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg><span>Notifications</span></div>\
                <div class="install-feature"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg><span>Works Offline</span></div>\
                <div class="install-feature"><svg viewBox="0 0 24 24"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg><span>Instant</span></div>\
            </div>\
            <button class="install-primary-btn" onclick="triggerInstall()">Install Now</button>\
            <button class="install-secondary-btn" onclick="closeInstallModal()">Maybe Later</button>\
        ';
    } else {
        // Desktop or browser without native install
        content.innerHTML = '\
            <div class="install-icon"><svg viewBox="0 0 24 24"><path d="M17 1.01L7 1c-1.1 0-2 .9-2 2v18c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-1.99-2-1.99zM17 19H7V5h10v14z"/></svg></div>\
            <h3>Install Cards App</h3>\
            <p>Get instant notifications when someone taps your NFC card</p>\
            <div class="install-features">\
                <div class="install-feature"><svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg><span>Notifications</span></div>\
                <div class="install-feature"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg><span>Works Offline</span></div>\
                <div class="install-feature"><svg viewBox="0 0 24 24"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg><span>Instant</span></div>\
            </div>\
            <div class="install-steps">\
                <div class="install-step"><span class="install-step-num">1</span><span class="install-step-text">Click the browser menu (three dots)</span></div>\
                <div class="install-step"><span class="install-step-num">2</span><span class="install-step-text">Select "Install app" or "Add to Home screen"</span></div>\
            </div>\
            <button class="install-secondary-btn" onclick="closeInstallModal(true)">Got it</button>\
        ';
    }

    modal.classList.add('show');
}

function triggerInstall() {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(function(result) {
            if (result.outcome === 'accepted') {
                updateInstallButton();
            }
            deferredPrompt = null;
        });
    }
    closeInstallModal();
}

function closeInstallModal(saveDismiss) {
    document.getElementById('installModal').classList.remove('show');
    if (saveDismiss) {
        localStorage.setItem('installModalDismissed', 'true');
    }
}

// Note: updateInstallButton called from initApp() after auth

// Listen for successful install
window.addEventListener('appinstalled', function() {
    updateInstallButton();
    closeInstallModal();
});

// Note: install modal shown from initApp() after auth

// ── Tutorial System ──
var tutorialSteps = [
    {
        element: '.qr-card',
        title: 'QR Code Sharing',
        text: 'Share your card instantly! Tap the QR to go fullscreen, or use the buttons below to copy link or share. Visitors scan this to get your digital card.',
        position: 'bottom'
    },
    {
        element: '#qrCardSelect',
        title: 'Switch Cards',
        text: 'If you have multiple cards (different businesses), switch between them here. The QR code updates automatically.',
        position: 'bottom'
    },
    {
        element: '.action-grid',
        title: 'Quick Actions',
        text: 'Access all features from here: View leads, check analytics, manage your cards, and more.',
        position: 'top'
    },
    {
        element: '.action-btn[onclick*="showLeads"]',
        title: 'Your Leads',
        text: 'Every person who receives your card and shares their info appears here. Filter by Hot/Warm leads, add notes, and set follow-up reminders.',
        position: 'top'
    },
    {
        element: '.action-btn[onclick*="showAnalytics"]',
        title: 'Analytics Dashboard',
        text: 'See how your cards perform: total views, clicks on call/email/WhatsApp, and which cards get the most engagement.',
        position: 'top'
    },
    {
        element: '.action-btn[onclick*="showSettings"]',
        title: 'Settings & Cards',
        text: 'Manage your cards, enable notifications, check storage usage, and access all settings from here.',
        position: 'top'
    },
    {
        element: '#notifBtn',
        title: 'You\'re All Set!',
        text: 'Enable notifications to get instant alerts when someone taps your card. You can restart this tutorial anytime from Settings. Welcome aboard!',
        position: 'left'
    }
];
var currentTutorialStep = 0;
var tutorialEnabled = localStorage.getItem('tutorialEnabled') !== 'false';

function startTutorial() {
    currentTutorialStep = 0;
    document.getElementById('tutorialOverlay').classList.add('active');
    showTutorialStep(0);
}

function endTutorial() {
    document.getElementById('tutorialOverlay').classList.remove('active');
    localStorage.setItem('tutorialCompleted', 'true');
}

function showTutorialStep(stepIndex) {
    var step = tutorialSteps[stepIndex];
    if (!step) { endTutorial(); return; }

    var el = document.querySelector(step.element);
    var spotlight = document.getElementById('tutorialSpotlight');
    var tooltip = document.getElementById('tutorialTooltip');
    var arrow = document.getElementById('tutorialArrow');
    var backdrop = document.getElementById('tutorialBackdrop');

    document.getElementById('tutorialTitle').textContent = step.title;
    document.getElementById('tutorialText').textContent = step.text;

    // Update progress dots
    var progressHtml = '';
    for (var i = 0; i < tutorialSteps.length; i++) {
        var dotClass = 'tutorial-dot';
        if (i < stepIndex) dotClass += ' done';
        else if (i === stepIndex) dotClass += ' active';
        progressHtml += '<div class="'+dotClass+'"></div>';
    }
    document.getElementById('tutorialProgress').innerHTML = progressHtml;

    // Show/hide prev button
    document.getElementById('tutorialPrev').style.display = stepIndex > 0 ? 'inline-block' : 'none';

    // Update next button
    var nextBtn = document.getElementById('tutorialNext');
    if (stepIndex === tutorialSteps.length - 1) {
        nextBtn.textContent = 'Finish';
        nextBtn.className = 'tutorial-btn tutorial-btn-done';
    } else {
        nextBtn.textContent = 'Next';
        nextBtn.className = 'tutorial-btn tutorial-btn-next';
    }

    // Reset tooltip transform
    tooltip.style.transform = '';
    arrow.style.display = '';

    if (el) {
        var rect = el.getBoundingClientRect();
        var padding = 10;
        var spotLeft = rect.left - padding;
        var spotTop = rect.top - padding;
        var spotWidth = rect.width + padding * 2;
        var spotHeight = rect.height + padding * 2;

        // Position spotlight
        spotlight.style.left = spotLeft + 'px';
        spotlight.style.top = spotTop + 'px';
        spotlight.style.width = spotWidth + 'px';
        spotlight.style.height = spotHeight + 'px';
        spotlight.style.display = 'block';

        // Create cutout in backdrop using clip-path
        var vw = window.innerWidth;
        var vh = window.innerHeight;
        backdrop.style.clipPath = 'polygon(0 0, 100% 0, 100% 100%, 0 100%, 0 0, ' +
            spotLeft + 'px ' + spotTop + 'px, ' +
            spotLeft + 'px ' + (spotTop + spotHeight) + 'px, ' +
            (spotLeft + spotWidth) + 'px ' + (spotTop + spotHeight) + 'px, ' +
            (spotLeft + spotWidth) + 'px ' + spotTop + 'px, ' +
            spotLeft + 'px ' + spotTop + 'px)';

        // Position tooltip based on position preference
        arrow.className = 'tutorial-arrow ' + step.position;
        var tooltipRect = tooltip.getBoundingClientRect();
        var tooltipWidth = 300;

        switch (step.position) {
            case 'bottom':
                tooltip.style.top = (rect.bottom + 20) + 'px';
                tooltip.style.left = Math.max(16, Math.min(vw - tooltipWidth - 16, rect.left + rect.width/2 - tooltipWidth/2)) + 'px';
                tooltip.style.bottom = 'auto';
                tooltip.style.right = 'auto';
                break;
            case 'top':
                tooltip.style.top = 'auto';
                tooltip.style.bottom = (vh - rect.top + 20) + 'px';
                tooltip.style.left = Math.max(16, Math.min(vw - tooltipWidth - 16, rect.left + rect.width/2 - tooltipWidth/2)) + 'px';
                tooltip.style.right = 'auto';
                break;
            case 'left':
                tooltip.style.top = Math.max(16, rect.top) + 'px';
                tooltip.style.right = (vw - rect.left + 20) + 'px';
                tooltip.style.left = 'auto';
                tooltip.style.bottom = 'auto';
                break;
            case 'right':
                tooltip.style.top = Math.max(16, rect.top) + 'px';
                tooltip.style.left = (rect.right + 20) + 'px';
                tooltip.style.right = 'auto';
                tooltip.style.bottom = 'auto';
                break;
        }
    } else {
        // Center tooltip if element not found
        spotlight.style.display = 'none';
        backdrop.style.clipPath = '';
        tooltip.style.top = '50%';
        tooltip.style.left = '50%';
        tooltip.style.right = 'auto';
        tooltip.style.bottom = 'auto';
        tooltip.style.transform = 'translate(-50%, -50%)';
        arrow.style.display = 'none';
    }
}

function nextTutorialStep() {
    if (currentTutorialStep >= tutorialSteps.length - 1) {
        endTutorial();
    } else {
        currentTutorialStep++;
        showTutorialStep(currentTutorialStep);
    }
}

function prevTutorialStep() {
    if (currentTutorialStep > 0) {
        currentTutorialStep--;
        showTutorialStep(currentTutorialStep);
    }
}

// Tutorial available via Settings > Restart Tutorial
// (auto-start disabled for smoother experience)

// ── Pull to Refresh ──
(function(){
    var ptr = document.getElementById('ptrIndicator');
    var startY = 0, pulling = false, threshold = 80;
    var mc = document.getElementById('mainContent');

    document.addEventListener('touchstart', function(e) {
        var scrollTop = mc ? mc.scrollTop : window.scrollY;
        if (scrollTop === 0 && e.touches.length === 1) {
            startY = e.touches[0].clientY;
            pulling = true;
        }
    }, {passive: true});

    document.addEventListener('touchmove', function(e) {
        if (!pulling || startY === 0) return;
        var diff = e.touches[0].clientY - startY;
        if (diff > 10 && diff < 150) {
            ptr.classList.add('show');
            ptr.classList.toggle('pulling', diff > threshold);
            ptr.style.transform = 'translateX(-50%) translateY(' + Math.min(diff * 0.4, 35) + 'px)';
        }
    }, {passive: true});

    document.addEventListener('touchend', function(e) {
        if (!pulling) return;
        var diff = (e.changedTouches[0]?.clientY || 0) - startY;
        if (diff > threshold) {
            ptr.classList.remove('pulling');
            ptr.classList.add('refreshing');
            setTimeout(function(){ location.reload(); }, 300);
        } else {
            ptr.classList.remove('show', 'pulling');
            ptr.style.transform = '';
        }
        pulling = false;
        startY = 0;
    }, {passive: true});
})();
</script>

<!-- Card Preview Modal -->
<div class="preview-modal" id="previewModal" onclick="if(event.target===this)closePreview()">
    <div class="preview-phone">
        <iframe id="previewFrame" class="preview-iframe"></iframe>
        <button class="preview-close" onclick="closePreview()">&times;</button>
        <div class="preview-actions">
            <button class="preview-action-btn" onclick="openInNewTab()">Open in new tab</button>
        </div>
    </div>
</div>

<!-- Install Modal -->
<div class="install-modal" id="installModal" onclick="if(event.target===this)closeInstallModal()">
    <div class="install-modal-content" id="installModalContent"></div>
</div>


</body>
</html>
