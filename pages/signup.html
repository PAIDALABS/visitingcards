<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Sign Up — CardFlow</title>
    <meta name="description" content="Create your free CardFlow account and start sharing NFC-powered digital business cards with lead capture and analytics in minutes.">
    <link rel="icon" type="image/svg+xml" href="/cardflow_logo_icon.svg">
    <script>(function(){var t=localStorage.getItem('token');if(t)fetch('/api/auth/me',{headers:{Authorization:'Bearer '+t}}).then(function(r){if(r.ok)window.location.replace('/dashboard');else localStorage.removeItem('token')}).catch(function(){})})()</script>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#FAFBFC">
    <script>(function(){var t=localStorage.getItem('cardflow-theme');if(!t&&window.matchMedia&&window.matchMedia('(prefers-color-scheme:dark)').matches)t='dark';if(t==='dark')document.documentElement.setAttribute('data-theme','dark');})()</script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://accounts.google.com">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"></noscript>
    <link rel="stylesheet" href="/theme.css">
    <link rel="stylesheet" href="/auth.css">
    <script src="/theme.js" defer></script>
    <script src="/api/client-config"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        .username-wrapper{position:relative}
        .username-prefix{position:absolute;left:16px;top:50%;transform:translateY(-50%);color:var(--text-muted);font-size:14px;pointer-events:none}
        .username-wrapper input{padding-left:120px}
        .username-status{font-size:12px;margin-top:4px;min-height:18px}
        .username-status.available{color:var(--success)}
        .username-status.taken{color:var(--danger)}
        .username-status.checking{color:var(--text-muted)}
        .form-hint{font-size:12px;color:var(--text-muted);margin-top:4px}
        .setup-note{background:var(--accent-subtle);border:1px solid var(--accent-glow);color:var(--accent-light);padding:10px 14px;border-radius:8px;font-size:13px;margin-bottom:16px}
        .referral-banner{background:linear-gradient(135deg,var(--accent-subtle),var(--accent-surface));border:1px solid var(--accent-glow);color:var(--accent-light);padding:14px;border-radius:10px;font-size:13px;margin-bottom:16px;text-align:center;line-height:1.5}
        .referral-banner strong{color:var(--text-primary);display:block;margin-bottom:4px;font-size:14px}
    </style>
</head>
<body>
<div class="auth-container">
    <div class="auth-logo">
        <a href="/landing" style="text-decoration:none;color:inherit"><h1>CardFlow</h1></a>
        <p>Your professional card, one tap away</p>
    </div>
    <div class="auth-card">
        <h2 id="formTitle">Get started for free</h2>
        <div id="setupNote" class="setup-note hidden">
            Almost there! Just pick a username to complete your account setup.
        </div>
        <div style="background:var(--accent-subtle);border:1px solid var(--accent-glow);border-radius:10px;padding:12px 16px;margin-bottom:16px;font-size:13px;color:var(--accent-light)">
    <span style="font-weight:600">Free forever</span> — Create your card, share via NFC or link, capture leads automatically.
</div>
        <div id="errorMsg" class="error-msg"></div>
        <div id="referralBanner" class="referral-banner hidden"></div>

        <form onsubmit="handleSignup(event); return false;">
        <!-- Full signup form (hidden in setup mode) -->
        <div id="emailFields">
            <div class="form-group">
                <label for="name">Full Name</label>
                <input type="text" id="name" placeholder="Your full name" required autocomplete="name">
            </div>
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" placeholder="you@example.com" required autocomplete="email">
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <div class="pw-wrapper">
                    <input type="password" id="password" placeholder="Min 8 characters" required minlength="8" maxlength="128" autocomplete="new-password">
                    <button type="button" class="pw-toggle" onclick="togglePw(this)" aria-label="Show password">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                    </button>
                </div>
                <div id="pwStrength" style="margin-top:6px;display:none">
                    <div style="display:flex;gap:4px;margin-bottom:4px">
                        <div class="pw-bar" style="flex:1;height:3px;border-radius:2px;background:var(--border);transition:background .2s"></div>
                        <div class="pw-bar" style="flex:1;height:3px;border-radius:2px;background:var(--border);transition:background .2s"></div>
                        <div class="pw-bar" style="flex:1;height:3px;border-radius:2px;background:var(--border);transition:background .2s"></div>
                        <div class="pw-bar" style="flex:1;height:3px;border-radius:2px;background:var(--border);transition:background .2s"></div>
                    </div>
                    <div id="pwStrengthText" style="font-size:11px;color:var(--text-muted)"></div>
                </div>
            </div>
        </div>

        <!-- Username field (always visible) -->
        <div class="form-group">
            <label for="username">Username</label>
            <div class="username-wrapper">
                <span class="username-prefix" id="usernamePrefix">cardflow.cloud/</span>
                <input type="text" id="username" placeholder="yourname" required autocomplete="off" pattern="(?=.*[a-z0-9])[a-z0-9._\-]{3,30}">
            </div>
            <div id="usernameStatus" class="username-status"></div>
            <div class="form-hint">3-30 characters. Letters, numbers, dots, hyphens, underscores.</div>
        </div>

        <button type="submit" class="btn-primary" id="signupBtn">Create Account</button>
        <p style="font-size:12px;color:var(--text-muted,#64748b);text-align:center;margin-top:12px">By creating an account, you agree to our <a href="/legal/terms" style="color:#5a5cc6">Terms of Service</a> and <a href="/legal/privacy" style="color:#5a5cc6">Privacy Policy</a>.</p>
        </form>

        <div id="googleSection">
            <div class="divider">or</div>
            <button class="btn-google" onclick="handleGoogleSignup()" id="googleBtn">
                <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.27-4.74 3.27-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                Sign up with Google
            </button>
        </div>
    </div>
    <div class="auth-footer">
        Already have an account? <a href="login">Sign in</a>
    </div>
</div>

<script src="/common.js"></script>
<script>
// Password strength meter
(function() {
    var pwInput = document.getElementById('password');
    if (!pwInput) return;
    pwInput.addEventListener('input', function() {
        var v = pwInput.value;
        var wrap = document.getElementById('pwStrength');
        if (!v) { wrap.style.display = 'none'; return; }
        wrap.style.display = 'block';
        var score = 0;
        if (v.length >= 6) score++;
        if (v.length >= 10) score++;
        if (/[A-Z]/.test(v) && /[a-z]/.test(v)) score++;
        if (/[0-9]/.test(v) && /[^a-zA-Z0-9]/.test(v)) score++;
        var colors = ['#ef4444','#f59e0b','#eab308','#22c55e'];
        var labels = ['Weak','Fair','Good','Strong'];
        var bars = wrap.querySelectorAll('.pw-bar');
        for (var i = 0; i < bars.length; i++) {
            bars[i].style.background = i < score ? colors[score - 1] : 'var(--border)';
        }
        document.getElementById('pwStrengthText').textContent = labels[score - 1] || '';
        document.getElementById('pwStrengthText').style.color = colors[score - 1] || 'var(--text-muted)';
    });
})();

var RESERVED_USERNAMES = [
    'admin','login','signup','pricing','landing','api','www','app',
    'help','support','billing','settings','dashboard','account',
    'cards','leads','analytics','nfc','qr','public','static','assets',
    'sw','manifest','icons','favicon','robots','sitemap','functions',
    'reset','password','reset-password','terms','privacy','cookies',
    'refund','disclaimer','about','contact','blog','news','status',
    'events','e','booth','booth-setup','badge','exhibitor','super-admin'
];

var searchParams = new URLSearchParams(window.location.search);
var isSetupMode = searchParams.get('setup') === '1';
var referralCode = searchParams.get('ref') || '';
var usernameAvailable = false;
var usernameCheckTimeout = null;

// Validate referral code
if (referralCode && !isSetupMode) {
    fetch('/api/public/referral/' + encodeURIComponent(referralCode))
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.valid) {
                var banner = document.getElementById('referralBanner');
                banner.innerHTML = '<strong>Invited by ' + escapeHtml(data.referrerName || 'a friend') + '</strong>Sign up and you both get 1 free month of Pro!';
                banner.classList.remove('hidden');
            } else {
                referralCode = '';
            }
        })
        .catch(function() { referralCode = ''; });
}

// Setup mode: Google user already authenticated, just needs username
if (isSetupMode) {
    document.getElementById('emailFields').classList.add('hidden');
    document.getElementById('googleSection').classList.add('hidden');
    document.getElementById('setupNote').classList.remove('hidden');
    document.getElementById('formTitle').textContent = 'Choose your username';
    document.getElementById('signupBtn').textContent = 'Complete Setup';
} else {
    // Normal signup - redirect if already logged in
    if (localStorage.getItem('token')) {
        fetch('/api/auth/me', {
            headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
        }).then(function(r) {
            if (r.ok) window.location.href = 'dashboard';
            else { localStorage.removeItem('token'); localStorage.removeItem('user'); }
        }).catch(function() {
            localStorage.removeItem('token'); localStorage.removeItem('user');
        });
    }
}

// Username validation & availability check
document.getElementById('username').addEventListener('input', function() {
    var val = this.value.toLowerCase().replace(/[^a-z0-9._\-]/g, '');
    this.value = val;
    usernameAvailable = false;

    var statusEl = document.getElementById('usernameStatus');
    if (val.length < 3) {
        statusEl.textContent = val.length > 0 ? 'Username must be at least 3 characters' : '';
        statusEl.className = 'username-status';
        return;
    }
    if (val.length > 30) {
        statusEl.textContent = 'Username must be 30 characters or less';
        statusEl.className = 'username-status taken';
        return;
    }
    if (RESERVED_USERNAMES.indexOf(val) !== -1) {
        statusEl.textContent = 'This username is reserved';
        statusEl.className = 'username-status taken';
        return;
    }

    statusEl.textContent = 'Checking...';
    statusEl.className = 'username-status checking';

    clearTimeout(usernameCheckTimeout);
    usernameCheckTimeout = setTimeout(function() {
        fetch('/api/public/check-username/' + val)
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (document.getElementById('username').value !== val) return;
                if (data.available) {
                    statusEl.textContent = 'Username is available!';
                    statusEl.className = 'username-status available';
                    usernameAvailable = true;
                } else {
                    statusEl.textContent = 'Username is taken';
                    statusEl.className = 'username-status taken';
                    usernameAvailable = false;
                }
            })
            .catch(function() {
                statusEl.textContent = 'Could not check availability';
                statusEl.className = 'username-status';
            });
    }, 400);
});

function showError(msg) {
    var el = document.getElementById('errorMsg');
    el.textContent = msg;
    el.classList.add('show');
}
function hideError() {
    document.getElementById('errorMsg').classList.remove('show');
}

function handleSignup(e) {
    if (e) e.preventDefault();
    hideError();
    var username = document.getElementById('username').value.trim().toLowerCase();

    if (!username || username.length < 3) {
        showError('Please choose a username (at least 3 characters).');
        return;
    }
    if (!usernameAvailable) {
        showError('Please choose an available username.');
        return;
    }

    var btn = document.getElementById('signupBtn');
    btn.disabled = true;
    btn.textContent = isSetupMode ? 'Setting up...' : 'Creating account...';

    if (isSetupMode) {
        // Google user just needs to complete setup with username
        var googleCredential = localStorage.getItem('googleCredential');
        if (!googleCredential) {
            showError('Session expired. Please sign in again.');
            window.location.href = 'login';
            return;
        }

        var setupBody = { idToken: googleCredential, username: username };
        if (referralCode) setupBody.referralCode = referralCode;
        try { var cfVid2 = localStorage.getItem('cf_vid'); if (cfVid2) setupBody.visitorId = cfVid2; } catch(e) {}

        fetch('/api/auth/google', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(setupBody)
        })
        .then(function(r) { return r.json().then(function(d) { return { ok: r.ok, data: d }; }); })
        .then(function(result) {
            if (result.ok && result.data.token) {
                localStorage.removeItem('googleCredential');
                localStorage.setItem('token', result.data.token);
                localStorage.setItem('user', JSON.stringify(result.data.user));
                window.location.href = 'dashboard';
            } else {
                btn.disabled = false;
                btn.textContent = 'Complete Setup';
                showError(result.data.error || 'Failed to create profile.');
            }
        })
        .catch(function() {
            btn.disabled = false;
            btn.textContent = 'Complete Setup';
            showError('Failed to create profile. Please try again.');
        });
        return;
    }

    // Normal email/password signup
    var name = document.getElementById('name').value.trim();
    var email = document.getElementById('email').value.trim();
    var password = document.getElementById('password').value;

    if (!name) { showError('Please enter your name.'); btn.disabled = false; btn.textContent = 'Create Account'; return; }
    if (!email) { showError('Please enter your email.'); btn.disabled = false; btn.textContent = 'Create Account'; return; }
    if (password.length < 8) { showError('Password must be at least 8 characters.'); btn.disabled = false; btn.textContent = 'Create Account'; return; }
    if (password.length > 128) { showError('Password must be at most 128 characters.'); btn.disabled = false; btn.textContent = 'Create Account'; return; }

    var signupBody = { email: email, password: password, name: name, username: username };
    if (referralCode) signupBody.referralCode = referralCode;
    try { var cfVid = localStorage.getItem('cf_vid'); if (cfVid) signupBody.visitorId = cfVid; } catch(e) {}

    fetch('/api/auth/signup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(signupBody)
    })
    .then(function(r) { return r.json().then(function(d) { return { ok: r.ok, data: d }; }); })
    .then(function(result) {
        if (result.ok && result.data.token) {
            localStorage.setItem('token', result.data.token);
            localStorage.setItem('user', JSON.stringify(result.data.user));
            window.location.href = 'dashboard';
        } else {
            btn.disabled = false;
            btn.textContent = 'Create Account';
            showError(result.data.error || 'Signup failed. Please try again.');
        }
    })
    .catch(function() {
        btn.disabled = false;
        btn.textContent = 'Create Account';
        showError('Signup failed. Please try again.');
    });
}

function togglePw(btn) {
    var input = btn.parentElement.querySelector('input');
    var show = input.type === 'password';
    input.type = show ? 'text' : 'password';
    btn.innerHTML = show
        ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>'
        : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>';
    btn.setAttribute('aria-label', show ? 'Hide password' : 'Show password');
}

// Auto-focus first input on desktop only (mobile keyboard opens on autofocus and disrupts layout)
if (window.innerWidth > 600) {
    if (isSetupMode) {
        document.getElementById('username').focus();
    } else {
        document.getElementById('name').focus();
    }
}

function handleGoogleSignup() {
    if (typeof google === 'undefined' || !google.accounts) {
        showError('Google Sign-In is still loading. Please wait a moment and try again.');
        return;
    }
    hideError();
    var username = document.getElementById('username').value.trim().toLowerCase();
    if (!username || username.length < 3) {
        showError('Please choose a username first.');
        return;
    }
    if (!usernameAvailable) {
        showError('Please choose an available username.');
        return;
    }

    var btn = document.getElementById('googleBtn');
    btn.disabled = true;

    try {
    google.accounts.id.initialize({
        client_id: window.GOOGLE_CLIENT_ID,
        callback: function(response) {
            var googleBody = { idToken: response.credential, username: username };
            if (referralCode) googleBody.referralCode = referralCode;
            fetch('/api/auth/google', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(googleBody)
            })
            .then(function(r) { return r.json().then(function(d) { return { ok: r.ok, data: d }; }); })
            .then(function(result) {
                if (result.ok && result.data.token) {
                    localStorage.setItem('token', result.data.token);
                    localStorage.setItem('user', JSON.stringify(result.data.user));
                    window.location.href = 'dashboard';
                } else {
                    btn.disabled = false;
                    showError(result.data.error || 'Google sign-up failed.');
                }
            })
            .catch(function() {
                btn.disabled = false;
                showError('Google sign-up failed. Please try again.');
            });
        }
    });

    google.accounts.id.prompt(function(notification) {
        if (notification.isNotDisplayed() || notification.isSkippedMoment()) {
            btn.disabled = false;
        }
    });
    } catch(err) {
        btn.disabled = false;
        showError('Google Sign-In failed to initialize. Please try again.');
    }
}

// Set username prefix to current domain
var _pfx = document.getElementById('usernamePrefix');
if (_pfx) _pfx.textContent = location.host + '/';

// Hide Google button if client ID not configured
if (!window.GOOGLE_CLIENT_ID) {
    var googleSection = document.getElementById('googleSection');
    if (googleSection) googleSection.style.display = 'none';
}
</script>
</body>
</html>
