<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>CardFlow Dashboard</title>
    <meta name="description" content="Manage your digital business cards, leads, analytics, and NFC settings from your CardFlow dashboard.">
    <link rel="icon" type="image/svg+xml" href="/cardflow_logo_icon.svg">
    <!-- iOS PWA -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CardFlow">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#FAFBFC">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="apple-touch-startup-image" href="apple-touch-icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"></noscript>
    <link rel="stylesheet" href="/theme.css">
    <link rel="stylesheet" href="/dashboard.css">
    <style>
    /* Critical CSS — loading screen paints without waiting for dashboard.css */
    #loadingScreen{position:fixed;inset:0;z-index:99999;background:var(--bg-base);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:24px;transition:opacity 0.3s ease}
    #loadingScreen.fade-out{opacity:0;pointer-events:none}
    .loading-logo{font-size:28px;font-weight:700;background:linear-gradient(135deg,var(--accent),var(--accent-light));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
    .loading-spinner{width:32px;height:32px;border:3px solid var(--bg-elevated);border-top-color:var(--accent);border-radius:50%;animation:lspin 0.8s linear infinite}
    @keyframes lspin{to{transform:rotate(360deg)}}
    </style>
    <script>(function(){var t=localStorage.getItem('cardflow-theme');if(!t&&window.matchMedia&&window.matchMedia('(prefers-color-scheme:dark)').matches)t='dark';if(t==='dark')document.documentElement.setAttribute('data-theme','dark');})()</script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js" integrity="sha384-lQXOAyZwHXE55JFyrOMB7nY2Wv+m5ZWNtJcHrd1rceRQXAYNLak8ukN5TjBTcIwz" crossorigin="anonymous" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js" integrity="sha384-9Q0jWoineiIq95JeIyBsNV90KKLfDsbkj29k/YFxf76a2JwkHDYkMuSbNGN6XJfV" crossorigin="anonymous" defer></script>
    <script src="/theme.js" defer></script>
    <script>
    // Debug logging (enable with ?debug=1)
    var CF_DEBUG = location.search.indexOf('debug=1') !== -1;
    function cfLog(tag, msg, data) {
        if (!CF_DEBUG) return;
        var ts = new Date().toISOString().substr(11, 12);
        console.log('[CF ' + ts + '] [' + tag + '] ' + msg, data || '');
    }

    // JWT Auth - replaces Firebase Auth
    var authToken = localStorage.getItem('token');
    var currentUser = null;
    var currentUserProfile = null;

    // Auth helper: fetch with JWT token
    // NOTE: This inline apiFetch is needed before common.js loads for the auth boot sequence.
    // common.js defines an identical apiFetch that overwrites this one once loaded.
    function apiFetch(path, options) {
        options = options || {};
        var noRedirect = options.noRedirect;
        delete options.noRedirect;
        options.headers = options.headers || {};
        var token = localStorage.getItem('token');
        if (token) options.headers['Authorization'] = 'Bearer ' + token;
        if (options.body && typeof options.body === 'object' && !(options.body instanceof FormData)) {
            options.headers['Content-Type'] = 'application/json';
            options.body = JSON.stringify(options.body);
        }
        return fetch('/api' + path, options).then(function(r) {
            if (r.status === 401 && !noRedirect) { localStorage.removeItem('token'); localStorage.removeItem('user'); location.href = '/login'; }
            return r;
        });
    }

    // Safety timeout — never stay stuck on loader for more than 8 seconds
    setTimeout(function() {
        var ls = document.getElementById('loadingScreen');
        if (ls) { ls.classList.add('fade-out'); setTimeout(function(){ ls.remove(); }, 300); }
        var ac = document.getElementById('appContainer');
        if (ac) { ac.style.display = ''; ac.classList.add('visible'); }
    }, 8000);

    // Redirect to login if not authenticated
    if (!authToken) {
        window.location.href = 'login';
    } else {
        fetch('/api/auth/me', {
            headers: { 'Authorization': 'Bearer ' + authToken }
        }).then(function(r) {
            if (r.status === 401 || r.status === 403) {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = 'login';
                throw new Error('unauthorized');
            }
            return r.json();
        }).then(function(profile) {
            if (!profile || profile.error) {
                localStorage.removeItem('token');
                window.location.href = 'login';
                return;
            }
            if (!profile.username) {
                window.location.href = 'signup?setup=1';
                return;
            }
            currentUser = { uid: profile.id, email: profile.email };
            currentUserProfile = profile;
            initApp();
        }).catch(function(err) {
            if (err.message === 'unauthorized') return;
            console.error('Failed to load profile:', err);
            // Show error screen instead of blank page
            var ls = document.getElementById('loadingScreen');
            if (ls) {
                ls.innerHTML = '<div style="text-align:center;padding:40px 20px">' +
                    '<div style="font-size:20px;font-weight:600;color:var(--text-primary);margin-bottom:12px">Connection Error</div>' +
                    '<div style="font-size:14px;color:var(--text-secondary);margin-bottom:24px;line-height:1.5">Could not reach the server.<br>Check your connection and try again.</div>' +
                    '<button onclick="location.reload()" style="background:var(--accent);color:#fff;border:none;padding:12px 28px;border-radius:12px;font-size:14px;font-weight:600;cursor:pointer">Retry</button>' +
                    '</div>';
            }
        });
    }

    function initApp() {
        try {
        var ac = document.getElementById('appContainer');
        ac.style.display = '';
        requestAnimationFrame(function(){ ac.classList.add('visible'); });
        var ls = document.getElementById('loadingScreen');
        if (ls) { ls.classList.add('fade-out'); setTimeout(function(){ ls.remove(); }, 300); }
        initCardElements();
        loadCardsFromFirebase();
        loadDefaultCard();
        loadTapLog();
        startListeningForTaps();
        startListeningForLeads();
        setInterval(checkPendingTap, 15000); // refresh tap log every 15s
        setInterval(checkReviewQueue, 300000);
        updateNotifUI();
        // Re-register push subscription on init if notifications already granted
        if ('Notification' in window && Notification.permission === 'granted') {
            subscribeToPush();
        }
        updateStatusBadges();
        updateInstallButton();
        // Silent token refresh every 6 hours
        setInterval(function() {
            apiFetch('/auth/refresh', { method: 'POST' })
                .then(function(r) { return r.json(); })
                .then(function(d) { if (d && d.token) localStorage.setItem('token', d.token); })
                .catch(function() {});
        }, 6 * 60 * 60 * 1000);
        // Session timeout after 8 hours of inactivity
        var _lastActivity = Date.now();
        ['click','keydown','scroll','touchstart'].forEach(function(evt) {
            document.addEventListener(evt, function() { _lastActivity = Date.now(); }, { passive: true });
        });
        setInterval(function() {
            if (Date.now() - _lastActivity > 8 * 60 * 60 * 1000) {
                localStorage.removeItem('token');
                window.location.href = '/login';
            }
        }, 60 * 1000);
        setTimeout(generateQR, 100);
        updateQsBadge();
        updateNfcBadge();
        updateNfcFab();
        setTimeout(function() {
            if (!isInStandaloneMode() && !localStorage.getItem('installModalDismissed')) {
                showInstallModal();
            }
        }, 3000);
        // Show user name in UI
        var userNameEl = document.getElementById('userName');
        if (userNameEl && currentUserProfile) {
            userNameEl.textContent = currentUserProfile.name || currentUser.email;
        }
        // Update plan label
        var planLabel = document.getElementById('currentPlanLabel');
        if (planLabel && currentUserProfile) {
            var plan = currentUserProfile.plan || 'free';
            planLabel.textContent = plan.charAt(0).toUpperCase() + plan.slice(1) + ' plan';
        }
        // Update password settings label
        updatePasswordSettingsLabel();
        // Populate sidebar user info
        var sidebarName = document.getElementById('sidebarUserName');
        if (sidebarName && currentUserProfile) {
            sidebarName.textContent = currentUserProfile.username || currentUserProfile.name || currentUser.email;
        }
        var sidebarBadge = document.getElementById('sidebarPlanBadge');
        if (sidebarBadge && currentUserProfile) {
            var sPlan = currentUserProfile.plan || 'free';
            sidebarBadge.textContent = sPlan.charAt(0).toUpperCase() + sPlan.slice(1);
        }
        // Impersonation (admin-only: token must contain impersonatedBy claim)
        var urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('impersonate')) {
            try {
                var impToken = urlParams.get('impersonate');
                var impPayload = JSON.parse(atob(impToken.split('.')[1]));
                if (impPayload.impersonatedBy) {
                    localStorage.setItem('token', impToken);
                    authToken = impToken;
                    window.history.replaceState({}, '', '/dashboard');
                    location.reload();
                    return;
                }
            } catch(e) {}
            // Invalid impersonation token — strip param and continue
            window.history.replaceState({}, '', '/dashboard');
        }
        // Show impersonation warning if token contains impersonation
        (function checkImpersonation() {
            try {
                var tkn = localStorage.getItem('token');
                if (!tkn) return;
                var payload = JSON.parse(atob(tkn.split('.')[1]));
                if (payload.impersonatedBy) {
                    var banner = document.createElement('div');
                    banner.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:99999;background:#ef4444;color:#fff;text-align:center;padding:8px 16px;font-size:13px;font-weight:600';
                    banner.textContent = 'You are impersonating this user. Close this tab to return to admin.';
                    document.body.prepend(banner);
                }
            } catch(e) {}
        })();
        // Announcements banner
        fetch('/api/public/announcements').then(function(r){ return r.json(); }).then(function(d) {
            if (!d.announcements || d.announcements.length === 0) return;
            var dismissed = JSON.parse(localStorage.getItem('dismissedAnnouncements') || '[]');
            d.announcements.forEach(function(a) {
                if (dismissed.indexOf(a.id) !== -1) return;
                var colors = { info:'#6366f1', warning:'#f59e0b', success:'#10b981', error:'#ef4444' };
                var banner = document.createElement('div');
                banner.style.cssText = 'background:' + (colors[a.type] || '#6366f1') + '22;border:1px solid ' + (colors[a.type] || '#6366f1') + '44;border-radius:10px;padding:12px 16px;margin:0 0 12px;display:flex;justify-content:space-between;align-items:center;font-size:13px;color:#f8fafc';
                banner.innerHTML = '<div><strong>' + (a.title||'').replace(/</g,'&lt;') + '</strong> &mdash; ' + (a.body||'').replace(/</g,'&lt;') + '</div>' +
                    '<button onclick="this.parentElement.remove();var d=JSON.parse(localStorage.getItem(\'dismissedAnnouncements\')||\'[]\');d.push(' + a.id + ');localStorage.setItem(\'dismissedAnnouncements\',JSON.stringify(d))" style="background:none;border:none;color:#fff;font-size:18px;cursor:pointer;padding:0 4px">&times;</button>';
                var container = document.getElementById('appContainer');
                if (container && container.firstElementChild) container.firstElementChild.prepend(banner);
            });
        }).catch(function(){});
        // Navigate to dashboard
        navigateTo('dashboard');
        } catch(e) {
            console.error('initApp error:', e);
            var ls2 = document.getElementById('loadingScreen');
            if (ls2) { ls2.classList.add('fade-out'); setTimeout(function(){ ls2.remove(); }, 300); }
            var ac2 = document.getElementById('appContainer');
            if (ac2) { ac2.style.display = ''; ac2.classList.add('visible'); }
        }
    }

    function logout() {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.href = 'login';
    }
    </script>
</head>
<body>
<div id="loadingScreen">
    <div class="loading-logo">CardFlow</div>
    <div class="loading-spinner"></div>
</div>
<div id="appContainer" style="display:none">
    <!-- NFC Overlay Screens (high z-index, stay full-screen) -->
    <div id="picker" class="screen hidden">
        <div class="pick-alert">NEW TAP</div>
        <div class="pick-title">Someone tapped your card!</div>
        <div class="pick-visitor" id="visitor-info"></div>
        <div class="pick-cards" id="pickerCards"></div>
        <button class="skip-btn" onclick="skipCard()">Skip — Don't share a card</button>
    </div>

    <div id="sent" class="screen hidden">
        <div class="check"><svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg></div>
        <h2>Card sent!</h2>
        <div class="sent-sub" id="sent-detail"></div>
        <div class="sent-auto" id="sent-auto"></div>
        <div id="lead-display"></div>
        <div class="return-progress" id="returnProgress"><div class="return-progress-bar"></div></div>
        <div class="return-text" id="returnText">Returning to dashboard...</div>
        <button class="idle-btn leads-btn" style="margin-top:16px" onclick="goBackNow()">Back now</button>
    </div>

    <!-- ═══ APP SHELL ═══ -->
    <div class="app-shell">
        <!-- Sidebar (desktop/tablet) -->
        <aside class="sidebar">
            <a href="/dashboard" class="sidebar-brand" style="text-decoration:none" onclick="event.preventDefault();navigateTo('dashboard')">
                <div class="sidebar-brand-icon"><svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V6h16v12zM6 10h2v2H6zm0 4h8v2H6zm10 0h2v2h-2zm-6-4h8v2h-8z"/></svg></div>
                <span class="sidebar-brand-name">CardFlow</span>
            </a>
            <nav class="sidebar-nav">
                <button class="nav-item active" onclick="navigateTo('dashboard')" title="Dashboard">
                    <svg viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>
                    <span class="nav-item-label">Dashboard</span>
                </button>
                <button class="nav-item" onclick="navigateTo('cards')" title="Cards">
                    <svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V6h16v12zM6 10h2v2H6zm0 4h8v2H6zm10 0h2v2h-2zm-6-4h8v2h-8z"/></svg>
                    <span class="nav-item-label">Cards</span>
                </button>
                <button class="nav-item" onclick="navigateTo('analytics')" title="Analytics">
                    <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>
                    <span class="nav-item-label">Analytics</span>
                </button>
                <button class="nav-item" onclick="navigateTo('settings')" title="Settings">
                    <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                    <span class="nav-item-label">Settings</span>
                </button>
            </nav>
            <div class="sidebar-user">
                <div class="sidebar-user-info">
                    <div class="sidebar-user-name" id="sidebarUserName">User</div>
                    <div class="sidebar-plan-badge" id="sidebarPlanBadge">Free</div>
                </div>
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
                    <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg>
                    <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
                </button>
                <button class="sidebar-signout" onclick="logout()" title="Sign out">
                    <svg viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
                </button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="main-content" id="mainContent">

            <!-- ═══ DASHBOARD PAGE ═══ -->
            <div class="page active" id="page-dashboard">
                <div class="page-header" style="flex-direction:column;align-items:flex-start;gap:4px">
                    <div style="display:flex;align-items:center;justify-content:space-between;width:100%">
                        <h1 id="dashGreeting" style="font-size:22px">Dashboard</h1>
                        <div style="display:flex;align-items:center;gap:8px">
                            <span id="dashPlanBadge" style="font-size:11px;font-weight:700;padding:4px 10px;border-radius:20px;background:rgba(99,102,241,.15);color:#818cf8;text-transform:uppercase;letter-spacing:.5px">Free</span>
                            <div class="status-icon" id="notifBtn" onclick="requestNotif()" style="width:36px;height:36px;border-radius:10px">
                                <svg viewBox="0 0 24 24" style="width:20px;height:20px"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg>
                                <span class="status-dot" id="notifDot"></span>
                            </div>
                        </div>
                    </div>
                    <div id="leadUsageBar" style="display:none;width:100%">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:3px">
                            <span style="font-size:11px;color:var(--text-muted)">Leads this month</span>
                            <span id="leadUsageText" style="font-size:11px;color:var(--text-muted)">0 / 25</span>
                        </div>
                        <div style="height:4px;background:rgba(255,255,255,.08);border-radius:2px;overflow:hidden">
                            <div id="leadUsageFill" style="height:100%;width:0%;background:linear-gradient(90deg,#6366f1,#8b5cf6);border-radius:2px;transition:width .5s ease"></div>
                        </div>
                        <div id="leadUsageWarning" style="display:none;margin-top:4px;font-size:11px;color:#f59e0b"></div>
                    </div>
                </div>

                <!-- Stats Row -->
                <div class="stats-row">
                    <div class="stat-card">
                        <div class="stat-card-icon" style="background:rgba(99,102,241,.15);color:#818cf8"><svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></div>
                        <div class="stat-card-value" id="dashLeadCount"><div class="skeleton" style="width:40px;height:28px;display:inline-block"></div></div>
                        <div class="stat-card-label">Total Leads</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-icon" style="background:rgba(74,222,128,.15);color:#4ade80"><svg viewBox="0 0 24 24"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg></div>
                        <div class="stat-card-value" id="dashTapsToday"><div class="skeleton" style="width:40px;height:28px;display:inline-block"></div></div>
                        <div class="stat-card-label">Taps Today</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card-icon" style="background:rgba(251,191,36,.15);color:#fbbf24"><svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V6h16v12z"/></svg></div>
                        <div class="stat-card-value" id="dashCardCount"><div class="skeleton" style="width:40px;height:28px;display:inline-block"></div></div>
                        <div class="stat-card-label">Active Cards</div>
                    </div>
                </div>

                <!-- Getting Started Checklist -->
                <div class="onboarding-checklist" id="gettingStarted" style="display:none">
                    <div class="checklist-header">
                        <span class="checklist-title">Getting Started</span>
                        <button class="checklist-dismiss" onclick="dismissChecklist()">Dismiss</button>
                    </div>
                    <div class="checklist-progress">
                        <div class="checklist-progress-bar"><div class="checklist-progress-fill" id="checklistFill" style="width:0%"></div></div>
                        <span class="checklist-progress-text" id="checklistProgressText">0 of 5</span>
                    </div>
                    <div id="checklistItems"></div>
                </div>

                <!-- Quick Actions -->
                <div class="dash-quick-actions" style="display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap">
                    <button onclick="openScanCardsModal()" style="display:flex;align-items:center;gap:8px;padding:10px 16px;background:rgba(74,222,128,.1);border:1.5px solid rgba(74,222,128,.3);border-radius:12px;color:#4ade80;font-family:inherit;font-size:13px;font-weight:600;cursor:pointer;transition:all .15s">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="#4ade80"><path d="M9.5 6.5v3h-3v-3h3M11 5H5v6h6V5zm-1.5 9.5v3h-3v-3h3M11 13H5v6h6v-6zm6.5-6.5v3h-3v-3h3M19 5h-6v6h6V5zm-6 8h1.5v1.5H13V13zm1.5 1.5H16V16h-1.5v-1.5zM16 13h1.5v1.5H16V13zm-3 3h1.5v1.5H13V16zm1.5 1.5H16V19h-1.5v-1.5zM16 16h1.5v1.5H16V16zm1.5-1.5H19V16h-1.5v-1.5zm0 3H19V19h-1.5v-1.5z"/></svg>
                        Scan Card
                    </button>
                    <button onclick="openCardEdit()" style="display:flex;align-items:center;gap:8px;padding:10px 16px;background:rgba(99,102,241,.1);border:1.5px solid rgba(99,102,241,.3);border-radius:12px;color:#818cf8;font-family:inherit;font-size:13px;font-weight:600;cursor:pointer;transition:all .15s">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="#818cf8"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                        Add Card
                    </button>
                </div>

                <!-- Pro Trial Banner (free plan only, dismissible) -->
                <div id="proTrialBanner" style="display:none;background:linear-gradient(135deg,rgba(99,102,241,.12),rgba(168,85,247,.12));border:1px solid rgba(99,102,241,.2);border-radius:14px;padding:16px;margin-bottom:16px;position:relative">
                    <button onclick="dismissProBanner()" style="position:absolute;top:10px;right:12px;background:none;border:none;color:rgba(255,255,255,.3);font-size:18px;cursor:pointer;padding:4px;line-height:1">&times;</button>
                    <div style="display:flex;align-items:center;gap:12px">
                        <div style="width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,#6366f1,#8b5cf6);display:flex;align-items:center;justify-content:center;flex-shrink:0">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="#fff"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>
                        </div>
                        <div style="flex:1;min-width:0">
                            <div style="font-size:14px;font-weight:700;color:#fff;margin-bottom:2px">Upgrade to Pro</div>
                            <div style="font-size:12px;color:rgba(255,255,255,.5)">5 cards, unlimited leads, full analytics, remove branding</div>
                        </div>
                    </div>
                    <button onclick="showUpgradeModal('Unlock more features to grow your network.')" style="margin-top:12px;width:100%;background:#6366f1;color:#fff;border:none;padding:10px;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer">Upgrade to Pro</button>
                </div>

                <!-- Onboarding placeholder (wizard is a fixed modal) -->
                <div id="onboardingWelcome" style="display:none"></div>

                <!-- Cards + Quick Share (merged) -->
                <div class="dash-section" id="dashQuickShare">
                    <div style="display:flex;gap:16px;flex-wrap:wrap;align-items:flex-start">
                        <div class="qr-card" style="margin:0">
                            <div class="qr-card-header">
                                <select id="qrCardSelect" data-card-select onchange="generateQR()" style="display:none"></select>
                                <button class="cs-trigger" id="csTrigger" onclick="openCardSwitcher()">
                                    <span class="cs-trigger-dot" id="csTriggerDot"></span>
                                    <span class="cs-trigger-label" id="csTriggerLabel">Select card</span>
                                    <svg class="cs-trigger-chevron" viewBox="0 0 24 24" width="16" height="16"><path d="M7 10l5 5 5-5z" fill="currentColor"/></svg>
                                </button>
                                <button class="qr-share-btn" onclick="shareCardLink()" title="Share">
                                    <svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/></svg>
                                </button>
                            </div>
                            <div class="qr-canvas-wrap" onclick="showFullscreenQR()">
                                <canvas id="qrCanvas"></canvas>
                            </div>
                            <div class="qr-btn-row">
                                <button class="qr-copy-btn" id="qrDefaultBtn" onclick="toggleDefaultCard()">☆ Default</button>
                                <button class="qr-copy-btn" id="qrEditBtn" onclick="openCardEdit()">
                                    <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a.996.996 0 0 0 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                                    Edit
                                </button>
                                <button class="qr-copy-btn" id="copyLinkBtn" onclick="copyCardLink()">
                                    <svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                                    Copy
                                </button>
                                <button class="qr-copy-btn" onclick="previewCard()">
                                    <svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
                                    Preview
                                </button>
                            </div>
                        </div>
                        <div class="qs-side-panel">
                            <p id="statusBadges" style="font-size:13px;color:var(--text-muted)"></p>
                            <div class="default-badge" id="defaultBadge"></div>
                            <div id="nfcLinkRow" style="display:none;margin-top:4px">
                                <label style="font-size:11px;color:var(--text-muted);margin-bottom:4px;display:block">NFC / Common Link</label>
                                <div style="display:flex;gap:6px;align-items:center">
                                    <input type="text" id="nfcLinkInput" readonly style="flex:1;background:var(--bg-elevated);border:1px solid var(--border);color:var(--text-primary);padding:8px 10px;border-radius:8px;font-size:12px;font-family:monospace;min-width:0">
                                    <button onclick="copyNfcLink()" id="copyNfcBtn" style="background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap">Copy</button>
                                </div>
                            </div>
                            <button class="nfc-share-btn" onclick="startNfcShare()">
                                <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 18H4V4h16v16zM18 6h-5c-1.1 0-2 .9-2 2v2.28c-.6.35-1 .98-1 1.72 0 1.1.9 2 2 2s2-.9 2-2c0-.74-.4-1.37-1-1.72V8h3v8H8V8h2V6H6v12h12V6z"/></svg>
                                Tap to Share
                                <span class="nfc-share-badge" id="nfcShareBadge">NFC</span>
                            </button>
                            <button class="nfc-share-btn" onclick="openScanCardsModal()" style="border-color:rgba(74,222,128,.4)">
                                <svg viewBox="0 0 24 24" style="fill:#4ade80"><path d="M9.5 6.5v3h-3v-3h3M11 5H5v6h6V5zm-1.5 9.5v3h-3v-3h3M11 13H5v6h6v-6zm6.5-6.5v3h-3v-3h3M19 5h-6v6h6V5zm-6 8h1.5v1.5H13V13zm1.5 1.5H16V16h-1.5v-1.5zM16 13h1.5v1.5H16V13zm-3 3h1.5v1.5H13V16zm1.5 1.5H16V19h-1.5v-1.5zM16 16h1.5v1.5H16V16zm1.5-1.5H19V16h-1.5v-1.5zm0 3H19V19h-1.5v-1.5z"/></svg>
                                Scan Card
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tap Log -->
                <div class="dash-section" id="dashTapLogSection">
                    <div class="dash-section-header">
                        <span class="dash-section-title">Tap Log</span>
                        <span class="tap-log-live live" id="tapLogLive">● LIVE</span>
                    </div>
                    <div id="dashTapLog">
                        <div class="activity-item"><div class="skeleton" style="width:100%;height:36px"></div></div>
                        <div class="activity-item"><div class="skeleton" style="width:85%;height:36px"></div></div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="dash-section" id="dashActivitySection">
                    <div class="dash-section-header">
                        <span class="dash-section-title">Recent Activity</span>
                        <button class="dash-section-link" onclick="navigateTo('leads')">View All</button>
                    </div>
                    <div class="activity-list" id="dashActivityFeed">
                        <div class="activity-item"><div class="skeleton" style="width:100%;height:16px"></div></div>
                        <div class="activity-item"><div class="skeleton" style="width:85%;height:16px"></div></div>
                        <div class="activity-item"><div class="skeleton" style="width:92%;height:16px"></div></div>
                    </div>
                </div>


                <div class="version-tag" style="position:static;text-align:right;padding:8px 0">v2.0</div>
            </div>

            <!-- ═══ CARDS PAGE ═══ -->
            <div class="page" id="page-cards">
                <div class="page-header">
                    <h1>Cards</h1>
                    <button class="import-btn" onclick="openCardEdit()" style="display:flex;align-items:center;gap:6px;padding:10px 16px;border:none;border-radius:10px;background:var(--accent);color:#fff;font-family:inherit;font-size:13px;font-weight:600;cursor:pointer">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        Add Card
                    </button>
                </div>
                <div class="cards-segment-control">
                    <button class="cards-segment-tab active" data-tab="my-cards" onclick="switchCardsTab('my-cards')">My Cards</button>
                    <button class="cards-segment-tab" data-tab="leads" onclick="switchCardsTab('leads')">Leads</button>
                </div>
                <div class="cards-tab-content active" id="cardsTabMyCards">
                    <div id="cardsPanel">
                        <div id="cardsList">
                            <!-- cards rendered here by JS, add-card button appended at end -->
                        </div>
                    </div>
                </div>
                <div class="cards-tab-content" id="cardsTabLeads">
                    <div id="leads">
                        <div class="leads-toolbar" style="position:static;padding:0 0 10px;background:transparent;backdrop-filter:none">
                            <input class="leads-search" id="leadSearch" type="text" placeholder="Search leads..." oninput="debouncedFilterLeads()">
                            <span id="leads-count" class="leads-count-badge"></span>
                            <button class="import-btn" onclick="openScanCardsModal()" style="display:flex;align-items:center;gap:6px">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                                Scan
                            </button>
                            <input type="file" id="scanCardsFileInput" accept="image/*" style="display:none" onchange="handleScanCardsFile(this)">
                            <input type="file" id="scanCardsBulkInput" accept="image/*" multiple style="display:none" onchange="handleScanCardsBulk(this)">
                            <input type="file" id="importVcf" accept=".vcf,text/vcard" style="display:none" onchange="importFromVcf(this)">
                            <div style="position:relative;display:inline-block" id="leadsMoreWrap">
                                <button class="toolbar-mini-btn" onclick="toggleLeadsMore()" id="leadsMoreBtn" aria-label="More actions">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="5" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="19" r="2"/></svg>
                                </button>
                                <div id="leadsMoreDrop" style="display:none;position:absolute;top:100%;right:0;margin-top:4px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:10px;min-width:160px;z-index:50;box-shadow:0 8px 24px rgba(0,0,0,.3);overflow:hidden">
                                    <button onclick="startImport();toggleLeadsMore()" class="toolbar-drop-item">Import Contacts</button>
                                    <div class="toolbar-drop-divider"></div>
                                    <div class="toolbar-drop-label">Filter by source</div>
                                    <button onclick="setSourceFilter('all');toggleLeadsMore()" class="toolbar-drop-item" id="srcAll">All Sources</button>
                                    <button onclick="setSourceFilter('exchange');toggleLeadsMore()" class="toolbar-drop-item" id="srcExchange">Exchanges</button>
                                    <button onclick="setSourceFilter('scan');toggleLeadsMore()" class="toolbar-drop-item" id="srcScan">Scanned</button>
                                    <button onclick="setSourceFilter('tap');toggleLeadsMore()" class="toolbar-drop-item" id="srcTap">Taps</button>
                                    <button onclick="setSourceFilter('manual');toggleLeadsMore()" class="toolbar-drop-item" id="srcManual">Manual</button>
                                    <button onclick="setSourceFilter('import');toggleLeadsMore()" class="toolbar-drop-item" id="srcImport">Imported</button>
                                    <div class="toolbar-drop-divider"></div>
                                    <button onclick="toggleScoreSort();toggleLeadsMore()" class="toolbar-drop-item" id="scoreSortBtn">Sort by Score</button>
                                    <div class="toolbar-drop-divider"></div>
                                    <button onclick="exportCSV();toggleLeadsMore()" class="toolbar-drop-item">Export CSV</button>
                                    <button onclick="exportJSON();toggleLeadsMore()" class="toolbar-drop-item">Export JSON</button>
                                </div>
                            </div>
                        </div>
                        <div class="filter-bar" id="filterBar" style="position:static;background:transparent;backdrop-filter:none;padding:0 0 8px">
                            <button class="filter-chip active" data-filter="all" onclick="setFilter('all')">All</button>
                            <button class="filter-chip" data-filter="score-hot" onclick="setFilter('score-hot')">Hot</button>
                            <button class="filter-chip" data-filter="score-warm" onclick="setFilter('score-warm')">Warm</button>
                            <button class="filter-chip" data-filter="status-new" onclick="setFilter('status-new')">New</button>
                            <button class="filter-chip" data-filter="status-contacted" onclick="setFilter('status-contacted')">Contacted</button>
                            <button class="filter-chip" data-filter="status-qualified" onclick="setFilter('status-qualified')">Qualified</button>
                            <button class="filter-chip" data-filter="status-won" onclick="setFilter('status-won')">Won</button>
                            <button class="filter-chip" data-filter="status-lost" onclick="setFilter('status-lost')">Lost</button>
                        </div>
                        <div class="filter-bar card-filter-bar" id="cardFilterBar" style="position:static;background:transparent;backdrop-filter:none;padding:0 0 8px"></div>
                        <div class="reminder-banner" id="reminderBanner"></div>
                        <div id="leads-list"></div>
                    </div>
                </div>
            </div>

            <!-- ═══ ANALYTICS PAGE ═══ -->
            <div class="page" id="page-analytics">
                <div id="analytics">
                    <div class="page-header">
                        <h1>Analytics</h1>
                    </div>
                    <div class="analytics-content" id="analyticsContent">
                        <div class="leads-empty">Loading analytics...</div>
                    </div>
                </div>
            </div>

            <!-- ═══ SETTINGS PAGE ═══ -->
            <div class="page" id="page-settings">
                <div class="page-header">
                    <h1>Settings</h1>
                </div>

                <!-- Profile Section -->
                <div class="settings-section">
                    <div class="settings-section-title">Profile</div>
                    <div class="settings-group">
                        <div class="settings-item" onclick="navigateTo('cards')">
                            <svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V6h16v12zM6 10h2v2H6zm0 4h8v2H6zm10 0h2v2h-2zm-6-4h8v2h-8z"/></svg>
                            <div class="settings-item-text"><strong>Manage Cards</strong><small>Add, edit, or remove business cards</small></div>
                        </div>
                        <div class="settings-item" onclick="openQuickSend()">
                            <svg viewBox="0 0 24 24"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>
                            <div class="settings-item-text"><strong>Quick Send</strong><small id="qsLabel">Auto-send a card on tap</small></div>
                        </div>
                        <div class="settings-item" onclick="openDefaultCard()">
                            <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
                            <div class="settings-item-text"><strong id="defaultLabel">Default Card</strong><small>Instantly shown when someone taps your NFC</small></div>
                        </div>
                        <div class="settings-item" id="settingsNfcLinkItem" style="display:none;cursor:default">
                            <svg viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg>
                            <div class="settings-item-text" style="flex:1;min-width:0">
                                <strong>NFC / Common Link</strong>
                                <small style="display:flex;align-items:center;gap:6px;margin-top:4px">
                                    <input type="text" id="settingsNfcLinkInput" readonly style="flex:1;background:var(--bg-elevated);border:1px solid var(--border);color:var(--text-primary);padding:6px 8px;border-radius:6px;font-size:12px;font-family:monospace;min-width:0">
                                    <button onclick="copySettingsNfcLink(event)" id="copySettingsNfcBtn" style="background:var(--accent);color:#fff;border:none;padding:6px 12px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap;flex-shrink:0">Copy</button>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Billing Section -->
                <div class="settings-section">
                    <div class="settings-section-title">Billing</div>
                    <div class="settings-group">
                        <div class="settings-item" onclick="showBillingPanel()" style="cursor:pointer">
                            <svg viewBox="0 0 24 24"><path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/></svg>
                            <div class="settings-item-text"><strong>Billing & Plan</strong><small id="currentPlanLabel">Free plan</small></div>
                        </div>
                    </div>
                </div>

                <!-- Referrals Section -->
                <div class="settings-section">
                    <div class="settings-section-title">Invite Friends</div>
                    <div class="settings-group">
                        <div class="settings-item" onclick="showReferralPanel()" style="cursor:pointer">
                            <svg viewBox="0 0 24 24"><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                            <div class="settings-item-text"><strong>Invite Friends</strong><small>Earn free Pro months for each signup</small></div>
                        </div>
                    </div>
                </div>

                <!-- Tools Section -->
                <div class="settings-section">
                    <div class="settings-section-title">Tools</div>
                    <div class="settings-group">
                        <div class="settings-item" onclick="showSignatureModal()">
                            <svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
                            <div class="settings-item-text"><strong>Email Signature</strong><small>Generate a branded signature with your card link</small></div>
                        </div>
                    </div>
                </div>

                <!-- Integrations Section -->
                <div class="settings-section">
                    <div class="settings-section-title">Integrations</div>
                    <div class="settings-group">
                        <div class="settings-item" onclick="showWebhookPanel()" style="cursor:pointer">
                            <svg viewBox="0 0 24 24"><path d="M10 15l5.88-4H1v2h9zm0-6H1V7h14.88L10 3v6zm14 2.12L20.88 8 17 11.88 13.12 8 10 11.12 13.88 15 10 18.88 13.12 22 17 18.12 20.88 22 24 18.88 20.12 15 24 11.12z"/></svg>
                            <div class="settings-item-text"><strong>Webhook</strong><small>Send new leads to Zapier, Make, or any URL</small></div>
                            <span id="webhookStatusDot" style="width:8px;height:8px;border-radius:50%;flex-shrink:0;background:var(--text-muted)"></span>
                        </div>
                    </div>
                </div>

                <!-- Team Section -->
                <div class="settings-section" id="teamSection">
                    <div class="settings-section-title">Team</div>
                    <div id="teamContent" style="padding:0">
                        <div class="settings-group">
                            <div class="settings-item" onclick="showTeamPanel()" style="cursor:pointer">
                                <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                                <div class="settings-item-text"><strong id="teamSettingsLabel">Manage Team</strong><small id="teamSettingsHint">Create or manage your team</small></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Account Section -->
                <div class="settings-section">
                    <div class="settings-section-title">Account</div>
                    <div class="settings-group">
                        <div class="settings-item" onclick="showPasswordModal()" id="passwordSettingsItem">
                            <svg viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>
                            <div class="settings-item-text"><strong id="passwordSettingsLabel">Change Password</strong><small id="passwordSettingsHint">Update your account password</small></div>
                        </div>
                    </div>
                </div>

                <!-- Notifications Section -->
                <div class="settings-section">
                    <div class="settings-section-title">Notifications</div>
                    <div class="settings-group">
                        <div class="settings-item" onclick="requestNotif()">
                            <svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg>
                            <div class="settings-item-text"><strong id="settingsNotifLabel">Enable Notifications</strong><small>Get alerts when someone taps your card</small></div>
                        </div>
                        <div class="settings-item" onclick="showInstallModal()">
                            <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                            <div class="settings-item-text"><strong>Install App</strong><small>Add to home screen for notifications</small></div>
                        </div>
                        <div class="settings-item" style="cursor:pointer" onclick="toggleWeeklyDigest()">
                            <svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
                            <div class="settings-item-text"><strong>Weekly Email Digest</strong><small id="digestHint">Get a weekly recap every Monday</small></div>
                            <div id="digestToggle" style="width:44px;height:24px;border-radius:12px;background:var(--text-muted);position:relative;flex-shrink:0;transition:background .2s;cursor:pointer">
                                <div style="width:20px;height:20px;border-radius:50%;background:#fff;position:absolute;top:2px;left:2px;transition:transform .2s"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Review Queue Section (inline) -->
                <div class="settings-section" id="settingsReviewSection">
                    <div class="settings-section-title">Review Queue <span id="reviewCount" style="color:var(--accent-light)"></span></div>
                    <div class="settings-group">
                        <div style="padding:16px" id="reviewQueue">
                            <div id="reviewList"><div style="font-size:14px;color:var(--text-muted)">No cards to review</div></div>
                        </div>
                    </div>
                </div>

                <!-- App Section -->
                <div class="settings-section">
                    <div class="settings-section-title">App</div>
                    <div class="settings-group">
                        <div class="settings-item" onclick="checkForUpdates()">
                            <svg viewBox="0 0 24 24"><path d="M21 10.12h-6.78l2.74-2.82c-2.73-2.7-7.15-2.8-9.88-.1-2.73 2.71-2.73 7.08 0 9.79s7.15 2.71 9.88 0C18.32 15.65 19 14.08 19 12.1h2c0 1.98-.88 4.55-2.64 6.29-3.51 3.48-9.21 3.48-12.72 0-3.5-3.47-3.5-9.12 0-12.6 3.51-3.47 9.14-3.47 12.65 0L21 3v7.12z"/></svg>
                            <div class="settings-item-text"><strong style="color:#4ade80">Check for Updates</strong><small>Download and install latest version</small></div>
                        </div>
                        <div class="settings-item" onclick="refreshApp()">
                            <svg viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                            <div class="settings-item-text"><strong style="color:#f87171">Reset & Refresh App</strong><small>Clear cache and reload latest version</small></div>
                        </div>
                    </div>
                </div>

                <!-- Danger Zone -->
                <div class="settings-section">
                    <div class="settings-section-title">Danger Zone</div>
                    <div class="settings-group">
                        <div class="settings-item" onclick="logout()">
                            <svg viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></svg>
                            <div class="settings-item-text"><strong style="color:#f87171">Sign Out</strong><small id="userName">Sign out of your account</small></div>
                        </div>
                        <div class="settings-item" onclick="deleteAccount()">
                            <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" fill="#f87171"/></svg>
                            <div class="settings-item-text"><strong style="color:#f87171">Delete Account</strong><small>Permanently delete all data (cannot be undone)</small></div>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div><!-- /app-shell -->

    <!-- Bottom Tab Bar (mobile) -->
    <nav class="bottom-tabs" id="bottomTabs">
        <button class="tab-item active" onclick="navigateTo('dashboard')">
            <svg viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>
            <span>Home</span>
        </button>
        <button class="tab-item" onclick="navigateTo('cards')">
            <svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V6h16v12z"/></svg>
            <span>Cards</span>
        </button>
        <button class="tab-item" onclick="navigateTo('analytics')">
            <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>
            <span>Analytics</span>
        </button>
        <button class="tab-item" onclick="navigateTo('settings')">
            <svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58z"/></svg>
            <span>Settings</span>
        </button>
    </nav>

    <!-- Card Edit Modal (Comprehensive) -->
    <div class="card-edit-modal" id="cardEditModal" onclick="if(event.target===this)closeCardEdit()">
        <div class="card-edit-content card-edit-full">
            <div class="card-edit-header">
                <h3 id="cardEditTitle">Add Card</h3>
                <button class="card-edit-close" onclick="closeCardEdit()">&times;</button>
            </div>
            <div class="card-edit-tabs">
                <button class="card-tab active" onclick="showCardTab('basic')">Basic</button>
                <button class="card-tab" onclick="showCardTab('contact')">Contact</button>
                <button class="card-tab" onclick="showCardTab('social')">Social</button>
                <button class="card-tab" onclick="showCardTab('brand')">Branding</button>
                <button class="card-tab" onclick="showCardTab('products')">Products</button>
            </div>
            <div class="card-edit-body card-edit-scrollable">
                <input type="hidden" id="cardEditId">

                <!-- Basic Tab -->
                <div class="card-tab-content active" id="tab-basic">
                    <div class="card-edit-field">
                        <label>Your Name *</label>
                        <input type="text" id="cardName" placeholder="e.g. John Doe">
                    </div>
                    <div class="card-edit-row">
                        <div class="card-edit-field">
                            <label>Job Title *</label>
                            <input type="text" id="cardTitle" placeholder="e.g. CEO">
                        </div>
                        <div class="card-edit-field">
                            <label>Company *</label>
                            <input type="text" id="cardCompany" placeholder="e.g. Acme Inc.">
                        </div>
                    </div>
                    <div class="card-edit-field">
                        <label>Card URL</label>
                        <div style="display:flex;align-items:center;gap:6px">
                            <input type="text" id="cardSlug" placeholder="e.g. acme-inc" style="flex:1" oninput="updateSlugPreview()">
                            <button type="button" onclick="autoGenerateSlug()" style="padding:6px 10px;font-size:11px;white-space:nowrap;background:var(--primary);color:#fff;border:none;border-radius:6px;cursor:pointer">Auto</button>
                        </div>
                        <div id="slugPreview" style="font-size:11px;color:var(--text-muted);margin-top:4px"></div>
                    </div>
                    <div class="card-edit-field">
                        <label>Short Description</label>
                        <input type="text" id="cardEditSubtitle" placeholder="e.g. Director — Singapore (shown in your dashboard)">
                    </div>
                    <div class="card-edit-field">
                        <label>Bio / About</label>
                        <textarea id="cardBio" rows="3" placeholder="Brief description about you or your company..."></textarea>
                    </div>
                </div>

                <!-- Contact Tab -->
                <div class="card-tab-content" id="tab-contact">
                    <div class="card-edit-row">
                        <div class="card-edit-field">
                            <label>Phone *</label>
                            <input type="tel" id="cardPhone" placeholder="+91 9876543210">
                        </div>
                        <div class="card-edit-field">
                            <label>WhatsApp Number</label>
                            <input type="text" id="cardWhatsapp" placeholder="919876543210 (country code + number)">
                        </div>
                    </div>
                    <div class="card-edit-field">
                        <label>Email *</label>
                        <input type="email" id="cardEmail" placeholder="hello@example.com">
                    </div>
                    <div class="card-edit-field">
                        <label>Address</label>
                        <textarea id="cardAddress" rows="2" placeholder="Full address for display"></textarea>
                    </div>
                    <div class="card-edit-row">
                        <div class="card-edit-field">
                            <label>Website</label>
                            <input type="url" id="cardWebsite" placeholder="https://example.com">
                        </div>
                        <div class="card-edit-field">
                            <label>Website Display</label>
                            <input type="text" id="cardWebsiteDisplay" placeholder="example.com">
                        </div>
                    </div>
                </div>

                <!-- Social Tab -->
                <div class="card-tab-content" id="tab-social">
                    <div class="card-edit-field">
                        <label>LinkedIn URL</label>
                        <input type="url" id="cardLinkedin" placeholder="https://linkedin.com/in/yourprofile">
                    </div>
                    <div class="card-edit-field">
                        <label>Instagram URL</label>
                        <input type="url" id="cardInstagram" placeholder="https://instagram.com/yourhandle">
                    </div>
                    <div class="card-edit-field">
                        <label>Twitter / X URL</label>
                        <input type="url" id="cardTwitter" placeholder="https://twitter.com/yourhandle">
                    </div>
                    <div class="card-edit-field">
                        <label>Calendly URL</label>
                        <input type="url" id="cardCalendly" placeholder="https://calendly.com/yourlink">
                    </div>
                </div>

                <!-- Branding Tab -->
                <div class="card-tab-content" id="tab-brand">
                    <div class="card-edit-field">
                        <label>Card Theme</label>
                        <div class="template-grid" id="templateGrid"></div>
                    </div>
                    <div class="card-edit-field">
                        <label>Brand Color</label>
                        <div class="color-picker-row" id="colorPicker">
                            <div class="color-picker-opt" data-color="#1B1464" style="background:#1B1464"></div>
                            <div class="color-picker-opt" data-color="#0E7490" style="background:#0E7490"></div>
                            <div class="color-picker-opt" data-color="#065F46" style="background:#065F46"></div>
                            <div class="color-picker-opt" data-color="#8B6914" style="background:#8B6914"></div>
                            <div class="color-picker-opt" data-color="#7C3AED" style="background:#7C3AED"></div>
                            <div class="color-picker-opt" data-color="#DC2626" style="background:#DC2626"></div>
                            <div class="color-picker-opt" data-color="#0891B2" style="background:#0891B2"></div>
                            <div class="color-picker-opt" data-color="#4F46E5" style="background:#4F46E5"></div>
                        </div>
                        <input type="color" id="cardCustomColor" style="margin-top:8px" onchange="selectedColor=this.value;updateColorPicker()">
                    </div>
                    <div class="card-edit-field">
                        <label>Company Logo</label>
                        <div class="photo-upload-row">
                            <input type="url" id="cardLogo" placeholder="Paste URL or upload">
                            <input type="file" id="cardLogoFile" accept="image/*" style="display:none" onchange="handleCardImage(this,'cardLogo','logoPreview',300)">
                            <button type="button" class="photo-upload-btn" onclick="document.getElementById('cardLogoFile').click()"><svg viewBox="0 0 24 24"><path d="M19 7v2.99s-1.99.01-2 0V7h-3s.01-1.99 0-2h3V2h2v3h3v2h-3zm-3 4V8h-3V5H5c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-8h-3zM5 19l3-4 2 3 3-4 4 5H5z"/></svg>Upload</button>
                        </div>
                        <div class="photo-preview" id="logoPreview"><img><button class="photo-remove" onclick="clearCardImage('cardLogo','logoPreview')">&times;</button></div>
                        <small class="field-hint">Logo shown on card avatar</small>
                    </div>
                    <div class="card-edit-field">
                        <label>Profile Photo</label>
                        <div class="photo-upload-row">
                            <input type="url" id="cardPhoto" placeholder="Paste URL or upload">
                            <input type="file" id="cardPhotoFile" accept="image/*" style="display:none" onchange="handleCardImage(this,'cardPhoto','photoPreview',500)">
                            <button type="button" class="photo-upload-btn" onclick="document.getElementById('cardPhotoFile').click()"><svg viewBox="0 0 24 24"><path d="M19 7v2.99s-1.99.01-2 0V7h-3s.01-1.99 0-2h3V2h2v3h3v2h-3zm-3 4V8h-3V5H5c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-8h-3zM5 19l3-4 2 3 3-4 4 5H5z"/></svg>Upload</button>
                        </div>
                        <div class="photo-preview" id="photoPreview"><img><button class="photo-remove" onclick="clearCardImage('cardPhoto','photoPreview')">&times;</button></div>
                        <small class="field-hint">Your headshot (takes priority over logo)</small>
                    </div>
                </div>

                <!-- Products Tab -->
                <div class="card-tab-content" id="tab-products">
                    <div class="products-editor">
                        <div id="productsContainer"></div>
                        <button class="add-product-btn" onclick="addProductField()">
                            <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                            Add Product
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-edit-footer">
                <button class="card-edit-cancel" onclick="closeCardEdit()">Cancel</button>
                <button class="card-edit-save" onclick="saveCard()">Save Card</button>
            </div>
        </div>
    </div>

    <!-- Fullscreen QR -->
    <div class="qr-fullscreen" id="qrFullscreen" onclick="if(event.target===this)closeFullscreenQR()">
        <div class="qr-card-name" id="qrFullName"></div>
        <div class="qr-full-wrap">
            <canvas id="qrFullCanvas"></canvas>
        </div>
        <button class="qr-close" onclick="closeFullscreenQR()">Close</button>
    </div>

    <!-- Quick Send Modal -->
    <div class="qs-modal" id="qsModal" onclick="if(event.target===this)closeQuickSend()">
        <div class="qs-sheet">
            <h3>Quick Send</h3>
            <p class="qs-sub">Auto-send a card when someone taps — no picking needed</p>
            <div id="qsOptions"></div>
        </div>
    </div>

    <!-- Default Card Modal -->
    <div class="qs-modal" id="defaultModal" onclick="if(event.target===this)closeDefaultCard()">
        <div class="qs-sheet">
            <h3>Default Card</h3>
            <p class="qs-sub">Instantly shown when someone taps your NFC tag</p>
            <div id="defaultOptions"></div>
        </div>
    </div>

    <!-- Tag Modal -->
    <div class="tag-modal" id="tagModal" onclick="if(event.target===this)closeTagModal()">
        <div class="tag-sheet">
            <h3>Add Tags</h3>
            <div class="tag-options" id="tagOptions"></div>
            <div class="tag-custom">
                <input type="text" id="customTagInput" placeholder="Custom tag...">
                <button onclick="addCustomTag()">Add</button>
            </div>
            <button class="tag-done" onclick="saveTagsAndClose()">Done</button>
        </div>
    </div>

    <!-- Card Verification Modal -->
    <div class="card-edit-modal" id="verifyModal" onclick="if(event.target===this)closeVerifyModal()">
        <div class="card-edit-content" style="max-width:480px">
            <div class="card-edit-header">
                <h3 id="verifyModalTitle">Verify Card</h3>
                <button class="card-edit-close" onclick="closeVerifyModal()">&times;</button>
            </div>
            <div class="card-edit-body" id="verifyModalBody" style="padding:20px">
                <p style="color:var(--text-muted)">Loading...</p>
            </div>
        </div>
    </div>

    <!-- Edit Lead Modal -->
    <div class="edit-modal" id="editModal" onclick="if(event.target===this)closeEditModal()">
        <div class="edit-modal-content">
            <div class="edit-modal-header">
                <h3>Edit Lead</h3>
                <button class="edit-modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="edit-modal-body">
                <input type="hidden" id="editLeadId">
                <div class="edit-field"><label>Name</label><input type="text" id="editName" placeholder="Full name"></div>
                <div class="edit-field"><label>Title</label><input type="text" id="editTitle" placeholder="Job title"></div>
                <div class="edit-field"><label>Company</label><input type="text" id="editCompany" placeholder="Company name"></div>
                <div class="edit-field"><label>Phone</label><input type="tel" id="editPhone" placeholder="Phone number"></div>
                <div class="edit-field"><label>Email</label><input type="email" id="editEmail" placeholder="Email address"></div>
                <div class="edit-field"><label>Website</label><input type="url" id="editWebsite" placeholder="https://..."></div>
                <div class="edit-field"><label>Address</label><input type="text" id="editAddress" placeholder="Address"></div>
                <div class="edit-row">
                    <div class="edit-field"><label>LinkedIn</label><input type="text" id="editLinkedin" placeholder="username"></div>
                    <div class="edit-field"><label>Instagram</label><input type="text" id="editInstagram" placeholder="handle"></div>
                    <div class="edit-field"><label>Twitter/X</label><input type="text" id="editTwitter" placeholder="handle"></div>
                </div>
            </div>
            <div class="edit-modal-footer">
                <button class="edit-cancel-btn" onclick="closeEditModal()">Cancel</button>
                <button class="edit-save-btn" onclick="saveEditedLead()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Import Contacts Modal -->
    <div class="import-modal" id="importModal">
        <div class="import-header">
            <button onclick="closeImportModal()">Cancel</button>
            <h3>Import Contacts</h3>
            <span class="import-count" id="importCount"></span>
            <button class="save-all-btn" onclick="saveAllImported()">Save All</button>
        </div>
        <div class="import-list" id="importList"></div>
    </div>

    <!-- Scan Modal -->
    <div class="scan-modal" id="scanModal">
        <div class="scan-header">
            <h3 id="scanTitle">Scan Contact</h3>
            <button class="scan-close" onclick="closeScanModal()">Cancel</button>
        </div>
        <div class="scan-options" id="scanOptions">
            <button class="scan-option" onclick="startQrScan()">
                <svg viewBox="0 0 24 24"><path d="M3 11h8V3H3v8zm2-6h4v4H5V5zm8-2v8h8V3h-8zm6 6h-4V5h4v4zM3 21h8v-8H3v8zm2-6h4v4H5v-4zm13-2h-2v2h2v-2zm-2 4h2v2h-2v-2zm2 2h2v2h-2v-2zm0-4h2v2h-2v-2zm2 2h2v2h-2v-2zm0-4h2v2h-2V9zm-4 8h2v2h-2v-2zm2 2h2v2h-2v-2z"/></svg>
                <div class="scan-option-title">QR Code</div>
                <div class="scan-option-desc">Scan their QR</div>
            </button>
            <button class="scan-option" onclick="startCardScan()">
                <svg viewBox="0 0 24 24"><path d="M21 3H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H3V5h18v14zM5 15h14v2H5zm0-4h14v2H5zm0-4h6v2H5z"/></svg>
                <div class="scan-option-title">Business Card</div>
                <div class="scan-option-desc">Photo + OCR</div>
            </button>
        </div>
        <div class="scan-camera" id="scanCamera" style="display:none">
            <video id="scanVideo" autoplay playsinline></video>
            <canvas id="scanCanvas"></canvas>
            <div class="scan-viewfinder" id="scanViewfinder"></div>
            <div class="scan-status" id="scanStatus">Point camera at QR code</div>
            <button class="scan-capture-btn" id="scanCaptureBtn" onclick="captureCard()" style="display:none">Capture</button>
        </div>
        <div class="scan-result" id="scanResult" style="display:none">
            <div class="scan-result-card">
                <div class="scan-result-title">Scanned Contact</div>
                <div class="scan-result-field"><label>Name</label><input type="text" id="scanName" placeholder="Full name"></div>
                <div class="scan-result-field"><label>Title</label><input type="text" id="scanJobTitle" placeholder="Job title"></div>
                <div class="scan-result-field"><label>Company</label><input type="text" id="scanCompany" placeholder="Company"></div>
                <div class="scan-result-field"><label>Phone</label><input type="tel" id="scanPhone" placeholder="Phone number"></div>
                <div class="scan-result-field"><label>Email</label><input type="email" id="scanEmail" placeholder="Email address"></div>
                <div class="scan-result-field"><label>Website</label><input type="url" id="scanUrl" placeholder="Website URL"></div>
                <div class="scan-result-actions">
                    <button class="scan-retry-btn" onclick="retryScan()">Scan Again</button>
                    <button class="scan-save-btn" onclick="saveScannedContact()">Save to Leads</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scan Contacts Modal -->
    <div class="scan-cards-modal" id="scanCardsModal" onclick="if(event.target===this)closeScanCardsModal()">
        <div class="scan-cards-inner">
            <div class="scan-cards-header">
                <h2 id="scanCardsTitle">Scan Contacts</h2>
                <button class="scan-cards-close" onclick="closeScanCardsModal()">&times;</button>
            </div>

            <!-- Source picker -->
            <div id="scanCardsSources" class="scan-cards-sources">
                <button onclick="scanCardsSingleCamera()">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                    <span class="sc-label">Camera</span>
                    <span class="sc-desc">Rapid-fire capture</span>
                </button>
                <button onclick="document.getElementById('scanCardsFileInput').click()">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
                    <span class="sc-label">Photo</span>
                    <span class="sc-desc">Pick from gallery</span>
                </button>
                <button onclick="document.getElementById('scanCardsBulkInput').click()">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="7" width="16" height="14" rx="2"/><path d="M6 3h16a2 2 0 0 1 2 2v12"/></svg>
                    <span class="sc-label">Bulk</span>
                    <span class="sc-desc">Multiple images</span>
                </button>
            </div>

            <!-- Camera view -->
            <div id="scanCardsCamera" class="scan-cards-camera" style="display:none">
                <video id="scanCardsVideo" autoplay playsinline></video>
                <canvas id="scanCardsCanvas"></canvas>
                <div class="scan-cards-flash" id="scanCardsFlash"></div>
                <div class="scan-cards-badge" id="scanCardsBadge">0 captured</div>
                <div class="scan-cards-cam-actions" id="scanCardsCamActions" style="display:none">
                    <button class="scan-cards-shutter" id="scanCardsShutter" onclick="captureScanCard()" title="Capture"></button>
                    <button class="scan-cards-done-btn" id="scanCardsDoneBtn" onclick="finishRapidFire()">Done</button>
                </div>
                <button class="scan-cards-cam-btn" id="scanCardsCaptureBtn" onclick="captureScanCard()">Capture</button>
            </div>

            <!-- Live results (unified progress + review) -->
            <div id="scanCardsResults" class="scan-results" style="display:none">
                <div class="scan-results-bar">
                    <div class="scan-results-info">
                        <span id="scanResultsCount">0 contacts</span>
                        <span class="scan-results-spinner" id="scanResultsSpinner" style="display:none"><span class="sr-spin"></span> Scanning...</span>
                    </div>
                    <div class="scan-results-btns">
                        <button class="sr-btn-more" id="scanResultsMoreBtn" onclick="scanMoreCards()" style="display:none">+ Scan More</button>
                        <button class="sr-btn-save" id="scanResultsSaveBtn" onclick="saveAllScanResults()" disabled>Save All</button>
                    </div>
                </div>
                <div class="scan-results-progress" id="scanResultsProgress" style="display:none">
                    <div class="sr-prog-bar"><div class="sr-prog-fill" id="scanResultsProgFill" style="width:0%"></div></div>
                </div>
                <div class="scan-results-feed" id="scanResultsFeed"></div>
            </div>
        </div>
    </div>

    <!-- Background scan indicator -->
    <div id="bgScanIndicator" class="bg-scan-indicator" style="display:none">
        <span class="bg-scan-spinner"></span>
        <span id="bgScanText">Scanning...</span>
    </div>

    <!-- Billing Panel -->
    <!-- Password Change Modal -->
    <div class="settings-modal" id="passwordModal" onclick="if(event.target===this)hidePasswordModal()">
        <div class="settings-sheet">
            <div class="settings-title" id="passwordModalTitle">Change Password</div>
            <div id="pwError" style="background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);color:var(--danger);padding:10px 14px;border-radius:8px;font-size:13px;margin-bottom:12px;display:none"></div>
            <div id="pwSuccess" style="background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.3);color:var(--success);padding:10px 14px;border-radius:8px;font-size:13px;margin-bottom:12px;display:none"></div>
            <div id="pwCurrentGroup" style="margin-bottom:12px">
                <label style="display:block;font-size:13px;color:var(--text-muted);margin-bottom:6px">Current Password</label>
                <div style="position:relative">
                    <input type="password" id="pwCurrent" style="width:100%;padding:12px 44px 12px 16px;background:var(--bg-base);border:1.5px solid var(--border);border-radius:10px;color:var(--text-primary);font-size:15px;outline:none;font-family:inherit" placeholder="Enter current password">
                    <button type="button" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;padding:4px;color:var(--text-muted);display:flex;align-items:center" onclick="togglePwDash(this)"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
                </div>
            </div>
            <div style="margin-bottom:12px">
                <label style="display:block;font-size:13px;color:var(--text-muted);margin-bottom:6px">New Password</label>
                <div style="position:relative">
                    <input type="password" id="pwNew" style="width:100%;padding:12px 44px 12px 16px;background:var(--bg-base);border:1.5px solid var(--border);border-radius:10px;color:var(--text-primary);font-size:15px;outline:none;font-family:inherit" placeholder="Min 6 characters">
                    <button type="button" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;padding:4px;color:var(--text-muted);display:flex;align-items:center" onclick="togglePwDash(this)"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
                </div>
            </div>
            <div style="margin-bottom:16px">
                <label style="display:block;font-size:13px;color:var(--text-muted);margin-bottom:6px">Confirm New Password</label>
                <div style="position:relative">
                    <input type="password" id="pwConfirm" style="width:100%;padding:12px 44px 12px 16px;background:var(--bg-base);border:1.5px solid var(--border);border-radius:10px;color:var(--text-primary);font-size:15px;outline:none;font-family:inherit" placeholder="Re-enter new password">
                    <button type="button" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;padding:4px;color:var(--text-muted);display:flex;align-items:center" onclick="togglePwDash(this)"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
                </div>
            </div>
            <button style="width:100%;padding:13px;background:#6366f1;color:#fff;border:none;border-radius:10px;font-family:inherit;font-size:15px;font-weight:600;cursor:pointer;margin-bottom:8px" id="pwSubmitBtn" onclick="submitPasswordChange()">Update Password</button>
            <button class="settings-close" onclick="hidePasswordModal()">Cancel</button>
        </div>
    </div>

    <!-- Referral Panel -->
    <div class="settings-modal" id="referralPanel" onclick="if(event.target===this)hideReferralPanel()">
        <div class="settings-sheet" style="max-height:85vh">
            <div class="settings-title">Invite Friends</div>

            <!-- How it works -->
            <div style="background:rgba(99,102,241,.08);border-radius:10px;padding:14px;margin-bottom:16px;font-size:13px;color:rgba(255,255,255,.6);line-height:1.6">
                <div style="font-weight:600;color:#818cf8;margin-bottom:8px">How it works</div>
                <div style="display:flex;gap:8px;margin-bottom:6px"><span style="color:#818cf8;font-weight:600">1.</span> Share your referral link or send an email invite</div>
                <div style="display:flex;gap:8px;margin-bottom:6px"><span style="color:#818cf8;font-weight:600">2.</span> Your friend signs up for CardFlow</div>
                <div style="display:flex;gap:8px"><span style="color:#818cf8;font-weight:600">3.</span> You both get 1 free month of Pro!</div>
            </div>

            <!-- Referral Link -->
            <div style="margin-bottom:16px">
                <label style="display:block;font-size:13px;color:rgba(255,255,255,.5);margin-bottom:6px">Your referral link</label>
                <div style="display:flex;gap:8px">
                    <input type="text" id="referralLinkInput" readonly style="flex:1;padding:10px 14px;background:rgba(255,255,255,.06);border:1.5px solid rgba(255,255,255,.1);border-radius:10px;color:#fff;font-size:13px;font-family:inherit;outline:none">
                    <button onclick="copyReferralLink()" id="copyRefBtn" style="padding:10px 16px;background:#6366f1;color:#fff;border:none;border-radius:10px;font-family:inherit;font-size:13px;font-weight:600;cursor:pointer;white-space:nowrap">Copy</button>
                </div>
            </div>

            <!-- Card / NFC Link -->
            <div style="margin-bottom:16px">
                <label style="display:block;font-size:13px;color:rgba(255,255,255,.5);margin-bottom:6px">Your card link (NFC / share)</label>
                <div style="display:flex;gap:8px">
                    <input type="text" id="referralNfcLinkInput" readonly style="flex:1;padding:10px 14px;background:rgba(255,255,255,.06);border:1.5px solid rgba(255,255,255,.1);border-radius:10px;color:#fff;font-size:13px;font-family:inherit;outline:none">
                    <button onclick="copyNfcLink()" id="copyNfcBtn" style="padding:10px 16px;background:rgba(255,255,255,.1);color:#fff;border:none;border-radius:10px;font-family:inherit;font-size:13px;font-weight:600;cursor:pointer;white-space:nowrap">Copy</button>
                </div>
            </div>

            <!-- Email Invite -->
            <div style="margin-bottom:16px">
                <label style="display:block;font-size:13px;color:rgba(255,255,255,.5);margin-bottom:6px">Send invite by email</label>
                <div style="display:flex;gap:8px">
                    <input type="email" id="inviteEmailInput" placeholder="friend@example.com" style="flex:1;padding:10px 14px;background:rgba(255,255,255,.06);border:1.5px solid rgba(255,255,255,.1);border-radius:10px;color:#fff;font-size:14px;font-family:inherit;outline:none">
                    <button onclick="sendInviteEmail()" id="sendInviteBtn" style="padding:10px 16px;background:#6366f1;color:#fff;border:none;border-radius:10px;font-family:inherit;font-size:13px;font-weight:600;cursor:pointer;white-space:nowrap">Send</button>
                </div>
                <div id="inviteFeedback" style="font-size:12px;margin-top:6px;min-height:18px"></div>
            </div>

            <!-- Stats Grid -->
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px">
                <div style="background:rgba(255,255,255,.05);border-radius:10px;padding:12px;text-align:center">
                    <div id="refStatInvites" style="font-size:22px;font-weight:700;color:#6366f1">0</div>
                    <div style="font-size:11px;color:rgba(255,255,255,.4)">Invites Sent</div>
                </div>
                <div style="background:rgba(255,255,255,.05);border-radius:10px;padding:12px;text-align:center">
                    <div id="refStatSignups" style="font-size:22px;font-weight:700;color:#10b981">0</div>
                    <div style="font-size:11px;color:rgba(255,255,255,.4)">Signups</div>
                </div>
                <div style="background:rgba(255,255,255,.05);border-radius:10px;padding:12px;text-align:center">
                    <div id="refStatMonths" style="font-size:22px;font-weight:700;color:#f59e0b">0</div>
                    <div style="font-size:11px;color:rgba(255,255,255,.4)">Months Earned</div>
                </div>
            </div>

            <!-- Recent Invites -->
            <div id="refRecentSection" style="display:none">
                <div style="font-size:13px;font-weight:600;color:rgba(255,255,255,.5);margin-bottom:8px">Recent Invites</div>
                <div id="refRecentList" style="display:flex;flex-direction:column;gap:6px;max-height:150px;overflow-y:auto"></div>
            </div>

            <button class="settings-close" onclick="hideReferralPanel()" style="margin-top:16px">Close</button>
        </div>
    </div>

    <div class="settings-modal" id="billingPanel" onclick="if(event.target===this)hideBillingPanel()">
        <div class="settings-sheet">
            <div class="settings-title">Billing & Plan</div>
            <div style="padding:16px 0;text-align:center">
                <div style="font-size:14px;color:rgba(255,255,255,.5);margin-bottom:4px">Current Plan</div>
                <div id="billingCurrentPlan" style="font-size:24px;font-weight:700;color:#6366f1;text-transform:capitalize">Free</div>
                <div id="billingPlanStatus" style="font-size:13px;color:rgba(255,255,255,.5);margin-top:4px"></div>
            </div>
            <div id="billingUpgradeSection" style="display:flex;flex-direction:column;gap:8px;padding:0 0 16px">
                <button class="settings-item" onclick="startCheckout('pro',null,event)" style="border:1px solid rgba(99,102,241,.3);cursor:pointer;background:none">
                    <svg viewBox="0 0 24 24" fill="#6366f1"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>
                    <div class="settings-item-text">
                        <strong style="color:#6366f1">Upgrade to Pro</strong>
                        <small>₹399/mo — 5 cards, unlimited leads, full analytics</small>
                    </div>
                </button>
                <button class="settings-item" onclick="startCheckout('business',null,event)" style="border:1px solid rgba(168,85,247,.3);cursor:pointer;background:none">
                    <svg viewBox="0 0 24 24" fill="#a855f7"><path d="M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-8v-2h2v-2h-2v-2h2v-2h-2V9h8v10zm-2-8h-2v2h2v-2zm0 4h-2v2h2v-2z"/></svg>
                    <div class="settings-item-text">
                        <strong style="color:#a855f7">Upgrade to Business</strong>
                        <small>₹999/mo — Unlimited cards, teams, custom domain, API</small>
                    </div>
                </button>
            </div>
            <div id="billingManageSection" style="display:none">
                <button class="settings-item" onclick="openBillingPortal()" style="border:1px solid rgba(99,102,241,.3);cursor:pointer;background:none">
                    <svg viewBox="0 0 24 24" fill="#6366f1"><path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/></svg>
                    <div class="settings-item-text">
                        <strong style="color:#6366f1">Manage Billing</strong>
                        <small>Update payment method, view invoices, cancel</small>
                    </div>
                </button>
            </div>
            <button class="settings-close" onclick="hideBillingPanel()">Close</button>
        </div>
    </div>

    <!-- Email Signature Modal -->
    <div class="sig-modal" id="sigModal" onclick="if(event.target===this)hideSignatureModal()">
        <div class="sig-content">
            <div class="sig-header">
                <h3>Email Signature</h3>
                <button class="sig-close" onclick="hideSignatureModal()">&times;</button>
            </div>
            <div class="sig-body">
                <div class="sig-select-row">
                    <select id="sigCardSelect" onchange="updateSignaturePreview()"></select>
                </div>
                <div class="sig-preview" id="sigPreview">
                    <p style="color:#94a3b8;font-size:13px;text-align:center">Select a card to generate your signature</p>
                </div>
                <div class="sig-actions">
                    <button class="sig-copy-btn" id="sigCopyBtn" onclick="copySignature()">
                        <svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                        Copy Signature
                    </button>
                </div>
                <button class="sig-setup-toggle" id="sigSetupToggle" onclick="toggleSigSetup()">
                    How to add to your email
                    <svg viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
                </button>
                <div class="sig-setup-guide" id="sigSetupGuide">
                    <div class="sig-setup-guide-inner">
                        <div class="sig-setup-step">
                            <strong>Gmail</strong>
                            Settings (gear icon) &rarr; See all settings &rarr; General &rarr; Signature &rarr; Paste
                        </div>
                        <div class="sig-setup-step">
                            <strong>Outlook</strong>
                            File &rarr; Options &rarr; Mail &rarr; Signatures &rarr; Paste
                        </div>
                        <div class="sig-setup-step">
                            <strong>Apple Mail</strong>
                            Mail &rarr; Settings &rarr; Signatures &rarr; Paste
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Onboarding Wizard Modal -->
    <div class="ob-wizard" id="obWizard">
        <div class="ob-wizard-inner">
            <div class="ob-progress">
                <div class="ob-progress-bar active" id="obBar1"></div>
                <div class="ob-progress-bar" id="obBar2"></div>
                <div class="ob-progress-bar" id="obBar3"></div>
            </div>
            <!-- Step 1: Your Details -->
            <div class="ob-step active" id="obWizStep1">
                <h2>Your card details</h2>
                <p class="ob-desc">Just the basics — you can add more details later.</p>
                <div class="ob-field"><label>Your Name</label><input type="text" id="obName" placeholder="Sarah Kim" autocomplete="name"></div>
                <div class="ob-field"><label>Job Title</label><input type="text" id="obTitle" placeholder="Co-Founder"></div>
                <div class="ob-field"><label>Company</label><input type="text" id="obCompany" placeholder="Acme Corp"></div>
                <div class="ob-field"><label>Email <span style="color:var(--text-muted);font-weight:400">(optional)</span></label><input type="email" id="obEmail" placeholder="sarah@acmecorp.com"></div>
                <div class="ob-field"><label>Phone <span style="color:var(--text-muted);font-weight:400">(optional)</span></label><input type="tel" id="obPhone" placeholder="+1 555 0123"></div>
            </div>
            <!-- Step 2: Pick a Theme -->
            <div class="ob-step" id="obWizStep2">
                <h2>Choose a look</h2>
                <p class="ob-desc">Pick a color that matches your brand.</p>
                <div class="ob-preview-card" id="obPreviewCard" style="background:linear-gradient(135deg,#4F46E5,#3730A3)">
                    <div class="ob-preview-name" id="obPreviewName">Your Name</div>
                    <div class="ob-preview-title" id="obPreviewTitle">Job Title at Company</div>
                </div>
                <div class="ob-templates" id="obTemplateGrid"></div>
            </div>
            <!-- Step 3: Share -->
            <div class="ob-step" id="obWizStep3">
                <div class="ob-done-icon"><svg viewBox="0 0 24 24" width="48" height="48" fill="var(--accent)"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg></div>
                <h2>You're all set!</h2>
                <p class="ob-desc">Your card is live. Share it with anyone.</p>
                <div class="ob-share">
                    <div class="ob-share-qr"><canvas id="obQrCanvas" width="160" height="160"></canvas></div>
                    <div class="ob-share-link">
                        <input type="text" id="obShareUrl" readonly>
                        <button onclick="copyObLink()">Copy</button>
                    </div>
                    <button class="ob-share-wa" onclick="shareObWhatsApp()">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M17.47 14.38c-.29-.15-1.7-.84-1.96-.93-.27-.1-.46-.15-.65.15-.2.29-.75.93-.92 1.12-.17.2-.34.22-.63.07-.29-.14-1.22-.45-2.33-1.43-.86-.77-1.44-1.71-1.61-2-.17-.29-.02-.45.13-.59.13-.13.29-.34.43-.51.15-.17.2-.29.29-.48.1-.2.05-.37-.02-.51-.07-.15-.65-1.56-.89-2.14-.24-.56-.48-.49-.65-.49-.17-.01-.37-.01-.56-.01-.2 0-.51.07-.78.37-.27.29-1.02 1-1.02 2.43s1.04 2.82 1.19 3.01c.15.2 2.05 3.13 4.97 4.39.69.3 1.23.48 1.65.61.69.22 1.32.19 1.82.12.56-.08 1.7-.7 1.94-1.37.24-.67.24-1.25.17-1.37-.07-.12-.27-.2-.56-.34zM12.05 21.5c-1.65 0-3.26-.43-4.69-1.24l-.34-.2-3.54.93.94-3.47-.22-.36a9.4 9.4 0 01-1.08-5.11c.34-4.81 4.3-8.65 9.12-8.85 2.6-.11 5.05.87 6.89 2.72a9.42 9.42 0 012.78 6.85c-.12 5.19-4.34 9.33-9.55 9.34h-.01z"/></svg>
                        Share via WhatsApp
                    </button>
                </div>
                <p class="ob-checklist-hint">Your dashboard has a quick setup guide to help you get the most out of CardFlow.</p>
            </div>
            <div class="ob-actions" id="obActions">
                <button class="ob-btn-primary" id="obNextBtn" onclick="obNext()">Next</button>
            </div>
        </div>
    </div>

    <!-- Welcome Screen (pre-onboarding) -->
    <div class="welcome-screen" id="welcomeScreen">
        <div class="welcome-inner">
            <div class="welcome-logo">
                <svg viewBox="0 0 24 24" width="52" height="52" fill="var(--accent)"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V6h16v12zM6 10h2v2H6zm0 4h8v2H6zm10 0h2v2h-2zm-6-4h8v2h-8z"/></svg>
            </div>
            <h1 class="welcome-title">Welcome to CardFlow</h1>
            <p class="welcome-subtitle">Create your digital business card in under a minute. Share it via QR, NFC, or a simple link.</p>
            <div class="welcome-features">
                <div class="welcome-feature">
                    <span class="welcome-feature-icon"><svg viewBox="0 0 24 24" width="20" height="20" fill="var(--accent)"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-1 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8zm-5.5 9c-.83 0-1.5-.67-1.5-1.5S5.67 9 6.5 9 8 9.67 8 10.5 7.33 12 6.5 12zm3-4C8.67 8 8 7.33 8 6.5S8.67 5 9.5 5s1.5.67 1.5 1.5S10.33 8 9.5 8zm5 0c-.83 0-1.5-.67-1.5-1.5S13.67 5 14.5 5s1.5.67 1.5 1.5S15.33 8 14.5 8zm3 4c-.83 0-1.5-.67-1.5-1.5S16.67 9 17.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"/></svg></span>
                    <span>Beautiful card themes</span>
                </div>
                <div class="welcome-feature">
                    <span class="welcome-feature-icon"><svg viewBox="0 0 24 24" width="20" height="20" fill="var(--accent)"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg></span>
                    <span>Capture leads automatically</span>
                </div>
                <div class="welcome-feature">
                    <span class="welcome-feature-icon"><svg viewBox="0 0 24 24" width="20" height="20" fill="var(--accent)"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/></svg></span>
                    <span>Share via QR, NFC, or link</span>
                </div>
            </div>
            <button class="welcome-cta" onclick="dismissWelcomeStartWizard()">Get Started</button>
            <p class="welcome-time">Takes about 30 seconds</p>
        </div>
    </div>

    <!-- Webhook Panel Modal -->
    <div class="sig-modal" id="webhookModal" onclick="if(event.target===this)hideWebhookPanel()">
        <div class="sig-content" style="max-width:min(460px, calc(100vw - 40px))">
            <div class="sig-header">
                <h3>Webhook Integration</h3>
                <button class="sig-close" onclick="hideWebhookPanel()">&times;</button>
            </div>
            <div style="padding:20px">
                <p style="font-size:13px;color:var(--text-muted);margin-bottom:16px">Every new lead will be sent as a POST request to your webhook URL. Works with Zapier, Make, n8n, and any service that accepts webhooks.</p>
                <label style="font-size:12px;font-weight:600;color:var(--text-secondary);display:block;margin-bottom:6px">Webhook URL</label>
                <input type="url" id="webhookUrlInput" placeholder="https://hooks.zapier.com/..." style="width:100%;padding:12px 14px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:10px;color:var(--text-primary);font-size:14px;font-family:monospace;outline:none;margin-bottom:12px" oninput="webhookUrlChanged=true">
                <div style="display:flex;gap:8px;margin-bottom:16px">
                    <button onclick="saveWebhookUrl()" style="flex:1;padding:10px;background:var(--accent);color:#fff;border:none;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer" id="saveWebhookBtn">Save</button>
                    <button onclick="testWebhook()" style="padding:10px 16px;background:var(--bg-elevated);color:var(--text-secondary);border:1px solid var(--border);border-radius:10px;font-size:14px;font-weight:500;cursor:pointer" id="testWebhookBtn">Test</button>
                    <button onclick="clearWebhookUrl()" style="padding:10px 16px;background:transparent;color:var(--text-muted);border:1px solid var(--border);border-radius:10px;font-size:13px;cursor:pointer">Clear</button>
                </div>
                <div id="webhookTestResult" style="display:none;padding:10px 14px;border-radius:10px;font-size:13px;margin-bottom:12px"></div>
                <div style="background:rgba(255,255,255,.03);border-radius:10px;padding:14px">
                    <div style="font-size:12px;font-weight:600;color:var(--text-secondary);margin-bottom:8px">Payload format</div>
                    <pre style="font-size:11px;color:var(--text-muted);margin:0;white-space:pre-wrap;font-family:monospace;line-height:1.5">POST {your-url}
Content-Type: application/json

{
  "event": "new_lead",
  "name": "John Smith",
  "email": "john@example.com",
  "phone": "+1234567890",
  "company": "Acme Inc",
  "source": "qr",
  "card": "my-card-name",
  "timestamp": "2026-01-15T10:30:00Z"
}</pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Team Panel Modal -->
    <div class="sig-modal" id="teamModal" onclick="if(event.target===this)hideTeamPanel()">
        <div class="sig-content" style="max-width:min(520px, calc(100vw - 40px));max-height:85vh;overflow-y:auto">
            <div class="sig-header">
                <h3 id="teamModalTitle">Team</h3>
                <button class="sig-close" onclick="hideTeamPanel()">&times;</button>
            </div>
            <div style="padding:20px" id="teamModalBody">
                <div class="leads-empty">Loading...</div>
            </div>
        </div>
    </div>

    <!-- Upgrade Modal -->
    <div class="settings-modal" id="upgradeModal" onclick="if(event.target===this)hideUpgradeModal()">
        <div class="settings-sheet" style="max-height:90vh">
            <div style="text-align:center;margin-bottom:20px">
                <div style="width:56px;height:56px;border-radius:16px;background:linear-gradient(135deg,#6366f1,#8b5cf6);display:inline-flex;align-items:center;justify-content:center;margin-bottom:12px">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="#fff"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>
                </div>
                <h3 style="font-size:20px;font-weight:700;margin:0 0 4px">Upgrade Your Plan</h3>
                <p id="upgradeModalReason" style="font-size:14px;color:rgba(255,255,255,.5);margin:0"></p>
            </div>
            <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:16px">
                <div style="background:rgba(99,102,241,.08);border:1px solid rgba(99,102,241,.25);border-radius:14px;padding:16px;cursor:pointer" onclick="startCheckout('pro',null,event)">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                        <span style="font-size:16px;font-weight:700;color:#6366f1">Pro</span>
                        <span style="font-size:16px;font-weight:700;color:#fff">₹399/mo</span>
                    </div>
                    <div style="display:flex;flex-direction:column;gap:4px;font-size:13px;color:rgba(255,255,255,.7)">
                        <span>5 digital cards</span>
                        <span>Unlimited leads</span>
                        <span>Full analytics & branding removal</span>
                    </div>
                    <div style="margin-top:12px;background:#6366f1;color:#fff;text-align:center;padding:10px;border-radius:10px;font-size:14px;font-weight:600">Upgrade to Pro</div>
                </div>
                <div style="background:rgba(168,85,247,.08);border:1px solid rgba(168,85,247,.25);border-radius:14px;padding:16px;cursor:pointer" onclick="startCheckout('business',null,event)">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
                        <span style="font-size:16px;font-weight:700;color:#a855f7">Business</span>
                        <span style="font-size:16px;font-weight:700;color:#fff">₹999/mo</span>
                    </div>
                    <div style="display:flex;flex-direction:column;gap:4px;font-size:13px;color:rgba(255,255,255,.7)">
                        <span>Unlimited cards</span>
                        <span>Everything in Pro</span>
                        <span>Dedicated support & lead export</span>
                    </div>
                    <div style="margin-top:12px;background:#a855f7;color:#fff;text-align:center;padding:10px;border-radius:10px;font-size:14px;font-weight:600">Upgrade to Business</div>
                </div>
            </div>
            <p style="text-align:center;font-size:12px;color:rgba(255,255,255,.4);margin:0 0 12px">Start growing your professional network with CardFlow</p>
            <button class="settings-close" onclick="hideUpgradeModal()">Maybe Later</button>
        </div>
    </div>

</div><!-- /appContainer -->

<script src="/common.js"></script>
<script>
// Database URL removed - now using Express API
var BASE_URL = 'https://card.cardflow.cloud';

// ═══ NAVIGATION ═══
var currentPage = 'dashboard';

function navigateTo(page) {
    // Backward compat: redirect old standalone pages to cards sub-tabs
    if (page === 'leads') { navigateTo('cards'); switchCardsTab('leads'); return; }
    if (page === 'connections') { navigateTo('cards'); switchCardsTab('leads'); return; }

    currentPage = page;
    // Hide all pages (remove active which triggers fade-out via CSS transition)
    document.querySelectorAll('.page').forEach(function(p) { p.classList.remove('active'); });
    // Deactivate all nav items
    document.querySelectorAll('.nav-item').forEach(function(n) { n.classList.remove('active'); });
    document.querySelectorAll('.tab-item').forEach(function(t) { t.classList.remove('active'); });

    // Show target page with slight delay for transition
    var target = document.getElementById('page-' + page);
    if (target) {
        requestAnimationFrame(function(){ target.classList.add('active'); });
    }

    // Activate matching nav/tab items
    var navItems = document.querySelectorAll('.nav-item');
    var tabItems = document.querySelectorAll('.tab-item');
    var pageMap = ['dashboard','cards','analytics','settings'];
    var idx = pageMap.indexOf(page);
    if (idx >= 0) {
        if (navItems[idx]) navItems[idx].classList.add('active');
        if (tabItems[idx]) tabItems[idx].classList.add('active');
    }

    // Scroll main content to top
    var mc = document.getElementById('mainContent');
    if (mc) mc.scrollTop = 0;

    // Update NFC FAB visibility
    updateNfcFab();

    // Trigger page-specific loading
    if (page === 'dashboard') loadDashboard();
    else if (page === 'analytics') {
        var ac = document.getElementById('analyticsContent');
        if (ac) ac.innerHTML = '<div class="leads-empty">Loading analytics...</div>';
        loadAnalyticsData();
    }
    else if (page === 'cards') {
        renderCardsList();
        // Load data for the currently active sub-tab
        if (currentCardsTab === 'leads') loadLeadsPage();
    }
    else if (page === 'settings') { updateNotifUI(); loadReviewItems(); updateWebhookDot(); loadDigestSetting(); }
}

// ═══ CARDS SUB-TABS ═══
var currentCardsTab = 'my-cards';

function switchCardsTab(tab) {
    currentCardsTab = tab;
    // Hide all tab content, show the target
    document.querySelectorAll('.cards-tab-content').forEach(function(el) { el.classList.remove('active'); el.style.display = 'none'; });
    var tabIdMap = { 'my-cards': 'cardsTabMyCards', 'leads': 'cardsTabLeads' };
    var target = document.getElementById(tabIdMap[tab]);
    if (target) { target.style.display = ''; target.classList.add('active'); }
    // Update segment button active states
    document.querySelectorAll('.cards-segment-tab').forEach(function(b) { b.classList.remove('active'); });
    var activeBtn = document.querySelector('.cards-segment-tab[data-tab="' + tab + '"]');
    if (activeBtn) activeBtn.classList.add('active');
    // Load data for the sub-tab
    if (tab === 'my-cards') renderCardsList();
    else if (tab === 'leads') loadLeadsPage();
}

// ═══ QR SWITCHER (trigger button + bottom sheet) ═══
function renderQrSwitcher() {
    var label = document.getElementById('csTriggerLabel');
    var dot = document.getElementById('csTriggerDot');
    if (!label || !dot) return;
    var selVal = document.getElementById('qrCardSelect') ? document.getElementById('qrCardSelect').value : '';
    if (!CARD_IDS || !CARD_IDS.length) {
        label.textContent = 'No cards yet';
        dot.style.background = 'var(--text-muted)';
        return;
    }
    var c = CARDS[selVal];
    if (!c) return;
    var name = (c.company || c.name).split(' ').slice(0,3).join(' ');
    var isDefault = (selVal === currentDefaultCard);
    label.textContent = name + (isDefault ? ' ★' : '');
    dot.style.background = c.color || '#6366f1';
}

function renderCardSwitcherList() {
    var list = document.getElementById('csList');
    if (!list) return;
    var selVal = document.getElementById('qrCardSelect') ? document.getElementById('qrCardSelect').value : '';
    if (!CARD_IDS || !CARD_IDS.length) {
        list.innerHTML = '<div style="padding:24px;text-align:center;color:var(--text-muted);font-size:14px">No cards yet<br><button onclick="openCardEdit()" style="margin-top:12px;padding:8px 20px;border:none;border-radius:8px;background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff;font-size:13px;font-weight:600;cursor:pointer">+ Create Your First Card</button></div>';
        return;
    }
    var html = '';
    CARD_IDS.forEach(function(id) {
        var c = CARDS[id];
        var name = escapeHtml(c.company || c.name);
        var sub = escapeHtml(c.subtitle || c.name || '');
        var color = c.color || '#6366f1';
        var isActive = selVal === id;
        var isDefault = (id === currentDefaultCard);
        var isInactive = !!c._inactive;
        html += '<button class="cs-card' + (isActive ? ' cs-active' : '') + (isInactive ? ' cs-inactive' : '') + '" onclick="' + (isInactive ? '' : 'switchCard(\'' + escapeHtml(id) + '\')') + '"' + (isInactive ? ' disabled style="opacity:.5;filter:grayscale(.5)"' : '') + '>';
        html += '<div class="cs-card-bar" style="background:' + color + '"></div>';
        html += '<div class="cs-card-info">';
        html += '<span class="cs-card-name">' + name + (isInactive ? ' <span style="font-size:10px;color:#f87171;margin-left:6px">Deactivated</span>' : '') + '</span>';
        if (sub && sub !== name) html += '<span class="cs-card-sub">' + sub + '</span>';
        html += '</div>';
        if (isDefault) html += '<span class="cs-card-star">★</span>';
        if (isActive) html += '<svg class="cs-card-check" viewBox="0 0 24 24" width="18" height="18"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" fill="currentColor"/></svg>';
        html += '</button>';
    });
    list.innerHTML = html;
}

function openCardSwitcher() {
    renderCardSwitcherList();
    document.getElementById('csBackdrop').classList.add('cs-open');
    document.getElementById('csSheet').classList.add('cs-open');
    document.body.style.overflow = 'hidden';
}

function closeCardSwitcher() {
    document.getElementById('csBackdrop').classList.remove('cs-open');
    document.getElementById('csSheet').classList.remove('cs-open');
    document.body.style.overflow = '';
}

function switchCard(cardId) {
    selectTileCard(cardId);
    closeCardSwitcher();
}

// Backdrop click to close
document.addEventListener('click', function(e) {
    if (e.target && e.target.id === 'csBackdrop') closeCardSwitcher();
});

// Swipe-down-to-dismiss on handle/header
(function() {
    var startY = 0, currentY = 0, dragging = false;
    var sheet = null;
    function getSheet() { return sheet || (sheet = document.getElementById('csSheet')); }
    function onStart(e) {
        var t = e.target.closest('.cs-handle, .cs-header');
        if (!t) return;
        dragging = true;
        startY = e.touches ? e.touches[0].clientY : e.clientY;
        currentY = startY;
        getSheet().style.transition = 'none';
    }
    function onMove(e) {
        if (!dragging) return;
        currentY = e.touches ? e.touches[0].clientY : e.clientY;
        var dy = Math.max(0, currentY - startY);
        getSheet().style.transform = 'translateY(' + dy + 'px)';
    }
    function onEnd() {
        if (!dragging) return;
        dragging = false;
        var dy = currentY - startY;
        getSheet().style.transition = '';
        getSheet().style.transform = '';
        if (dy > 80) closeCardSwitcher();
    }
    document.addEventListener('touchstart', onStart, { passive: true });
    document.addEventListener('touchmove', onMove, { passive: true });
    document.addEventListener('touchend', onEnd);
    document.addEventListener('mousedown', onStart);
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onEnd);
})();

function updateQrActions() {
    var selVal = document.getElementById('qrCardSelect') ? document.getElementById('qrCardSelect').value : '';
    var defBtn = document.getElementById('qrDefaultBtn');
    if (defBtn) {
        var isDefault = selVal && selVal === currentDefaultCard;
        defBtn.innerHTML = isDefault ? '★ Default' : '☆ Default';
        defBtn.classList.toggle('qr-default-on', !!isDefault);
        defBtn.onclick = function() { toggleDefaultCard(selVal); };
    }
    var editBtn = document.getElementById('qrEditBtn');
    if (editBtn) {
        editBtn.onclick = function() { openCardEdit(selVal); };
    }
}

function selectTileCard(cardId) {
    var sel = document.getElementById('qrCardSelect');
    if (sel) { sel.value = cardId; }
    localStorage.setItem('selectedCard', cardId);
    generateQR();
    renderQrSwitcher();
    updateQrActions();
}

// ═══ DASHBOARD ═══
var cachedLeads = null;

function loadDashboard() {
    // Greeting
    var greetEl = document.getElementById('dashGreeting');
    if (greetEl && currentUserProfile) {
        var hour = new Date().getHours();
        var greeting = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';
        var firstName = (currentUserProfile.name || '').split(' ')[0] || currentUserProfile.username || '';
        greetEl.textContent = greeting + (firstName ? ', ' + firstName : '');
    }
    // Plan badge
    var planBadge = document.getElementById('dashPlanBadge');
    if (planBadge) {
        var plan = getUserPlan() || 'free';
        planBadge.textContent = plan.charAt(0).toUpperCase() + plan.slice(1);
        if (plan === 'pro') { planBadge.style.background = 'rgba(168,85,247,.15)'; planBadge.style.color = '#c084fc'; }
        else if (plan === 'business') { planBadge.style.background = 'rgba(251,191,36,.15)'; planBadge.style.color = '#fbbf24'; }
    }
    // Stats
    Promise.all([
        apiFetch('/leads').then(function(r){return r.json()}),
        apiFetch('/taps').then(function(r){return r.json()})
    ]).then(function(results) {
        var leads = results[0] || {};
        var taps = results[1] || {};
        cachedLeads = leads;
        var leadCount = 0;
        for (var k in leads) {
            if (leads[k]) leadCount++;
        }
        // Count today's taps
        var todayStr = new Date().toISOString().slice(0,10);
        var tapsToday = 0;
        for (var tk in taps) {
            if (taps[tk] && taps[tk].ts) {
                var tapDate = new Date(taps[tk].ts).toISOString().slice(0,10);
                if (tapDate === todayStr) tapsToday++;
            }
        }
        var el = document.getElementById('dashLeadCount');
        if (el) el.textContent = leadCount;
        var tt = document.getElementById('dashTapsToday');
        if (tt) tt.textContent = tapsToday;
        var cc = document.getElementById('dashCardCount');
        if (cc) cc.textContent = CARD_IDS.length;

        // Lead usage bar for free plan
        var usageBar = document.getElementById('leadUsageBar');
        if (usageBar && getUserPlan() === 'free') {
            usageBar.style.display = '';
            apiFetch('/leads/month-count').then(function(r){return r.json()}).then(function(data){
                var count = data.count || 0;
                var limit = 25;
                var pct = Math.min(100, Math.round((count / limit) * 100));
                var text = document.getElementById('leadUsageText');
                var fill = document.getElementById('leadUsageFill');
                var warn = document.getElementById('leadUsageWarning');
                if (text) text.textContent = count + ' / ' + limit;
                if (fill) fill.style.width = pct + '%';
                if (pct >= 100 && fill) fill.style.background = 'linear-gradient(90deg,#ef4444,#f97316)';
                else if (pct >= 80 && fill) fill.style.background = 'linear-gradient(90deg,#f59e0b,#f97316)';
                if (warn) {
                    if (pct >= 100) { warn.style.display = ''; warn.innerHTML = 'Limit reached. <a href="#" onclick="showUpgradeModal(\'You\\\'ve hit your 25 lead/month limit. Upgrade for unlimited leads.\');return false" style="color:#6366f1;font-weight:600;text-decoration:underline">Upgrade for unlimited leads</a>'; }
                    else if (pct >= 80) { warn.style.display = ''; warn.textContent = 'Almost at your monthly limit. Consider upgrading.'; }
                    else { warn.style.display = 'none'; }
                }
            }).catch(function(){});
        } else if (usageBar) {
            usageBar.style.display = 'none';
        }

        // Also update the old lead count stat
        var oldEl = document.getElementById('leadCount');
        if (oldEl) {
            var numEl = oldEl.querySelector('.stat-num');
            if (numEl) numEl.textContent = leadCount;
        }

        // Render recent activity
        renderRecentActivity(leads);
    }).catch(function() {});

    // Render card tiles
    renderDashCardTiles();

    // Show pro trial banner for free users
    maybeShowProBanner();

    // Getting started checklist
    loadChecklistState();

}

function renderDashCardTiles() {
    renderQrSwitcher();
    updateQrActions();
}

function renderRecentActivity(leads) {
    var container = document.getElementById('dashActivityFeed');
    if (!container) return;
    var items = [];
    for (var k in leads) {
        var l = leads[k];
        if (l) {
            l._id = k;
            items.push(l);
        }
    }
    items.sort(function(a, b) { return (b.ts || 0) - (a.ts || 0); });
    var maxItems = window.innerWidth <= 767 ? 5 : 8;
    items = items.slice(0, maxItems);

    if (items.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon"><svg viewBox="0 0 24 24" width="40" height="40" fill="none" stroke="var(--text-muted)" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg></div><div class="empty-state-title">No activity yet</div><div class="empty-state-desc">When people view your card and submit their info, you\'ll see it here.</div><button class="empty-state-btn" onclick="shareCardLink()">Share Your Card</button></div>';
        return;
    }

    var html = '';
    items.forEach(function(l) {
        var dotClass = 'activity-dot dot-lead';
        if (l.source === 'tap' || l.source === 'nfc') dotClass = 'activity-dot dot-tap';
        else if (l.source === 'share' || l.source === 'qr') dotClass = 'activity-dot dot-share';
        html += '<div class="activity-item">';
        html += '<div class="' + dotClass + '"></div>';
        html += '<div class="activity-text">';
        html += '<div class="activity-name">' + escapeHtml(l.name || l.phone || l.email || 'Visitor') + '</div>';
        var detail = [];
        if (l.company) detail.push(escapeHtml(l.company));
        if (l.card && NAMES[l.card]) detail.push(escapeHtml(NAMES[l.card]));
        if (detail.length) html += '<div class="activity-detail">' + detail.join(' · ') + '</div>';
        html += '</div>';
        if (l.ts) html += '<div class="activity-time">' + timeAgo(l.ts) + '</div>';
        html += '</div>';
    });
    container.innerHTML = html;
}

function timeAgo(ts) {
    var now = Date.now();
    var diff = now - ts;
    if (diff < 60000) return 'just now';
    if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
    if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
    if (diff < 604800000) return Math.floor(diff / 86400000) + 'd ago';
    return new Date(ts).toLocaleDateString('en-IN', {day: 'numeric', month: 'short'});
}

// ── Tap Log ──
var tapLogEntries = [];

function loadTapLog() {
    apiFetch('/taps', {noRedirect: true}).then(function(r) {
        if (!r || !r.ok) return;
        return r.json();
    }).then(function(taps) {
        if (!Array.isArray(taps)) return;
        tapLogEntries = taps;
        renderTapLog();
    }).catch(function() {});
}

function renderTapLog() {
    var container = document.getElementById('dashTapLog');
    if (!container) return;
    if (tapLogEntries.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon"><svg viewBox="0 0 24 24" width="40" height="40" fill="none" stroke="var(--text-muted)" stroke-width="1.5"><path d="M6 8.32a7.43 7.43 0 0 1 0 7.36M9.46 6.21a11.76 11.76 0 0 1 0 11.58M12.91 4.1a15.91 15.91 0 0 1 .01 15.8M16.37 2a20.16 20.16 0 0 1 0 20"/></svg></div><div class="empty-state-title">No taps yet</div><div class="empty-state-desc">Share your NFC card or QR code to see live taps appear here.</div></div>';
        return;
    }
    var nfcIcon = '<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 8.32a7.43 7.43 0 0 1 0 7.36"/><path d="M9.46 6.21a11.76 11.76 0 0 1 0 11.58"/><path d="M12.91 4.1a15.91 15.91 0 0 1 .01 15.8"/><path d="M16.37 2a20.16 20.16 0 0 1 0 20"/></svg>';
    var qrIcon = '<svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><path d="M14 14h3v3h-3zM17 17h3v3h-3zM14 20h3"/></svg>';
    var html = '';
    tapLogEntries.slice(0, 3).forEach(function(t) {
        var icon = (t.source === 'qr' || t.source === 'share') ? qrIcon : nfcIcon;
        var ts = t.ts || t._ts || 0;
        var isPending = !t.card && ts && (Date.now() - ts) < 300000;
        var cardLabel = (t.card && NAMES[t.card]) ? escapeHtml(NAMES[t.card]) : null;
        var statusText = cardLabel ? cardLabel + ' shared' : (isPending ? 'Pick a card to share:' : 'No card selected');
        var statusClass = cardLabel ? 'selected' : (isPending ? 'pending-active' : 'pending');
        var visitor = t.visitor ? escapeHtml((t.visitor.device || '') + (t.visitor.browser ? ' · ' + t.visitor.browser : '')) : 'Unknown device';
        var timeStr = ts ? timeAgo(ts) : '';
        var tapId = esc(t._id || t.sessionId || t.sid || '');
        var entryId = 'taplog-' + escapeHtml(t._id || t.sessionId || t.sid || '');
        html += '<div class="tap-log-entry" id="' + entryId + '">';
        html += '<div class="tap-log-icon">' + icon + '</div>';
        html += '<div class="tap-log-main">';
        html += '<div class="tap-log-row"><div class="tap-log-status ' + statusClass + '">' + statusText + '</div><div class="tap-log-time">' + timeStr + '</div></div>';
        html += '<div class="tap-log-visitor">' + visitor + '</div>';
        if (isPending) {
            html += '<div class="tap-log-picks">';
            if (CARD_IDS.length > 0) {
                CARD_IDS.forEach(function(cid) {
                    var c = CARDS[cid];
                    if (!c || c._inactive) return;
                    var bg = (c.gradient || 'var(--accent)').replace(/"/g, "'");
                    html += '<button class="tap-log-pick-btn" style="background:' + bg + '" onclick="selectCardInLog(\'' + tapId + '\',\'' + esc(cid) + '\')">' + escapeHtml(c.company || c.name || cid) + '</button>';
                });
            } else {
                html += '<span style="font-size:11px;color:var(--text-muted)">Loading cards…</span>';
            }
            html += '</div>';
        }
        html += '</div>';
        html += '</div>';
    });
    container.innerHTML = html;
}

function selectCardInLog(tapId, cardId) {
    cfLog('SELECT', 'selectCardInLog tapId=' + tapId + ' cardId=' + cardId);
    apiFetch('/taps/' + tapId, {method:'PATCH', body:{card:cardId, status:'selected'}, noRedirect:true}).catch(function(e){ cfLog('SELECT', 'Tap PATCH failed: ' + e.message); });
    apiFetch('/leads/' + tapId, {method:'PATCH', body:{card:cardId}, noRedirect:true}).catch(function(e){ cfLog('SELECT', 'Lead PATCH failed: ' + e.message); });
    updateTapLogCard(tapId, cardId);
    showToast((NAMES[cardId] || cardId) + ' shared', 'success');
    loadStats();
}

function prependTapLog(tapData) {
    var entry = Object.assign({}, tapData, { _id: tapData.sessionId || tapData.sid });
    // Remove duplicate if exists
    tapLogEntries = tapLogEntries.filter(function(t) { return t._id !== entry._id; });
    tapLogEntries.unshift(entry);
    if (tapLogEntries.length > 30) tapLogEntries.pop();
    renderTapLog();
    // Flash highlight on new entry
    var el = document.getElementById('taplog-' + (entry._id || ''));
    if (el) { el.classList.add('tap-new'); setTimeout(function() { el.classList.remove('tap-new'); }, 800); }
}

function updateTapLogCard(sessionId, cardId) {
    for (var i = 0; i < tapLogEntries.length; i++) {
        var t = tapLogEntries[i];
        if (t._id === sessionId || t.sessionId === sessionId || t.sid === sessionId) {
            tapLogEntries[i] = Object.assign({}, t, { card: cardId });
            break;
        }
    }
    renderTapLog();
}

// ── Refresh tap log on focus/SSE reconnect/poll ──
function checkPendingTap() {
    if (!currentUser || !authToken) return;
    // L1: Don't poll if picker is already visible
    var pickerEl = document.getElementById('picker');
    if (pickerEl && !pickerEl.classList.contains('hidden')) {
        cfLog('POLL', 'checkPendingTap skipped — picker already visible');
        return;
    }
    cfLog('POLL', 'checkPendingTap running...');
    apiFetch('/taps', {noRedirect: true}).then(function(r) {
        if (!r || !r.ok) return;
        return r.json();
    }).then(function(taps) {
        if (!Array.isArray(taps) || taps.length === 0) return;
        // Detect genuinely new pending tap to buzz & notify
        var latest = taps[0];
        var latestId = latest._id || latest.sessionId || latest.sid;
        var latestTs = latest.ts || latest._ts || 0;
        var isNew = latestId && latestId !== lastSeenSession && !latest.card
                    && latestTs && (Date.now() - latestTs) < 300000;
        tapLogEntries = taps;
        if (CARD_IDS.length === 0) {
            setTimeout(renderTapLog, 800);
        } else {
            renderTapLog();
        }
        if (isNew) {
            cfLog('POLL', 'New pending tap detected: ' + latestId);
            lastSeenSession = latestId;
            localStorage.setItem('lastSeenSession', latestId);
            currentSession = latestId;
            var vi = latest.visitor;
            document.getElementById('visitor-info').textContent = vi ? (vi.device+' · '+vi.browser) : '';
            buzz();

            // M7: Check Quick Send before showing picker
            var qs = getQuickSend();
            if (qs && NAMES[qs]) {
                cfLog('POLL', 'Quick Send active, auto-selecting: ' + qs);
                notify('Card auto-sent!', NAMES[qs] + ' shared via Quick Send');
                selectCardInLog(currentSession, qs);
                return;
            }

            notify('Someone tapped your card!', 'Select a card to share');
            if (CARD_IDS.length > 0) {
                initCardElements();
                show('picker');
            } else {
                var _pp = 0;
                var _pt = setInterval(function() {
                    _pp++;
                    if (CARD_IDS.length > 0 || _pp >= 20) {
                        clearInterval(_pt);
                        if (currentSession && CARD_IDS.length > 0) { initCardElements(); show('picker'); }
                    }
                }, 150);
            }
        }
    }).catch(function() {});
}

function getPreviewUrl(cardId) {
    if (currentUserProfile && currentUserProfile.username) {
        return '/' + currentUserProfile.username + '/' + cardId + '?preview=1';
    }
    var c = CARDS[cardId];
    return c && c.token ? '/?c=' + c.token + '&preview=1' : '/';
}

function previewCardById(cardId) {
    if (!cardId || !CARDS[cardId]) return;
    currentPreviewUrl = getCardUrl(cardId);
    document.getElementById('previewLoading').style.display = 'flex';
    document.getElementById('previewFrame').src = getPreviewUrl(cardId);
    document.getElementById('previewModal').classList.add('show');
}

function shareCardById(cardId) {
    if (!cardId || !CARDS[cardId]) return;
    var url = getCardUrl(cardId);
    if (navigator.share) {
        navigator.share({ title: (CARDS[cardId].company || CARDS[cardId].name) + ' — Digital Card', url: url }).catch(function() {});
    } else {
        navigator.clipboard.writeText(url).then(function() { showUpdateToast('Link copied!'); });
    }
}

function copyBcardLink(cardId, btn) {
    var url = getCardUrl(cardId);
    navigator.clipboard.writeText(url).then(function() {
        btn.classList.add('copied');
        btn.innerHTML = '<svg viewBox="0 0 24 24" width="13" height="13"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" fill="currentColor"/></svg>';
        setTimeout(function() {
            btn.classList.remove('copied');
            btn.innerHTML = '<svg viewBox="0 0 24 24" width="13" height="13"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z" fill="currentColor"/></svg>';
        }, 1500);
    });
}

function loadLeadsPage() {
    document.getElementById('leads-list').innerHTML = '<div class="leads-empty">Loading...</div>';
    document.getElementById('leadSearch').value = '';
    activeFilter = 'all';
    activeSourceFilter = 'all';
    document.querySelectorAll('#filterBar .filter-chip').forEach(function(c) { c.classList.toggle('active', c.dataset.filter === 'all'); });
    var srcBtn = document.getElementById('sourceDropBtn');
    if (srcBtn) { srcBtn.textContent = 'Source ▾'; srcBtn.classList.remove('active'); }
    // Reuse existing lead loading logic
    showLeadsData();
}

// ── Security helpers (escapeHtml & escHtml provided by common.js) ──
var escAttr = escapeHtml; // alias — same logic, used in lead rendering
function sanitizeColor(c) {
    if (!c) return '';
    if (/^#[0-9a-fA-F]{3,8}$/.test(c)) return c;
    if (/^rgb\(\s*\d{1,3}\s*,\s*\d{1,3}\s*,\s*\d{1,3}\s*\)$/.test(c)) return c;
    return '#1B1464';
}

// ═══ CARDS - loaded dynamically from Firebase ═══
var CARDS = {};

// Plan limits
var PLAN_LIMITS = {
    free: { cards: 1, leadsPerMonth: 25 },
    pro: { cards: 5, leadsPerMonth: -1 },
    business: { cards: -1, leadsPerMonth: -1 }
};

function getUserPlan() {
    return (currentUserProfile && currentUserProfile.plan) || 'free';
}

function canAddCard() {
    var plan = getUserPlan();
    var limit = PLAN_LIMITS[plan] ? PLAN_LIMITS[plan].cards : 1;
    if (limit === -1) return true;
    var activeCount = CARD_IDS.filter(function(id) { return !CARDS[id]._inactive; }).length;
    return activeCount < limit;
}
var CARD_IDS = Object.keys(CARDS);

// Legacy compatibility aliases
var NAMES = {}; var CARD_COLORS = {}; var TOKEN_BY_CARD = {}; var TOKENS = {};
CARD_IDS.forEach(function(id) {
    var c = CARDS[id];
    NAMES[id] = c.company || c.name;
    CARD_COLORS[id] = c.color;
    TOKEN_BY_CARD[id] = c.token;
    TOKENS[c.token] = id;
});

// Helper: Get card URL (path-based when username available)
function getCardUrl(cardId) {
    var c = CARDS[cardId];
    if (!c) return BASE_URL;
    if (currentUserProfile && currentUserProfile.username) {
        return BASE_URL + '/' + currentUserProfile.username + '/' + cardId;
    }
    return BASE_URL;
}

var PRESET_TAGS = ['Hot Lead','Follow Up','Customer','Partner','Event'];
var STATUS_OPTIONS = ['new','contacted','qualified','won','lost'];
var STATUS_LABELS = {new:'New',contacted:'Contacted',qualified:'Qualified',won:'Won',lost:'Lost'};

// Lead scoring weights
var SCORE_WEIGHTS = {
    save_contact: 5,
    whatsapp: 4,
    call: 4,
    email: 3,
    website: 3,
    linkedin: 2,
    instagram: 2,
    twitter: 2,
    calendly: 3,
    product_enquiry: 4,
    view: 1
};
var leadScores = {}; // {sessionId: {score: N, actions: [...]}}

// Follow-up message templates
var FOLLOWUP_TEMPLATES = {
    day1: "Hi {name}, great connecting with you! Just wanted to make sure you saved my contact. Let me know if you need anything.",
    day3: "Hi {name}, hope you're doing well! Following up from our recent meeting. Would love to continue the conversation.",
    day7: "Hi {name}, quick reminder - I'm here if you need any assistance. Feel free to reach out anytime!",
    custom: "Hi {name}, "
};

function getFollowupMessage(template, lead) {
    var name = lead.name ? lead.name.split(' ')[0] : 'there';
    var msg = FOLLOWUP_TEMPLATES[template] || FOLLOWUP_TEMPLATES.custom;
    return msg.replace('{name}', name);
}

function calculateLeadScore(actions) {
    var score = 0;
    var seen = {};
    actions.forEach(function(a) {
        var action = a.action || a;
        var weight = SCORE_WEIGHTS[action] || 1;
        if (!seen[action]) {
            score += weight;
            seen[action] = true;
        } else {
            score += Math.ceil(weight / 2); // Diminishing returns for repeat actions
        }
    });
    return score;
}

function getScoreLabel(score) {
    if (score >= 10) return {label: 'Hot', class: 'score-hot'};
    if (score >= 5) return {label: 'Warm', class: 'score-warm'};
    if (score >= 1) return {label: 'Cool', class: 'score-cool'};
    return {label: '', class: ''};
}

var currentSession = null;
var ready = false;
var lastSeenSession = localStorage.getItem('lastSeenSession') || null;
var allLeads = [];
var activeFilter = 'all';
var expandedLeadId = null;
var tagModalLeadId = null;
var tagModalTags = [];

// ═══ DYNAMIC CARD HTML GENERATION ═══
function initCardElements() {
    // Populate all card selects
    var selectHtml = '';
    CARD_IDS.forEach(function(id) {
        var c = CARDS[id];
        var label = c.company ? c.company : c.name;
        selectHtml += '<option value="'+id+'">'+escapeHtml(label)+'</option>';
    });
    var savedCard = localStorage.getItem('selectedCard');
    document.querySelectorAll('[data-card-select]').forEach(function(sel) {
        sel.innerHTML = selectHtml;
        if (savedCard && CARDS[savedCard]) sel.value = savedCard;
    });

    // Populate picker buttons
    var pickerHtml = '';
    CARD_IDS.forEach(function(id) {
        var c = CARDS[id];
        pickerHtml += '<button class="pick-btn" style="background:'+escapeHtml(c.gradient)+'" onclick="selectCard(\''+id+'\')">'+escapeHtml(c.company||c.name)+'<small>'+escapeHtml(c.company?c.name:'')+'</small></button>';
    });
    var pickerEl = document.getElementById('pickerCards');
    if (pickerEl) pickerEl.innerHTML = pickerHtml;

    // Populate Quick Send options
    var qsHtml = '';
    CARD_IDS.forEach(function(id) {
        var c = CARDS[id];
        qsHtml += '<button class="qs-opt" data-card="'+id+'" onclick="setQuickSend(\''+id+'\')">'+escapeHtml(c.company||c.name)+'<small>'+escapeHtml(c.company?c.name:'')+'</small></button>';
    });
    qsHtml += '<button class="qs-off" onclick="setQuickSend(\'\')">Turn off Quick Send</button>';
    var qsEl = document.getElementById('qsOptions');
    if (qsEl) qsEl.innerHTML = qsHtml;

    // Populate Default Card options
    var defaultHtml = '';
    CARD_IDS.forEach(function(id) {
        var c = CARDS[id];
        defaultHtml += '<button class="qs-opt" data-default="'+id+'" onclick="setDefaultCard(\''+id+'\')">'+escapeHtml(c.company||c.name)+'<small>'+escapeHtml(c.company?c.name:'')+'</small></button>';
    });
    defaultHtml += '<button class="qs-off" onclick="setDefaultCard(\'\')">None — let me choose each time</button>';
    var defaultEl = document.getElementById('defaultOptions');
    if (defaultEl) defaultEl.innerHTML = defaultHtml;

    // Populate card filter chips
    var filterHtml = '<span class="filter-label">Card:</span>';
    CARD_IDS.forEach(function(id) {
        var c = CARDS[id];
        filterHtml += '<button class="filter-chip card-filter-chip" data-filter="card-'+id+'" onclick="setFilter(\'card-'+id+'\')" style="border-color:'+sanitizeColor(c.color)+'">'+escapeHtml((c.company||c.name).split(' ')[0])+'</button>';
    });
    var filterEl = document.getElementById('cardFilterBar');
    if (filterEl) filterEl.innerHTML = filterHtml;

    // Populate dashboard QR switcher
    renderQrSwitcher();
    updateQrActions();
}

// ═══ CARD MANAGEMENT ═══
var editingCardId = null;
var selectedColor = '#1B1464';

function generateToken() {
    var chars = 'abcdefghijklmnopqrstuvwxyz0123456789';
    var token = '';
    for (var i = 0; i < 10; i++) token += chars[Math.floor(Math.random() * chars.length)];
    return token;
}

function generateSlug(text) {
    return text.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '').substring(0, 40);
}

function autoGenerateSlug() {
    var company = document.getElementById('cardCompany').value.trim();
    if (!company) { alert('Enter a company name first'); return; }
    var slug = generateSlug(company);
    if (CARDS[slug] && slug !== editingCardId) {
        slug = slug.substring(0, 35) + '-' + Date.now().toString(36).slice(-4);
    }
    document.getElementById('cardSlug').value = slug;
    updateSlugPreview();
}

function updateSlugPreview() {
    var slug = document.getElementById('cardSlug').value.trim();
    var preview = document.getElementById('slugPreview');
    if (!slug) { preview.innerHTML = ''; return; }
    var username = (currentUserProfile && currentUserProfile.username) || 'username';
    if (slug.length > 1 && !/^[a-z0-9][a-z0-9-]*[a-z0-9]$/.test(slug)) {
        preview.innerHTML = '<span style="color:#e74c3c">Only lowercase letters, numbers and hyphens allowed</span>';
        return;
    }
    if (CARDS[slug] && slug !== editingCardId) {
        preview.innerHTML = '<span style="color:#e74c3c">This slug is already taken by another card</span>';
        return;
    }
    preview.innerHTML = BASE_URL + '/' + username + '/<strong>' + escapeHtml(slug) + '</strong>';
}

function darkenColor(hex) {
    var r = parseInt(hex.slice(1,3), 16);
    var g = parseInt(hex.slice(3,5), 16);
    var b = parseInt(hex.slice(5,7), 16);
    r = Math.floor(r * 0.6); g = Math.floor(g * 0.6); b = Math.floor(b * 0.6);
    return '#' + r.toString(16).padStart(2,'0') + g.toString(16).padStart(2,'0') + b.toString(16).padStart(2,'0');
}

function showCardsPanel() {
    navigateTo('cards');
}

function hideCardsPanel() {
    navigateTo('dashboard');
}

function renderCardsList() {
    var html = '';
    CARD_IDS.forEach(function(id, idx) {
        var c = CARDS[id];
        var cardUrl = getCardUrl(id);
        var color1 = sanitizeColor(c.color || c.color1 || '#1B1464');
        var color2 = darkenColor(color1);

        // Avatar content
        var avatarHtml = '';
        if (c.photo) {
            avatarHtml = '<img src="'+escapeHtml(c.photo)+'" alt="">';
        } else if (c.logo) {
            avatarHtml = '<img class="bcard-avatar-logo" src="'+escapeHtml(c.logo)+'" alt="">';
        } else {
            var initials = (c.name || '').split(' ').map(function(w){return w[0]}).join('').substring(0,2).toUpperCase();
            avatarHtml = '<span class="bcard-initials">'+(escapeHtml(initials) || 'CF')+'</span>';
        }

        var isInactive = !!c._inactive;
        html += '<div class="bcard' + (isInactive ? ' bcard-inactive' : '') + '" style="animation-delay:'+(idx*80)+'ms">';
        if (isInactive) html += '<div class="bcard-inactive-badge">Deactivated — <a href="#" onclick="event.preventDefault();event.stopPropagation();showUpgradeModal(\'Upgrade your plan to reactivate this card.\')">Upgrade to reactivate</a></div>';

        // Hero — entire gradient background
        html += '<div class="bcard-hero" style="background:linear-gradient(145deg,'+color1+','+color2+')">';
        // Identity row: avatar + name/title
        html += '<div class="bcard-identity">';
        html += '<div class="bcard-avatar">'+avatarHtml+'</div>';
        html += '<div class="bcard-text">';
        html += '<div class="bcard-name">'+escapeHtml(c.company || c.name)+(c._verifiedAt ? ' <svg viewBox="0 0 24 24" width="14" height="14" fill="none" style="vertical-align:middle"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z" fill="#059669"/><path d="M9 12l2 2 4-4" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>' : '')+'</div>';
        html += '<div class="bcard-title">'+escapeHtml(c.company ? c.name : '')+(c.title ? (c.company ? ' &middot; ' : '')+escapeHtml(c.title) : '')+'</div>';
        html += '</div></div>';
        html += '</div>';

        // Divider
        html += '<div class="bcard-divider" style="background:linear-gradient(90deg,transparent,'+color1+'44,transparent)"></div>';

        // Body — contact details
        html += '<div class="bcard-body">';
        if (c.phone) html += '<div class="bcard-contact"><svg viewBox="0 0 24 24"><path d="M6.62 10.79a15.05 15.05 0 0 0 6.59 6.59l2.2-2.2a1 1 0 0 1 1.01-.24c1.12.37 2.33.57 3.58.57a1 1 0 0 1 1 1V20a1 1 0 0 1-1 1A17 17 0 0 1 3 4a1 1 0 0 1 1-1h3.5a1 1 0 0 1 1 1c0 1.25.2 2.46.57 3.58a1 1 0 0 1-.24 1.01l-2.2 2.2z"/></svg><span>'+escapeHtml(c.phone)+'</span></div>';
        if (c.email) html += '<div class="bcard-contact"><svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg><span>'+escapeHtml(c.email)+'</span></div>';
        if (c.website) html += '<div class="bcard-contact"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg><span>'+escapeHtml(c.websiteDisplay || c.website)+'</span></div>';

        // Visitor link
        html += '<div class="bcard-link">';
        html += '<svg viewBox="0 0 24 24" width="12" height="12"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z" fill="rgba(255,255,255,.3)"/></svg>';
        html += '<span class="bcard-link-url" title="'+escapeHtml(cardUrl)+'">'+escapeHtml(cardUrl)+'</span>';
        html += '<button class="bcard-link-copy" onclick="event.stopPropagation();copyBcardLink(\''+id+'\',this)"><svg viewBox="0 0 24 24" width="13" height="13"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z" fill="currentColor"/></svg></button>';
        html += '</div>';
        html += '</div>';

        // Actions
        html += '<div class="bcard-actions">';
        if (isInactive) {
            html += '<button class="bcard-action" disabled style="opacity:.4;cursor:not-allowed"><svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a.996.996 0 0 0 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>Edit</button>';
            html += '<button class="bcard-action" onclick="previewCardById(\''+id+'\')"><svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>Preview</button>';
        } else {
            html += '<button class="bcard-action" onclick="openCardEdit(\''+id+'\')"><svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a.996.996 0 0 0 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>Edit</button>';
            html += '<button class="bcard-action" onclick="previewCardById(\''+id+'\')"><svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>Preview</button>';
            html += '<button class="bcard-action" onclick="shareCardById(\''+id+'\')"><svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/></svg>Share</button>';
            if (c._verifiedAt) {
                html += '<span class="bcard-action bcard-verified" title="Verified"><svg viewBox="0 0 24 24" width="14" height="14" fill="none"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z" fill="#059669"/><path d="M9 12l2 2 4-4" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>Verified</span>';
            } else if (c.email) {
                html += '<button class="bcard-action verify-action" onclick="event.stopPropagation();openVerifyCard(\''+id+'\')"><svg viewBox="0 0 24 24" width="14" height="14" fill="none"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z" fill="currentColor" opacity=".6"/><path d="M9 12l2 2 4-4" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>Verify</button>';
            }
        }
        html += '<button class="bcard-action delete-action" onclick="deleteCard(\''+id+'\')"><svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button>';
        html += '</div>';
        html += '</div>';
    });
    // Add card button
    html += '<button class="add-card-btn" onclick="openCardEdit()">';
    html += '<svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>';
    html += 'Add New Card';
    html += '</button>';
    document.getElementById('cardsList').innerHTML = html;
    // Scroll hint: hide fade when scrolled to end
    var cl = document.getElementById('cardsList');
    var cp = document.getElementById('cardsPanel');
    if (cl && cp) {
        var checkEnd = function() {
            var atEnd = cl.scrollLeft + cl.clientWidth >= cl.scrollWidth - 10;
            cp.classList.toggle('scrolled-end', atEnd);
        };
        cl.removeEventListener('scroll', checkEnd);
        cl.addEventListener('scroll', checkEnd, { passive: true });
        setTimeout(checkEnd, 100);
    }
}

var editingProducts = [];

function showCardTab(tabName) {
    document.querySelectorAll('.card-tab').forEach(function(t){ t.classList.remove('active'); });
    document.querySelectorAll('.card-tab-content').forEach(function(c){ c.classList.remove('active'); });
    document.querySelector('.card-tab[onclick*="'+tabName+'"]').classList.add('active');
    document.getElementById('tab-'+tabName).classList.add('active');
}

function openCardEdit(cardId) {
    // Check plan limit for new cards — re-fetch profile if stale
    if (!cardId && !canAddCard()) {
        apiFetch('/auth/me').then(function(r) { return r.json(); }).then(function(profile) {
            if (profile && !profile.error) {
                currentUserProfile = profile;
                currentUser = { uid: profile.id, email: profile.email };
            }
            if (canAddCard()) {
                openCardEdit(null); // retry now that profile is fresh
            } else {
                var plan = getUserPlan();
                var limit = PLAN_LIMITS[plan] ? PLAN_LIMITS[plan].cards : 1;
                showUpgradeModal('Your ' + plan + ' plan allows ' + limit + ' card(s). Upgrade to create more.');
            }
        }).catch(function() {
            var plan = getUserPlan();
            var limit = PLAN_LIMITS[plan] ? PLAN_LIMITS[plan].cards : 1;
            showUpgradeModal('Your ' + plan + ' plan allows ' + limit + ' card(s). Upgrade to create more.');
        });
        return;
    }
    editingCardId = cardId || null;
    document.getElementById('cardEditTitle').textContent = cardId ? 'Edit Card' : 'Add Card';
    showCardTab('basic');

    if (cardId && CARDS[cardId]) {
        var c = CARDS[cardId];
        document.getElementById('cardEditId').value = cardId;
        // Basic
        document.getElementById('cardName').value = c.name || '';
        document.getElementById('cardTitle').value = c.title || '';
        document.getElementById('cardCompany').value = c.company || '';
        document.getElementById('cardSlug').value = cardId;
        document.getElementById('cardSlug').disabled = true;
        document.getElementById('cardEditSubtitle').value = c.subtitle || '';
        document.getElementById('cardBio').value = c.bio || '';
        // Contact
        document.getElementById('cardPhone').value = c.phone || '';
        document.getElementById('cardWhatsapp').value = c.whatsapp || '';
        document.getElementById('cardEmail').value = c.email || '';
        document.getElementById('cardAddress').value = c.address || '';
        document.getElementById('cardWebsite').value = c.website || '';
        document.getElementById('cardWebsiteDisplay').value = c.websiteDisplay || '';
        // Social
        document.getElementById('cardLinkedin').value = c.linkedin || '';
        document.getElementById('cardInstagram').value = c.instagram || '';
        document.getElementById('cardTwitter').value = c.twitter || '';
        document.getElementById('cardCalendly').value = c.calendly || '';
        // Brand
        selectedColor = c.color || c.color1 || '#1B1464';
        document.getElementById('cardCustomColor').value = selectedColor;
        document.getElementById('cardLogo').value = c.logo || '';
        document.getElementById('cardPhoto').value = c.photo || '';
        // Products
        editingProducts = c.products ? JSON.parse(JSON.stringify(c.products)) : [];
    } else {
        // Clear all fields for new card
        ['cardName','cardTitle','cardCompany','cardSlug','cardEditSubtitle','cardBio','cardPhone','cardWhatsapp',
         'cardEmail','cardAddress','cardWebsite','cardWebsiteDisplay','cardLinkedin','cardInstagram',
         'cardTwitter','cardCalendly','cardLogo','cardPhoto'].forEach(function(id){
            var el = document.getElementById(id);
            if (el) el.value = '';
        });
        document.getElementById('cardEditId').value = '';
        document.getElementById('cardSlug').disabled = false;
        selectedColor = '#1B1464';
        document.getElementById('cardCustomColor').value = selectedColor;
        editingProducts = [];
    }

    updateColorPicker();
    renderTemplateGrid();
    renderProductsEditor();
    updateSlugPreview();
    updateImagePreviews();
    document.getElementById('cardEditModal').classList.add('show');
}

function closeCardEdit() {
    document.getElementById('cardEditModal').classList.remove('show');
    editingCardId = null;
    editingProducts = [];
    document.getElementById('slugPreview').innerHTML = '';
    document.getElementById('cardSlug').disabled = false;
    // Clear image previews
    clearCardImage('cardLogo', 'logoPreview');
    clearCardImage('cardPhoto', 'photoPreview');
}

function updateColorPicker() {
    document.querySelectorAll('.color-picker-opt').forEach(function(opt) {
        opt.classList.toggle('selected', opt.dataset.color === selectedColor);
        opt.onclick = function() {
            selectedColor = opt.dataset.color;
            document.getElementById('cardCustomColor').value = selectedColor;
            updateColorPicker();
        };
    });
}

function renderProductsEditor() {
    var html = '';
    editingProducts.forEach(function(p, i) {
        html += '<div class="product-item"><div class="product-item-header"><span class="product-item-title">Product '+(i+1)+'</span><button class="remove-product" onclick="removeProduct('+i+')">&times;</button></div>'+
            '<input type="text" placeholder="Product name" value="'+escapeHtml(p.name||'')+'" onchange="editingProducts['+i+'].name=this.value">'+
            '<input type="text" placeholder="Price (e.g. $100/unit)" value="'+escapeHtml(p.price||'')+'" onchange="editingProducts['+i+'].price=this.value">'+
            '<input type="text" placeholder="Image URL" value="'+escapeHtml(p.image||'')+'" onchange="editingProducts['+i+'].image=this.value">'+
            '</div>';
    });
    document.getElementById('productsContainer').innerHTML = html;
}

function addProductField() {
    editingProducts.push({name:'', price:'', image:''});
    renderProductsEditor();
}

function removeProduct(idx) {
    editingProducts.splice(idx, 1);
    renderProductsEditor();
}

// Image upload: resize on client, store as base64 data URI
function handleCardImage(input, urlInputId, previewId, maxSize) {
    if (!input.files || !input.files[0]) return;
    var file = input.files[0];
    if (file.size > 10 * 1024 * 1024) { alert('Image too large (max 10MB)'); input.value = ''; return; }
    var reader = new FileReader();
    reader.onload = function(e) {
        var img = new Image();
        img.onload = function() {
            var canvas = document.createElement('canvas');
            var w = img.width, h = img.height;
            if (w > maxSize || h > maxSize) {
                if (w > h) { h = Math.round(h * maxSize / w); w = maxSize; }
                else { w = Math.round(w * maxSize / h); h = maxSize; }
            }
            canvas.width = w; canvas.height = h;
            var ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, w, h);
            var dataUrl = canvas.toDataURL('image/jpeg', 0.75);
            document.getElementById(urlInputId).value = dataUrl;
            var preview = document.getElementById(previewId);
            preview.querySelector('img').src = dataUrl;
            preview.classList.add('show');
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
    input.value = '';
}

function clearCardImage(urlInputId, previewId) {
    document.getElementById(urlInputId).value = '';
    var preview = document.getElementById(previewId);
    preview.querySelector('img').src = '';
    preview.classList.remove('show');
}

function updateImagePreviews() {
    ['cardLogo:logoPreview', 'cardPhoto:photoPreview'].forEach(function(pair) {
        var parts = pair.split(':');
        var val = document.getElementById(parts[0]).value;
        var preview = document.getElementById(parts[1]);
        if (val && (val.startsWith('data:') || val.startsWith('http'))) {
            preview.querySelector('img').src = val;
            preview.classList.add('show');
        } else {
            preview.classList.remove('show');
        }
    });
}

function saveCard() {
    var name = document.getElementById('cardName').value.trim();
    var title = document.getElementById('cardTitle').value.trim();
    var company = document.getElementById('cardCompany').value.trim();
    var subtitle = document.getElementById('cardEditSubtitle').value.trim() || (title + ' — ' + company);

    if (!name) { alert('Please enter your name'); showCardTab('basic'); return; }
    if (!title) { alert('Please enter a job title'); showCardTab('basic'); return; }
    if (!company) { alert('Please enter a company name'); showCardTab('basic'); return; }

    // Plan limit check for new cards (server is the real gate, this is just UX)
    if (!editingCardId && !canAddCard()) {
        // Profile might be stale — let the server decide
    }

    // Use slug field for new cards, editingCardId for existing
    var slugInput = document.getElementById('cardSlug').value.trim();
    var cardId;
    if (editingCardId) {
        cardId = editingCardId;
    } else if (slugInput) {
        cardId = slugInput.toLowerCase().replace(/[^a-z0-9-]/g, '').replace(/^-|-$/g, '');
        if (!cardId) { alert('Please enter a valid URL slug'); showCardTab('basic'); return; }
        if (CARDS[cardId]) { alert('This slug is already taken. Choose another.'); showCardTab('basic'); return; }
    } else {
        cardId = generateSlug(company) || 'card-' + Date.now().toString(36);
        if (CARDS[cardId]) cardId = cardId.substring(0, 35) + '-' + Date.now().toString(36).slice(-4);
    }
    var token = (CARDS[cardId] && CARDS[cardId].token) || generateToken();
    var phone = document.getElementById('cardPhone').value.trim();
    var website = document.getElementById('cardWebsite').value.trim();
    var address = document.getElementById('cardAddress').value.trim();

    // Auto-generate derived fields
    var phoneDisplay = phone;
    var whatsapp = document.getElementById('cardWhatsapp').value.trim() || phone.replace(/[^0-9]/g,'');
    var websiteDisplay = document.getElementById('cardWebsiteDisplay').value.trim() || website.replace(/^https?:\/\//, '').replace(/\/$/, '');
    var addressQuery = address.replace(/\s+/g, '+').replace(/,/g, '');

    // Compute color variations
    var color1 = selectedColor;
    var color2 = darkenColor(selectedColor);
    var accent = selectedColor;
    var accentLight = lightenColor(selectedColor);

    var cardData = {
        name: name,
        title: title,
        company: company,
        subtitle: subtitle,
        color: selectedColor,
        color1: color1,
        color2: color2,
        accent: accent,
        accentLight: accentLight,
        gradient: 'linear-gradient(135deg,' + color1 + ',' + color2 + ')',
        token: token,
        phone: phone,
        phoneDisplay: phoneDisplay,
        whatsapp: whatsapp,
        email: document.getElementById('cardEmail').value.trim(),
        address: address,
        addressQuery: addressQuery,
        website: website,
        websiteDisplay: websiteDisplay,
        bio: document.getElementById('cardBio').value.trim(),
        logo: document.getElementById('cardLogo').value.trim(),
        photo: document.getElementById('cardPhoto').value.trim(),
        linkedin: document.getElementById('cardLinkedin').value.trim(),
        instagram: document.getElementById('cardInstagram').value.trim(),
        twitter: document.getElementById('cardTwitter').value.trim(),
        calendly: document.getElementById('cardCalendly').value.trim(),
        products: editingProducts.filter(function(p){ return p.name; }),
        vcardAdr: ';;'+address.replace(/,/g,'\\,')+';;;;'
    };

    // Save card — show loading, check response
    var saveBtn = document.querySelector('.card-edit-save');
    saveBtn.disabled = true;
    saveBtn.textContent = 'Saving...';
    apiFetch('/cards/' + cardId, {
        method: 'PUT',
        body: cardData
    }).then(function(r) {
        if (!r.ok) return r.json().then(function(err) { throw new Error(err.error || 'Save failed (HTTP ' + r.status + ')'); });
        // Update local data
        CARDS[cardId] = cardData;
        if (CARD_IDS.indexOf(cardId) === -1) CARD_IDS.push(cardId);
        rebuildCardMaps();
        initCardElements();
        renderCardsList();
        closeCardEdit();
        generateQR();
        showToast('Card saved!');
        // Hide onboarding after first card is created
        var ob = document.getElementById('onboardingWelcome');
        if (ob) ob.style.display = 'none';
        var qs = document.getElementById('dashQuickShare');
        if (qs) qs.style.display = '';
        var cs = document.getElementById('dashCardsSection');
        if (cs) cs.style.display = '';
        var as = document.getElementById('dashActivitySection');
        if (as) as.style.display = '';
        loadDashboard();
    }).catch(function(err) {
        showToast(err.message || 'Couldn\'t save card. Check your connection and try again.', 'error');
    }).finally(function() {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Card';
    });
}

function lightenColor(hex) {
    var r = parseInt(hex.slice(1,3), 16);
    var g = parseInt(hex.slice(3,5), 16);
    var b = parseInt(hex.slice(5,7), 16);
    // Create a light tint
    r = Math.min(255, r + Math.floor((255 - r) * 0.85));
    g = Math.min(255, g + Math.floor((255 - g) * 0.85));
    b = Math.min(255, b + Math.floor((255 - b) * 0.85));
    return '#' + r.toString(16).padStart(2,'0') + g.toString(16).padStart(2,'0') + b.toString(16).padStart(2,'0');
}

function deleteCard(cardId) {
    if (!CARDS[cardId]) return;
    if (!confirm('Delete "' + (CARDS[cardId].company || CARDS[cardId].name) + '"? This cannot be undone.')) return;

    apiFetch('/cards/' + cardId, { method: 'DELETE' }).then(function(r) {
        if (!r.ok) throw new Error('Delete failed');
        delete CARDS[cardId];
        CARD_IDS = CARD_IDS.filter(function(id) { return id !== cardId; });
        rebuildCardMaps();
        initCardElements();
        renderCardsList();
        generateQR();
        if (CARD_IDS.length === 0) showFirstCardPrompt();
        showToast('Card deleted');
    }).catch(function(err) {
        showToast('Couldn\'t delete this card. Please try again.', 'error');
    });
}

// ── Card Verification ──

var _verifyState = {};
var _verifyPoll = null;

function openVerifyModal() {
    document.getElementById('verifyModal').classList.add('show');
}
function closeVerifyModal() {
    document.getElementById('verifyModal').classList.remove('show');
    if (_verifyPoll) { clearInterval(_verifyPoll); _verifyPoll = null; }
    _verifyState = {};
}

function openVerifyCard(cardId) {
    var c = CARDS[cardId];
    if (!c) return;
    _verifyState = { cardId: cardId, card: c, docs: [] };
    document.getElementById('verifyModalTitle').textContent = 'Verify Card';
    document.getElementById('verifyModalBody').innerHTML = '<p style="color:var(--text-muted)">Loading...</p>';
    openVerifyModal();

    // Check existing verification status
    apiFetch('/verification/status/' + cardId).then(function(r) { return r.json(); }).then(function(data) {
        if (data.exists) {
            _verifyState.id = data.id;
            _verifyState.email = data.email;
            if (data.status === 'approved') return renderVerifyStep('approved', data);
            if (data.status === 'rejected') return renderVerifyStep('rejected', data);
            if (data.status === 'escalated' || data.status === 'ai_reviewing') return renderVerifyStep('reviewing', data);
            if (data.status === 'documents_uploaded') return renderVerifyStep('documents', data);
            if (data.status === 'email_verified') return renderVerifyStep('documents', data);
            return renderVerifyStep('otp', data);
        }
        renderVerifyStep('start');
    }).catch(function() {
        renderVerifyStep('start');
    });
}

function renderVerifyStep(step, data) {
    var body = document.getElementById('verifyModalBody');
    var c = _verifyState.card;
    var h = '<div class="verify-step">';

    if (step === 'start') {
        h += '<h4>Verify your card</h4>';
        h += '<p>To get a verified badge on your card, we\'ll verify your email and review supporting documents.</p>';
        h += '<div style="padding:12px;background:var(--glass-bg);border:1px solid var(--glass-border);border-radius:8px;margin:0 0 16px">';
        h += '<div style="font-size:13px;color:var(--text-muted)">Card email</div>';
        h += '<div style="font-size:15px;color:var(--text-primary);font-weight:500">'+escapeHtml(c.email)+'</div>';
        h += '</div>';
        h += '<p style="font-size:13px">We\'ll send a verification code to this email address.</p>';
        h += '<button class="verify-btn verify-btn-primary" onclick="startVerification()">Send Verification Code</button>';
    } else if (step === 'otp') {
        var email = _verifyState.email || (data && data.email) || c.email;
        h += '<h4>Enter verification code</h4>';
        h += '<p>We sent a 6-digit code to <strong>'+escapeHtml(email)+'</strong></p>';
        h += '<div class="verify-otp-input" id="verifyOtpInputs">';
        for (var i = 0; i < 6; i++) h += '<input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" oninput="verifyOtpNav(this,'+i+')" onkeydown="verifyOtpBack(event,'+i+')">';
        h += '</div>';
        h += '<button class="verify-btn verify-btn-primary" id="verifyOtpBtn" onclick="submitVerifyOTP()" disabled>Verify Code</button>';
        h += '<button class="verify-btn verify-btn-secondary" onclick="resendVerifyOTP()">Resend Code</button>';
    } else if (step === 'documents') {
        h += '<h4>Upload supporting documents</h4>';
        h += '<p>Upload 1-3 documents to prove your identity and business. Examples: Government ID, company badge, business registration, or letterhead.</p>';
        h += '<div id="verifyDocList" class="verify-doc-list"></div>';
        h += '<div class="verify-doc-upload" onclick="document.getElementById(\'verifyDocInput\').click()">';
        h += '<svg viewBox="0 0 24 24" width="24" height="24" fill="var(--text-muted)" style="margin-bottom:4px"><path d="M19.35 10.04A7.49 7.49 0 0 0 12 4C9.11 4 6.6 5.64 5.35 8.04A5.994 5.994 0 0 0 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/></svg>';
        h += '<div style="font-size:13px;color:var(--text-muted)">Click to upload document</div>';
        h += '<input type="file" id="verifyDocInput" accept="image/*" onchange="addVerifyDoc(this)" multiple style="display:none">';
        h += '</div>';
        h += '<button class="verify-btn verify-btn-primary" id="verifyDocsSubmitBtn" onclick="uploadAndSubmitDocs()" disabled>Upload &amp; Submit for Review</button>';
    } else if (step === 'reviewing') {
        h += '<div class="verify-status-icon"><svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" stroke="var(--accent)" stroke-width="2"/><path d="M12 6v6l4 2" stroke="var(--accent)" stroke-width="2" stroke-linecap="round"/></svg></div>';
        h += '<h4 style="text-align:center">Under Review</h4>';
        h += '<p style="text-align:center">Your documents are being reviewed. This usually takes less than a minute.</p>';
        // Poll for status updates
        startVerifyPoll();
    } else if (step === 'approved') {
        h += '<div class="verify-status-icon"><svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" fill="#059669"/><path d="M8 12l3 3 5-5" stroke="#fff" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg></div>';
        h += '<h4 style="text-align:center;color:#059669">Card Verified!</h4>';
        h += '<p style="text-align:center">Your card now shows a verified badge to everyone who views it.</p>';
        h += '<button class="verify-btn verify-btn-primary" onclick="closeVerifyModal();renderCardsList()">Done</button>';
    } else if (step === 'rejected') {
        h += '<div class="verify-status-icon"><svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10" fill="#ef4444"/><path d="M8 8l8 8M16 8l-8 8" stroke="#fff" stroke-width="2.5" stroke-linecap="round"/></svg></div>';
        h += '<h4 style="text-align:center;color:#ef4444">Verification Declined</h4>';
        if (data && data.rejectionReason) h += '<p style="text-align:center">'+escapeHtml(data.rejectionReason)+'</p>';
        h += '<p style="text-align:center;font-size:13px">You can try again with different documents.</p>';
        h += '<button class="verify-btn verify-btn-primary" onclick="retryVerification()">Try Again</button>';
    }

    h += '</div>';
    body.innerHTML = h;

    // Auto-focus first OTP input
    if (step === 'otp') {
        var first = document.querySelector('#verifyOtpInputs input');
        if (first) setTimeout(function() { first.focus(); }, 100);
    }
    // Re-render doc list if on documents step
    if (step === 'documents') renderVerifyDocList();
}

function startVerification() {
    var btn = event.target;
    btn.disabled = true; btn.textContent = 'Sending...';
    apiFetch('/verification/request', { method: 'POST', body: JSON.stringify({ cardId: _verifyState.cardId }) })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.error) { showToast(data.error, 'error'); btn.disabled = false; btn.textContent = 'Send Verification Code'; return; }
        _verifyState.id = data.id;
        _verifyState.email = data.email;
        if (data.status === 'email_verified' || data.status === 'documents_uploaded') {
            renderVerifyStep('documents');
        } else {
            renderVerifyStep('otp');
        }
    }).catch(function() { showToast('Failed to start verification', 'error'); btn.disabled = false; btn.textContent = 'Send Verification Code'; });
}

function verifyOtpNav(input, idx) {
    input.value = input.value.replace(/[^0-9]/g, '');
    if (input.value && idx < 5) {
        var next = document.querySelectorAll('#verifyOtpInputs input')[idx + 1];
        if (next) next.focus();
    }
    checkVerifyOtp();
}
function verifyOtpBack(e, idx) {
    if (e.key === 'Backspace' && !e.target.value && idx > 0) {
        var prev = document.querySelectorAll('#verifyOtpInputs input')[idx - 1];
        if (prev) { prev.focus(); prev.select(); }
    }
}
function checkVerifyOtp() {
    var inputs = document.querySelectorAll('#verifyOtpInputs input');
    var code = '';
    inputs.forEach(function(inp) { code += inp.value; });
    var btn = document.getElementById('verifyOtpBtn');
    if (btn) btn.disabled = code.length !== 6;
}

function submitVerifyOTP() {
    var inputs = document.querySelectorAll('#verifyOtpInputs input');
    var code = '';
    inputs.forEach(function(inp) { code += inp.value; });
    if (code.length !== 6) return;

    var btn = document.getElementById('verifyOtpBtn');
    btn.disabled = true; btn.textContent = 'Verifying...';
    apiFetch('/verification/verify-email', { method: 'POST', body: JSON.stringify({ verificationId: _verifyState.id, code: code }) })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.error) { showToast(data.error, 'error'); btn.disabled = false; btn.textContent = 'Verify Code'; return; }
        renderVerifyStep('documents');
    }).catch(function() { showToast('Verification failed', 'error'); btn.disabled = false; btn.textContent = 'Verify Code'; });
}

function resendVerifyOTP() {
    apiFetch('/verification/resend-otp', { method: 'POST', body: JSON.stringify({ verificationId: _verifyState.id }) })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.error) return showToast(data.error, 'error');
        showToast('New code sent');
    }).catch(function() { showToast('Failed to resend code', 'error'); });
}

function addVerifyDoc(input) {
    var files = Array.from(input.files);
    files.forEach(function(file) {
        if (_verifyState.docs.length >= 3) return;
        if (!file.type.startsWith('image/')) { showToast('Only images allowed', 'error'); return; }
        if (file.size > 5 * 1024 * 1024) { showToast('File too large (max 5MB)', 'error'); return; }

        var reader = new FileReader();
        reader.onload = function(e) {
            // Resize on canvas
            var img = new Image();
            img.onload = function() {
                var maxDim = 1200;
                var w = img.width, h = img.height;
                if (w > maxDim || h > maxDim) {
                    if (w > h) { h = Math.round(h * maxDim / w); w = maxDim; }
                    else { w = Math.round(w * maxDim / h); h = maxDim; }
                }
                var canvas = document.createElement('canvas');
                canvas.width = w; canvas.height = h;
                canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                var dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                _verifyState.docs.push({ label: 'Document', data: dataUrl, name: file.name });
                renderVerifyDocList();
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    });
    input.value = '';
}

function renderVerifyDocList() {
    var list = document.getElementById('verifyDocList');
    if (!list) return;
    var h = '';
    _verifyState.docs.forEach(function(doc, i) {
        h += '<div class="verify-doc-item">';
        h += '<img src="'+doc.data+'" alt="Doc '+(i+1)+'">';
        h += '<div class="doc-info">';
        h += '<div class="doc-name">'+escapeHtml(doc.name || 'Document '+(i+1))+'</div>';
        h += '<select class="verify-label-select" onchange="_verifyState.docs['+i+'].label=this.value">';
        h += '<option value="Government ID"'+(doc.label==='Government ID'?' selected':'')+'>Government ID</option>';
        h += '<option value="Company Badge"'+(doc.label==='Company Badge'?' selected':'')+'>Company Badge</option>';
        h += '<option value="Business Registration"'+(doc.label==='Business Registration'?' selected':'')+'>Business Cert</option>';
        h += '<option value="Letterhead"'+(doc.label==='Letterhead'?' selected':'')+'>Letterhead</option>';
        h += '<option value="Other"'+(doc.label==='Other'?' selected':'')+'>Other</option>';
        h += '</select>';
        h += '</div>';
        h += '<button class="doc-remove" onclick="_verifyState.docs.splice('+i+',1);renderVerifyDocList()">&times;</button>';
        h += '</div>';
    });
    list.innerHTML = h;

    var btn = document.getElementById('verifyDocsSubmitBtn');
    var upload = document.querySelector('.verify-doc-upload');
    if (btn) btn.disabled = _verifyState.docs.length === 0;
    if (upload) upload.style.display = _verifyState.docs.length >= 3 ? 'none' : '';
}

function uploadAndSubmitDocs() {
    if (_verifyState.docs.length === 0) return;
    var btn = document.getElementById('verifyDocsSubmitBtn');
    btn.disabled = true; btn.textContent = 'Uploading...';

    var docs = _verifyState.docs.map(function(d) { return { label: d.label, data: d.data }; });
    apiFetch('/verification/upload-documents', { method: 'POST', body: JSON.stringify({ verificationId: _verifyState.id, documents: docs }) })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.error) { showToast(data.error, 'error'); btn.disabled = false; btn.textContent = 'Upload & Submit for Review'; return; }
        btn.textContent = 'Submitting...';
        return apiFetch('/verification/submit', { method: 'POST', body: JSON.stringify({ verificationId: _verifyState.id }) })
        .then(function(r) { return r.json(); })
        .then(function(data2) {
            if (data2.error) { showToast(data2.error, 'error'); btn.disabled = false; btn.textContent = 'Upload & Submit for Review'; return; }
            renderVerifyStep('reviewing');
        });
    }).catch(function() { showToast('Upload failed', 'error'); btn.disabled = false; btn.textContent = 'Upload & Submit for Review'; });
}

function startVerifyPoll() {
    if (_verifyPoll) clearInterval(_verifyPoll);
    _verifyPoll = setInterval(function() {
        apiFetch('/verification/status/' + _verifyState.cardId).then(function(r) { return r.json(); }).then(function(data) {
            if (!data.exists) return;
            if (data.status === 'approved') {
                clearInterval(_verifyPoll); _verifyPoll = null;
                // Update local card data
                if (CARDS[_verifyState.cardId]) CARDS[_verifyState.cardId]._verifiedAt = new Date().toISOString();
                renderVerifyStep('approved', data);
            } else if (data.status === 'rejected') {
                clearInterval(_verifyPoll); _verifyPoll = null;
                renderVerifyStep('rejected', data);
            } else if (data.status === 'escalated') {
                clearInterval(_verifyPoll); _verifyPoll = null;
                document.getElementById('verifyModalBody').querySelector('h4').textContent = 'Under Manual Review';
                document.getElementById('verifyModalBody').querySelector('p').textContent = 'Your documents have been escalated for manual review by our team. You\'ll receive an email when the review is complete.';
            }
        }).catch(function() {});
    }, 3000);
}

function retryVerification() {
    _verifyState.docs = [];
    renderVerifyStep('start');
}

function rebuildCardMaps() {
    NAMES = {}; CARD_COLORS = {}; TOKEN_BY_CARD = {}; TOKENS = {};
    CARD_IDS.forEach(function(id) {
        var c = CARDS[id];
        NAMES[id] = c.company || c.name;
        CARD_COLORS[id] = c.color;
        TOKEN_BY_CARD[id] = c.token;
        TOKENS[c.token] = id;
    });
}

function loadCardsFromFirebase() {
    apiFetch('/cards').then(function(r) { return r.json(); }).then(function(data) {
        if (data && typeof data === 'object' && Object.keys(data).length > 0) {
            // Load cards from Firebase
            var loadedCards = {};
            var loadedIds = [];
            for (var id in data) {
                if (data.hasOwnProperty(id)) {
                    var c = data[id];
                    if (c && typeof c === 'object' && c.name) {
                        // Ensure all required fields exist
                        if (!c.gradient && c.color) {
                            c.gradient = 'linear-gradient(135deg,' + c.color + ',' + darkenColor(c.color) + ')';
                        }
                        if (!c.token) c.token = generateToken();
                        if (!c.subtitle) c.subtitle = '';
                        loadedCards[id] = c;
                        loadedIds.push(id);
                    }
                }
            }
            if (loadedIds.length > 0) {
                CARDS = loadedCards;
                CARD_IDS = loadedIds;
                rebuildCardMaps();
                initCardElements();
                generateQR();
                renderDashCardTiles();
                updateNfcFab();
                if (currentPage === 'cards') renderCardsList();
                renderTapLog(); // re-render now that CARD_IDS are loaded
            } else {
                seedDefaultCards();
            }
        } else {
            // No cards in Firebase - seed with defaults
            seedDefaultCards();
        }
    }).catch(function(err) {
        // Use default cards if Firebase fails
        console.error('Error loading cards:', err);
        rebuildCardMaps();
        initCardElements();
        generateQR();
    });
}

function seedDefaultCards() {
    // New user — no cards yet. Show the onboarding wizard.
    CARDS = {};
    CARD_IDS = [];
    rebuildCardMaps();
    initCardElements();
    showFirstCardPrompt();
    // Hide dashboard sections until card is created
    var qs = document.getElementById('dashQuickShare');
    if (qs) qs.style.display = 'none';
    var cs = document.getElementById('dashCardsSection');
    if (cs) cs.style.display = 'none';
    var as = document.getElementById('dashActivitySection');
    if (as) as.style.display = 'none';
    // Launch welcome screen (which leads to wizard)
    showWelcomeScreen();
}

function showFirstCardPrompt() {
    var cardsList = document.getElementById('cardsList');
    if (cardsList) {
        cardsList.innerHTML = '<div class="empty-state">' +
            '<div class="empty-state-icon"><svg viewBox="0 0 24 24" width="40" height="40" fill="none" stroke="var(--text-muted)" stroke-width="1.5"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M6 10h2v2H6zM6 14h8v2H6zM16 14h2v2h-2zM10 10h8v2h-8z"/></svg></div>' +
            '<div class="empty-state-title">No cards yet</div>' +
            '<div class="empty-state-desc">Create your first digital business card to start sharing and capturing leads.</div>' +
            '<button class="empty-state-btn" onclick="openCardEdit()">Create Card</button>' +
            '</div>';
    }
    // Also show the cards panel automatically for first-time users
    var cardsPanel = document.getElementById('cardsPanel');
    if (cardsPanel && !cardsPanel.classList.contains('show')) {
        showCardsPanel();
    }
}

// ── Billing / Razorpay ──

function loadRazorpay() {
    if (window.Razorpay) return Promise.resolve();
    return new Promise(function(resolve, reject) {
        var s = document.createElement('script');
        s.src = 'https://checkout.razorpay.com/v1/checkout.js';
        s.onload = resolve;
        s.onerror = reject;
        document.head.appendChild(s);
    });
}

function showBillingPanel() {
    var plan = getUserPlan();
    var planEl = document.getElementById('billingCurrentPlan');
    var statusEl = document.getElementById('billingPlanStatus');
    var upgradeEl = document.getElementById('billingUpgradeSection');
    var manageEl = document.getElementById('billingManageSection');

    if (planEl) planEl.textContent = plan.charAt(0).toUpperCase() + plan.slice(1);

    if (plan === 'free') {
        upgradeEl.style.display = '';
        manageEl.style.display = 'none';
        if (statusEl) statusEl.textContent = '1 card, 25 leads/month';
    } else {
        upgradeEl.style.display = 'none';
        manageEl.style.display = '';
        if (statusEl) {
            var limits = PLAN_LIMITS[plan] || {};
            var cardsText = limits.cards === -1 ? 'Unlimited' : limits.cards;
            var leadsText = limits.leadsPerMonth === -1 ? 'Unlimited' : limits.leadsPerMonth;
            statusEl.textContent = cardsText + ' cards, ' + leadsText + ' leads/month';
        }
    }

    // Update settings label too
    var label = document.getElementById('currentPlanLabel');
    if (label) label.textContent = plan.charAt(0).toUpperCase() + plan.slice(1) + ' plan';

    document.getElementById('billingPanel').classList.add('show');
}

function hideBillingPanel() {
    document.getElementById('billingPanel').classList.remove('show');
}

function showUpgradeModal(reason) {
    var el = document.getElementById('upgradeModalReason');
    if (el) el.textContent = reason || 'Unlock more features to grow your network.';
    document.getElementById('upgradeModal').classList.add('show');
}

function hideUpgradeModal() {
    document.getElementById('upgradeModal').classList.remove('show');
}

function dismissProBanner() {
    document.getElementById('proTrialBanner').style.display = 'none';
    localStorage.setItem('proTrialBannerDismissed', Date.now());
}

function maybeShowProBanner() {
    if (getUserPlan() !== 'free') return;
    var banner = document.getElementById('proTrialBanner');
    if (!banner) return;
    var dismissed = localStorage.getItem('proTrialBannerDismissed');
    // Show again after 7 days
    if (dismissed && (Date.now() - parseInt(dismissed, 10)) < 7 * 24 * 60 * 60 * 1000) return;
    banner.style.display = '';
}

function startCheckout(plan, interval, event) {
    var btn = event ? event.target.closest('.settings-item, [onclick*="startCheckout"]') : null;
    if (btn) btn.style.opacity = '0.5';

    loadRazorpay().then(function() {
    apiFetch('/billing/create-order', {
        method: 'POST',
        body: { plan: plan }
    }).then(function(r) { return r.json(); }).then(function(data) {
        if (data.orderId) {
            var options = {
                key: data.keyId,
                amount: data.amount,
                currency: data.currency,
                name: 'CardFlow',
                description: plan.charAt(0).toUpperCase() + plan.slice(1) + ' Plan',
                order_id: data.orderId,
                handler: function(response) {
                    verifyRazorpayPayment(response, plan);
                },
                prefill: {
                    email: currentUserProfile ? currentUserProfile.email : '',
                    name: currentUserProfile ? currentUserProfile.name : ''
                },
                theme: {
                    color: '#6366f1'
                },
                modal: {
                    ondismiss: function() {
                        if (btn) btn.style.opacity = '';
                    }
                }
            };
            var rzp = new Razorpay(options);
            rzp.on('payment.failed', function(response) {
                showUpdateToast('Payment failed: ' + (response.error.description || 'Please try again.'));
                if (btn) btn.style.opacity = '';
            });
            rzp.open();
        } else {
            showUpdateToast(data.error || 'Couldn\'t start checkout. Please try again.');
            if (btn) btn.style.opacity = '';
        }
    }).catch(function(err) {
        showUpdateToast('Couldn\'t start checkout. Please try again.');
        if (btn) btn.style.opacity = '';
    });
    }).catch(function() {
        showUpdateToast('Could not load payment SDK. Please try again.');
        if (btn) btn.style.opacity = '';
    });
}

function verifyRazorpayPayment(response, plan) {
    apiFetch('/billing/verify-payment', {
        method: 'POST',
        body: {
            razorpay_order_id: response.razorpay_order_id,
            razorpay_payment_id: response.razorpay_payment_id,
            razorpay_signature: response.razorpay_signature
        }
    }).then(function(r) { return r.json(); }).then(function(data) {
        if (data.success) {
            if (currentUserProfile) currentUserProfile.plan = data.plan;
            var label = document.getElementById('currentPlanLabel');
            if (label) label.textContent = data.plan.charAt(0).toUpperCase() + data.plan.slice(1) + ' plan';
            showUpdateToast(data.plan.charAt(0).toUpperCase() + data.plan.slice(1) + ' plan activated!');
            hideBillingPanel();
            hideUpgradeModal();
            loadDashboard();
        } else {
            showUpdateToast(data.error || 'Payment verification failed. Contact support.');
        }
    }).catch(function(err) {
        showUpdateToast('Payment verification failed. Please contact support.');
    });
}

function openBillingPortal() {
    apiFetch('/billing/subscription').then(function(r){ return r.json(); }).then(function(sub) {
        var plan = sub.plan || 'free';
        var status = sub.status || 'none';
        var periodEnd = sub.currentPeriodEnd;
        var html = '<div style="padding:16px 0;text-align:center">';
        html += '<div style="font-size:14px;color:rgba(255,255,255,.5);margin-bottom:4px">Current Plan</div>';
        html += '<div style="font-size:24px;font-weight:700;color:#6366f1;text-transform:capitalize">' + escapeHtml(plan) + '</div>';
        html += '<div style="font-size:13px;color:rgba(255,255,255,.5);margin-top:4px">Status: ' + escapeHtml(status) + '</div>';
        if (periodEnd && plan !== 'free') {
            var expDate = new Date(periodEnd * 1000);
            html += '<div style="font-size:13px;color:rgba(255,255,255,.5);margin-top:4px">Active until: ' + expDate.toLocaleDateString('en-IN', {day:'numeric',month:'short',year:'numeric'}) + '</div>';
        }
        html += '</div>';
        if (plan !== 'free' && status === 'active') {
            html += '<div style="padding:0 0 16px;text-align:center">';
            html += '<button onclick="cancelSubscription()" style="background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);color:#ef4444;padding:10px 24px;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer">Cancel Subscription</button>';
            html += '<p style="font-size:12px;color:rgba(255,255,255,.4);margin-top:8px">Your features remain active until the billing period ends.</p>';
            html += '</div>';
        } else if (plan !== 'free' && status === 'cancelled' && periodEnd) {
            var cancelExpDate = new Date(periodEnd * 1000);
            html += '<div style="padding:0 0 16px;text-align:center">';
            html += '<div style="font-size:13px;color:#f59e0b;font-weight:600;margin-bottom:4px">Cancellation pending</div>';
            html += '<p style="font-size:12px;color:rgba(255,255,255,.4)">Your ' + escapeHtml(plan) + ' features remain active until ' + cancelExpDate.toLocaleDateString('en-IN', {day:'numeric',month:'short',year:'numeric'}) + '. After that, you will be downgraded to Free.</p>';
            html += '</div>';
        }
        html += '<p style="text-align:center;font-size:12px;color:rgba(255,255,255,.4);margin:8px 0">For payment issues, email <a href="mailto:support@cardflow.cloud" style="color:#6366f1">support@cardflow.cloud</a></p>';
        document.getElementById('billingManageSection').innerHTML = html;
    }).catch(function(e) {
        console.error('Billing portal load failed:', e);
        showUpdateToast('Could not load billing info. Please try again.');
    });
}

function cancelSubscription() {
    if (!confirm('Cancel your subscription? Your plan will stay active until the end of your current billing period, then downgrade to Free.')) return;
    apiFetch('/billing/cancel', { method: 'POST' }).then(function(r){ return r.json(); }).then(function(d) {
        if (d.success) {
            if (d.immediate) {
                showUpdateToast('Subscription cancelled. You are now on the Free plan.');
                document.getElementById('billingCurrentPlan').textContent = 'Free';
                document.getElementById('billingUpgradeSection').style.display = '';
                document.getElementById('billingManageSection').style.display = 'none';
                if (typeof currentUserProfile !== 'undefined') currentUserProfile.plan = 'free';
            } else {
                var until = d.activeUntil ? new Date(d.activeUntil * 1000).toLocaleDateString('en-IN', {day:'numeric',month:'short',year:'numeric'}) : '';
                showUpdateToast('Subscription cancelled. Your ' + (d.plan || '').charAt(0).toUpperCase() + (d.plan || '').slice(1) + ' plan stays active until ' + until + '.');
            }
            openBillingPortal();
            loadDashboard();
        } else {
            showUpdateToast(d.error || 'Cancellation failed. Contact support.');
        }
    }).catch(function(e) {
        console.error('Cancel subscription failed:', e);
        showUpdateToast('Cancellation failed. Please contact support@cardflow.cloud');
    });
}

// ── Referral System ──

function showReferralPanel() {
    document.getElementById('referralPanel').classList.add('show');
    loadReferralData();
}

function hideReferralPanel() {
    document.getElementById('referralPanel').classList.remove('show');
}

function loadReferralData() {
    // Load referral code/link
    apiFetch('/referrals/code').then(function(r) { return r.json(); }).then(function(data) {
        if (data.link) {
            document.getElementById('referralLinkInput').value = data.link;
        }
    }).catch(function() {});

    // Populate NFC/card link
    var nfcInput = document.getElementById('referralNfcLinkInput');
    if (nfcInput && currentUserProfile && currentUserProfile.username) {
        nfcInput.value = BASE_URL + '/' + currentUserProfile.username + '?nfc=1';
    }

    // Load stats
    apiFetch('/referrals/stats').then(function(r) { return r.json(); }).then(function(data) {
        document.getElementById('refStatInvites').textContent = data.invitesSent || 0;
        document.getElementById('refStatSignups').textContent = data.signups || 0;
        document.getElementById('refStatMonths').textContent = data.monthsEarned || 0;

        // Recent invites
        var recentSection = document.getElementById('refRecentSection');
        var recentList = document.getElementById('refRecentList');
        if (data.recent && data.recent.length > 0) {
            recentSection.style.display = '';
            recentList.innerHTML = '';
            data.recent.forEach(function(inv) {
                var statusColor = inv.status === 'rewarded' ? '#10b981' : inv.status === 'signed_up' ? '#6366f1' : '#64748b';
                var statusText = inv.status === 'rewarded' ? 'Rewarded' : inv.status === 'signed_up' ? 'Signed up' : 'Pending';
                var el = document.createElement('div');
                el.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:rgba(255,255,255,.04);border-radius:8px;font-size:13px';
                el.innerHTML = '<span style="color:rgba(255,255,255,.7);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:60%">' + escapeHtml(inv.invitee_email) + '</span>' +
                    '<span style="color:' + statusColor + ';font-weight:500;font-size:12px">' + statusText + '</span>';
                recentList.appendChild(el);
            });
        } else {
            recentSection.style.display = 'none';
        }
    }).catch(function() {});
}

function copyReferralLink() {
    var input = document.getElementById('referralLinkInput');
    var btn = document.getElementById('copyRefBtn');
    if (!input.value) return;
    navigator.clipboard.writeText(input.value).then(function() {
        btn.textContent = 'Copied!';
        btn.style.background = '#10b981';
        setTimeout(function() { btn.textContent = 'Copy'; btn.style.background = '#6366f1'; }, 2000);
    }).catch(function() {
        input.select();
        document.execCommand('copy');
        btn.textContent = 'Copied!';
        btn.style.background = '#10b981';
        setTimeout(function() { btn.textContent = 'Copy'; btn.style.background = '#6366f1'; }, 2000);
    });
}

// copyNfcLink consolidated below (single definition)

function sendInviteEmail() {
    var input = document.getElementById('inviteEmailInput');
    var btn = document.getElementById('sendInviteBtn');
    var feedback = document.getElementById('inviteFeedback');
    var email = input.value.trim();
    if (!email) { feedback.style.color = 'var(--danger)'; feedback.textContent = 'Please enter an email'; return; }

    btn.disabled = true;
    btn.textContent = 'Sending...';
    feedback.textContent = '';

    apiFetch('/referrals/send-invite', {
        method: 'POST',
        body: { email: email }
    }).then(function(r) { return r.json().then(function(d) { return { ok: r.ok, data: d }; }); })
    .then(function(result) {
        btn.disabled = false;
        btn.textContent = 'Send';
        if (result.ok) {
            feedback.style.color = 'var(--success)';
            feedback.textContent = 'Invite sent to ' + email + '!';
            input.value = '';
            loadReferralData();
        } else {
            feedback.style.color = 'var(--danger)';
            feedback.textContent = result.data.error || 'Failed to send invite';
        }
    })
    .catch(function() {
        btn.disabled = false;
        btn.textContent = 'Send';
        feedback.style.color = 'var(--danger)';
        feedback.textContent = 'Failed to send invite. Try again.';
    });
}

// ── Account Deletion (GDPR) ──
function deleteAccount() {
    if (!currentUser) return;
    if (!confirm('Are you sure you want to delete your account? ALL your cards, leads, analytics, and settings will be permanently deleted. This cannot be undone.')) return;
    if (!confirm('This is your FINAL warning. Type "DELETE" in the next prompt to confirm.')) return;
    var confirmation = prompt('Type DELETE to permanently remove your account:');
    if (confirmation !== 'DELETE') { showUpdateToast('Account deletion cancelled.'); return; }

    // Require password for password-based accounts
    var body = {};
    if (currentUserProfile && currentUserProfile.has_password) {
        var pw = prompt('Enter your password to confirm account deletion:');
        if (!pw) { showUpdateToast('Account deletion cancelled.'); return; }
        body.password = pw;
    } else {
        body.confirm = true;
    }

    // Delete account via API (CASCADE handles all related data)
    apiFetch('/auth/account', { method: 'DELETE', body: body }).then(function(r) {
        return r.json().then(function(d) { return { ok: r.ok, data: d }; });
    }).then(function(result) {
        if (!result.ok) {
            showUpdateToast(result.data.error || 'Failed to delete account.');
            return;
        }
        localStorage.clear();
        alert('Your account has been deleted.');
        window.location.href = '/';
    }).catch(function(err) {
        showUpdateToast('Couldn\'t delete your account. Please try again.');
    });
}

// ── Password Change/Set ──
function togglePwDash(btn) {
    var input = btn.parentElement.querySelector('input');
    var show = input.type === 'password';
    input.type = show ? 'text' : 'password';
    btn.innerHTML = show
        ? '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>'
        : '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>';
}

function showPasswordModal() {
    var hasPassword = currentUserProfile && currentUserProfile.has_password;
    var modal = document.getElementById('passwordModal');
    var title = document.getElementById('passwordModalTitle');
    var currentGroup = document.getElementById('pwCurrentGroup');
    var submitBtn = document.getElementById('pwSubmitBtn');

    title.textContent = hasPassword ? 'Change Password' : 'Set Password';
    submitBtn.textContent = hasPassword ? 'Update Password' : 'Set Password';
    currentGroup.style.display = hasPassword ? 'block' : 'none';

    // Reset fields
    document.getElementById('pwCurrent').value = '';
    document.getElementById('pwNew').value = '';
    document.getElementById('pwConfirm').value = '';
    document.getElementById('pwError').style.display = 'none';
    document.getElementById('pwSuccess').style.display = 'none';
    submitBtn.disabled = false;

    modal.classList.add('show');
    (hasPassword ? document.getElementById('pwCurrent') : document.getElementById('pwNew')).focus();
}

function hidePasswordModal() {
    document.getElementById('passwordModal').classList.remove('show');
}

function submitPasswordChange() {
    var errorEl = document.getElementById('pwError');
    var successEl = document.getElementById('pwSuccess');
    var btn = document.getElementById('pwSubmitBtn');
    errorEl.style.display = 'none';
    successEl.style.display = 'none';

    var hasPassword = currentUserProfile && currentUserProfile.has_password;
    var currentPw = document.getElementById('pwCurrent').value;
    var newPw = document.getElementById('pwNew').value;
    var confirmPw = document.getElementById('pwConfirm').value;

    if (hasPassword && !currentPw) {
        errorEl.textContent = 'Please enter your current password.';
        errorEl.style.display = 'block';
        return;
    }
    if (newPw.length < 6) {
        errorEl.textContent = 'New password must be at least 6 characters.';
        errorEl.style.display = 'block';
        return;
    }
    if (newPw !== confirmPw) {
        errorEl.textContent = 'Passwords do not match.';
        errorEl.style.display = 'block';
        return;
    }

    btn.disabled = true;
    btn.textContent = 'Saving...';

    var body = { newPassword: newPw };
    if (hasPassword) body.currentPassword = currentPw;

    apiFetch('/auth/change-password', { method: 'POST', body: body })
        .then(function(r) { return r.json().then(function(d) { return { ok: r.ok, data: d }; }); })
        .then(function(result) {
            if (result.ok) {
                successEl.textContent = result.data.message || 'Password updated successfully.';
                successEl.style.display = 'block';
                btn.textContent = 'Done';
                // Update profile state
                if (currentUserProfile) currentUserProfile.has_password = true;
                updatePasswordSettingsLabel();
                setTimeout(hidePasswordModal, 1500);
            } else {
                errorEl.textContent = result.data.error || 'Failed to update password.';
                errorEl.style.display = 'block';
                btn.disabled = false;
                btn.textContent = hasPassword ? 'Update Password' : 'Set Password';
            }
        })
        .catch(function() {
            errorEl.textContent = 'Something went wrong. Please try again.';
            errorEl.style.display = 'block';
            btn.disabled = false;
            btn.textContent = hasPassword ? 'Update Password' : 'Set Password';
        });
}

function updatePasswordSettingsLabel() {
    var label = document.getElementById('passwordSettingsLabel');
    var hint = document.getElementById('passwordSettingsHint');
    if (currentUserProfile && currentUserProfile.has_password) {
        label.textContent = 'Change Password';
        hint.textContent = 'Update your account password';
    } else {
        label.textContent = 'Set Password';
        hint.textContent = 'Add a password to your account';
    }
}

function show(id) {
    cfLog('UI', 'show(' + id + ')');
    if (id === 'idle') {
        // Just hide picker/sent overlays, dashboard is always the base
        document.querySelectorAll('.screen').forEach(function(s){ s.classList.add('hidden'); });
        return;
    }

    document.querySelectorAll('.screen').forEach(function(s){ s.classList.add('hidden'); });
    var el = document.getElementById(id);
    if (el) el.classList.remove('hidden');

    // Animate picker buttons with stagger
    if (id === 'picker') {
        var btns = document.querySelectorAll('.pick-btn');
        btns.forEach(function(btn, i) {
            btn.classList.remove('animate-in');
            btn.style.animationDelay = (i * 0.08) + 's';
            setTimeout(function(){ btn.classList.add('animate-in'); }, 10);
        });
    }

    // Reset sent screen animations
    if (id === 'sent') {
        var progress = document.getElementById('returnProgress');
        var text = document.getElementById('returnText');
        if (progress) progress.style.display = 'block';
        if (text) text.style.display = 'block';
    }
}

// ── Wake Lock ──
var wakeLock = null;
function requestWakeLock() {
    if (!('wakeLock' in navigator)) return;
    navigator.wakeLock.request('screen').then(function(wl){ wakeLock = wl; }).catch(function(){});
}
document.addEventListener('visibilitychange', function(){
    if (document.visibilityState === 'visible') {
        cfLog('VIS', 'Page became visible, es state=' + (es ? es.readyState : 'null'));
        requestWakeLock();
        // Restart tap SSE if dead (readyState 2 = CLOSED)
        if (!es || es.readyState === 2) {
            cfLog('VIS', 'SSE dead, restarting');
            startListeningForTaps();
        }
        checkPendingTap();
    }
});
requestWakeLock();

// ── Notifications (iOS-compatible) ──
function isIOSDevice() {
    return /iPhone|iPad|iPod/.test(navigator.userAgent);
}
function isRunningAsPWA() {
    return (window.matchMedia('(display-mode: standalone)').matches) ||
           (window.navigator.standalone === true);
}

function debugNotifications() {
    var info = [];
    info.push('=== DEBUG v13 ===');
    info.push('iOS: ' + isIOSDevice());
    info.push('PWA: ' + isRunningAsPWA());
    info.push('standalone: ' + window.navigator.standalone);
    info.push('Notification exists: ' + ('Notification' in window));
    if ('Notification' in window) {
        info.push('Permission: ' + Notification.permission);
    }
    info.push('SW support: ' + ('serviceWorker' in navigator));
    info.push('Push support: ' + ('PushManager' in window));
    info.push('Protocol: ' + location.protocol);
    info.push('Host: ' + location.host);

    var msg = info.join('\n');
    alert(msg);

    // Try to force request permission with user gesture
    if ('Notification' in window && Notification.permission === 'default') {
        alert('Requesting permission NOW...');
        Notification.requestPermission().then(function(p) {
            alert('Permission result: ' + p);
        }).catch(function(e) {
            alert('Permission error: ' + e);
        });
    }
}

function forceResetAndRequest() {
    // Direct permission request with user gesture
    if (!('Notification' in window)) {
        alert('Notification API not available on this device');
        return;
    }

    alert('Current permission: ' + Notification.permission + '\n\nTapping OK will request permission...');

    try {
        Notification.requestPermission().then(function(permission) {
            alert('Result: ' + permission);
            updateNotifUI(permission);
            if (permission === 'granted') {
                new Notification('It works!', {body: 'Notifications are now enabled'});
            }
        }).catch(function(err) {
            alert('Error: ' + err.message);
        });
    } catch(e) {
        alert('Exception: ' + e.message);
    }
}

function requestNotif() {
    // iOS requires PWA mode for notifications
    if (isIOSDevice() && !isRunningAsPWA()) {
        alert('iPhone Notifications Require Installation\n\nTo receive notifications:\n1. Tap the Share button (box with arrow)\n2. Tap "Add to Home Screen"\n3. Open the app from your Home Screen\n4. Then tap this button again');
        return;
    }

    if (!('Notification' in window)) {
        alert('Notifications not supported on this device.\n\nMake sure you\'re using iOS 16.4 or later.');
        return;
    }

    // If already denied, show instructions
    if (Notification.permission === 'denied') {
        var msg = 'Notifications are blocked.\n\n';
        if (isIOSDevice()) {
            msg += 'To fix on iPhone:\n\n';
            msg += '1. Open the Settings app\n';
            msg += '2. Tap Notifications\n';
            msg += '3. Scroll down to find "CardFlow"\n';
            msg += '4. Enable "Allow Notifications"\n\n';
            msg += 'If not found there, try:\n';
            msg += 'Settings → Apps → CardFlow → Notifications\n\n';
            msg += 'Or: Delete this app, clear Safari data, and re-install.';
        } else if (/Android/.test(navigator.userAgent)) {
            msg += '1. Tap the lock icon in the URL bar\n2. Tap "Site settings"\n3. Set Notifications to "Allow"';
        } else {
            msg += '1. Click the lock icon in the URL bar\n2. Find "Notifications"\n3. Change to "Allow"';
        }
        alert(msg);
        return;
    }

    // Request permission
    Notification.requestPermission().then(function(permission) {
        updateNotifUI(permission);
        if (permission === 'granted') {
            // Send a test notification + register push subscription
            sendTestNotification();
            subscribeToPush();
            completeChecklistItem('enable_notifs');
        }
    }).catch(function(err) {
        console.error('Notification permission error:', err);
        showUpdateToast('Couldn\'t enable notifications. Please check your browser settings.');
    });
}

function sendTestNotification() {
    if (navigator.serviceWorker && navigator.serviceWorker.controller) {
        navigator.serviceWorker.ready.then(function(reg) {
            reg.showNotification('Notifications Enabled!', {
                body: 'You will now receive alerts when someone taps your card',
                icon: 'icon-192.png',
                badge: 'icon-192.png',
                tag: 'test-notif',
                vibrate: [100, 50, 100]
            });
        });
    } else {
        new Notification('Notifications Enabled!', {
            body: 'You will now receive alerts when someone taps your card',
            icon: 'icon-192.png',
            tag: 'test-notif'
        });
    }
}

function subscribeToPush() {
    if (!navigator.serviceWorker) return;
    fetch('/api/public/vapid-key').then(function(r) { return r.json(); }).then(function(data) {
        if (!data.publicKey) return;
        // Convert base64url to Uint8Array
        var padding = '='.repeat((4 - data.publicKey.length % 4) % 4);
        var base64 = (data.publicKey + padding).replace(/-/g, '+').replace(/_/g, '/');
        var raw = atob(base64);
        var key = new Uint8Array(raw.length);
        for (var i = 0; i < raw.length; i++) key[i] = raw.charCodeAt(i);

        navigator.serviceWorker.ready.then(function(reg) {
            return reg.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: key
            });
        }).then(function(subscription) {
            // Compare with stored subscription — skip PATCH if unchanged
            var subJson = JSON.stringify(subscription.toJSON());
            var stored = localStorage.getItem('push_sub');
            if (stored === subJson) return;
            localStorage.setItem('push_sub', subJson);
            apiFetch('/settings', {
                method: 'PATCH',
                body: { push_subscription: subscription.toJSON() }
            }).catch(function(err) { console.error('Failed to save push subscription:', err); });
        }).catch(function(err) {
            console.error('Push subscription failed:', err.message);
        });
    }).catch(function(err) {
        console.error('VAPID key fetch failed:', err.message);
    });
}

function updateNotifUI(permission) {
    var perm = permission || (('Notification' in window) ? Notification.permission : 'default');
    var icon = document.getElementById('notifBtn');
    var dot = document.getElementById('notifDot');
    var settingsLabel = document.getElementById('settingsNotifLabel');

    if (!icon || !dot) return;

    // Special case: iOS not running as PWA
    if (isIOSDevice() && !isRunningAsPWA()) {
        icon.className = 'status-icon';
        dot.className = 'status-dot off';
        if (settingsLabel) settingsLabel.textContent = 'Install App First';
        return;
    }

    // Notification API not available
    if (!('Notification' in window)) {
        icon.className = 'status-icon';
        dot.className = 'status-dot';
        if (settingsLabel) settingsLabel.textContent = 'Not Supported';
        return;
    }

    if (perm === 'granted') {
        icon.className = 'status-icon notif-on';
        dot.className = 'status-dot on';
        if (settingsLabel) settingsLabel.textContent = 'Notifications On';
    } else if (perm === 'denied') {
        icon.className = 'status-icon';
        dot.className = 'status-dot off';
        if (settingsLabel) settingsLabel.textContent = 'Notifications Blocked';
    } else {
        icon.className = 'status-icon';
        dot.className = 'status-dot';
        if (settingsLabel) settingsLabel.textContent = 'Enable Notifications';
    }
}

function updateStatusBadges() {
    var el = document.getElementById('statusBadges');
    if (!el) return;

    var parts = [];
    var qs = getQuickSend();
    if (qs && CARDS[qs]) parts.push('Quick: ' + (CARDS[qs].company || CARDS[qs].name).split(' ')[0]);
    if (currentDefaultCard && CARDS[currentDefaultCard]) parts.push('Default: ' + (CARDS[currentDefaultCard].company || CARDS[currentDefaultCard].name).split(' ')[0]);

    el.textContent = parts.length ? parts.join(' · ') : 'Ready to share';

    // Populate NFC link
    var nfcRow = document.getElementById('nfcLinkRow');
    var nfcInput = document.getElementById('nfcLinkInput');
    if (nfcRow && nfcInput && currentUserProfile && currentUserProfile.username) {
        var nfcUrl = BASE_URL + '/' + currentUserProfile.username + '?nfc=1';
        nfcInput.value = nfcUrl;
        nfcRow.style.display = '';
        // Also populate settings page NFC link
        var settingsItem = document.getElementById('settingsNfcLinkItem');
        var settingsInput = document.getElementById('settingsNfcLinkInput');
        if (settingsItem && settingsInput) {
            settingsInput.value = nfcUrl;
            settingsItem.style.display = '';
        }
    }
}

function copyNfcLink() {
    // Try dashboard NFC input first, fall back to referral panel input
    var input = document.getElementById('nfcLinkInput') || document.getElementById('referralNfcLinkInput');
    if (!input || !input.value) return;
    navigator.clipboard.writeText(input.value).then(function() {
        var btn = document.getElementById('copyNfcBtn');
        if (btn) { btn.textContent = 'Copied!'; setTimeout(function(){ btn.textContent = 'Copy'; }, 2000); }
    }).catch(function() {
        input.select();
        document.execCommand('copy');
    });
}

function copySettingsNfcLink(e) {
    if (e) e.stopPropagation();
    var input = document.getElementById('settingsNfcLinkInput');
    if (!input || !input.value) return;
    navigator.clipboard.writeText(input.value).then(function() {
        var btn = document.getElementById('copySettingsNfcBtn');
        if (btn) { btn.textContent = 'Copied!'; setTimeout(function(){ btn.textContent = 'Copy'; }, 2000); }
    }).catch(function() {
        input.select();
        document.execCommand('copy');
    });
}

// ── NFC Tap-to-Share ──
var nfcAbortController = null;

function getNfcShareUrl() {
    if (!currentUserProfile || !currentUserProfile.username) return null;
    return BASE_URL + '/' + currentUserProfile.username + '?nfc=1';
}

function startNfcShare() {
    var cardId = document.getElementById('qrCardSelect').value;
    var card = CARDS[cardId];
    var url = getNfcShareUrl();
    if (!url) return;

    var overlay = document.getElementById('nfcOverlay');
    var rings = document.getElementById('nfcRings');
    var ringsIcon = document.getElementById('nfcRingsIcon');
    var textEl = document.getElementById('nfcOverlayText');
    var subEl = document.getElementById('nfcOverlaySub');
    var cardEl = document.getElementById('nfcOverlayCard');
    var cancelBtn = document.getElementById('nfcCancelBtn');
    var fallback = document.getElementById('nfcFallback');

    // Card preview text
    cardEl.textContent = card ? (card.company || card.name) : currentUserProfile.username;

    // Check NFC support
    if (!('NDEFReader' in window)) {
        // Show fallback: QR + share link
        overlay.classList.remove('success');
        overlay.classList.add('show');
        rings.style.display = 'none';
        textEl.textContent = 'Share your card';
        subEl.textContent = 'Scan QR code or tap Share Link';
        cancelBtn.style.display = 'none';
        fallback.style.display = '';
        // Draw QR in fallback
        if (typeof qrcode !== 'undefined') {
            drawQR(document.getElementById('nfcFallbackQr'), url, 200, card ? card.color : '#6366f1');
        }
        return;
    }

    // NFC supported — show scanning overlay
    overlay.classList.remove('success');
    overlay.classList.add('show');
    rings.style.display = '';
    textEl.textContent = 'Hold near another phone';
    subEl.textContent = 'Place phones back to back';
    cancelBtn.style.display = '';
    fallback.style.display = 'none';
    ringsIcon.innerHTML = '<svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 18H4V4h16v16zM18 6h-5c-1.1 0-2 .9-2 2v2.28c-.6.35-1 .98-1 1.72 0 1.1.9 2 2 2s2-.9 2-2c0-.74-.4-1.37-1-1.72V8h3v8H8V8h2V6H6v12h12V6z"/></svg>';

    // Start NFC write
    nfcAbortController = new AbortController();
    var reader = new NDEFReader();
    reader.write({records: [{recordType: 'url', data: url}]}, {signal: nfcAbortController.signal})
    .then(function() {
        // Success
        overlay.classList.add('success');
        textEl.textContent = 'Card shared!';
        subEl.textContent = '';
        ringsIcon.innerHTML = '<svg viewBox="0 0 24 24" fill="#fff"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>';
        if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
        setTimeout(closeNfcOverlay, 2500);
    })
    .catch(function(err) {
        if (err.name === 'AbortError') return; // User cancelled
        var msg = 'NFC write failed';
        if (err.name === 'NotAllowedError') msg = 'NFC permission denied';
        else if (err.name === 'NotReadableError') msg = 'NFC not available — check settings';
        textEl.textContent = msg;
        subEl.textContent = 'Tap Cancel and try again';
    });
}

function closeNfcOverlay() {
    if (nfcAbortController) {
        nfcAbortController.abort();
        nfcAbortController = null;
    }
    var overlay = document.getElementById('nfcOverlay');
    overlay.classList.remove('show', 'success');
}

function shareNfcLink() {
    var url = getNfcShareUrl();
    if (!url) return;
    var cardId = document.getElementById('qrCardSelect').value;
    var card = CARDS[cardId];
    var title = card ? (card.company || card.name) + ' — Digital Card' : 'My Digital Card';
    if (navigator.share) {
        navigator.share({title: title, url: url}).catch(function(){});
    } else {
        navigator.clipboard.writeText(url).then(function() {
            var btn = document.querySelector('.nfc-share-link');
            if (btn) { btn.textContent = 'Copied!'; setTimeout(function(){ btn.textContent = 'Share Link'; }, 2000); }
        });
    }
}

function updateNfcFab() {
    var fab = document.getElementById('nfcFab');
    if (!fab) return;
    var hasCards = Object.keys(CARDS).length > 0;
    if (currentPage === 'dashboard' && hasCards) {
        fab.classList.add('visible');
    } else {
        fab.classList.remove('visible');
    }
}

function updateNfcBadge() {
    var badge = document.getElementById('nfcShareBadge');
    if (!badge) return;
    badge.textContent = ('NDEFReader' in window) ? 'NFC' : 'QR + Link';
}

function showSettings() {
    navigateTo('settings');
}
function hideSettings() {
    navigateTo('dashboard');
}

function checkForUpdates() {
    hideSettings();
    showUpdateToast('Checking for updates...');
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistration().then(function(reg) {
            if (reg) {
                reg.update().then(function() {
                    // Check if there's a waiting worker
                    if (reg.waiting) {
                        showUpdateToast('Installing update...');
                        reg.waiting.postMessage({type: 'SKIP_WAITING'});
                    } else if (reg.installing) {
                        showUpdateToast('Update found, installing...');
                    } else {
                        showUpdateToast('Already up to date!');
                        setTimeout(function(){ hideUpdateToast(); }, 2000);
                    }
                });
            } else {
                showUpdateToast('No service worker found');
                setTimeout(function(){ hideUpdateToast(); }, 2000);
            }
        });
    } else {
        location.reload(true);
    }
}

function hideUpdateToast() {
    var toast = document.querySelector('.update-toast');
    if (toast) toast.remove();
}

function refreshApp() {
    if (!confirm('This will clear all cached data and reload the app. Continue?')) return;

    // Clear caches
    if ('caches' in window) {
        caches.keys().then(function(names) {
            names.forEach(function(name) {
                caches.delete(name);
            });
        });
    }

    // Unregister service worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(function(registrations) {
            registrations.forEach(function(reg) {
                reg.unregister();
            });
        });
    }

    // Clear localStorage (except important settings)
    var token = localStorage.getItem('token');
    var user = localStorage.getItem('user');
    var quickSend = localStorage.getItem('quickSendCard');
    localStorage.clear();
    if (token) localStorage.setItem('token', token);
    if (user) localStorage.setItem('user', user);
    if (quickSend) localStorage.setItem('quickSendCard', quickSend);

    // Reload
    setTimeout(function() {
        location.reload(true);
    }, 500);
}

function showDebugMenu() {
    var info = [];
    info.push('=== DEBUG v16 ===');
    info.push('iOS: ' + isIOSDevice());
    info.push('PWA: ' + isRunningAsPWA());
    info.push('Notif: ' + (('Notification' in window) ? Notification.permission : 'N/A'));
    info.push('SW: ' + ('serviceWorker' in navigator));
    info.push('Push: ' + ('PushManager' in window));

    var action = confirm(info.join('\n') + '\n\nTap OK to force request permission');
    if (action) {
        forceResetAndRequest();
    }
}

function notify(title, body) {
    cfLog('NOTIF', 'notify: ' + title + ' / ' + body);
    if (!('Notification' in window) || Notification.permission !== 'granted') {
        cfLog('NOTIF', 'Notifications not available or not granted: ' + (('Notification' in window) ? Notification.permission : 'N/A'));
        return;
    }
    if (navigator.serviceWorker && navigator.serviceWorker.controller) {
        navigator.serviceWorker.ready.then(function(reg) {
            reg.showNotification(title || 'Someone tapped your card!', {
                body: body || 'Tap to select which card to share',
                icon: '/icon-192.png',
                badge: '/icon-192.png',
                vibrate: [100,50,100,50,200],
                tag: 'nfc-tap',
                data: { url: '/dashboard', tapId: currentSession || '' },
                requireInteraction: true,
                renotify: true
            });
        });
    } else {
        var n = new Notification(title, {body:body,tag:'nfc-tap',icon:'/icon-192.png',requireInteraction:true});
        n.onclick = function(){ window.focus(); n.close(); };
    }
}

function buzz() {
    if (navigator.vibrate) navigator.vibrate([100,50,100,50,200]);
    try {
        var ctx = new (window.AudioContext||window.webkitAudioContext)();
        var o = ctx.createOscillator(), g = ctx.createGain();
        o.connect(g); g.connect(ctx.destination);
        o.frequency.value = 880; o.type = 'sine'; g.gain.value = 0.3;
        o.start(); g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.3);
        o.stop(ctx.currentTime+0.3);
    } catch(e){}
}

// ── Tap Stats ──
// Lightweight stats refresh — invalidates cache and reloads dashboard stats if visible
function loadStats() {
    cachedLeads = null;
    if (currentPage === 'dashboard') loadDashboard();
}

// Note: initCardElements, loadCardsFromFirebase called from initApp() after auth

// ── QR Code Generation (Styled for Pro, Basic for Free) ──
function isFinderPattern(row, col, moduleCount) {
    // Top-left
    if (row < 7 && col < 7) return true;
    // Top-right
    if (row < 7 && col >= moduleCount - 7) return true;
    // Bottom-left
    if (row >= moduleCount - 7 && col < 7) return true;
    return false;
}

function drawRoundedRect(ctx, x, y, w, h, r) {
    ctx.beginPath();
    ctx.moveTo(x + r, y);
    ctx.lineTo(x + w - r, y);
    ctx.quadraticCurveTo(x + w, y, x + w, y + r);
    ctx.lineTo(x + w, y + h - r);
    ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
    ctx.lineTo(x + r, y + h);
    ctx.quadraticCurveTo(x, y + h, x, y + h - r);
    ctx.lineTo(x, y + r);
    ctx.quadraticCurveTo(x, y, x + r, y);
    ctx.closePath();
    ctx.fill();
}

function drawFinderRounded(ctx, cx, cy, cellSize, color) {
    // Outer ring (7x7)
    var outerSize = cellSize * 7;
    var ox = cx - outerSize / 2;
    var oy = cy - outerSize / 2;
    ctx.fillStyle = color;
    drawRoundedRect(ctx, ox, oy, outerSize, outerSize, cellSize * 1.4);
    // White inner (5x5)
    var innerSize = cellSize * 5;
    var ix = cx - innerSize / 2;
    var iy = cy - innerSize / 2;
    ctx.fillStyle = '#ffffff';
    drawRoundedRect(ctx, ix, iy, innerSize, innerSize, cellSize);
    // Center dot (3x3)
    var dotSize = cellSize * 3;
    var dx = cx - dotSize / 2;
    var dy = cy - dotSize / 2;
    ctx.fillStyle = color;
    drawRoundedRect(ctx, dx, dy, dotSize, dotSize, cellSize * 0.7);
}

function drawQR(canvas, url, size, darkColor, styled) {
    if (typeof qrcode === 'undefined') return false;
    var isPro = getUserPlan && getUserPlan() !== 'free';
    var useStyled = styled !== undefined ? styled : isPro;
    try {
        var qr = qrcode(0, 'M');
        qr.addData(url);
        qr.make();
        var dpr = window.devicePixelRatio || 1;
        var ctx = canvas.getContext('2d');
        var moduleCount = qr.getModuleCount();
        var cellSize = Math.floor(size / moduleCount);
        var offset = Math.floor((size - cellSize * moduleCount) / 2);
        canvas.width = size * dpr;
        canvas.height = size * dpr;
        canvas.style.width = size + 'px';
        canvas.style.height = size + 'px';
        ctx.scale(dpr, dpr);
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, size, size);

        var dc = darkColor || '#1B1464';

        if (useStyled) {
            // Draw data modules as rounded dots
            var dotRadius = cellSize * 0.42;
            ctx.fillStyle = dc;
            for (var row = 0; row < moduleCount; row++) {
                for (var col = 0; col < moduleCount; col++) {
                    if (qr.isDark(row, col) && !isFinderPattern(row, col, moduleCount)) {
                        var x = offset + col * cellSize + cellSize / 2;
                        var y = offset + row * cellSize + cellSize / 2;
                        ctx.beginPath();
                        ctx.arc(x, y, dotRadius, 0, 2 * Math.PI);
                        ctx.fill();
                    }
                }
            }
            // Draw finder patterns with rounded corners
            var finderPositions = [
                { row: 3.5, col: 3.5 },
                { row: 3.5, col: moduleCount - 3.5 },
                { row: moduleCount - 3.5, col: 3.5 }
            ];
            for (var f = 0; f < finderPositions.length; f++) {
                var fp = finderPositions[f];
                drawFinderRounded(ctx, offset + fp.col * cellSize, offset + fp.row * cellSize, cellSize, dc);
            }
            // Logo center area (white circle + "CF" text or just clear)
            var logoSize = cellSize * 5;
            var lx = size / 2;
            var ly = size / 2;
            ctx.fillStyle = '#ffffff';
            ctx.beginPath();
            ctx.arc(lx, ly, logoSize / 2 + 2, 0, 2 * Math.PI);
            ctx.fill();
            // Draw "CF" brand mark
            ctx.fillStyle = dc;
            ctx.font = 'bold ' + Math.round(cellSize * 2.5) + 'px Inter,Arial,sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('CF', lx, ly + 1);
        } else {
            // Basic square QR for free users
            ctx.fillStyle = dc;
            for (var row2 = 0; row2 < moduleCount; row2++) {
                for (var col2 = 0; col2 < moduleCount; col2++) {
                    if (qr.isDark(row2, col2)) {
                        ctx.fillRect(offset + col2 * cellSize, offset + row2 * cellSize, cellSize, cellSize);
                    }
                }
            }
        }
        return true;
    } catch(e) {
        console.error('QR Error:', e);
        return false;
    }
}

function generateQR() {
    if (typeof qrcode === 'undefined') { setTimeout(generateQR, 200); return; }
    var cardId = document.getElementById('qrCardSelect').value;
    var card = CARDS[cardId];
    if (!card) return;
    var qrSize = window.innerWidth <= 767 ? 140 : 180;
    drawQR(document.getElementById('qrCanvas'), getCardUrl(cardId), qrSize, card.color);
}

function showFullscreenQR() {
    var cardId = document.getElementById('qrCardSelect').value;
    var card = CARDS[cardId];
    if (!card) return;
    document.getElementById('qrFullName').textContent = card.company || card.name;
    drawQR(document.getElementById('qrFullCanvas'), getCardUrl(cardId), 280, card.color);
    document.getElementById('qrFullscreen').classList.add('show');
}

function closeFullscreenQR() {
    document.getElementById('qrFullscreen').classList.remove('show');
}

function copyCardLink() {
    var cardId = document.getElementById('qrCardSelect').value;
    completeChecklistItem('share_card');
    navigator.clipboard.writeText(getCardUrl(cardId)).then(function(){
        var btn = document.getElementById('copyLinkBtn');
        btn.classList.add('copied');
        btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>Copied!';
        setTimeout(function(){
            btn.classList.remove('copied');
            btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>Copy Link';
        },2000);
    });
}

function shareCardLink() {
    var cardId = document.getElementById('qrCardSelect').value;
    completeChecklistItem('share_card');
    if (navigator.share) {
        navigator.share({title:(CARDS[cardId].company||CARDS[cardId].name)+' — Digital Card',url:getCardUrl(cardId)}).catch(function(){});
    } else {
        copyCardLink();
    }
}

var currentPreviewUrl = '';
function previewCard() {
    var cardId = document.getElementById('qrCardSelect').value;
    if (!cardId || !CARDS[cardId]) return;
    completeChecklistItem('preview_card');
    currentPreviewUrl = getCardUrl(cardId);
    document.getElementById('previewLoading').style.display = 'flex';
    document.getElementById('previewFrame').src = getPreviewUrl(cardId);
    document.getElementById('previewModal').classList.add('show');
}
function closePreview() {
    var modal = document.getElementById('previewModal');
    var frame = document.getElementById('previewFrame');
    modal.classList.remove('show');
    setTimeout(function(){ frame.src = ''; document.getElementById('previewLoading').style.display = 'flex'; }, 300);
}
function openInNewTab() {
    if (currentPreviewUrl) window.open(currentPreviewUrl, '_blank');
    closePreview();
}

// Note: generateQR called from initApp() after auth

// ── Card Templates ──
var CARD_TEMPLATES = [
    { id: 'midnight', name: 'Midnight', label: 'Classic dark', color: '#1B1464', gradient: 'linear-gradient(135deg,#1B1464,#0D0D3B)' },
    { id: 'ocean', name: 'Ocean', label: 'Deep blue', color: '#0E7490', gradient: 'linear-gradient(135deg,#0E7490,#064E6E)' },
    { id: 'forest', name: 'Forest', label: 'Natural green', color: '#065F46', gradient: 'linear-gradient(135deg,#065F46,#034D38)' },
    { id: 'royal', name: 'Royal', label: 'Bold purple', color: '#7C3AED', gradient: 'linear-gradient(135deg,#7C3AED,#5B21B6)' },
    { id: 'ember', name: 'Ember', label: 'Warm red', color: '#DC2626', gradient: 'linear-gradient(135deg,#DC2626,#991B1B)' },
    { id: 'gold', name: 'Gold', label: 'Luxury tone', color: '#8B6914', gradient: 'linear-gradient(135deg,#8B6914,#6B4F0E)' },
    { id: 'slate', name: 'Slate', label: 'Modern minimal', color: '#334155', gradient: 'linear-gradient(135deg,#334155,#1e293b)' },
    { id: 'coral', name: 'Coral', label: 'Vibrant warm', color: '#E11D48', gradient: 'linear-gradient(135deg,#E11D48,#9F1239)' },
    { id: 'teal', name: 'Teal', label: 'Fresh cool', color: '#0891B2', gradient: 'linear-gradient(135deg,#0891B2,#0E7490)' },
    { id: 'indigo', name: 'Indigo', label: 'Deep violet', color: '#4F46E5', gradient: 'linear-gradient(135deg,#4F46E5,#3730A3)' }
];

function renderTemplateGrid() {
    var grid = document.getElementById('templateGrid');
    if (!grid) return;
    var html = '';
    for (var i = 0; i < CARD_TEMPLATES.length; i++) {
        var t = CARD_TEMPLATES[i];
        var sel = (selectedColor === t.color) ? ' selected' : '';
        html += '<div class="template-card' + sel + '" data-template="' + t.id + '" style="background:' + t.gradient + '" onclick="selectTemplate(\'' + t.id + '\')">';
        html += '<div class="template-check"><svg viewBox="0 0 24 24" fill="' + t.color + '"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg></div>';
        html += '<div class="template-name">' + t.name + '</div>';
        html += '<div class="template-label">' + t.label + '</div>';
        html += '</div>';
    }
    grid.innerHTML = html;
}

function selectTemplate(id) {
    var t = CARD_TEMPLATES.find(function(tpl) { return tpl.id === id; });
    if (!t) return;
    selectedColor = t.color;
    document.getElementById('cardCustomColor').value = t.color;
    updateColorPicker();
    renderTemplateGrid();
}

// ── Team Management ──
var cachedTeam = null;

function showTeamPanel() {
    var plan = getUserPlan();
    if (plan !== 'business') {
        showUpgradeModal('Team features require the Business plan.');
        return;
    }
    document.getElementById('teamModal').classList.add('show');
    loadTeamData();
}

function hideTeamPanel() {
    document.getElementById('teamModal').classList.remove('show');
}

function loadTeamData() {
    var body = document.getElementById('teamModalBody');
    body.innerHTML = '<div class="leads-empty">Loading...</div>';

    apiFetch('/teams').then(function(r){ return r.json(); }).then(function(data) {
        cachedTeam = data.team;
        if (!data.team) {
            renderCreateTeam(body);
        } else {
            renderTeamDashboard(body, data.team);
        }
    }).catch(function() {
        body.innerHTML = '<div class="leads-empty">Failed to load team data</div>';
    });
}

function renderCreateTeam(body) {
    document.getElementById('teamModalTitle').textContent = 'Create a Team';
    body.innerHTML =
        '<div style="text-align:center;padding:20px 0">' +
        '<svg viewBox="0 0 24 24" width="48" height="48" fill="var(--accent-light)" style="margin-bottom:12px"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>' +
        '<h3 style="color:var(--text-primary);margin:0 0 8px">Create your team</h3>' +
        '<p style="color:var(--text-muted);font-size:14px;margin:0 0 24px">Invite team members, share card templates, and track performance across your organization.</p>' +
        '<div style="max-width:300px;margin:0 auto">' +
        '<input type="text" id="newTeamName" placeholder="Team name (e.g. Sales Team)" style="width:100%;padding:12px 14px;background:var(--bg-elevated);border:1px solid var(--border);border-radius:10px;color:var(--text-primary);font-size:15px;outline:none;margin-bottom:12px;box-sizing:border-box">' +
        '<button onclick="createTeam()" style="width:100%;padding:14px;background:linear-gradient(135deg,var(--accent),#8b5cf6);color:#fff;border:none;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer">Create Team</button>' +
        '</div></div>';
}

function createTeam() {
    var name = document.getElementById('newTeamName').value.trim();
    if (!name) { document.getElementById('newTeamName').focus(); return; }

    apiFetch('/teams', {
        method: 'POST',
        body: { name: name }
    }).then(function(r){ return r.json(); }).then(function(data) {
        if (data.error) { alert(data.error); return; }
        loadTeamData();
    }).catch(function(err) { showUpdateToast('Couldn\'t create team. Please try again.'); });
}

function renderTeamDashboard(body, team) {
    document.getElementById('teamModalTitle').textContent = team.name;
    var html = '';

    // Stats (admin only)
    if (team.isAdmin && team.stats) {
        var s = team.stats;
        html += '<div class="team-stats">';
        html += '<div class="team-stat"><div class="team-stat-num">' + s.totalMembers + '</div><div class="team-stat-label">Members</div></div>';
        html += '<div class="team-stat"><div class="team-stat-num">' + s.totalCards + '</div><div class="team-stat-label">Cards</div></div>';
        html += '<div class="team-stat"><div class="team-stat-num">' + s.weekLeads + '</div><div class="team-stat-label">Leads this week</div></div>';
        html += '</div>';
    }

    // Invite (admin only)
    if (team.isAdmin) {
        html += '<div style="margin-bottom:16px">';
        html += '<div style="font-size:13px;font-weight:600;color:var(--text-secondary);margin-bottom:8px">Invite member</div>';
        html += '<div class="team-invite-row">';
        html += '<input type="email" id="teamInviteEmail" placeholder="colleague@company.com">';
        html += '<button onclick="inviteTeamMember()">Invite</button>';
        html += '</div>';
        html += '<div id="teamInviteResult" style="font-size:13px;margin-top:-8px;margin-bottom:8px"></div>';
        html += '</div>';

        // Pending invitations
        if (team.invitations && team.invitations.length > 0) {
            html += '<div style="font-size:13px;font-weight:600;color:var(--text-secondary);margin-bottom:8px">Pending invitations</div>';
            team.invitations.forEach(function(inv) {
                html += '<div class="team-pending"><span>' + escapeHtml(inv.email) + '</span><span style="color:var(--text-muted)">' + new Date(inv.created_at).toLocaleDateString() + '</span></div>';
            });
            html += '<div style="margin-bottom:16px"></div>';
        }
    }

    // Members
    html += '<div style="font-size:13px;font-weight:600;color:var(--text-secondary);margin-bottom:8px">Members</div>';
    team.members.forEach(function(m) {
        var initials = (m.name || m.email || '?').split(' ').map(function(w){ return w[0]; }).join('').substring(0, 2).toUpperCase();
        var isOwner = m.user_id === team.ownerId;
        html += '<div class="team-member">';
        html += '<div class="team-member-avatar">' + escapeHtml(initials) + '</div>';
        html += '<div class="team-member-info">';
        html += '<div class="team-member-name">' + escapeHtml(m.name || m.email) + '</div>';
        html += '<div class="team-member-meta">' + escapeHtml(m.email) + (m.username ? ' · @' + m.username : '') + '</div>';
        html += '</div>';
        if (isOwner) {
            html += '<span class="team-member-badge">Owner</span>';
        } else if (m.role === 'admin') {
            html += '<span class="team-member-badge">Admin</span>';
        }
        if (team.isAdmin && !isOwner) {
            html += '<button class="team-member-remove" onclick="removeTeamMember(\'' + m.user_id + '\',\'' + escapeHtml(m.name || m.email) + '\')" title="Remove">&times;</button>';
        }
        html += '</div>';
    });

    // Actions
    html += '<div style="margin-top:20px;display:flex;gap:8px">';
    if (team.isAdmin) {
        html += '<button onclick="deleteTeam()" style="padding:10px 16px;background:rgba(239,68,68,.1);color:#ef4444;border:1px solid rgba(239,68,68,.2);border-radius:10px;font-size:13px;cursor:pointer;font-weight:500">Delete Team</button>';
    } else {
        html += '<button onclick="leaveTeam()" style="padding:10px 16px;background:rgba(239,68,68,.1);color:#ef4444;border:1px solid rgba(239,68,68,.2);border-radius:10px;font-size:13px;cursor:pointer;font-weight:500">Leave Team</button>';
    }
    html += '</div>';

    body.innerHTML = html;
}

function inviteTeamMember() {
    var emailInput = document.getElementById('teamInviteEmail');
    var email = emailInput.value.trim().toLowerCase();
    if (!email) { emailInput.focus(); return; }

    var result = document.getElementById('teamInviteResult');
    result.textContent = 'Sending...';
    result.style.color = 'var(--text-muted)';

    apiFetch('/teams/invite', {
        method: 'POST',
        body: { email: email }
    }).then(function(r){ return r.json(); }).then(function(data) {
        if (data.error) {
            result.textContent = data.error;
            result.style.color = '#ef4444';
        } else {
            var msg = data.status === 'added' ? 'Added to team!' : 'Invitation sent!';
            result.textContent = msg;
            result.style.color = '#10b981';
            emailInput.value = '';
            setTimeout(function(){ loadTeamData(); }, 1000);
        }
    }).catch(function() {
        result.textContent = 'Failed to send invitation';
        result.style.color = '#ef4444';
    });
}

function removeTeamMember(userId, name) {
    if (!confirm('Remove ' + name + ' from the team?')) return;
    apiFetch('/teams/members/' + userId, { method: 'DELETE' }).then(function(r){ return r.json(); }).then(function(data) {
        if (data.error) alert(data.error);
        else loadTeamData();
    }).catch(function(){ showUpdateToast('Couldn\'t remove member. Please try again.'); });
}

function deleteTeam() {
    if (!confirm('Delete this team? All members will be removed. This cannot be undone.')) return;
    apiFetch('/teams', { method: 'DELETE' }).then(function(r){ return r.json(); }).then(function(data) {
        if (data.error) alert(data.error);
        else { hideTeamPanel(); }
    }).catch(function(){ showUpdateToast('Couldn\'t delete team. Please try again.'); });
}

function leaveTeam() {
    if (!confirm('Leave this team?')) return;
    apiFetch('/teams/leave', { method: 'POST' }).then(function(r){ return r.json(); }).then(function(data) {
        if (data.error) alert(data.error);
        else { hideTeamPanel(); }
    }).catch(function(){ showUpdateToast('Couldn\'t leave team. Please try again.'); });
}


function getTimeAgo(dateStr) {
    var diff = Date.now() - new Date(dateStr).getTime();
    var mins = Math.floor(diff / 60000);
    if (mins < 1) return 'Just now';
    if (mins < 60) return mins + 'm ago';
    var hrs = Math.floor(mins / 60);
    if (hrs < 24) return hrs + 'h ago';
    var days = Math.floor(hrs / 24);
    if (days < 7) return days + 'd ago';
    if (days < 30) return Math.floor(days / 7) + 'w ago';
    return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

// ── Welcome Screen ──
function showWelcomeScreen() {
    document.getElementById('welcomeScreen').classList.add('show');
}
function dismissWelcomeStartWizard() {
    var ws = document.getElementById('welcomeScreen');
    ws.style.opacity = '0';
    ws.style.transition = 'opacity .3s ease';
    setTimeout(function() {
        ws.classList.remove('show');
        ws.style.opacity = '';
        ws.style.transition = '';
        showOnboardingWizard();
    }, 300);
}

// ── Onboarding Wizard ──
var obStep = 1;
var obSelectedColor = '#4F46E5';

function showOnboardingWizard() {
    obStep = 1;
    obSelectedColor = '#4F46E5';
    // Pre-fill from user profile
    var user = null;
    try { user = JSON.parse(localStorage.getItem('user')); } catch(e){}
    if (user && user.email) {
        var el = document.getElementById('obEmail');
        if (el && !el.value) el.value = user.email;
    }
    if (currentUserProfile && currentUserProfile.name) {
        var nameEl = document.getElementById('obName');
        if (nameEl && !nameEl.value) nameEl.value = currentUserProfile.name;
    }
    renderObTemplates();
    updateObStep();
    document.getElementById('obWizard').classList.add('show');
}

function renderObTemplates() {
    var grid = document.getElementById('obTemplateGrid');
    if (!grid) return;
    var html = '';
    for (var i = 0; i < CARD_TEMPLATES.length; i++) {
        var t = CARD_TEMPLATES[i];
        var sel = (obSelectedColor === t.color) ? ' selected' : '';
        html += '<div class="ob-tpl' + sel + '" style="background:' + t.gradient + '" onclick="selectObTemplate(\'' + t.id + '\')">';
        html += '<div class="ob-tpl-name">' + t.name + '</div></div>';
    }
    grid.innerHTML = html;
}

function selectObTemplate(id) {
    var t = CARD_TEMPLATES.find(function(tpl) { return tpl.id === id; });
    if (!t) return;
    obSelectedColor = t.color;
    renderObTemplates();
    updateObPreview(t.gradient);
}
function updateObPreview(gradient) {
    var prev = document.getElementById('obPreviewCard');
    if (prev && gradient) prev.style.background = gradient;
    var pn = document.getElementById('obPreviewName');
    if (pn) pn.textContent = document.getElementById('obName').value.trim() || 'Your Name';
    var pt = document.getElementById('obPreviewTitle');
    if (pt) {
        var ti = document.getElementById('obTitle').value.trim() || 'Job Title';
        var co = document.getElementById('obCompany').value.trim() || 'Company';
        pt.textContent = ti + ' at ' + co;
    }
}

function updateObStep() {
    for (var i = 1; i <= 3; i++) {
        var step = document.getElementById('obWizStep' + i);
        var bar = document.getElementById('obBar' + i);
        if (step) step.classList.toggle('active', i === obStep);
        if (bar) {
            bar.classList.toggle('active', i === obStep);
            bar.classList.toggle('done', i < obStep);
        }
    }
    var btn = document.getElementById('obNextBtn');
    var actions = document.getElementById('obActions');
    if (obStep === 1) {
        actions.innerHTML = '<button class="ob-btn-primary" onclick="obNext()">Next</button>';
    } else if (obStep === 2) {
        actions.innerHTML = '<button class="ob-btn-secondary" onclick="obBack()">Back</button><button class="ob-btn-primary" id="obCreateBtn" onclick="obNext()">Create My Card</button>';
        updateObPreview();
    } else if (obStep === 3) {
        actions.innerHTML = '<button class="ob-btn-primary" onclick="closeOnboardingWizard()">Go to Dashboard</button>';
    }
}

function obNext() {
    if (obStep === 1) {
        var valid = true;
        ['obName','obTitle','obCompany'].forEach(function(id) {
            var el = document.getElementById(id);
            if (!el.value.trim()) {
                el.classList.add('ob-field-error');
                if (valid) el.focus();
                valid = false;
            } else {
                el.classList.remove('ob-field-error');
            }
        });
        if (!valid) return;
        obStep = 2;
        updateObStep();
    } else if (obStep === 2) {
        obCreateCard();
    }
}

function obBack() {
    if (obStep > 1) { obStep--; updateObStep(); }
}

function obCreateCard() {
    var btn = document.getElementById('obCreateBtn');
    if (btn) { btn.disabled = true; btn.textContent = 'Creating...'; }

    var name = document.getElementById('obName').value.trim();
    var title = document.getElementById('obTitle').value.trim();
    var company = document.getElementById('obCompany').value.trim();
    var email = document.getElementById('obEmail').value.trim();
    var phone = document.getElementById('obPhone').value.trim();

    var color1 = obSelectedColor;
    var color2 = darkenColor(color1);
    var slug = generateSlug(company) || 'card-' + Date.now().toString(36);
    var token = generateToken();
    var whatsapp = phone.replace(/[^0-9]/g, '');
    var address = '';

    var cardData = {
        name: name, title: title, company: company,
        subtitle: title + ' — ' + company,
        color: color1, color1: color1, color2: color2,
        accent: color1, accentLight: lightenColor(color1),
        gradient: 'linear-gradient(135deg,' + color1 + ',' + color2 + ')',
        token: token, phone: phone, phoneDisplay: phone,
        whatsapp: whatsapp, email: email,
        address: '', addressQuery: '',
        website: '', websiteDisplay: '',
        bio: '', logo: '', photo: '',
        linkedin: '', instagram: '', twitter: '', calendly: '',
        products: [], vcardAdr: ';;;;;;'
    };

    apiFetch('/cards/' + slug, { method: 'PUT', body: cardData }).then(function() {
        CARDS[slug] = cardData;
        if (CARD_IDS.indexOf(slug) === -1) CARD_IDS.push(slug);
        rebuildCardMaps();
        initCardElements();
        renderCardsList();
        generateQR();

        // Show step 3 with QR and link
        var user = null;
        try { user = JSON.parse(localStorage.getItem('user')); } catch(e){}
        var username = (user && user.username) || '';
        var url = 'https://card.cardflow.cloud/' + username + '/' + slug;
        document.getElementById('obShareUrl').value = url;

        // Generate QR on canvas
        var canvas = document.getElementById('obQrCanvas');
        if (canvas) {
            drawQR(canvas, url, 160, color1, false);
        }

        obStep = 3;
        updateObStep();
        completeChecklistItem('create_card');

        // Hide onboarding placeholder, show dashboard sections
        var ob = document.getElementById('onboardingWelcome');
        if (ob) ob.style.display = 'none';
        var qs = document.getElementById('dashQuickShare');
        if (qs) qs.style.display = '';
        var cs = document.getElementById('dashCardsSection');
        if (cs) cs.style.display = '';
        var as = document.getElementById('dashActivitySection');
        if (as) as.style.display = '';
        loadDashboard();
    }).catch(function(err) {
        if (btn) { btn.disabled = false; btn.textContent = 'Create My Card'; }
        showUpdateToast('Couldn\'t create your card. Please check your connection and try again.');
    });
}

function copyObLink() {
    completeChecklistItem('share_card');
    var input = document.getElementById('obShareUrl');
    if (navigator.clipboard) {
        navigator.clipboard.writeText(input.value).then(function(){
            var btn = input.nextElementSibling;
            btn.textContent = 'Copied!';
            setTimeout(function(){ btn.textContent = 'Copy'; }, 1500);
        });
    } else {
        input.select(); document.execCommand('copy');
    }
}

function shareObWhatsApp() {
    var url = document.getElementById('obShareUrl').value;
    if (url) window.open('https://wa.me/?text=' + encodeURIComponent('Check out my digital business card: ' + url), '_blank');
}

function closeOnboardingWizard() {
    document.getElementById('obWizard').classList.remove('show');
    // Start guided tour for first-time users
    setTimeout(function() { startTour(); }, 800);
}

// ── Guided Tour ──
var TOUR_STEPS = [
    { target: '#dashQuickShare .qr-card', text: 'This is your QR code. Show it to someone to share your card instantly.', position: 'bottom' },
    { target: '#csTrigger', text: 'Switch between your cards here. Each card has its own QR code and link.', position: 'bottom' },
    { target: '#dashTapLogSection', text: 'Every time someone scans your QR or taps your NFC, it shows up here in real-time.', position: 'top' },
    { target: window.innerWidth < 768 ? '.tab-item:nth-child(2)' : '.nav-item:nth-child(2)', text: 'Manage your cards, edit details, and view captured leads here.', position: 'top' }
];
var tourStep = 0;

function startTour() {
    if (localStorage.getItem('cardflow-tour-done')) return;
    tourStep = 0;
    document.getElementById('tourOverlay').style.display = '';
    showTourStep();
}

function showTourStep() {
    if (tourStep >= TOUR_STEPS.length) { endTour(); return; }
    var step = TOUR_STEPS[tourStep];
    var el = document.querySelector(step.target);
    if (!el) { tourStep++; showTourStep(); return; }
    var rect = el.getBoundingClientRect();
    var pad = 8;
    var spotlight = document.getElementById('tourSpotlight');
    spotlight.style.top = (rect.top - pad) + 'px';
    spotlight.style.left = (rect.left - pad) + 'px';
    spotlight.style.width = (rect.width + pad * 2) + 'px';
    spotlight.style.height = (rect.height + pad * 2) + 'px';
    document.getElementById('tourText').textContent = step.text;
    document.getElementById('tourStepCount').textContent = (tourStep + 1) + ' / ' + TOUR_STEPS.length;
    var tooltip = document.getElementById('tourTooltip');
    var tooltipW = Math.min(280, window.innerWidth - 40);
    var left = Math.max(20, Math.min(rect.left, window.innerWidth - tooltipW - 20));
    tooltip.style.left = left + 'px';
    if (step.position === 'bottom') {
        tooltip.style.top = (rect.bottom + pad + 12) + 'px';
        tooltip.style.bottom = 'auto';
    } else {
        tooltip.style.top = 'auto';
        tooltip.style.bottom = (window.innerHeight - rect.top + pad + 12) + 'px';
    }
    var nextBtn = tooltip.querySelector('.tour-next');
    nextBtn.textContent = (tourStep === TOUR_STEPS.length - 1) ? 'Done' : 'Next';
}

function nextTourStep() { tourStep++; showTourStep(); }

function endTour() {
    localStorage.setItem('cardflow-tour-done', '1');
    var overlay = document.getElementById('tourOverlay');
    overlay.style.opacity = '0';
    setTimeout(function(){ overlay.style.display = 'none'; overlay.style.opacity = ''; }, 300);
}

// ── Getting Started Checklist ──
var CHECKLIST_ITEMS = [
    { id: 'create_card', title: 'Create your first card', desc: 'Set up your digital business card', action: function(){ navigateTo('cards'); } },
    { id: 'share_card', title: 'Share your card', desc: 'Send your card link to someone', action: function(){ shareCardLink(); } },
    { id: 'preview_card', title: 'Preview your card', desc: 'See how visitors see your card', action: function(){ previewCard(); } },
    { id: 'set_default', title: 'Set a default card', desc: 'Choose which card shows on NFC tap', action: function(){ navigateTo('settings'); } },
    { id: 'enable_notifs', title: 'Enable notifications', desc: 'Get alerted when someone views your card', action: function(){ requestNotif(); } }
];
var checklistState = { completed: [], dismissed: false };
var checklistLoaded = false;

function renderChecklist() {
    var el = document.getElementById('gettingStarted');
    if (!el) return;
    // Auto-detect completions
    if (CARD_IDS.length > 0 && checklistState.completed.indexOf('create_card') === -1) checklistState.completed.push('create_card');
    if (typeof currentDefaultCard !== 'undefined' && currentDefaultCard && checklistState.completed.indexOf('set_default') === -1) checklistState.completed.push('set_default');
    if ('Notification' in window && Notification.permission === 'granted' && checklistState.completed.indexOf('enable_notifs') === -1) checklistState.completed.push('enable_notifs');
    // Hide if dismissed or all done
    var allDone = CHECKLIST_ITEMS.every(function(item) { return checklistState.completed.indexOf(item.id) !== -1; });
    if (checklistState.dismissed || allDone) { el.style.display = 'none'; return; }
    el.style.display = '';
    var doneCount = checklistState.completed.length;
    var total = CHECKLIST_ITEMS.length;
    var pct = Math.round((doneCount / total) * 100);
    document.getElementById('checklistFill').style.width = pct + '%';
    document.getElementById('checklistProgressText').textContent = doneCount + ' of ' + total;
    var html = '';
    CHECKLIST_ITEMS.forEach(function(item) {
        var done = checklistState.completed.indexOf(item.id) !== -1;
        html += '<div class="checklist-item' + (done ? ' done' : '') + '" onclick="checklistAction(\'' + item.id + '\')">';
        html += '<div class="checklist-check"><svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg></div>';
        html += '<div class="checklist-text"><div class="checklist-text-title">' + item.title + '</div><div class="checklist-text-desc">' + item.desc + '</div></div>';
        if (!done) html += '<div class="checklist-arrow"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg></div>';
        html += '</div>';
    });
    document.getElementById('checklistItems').innerHTML = html;
}

function checklistAction(id) {
    var item = CHECKLIST_ITEMS.find(function(i){ return i.id === id; });
    if (item && checklistState.completed.indexOf(id) === -1) item.action();
}

function completeChecklistItem(id) {
    if (checklistState.completed.indexOf(id) !== -1) return;
    checklistState.completed.push(id);
    saveChecklistState();
    renderChecklist();
}

function dismissChecklist() {
    checklistState.dismissed = true;
    saveChecklistState();
    var el = document.getElementById('gettingStarted');
    if (el) { el.style.opacity = '0'; el.style.transition = 'opacity .3s'; setTimeout(function(){ el.style.display = 'none'; }, 300); }
}

function saveChecklistState() {
    apiFetch('/settings', { method: 'PATCH', body: { data: { onboarding: { completed: checklistState.completed, dismissed: checklistState.dismissed } } } }).catch(function(){});
}

function loadChecklistState() {
    if (checklistLoaded) { renderChecklist(); return; }
    apiFetch('/settings').then(function(r){ return r.json(); }).then(function(s) {
        var ob = (s.data && s.data.onboarding) || {};
        checklistState.completed = ob.completed || [];
        checklistState.dismissed = ob.dismissed || false;
        checklistLoaded = true;
        renderChecklist();
    }).catch(function(){ renderChecklist(); });
}

// ── Email Signature Generator ──
function showSignatureModal() {
    var modal = document.getElementById('sigModal');
    var select = document.getElementById('sigCardSelect');
    // Populate card select
    select.innerHTML = '';
    CARD_IDS.forEach(function(id) {
        var opt = document.createElement('option');
        opt.value = id;
        opt.textContent = CARDS[id].company || CARDS[id].name;
        select.appendChild(opt);
    });
    if (CARD_IDS.length > 0) updateSignaturePreview();
    modal.classList.add('show');
}

function hideSignatureModal() {
    document.getElementById('sigModal').classList.remove('show');
}

function updateSignaturePreview() {
    var cardId = document.getElementById('sigCardSelect').value;
    var card = CARDS[cardId];
    if (!card) return;
    var preview = document.getElementById('sigPreview');
    var cardUrl = getCardUrl(cardId);
    var brandColor = card.color || '#6366f1';
    var isPro = getUserPlan() !== 'free';
    var poweredBy = isPro ? '' : '<tr><td style="padding-top:10px;font-size:11px;color:#94a3b8">Made with <a href="https://cardflow.cloud" style="color:#6366f1;text-decoration:none;font-weight:600">CardFlow</a></td></tr>';

    var sigHtml = '<table cellpadding="0" cellspacing="0" style="font-family:Arial,Helvetica,sans-serif;font-size:14px;color:#1e293b;line-height:1.4">' +
        '<tr>' +
        '<td style="padding-right:16px;border-right:3px solid ' + brandColor + '">' +
        '<div style="width:60px;height:60px;border-radius:50%;background:' + brandColor + ';display:flex;align-items:center;justify-content:center;overflow:hidden">';

    if (card.photo) {
        sigHtml += '<img src="' + escHtml(card.photo) + '" width="60" height="60" style="border-radius:50%;object-fit:cover" alt="">';
    } else {
        var initials = (card.name || 'U').split(' ').map(function(w){return w[0]}).join('').toUpperCase().slice(0,2);
        sigHtml += '<span style="color:#fff;font-size:20px;font-weight:700;letter-spacing:1px">' + initials + '</span>';
    }

    sigHtml += '</div></td>' +
        '<td style="padding-left:16px">' +
        '<div style="font-size:16px;font-weight:700;color:#1e293b;margin-bottom:2px">' + escHtml(card.name || '') + '</div>' +
        '<div style="font-size:13px;color:#64748b;margin-bottom:8px">' + escHtml(card.title || '') + (card.company ? ' at ' + escHtml(card.company) : '') + '</div>';

    var contactParts = [];
    if (card.phone) contactParts.push('<a href="tel:' + escHtml(card.phone) + '" style="color:#1e293b;text-decoration:none">' + escHtml(card.phoneDisplay || card.phone) + '</a>');
    if (card.email) contactParts.push('<a href="mailto:' + escHtml(card.email) + '" style="color:#1e293b;text-decoration:none">' + escHtml(card.email) + '</a>');
    if (contactParts.length) {
        sigHtml += '<div style="font-size:12px;margin-bottom:8px">' + contactParts.join(' &nbsp;|&nbsp; ') + '</div>';
    }

    sigHtml += '<a href="' + escHtml(cardUrl) + '" style="display:inline-block;padding:6px 14px;background:' + brandColor + ';color:#fff;border-radius:6px;font-size:12px;font-weight:600;text-decoration:none">View my card</a>' +
        '</td></tr>' +
        poweredBy +
        '</table>';

    preview.innerHTML = sigHtml;
}

// escHtml provided by common.js

function copySignature() {
    var preview = document.getElementById('sigPreview');
    var html = preview.innerHTML;
    // Copy as rich HTML to clipboard
    var blob = new Blob([html], { type: 'text/html' });
    var plainText = preview.innerText;
    var plainBlob = new Blob([plainText], { type: 'text/plain' });
    var data = new ClipboardItem({
        'text/html': blob,
        'text/plain': plainBlob
    });
    navigator.clipboard.write([data]).then(function() {
        var btn = document.getElementById('sigCopyBtn');
        btn.classList.add('copied');
        btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>Copied!';
        setTimeout(function() {
            btn.classList.remove('copied');
            btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>Copy Signature';
        }, 2500);
    }).catch(function() {
        // Fallback: copy plain text
        navigator.clipboard.writeText(plainText).then(function() {
            var btn2 = document.getElementById('sigCopyBtn');
            btn2.classList.add('copied');
            btn2.innerHTML = '<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>Copied (text)';
            setTimeout(function() {
                btn2.classList.remove('copied');
                btn2.innerHTML = '<svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>Copy Signature';
            }, 2500);
        });
    });
}

function toggleSigSetup() {
    var toggle = document.getElementById('sigSetupToggle');
    var guide = document.getElementById('sigSetupGuide');
    toggle.classList.toggle('open');
    guide.classList.toggle('open');
}

// ── Webhook Integration ──
var webhookUrlChanged = false;

function showWebhookPanel() {
    if (getUserPlan() === 'free') { showUpgradeModal('Webhook integrations are available on Pro. Upgrade to connect Zapier, Make, and more.'); return; }
    document.getElementById('webhookModal').classList.add('show');
    document.getElementById('webhookTestResult').style.display = 'none';
    // Load current webhook URL from settings
    apiFetch('/settings').then(function(r){return r.json()}).then(function(s){
        var url = (s.data && s.data.webhookUrl) || '';
        document.getElementById('webhookUrlInput').value = url;
        webhookUrlChanged = false;
    }).catch(function(){});
}

function hideWebhookPanel() {
    document.getElementById('webhookModal').classList.remove('show');
}

function saveWebhookUrl() {
    var url = document.getElementById('webhookUrlInput').value.trim();
    var btn = document.getElementById('saveWebhookBtn');
    btn.textContent = 'Saving...';
    apiFetch('/settings').then(function(r){return r.json()}).then(function(s){
        var data = s.data || {};
        data.webhookUrl = url || null;
        return apiFetch('/settings', {method:'PATCH', body:{data:data}});
    }).then(function(){
        btn.textContent = 'Saved!';
        var dot = document.getElementById('webhookStatusDot');
        if (dot) dot.style.background = url ? '#4ade80' : 'var(--text-muted)';
        setTimeout(function(){ btn.textContent = 'Save'; }, 1500);
        webhookUrlChanged = false;
    }).catch(function(){
        btn.textContent = 'Failed';
        setTimeout(function(){ btn.textContent = 'Save'; }, 1500);
    });
}

function clearWebhookUrl() {
    document.getElementById('webhookUrlInput').value = '';
    saveWebhookUrl();
}

function testWebhook() {
    var url = document.getElementById('webhookUrlInput').value.trim();
    if (!url) { alert('Enter a webhook URL first'); return; }
    var btn = document.getElementById('testWebhookBtn');
    var result = document.getElementById('webhookTestResult');
    btn.textContent = 'Testing...';
    btn.disabled = true;
    result.style.display = 'none';

    apiFetch('/settings/test-webhook', {method:'POST', body:{url:url}})
        .then(function(r){return r.json()})
        .then(function(d){
            btn.textContent = 'Test';
            btn.disabled = false;
            if (d.success) {
                result.style.display = '';
                result.style.background = 'rgba(74,222,128,.1)';
                result.style.color = '#4ade80';
                result.textContent = 'Webhook delivered (status '+d.status+')';
            } else {
                result.style.display = '';
                result.style.background = 'rgba(239,68,68,.1)';
                result.style.color = '#ef4444';
                result.textContent = 'Failed: '+(d.error||'Could not reach URL');
            }
        }).catch(function(){
            btn.textContent = 'Test';
            btn.disabled = false;
            result.style.display = '';
            result.style.background = 'rgba(239,68,68,.1)';
            result.style.color = '#ef4444';
            result.textContent = 'Test failed — check console';
        });
}

// Update webhook status dot on settings load
function updateWebhookDot() {
    apiFetch('/settings').then(function(r){return r.json()}).then(function(s){
        var dot = document.getElementById('webhookStatusDot');
        if (dot && s.data && s.data.webhookUrl) dot.style.background = '#4ade80';
    }).catch(function(){});
}

// ── Weekly Digest Toggle ──
var digestEnabled = false;
function updateDigestUI() {
    var toggle = document.getElementById('digestToggle');
    var hint = document.getElementById('digestHint');
    if (!toggle) return;
    var knob = toggle.firstElementChild;
    if (digestEnabled) {
        toggle.style.background = '#4f46e5';
        knob.style.transform = 'translateX(20px)';
        if (hint) hint.textContent = 'Enabled — recap sent every Monday';
    } else {
        toggle.style.background = 'var(--text-muted)';
        knob.style.transform = 'translateX(0)';
        if (hint) hint.textContent = 'Get a weekly recap every Monday';
    }
}
function loadDigestSetting() {
    apiFetch('/settings').then(function(r){return r.json()}).then(function(s){
        digestEnabled = !!(s.data && s.data.weeklyDigest);
        updateDigestUI();
    }).catch(function(){});
}
function toggleWeeklyDigest() {
    var plan = getUserPlan();
    if (plan === 'free') {
        showUpgradeModal(); return;
    }
    digestEnabled = !digestEnabled;
    updateDigestUI();
    apiFetch('/settings', {
        method: 'PATCH',
        body: { data: { weeklyDigest: digestEnabled } }
    }).catch(function(){
        digestEnabled = !digestEnabled;
        updateDigestUI();
    });
}

// ── Quick Send ──
function getQuickSend() { return localStorage.getItem('quickSendCard') || ''; }
function updateQsBadge() {
    var qs = getQuickSend();
    var btn = document.getElementById('qsBtn');
    var label = document.getElementById('qsLabel');
    if (btn && qs && NAMES[qs]) {
        btn.classList.add('active');
        if (label) label.textContent = 'Quick: ON';
    } else if (btn) {
        btn.classList.remove('active');
        if (label) label.textContent = 'Quick Send';
    }
    document.querySelectorAll('.qs-opt').forEach(function(o){
        o.classList.toggle('selected', o.dataset.card === qs);
    });
    updateStatusBadges();
}
function openQuickSend() { document.getElementById('qsModal').classList.add('show'); updateQsBadge(); }
function closeQuickSend() { document.getElementById('qsModal').classList.remove('show'); }
function setQuickSend(card) {
    if (card) localStorage.setItem('quickSendCard', card);
    else localStorage.removeItem('quickSendCard');
    updateQsBadge();
    closeQuickSend();
}
// Note: updateQsBadge called from initApp() after auth

// ── Default Card (for timeout) ──
var currentDefaultCard = '';
function loadDefaultCard() {
    apiFetch('/settings').then(function(r){return r.json()}).then(function(s){ return s && s.defaultCard; }).then(function(card) {
        currentDefaultCard = card || '';
        updateDefaultBadge();
    }).catch(function(){});
}
function updateDefaultBadge() {
    var btn = document.getElementById('defaultBtn');
    var label = document.getElementById('defaultLabel');
    if (btn && currentDefaultCard && NAMES[currentDefaultCard]) {
        btn.classList.add('active');
        if (label) label.textContent = 'Default: ON';
    } else if (btn) {
        btn.classList.remove('active');
        if (label) label.textContent = 'Default';
    }
    document.querySelectorAll('[data-default]').forEach(function(o){
        o.classList.toggle('selected', o.dataset.default === currentDefaultCard);
    });
    updateStatusBadges();
    renderQrSwitcher();
    updateQrActions();
}
function openDefaultCard() { document.getElementById('defaultModal').classList.add('show'); updateDefaultBadge(); }
function closeDefaultCard() { document.getElementById('defaultModal').classList.remove('show'); }
function setDefaultCard(card) {
    currentDefaultCard = card;
    apiFetch('/settings',{method:'PATCH',body:{defaultCard:card || null}}).catch(function(e){ console.error('Default card save failed:', e); });
    updateDefaultBadge();
    closeDefaultCard();
}
function toggleDefaultCard(card) {
    if (!card) { var sel = document.getElementById('qrCardSelect'); card = sel ? sel.value : ''; }
    if (!card) return;
    var newDefault = (currentDefaultCard === card) ? '' : card;
    currentDefaultCard = newDefault;
    apiFetch('/settings',{method:'PATCH',body:{defaultCard:newDefault || null}}).catch(function(e){ console.error('Default card toggle failed:', e); });
    updateDefaultBadge();
    if (newDefault) completeChecklistItem('set_default');
}
// Note: loadDefaultCard called from initApp() after auth

// ── Listen for taps ──
var es = null;
var currentLeadES = null;
var tapRetries = 0;
function startListeningForTaps() {
    if (!currentUser || !authToken) return;
    if (es) es.close();
    cfLog('SSE', 'Requesting tap SSE ticket...');
    apiFetch('/auth/sse-ticket', {noRedirect: true}).then(function(r){
        if (!r.ok) { cfLog('SSE', 'Ticket failed: ' + r.status); return; }
        return r.json();
    }).then(function(d) {
        if (!d || !d.ticket) return;
        cfLog('SSE', 'Got ticket, connecting to /api/sse/taps');
        es = new EventSource('/api/sse/taps?ticket=' + d.ticket);
        es.onopen = function() {
            cfLog('SSE', 'Tap SSE connected');
            tapRetries = 0;
            checkPendingTap();
        };
        es.onmessage = function(e) {
            tapRetries = 0;
            cfLog('SSE', 'Tap SSE message received', e.data.substring(0, 100));
            try { handleTapEvent({ data: e.data }); } catch(err) { cfLog('SSE', 'handleTapEvent error: ' + err.message); }
        };
        es.onerror = function() {
            cfLog('SSE', 'Tap SSE error, readyState=' + es.readyState + ', retry #' + tapRetries);
            es.close();
            if (tapRetries < 50) {
                var delay = Math.min(5000 * Math.pow(1.5, tapRetries), 30000);
                tapRetries++;
                setTimeout(function() { startListeningForTaps(); }, delay);
            }
        };
    }).catch(function(e) { cfLog('SSE', 'SSE ticket error: ' + e.message); });
}

// ── Listen for leads (SSE) ──
var esLeads = null;
var leadRetries = 0;
function startListeningForLeads() {
    if (!currentUser || !authToken) return;
    if (esLeads) esLeads.close();
    apiFetch('/auth/sse-ticket', {noRedirect: true}).then(function(r){
        if (!r.ok) { console.warn('SSE leads ticket failed:', r.status); return; }
        return r.json();
    }).then(function(d) {
        if (!d || !d.ticket) return;
        esLeads = new EventSource('/api/sse/leads?ticket=' + d.ticket);
        esLeads.onopen = function() { leadRetries = 0; };
        esLeads.onmessage = function(e) {
            leadRetries = 0;
            try {
                var val = JSON.parse(e.data);
                if (!val || !val.id) return;
                loadStats();
                if (currentPage === 'leads' || (currentPage === 'cards' && currentCardsTab === 'leads')) {
                    showLeadsData();
                }
            } catch(err) {}
        };
        esLeads.onerror = function() {
            esLeads.close();
            if (leadRetries < 50) {
                var delay = Math.min(5000 * Math.pow(1.5, leadRetries), 30000);
                leadRetries++;
                setTimeout(function() { startListeningForLeads(); }, delay);
            }
        };
    }).catch(function(e) { console.error('SSE ticket error:', e); });
}

// ── SSE cleanup on page unload ──
window.addEventListener('beforeunload', function() {
    if (typeof es !== 'undefined' && es) { es.close(); es = null; }
    if (typeof esLeads !== 'undefined' && esLeads) { esLeads.close(); esLeads = null; }
    if (typeof currentLeadES !== 'undefined' && currentLeadES) { currentLeadES.close(); currentLeadES = null; }
});

function handleTapEvent(e) {
    var val = JSON.parse(e.data);
    if (!val || !val.sessionId) return;
    cfLog('TAP', 'handleTapEvent received', {sid: val.sessionId, card: val.card, ts: val.ts});

    // Skip if we've already seen this session (prevents duplicate notifications on reconnect/refresh)
    if (val.sessionId === lastSeenSession) {
        cfLog('TAP', 'Skipping duplicate session', val.sessionId);
        return;
    }

    // Check if this tap is recent (within last 5 minutes) to avoid old data on reconnect
    if (val.ts && typeof val.ts === 'number') {
        var age = Date.now() - val.ts;
        if (age > 300000) {
            cfLog('TAP', 'Skipping stale tap, age=' + age + 'ms');
            return;
        }
    }

    // New session - save it
    lastSeenSession = val.sessionId;
    localStorage.setItem('lastSeenSession', val.sessionId);

    currentSession = val.sessionId;
    var vi = val.visitor;
    document.getElementById('visitor-info').textContent = vi ? (vi.device+' · '+vi.browser) : '';
    prependTapLog(val);
    buzz();

    // Card was already shown via default card redirect — just notify admin
    if (val.card && NAMES[val.card]) {
        cfLog('TAP', 'Card already selected via default: ' + val.card);
        notify('Card shared!', NAMES[val.card] + ' sent via default');
        updateTapLogCard(val.sessionId, val.card);
        loadStats();
        return;
    }

    // Quick Send — auto-select card and notify
    var qs = getQuickSend();
    if (qs && NAMES[qs]) {
        cfLog('TAP', 'Quick Send active, auto-selecting: ' + qs);
        notify('Card auto-sent!', NAMES[qs] + ' shared via Quick Send');
        selectCardInLog(currentSession, qs);
        return;
    }

    // Manual selection — show picker overlay + notify
    cfLog('TAP', 'Showing picker for manual selection, CARD_IDS=' + CARD_IDS.length);
    notify('Someone tapped your card!', 'Select a card to share');
    if (CARD_IDS.length > 0) {
        initCardElements();
        show('picker');
    } else {
        // CARD_IDS not loaded yet — poll until ready
        var _pickPoll = 0;
        var _pickTimer = setInterval(function() {
            _pickPoll++;
            if (CARD_IDS.length > 0 || _pickPoll >= 20) {
                clearInterval(_pickTimer);
                if (currentSession && CARD_IDS.length > 0) {
                    cfLog('TAP', 'Cards loaded after ' + _pickPoll + ' polls, showing picker');
                    initCardElements();
                    show('picker');
                }
            }
        }, 150);
    }
}

// ── Select card ──
var leadReceived = false;
var returnTimer = null;

function goBackNow() {
    if (returnTimer) clearTimeout(returnTimer);
    show('idle');
    loadStats();
}

function selectCard(cardId, auto) {
    cfLog('SELECT', 'selectCard cardId=' + cardId + ' auto=' + auto + ' session=' + currentSession);
    if (!currentSession) {
        showToast('Tap session expired — please tap the card again.', 'error');
        show('idle');
        return;
    }
    apiFetch('/taps/'+currentSession,{method:'PATCH',body:{card:cardId,status:'selected'},noRedirect:true}).catch(function(e){ cfLog('SELECT', 'Tap PATCH failed: ' + e.message); });
    apiFetch('/leads/'+currentSession,{method:'PATCH',body:{card:cardId},noRedirect:true}).catch(function(e){ cfLog('SELECT', 'Lead PATCH failed: ' + e.message); });
    updateTapLogCard(currentSession, cardId);

    document.getElementById('sent-detail').textContent = NAMES[cardId]+' card shared';
    document.getElementById('sent-auto').textContent = auto ? '(Quick Send)' : '';
    document.getElementById('lead-display').innerHTML = '';
    leadReceived = false;
    show('sent');
    loadStats();

    // Reset progress bar animation
    var progress = document.getElementById('returnProgress');
    var progressBar = progress ? progress.querySelector('.return-progress-bar') : null;
    if (progressBar) {
        progressBar.style.animation = 'none';
        progressBar.offsetHeight; // Force reflow
        progressBar.style.animation = 'returnProgress 1.5s linear forwards';
    }

    // M6: Start return timer with minimum 2s delay to let lead SSE establish
    if (returnTimer) clearTimeout(returnTimer);
    returnTimer = setTimeout(function(){
        if (!leadReceived) { show('idle'); loadStats(); }
    }, 3000);

    var sid = currentSession;
    if (currentLeadES) { currentLeadES.close(); currentLeadES = null; }
    apiFetch('/auth/sse-ticket', {noRedirect: true}).then(function(r){
        if (!r.ok) return;
        return r.json();
    }).then(function(d) {
        if (!d || !d.ticket) return;
        cfLog('SELECT', 'Opening lead SSE for session ' + sid);
        currentLeadES = new EventSource('/api/sse/lead/'+sid+'?ticket='+d.ticket);
        currentLeadES.onopen = function() { cfLog('SELECT', 'Lead SSE connected'); };
        currentLeadES.onmessage = function(ev) { handleLead(ev); };
        currentLeadES.onerror = function() { cfLog('SELECT', 'Lead SSE error, readyState=' + currentLeadES.readyState); };
        setTimeout(function(){ if(currentLeadES) currentLeadES.close(); },60000);
    }).catch(function(e) { cfLog('SELECT', 'SSE ticket error: ' + e.message); });
    function handleLead(ev) {
        var lead = JSON.parse(ev.data);
        if (!lead) return;
        if (typeof lead === 'string') return;
        cfLog('SELECT', 'Lead SSE data: ' + JSON.stringify(lead));

        // First message: show initial data
        if (!leadReceived) {
            // Need at least some data (name/phone/email) OR a photo being processed
            if (!lead.name && !lead.phone && !lead.email && !lead.hasPhoto) return;
            leadReceived = true;
            clearTimeout(returnTimer);
            buzz();
            notify('Lead received!', (lead.name || 'Card photo') + (lead.company?' — '+lead.company:''));
            document.getElementById('sent-auto').textContent = 'Lead saved!';
            var progress = document.getElementById('returnProgress');
            var returnText = document.getElementById('returnText');
            if (progress) progress.style.display = 'none';
            if (returnText) returnText.style.display = 'none';
        }

        // Build lead card HTML
        renderLeadCard(lead);

        // If OCR processed or no photo, close SSE. Otherwise keep open for OCR enrichment.
        if (lead.ocrProcessed || !lead.hasPhoto) {
            if (currentLeadES) currentLeadES.close();
        }
    }

    function renderLeadCard(lead) {
        var html = '<div class="lead-card"><div class="lc-label">Lead received</div>';
        if (lead.name) html += '<div class="lc-name">'+escapeHtml(lead.name)+'</div>';
        if (lead.title) html += '<div class="lc-company">'+escapeHtml(lead.title)+'</div>';
        if (lead.company) html += '<div class="lc-company">'+escapeHtml(lead.company)+'</div>';
        html += '<div class="lc-contact">';
        if (lead.phone) html += '<div><a href="tel:'+escapeHtml(lead.phone)+'">'+escapeHtml(lead.phone)+'</a></div>';
        if (lead.email) html += '<div><a href="mailto:'+escapeHtml(lead.email)+'">'+escapeHtml(lead.email)+'</a></div>';
        html += '</div>';
        // Show processing status for photo leads awaiting OCR
        if (lead.hasPhoto && !lead.ocrProcessed) {
            html += '<div class="lc-ocr-status"><svg class="spin" viewBox="0 0 24 24" width="16" height="16"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46A7.93 7.93 0 0020 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74A7.93 7.93 0 004 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/></svg> Processing card photo...</div>';
        }
        if (lead.ocrProcessed && !lead.name && !lead.phone && !lead.email) {
            html += '<div class="lc-ocr-status">Could not extract text from photo. View it in your leads.</div>';
        }
        html += '<div class="lead-actions"><button class="save-lead-btn" onclick="saveLead(\''+esc(lead.name||'')+'\',\''+esc(lead.phone||'')+'\',\''+esc(lead.email||'')+'\',\''+esc(lead.company||'')+'\')"><svg viewBox="0 0 24 24"><path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2v9.67z"/></svg>Save to Contacts</button></div>';
        html += '</div>';
        document.getElementById('lead-display').innerHTML = html;
    }
}

function skipCard() {
    if (!currentSession) { show('idle'); return; }
    apiFetch('/taps/'+currentSession,{method:'PATCH',body:{status:'skipped'}}).catch(function(e){ console.error('Tap skip failed:', e); });
    currentSession = null;
    show('idle');
    loadStats();
}

// ── Leads Dashboard ──
var sortByScore = false;
var activeSourceFilter = 'all';

function showLeads() {
    navigateTo('leads');
}

function showLeadsData() {
    // Fetch leads (required), analytics (optional), and exchanges (for sent items)
    var leadsPromise = apiFetch('/leads').then(function(r){return r.json()}).catch(function(){ return null; });
    var analyticsPromise = apiFetch('/analytics').then(function(r){return r.json()}).catch(function(){ return {}; });
    var exchangesPromise = apiFetch('/exchanges').then(function(r){return r.json()}).catch(function(){ return { sent: [], received: [] }; });

    Promise.all([leadsPromise, analyticsPromise, exchangesPromise]).then(function(results) {
        var data = results[0];
        var analytics = results[1] || {};
        var exchData = results[2] || { sent: [], received: [] };

        // Aggregate analytics by session ID
        leadScores = {};
        try {
            for (var cardId in analytics) {
                var cardAnalytics = analytics[cardId];
                if (!cardAnalytics) continue;
                var clicksArr = Array.isArray(cardAnalytics.clicks) ? cardAnalytics.clicks : [];
                clicksArr.forEach(function(click) {
                    if (click && click.sid) {
                        if (!leadScores[click.sid]) leadScores[click.sid] = {score: 0, actions: []};
                        leadScores[click.sid].actions.push(click);
                    }
                });
                var viewsArr = Array.isArray(cardAnalytics.views) ? cardAnalytics.views : [];
                viewsArr.forEach(function(view) {
                    if (view && view.sid) {
                        if (!leadScores[view.sid]) leadScores[view.sid] = {score: 0, actions: []};
                        leadScores[view.sid].actions.push({action: 'view', ts: view.ts});
                    }
                });
            }
            for (var sid in leadScores) {
                leadScores[sid].score = calculateLeadScore(leadScores[sid].actions);
            }
        } catch(e) { console.error('Analytics scoring error:', e); }

        if (!data || typeof data !== 'object') { allLeads=[]; renderLeads([]); return; }

        var items = [];
        for (var k in data) {
            var l = data[k];
            if (!l) continue;
            l._id = k;
            if (!l.status) l.status = 'new';
            if (!l.tags) l.tags = [];
            if (typeof l.tags === 'string') l.tags = [l.tags];
            l.score = leadScores[k] ? leadScores[k].score : 0;
            l.actions = leadScores[k] ? leadScores[k].actions : [];
            items.push(l);
        }

        // Inject sent exchanges as pseudo-leads (read-only)
        var sentExchanges = exchData.sent || [];
        sentExchanges.forEach(function(ex) {
            items.push({
                _id: 'sent_' + ex.id,
                _sent: true,
                type: 'card_exchange',
                source: 'exchange',
                _exchangeDirection: 'sent',
                name: ex.recipient_name || 'Unknown',
                company: ex.recipient_company || '',
                title: ex.recipient_title || '',
                email: ex.recipient_email || '',
                phone: ex.recipient_phone || '',
                exchangerUsername: ex.recipient_username || '',
                exchangerCardId: ex.recipient_card_id || '',
                status: 'new',
                tags: [],
                ts: new Date(ex.created_at).getTime(),
                score: 0,
                actions: []
            });
        });

        // Mark received exchanges with direction
        items.forEach(function(l) {
            if (l.type === 'card_exchange' && !l._sent) l._exchangeDirection = 'received';
        });

        if (sortByScore) {
            items.sort(function(a,b){ return (b.score||0)-(a.score||0); });
        } else {
            items.sort(function(a,b){ return (b.ts||0)-(a.ts||0); });
        }
        allLeads = items;
        renderLeads(filterLeadsData());
        checkReminders();
    }).catch(function(err){
        console.error('Leads load error:', err);
        document.getElementById('leads-list').innerHTML = '<div class="leads-empty">Failed to load leads</div>';
    });
}

function toggleScoreSort() {
    sortByScore = !sortByScore;
    var btn = document.getElementById('scoreSortBtn');
    if (btn) btn.classList.toggle('active', sortByScore);
    if (sortByScore) {
        allLeads.sort(function(a,b){ return (b.score||0)-(a.score||0); });
    } else {
        allLeads.sort(function(a,b){ return (b.ts||0)-(a.ts||0); });
    }
    renderLeads(filterLeadsData());
}

function renderLeads(items) {
    var list = document.getElementById('leads-list');
    document.getElementById('leads-count').textContent = items.length;
    if (items.length === 0) { list.innerHTML = '<div class="empty-state"><div class="empty-state-icon"><svg viewBox="0 0 24 24" width="40" height="40" fill="none" stroke="var(--text-muted)" stroke-width="1.5"><path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="8.5" cy="7" r="4"/><path d="M20 8v6M23 11h-6"/></svg></div><div class="empty-state-title">No leads yet</div><div class="empty-state-desc">Share your card to start capturing contacts.</div><button class="empty-state-btn" onclick="shareCardLink()">Share Your Card</button></div>'; return; }

    var html = '';
    items.forEach(function(l) {
        var statusClass = 'status-'+(l.status||'new');
        var statusLabel = STATUS_LABELS[l.status||'new'] || 'New';
        var isExpanded = expandedLeadId === l._id;
        var isExchange = l.type === 'card_exchange';
        var hasContact = l.name || l.phone || l.email;

        // Date compact
        var timeCompact = '';
        if (l.ts) {
            var d = new Date(l.ts);
            timeCompact = d.toLocaleDateString('en-IN',{day:'numeric',month:'short'});
        }

        html += '<div class="lead-item'+(isExchange?' lead-exchange':'')+(isExpanded?' expanded':'')+'" data-id="'+escAttr(l._id)+'">';

        // ── Collapsed row (cleaned up — max 4 badges) ──
        html += '<div class="li-collapsed" onclick="toggleLeadExpand(\''+escAttr(l._id)+'\')">';
        var nameStr = l.name || (hasContact ? '' : 'Anonymous Visitor');
        var initials = (nameStr || '?').split(' ').map(function(w){return w[0]||''}).join('').substring(0,2).toUpperCase();
        var avatarBg = isExchange ? 'rgba(16,185,129,.2)' : 'var(--glass-border)';
        var avatarColor = isExchange ? '#10b981' : 'var(--text-muted)';
        html += '<div class="li-avatar" style="background:'+avatarBg+';color:'+avatarColor+'">'+initials+'</div>';
        html += '<div class="li-collapsed-left">';
        html += '<div class="li-name"'+(nameStr==='Anonymous Visitor'?' style="opacity:.5"':'')+'>'+escapeHtml(nameStr)+'</div>';
        if (l.company) html += '<div class="li-company">'+escapeHtml(l.company)+'</div>';
        var contactPreview = '';
        if (l.phone) contactPreview += '<a href="tel:'+escapeHtml(l.phone)+'" class="li-preview-link" onclick="event.stopPropagation()">'+escapeHtml(l.phone)+'</a>';
        if (l.email) contactPreview += (contactPreview ? '<span class="li-preview-dot"> · </span>' : '') + '<a href="mailto:'+escapeHtml(l.email)+'" class="li-preview-link" onclick="event.stopPropagation()">'+escapeHtml(l.email)+'</a>';
        if (contactPreview) html += '<div class="li-preview">'+contactPreview+'</div>';
        html += '</div>';
        html += '<div class="li-collapsed-right">';
        if (isExchange && l._exchangeDirection === 'sent') html += '<span class="exchange-badge-sm sent">Sent</span>';
        else if (isExchange) html += '<span class="exchange-badge-sm">Received</span>';
        else if (l.ocrProcessed) html += '<span class="li-ocr-badge">Scanned</span>';
        if (!l._sent) html += '<button class="status-badge '+statusClass+'" onclick="event.stopPropagation();cycleStatus(\''+escAttr(l._id)+'\')">'+statusLabel+'</button>';
        if (timeCompact) html += '<span class="li-time-compact">'+timeCompact+'</span>';
        html += '<svg class="li-chevron" viewBox="0 0 24 24"><path d="M7 10l5 5 5-5z"/></svg>';
        html += '</div></div>';

        // ── Expanded body (sectioned) ──
        html += '<div class="li-expanded">';

        // ─ Section 1: Contact + Quick Actions ─
        html += '<div class="li-section">';
        html += '<div class="li-section-label">Contact</div>';
        var titleStr = l.title || (l.ocrFields && l.ocrFields.title) || '';
        if (titleStr) html += '<div class="li-contact-row"><svg viewBox="0 0 24 24"><path d="M20 6H16V4C16 2.89 15.11 2 14 2H10C8.89 2 8 2.89 8 4V6H4C2.89 6 2 6.89 2 8V19C2 20.11 2.89 21 4 21H20C21.11 21 22 20.11 22 19V8C22 6.89 21.11 6 20 6ZM10 4H14V6H10V4Z"/></svg>'+escapeHtml(titleStr)+'</div>';
        if (l.phone) html += '<div class="li-contact-row"><svg viewBox="0 0 24 24"><path d="M6.62 10.79a15.05 15.05 0 0 0 6.59 6.59l2.2-2.2a1 1 0 0 1 1.01-.24c1.12.37 2.33.57 3.58.57a1 1 0 0 1 1 1V20a1 1 0 0 1-1 1A17 17 0 0 1 3 4a1 1 0 0 1 1-1h3.5a1 1 0 0 1 1 1c0 1.25.2 2.46.57 3.58a1 1 0 0 1-.24 1.01l-2.2 2.2z"/></svg>'+escapeHtml(l.phone)+'</div>';
        if (l.email) html += '<div class="li-contact-row"><svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>'+escapeHtml(l.email)+'</div>';
        var addressStr = l.address || (l.ocrFields && l.ocrFields.address) || '';
        if (addressStr) html += '<div class="li-contact-row" style="color:var(--text-muted)"><svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5a2.5 2.5 0 0 1 0-5 2.5 2.5 0 0 1 0 5z"/></svg>'+escapeHtml(addressStr)+'</div>';
        var websiteStr = (l.ocrFields && l.ocrFields.website) || '';
        if (websiteStr) html += '<div class="li-contact-row"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg><a href="'+escapeHtml(websiteStr)+'" target="_blank" onclick="event.stopPropagation()" style="color:var(--text-secondary);text-decoration:none">'+escapeHtml(websiteStr.replace(/^https?:\/\//,''))+'</a></div>';
        var socials = [];
        if (l.ocrFields) {
            if (l.ocrFields.linkedin) socials.push({icon:'in',val:l.ocrFields.linkedin,url:'https://linkedin.com/in/'+l.ocrFields.linkedin});
            if (l.ocrFields.instagram) socials.push({icon:'ig',val:l.ocrFields.instagram,url:'https://instagram.com/'+l.ocrFields.instagram});
            if (l.ocrFields.twitter) socials.push({icon:'x',val:l.ocrFields.twitter,url:'https://x.com/'+l.ocrFields.twitter});
        }
        if (socials.length) {
            html += '<div class="li-contact-row" style="gap:12px">';
            socials.forEach(function(s) { html += '<a href="'+escapeHtml(s.url)+'" target="_blank" onclick="event.stopPropagation()" style="color:var(--text-muted);text-decoration:none;font-size:12px">'+s.icon+'/'+escapeHtml(s.val)+'</a>'; });
            html += '</div>';
        }
        if (isExchange && l.exchangerUsername) {
            html += '<a href="/'+escapeHtml(l.exchangerUsername)+(l.exchangerCardId?'/'+escapeHtml(l.exchangerCardId):'')+'" target="_blank" class="li-exchange-link" onclick="event.stopPropagation()">View their card &rarr;</a>';
        }
        if (l.phone || l.email) {
            html += '<div class="li-quick-actions">';
            if (l.phone) {
                html += '<a href="tel:'+escapeHtml(l.phone)+'" class="li-quick-btn call-btn" onclick="event.stopPropagation()"><svg viewBox="0 0 24 24"><path d="M6.62 10.79a15.05 15.05 0 0 0 6.59 6.59l2.2-2.2a1 1 0 0 1 1.01-.24c1.12.37 2.33.57 3.58.57a1 1 0 0 1 1 1V20a1 1 0 0 1-1 1A17 17 0 0 1 3 4a1 1 0 0 1 1-1h3.5a1 1 0 0 1 1 1c0 1.25.2 2.46.57 3.58a1 1 0 0 1-.24 1.01l-2.2 2.2z"/></svg>Call</a>';
                var waNum = l.phone.replace(/[^0-9]/g,'');
                if (waNum.length === 10) waNum = '91'+waNum;
                var waMsg = encodeURIComponent('Hi'+(l.name?' '+l.name.split(' ')[0]:'')+', ');
                html += '<a href="https://wa.me/'+waNum+'?text='+waMsg+'" target="_blank" class="li-quick-btn wa-btn" onclick="event.stopPropagation()"><svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51l-.57-.01c-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347zM12.05 21.785h-.01a9.87 9.87 0 0 1-5.031-1.378l-.361-.214-3.741.981.998-3.648-.235-.374A9.86 9.86 0 0 1 2.15 12.01C2.15 6.558 6.558 2.15 12.05 2.15c2.634 0 5.122 1.03 6.988 2.898a9.825 9.825 0 0 1 2.893 6.994c-.003 5.45-4.437 9.884-9.88 9.884v-.14z"/></svg>WA</a>';
            }
            if (l.email) html += '<a href="mailto:'+escapeHtml(l.email)+'" class="li-quick-btn email-btn" onclick="event.stopPropagation()"><svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>Email</a>';
            html += '</div>';
        }
        // Card photo (after contact, before activity)
        if (l.photo) html += '<img class="li-photo" src="'+escapeHtml(l.photo)+'" alt="Card photo">';
        html += '</div>';

        // ─ Section 2: Activity & Meta ─
        var hasActivity = (l.ts || (l.actions && l.actions.length > 0) || l.card);
        if (hasActivity) {
        html += '<div class="li-section">';
        html += '<div class="li-section-label">Activity</div>';
        var cardLabel = l.card && (NAMES[l.card] || (CARDS[l.card] && CARDS[l.card].company) || l.card);
        if (cardLabel) html += '<span class="li-card-badge">via '+escapeHtml(cardLabel)+'</span>';
        if (l.ts) {
            var d2 = new Date(l.ts);
            html += '<div class="li-time">'+d2.toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'})+' '+d2.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'});
            if (l.source) html += '<span class="li-source">'+escapeHtml(l.source)+'</span>';
            html += '</div>';
        }
        if (l.actions && l.actions.length > 0) {
            var actionCounts = {};
            l.actions.forEach(function(a) { var action = a.action || 'view'; actionCounts[action] = (actionCounts[action] || 0) + 1; });
            html += '<div class="lead-actions-row">';
            var actionLabels = {call:'Called',whatsapp:'WhatsApp',email:'Emailed',save_contact:'Saved Contact',website:'Website',linkedin:'LinkedIn',instagram:'Instagram',twitter:'Twitter',view:'Viewed'};
            for (var action in actionCounts) {
                var label = actionLabels[action] || action;
                var count = actionCounts[action];
                html += '<span class="action-chip">'+label+(count > 1 ? ' ×'+count : '')+'</span>';
            }
            html += '</div>';
        }
        html += '</div>';
        }

        // ─ Section 3: Tags, Notes, Reminder (skip for sent exchanges) ─
        if (!l._sent) {
        html += '<div class="li-section">';
        html += '<div class="li-section-label">Notes & Follow-up</div>';
        html += '<div class="tag-row">';
        if (l.tags && l.tags.length) {
            l.tags.forEach(function(t){
                html += '<span class="tag-chip" onclick="event.stopPropagation();removeTag(\''+escAttr(l._id)+'\',\''+esc(t)+'\')">'+escapeHtml(t)+' &times;</span>';
            });
        }
        html += '<button class="add-tag-btn" onclick="event.stopPropagation();openTagModal(\''+escAttr(l._id)+'\')">+ Tag</button></div>';
        html += '<div class="lead-note"><textarea placeholder="Add notes..." onclick="event.stopPropagation()" onblur="saveNote(\''+escAttr(l._id)+'\',this)" rows="2">'+escapeHtml(l.notes||'')+'</textarea><div class="lead-note-saved" id="note-saved-'+escAttr(l._id)+'">Saved</div></div>';
        html += '<div class="lead-reminder">';
        if (l.reminder && l.reminder.date && !l.reminder.done) {
            var isOverdue = new Date(l.reminder.date) < new Date().setHours(0,0,0,0);
            html += '<span class="remind-set'+(isOverdue?' reminder-overdue':'')+'">Reminder: '+l.reminder.date+(isOverdue?' (Overdue)':'')+'</span>';
            if (l.phone) {
                html += '<select class="template-select" id="tpl-'+escAttr(l._id)+'" onclick="event.stopPropagation()"><option value="day1">Day 1</option><option value="day3">Day 3</option><option value="day7">Day 7</option><option value="custom">Custom</option></select>';
                html += '<button class="followup-send" onclick="event.stopPropagation();sendFollowup(\''+escAttr(l._id)+'\')"><svg viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51l-.57-.01c-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347z"/></svg>Send</button>';
            }
            html += '<button class="remind-btn" onclick="event.stopPropagation();dismissReminder(\''+escAttr(l._id)+'\')">Done</button>';
        } else {
            html += '<input type="date" id="remind-date-'+escAttr(l._id)+'" onclick="event.stopPropagation()">';
            html += '<button class="remind-btn" onclick="event.stopPropagation();setReminder(\''+escAttr(l._id)+'\')">Remind me</button>';
        }
        html += '</div>';
        html += '</div>';
        }

        // ─ Section 4: Action buttons ─
        html += '<div class="li-section li-section-actions">';
        if (!l._sent) {
        html += '<button class="edit-lead-btn" onclick="event.stopPropagation();openEditModal(\''+escAttr(l._id)+'\')"><svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a.996.996 0 0 0 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>Edit</button>';
        }
        html += '<button class="save-lead-btn" onclick="event.stopPropagation();saveLead(\''+esc(l.name||'')+'\',\''+esc(l.phone||'')+'\',\''+esc(l.email||'')+'\',\''+esc(l.company||'')+'\')"><svg viewBox="0 0 24 24"><path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2v9.67z"/></svg>Save</button>';
        if (!l._sent) {
        html += '<button class="del-lead-btn" onclick="event.stopPropagation();deleteLead(\''+escAttr(l._id)+'\')"><svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>Delete</button>';
        }
        html += '</div>';

        html += '</div>'; // .li-expanded
        html += '</div>'; // .lead-item
    });
    list.innerHTML = html;
}

function toggleLeadExpand(id) {
    if (expandedLeadId === id) {
        expandedLeadId = null;
    } else {
        expandedLeadId = id;
    }
    // Toggle classes directly for smooth UX instead of full re-render
    document.querySelectorAll('.lead-item').forEach(function(el) {
        if (el.dataset.id === id && expandedLeadId === id) {
            el.classList.add('expanded');
        } else {
            el.classList.remove('expanded');
        }
    });
}

var _leadSearchTimer = null;
function debouncedFilterLeads() {
    clearTimeout(_leadSearchTimer);
    _leadSearchTimer = setTimeout(filterLeads, 200);
}

function filterLeads() {
    renderLeads(filterLeadsData());
}

function filterLeadsData() {
    var q = document.getElementById('leadSearch').value.toLowerCase().trim();
    var filtered = allLeads;

    // Source filter
    if (activeSourceFilter !== 'all') {
        filtered = filtered.filter(function(l) {
            var src = (l.source || '').toLowerCase();
            if (activeSourceFilter === 'exchange') return l.type === 'card_exchange' || src === 'exchange';
            if (activeSourceFilter === 'scan') return src === 'scan' || src === 'badge_scan' || l.ocrProcessed;
            if (activeSourceFilter === 'tap') return src === 'nfc_tap' || src === 'tap';
            if (activeSourceFilter === 'manual') return src === 'manual' || src === 'form' || (!src && !l.type);
            if (activeSourceFilter === 'import') return src === 'csv_import' || src === 'vcf_import' || src === 'import';
            return true;
        });
    }

    if (activeFilter !== 'all') {
        if (activeFilter === 'score-hot') {
            filtered = filtered.filter(function(l){ return (l.score||0) >= 10; });
        } else if (activeFilter === 'score-warm') {
            filtered = filtered.filter(function(l){ return (l.score||0) >= 5 && (l.score||0) < 10; });
        } else if (activeFilter.indexOf('status-') === 0) {
            var st = activeFilter.replace('status-','');
            filtered = filtered.filter(function(l){ return (l.status||'new') === st; });
        } else if (activeFilter.indexOf('tag-') === 0) {
            var tag = activeFilter.replace('tag-','');
            filtered = filtered.filter(function(l){ return l.tags && l.tags.indexOf(tag) !== -1; });
        } else if (activeFilter.indexOf('card-') === 0) {
            var card = activeFilter.replace('card-','');
            filtered = filtered.filter(function(l){ return l.card === card; });
        }
    }

    if (q) {
        filtered = filtered.filter(function(l){
            return (l.name||'').toLowerCase().indexOf(q)!==-1 ||
                   (l.company||'').toLowerCase().indexOf(q)!==-1 ||
                   (l.phone||'').indexOf(q)!==-1 ||
                   (l.email||'').toLowerCase().indexOf(q)!==-1 ||
                   (l.notes||'').toLowerCase().indexOf(q)!==-1;
        });
    }
    return filtered;
}

function setFilter(f) {
    activeFilter = f;
    document.querySelectorAll('#filterBar .filter-chip').forEach(function(c){ c.classList.toggle('active', c.dataset.filter === f); });
    filterLeads();
}

function setSourceFilter(src) {
    activeSourceFilter = src;
    var labels = { all: 'Source ▾', exchange: 'Exchanges ▾', scan: 'Scanned ▾', tap: 'Taps ▾', manual: 'Manual ▾', import: 'Imported ▾' };
    var btn = document.getElementById('sourceDropBtn');
    if (btn) {
        btn.textContent = labels[src] || 'Source ▾';
        btn.classList.toggle('active', src !== 'all');
    }
    filterLeads();
}

function cycleStatus(id) {
    var lead = allLeads.find(function(l){ return l._id === id; });
    if (!lead) return;
    var idx = STATUS_OPTIONS.indexOf(lead.status||'new');
    var next = STATUS_OPTIONS[(idx+1) % STATUS_OPTIONS.length];
    lead.status = next;
    apiFetch('/leads/'+id,{method:'PATCH',body:{status:next}}).catch(function(e){ console.error('Lead status update failed:', e); });
    filterLeads();
}

function saveNote(id, textarea) {
    var note = textarea.value.trim();
    var lead = allLeads.find(function(l){ return l._id === id; });
    if (lead) lead.notes = note;
    apiFetch('/leads/'+id,{method:'PATCH',body:{notes:note}}).catch(function(e){ console.error('Lead note save failed:', e); });
    var saved = document.getElementById('note-saved-'+id);
    if (saved) { saved.style.display = 'block'; setTimeout(function(){ saved.style.display = 'none'; },1500); }
}

function openTagModal(id) {
    tagModalLeadId = id;
    var lead = allLeads.find(function(l){ return l._id === id; });
    tagModalTags = lead && lead.tags ? lead.tags.slice() : [];

    var html = '';
    PRESET_TAGS.forEach(function(t){
        var sel = tagModalTags.indexOf(t) !== -1 ? ' selected' : '';
        html += '<button class="tag-option'+sel+'" onclick="toggleTagOption(this,\''+esc(t)+'\')">'+escapeHtml(t)+'</button>';
    });
    document.getElementById('tagOptions').innerHTML = html;
    document.getElementById('customTagInput').value = '';
    document.getElementById('tagModal').classList.add('show');
}
function closeTagModal() { document.getElementById('tagModal').classList.remove('show'); }

function toggleTagOption(btn, tag) {
    var idx = tagModalTags.indexOf(tag);
    if (idx !== -1) { tagModalTags.splice(idx,1); btn.classList.remove('selected'); }
    else { tagModalTags.push(tag); btn.classList.add('selected'); }
}

function addCustomTag() {
    var input = document.getElementById('customTagInput');
    var tag = input.value.trim();
    if (!tag || tagModalTags.indexOf(tag) !== -1) return;
    tagModalTags.push(tag);
    input.value = '';
    var opts = document.getElementById('tagOptions');
    opts.innerHTML += '<button class="tag-option selected" onclick="toggleTagOption(this,\''+esc(tag)+'\')">'+escapeHtml(tag)+'</button>';
}

function saveTagsAndClose() {
    if (!tagModalLeadId) return;
    var lead = allLeads.find(function(l){ return l._id === tagModalLeadId; });
    if (lead) lead.tags = tagModalTags.slice();
    apiFetch('/leads/'+tagModalLeadId,{method:'PATCH',body:{tags:tagModalTags}}).catch(function(e){ console.error('Lead tags save failed:', e); });
    closeTagModal();
    filterLeads();
}

function removeTag(id, tag) {
    var lead = allLeads.find(function(l){ return l._id === id; });
    if (!lead || !lead.tags) return;
    var idx = lead.tags.indexOf(tag);
    if (idx !== -1) lead.tags.splice(idx,1);
    apiFetch('/leads/'+id,{method:'PATCH',body:{tags:lead.tags}}).catch(function(e){ console.error('Lead tag remove failed:', e); });
    filterLeads();
}

function setReminder(id) {
    var input = document.getElementById('remind-date-'+id);
    if (!input || !input.value) return;
    var reminder = {date:input.value, done:false};
    var lead = allLeads.find(function(l){ return l._id === id; });
    if (lead) lead.reminder = reminder;
    apiFetch('/leads/'+id,{method:'PATCH',body:{reminder:reminder}}).catch(function(e){ console.error('Lead reminder save failed:', e); });
    filterLeads();
}

function dismissReminder(id) {
    var lead = allLeads.find(function(l){ return l._id === id; });
    if (lead && lead.reminder) lead.reminder.done = true;
    apiFetch('/leads/'+id,{method:'PATCH',body:{reminder:{date:lead.reminder.date,done:true}}}).catch(function(e){ console.error('Lead reminder dismiss failed:', e); });
    filterLeads();
    checkReminders();
}

function sendFollowup(id) {
    var lead = allLeads.find(function(l){ return l._id === id; });
    if (!lead || !lead.phone) return;
    var tplSelect = document.getElementById('tpl-'+id);
    var template = tplSelect ? tplSelect.value : 'day1';
    var msg = getFollowupMessage(template, lead);
    var phone = lead.phone.replace(/[^0-9]/g,'');
    if (phone.length === 10) phone = '91'+phone;
    window.open('https://wa.me/'+phone+'?text='+encodeURIComponent(msg), '_blank');
    // Mark as followed up
    apiFetch('/leads/'+id,{method:'PATCH',body:{lastFollowup:{ts:Date.now(),template:template}}}).catch(function(e){ console.error('Lead followup save failed:', e); });
}

function checkReminders() {
    var today = new Date().toISOString().slice(0,10);
    var overdue = allLeads.filter(function(l){
        return l.reminder && l.reminder.date && !l.reminder.done && l.reminder.date <= today;
    });
    var banner = document.getElementById('reminderBanner');
    if (overdue.length === 0) { banner.classList.remove('show'); banner.innerHTML = ''; return; }

    var html = '<div class="reminder-banner-title">Overdue Reminders ('+overdue.length+')</div>';
    overdue.forEach(function(l){
        html += '<div class="reminder-item"><span>'+escapeHtml(l.name||'Unknown')+' — '+escapeHtml(l.reminder.date)+'</span><button class="reminder-dismiss" onclick="dismissReminder(\''+escAttr(l._id)+'\')">Dismiss</button></div>';
    });
    banner.innerHTML = html;
    banner.classList.add('show');

    if ('Notification' in window && Notification.permission === 'granted' && overdue.length > 0) {
        notify('Follow-up Reminder', overdue.length+' lead(s) need follow-up today');
    }
}

setInterval(function(){
    if (allLeads.length > 0) checkReminders();
}, 60000);

function deleteLead(id) {
    if (!confirm('Delete this lead?')) return;
    apiFetch('/leads/'+id,{method:'DELETE'}).then(function(){
        var el = document.querySelector('.lead-item[data-id="'+id+'"]');
        if (el) { el.style.opacity='0'; setTimeout(function(){el.remove()},200); }
        allLeads = allLeads.filter(function(l){ return l._id !== id; });
        document.getElementById('leads-count').textContent = allLeads.length+' total';
        if (allLeads.length === 0) document.getElementById('leads-list').innerHTML = '<div class="empty-state"><div class="empty-state-icon"><svg viewBox="0 0 24 24" width="40" height="40" fill="none" stroke="var(--text-muted)" stroke-width="1.5"><path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="8.5" cy="7" r="4"/><path d="M20 8v6M23 11h-6"/></svg></div><div class="empty-state-title">No leads yet</div><div class="empty-state-desc">Share your card to start capturing contacts.</div><button class="empty-state-btn" onclick="shareCardLink()">Share Your Card</button></div>';
        loadStats();
    }).catch(function(e){ console.error('Lead delete failed:', e); showUpdateToast('Couldn\'t delete lead. Please try again.'); });
}

// ── Edit Lead ──
function openEditModal(id) {
    var lead = allLeads.find(function(l){ return l._id === id; });
    if (!lead) return;
    var ocr = lead.ocrFields || {};
    document.getElementById('editLeadId').value = id;
    document.getElementById('editName').value = lead.name || '';
    document.getElementById('editTitle').value = lead.title || ocr.title || '';
    document.getElementById('editCompany').value = lead.company || '';
    document.getElementById('editPhone').value = lead.phone || '';
    document.getElementById('editEmail').value = lead.email || '';
    document.getElementById('editWebsite').value = ocr.website || lead.website || '';
    document.getElementById('editAddress').value = lead.address || ocr.address || '';
    document.getElementById('editLinkedin').value = ocr.linkedin || '';
    document.getElementById('editInstagram').value = ocr.instagram || '';
    document.getElementById('editTwitter').value = ocr.twitter || '';
    document.getElementById('editModal').classList.add('show');
}

function closeEditModal() {
    document.getElementById('editModal').classList.remove('show');
}

function saveEditedLead() {
    var id = document.getElementById('editLeadId').value;
    var titleVal = document.getElementById('editTitle').value.trim();
    var websiteVal = document.getElementById('editWebsite').value.trim();
    var addressVal = document.getElementById('editAddress').value.trim();
    var linkedinVal = document.getElementById('editLinkedin').value.trim();
    var instagramVal = document.getElementById('editInstagram').value.trim();
    var twitterVal = document.getElementById('editTwitter').value.trim();

    var updates = {
        name: document.getElementById('editName').value.trim(),
        title: titleVal,
        company: document.getElementById('editCompany').value.trim(),
        phone: document.getElementById('editPhone').value.trim(),
        email: document.getElementById('editEmail').value.trim(),
        address: addressVal,
        ocrFields: {
            title: titleVal,
            website: websiteVal,
            address: addressVal,
            linkedin: linkedinVal,
            instagram: instagramVal,
            twitter: twitterVal
        }
    };

    apiFetch('/leads/'+id,{method:'PATCH',body:updates}).then(function(){
        var lead = allLeads.find(function(l){ return l._id === id; });
        if (lead) {
            lead.name = updates.name;
            lead.title = updates.title;
            lead.company = updates.company;
            lead.phone = updates.phone;
            lead.email = updates.email;
            lead.address = updates.address;
            if (!lead.ocrFields) lead.ocrFields = {};
            lead.ocrFields.title = titleVal;
            lead.ocrFields.website = websiteVal;
            lead.ocrFields.address = addressVal;
            lead.ocrFields.linkedin = linkedinVal;
            lead.ocrFields.instagram = instagramVal;
            lead.ocrFields.twitter = twitterVal;
        }
        closeEditModal();
        filterLeads();
    }).catch(function(){});
}

function exportCSV() {
    if (!allLeads.length) { showUpdateToast('No leads to export'); return; }
    var rows = [['Name','Phone','Email','Company','Card','Status','Score','Tags','Notes','Actions','Source','Date']];
    allLeads.forEach(function(l){
        var date = l.ts ? new Date(l.ts).toISOString() : '';
        var actions = (l.actions||[]).map(function(a){return a.action||'view'}).join(', ');
        rows.push([
            '"'+(l.name||'').replace(/"/g,'""')+'"',
            '"'+(l.phone||'')+'"',
            '"'+(l.email||'')+'"',
            '"'+(l.company||'').replace(/"/g,'""')+'"',
            '"'+(NAMES[l.card]||l.card||'')+'"',
            '"'+(STATUS_LABELS[l.status]||'New')+'"',
            (l.score||0),
            '"'+((l.tags||[]).join(', ')).replace(/"/g,'""')+'"',
            '"'+(l.notes||'').replace(/"/g,'""')+'"',
            '"'+actions+'"',
            '"'+(l.source||'nfc')+'"',
            '"'+date+'"'
        ]);
    });
    var csv = rows.map(function(r){return r.join(',')}).join('\n');
    var blob = new Blob([csv],{type:'text/csv;charset=utf-8'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url; a.download = 'leads_'+new Date().toISOString().slice(0,10)+'.csv';
    document.body.appendChild(a); a.click();
    setTimeout(function(){ document.body.removeChild(a); URL.revokeObjectURL(url); },100);
}

function exportJSON() {
    if (!allLeads.length) { showUpdateToast('No leads to export'); return; }
    var data = allLeads.map(function(l){
        return {
            name: l.name||'',
            phone: l.phone||'',
            email: l.email||'',
            company: l.company||'',
            card: NAMES[l.card]||l.card||'',
            status: STATUS_LABELS[l.status]||'New',
            score: l.score||0,
            tags: l.tags||[],
            notes: l.notes||'',
            source: l.source||'nfc',
            date: l.ts ? new Date(l.ts).toISOString() : ''
        };
    });
    var json = JSON.stringify(data, null, 2);
    var blob = new Blob([json],{type:'application/json;charset=utf-8'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url; a.download = 'leads_'+new Date().toISOString().slice(0,10)+'.json';
    document.body.appendChild(a); a.click();
    setTimeout(function(){ document.body.removeChild(a); URL.revokeObjectURL(url); },100);
}

function toggleExportDrop() {
    var drop = document.getElementById('exportDrop');
    if (!drop) return;
    var showing = drop.style.display !== 'none';
    drop.style.display = showing ? 'none' : 'block';
    if (!showing) {
        var close = function(e) { if (!document.getElementById('exportDropWrap').contains(e.target)) { drop.style.display = 'none'; document.removeEventListener('click', close); } };
        setTimeout(function(){ document.addEventListener('click', close); }, 10);
    }
}

function toggleSourceDrop() {
    var drop = document.getElementById('sourceDrop');
    if (!drop) return;
    var showing = drop.style.display !== 'none';
    drop.style.display = showing ? 'none' : 'block';
    if (!showing) {
        var close = function(e) { if (!document.getElementById('sourceDropWrap').contains(e.target)) { drop.style.display = 'none'; document.removeEventListener('click', close); } };
        setTimeout(function(){ document.addEventListener('click', close); }, 10);
    }
}

function toggleLeadsMore() {
    var drop = document.getElementById('leadsMoreDrop');
    if (!drop) return;
    var showing = drop.style.display !== 'none';
    drop.style.display = showing ? 'none' : 'block';
    if (!showing) {
        // Highlight active source filter
        var srcMap = {all:'srcAll',exchange:'srcExchange',scan:'srcScan',tap:'srcTap',manual:'srcManual','import':'srcImport'};
        for (var k in srcMap) {
            var el = document.getElementById(srcMap[k]);
            if (el) el.classList.toggle('active-src', activeSourceFilter === k);
        }
        // Highlight score sort
        var scoreBtn = document.getElementById('scoreSortBtn');
        if (scoreBtn) scoreBtn.classList.toggle('active-src', sortByScore);
        var close = function(e) { if (!document.getElementById('leadsMoreWrap').contains(e.target)) { drop.style.display = 'none'; document.removeEventListener('click', close); } };
        setTimeout(function(){ document.addEventListener('click', close); }, 10);
    }
}

// ── Import Contacts ──
var importedContacts = [];

function startImport() {
    // Try Contact Picker API first (Android Chrome)
    if ('contacts' in navigator && 'ContactsManager' in window) {
        navigator.contacts.select(
            ['name', 'email', 'tel', 'address', 'organization'],
            {multiple: true}
        ).then(function(contacts) {
            if (!contacts || contacts.length === 0) return;
            importedContacts = contacts.map(function(c) {
                return {
                    name: c.name && c.name[0] ? c.name[0] : '',
                    phone: c.tel && c.tel[0] ? c.tel[0] : '',
                    email: c.email && c.email[0] ? c.email[0] : '',
                    company: c.organization && c.organization[0] ? c.organization[0] : '',
                    address: c.address && c.address[0] ? formatAddress(c.address[0]) : '',
                    card: CARD_IDS[0] || ''
                };
            });
            renderImportList();
            document.getElementById('importModal').classList.add('show');
        }).catch(function(err) {
            console.error('Contact picker error:', err);
            document.getElementById('importVcf').click();
        });
    } else {
        // Fallback to VCF file picker
        document.getElementById('importVcf').click();
    }
}

function formatAddress(addr) {
    if (typeof addr === 'string') return addr;
    var parts = [];
    if (addr.streetAddress) parts.push(addr.streetAddress);
    if (addr.locality) parts.push(addr.locality);
    if (addr.region) parts.push(addr.region);
    if (addr.postalCode) parts.push(addr.postalCode);
    if (addr.country) parts.push(addr.country);
    return parts.join(', ');
}

function importFromVcf(input) {
    if (!input.files || !input.files[0]) return;
    var file = input.files[0];
    var reader = new FileReader();
    reader.onload = function(e) {
        var vcf = e.target.result;
        importedContacts = parseVCF(vcf);
        if (importedContacts.length === 0) {
            showUpdateToast('No contacts found in file');
            return;
        }
        renderImportList();
        document.getElementById('importModal').classList.add('show');
    };
    reader.readAsText(file);
    input.value = '';
}

function parseVCF(vcf) {
    var contacts = [];
    var cards = vcf.split('BEGIN:VCARD');
    cards.forEach(function(card) {
        if (!card.trim()) return;
        var contact = {name:'',phone:'',email:'',company:'',address:'',card:CARD_IDS[0]||''};

        // Name
        var fnMatch = card.match(/FN[;:]([^\r\n]+)/i);
        if (fnMatch) contact.name = fnMatch[1].replace(/^[^:]*:/,'').trim();
        if (!contact.name) {
            var nMatch = card.match(/\nN[;:]([^\r\n]+)/i);
            if (nMatch) {
                var parts = nMatch[1].replace(/^[^:]*:/,'').split(';');
                contact.name = ((parts[1]||'')+' '+(parts[0]||'')).trim();
            }
        }

        // Phone
        var telMatch = card.match(/TEL[;:][^\r\n]*?(\+?[\d\s\-()]+)/i);
        if (telMatch) contact.phone = telMatch[1].replace(/[\s\-()]/g,'').trim();

        // Email
        var emailMatch = card.match(/EMAIL[;:]([^\r\n]+)/i);
        if (emailMatch) contact.email = emailMatch[1].replace(/^[^:]*:/,'').trim();

        // Company
        var orgMatch = card.match(/ORG[;:]([^\r\n]+)/i);
        if (orgMatch) contact.company = orgMatch[1].replace(/^[^:]*:/,'').split(';')[0].trim();

        // Address
        var adrMatch = card.match(/ADR[;:]([^\r\n]+)/i);
        if (adrMatch) {
            var adrParts = adrMatch[1].replace(/^[^:]*:/,'').split(';').filter(function(p){return p.trim()});
            contact.address = adrParts.join(', ').trim();
        }

        if (contact.name || contact.phone || contact.email) {
            contacts.push(contact);
        }
    });
    return contacts;
}

function renderImportList() {
    var html = '';
    importedContacts.forEach(function(c, i) {
        html += '<div class="import-item" data-index="'+i+'">';
        html += '<div class="import-item-header"><span class="import-item-name">'+(c.name||'Contact '+(i+1))+'</span>';
        html += '<button class="import-item-remove" onclick="removeImportItem('+i+')">Remove</button></div>';
        html += '<div class="import-field"><label>Name</label><input type="text" value="'+esc(c.name)+'" onchange="updateImportField('+i+',\'name\',this.value)"></div>';
        html += '<div class="import-field"><label>Phone</label><input type="tel" value="'+esc(c.phone)+'" onchange="updateImportField('+i+',\'phone\',this.value)"></div>';
        html += '<div class="import-field"><label>Email</label><input type="email" value="'+esc(c.email)+'" onchange="updateImportField('+i+',\'email\',this.value)"></div>';
        html += '<div class="import-field"><label>Company</label><input type="text" value="'+esc(c.company)+'" onchange="updateImportField('+i+',\'company\',this.value)"></div>';
        html += '<div class="import-field"><label>Address</label><input type="text" value="'+esc(c.address)+'" onchange="updateImportField('+i+',\'address\',this.value)"></div>';
        html += '<div class="import-field"><label>Assign to Card</label><select class="import-card-select" onchange="updateImportField('+i+',\'card\',this.value)">';
        CARD_IDS.forEach(function(cid) {
            html += '<option value="'+cid+'"'+(c.card===cid?' selected':'')+'>'+escapeHtml(CARDS[cid].company||CARDS[cid].name)+'</option>';
        });
        html += '</select></div></div>';
    });
    document.getElementById('importList').innerHTML = html;
    document.getElementById('importCount').textContent = importedContacts.length + ' contacts';
}

function updateImportField(index, field, value) {
    if (importedContacts[index]) {
        importedContacts[index][field] = value;
        if (field === 'name') {
            document.querySelector('.import-item[data-index="'+index+'"] .import-item-name').textContent = value || 'Contact '+(index+1);
        }
    }
}

function removeImportItem(index) {
    importedContacts.splice(index, 1);
    renderImportList();
    if (importedContacts.length === 0) closeImportModal();
}

function closeImportModal() {
    document.getElementById('importModal').classList.remove('show');
    importedContacts = [];
}

function saveAllImported() {
    if (importedContacts.length === 0) return;
    var saved = 0;
    var validContacts = importedContacts.filter(function(c) {
        return c.name || c.phone || c.email;
    });
    var total = validContacts.length;
    if (total === 0) { closeImportModal(); return; }

    validContacts.forEach(function(c) {
        var id = Date.now().toString(36) + Math.random().toString(36).substr(2,5);
        var lead = {
            name: c.name,
            phone: c.phone,
            email: c.email,
            company: c.company,
            address: c.address,
            card: c.card,
            status: 'new',
            tags: [],
            source: 'import',
            ts: Date.now()
        };
        apiFetch('/leads/'+id,{method:'PUT',body:lead}).then(function(){
            saved++;
            if (saved === total) {
                closeImportModal();
                showLeads(); // Refresh leads list
            }
        }).catch(function(){});
    });
}

function hideLeads() {
    navigateTo('dashboard');
}

// ── Analytics Dashboard ──
function showAnalytics() {
    navigateTo('analytics');
}

function hideAnalytics() {
    navigateTo('dashboard');
}

function loadAnalyticsData() {
    Promise.all([
        apiFetch('/analytics').then(function(r){return r.json()}),
        apiFetch('/leads').then(function(r){return r.json()})
    ]).then(function(results) {
        var analytics = results[0] || {};
        var leads = results[1] || {};
        renderAnalytics(analytics, leads);
    }).catch(function(){
        document.getElementById('analyticsContent').innerHTML = '<div class="leads-empty">Failed to load analytics</div>';
    });
}

var analyticsRangeData = null;
var analyticsLeadsData = null;

function renderAnalytics(analytics, leads) {
    analyticsRangeData = analytics;
    analyticsLeadsData = leads;
    renderAnalyticsForRange(7);
}

function renderAnalyticsForRange(rangeDays) {
    var analytics = analyticsRangeData;
    var leads = analyticsLeadsData;
    if (!analytics || !leads) return;

    var now = Date.now();
    var rangeMs = rangeDays * 86400000;
    var cutoff = now - rangeMs;

    var totalViews = 0, totalClicks = 0, totalLeads = 0, totalSaves = 0;
    var sourceCount = {nfc:0,qr:0,link:0,timeout:0};
    var clickCount = {call:0,email:0,whatsapp:0,linkedin:0,instagram:0,twitter:0,save_contact:0,website:0};
    var cardViews = {};
    var cardClicks = {};
    var cardLeads = {};
    var dailyViews = {};
    var dayOfWeekViews = [0,0,0,0,0,0,0];

    for (var k in leads) {
        if (leads[k] && leads[k].ts && leads[k].ts >= cutoff) totalLeads++;
    }

    CARD_IDS.forEach(function(cid) {
        var cardData = analytics[cid] || {};
        cardViews[cid] = 0;
        cardClicks[cid] = 0;
        cardLeads[cid] = 0;

        var views = Array.isArray(cardData.views) ? cardData.views : [];
        views.forEach(function(v) {
            if (v.ts && v.ts < cutoff) return;
            totalViews++;
            cardViews[cid]++;
            if (v.source && sourceCount.hasOwnProperty(v.source)) sourceCount[v.source]++;
            if (v.ts) {
                var day = new Date(v.ts).toISOString().slice(0,10);
                dailyViews[day] = (dailyViews[day]||0) + 1;
                dayOfWeekViews[new Date(v.ts).getDay()]++;
            }
        });

        var clicks = Array.isArray(cardData.clicks) ? cardData.clicks : [];
        clicks.forEach(function(cl) {
            if (cl.ts && cl.ts < cutoff) return;
            totalClicks++;
            cardClicks[cid]++;
            if (cl.action && clickCount.hasOwnProperty(cl.action)) clickCount[cl.action]++;
            if (cl.action === 'save_contact') totalSaves++;
        });
    });

    for (var lk in leads) {
        var lead = leads[lk];
        if (lead && lead.ts && lead.ts >= cutoff && lead.card) {
            cardLeads[lead.card] = (cardLeads[lead.card]||0) + 1;
        }
    }

    var convRate = totalViews > 0 ? Math.round((totalLeads/totalViews)*100) : 0;

    var dayNames = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
    var bestDayIdx = 0;
    dayOfWeekViews.forEach(function(v, i){ if (v > dayOfWeekViews[bestDayIdx]) bestDayIdx = i; });

    var topSource = 'NFC', topSourceVal = sourceCount.nfc;
    if (sourceCount.qr > topSourceVal) { topSource = 'QR Code'; topSourceVal = sourceCount.qr; }
    if (sourceCount.link > topSourceVal) { topSource = 'Direct Link'; topSourceVal = sourceCount.link; }

    var html = '';

    // Time range selector
    html += '<div style="display:flex;gap:6px;margin-bottom:16px">';
    [7,30,90].forEach(function(d) {
        var active = d === rangeDays;
        html += '<button onclick="renderAnalyticsForRange('+d+')" style="padding:7px 16px;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;border:1px solid '+(active?'var(--accent)':'var(--border)')+';background:'+(active?'rgba(99,102,241,.15)':'transparent')+';color:'+(active?'var(--accent-light)':'var(--text-muted)')+'">'+d+'d</button>';
    });
    html += '</div>';

    html += '<div class="analytics-grid">';
    html += '<div class="analytics-card"><div class="ac-num">'+totalViews+'</div><div class="ac-label">Views</div></div>';
    html += '<div class="analytics-card"><div class="ac-num">'+totalClicks+'</div><div class="ac-label">Clicks</div></div>';
    html += '<div class="analytics-card"><div class="ac-num">'+totalLeads+'</div><div class="ac-label">Leads</div></div>';
    html += '<div class="analytics-card"><div class="ac-num">'+convRate+'%</div><div class="ac-label">Conversion</div></div>';
    html += '</div>';

    var isFree = getUserPlan() === 'free';

    if (isFree) {
        html += '<div style="position:relative;margin-top:16px">';
        html += '<div style="filter:blur(5px);pointer-events:none;opacity:.5;user-select:none">';
        html += '<div class="chart-container"><canvas width="400" height="180"></canvas></div>';
        html += '<div class="analytics-section"><h3>Views by Source</h3>';
        html += makeBar('NFC', 42, 42, '#60a5fa');
        html += makeBar('QR Code', 28, 42, '#a78bfa');
        html += makeBar('Direct Link', 15, 42, '#34d399');
        html += '</div>';
        html += '</div>';
        html += '<div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(15,15,26,.6);border-radius:12px">';
        html += '<div style="width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,#6366f1,#8b5cf6);display:flex;align-items:center;justify-content:center;margin-bottom:12px"><svg width="24" height="24" viewBox="0 0 24 24" fill="#fff"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1s3.1 1.39 3.1 3.1v2z"/></svg></div>';
        html += '<div style="font-size:16px;font-weight:700;color:#fff;margin-bottom:4px">Unlock Full Analytics</div>';
        html += '<div style="font-size:13px;color:rgba(255,255,255,.5);margin-bottom:16px;text-align:center;max-width:260px">See charts, insights, and card performance with Pro.</div>';
        html += '<button onclick="showUpgradeModal(\'Upgrade for full analytics — charts, insights, and card performance.\')" style="background:#6366f1;color:#fff;border:none;padding:10px 24px;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer">Upgrade to Pro</button>';
        html += '</div></div>';
    } else {
        // Views chart
        html += '<div class="chart-container"><div style="font-size:13px;font-weight:600;color:var(--text-secondary);margin-bottom:10px">Views — Last '+rangeDays+' days</div><canvas id="viewsChart" width="400" height="180"></canvas></div>';

        // Engagement funnel
        var funnelSteps = [
            {label:'Views', value:totalViews, color:'#60a5fa'},
            {label:'Clicks', value:totalClicks, color:'#a78bfa'},
            {label:'Leads', value:totalLeads, color:'#4ade80'},
            {label:'Saved', value:totalSaves, color:'#f472b6'}
        ];
        var maxFunnel = Math.max(totalViews, 1);
        html += '<div class="analytics-section"><h3>Engagement Funnel</h3>';
        html += '<div style="display:flex;flex-direction:column;gap:8px">';
        funnelSteps.forEach(function(step, idx) {
            var pct = Math.round((step.value / maxFunnel) * 100);
            var convPct = idx > 0 && funnelSteps[idx-1].value > 0 ? Math.round((step.value / funnelSteps[idx-1].value) * 100) : 100;
            html += '<div style="display:flex;align-items:center;gap:10px">';
            html += '<span style="font-size:12px;color:var(--text-muted);width:50px;flex-shrink:0">'+step.label+'</span>';
            html += '<div style="flex:1;height:28px;background:rgba(255,255,255,.04);border-radius:8px;overflow:hidden;position:relative">';
            html += '<div style="height:100%;width:'+pct+'%;background:'+step.color+';border-radius:8px;transition:width .5s ease;min-width:2px"></div>';
            html += '<span style="position:absolute;right:10px;top:50%;transform:translateY(-50%);font-size:12px;font-weight:600;color:var(--text-primary)">'+step.value+'</span>';
            html += '</div>';
            if (idx > 0) html += '<span style="font-size:11px;color:var(--text-muted);width:36px;flex-shrink:0;text-align:right">'+convPct+'%</span>';
            else html += '<span style="width:36px;flex-shrink:0"></span>';
            html += '</div>';
        });
        html += '</div></div>';

        // Insights
        html += '<div class="analytics-section"><h3>Insights</h3>';
        html += '<div style="display:flex;flex-direction:column;gap:8px">';
        if (totalViews > 0) {
            html += '<div style="display:flex;align-items:center;gap:10px;padding:12px 14px;background:rgba(255,255,255,.04);border-radius:12px;font-size:13px;color:var(--text-secondary)"><svg viewBox="0 0 24 24" width="18" height="18" fill="#60a5fa"><path d="M9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm2-7h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2z"/></svg>Best day: <strong style="color:var(--text-primary);margin-left:2px">'+dayNames[bestDayIdx]+'</strong></div>';
            html += '<div style="display:flex;align-items:center;gap:10px;padding:12px 14px;background:rgba(255,255,255,.04);border-radius:12px;font-size:13px;color:var(--text-secondary)"><svg viewBox="0 0 24 24" width="18" height="18" fill="#a78bfa"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/></svg>Top source: <strong style="color:var(--text-primary);margin-left:2px">'+topSource+'</strong></div>';
        }
        if (convRate > 0) {
            html += '<div style="display:flex;align-items:center;gap:10px;padding:12px 14px;background:rgba(255,255,255,.04);border-radius:12px;font-size:13px;color:var(--text-secondary)"><svg viewBox="0 0 24 24" width="18" height="18" fill="#4ade80"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"/></svg>'+convRate+'% of visitors become leads</div>';
        }
        if (totalViews === 0) {
            html += '<div style="padding:12px 14px;background:rgba(255,255,255,.04);border-radius:12px;font-size:13px;color:var(--text-muted)">Share your card to start seeing insights here.</div>';
        }
        html += '</div></div>';

        // Views by source
        html += '<div class="analytics-section"><h3>Views by Source</h3>';
        var maxSource = Math.max(sourceCount.nfc, sourceCount.qr, sourceCount.link, 1);
        html += makeBar('NFC', sourceCount.nfc, maxSource, '#60a5fa');
        html += makeBar('QR Code', sourceCount.qr, maxSource, '#a78bfa');
        html += makeBar('Direct Link', sourceCount.link, maxSource, '#34d399');
        if (sourceCount.timeout > 0) html += makeBar('Timeout', sourceCount.timeout, maxSource, '#fb923c');
        html += '</div>';

        // Click breakdown
        html += '<div class="analytics-section"><h3>Click Breakdown</h3>';
        var actions = ['call','whatsapp','email','website','linkedin','save_contact'];
        var actionLabels = {call:'Call',whatsapp:'WhatsApp',email:'Email',website:'Website',linkedin:'LinkedIn',save_contact:'Save Contact'};
        var maxClick = Math.max.apply(null, actions.map(function(a){return clickCount[a]||0}).concat([1]));
        var actionColors = {call:'#60a5fa',whatsapp:'#4ade80',email:'#fbbf24',website:'#a78bfa',linkedin:'#38bdf8',save_contact:'#f472b6'};
        actions.forEach(function(a){
            if (clickCount[a] > 0) html += makeBar(actionLabels[a], clickCount[a]||0, maxClick, actionColors[a]||'#60a5fa');
        });
        if (totalClicks === 0) html += '<div style="font-size:13px;color:var(--text-muted);padding:8px 0">No clicks recorded yet.</div>';
        html += '</div>';

        // Card performance
        if (CARD_IDS.length > 1) {
            html += '<div class="analytics-section"><h3>Card Comparison</h3>';
            var bestCardId = CARD_IDS[0];
            CARD_IDS.forEach(function(cid){ if ((cardViews[cid]||0) > (cardViews[bestCardId]||0)) bestCardId = cid; });
            var secondBest = CARD_IDS.filter(function(c){return c!==bestCardId})[0];
            var bestRatio = secondBest && (cardViews[secondBest]||0) > 0 ? Math.round((cardViews[bestCardId]||0) / (cardViews[secondBest]||1)) : 0;
            if (bestRatio > 1) {
                html += '<div style="padding:10px 14px;background:rgba(99,102,241,.08);border:1px solid rgba(99,102,241,.15);border-radius:10px;font-size:13px;color:var(--accent-light);margin-bottom:12px">Your best card is <strong>'+escapeHtml(NAMES[bestCardId])+'</strong> with '+bestRatio+'x more views</div>';
            }
            CARD_IDS.forEach(function(cid){
                html += '<div class="card-perf-item"><span class="card-perf-name" style="color:'+sanitizeColor(CARD_COLORS[cid])+'">'+escapeHtml(NAMES[cid])+'</span><span class="card-perf-stats">'+
                    (cardViews[cid]||0)+' views · '+(cardClicks[cid]||0)+' clicks · '+(cardLeads[cid]||0)+' leads</span></div>';
            });
            html += '</div>';
        } else if (CARD_IDS.length === 1) {
            html += '<div class="analytics-section"><h3>Card Performance</h3>';
            CARD_IDS.forEach(function(cid){
                html += '<div class="card-perf-item"><span class="card-perf-name" style="color:'+sanitizeColor(CARD_COLORS[cid])+'">'+escapeHtml(NAMES[cid])+'</span><span class="card-perf-stats">'+
                    (cardViews[cid]||0)+' views · '+(cardClicks[cid]||0)+' clicks · '+(cardLeads[cid]||0)+' leads</span></div>';
            });
            html += '</div>';
        }
    }

    document.getElementById('analyticsContent').innerHTML = html;
    if (!isFree) setTimeout(function(){ drawDailyChart(dailyViews, rangeDays); }, 50);
}

function makeBar(label, count, max, color) {
    var pct = max > 0 ? Math.round((count/max)*100) : 0;
    return '<div class="analytics-bar"><span class="ab-label">'+label+'</span><div class="ab-track"><div class="ab-fill" style="width:'+pct+'%;background:'+color+'"></div></div><span class="ab-count">'+count+'</span></div>';
}

function drawDailyChart(dailyViews, rangeDays) {
    var canvas = document.getElementById('viewsChart');
    if (!canvas) return;
    var ctx = canvas.getContext('2d');
    var w = canvas.parentElement.clientWidth - 40;
    canvas.width = w * 2;
    canvas.height = 180 * 2;
    canvas.style.width = w + 'px';
    canvas.style.height = '180px';
    ctx.scale(2,2);

    var numDays = rangeDays || 7;
    // For 30/90 days, aggregate into buckets to keep chart readable
    var bucketSize = numDays <= 7 ? 1 : numDays <= 30 ? 1 : 3;
    var numPoints = Math.ceil(numDays / bucketSize);

    var labels = [];
    var values = [];
    for (var i = numPoints - 1; i >= 0; i--) {
        var bucketSum = 0;
        var bucketDate;
        for (var b = 0; b < bucketSize; b++) {
            var dayOffset = i * bucketSize + b;
            var d = new Date();
            d.setDate(d.getDate() - dayOffset);
            var key = d.toISOString().slice(0,10);
            bucketSum += (dailyViews[key] || 0);
            if (b === 0) bucketDate = d;
        }
        labels.push(bucketDate.toLocaleDateString('en-IN',{day:'numeric',month:'short'}));
        values.push(bucketSum);
    }

    var maxVal = Math.max.apply(null, values.concat([1]));
    var chartW = w - 50;
    var chartH = 140;
    var startX = 40;
    var startY = 10;

    ctx.strokeStyle = 'rgba(255,255,255,0.06)';
    ctx.lineWidth = 0.5;
    for (var g = 0; g <= 4; g++) {
        var gy = startY + chartH - (g/4)*chartH;
        ctx.beginPath();
        ctx.moveTo(startX, gy);
        ctx.lineTo(startX + chartW, gy);
        ctx.stroke();
    }

    ctx.fillStyle = 'rgba(255,255,255,0.3)';
    ctx.font = '10px Inter';
    ctx.textAlign = 'right';
    for (var g = 0; g <= 4; g++) {
        var val = Math.round((g/4)*maxVal);
        var gy = startY + chartH - (g/4)*chartH;
        ctx.fillText(val, startX - 8, gy + 3);
    }

    var barW = chartW / numPoints;
    ctx.beginPath();
    var points = [];
    for (var i = 0; i < numPoints; i++) {
        var x = startX + barW * i + barW/2;
        var y = startY + chartH - (values[i]/maxVal)*chartH;
        points.push({x:x,y:y});
        if (i === 0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
    }
    ctx.strokeStyle = '#60a5fa';
    ctx.lineWidth = 2;
    ctx.stroke();

    ctx.lineTo(points[points.length-1].x, startY + chartH);
    ctx.lineTo(points[0].x, startY + chartH);
    ctx.closePath();
    var gradient = ctx.createLinearGradient(0, startY, 0, startY + chartH);
    gradient.addColorStop(0, 'rgba(96,165,250,0.2)');
    gradient.addColorStop(1, 'rgba(96,165,250,0)');
    ctx.fillStyle = gradient;
    ctx.fill();

    points.forEach(function(p){
        ctx.beginPath();
        ctx.arc(p.x, p.y, 3, 0, Math.PI*2);
        ctx.fillStyle = '#60a5fa';
        ctx.fill();
    });

    // Show labels — skip some for readability on longer ranges
    var labelSkip = numPoints > 14 ? Math.ceil(numPoints / 7) : (numPoints > 7 ? 2 : 1);
    ctx.fillStyle = 'rgba(255,255,255,0.35)';
    ctx.font = '10px Inter';
    ctx.textAlign = 'center';
    for (var i = 0; i < numPoints; i++) {
        if (i % labelSkip === 0 || i === numPoints - 1) {
            ctx.fillText(labels[i], startX + barW*i + barW/2, startY + chartH + 18);
        }
    }
}

// ── Storage Dashboard ──
function showStorage() {
    navigateTo('settings');
    setTimeout(function() {
        var el = document.getElementById('settingsStorageSection');
        if (el) el.scrollIntoView({behavior: 'smooth'});
    }, 100);
    loadStorageData();
}

function hideStorage() {
    navigateTo('dashboard');
}

function loadStorageData() {
    // Fetch all data to calculate size
    Promise.all([
        apiFetch('/leads').then(function(r){return r.text()}),
        apiFetch('/taps').then(function(r){return r.text()}),
        apiFetch('/analytics').then(function(r){return r.text()}),
        apiFetch('/settings').then(function(r){return r.text()}),
        apiFetch('/auth/me').then(function(r){return r.text()})
    ]).then(function(results) {
        var leadsData = results[0] || '{}';
        var tapsData = results[1] || '{}';
        var analyticsData = results[2] || '{}';
        var settingsData = results[3] || '{}';
        var latestData = results[4] || '{}';

        // Calculate sizes in bytes
        var leadsSize = new Blob([leadsData]).size;
        var tapsSize = new Blob([tapsData]).size;
        var analyticsSize = new Blob([analyticsData]).size;
        var settingsSize = new Blob([settingsData]).size;
        var latestSize = new Blob([latestData]).size;
        var totalSize = leadsSize + tapsSize + analyticsSize + settingsSize + latestSize;

        // Count records
        var leads = JSON.parse(leadsData) || {};
        var taps = JSON.parse(tapsData) || {};
        var leadsCount = Object.keys(leads).length;
        var tapsCount = Object.keys(taps).length;

        // Firebase free tier: 1 GB storage, 10 GB/month download
        var freeStorageLimit = 1024 * 1024 * 1024; // 1 GB
        var freeDownloadLimit = 10 * 1024 * 1024 * 1024; // 10 GB
        var storagePercent = (totalSize / freeStorageLimit) * 100;

        // Estimated monthly downloads (rough: assume 100 page loads * total data)
        var estimatedMonthlyDownload = totalSize * 100;
        var downloadPercent = (estimatedMonthlyDownload / freeDownloadLimit) * 100;

        // Cost calculation (Blaze plan: $5/GB stored, $1/GB downloaded beyond free tier)
        var storageCost = totalSize > freeStorageLimit ? ((totalSize - freeStorageLimit) / (1024*1024*1024)) * 5 : 0;
        var downloadCost = estimatedMonthlyDownload > freeDownloadLimit ? ((estimatedMonthlyDownload - freeDownloadLimit) / (1024*1024*1024)) * 1 : 0;
        var totalCost = storageCost + downloadCost;

        renderStorage({
            leadsSize: leadsSize,
            tapsSize: tapsSize,
            analyticsSize: analyticsSize,
            settingsSize: settingsSize,
            totalSize: totalSize,
            leadsCount: leadsCount,
            tapsCount: tapsCount,
            storagePercent: storagePercent,
            downloadPercent: downloadPercent,
            estimatedMonthlyDownload: estimatedMonthlyDownload,
            storageCost: storageCost,
            downloadCost: downloadCost,
            totalCost: totalCost,
            freeStorageLimit: freeStorageLimit,
            freeDownloadLimit: freeDownloadLimit
        });
    }).catch(function(err){
        document.getElementById('storageContent').innerHTML = '<div class="leads-empty">Failed to load storage data</div>';
    });
}

function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    var k = 1024;
    var sizes = ['B', 'KB', 'MB', 'GB'];
    var i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function renderStorage(data) {
    var html = '';

    // Storage Overview
    html += '<div class="storage-card"><h4>Storage Used</h4>';
    html += '<div class="storage-row"><span class="storage-label">Leads data</span><span class="storage-value">'+formatBytes(data.leadsSize)+'</span></div>';
    html += '<div class="storage-row"><span class="storage-label">Tap sessions</span><span class="storage-value">'+formatBytes(data.tapsSize)+'</span></div>';
    html += '<div class="storage-row"><span class="storage-label">Analytics</span><span class="storage-value">'+formatBytes(data.analyticsSize)+'</span></div>';
    html += '<div class="storage-row"><span class="storage-label">Settings</span><span class="storage-value">'+formatBytes(data.settingsSize)+'</span></div>';
    html += '<div class="storage-row" style="border-top:1px solid rgba(255,255,255,.1);padding-top:12px;margin-top:8px"><span class="storage-label" style="font-weight:600;color:rgba(255,255,255,.7)">Total</span><span class="storage-value" style="color:#2dd4bf">'+formatBytes(data.totalSize)+'</span></div>';
    html += '</div>';

    // Records Count
    html += '<div class="storage-card"><h4>Records</h4>';
    html += '<div class="storage-row"><span class="storage-label">Total leads</span><span class="storage-value">'+data.leadsCount+'</span></div>';
    html += '<div class="storage-row"><span class="storage-label">Total tap sessions</span><span class="storage-value">'+data.tapsCount+'</span></div>';
    html += '</div>';

    // Free Tier Usage
    html += '<div class="storage-card"><h4>Free Tier Usage</h4>';
    html += '<div class="storage-bar"><div class="storage-bar-track"><div class="storage-bar-fill" style="width:'+Math.min(data.storagePercent, 100)+'%"></div></div>';
    html += '<div class="storage-bar-label"><span>Storage: '+formatBytes(data.totalSize)+' / 1 GB</span><span>'+data.storagePercent.toFixed(4)+'%</span></div></div>';
    html += '<div class="storage-bar" style="margin-top:16px"><div class="storage-bar-track"><div class="storage-bar-fill" style="width:'+Math.min(data.downloadPercent, 100)+'%"></div></div>';
    html += '<div class="storage-bar-label"><span>Est. downloads: '+formatBytes(data.estimatedMonthlyDownload)+' / 10 GB</span><span>'+data.downloadPercent.toFixed(4)+'%</span></div></div>';
    html += '</div>';

    // Cost Estimate
    html += '<div class="storage-card"><h4>Estimated Monthly Cost</h4>';
    if (data.totalCost === 0) {
        html += '<div class="storage-row"><span class="storage-label">Status</span><span class="storage-value cost-free">Within free tier</span></div>';
        html += '<div class="storage-row"><span class="storage-label">Monthly cost</span><span class="storage-value cost-free">$0.00</span></div>';
    } else {
        html += '<div class="storage-row"><span class="storage-label">Storage overage</span><span class="storage-value cost-paid">$'+data.storageCost.toFixed(2)+'</span></div>';
        html += '<div class="storage-row"><span class="storage-label">Download overage</span><span class="storage-value cost-paid">$'+data.downloadCost.toFixed(2)+'</span></div>';
        html += '<div class="storage-row"><span class="storage-label">Total</span><span class="storage-value cost-paid">$'+data.totalCost.toFixed(2)+'/mo</span></div>';
    }
    html += '</div>';

    // Info Note
    html += '<p class="storage-note">Firebase Spark (free) plan includes 1 GB storage and 10 GB/month downloads. Blaze plan charges $5/GB stored and $1/GB downloaded beyond free limits. Download estimate assumes ~100 page loads/month.</p>';

    document.getElementById('storageContent').innerHTML = html;
}

// ── Review Queue ──
var reviewItems = [];

function checkReviewQueue() {
    if (!currentUser) return;
    // Use cached leads if available, otherwise fetch
    var updateBadge = function(data) {
        var count = 0;
        if (data) {
            for (var k in data) {
                var l = data[k];
                if (l && l.needsReview && l.cardImage) {
                    count++;
                }
            }
        }
        var badge = document.getElementById('reviewBadge');
        if (badge) {
            if (count > 0) {
                badge.textContent = count;
                badge.classList.add('show');
            } else {
                badge.classList.remove('show');
            }
        }
    };
    if (cachedLeads) {
        updateBadge(cachedLeads);
    } else {
        apiFetch('/leads').then(function(r){return r.json()}).then(function(data) {
            cachedLeads = data;
            updateBadge(data);
        }).catch(function(){});
    }
}

function showReviewQueue() {
    navigateTo('settings');
    setTimeout(function() {
        var el = document.getElementById('settingsReviewSection');
        if (el) el.scrollIntoView({behavior: 'smooth'});
    }, 100);
    loadReviewItems();
}

function hideReviewQueue() {
    navigateTo('dashboard');
    checkReviewQueue();
}

function loadReviewItems() {
    apiFetch('/leads').then(function(r){return r.json()}).then(function(data) {
        if (!data) { reviewItems = []; renderReviewItems(); return; }

        var items = [];
        for (var k in data) {
            var l = data[k];
            if (l && l.needsReview && l.cardImage) {
                l._id = k;
                items.push(l);
            }
        }
        items.sort(function(a,b){ return (b.ts||0)-(a.ts||0); });
        reviewItems = items;
        renderReviewItems();
    }).catch(function(){
        document.getElementById('reviewList').innerHTML = '<div class="leads-empty">Failed to load</div>';
    });
}

function renderReviewItems() {
    var list = document.getElementById('reviewList');
    document.getElementById('reviewCount').textContent = reviewItems.length + ' pending';

    if (reviewItems.length === 0) {
        list.innerHTML = '<div class="leads-empty">No cards to review</div>';
        return;
    }

    var html = '';
    reviewItems.forEach(function(item, idx) {
        var timeStr = item.ts ? new Date(item.ts).toLocaleString('en-IN', {day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'}) : '';

        html += '<div class="review-item" data-id="'+item._id+'" data-idx="'+idx+'">';
        html += '<div class="review-time">'+timeStr+' · '+(item.visitor?item.visitor.device:'Unknown')+'</div>';
        html += '<img class="review-img" src="'+escapeHtml(item.cardImage || '')+'" id="reviewImg'+idx+'">';
        html += '<button class="review-ocr-btn" onclick="runOCR('+idx+')" id="ocrBtn'+idx+'"><svg viewBox="0 0 24 24"><path d="M9.5 6.5v3h-3v-3h3M11 5H5v6h6V5zm-1.5 9.5v3h-3v-3h3M11 13H5v6h6v-6zm6.5-6.5v3h-3v-3h3M19 5h-6v6h6V5z"/></svg>Extract text with OCR</button>';
        html += '<div class="review-field"><label>Name</label><input type="text" id="revName'+idx+'" placeholder="Full name"></div>';
        html += '<div class="review-field"><label>Phone</label><input type="tel" id="revPhone'+idx+'" placeholder="Phone number"></div>';
        html += '<div class="review-field"><label>Email</label><input type="email" id="revEmail'+idx+'" placeholder="Email address"></div>';
        html += '<div class="review-field"><label>Company</label><input type="text" id="revCompany'+idx+'" placeholder="Company name"></div>';
        html += '<div class="review-field"><label>Address</label><textarea id="revAddress'+idx+'" placeholder="Address (optional)" rows="2"></textarea></div>';
        html += '<div class="review-actions">';
        html += '<button class="review-save" onclick="saveReview('+idx+')">Save Lead</button>';
        html += '<button class="review-skip" onclick="skipReview('+idx+')">Skip</button>';
        html += '</div></div>';
    });
    list.innerHTML = html;
}

// Lazy-load Tesseract.js only when OCR is first needed
var _tesseractLoaded = (typeof Tesseract !== 'undefined');
function loadTesseract() {
    if (_tesseractLoaded) return Promise.resolve();
    return new Promise(function(resolve, reject) {
        var s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js';
        s.onload = function() { _tesseractLoaded = true; resolve(); };
        s.onerror = function() { reject(new Error('Failed to load OCR library')); };
        document.head.appendChild(s);
    });
}

function runOCR(idx) {
    var item = reviewItems[idx];
    if (!item) return;

    var btn = document.getElementById('ocrBtn'+idx);
    btn.classList.add('scanning');
    btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M9.5 6.5v3h-3v-3h3M11 5H5v6h6V5zm-1.5 9.5v3h-3v-3h3M11 13H5v6h6v-6zm6.5-6.5v3h-3v-3h3M19 5h-6v6h6V5z"/></svg>Scanning...';

    // Try server-side OCR first (LLM-powered), fall back to client-side Tesseract
    apiFetch('/ocr/scan-card', { method: 'POST', body: { image: item.cardImage } })
        .then(function(r) {
            if (!r.ok) throw new Error('Server OCR failed');
            return r.json();
        })
        .then(function(data) {
            // Server returns { fields, rawText, method } — use rawText for parseAndFillReview
            parseAndFillReview(idx, data.rawText || '');
            // Also overwrite fields if LLM provided better results
            if (data.fields) {
                var f = data.fields;
                if (f.email) document.getElementById('revEmail'+idx).value = f.email;
                if (f.phone) document.getElementById('revPhone'+idx).value = f.phone;
                if (f.name) document.getElementById('revName'+idx).value = f.name;
                if (f.company) document.getElementById('revCompany'+idx).value = f.company;
            }
            btn.classList.remove('scanning');
            btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>Done! Edit below.';
        })
        .catch(function() {
            // Fallback to client-side Tesseract
            loadTesseract().then(function() {
                btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M9.5 6.5v3h-3v-3h3M11 5H5v6h6V5zm-1.5 9.5v3h-3v-3h3M11 13H5v6h6v-6zm6.5-6.5v3h-3v-3h3M19 5h-6v6h6V5z"/></svg>Scanning locally...';
                Tesseract.recognize(item.cardImage, 'eng').then(function(result) {
                    parseAndFillReview(idx, result.data.text);
                    btn.classList.remove('scanning');
                    btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>Done! Edit below.';
                }).catch(function() {
                    btn.classList.remove('scanning');
                    btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M9.5 6.5v3h-3v-3h3M11 5H5v6h6V5z"/></svg>OCR failed - fill manually';
                });
            }).catch(function() {
                btn.classList.remove('scanning');
                btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M9.5 6.5v3h-3v-3h3M11 5H5v6h6V5z"/></svg>OCR unavailable';
            });
        });
}

function parseAndFillReview(idx, text) {
    var lines = text.split('\n').map(function(l){ return l.trim(); }).filter(function(l){ return l.length > 0; });
    var fullText = text.replace(/\n/g, ' ');

    // Extract email
    var emailMatch = fullText.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/);
    if (emailMatch) {
        document.getElementById('revEmail'+idx).value = emailMatch[0].toLowerCase();
    }

    // Extract phone - try multiple patterns
    var phonePatterns = [
        /(?:\+?91[-.\s]?)?[6-9]\d{9}/,
        /(?:\+?1[-.\s]?)?\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}/,
        /(?:\+?\d{1,3}[-.\s]?)?\d{2,4}[-.\s]?\d{3,4}[-.\s]?\d{3,4}/
    ];
    for (var i = 0; i < phonePatterns.length; i++) {
        var phoneMatch = fullText.match(phonePatterns[i]);
        if (phoneMatch) {
            var phone = phoneMatch[0].replace(/[^\d+]/g, '');
            if (phone.length >= 10) {
                document.getElementById('revPhone'+idx).value = phoneMatch[0].trim();
                break;
            }
        }
    }

    // Company keywords (prioritized)
    var companyKeywords = ['pvt','ltd','llc','inc','corp','limited','private','company','solutions','technologies','services','group','enterprises','industries','exports','imports','trading','consulting','associates','partners','infra','infrastructure','developers','builders','realty','real estate','properties'];
    var companyFound = '';

    // First pass: Look for lines with company keywords
    for (var i = 0; i < lines.length; i++) {
        var line = lines[i];
        var lower = line.toLowerCase();
        if (line.indexOf('@') !== -1) continue;
        if (lower.indexOf('www') !== -1) continue;
        var hasCompanyWord = companyKeywords.some(function(w){ return lower.indexOf(w) !== -1; });
        if (hasCompanyWord && line.length > 3 && line.length < 60) {
            companyFound = line;
            break;
        }
    }

    // Second pass: If no company found, look for ALL CAPS lines (common for company names)
    if (!companyFound) {
        for (var i = 0; i < Math.min(lines.length, 8); i++) {
            var line = lines[i];
            if (line.indexOf('@') !== -1) continue;
            if (/\d{5,}/.test(line)) continue;
            // Check if mostly uppercase
            var upperCount = (line.match(/[A-Z]/g) || []).length;
            var letterCount = (line.match(/[a-zA-Z]/g) || []).length;
            if (letterCount > 4 && upperCount / letterCount > 0.7 && line.length > 5 && line.length < 50) {
                companyFound = line;
                break;
            }
        }
    }

    if (companyFound) {
        document.getElementById('revCompany'+idx).value = companyFound;
    }

    // Extract name - look for proper case names (not all caps, not company)
    var nameSkipWords = ['pvt','ltd','llc','inc','corp','limited','private','company','solutions','technologies','services','www','http','email','phone','tel','fax','address','mobile','office','director','manager','ceo','founder','mr','mrs','ms','dr'];
    for (var i = 0; i < Math.min(lines.length, 8); i++) {
        var line = lines[i];
        var lower = line.toLowerCase();
        if (line.indexOf('@') !== -1) continue;
        if (lower.indexOf('www') !== -1) continue;
        if (/\d{5,}/.test(line)) continue;
        if (line === companyFound) continue;

        var hasSkipWord = nameSkipWords.some(function(w){ return lower.indexOf(w) !== -1; });
        if (hasSkipWord) continue;

        var words = line.split(/\s+/).filter(function(w){ return w.length > 1; });
        if (words.length >= 2 && words.length <= 5) {
            var letterRatio = (line.replace(/[^a-zA-Z\s.]/g, '').length / line.length);
            // Check for proper case (not ALL CAPS)
            var upperCount = (line.match(/[A-Z]/g) || []).length;
            var letterCount = (line.match(/[a-zA-Z]/g) || []).length;
            var isAllCaps = letterCount > 4 && upperCount / letterCount > 0.8;

            if (letterRatio > 0.8 && !isAllCaps) {
                document.getElementById('revName'+idx).value = line;
                break;
            }
        }
    }

    // Extract address - look for lines with address indicators
    var addressKeywords = ['road','street','lane','nagar','colony','sector','block','floor','building','tower','plot','no.','pin','zip','-','avenue','apt','apartment','suite','city','state'];
    var addressLines = [];
    for (var i = 0; i < lines.length; i++) {
        var line = lines[i];
        var lower = line.toLowerCase();
        if (line.indexOf('@') !== -1) continue;
        var hasAddressWord = addressKeywords.some(function(w){ return lower.indexOf(w) !== -1; });
        // Also check for PIN code pattern
        var hasPinCode = /\b\d{6}\b/.test(line) || /\b\d{5}\b/.test(line);
        if ((hasAddressWord || hasPinCode) && line.length > 5) {
            addressLines.push(line);
        }
    }
    if (addressLines.length > 0) {
        document.getElementById('revAddress'+idx).value = addressLines.join(', ');
    }
}

function saveReview(idx) {
    var item = reviewItems[idx];
    if (!item) return;

    var name = document.getElementById('revName'+idx).value.trim();
    var phone = document.getElementById('revPhone'+idx).value.trim();
    var email = document.getElementById('revEmail'+idx).value.trim();
    var company = document.getElementById('revCompany'+idx).value.trim();
    var address = document.getElementById('revAddress'+idx).value.trim();

    // Update lead with extracted data, compress image, mark as reviewed
    var updateData = {
        name: name,
        phone: phone,
        email: email,
        company: company,
        address: address,
        needsReview: null, // delete this field
        cardImage: null,   // delete full-size image
        reviewedAt: Date.now()
    };

    // Compress card image to thumbnail before saving
    var savePromise = item.cardImage ? compressCardPhoto(item.cardImage).then(function(thumb) {
        if (thumb) updateData.photo = thumb;
        return apiFetch('/leads/'+item._id, {method:'PATCH', body:updateData});
    }) : apiFetch('/leads/'+item._id, {method:'PATCH', body:updateData});

    savePromise.then(function() {
        // Remove from list
        reviewItems.splice(idx, 1);
        renderReviewItems();
        loadStats();

        // Offer to save to contacts
        if (name || phone || email) {
            if (confirm('Lead saved! Add "' + (name || phone || email) + '" to your contacts?')) {
                saveLeadWithAddress(name, phone, email, company, address);
            }
        }
    }).catch(function(){});
}

function saveLeadWithAddress(name, phone, email, company, address) {
    var parts = (name || '').split(' ');
    var last = parts.length > 1 ? parts.pop() : '';
    var first = parts.join(' ') || name;
    var lines = ['BEGIN:VCARD','VERSION:3.0'];
    if (name) { lines.push('N:'+last+';'+first+';;;'); lines.push('FN:'+name); }
    if (company) lines.push('ORG:'+company);
    if (phone) lines.push('TEL;TYPE=CELL:'+phone);
    if (email) lines.push('EMAIL;TYPE=INTERNET:'+email);
    if (address) lines.push('ADR;TYPE=WORK:;;'+address.replace(/,/g,';')+';;;;');
    lines.push('END:VCARD');
    var blob = new Blob([lines.join('\n')], {type:'text/vcard;charset=utf-8'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = (name||'contact').replace(/\s/g,'_')+'.vcf';
    document.body.appendChild(a); a.click();
    setTimeout(function(){ document.body.removeChild(a); URL.revokeObjectURL(url); },100);
}

function skipReview(idx) {
    var item = reviewItems[idx];
    if (!item) return;

    // Just remove needsReview flag but keep the image
    apiFetch('/leads/'+item._id, {method:'PATCH', body:{needsReview:null}}).then(function() {
        reviewItems.splice(idx, 1);
        renderReviewItems();
    }).catch(function(){});
}

// Note: checkReviewQueue + interval called from initApp() after auth

function esc(s) { return s.replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/\n/g,'\\n').replace(/\r/g,'\\r').replace(/</g,'\\x3c').replace(/>/g,'\\x3e'); }

function saveLead(name, phone, email, company) {
    var parts = name.split(' ');
    var last = parts.length > 1 ? parts.pop() : '';
    var first = parts.join(' ') || name;
    var lines = ['BEGIN:VCARD','VERSION:3.0'];
    if (name) { lines.push('N:'+last+';'+first+';;;'); lines.push('FN:'+name); }
    if (company) lines.push('ORG:'+company);
    if (phone) lines.push('TEL;TYPE=CELL:'+phone);
    if (email) lines.push('EMAIL;TYPE=INTERNET:'+email);
    lines.push('END:VCARD');
    var blob = new Blob([lines.join('\n')], {type:'text/vcard;charset=utf-8'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = (name||'contact').replace(/\s/g,'_')+'.vcf';
    document.body.appendChild(a); a.click();
    setTimeout(function(){ document.body.removeChild(a); URL.revokeObjectURL(url); },100);
}

// ── Scan Modal ──
var scanStream = null;
var scanMode = null; // 'qr' or 'card'
var scanInterval = null;

function openScanModal() {
    document.getElementById('scanModal').classList.add('show');
    document.getElementById('scanOptions').style.display = 'flex';
    document.getElementById('scanCamera').style.display = 'none';
    document.getElementById('scanResult').style.display = 'none';
    document.getElementById('scanTitle').textContent = 'Scan Contact';
}

function closeScanModal() {
    document.getElementById('scanModal').classList.remove('show');
    stopScanCamera();
    scanCapturedPhoto = null;
}

function stopScanCamera() {
    if (scanInterval) { clearInterval(scanInterval); scanInterval = null; }
    if (scanStream) {
        scanStream.getTracks().forEach(function(t){ t.stop(); });
        scanStream = null;
    }
    var video = document.getElementById('scanVideo');
    if (video) video.srcObject = null;
}

function startQrScan() {
    scanMode = 'qr';
    document.getElementById('scanOptions').style.display = 'none';
    document.getElementById('scanCamera').style.display = 'flex';
    document.getElementById('scanTitle').textContent = 'Scan QR Code';
    document.getElementById('scanStatus').textContent = 'Point camera at QR code...';
    document.getElementById('scanCaptureBtn').style.display = 'none';
    document.getElementById('scanViewfinder').style.display = 'block';

    startCamera(function() {
        // Start scanning for QR codes
        scanInterval = setInterval(scanForQR, 200);
    });
}

function startCardScan() {
    scanMode = 'card';
    document.getElementById('scanOptions').style.display = 'none';
    document.getElementById('scanCamera').style.display = 'flex';
    document.getElementById('scanTitle').textContent = 'Scan Business Card';
    document.getElementById('scanStatus').textContent = 'Position card in frame, then tap Capture';
    document.getElementById('scanCaptureBtn').style.display = 'block';
    document.getElementById('scanViewfinder').style.display = 'none';

    startCamera();
}

function startCamera(callback) {
    var video = document.getElementById('scanVideo');
    navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
    }).then(function(stream) {
        scanStream = stream;
        video.srcObject = stream;
        video.play();
        if (callback) setTimeout(callback, 500);
    }).catch(function(err) {
        document.getElementById('scanStatus').textContent = 'Couldn\'t access your camera. Please check permissions and try again.';
    });
}

function scanForQR() {
    if (typeof jsQR === 'undefined') return;
    var video = document.getElementById('scanVideo');
    var canvas = document.getElementById('scanCanvas');
    var ctx = canvas.getContext('2d');

    if (video.readyState !== video.HAVE_ENOUGH_DATA) return;

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);

    var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    var code = jsQR(imageData.data, imageData.width, imageData.height);

    if (code && code.data) {
        stopScanCamera();
        processQrData(code.data);
    }
}

function processQrData(data) {
    document.getElementById('scanStatus').textContent = 'QR found! Processing...';

    // Try to parse vCard
    if (data.indexOf('BEGIN:VCARD') !== -1) {
        var contact = parseVCard(data);
        showScanResult(contact);
        return;
    }

    // Try to parse MECARD
    if (data.indexOf('MECARD:') === 0) {
        var contact = parseMeCard(data);
        showScanResult(contact);
        return;
    }

    // URL - might be a digital card
    if (data.indexOf('http') === 0) {
        showScanResult({ name: '', company: '', phone: '', email: '', title: '', url: data });
        document.getElementById('scanStatus').textContent = 'URL found: ' + data;
        return;
    }

    // Plain text - put in name field
    showScanResult({ name: data, company: '', phone: '', email: '', title: '', url: '' });
}

function parseVCard(data) {
    var contact = { name: '', company: '', phone: '', email: '', title: '', url: '', address: '' };
    var lines = data.split(/\r?\n/);
    lines.forEach(function(line) {
        var l = line.replace(/^item\d+\./i, '');
        var prop = l.split(':')[0].split(';')[0].toUpperCase();
        var val = l.substring(l.indexOf(':') + 1).trim();
        if (!val) return;
        switch (prop) {
            case 'FN': contact.name = val; break;
            case 'N':
                if (!contact.name) {
                    var parts = val.split(';');
                    contact.name = ((parts[1] || '') + ' ' + (parts[0] || '')).trim();
                }
                break;
            case 'ORG': contact.company = val.split(';')[0]; break;
            case 'TITLE': contact.title = val; break;
            case 'TEL': contact.phone = contact.phone || val.replace(/^tel:/i, ''); break;
            case 'EMAIL': contact.email = contact.email || val; break;
            case 'URL': contact.url = contact.url || val; break;
            case 'ADR':
                if (!contact.address) {
                    contact.address = val.split(';').filter(function(s) { return s.trim(); }).join(', ');
                }
                break;
        }
    });
    return contact;
}

function parseMeCard(data) {
    var contact = { name: '', company: '', phone: '', email: '', url: '' };
    var parts = data.replace('MECARD:', '').split(';');
    parts.forEach(function(p) {
        if (p.indexOf('N:') === 0) contact.name = p.substring(2).replace(/,/g, ' ');
        else if (p.indexOf('ORG:') === 0) contact.company = p.substring(4);
        else if (p.indexOf('TEL:') === 0) contact.phone = p.substring(4);
        else if (p.indexOf('EMAIL:') === 0) contact.email = p.substring(6);
        else if (p.indexOf('URL:') === 0) contact.url = p.substring(4);
    });
    return contact;
}

function captureCard() {
    var video = document.getElementById('scanVideo');
    var canvas = document.getElementById('scanCanvas');
    var ctx = canvas.getContext('2d');

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);

    var imageData = canvas.toDataURL('image/jpeg', 0.70);

    stopScanCamera();
    closeScanModal();
    showToast('Scanning card in background...');
    bgProcessOCR(imageData, 'camera');
}

function extractContactFromOCR(text) {
    var contact = { name: '', company: '', phone: '', email: '', title: '', url: '' };
    var lines = text.split('\n').map(function(l){ return l.trim(); }).filter(function(l){ return l; });

    // Find email
    var emailMatch = text.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/);
    if (emailMatch) contact.email = emailMatch[0].toLowerCase();

    // Find phone (require at least some digits, not just spaces/dashes)
    var phoneMatch = text.match(/(?:\+?\d[\d\s\-\(\)]{8,}\d)/);
    if (phoneMatch) contact.phone = phoneMatch[0].replace(/[^\d+]/g, '');

    // Find URL
    var urlMatch = text.match(/https?:\/\/[^\s]+|www\.[^\s]+/i);
    if (urlMatch) contact.url = urlMatch[0];

    // Title keywords
    var titleWords = /\b(ceo|cto|cfo|coo|director|manager|engineer|developer|designer|founder|president|vp|vice\s*president|head|lead|chief|officer|consultant|analyst|partner|advisor|specialist|executive|architect)\b/i;

    // Classify remaining lines
    for (var i = 0; i < lines.length; i++) {
        var line = lines[i];
        if (line.match(/@/) || line.match(/^[\d\+\(\s\-\)]{8,}$/) || line.match(/^http/i) || line.match(/^www\./i)) continue;
        if (line.length <= 2) continue;

        if (!contact.name) {
            contact.name = line;
        } else if (!contact.title && titleWords.test(line)) {
            contact.title = line;
        } else if (!contact.company && line !== contact.name) {
            contact.company = line;
        }
        if (contact.name && contact.company && contact.title) break;
    }

    return contact;
}

function showScanResult(contact) {
    document.getElementById('scanCamera').style.display = 'none';
    document.getElementById('scanResult').style.display = 'block';
    document.getElementById('scanName').value = contact.name || '';
    document.getElementById('scanCompany').value = contact.company || '';
    document.getElementById('scanJobTitle').value = contact.title || '';
    document.getElementById('scanPhone').value = contact.phone || '';
    document.getElementById('scanEmail').value = contact.email || '';
    document.getElementById('scanUrl').value = contact.url || '';
    document.getElementById('scanTitle').textContent = 'Review Contact';
}

function retryScan() {
    document.getElementById('scanResult').style.display = 'none';
    document.getElementById('scanOptions').style.display = 'flex';
    document.getElementById('scanTitle').textContent = 'Scan Contact';
}

function saveScannedContact() {
    var contact = {
        name: document.getElementById('scanName').value.trim(),
        title: document.getElementById('scanJobTitle').value.trim(),
        company: document.getElementById('scanCompany').value.trim(),
        phone: document.getElementById('scanPhone').value.trim(),
        email: document.getElementById('scanEmail').value.trim(),
        website: document.getElementById('scanUrl').value.trim(),
        ts: Date.now(),
        source: 'scanned',
        photo: scanCapturedPhoto || null
    };

    if (!contact.name && !contact.phone && !contact.email) {
        alert('Please enter at least a name, phone, or email');
        return;
    }

    // Save lead
    var scanLeadId = Date.now().toString(36) + Math.random().toString(36).substr(2,5);
    apiFetch('/leads/' + scanLeadId, {
        method: 'PUT',
        body: contact
    }).then(function() {
        closeScanModal();
        loadStats();
        showUpdateToast('Contact saved to leads!');
    }).catch(function(err) {
        showUpdateToast('Couldn\'t save this contact. Please check your connection and try again.');
    });
}

// ═══ SCAN & ADD CARDS ═══
var scanResults = [];       // [{id, imageData, contacts, status, multiCard, expanded}]
var scanProcessing = 0;     // count of in-flight OCR requests
var scanTotalQueued = 0;    // total images queued (for bulk progress)
var scanTotalDone = 0;      // total images done
var scanSavedCount = 0;     // auto-saved count
var scanCardsStream = null;
var scanCardsRapidMode = false;
var scanCapturedPhoto = null; // thumbnail from single-scan modal

// ── Background OCR queue ──
var bgScanQueue = [];       // [{id, imageData, photoThumb, contacts, status, source}]
var bgScanProcessing = 0;   // in-flight background OCR count

// Compress a data-URL image to a small thumbnail for lead storage (~5-15KB)
// crop: optional {x,y,w,h} in percentage (0-100) to extract just the card region
function compressCardPhoto(dataUrl, crop) {
    return new Promise(function(resolve) {
        var img = new Image();
        img.onload = function() {
            var c = document.createElement('canvas');
            var ctx = c.getContext('2d');
            var maxDim = 400;

            if (crop && crop.w > 0 && crop.h > 0) {
                // Crop to card region
                var sx = Math.round(img.width * crop.x / 100);
                var sy = Math.round(img.height * crop.y / 100);
                var sw = Math.round(img.width * crop.w / 100);
                var sh = Math.round(img.height * crop.h / 100);
                var w = sw, h = sh;
                if (w > maxDim || h > maxDim) {
                    if (w > h) { h = Math.round(h * maxDim / w); w = maxDim; }
                    else { w = Math.round(w * maxDim / h); h = maxDim; }
                }
                c.width = w; c.height = h;
                ctx.drawImage(img, sx, sy, sw, sh, 0, 0, w, h);
            } else {
                // Full image resize
                var w = img.width, h = img.height;
                if (w > maxDim || h > maxDim) {
                    if (w > h) { h = Math.round(h * maxDim / w); w = maxDim; }
                    else { w = Math.round(w * maxDim / h); h = maxDim; }
                }
                c.width = w; c.height = h;
                ctx.drawImage(img, 0, 0, w, h);
            }
            resolve(c.toDataURL('image/jpeg', 0.50));
        };
        img.onerror = function() { resolve(null); };
        img.src = dataUrl;
    });
}

// Actionable toast — clickable, longer duration
function showActionableToast(msg, type, onClick, duration) {
    var t = document.createElement('div');
    t.className = 'toast toast-' + (type || 'success') + ' toast-actionable show';
    t.textContent = msg;
    if (onClick) t.addEventListener('click', function() { t.remove(); onClick(); });
    document.body.appendChild(t);
    setTimeout(function() { t.classList.remove('show'); setTimeout(function() { t.remove(); }, 300); }, duration || 5000);
}

// ── Background OCR processing ──

function bgProcessOCR(imageData, source) {
    var id = 'bg_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 4);
    var entry = { id: id, imageData: imageData, photoThumb: null, contacts: [], status: 'scanning', source: source || 'camera' };
    bgScanQueue.push(entry);
    bgScanProcessing++;
    updateBgScanIndicator();

    apiFetch('/ocr/scan-card-multi', { method: 'POST', body: { image: imageData } })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            var contacts = data.contacts || [];
            if (contacts.length === 0) contacts = [{ name: '', title: '', company: '', phone: '', email: '', website: '' }];
            entry.contacts = contacts;
            entry.status = 'done';
            bgScanProcessing--;
            updateBgScanIndicator();
            // Compress thumbnail with crop coordinates from OCR (auto-crops to card)
            var crop = data.crop || null;
            compressCardPhoto(imageData, crop).then(function(thumb) {
                entry.photoThumb = thumb;
                bgAutoSave(entry);
            });
        })
        .catch(function() {
            bgScanProcessing--;
            // Fallback to client Tesseract
            function doLocal() {
                Tesseract.recognize(imageData, 'eng').then(function(result) {
                    var parsed = parseBusinessCardOCR(result.data.text);
                    entry.contacts = [parsed];
                    entry.status = 'done';
                    updateBgScanIndicator();
                    // No crop from Tesseract — compress full image
                    compressCardPhoto(imageData).then(function(thumb) {
                        entry.photoThumb = thumb;
                        bgAutoSave(entry);
                    });
                }).catch(function() {
                    entry.status = 'error';
                    updateBgScanIndicator();
                    showActionableToast('Card scan failed. Tap to retry.', 'error', function() {
                        entry.status = 'scanning'; bgScanProcessing++;
                        bgProcessOCR(entry.imageData, entry.source);
                    });
                });
            }
            if (typeof Tesseract === 'undefined') {
                loadTesseract().then(doLocal).catch(function() {
                    entry.status = 'error';
                    updateBgScanIndicator();
                    showActionableToast('Card scan failed. Tap to retry.', 'error', function() { bgProcessOCR(entry.imageData, entry.source); });
                });
            } else { doLocal(); }
        });
}

function bgAutoSave(entry) {
    if (entry._saved) return;
    entry._saved = true;
    var saved = 0;
    var total = entry.contacts.length;

    entry.contacts.forEach(function(c) {
        var leadId = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        var leadData = {
            name: c.name || '', title: c.title || '', company: c.company || '',
            phone: c.phone || '', email: c.email || '',
            website: c.url || c.website || '',
            ts: Date.now(), source: 'card-scan',
            photo: entry.photoThumb || null
        };
        apiFetch('/leads/' + leadId, { method: 'PUT', body: leadData })
            .then(function() {
                saved++;
                if (saved === total) {
                    entry.status = 'saved';
                    entry.imageData = null; // free memory
                    updateBgScanIndicator();
                    var name = entry.contacts[0] && entry.contacts[0].name;
                    showToast(name ? (name + ' saved to leads!') : 'Contact saved to leads!');
                    loadStats();
                    completeChecklistItem('share_card');
                }
            })
            .catch(function() {
                entry.status = 'error';
                entry._saved = false;
                updateBgScanIndicator();
                showActionableToast('Failed to save contact. Tap to retry.', 'error', function() { bgAutoSave(entry); });
            });
    });
}

function updateBgScanIndicator() {
    var el = document.getElementById('bgScanIndicator');
    if (!el) return;
    var pending = bgScanQueue.filter(function(e) { return e.status === 'scanning'; }).length;
    var done = bgScanQueue.filter(function(e) { return e.status === 'done' || e.status === 'saved'; }).length;
    var errors = bgScanQueue.filter(function(e) { return e.status === 'error'; }).length;

    if (pending === 0 && done === 0 && errors === 0) { el.style.display = 'none'; return; }

    el.style.display = 'flex';
    var text = document.getElementById('bgScanText');
    var spinner = el.querySelector('.bg-scan-spinner');

    if (pending > 0) {
        spinner.style.display = '';
        text.textContent = 'Scanning ' + pending + ' card' + (pending !== 1 ? 's' : '') + '...';
    } else if (errors > 0) {
        spinner.style.display = 'none';
        text.textContent = errors + ' failed';
    } else {
        spinner.style.display = 'none';
        text.textContent = done + ' saved';
        setTimeout(function() {
            if (bgScanProcessing === 0) {
                el.style.display = 'none';
                bgScanQueue = bgScanQueue.filter(function(e) { return e.status !== 'saved'; });
            }
        }, 4000);
    }
}

var scanCardsAutoSave = localStorage.getItem('scanCardsAutoSave') === '1';

function parseBusinessCardOCR(text) {
    var result = { name: '', title: '', company: '', phone: '', email: '', url: '' };
    var lines = text.split('\n').map(function(l){ return l.trim(); }).filter(function(l){ return l.length > 1; });

    // Email
    var emailMatch = text.match(/[a-zA-Z0-9._%+\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,}/);
    if (emailMatch) result.email = emailMatch[0].toLowerCase();

    // Phone (must start and end with digit)
    var phoneMatch = text.match(/(?:\+?\d[\d\s\-\(\)]{8,}\d)/);
    if (phoneMatch) result.phone = phoneMatch[0].replace(/[^\d+]/g, '');

    // URL
    var urlMatch = text.match(/https?:\/\/[^\s]+|www\.[^\s]+/i);
    if (urlMatch) result.url = urlMatch[0];

    // Title keywords
    var titleWords = /\b(ceo|cto|cfo|coo|director|manager|engineer|developer|designer|founder|president|vp|vice\s*president|head|lead|chief|officer|consultant|analyst|associate|partner|advisor|specialist|coordinator|executive|administrator|intern|assistant|supervisor|architect|scientist|professor|doctor)\b/i;

    // Classify lines
    for (var i = 0; i < lines.length; i++) {
        var line = lines[i];
        if (line.match(/@/) || line.match(/^[\d\+\(\s\-\)]{8,}$/) || line.match(/^http/i) || line.match(/^www\./i)) continue;
        if (line.length <= 2) continue;

        if (!result.name) {
            result.name = line;
        } else if (!result.title && titleWords.test(line)) {
            result.title = line;
        } else if (!result.company && line !== result.name) {
            result.company = line;
        }
        if (result.name && result.company && result.title) break;
    }

    return result;
}

function openScanCardsModal() {
    scanResults = [];
    scanProcessing = 0;
    scanTotalQueued = 0;
    scanTotalDone = 0;
    scanSavedCount = 0;
    scanCardsRapidMode = false;
    document.getElementById('scanCardsSources').style.display = 'flex';
    document.getElementById('scanCardsCamera').style.display = 'none';
    document.getElementById('scanCardsResults').style.display = 'none';
    document.getElementById('scanCardsTitle').textContent = 'Scan Contacts';
    document.getElementById('scanCardsBadge').style.display = 'none';
    document.getElementById('scanCardsCamActions').style.display = 'none';
    document.getElementById('scanCardsCaptureBtn').style.display = '';
    document.getElementById('scanCardsShutter').disabled = false;
    document.getElementById('scanResultsFeed').innerHTML = '';
    document.getElementById('scanCardsModal').classList.add('show');
}

function closeScanCardsModal() {
    document.getElementById('scanCardsModal').classList.remove('show');
    stopScanCardsCamera();
    document.getElementById('scanCardsFileInput').value = '';
    document.getElementById('scanCardsBulkInput').value = '';

    // Transfer in-flight / unsaved results to background queue
    var pending = scanResults.filter(function(r) {
        return r.status === 'scanning' || (r.status === 'done' && !r._saved);
    });
    if (pending.length > 0) {
        pending.forEach(function(r) {
            r._bgTransferred = true;
            bgScanQueue.push({
                id: r.id, imageData: r.imageData, photoThumb: r.photoThumb,
                contacts: r.contacts.slice(), status: r.status, source: 'bulk'
            });
            if (r.status === 'scanning') bgScanProcessing++;
            if (r.status === 'done') bgAutoSave(bgScanQueue[bgScanQueue.length - 1]);
        });
        updateBgScanIndicator();
        showToast(pending.length + ' card' + (pending.length !== 1 ? 's' : '') + ' processing in background');
    }

    scanResults = [];
    scanProcessing = 0;
    scanCardsRapidMode = false;
}

function stopScanCardsCamera() {
    if (scanCardsStream) {
        scanCardsStream.getTracks().forEach(function(t){ t.stop(); });
        scanCardsStream = null;
    }
}

function scanCardsSingleCamera() {
    document.getElementById('scanCardsSources').style.display = 'none';
    document.getElementById('scanCardsCamera').style.display = 'flex';
    document.getElementById('scanCardsTitle').textContent = 'Rapid-Fire Camera';

    scanCardsRapidMode = true;
    scanResults = [];
    scanProcessing = 0;
    document.getElementById('scanCardsCaptureBtn').style.display = 'none';
    document.getElementById('scanCardsCamActions').style.display = 'flex';
    document.getElementById('scanCardsBadge').style.display = 'block';
    document.getElementById('scanCardsBadge').textContent = 'Ready';

    var video = document.getElementById('scanCardsVideo');
    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
        .then(function(stream) {
            scanCardsStream = stream;
            video.srcObject = stream;
            stream.getVideoTracks()[0].addEventListener('ended', function() {
                if (scanCardsRapidMode) finishRapidFire();
            });
        })
        .catch(function(err) {
            showToast('Couldn\'t access your camera. Please check permissions.', 'error');
            document.getElementById('scanCardsSources').style.display = 'flex';
            document.getElementById('scanCardsCamera').style.display = 'none';
            scanCardsRapidMode = false;
        });
}

function captureScanCard() {
    var video = document.getElementById('scanCardsVideo');
    var canvas = document.getElementById('scanCardsCanvas');
    var ctx = canvas.getContext('2d');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);

    var imageData = canvas.toDataURL('image/jpeg', 0.70);

    // Flash effect
    var flash = document.getElementById('scanCardsFlash');
    flash.classList.add('active');
    setTimeout(function() { flash.classList.remove('active'); }, 120);

    // Add to results with processing state and run OCR in background
    addScanResultAndOCR(imageData);
    updateRapidFireBadge();
}

function handleScanCardsFile(input) {
    if (!input.files || !input.files[0]) return;
    document.getElementById('scanCardsSources').style.display = 'none';
    showScanResults();

    processImageFile(input.files[0], function(imageData) {
        addScanResultAndOCR(imageData);
    });
    input.value = '';
}

function handleScanCardsBulk(input) {
    if (!input.files || input.files.length === 0) return;
    var files = Array.prototype.slice.call(input.files);
    var total = files.length;

    // Auto-enable auto-save for large batches
    if (total > 10) scanCardsAutoSave = true;

    document.getElementById('scanCardsSources').style.display = 'none';
    scanTotalQueued = total;
    scanTotalDone = 0;
    scanSavedCount = 0;
    showScanResults();
    document.getElementById('scanResultsProgress').style.display = 'block';
    document.getElementById('scanResultsProgFill').style.width = '2%';

    // Worker pool: process 3 images concurrently
    var WORKERS = 3;
    var nextIdx = 0;
    var bulkUseSmall = total > 10;

    function startWorker() {
        if (nextIdx >= total) return;
        var fileIdx = nextIdx++;
        processImageFileBulk(files[fileIdx], bulkUseSmall, function(imageData) {
            if (!imageData) {
                scanTotalDone++;
                updateBulkProgress();
                startWorker();
                return;
            }
            addScanResultAndOCR(imageData, function() {
                scanTotalDone++;
                updateBulkProgress();
                startWorker();
            });
        });
    }

    for (var w = 0; w < Math.min(WORKERS, total); w++) startWorker();
    input.value = '';
}

function updateBulkProgress() {
    if (scanTotalQueued <= 0) return;
    var pct = Math.max(2, Math.round((scanTotalDone / scanTotalQueued) * 100));
    document.getElementById('scanResultsProgFill').style.width = pct + '%';
    if (scanTotalDone >= scanTotalQueued) {
        document.getElementById('scanResultsProgress').style.display = 'none';
        document.getElementById('scanResultsMoreBtn').style.display = '';
        if (scanCardsAutoSave && scanSavedCount > 0) {
            showToast(scanSavedCount + ' contact' + (scanSavedCount !== 1 ? 's' : '') + ' saved');
            showLeadsData();
            switchCardsTab('leads');
            setTimeout(function() { closeScanCardsModal(); }, 500);
        }
    }
}

function processImageFileBulk(file, small, callback) {
    var reader = new FileReader();
    reader.onload = function(e) {
        var img = new Image();
        img.onload = function() {
            var canvas = document.createElement('canvas');
            var maxDim = small ? 800 : 1200;
            var quality = small ? 0.7 : 0.85;
            var w = img.width, h = img.height;
            if (w > maxDim || h > maxDim) {
                if (w > h) { h = Math.round(h * maxDim / w); w = maxDim; }
                else { w = Math.round(w * maxDim / h); h = maxDim; }
            }
            canvas.width = w; canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
            callback(canvas.toDataURL('image/jpeg', quality));
        };
        img.onerror = function() { callback(null); };
        img.src = e.target.result;
    };
    reader.onerror = function() { callback(null); };
    reader.readAsDataURL(file);
}

function processImageFile(file, callback) {
    var reader = new FileReader();
    reader.onload = function(e) {
        var img = new Image();
        img.onload = function() {
            var canvas = document.createElement('canvas');
            var maxDim = 800;
            var w = img.width, h = img.height;
            if (w > maxDim || h > maxDim) {
                if (w > h) { h = Math.round(h * maxDim / w); w = maxDim; }
                else { w = Math.round(w * maxDim / h); h = maxDim; }
            }
            canvas.width = w; canvas.height = h;
            canvas.getContext('2d').drawImage(img, 0, 0, w, h);
            callback(canvas.toDataURL('image/jpeg', 0.70));
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

// ── Core: add a scan result card and run OCR in background ──

function addScanResultAndOCR(imageData, onDone) {
    var id = 'sr_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 4);
    var entry = { id: id, imageData: imageData, contacts: [], status: 'scanning', multiCard: false, photoThumb: null };
    scanResults.push(entry);
    scanProcessing++;
    // Generate compressed thumbnail in parallel with OCR
    compressCardPhoto(imageData).then(function(thumb) { entry.photoThumb = thumb; });
    renderScanResultCard(entry);
    updateScanResultsBar();

    // Run OCR in background via server
    apiFetch('/ocr/scan-card-multi', { method: 'POST', body: { image: imageData } })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            var contacts = data.contacts || [];
            if (contacts.length === 0) contacts = [{ name: '', title: '', company: '', phone: '', email: '', website: '' }];
            entry.contacts = contacts;
            entry.multiCard = contacts.length > 1;
            entry.status = 'done';
            scanProcessing--;
            // If transferred to background, route there instead
            if (entry._bgTransferred) {
                var bgEntry = bgScanQueue.find(function(e) { return e.id === entry.id; });
                if (bgEntry) { bgEntry.contacts = contacts; bgEntry.photoThumb = entry.photoThumb; bgEntry.status = 'done'; bgScanProcessing--; updateBgScanIndicator(); bgAutoSave(bgEntry); }
                if (onDone) onDone();
                return;
            }
            updateScanResultCard(entry);
            updateScanResultsBar();
            if (scanCardsAutoSave) autoSaveScanResult(entry);
            if (onDone) onDone();
        })
        .catch(function() {
            // Fallback to client Tesseract
            scanProcessing--;
            function doBgFallback(parsed) {
                if (entry._bgTransferred) {
                    var bgEntry = bgScanQueue.find(function(e) { return e.id === entry.id; });
                    if (bgEntry) { bgEntry.contacts = [parsed]; bgEntry.photoThumb = entry.photoThumb; bgEntry.status = 'done'; bgScanProcessing--; updateBgScanIndicator(); bgAutoSave(bgEntry); }
                    if (onDone) onDone();
                    return true;
                }
                return false;
            }
            function doLocal() {
                Tesseract.recognize(imageData, 'eng').then(function(result) {
                    var parsed = parseBusinessCardOCR(result.data.text);
                    entry.contacts = [parsed];
                    entry.status = 'done';
                    if (doBgFallback(parsed)) return;
                    updateScanResultCard(entry);
                    updateScanResultsBar();
                    if (scanCardsAutoSave) autoSaveScanResult(entry);
                    if (onDone) onDone();
                }).catch(function() {
                    var empty = { name: '', title: '', company: '', phone: '', email: '', website: '' };
                    entry.contacts = [empty];
                    entry.status = 'done';
                    if (doBgFallback(empty)) return;
                    updateScanResultCard(entry);
                    updateScanResultsBar();
                    if (onDone) onDone();
                });
            }
            if (typeof Tesseract === 'undefined') {
                loadTesseract().then(doLocal).catch(function() {
                    var empty = { name: '', title: '', company: '', phone: '', email: '', website: '' };
                    entry.contacts = [empty];
                    entry.status = 'done';
                    if (doBgFallback(empty)) return;
                    updateScanResultCard(entry);
                    updateScanResultsBar();
                    if (onDone) onDone();
                });
            } else {
                doLocal();
            }
        });
}

function autoSaveScanResult(entry) {
    if (entry.status !== 'done' || entry._saved) return;
    entry._saved = true;
    entry.contacts.forEach(function(c) {
        var leadId = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        var leadData = {
            name: c.name || '', title: c.title || '', company: c.company || '',
            phone: c.phone || '', email: c.email || '',
            website: c.url || c.website || '',
            ts: Date.now(), source: 'card-scan',
            photo: entry.photoThumb || null
        };
        apiFetch('/leads/' + leadId, { method: 'PUT', body: leadData })
            .then(function() {
                scanSavedCount++;
                entry.status = 'saved';
                updateScanResultCard(entry);
                updateScanResultsBar();
            })
            .catch(function() {
                entry.status = 'error';
                updateScanResultCard(entry);
            });
    });
}

// ── Show / hide results panel ──

function showScanResults() {
    document.getElementById('scanCardsResults').style.display = 'flex';
    document.getElementById('scanCardsTitle').textContent = 'Scan Results';
    document.getElementById('scanResultsMoreBtn').style.display = scanCardsRapidMode ? 'none' : '';
}

function scanMoreCards() {
    document.getElementById('scanCardsResults').style.display = 'none';
    document.getElementById('scanCardsSources').style.display = 'flex';
    document.getElementById('scanCardsTitle').textContent = 'Scan Contacts';
}

// ── Render result cards ──

function renderScanResultCard(entry) {
    var feed = document.getElementById('scanResultsFeed');
    var div = document.createElement('div');
    div.className = 'sr-card' + (entry.status === 'scanning' ? ' processing' : '');
    div.id = 'sr-' + entry.id;
    div.innerHTML = buildScanResultHTML(entry);
    feed.insertBefore(div, feed.firstChild);
    feed.scrollTop = 0;
}

function updateScanResultCard(entry) {
    var el = document.getElementById('sr-' + entry.id);
    if (!el) return;
    el.className = 'sr-card' + (entry.status === 'scanning' ? ' processing' : '') + (entry.multiCard ? ' has-multi' : '');
    el.innerHTML = buildScanResultHTML(entry);
}

function buildScanResultHTML(entry) {
    var html = '';

    if (entry.status === 'scanning') {
        // Processing state — show image + spinner
        html += '<div class="sr-card-thumb-wrap">';
        html += '<img class="sr-card-thumb" src="' + entry.imageData + '" alt="Card">';
        html += '<div class="sr-card-thumb-spinner"></div>';
        html += '</div>';
        html += '<div class="sr-card-body"><div class="sr-card-scanning">Scanning card...</div></div>';
        return html;
    }

    // Completed state — show image + editable fields for each contact
    for (var ci = 0; ci < entry.contacts.length; ci++) {
        var c = entry.contacts[ci];
        if (ci === 0) {
            // First contact shows with image
            html += '<div class="sr-card-thumb-wrap" onclick="toggleScanImage(\'' + entry.id + '\')" style="cursor:pointer">';
            html += '<img class="sr-card-thumb" src="' + entry.imageData + '" alt="Card">';
            html += '</div>';
        }

        html += '<div class="sr-card-body' + (ci > 0 ? ' sr-card-extra' : '') + '">';
        if (entry.multiCard && ci === 0) {
            html += '<div class="sr-card-multi">' + entry.contacts.length + ' contacts</div>';
        }

        // Summary line
        var name = c.name || 'Unknown';
        var detail = '';
        if (c.title && c.company) detail = escapeHtml(c.title) + ' at ' + escapeHtml(c.company);
        else if (c.company) detail = escapeHtml(c.company);
        else if (c.title) detail = escapeHtml(c.title);
        html += '<div class="sr-card-name">' + escapeHtml(name) + '</div>';
        if (detail) html += '<div class="sr-card-detail">' + detail + '</div>';

        // Editable fields
        html += '<div class="sr-card-fields">';
        html += '<div class="sr-card-row">';
        html += '<input placeholder="Name" value="' + escAttr(c.name || '') + '" onchange="updateScanContact(\'' + entry.id + '\',' + ci + ',\'name\',this.value)">';
        html += '<input placeholder="Title" value="' + escAttr(c.title || '') + '" onchange="updateScanContact(\'' + entry.id + '\',' + ci + ',\'title\',this.value)">';
        html += '</div>';
        html += '<input placeholder="Company" value="' + escAttr(c.company || '') + '" onchange="updateScanContact(\'' + entry.id + '\',' + ci + ',\'company\',this.value)">';
        html += '<div class="sr-card-row">';
        html += '<input placeholder="Phone" value="' + escAttr(c.phone || '') + '" onchange="updateScanContact(\'' + entry.id + '\',' + ci + ',\'phone\',this.value)">';
        html += '<input placeholder="Email" value="' + escAttr(c.email || '') + '" onchange="updateScanContact(\'' + entry.id + '\',' + ci + ',\'email\',this.value)">';
        html += '</div>';
        html += '<input placeholder="Website" value="' + escAttr(c.website || c.url || '') + '" onchange="updateScanContact(\'' + entry.id + '\',' + ci + ',\'website\',this.value)">';
        html += '</div>';

        html += '</div>';
    }

    // Status badge
    if (entry.status === 'saved') html += '<span class="sr-card-status saved">Saved</span>';
    else if (entry.status === 'error') html += '<span class="sr-card-status error">Error</span>';

    // Remove button
    if (entry.status !== 'scanning' && entry.status !== 'saved') {
        html += '<button class="sr-card-remove" onclick="removeScanResult(\'' + entry.id + '\')">&times;</button>';
    }

    return html;
}

function updateScanContact(entryId, contactIdx, field, value) {
    var entry = scanResults.find(function(r) { return r.id === entryId; });
    if (entry && entry.contacts[contactIdx]) entry.contacts[contactIdx][field] = value;
}

function toggleScanImage(entryId) {
    var el = document.getElementById('sr-' + entryId);
    if (!el) return;
    el.classList.toggle('sr-expanded');
}

function updateScanResultsBar() {
    var total = 0;
    scanResults.forEach(function(r) { total += r.contacts.length; });
    var countText = total + ' contact' + (total !== 1 ? 's' : '');
    if (scanSavedCount > 0) countText += ' (' + scanSavedCount + ' saved)';
    document.getElementById('scanResultsCount').textContent = countText;
    document.getElementById('scanResultsSpinner').style.display = scanProcessing > 0 ? 'inline-flex' : 'none';
    var saveBtn = document.getElementById('scanResultsSaveBtn');
    var unsaved = scanResults.filter(function(r) { return r.status === 'done' && !r._saved; });
    if (scanCardsAutoSave) {
        saveBtn.style.display = 'none';
    } else {
        saveBtn.style.display = '';
        saveBtn.disabled = unsaved.length === 0;
        saveBtn.textContent = 'Save All' + (unsaved.length > 0 ? ' (' + unsaved.length + ')' : '');
    }
}

function removeScanResult(id) {
    scanResults = scanResults.filter(function(r) { return r.id !== id; });
    var el = document.getElementById('sr-' + id);
    if (el) el.remove();
    updateScanResultsBar();
    if (scanResults.length === 0) closeScanCardsModal();
}

function saveAllScanResults() {
    var btn = document.getElementById('scanResultsSaveBtn');
    btn.disabled = true;
    btn.textContent = 'Saving...';

    var toSave = scanResults.filter(function(r) { return r.status === 'done' && !r._saved; });
    var idx = 0;
    var saved = 0;

    function saveNext() {
        if (idx >= toSave.length) {
            showToast(saved + ' contact' + (saved !== 1 ? 's' : '') + ' saved');
            showLeadsData();
            switchCardsTab('leads');
            setTimeout(function() { closeScanCardsModal(); }, 500);
            return;
        }
        var entry = toSave[idx];
        entry._saved = true;
        var contacts = entry.contacts;
        var ci = 0;

        function saveContact() {
            if (ci >= contacts.length) {
                entry.status = 'saved';
                updateScanResultCard(entry);
                idx++;
                saveNext();
                return;
            }
            var c = contacts[ci];
            var leadId = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
            var leadData = {
                name: c.name || '', title: c.title || '', company: c.company || '',
                phone: c.phone || '', email: c.email || '',
                website: c.url || c.website || '',
                ts: Date.now(), source: 'card-scan',
                photo: entry.photoThumb || null
            };
            apiFetch('/leads/' + leadId, { method: 'PUT', body: leadData })
                .then(function() { saved++; ci++; saveContact(); })
                .catch(function() { ci++; saveContact(); });
        }
        saveContact();
    }
    saveNext();
}

// ── Rapid-fire helpers ──

function updateRapidFireBadge() {
    var badge = document.getElementById('scanCardsBadge');
    var captured = scanResults.length;
    var text = captured + ' captured';
    if (scanProcessing > 0) text += ' (' + scanProcessing + ' scanning)';
    badge.textContent = text;
}

function finishRapidFire() {
    scanCardsRapidMode = false;
    stopScanCardsCamera();
    document.getElementById('scanCardsShutter').disabled = true;
    document.getElementById('scanCardsCamera').style.display = 'none';

    if (scanResults.length === 0) {
        showToast('No cards captured', 'error');
        closeScanCardsModal();
        return;
    }

    showScanResults();
    document.getElementById('scanResultsMoreBtn').style.display = '';

    // If still processing, show progress
    if (scanProcessing > 0) {
        document.getElementById('scanResultsProgress').style.display = 'block';
        scanTotalQueued = scanResults.length;
        scanTotalDone = scanResults.length - scanProcessing;
        var waitInt = setInterval(function() {
            scanTotalDone = scanResults.length - scanProcessing;
            var pct = Math.round((scanTotalDone / scanTotalQueued) * 100);
            document.getElementById('scanResultsProgFill').style.width = pct + '%';
            if (scanProcessing <= 0) {
                clearInterval(waitInt);
                document.getElementById('scanResultsProgress').style.display = 'none';
                if (scanCardsAutoSave) {
                    scanResults.forEach(function(r) { autoSaveScanResult(r); });
                }
            }
        }, 300);
    } else if (scanCardsAutoSave) {
        scanResults.forEach(function(r) { autoSaveScanResult(r); });
    }
}

// ── Service Worker Registration ──
if ('serviceWorker' in navigator) {
    var refreshing = false;
    // Reload once when new SW takes control (after skipWaiting)
    navigator.serviceWorker.addEventListener('controllerchange', function() {
        if (!refreshing) { refreshing = true; window.location.reload(); }
    });

    navigator.serviceWorker.register('/sw.js').then(function(reg) {
        // Check for updates every 5 minutes
        setInterval(function() { reg.update(); }, 300000);

        // Listen for new service worker waiting
        reg.addEventListener('updatefound', function() {
            var newWorker = reg.installing;
            if (!newWorker) return;
            newWorker.addEventListener('statechange', function() {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                    // New SW is waiting — show toast and tell it to activate
                    showUpdateToast();
                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                }
            });
        });

        // Also handle case where SW is already waiting on page load
        if (reg.waiting) {
            showUpdateToast();
            reg.waiting.postMessage({ type: 'SKIP_WAITING' });
        }
    }).catch(function(err) {
        console.error('ServiceWorker registration failed:', err);
    });
}

function showUpdateToast() {
    var existing = document.querySelector('.update-toast');
    if (existing) return; // already showing
    var toast = document.createElement('div');
    toast.className = 'update-toast';
    toast.style.cssText = 'position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:#4ade80;color:#000;padding:12px 24px;border-radius:12px;font-size:14px;font-weight:500;z-index:9999;animation:fadeIn .3s';
    toast.textContent = 'Updating to latest version\u2026';
    document.body.appendChild(toast);
}

// ── App Install System ──
var deferredPrompt = null;

function isIOS() {
    return /iPhone|iPad|iPod/.test(navigator.userAgent);
}
function isAndroid() {
    return /Android/.test(navigator.userAgent);
}
function isInStandaloneMode() {
    return (window.matchMedia('(display-mode: standalone)').matches) ||
           (window.navigator.standalone === true);
}

// Capture the beforeinstallprompt event for Chrome/Android
window.addEventListener('beforeinstallprompt', function(e) {
    e.preventDefault();
    deferredPrompt = e;
    updateInstallButton();
});

// Update install button based on state
function updateInstallButton() {
    var btn = document.getElementById('installBtn');
    if (!btn) return;
    if (isInStandaloneMode()) {
        btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>Installed';
        btn.classList.add('installed');
        btn.onclick = null;
    }
}

function showInstallModal() {
    if (isInStandaloneMode()) {
        return; // Already installed
    }

    var modal = document.getElementById('installModal');
    var content = document.getElementById('installModalContent');

    if (isIOS()) {
        // iOS instructions
        content.innerHTML = '\
            <div class="install-icon"><svg viewBox="0 0 24 24"><path d="M17 1.01L7 1c-1.1 0-2 .9-2 2v18c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-1.99-2-1.99zM17 19H7V5h10v14z"/></svg></div>\
            <h3>Install CardFlow</h3>\
            <p>Get instant notifications when someone taps your NFC card</p>\
            <div class="install-features">\
                <div class="install-feature"><svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg><span>Notifications</span></div>\
                <div class="install-feature"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg><span>Works Offline</span></div>\
                <div class="install-feature"><svg viewBox="0 0 24 24"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg><span>Instant</span></div>\
            </div>\
            <div class="install-steps">\
                <div class="install-step"><span class="install-step-num">1</span><span class="install-step-text">Tap <svg viewBox="0 0 24 24"><path d="M16 5l-1.42 1.42-1.59-1.59V16h-1.98V4.83L9.42 6.42 8 5l4-4 4 4zm4 5v11c0 1.1-.9 2-2 2H6c-1.1 0-2-.9-2-2V10c0-1.1.9-2 2-2h3v2H6v11h12V10h-3V8h3c1.1 0 2 .9 2 2z"/></svg> Share at the bottom</span></div>\
                <div class="install-step"><span class="install-step-num">2</span><span class="install-step-text">Scroll down, tap <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg> Add to Home Screen</span></div>\
                <div class="install-step"><span class="install-step-num">3</span><span class="install-step-text">Tap Add in the top right</span></div>\
            </div>\
            <button class="install-secondary-btn" onclick="closeInstallModal(true)">Got it</button>\
        ';
    } else if (deferredPrompt) {
        // Chrome/Android with native prompt available
        content.innerHTML = '\
            <div class="install-icon"><svg viewBox="0 0 24 24"><path d="M17 1.01L7 1c-1.1 0-2 .9-2 2v18c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-1.99-2-1.99zM17 19H7V5h10v14z"/></svg></div>\
            <h3>Install CardFlow</h3>\
            <p>Get instant notifications when someone taps your NFC card</p>\
            <div class="install-features">\
                <div class="install-feature"><svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg><span>Notifications</span></div>\
                <div class="install-feature"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg><span>Works Offline</span></div>\
                <div class="install-feature"><svg viewBox="0 0 24 24"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg><span>Instant</span></div>\
            </div>\
            <button class="install-primary-btn" onclick="triggerInstall()">Install Now</button>\
            <button class="install-secondary-btn" onclick="closeInstallModal()">Maybe Later</button>\
        ';
    } else {
        // Desktop or browser without native install
        content.innerHTML = '\
            <div class="install-icon"><svg viewBox="0 0 24 24"><path d="M17 1.01L7 1c-1.1 0-2 .9-2 2v18c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-1.99-2-1.99zM17 19H7V5h10v14z"/></svg></div>\
            <h3>Install CardFlow</h3>\
            <p>Get instant notifications when someone taps your NFC card</p>\
            <div class="install-features">\
                <div class="install-feature"><svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg><span>Notifications</span></div>\
                <div class="install-feature"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg><span>Works Offline</span></div>\
                <div class="install-feature"><svg viewBox="0 0 24 24"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg><span>Instant</span></div>\
            </div>\
            <div class="install-steps">\
                <div class="install-step"><span class="install-step-num">1</span><span class="install-step-text">Click the browser menu (three dots)</span></div>\
                <div class="install-step"><span class="install-step-num">2</span><span class="install-step-text">Select "Install app" or "Add to Home screen"</span></div>\
            </div>\
            <button class="install-secondary-btn" onclick="closeInstallModal(true)">Got it</button>\
        ';
    }

    modal.classList.add('show');
}

function triggerInstall() {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(function(result) {
            if (result.outcome === 'accepted') {
                updateInstallButton();
            }
            deferredPrompt = null;
        });
    }
    closeInstallModal();
}

function closeInstallModal(saveDismiss) {
    document.getElementById('installModal').classList.remove('show');
    if (saveDismiss) {
        localStorage.setItem('installModalDismissed', 'true');
    }
}

// Note: updateInstallButton called from initApp() after auth

// Listen for successful install
window.addEventListener('appinstalled', function() {
    updateInstallButton();
    closeInstallModal();
});

// Note: install modal shown from initApp() after auth

</script>

<!-- Card Preview Modal -->
<div class="preview-modal" id="previewModal" onclick="if(event.target===this)closePreview()">
    <div class="preview-phone">
        <div class="preview-loading" id="previewLoading"><div class="preview-spinner"></div></div>
        <iframe id="previewFrame" class="preview-iframe" onload="document.getElementById('previewLoading').style.display='none'"></iframe>
        <button class="preview-close" onclick="closePreview()">&times;</button>
        <div class="preview-actions">
            <button class="preview-action-btn" onclick="openInNewTab()">Open in new tab</button>
        </div>
    </div>
</div>

<!-- NFC FAB (mobile only) -->
<button class="nfc-fab" id="nfcFab" onclick="startNfcShare()">
    <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 18H4V4h16v16zM18 6h-5c-1.1 0-2 .9-2 2v2.28c-.6.35-1 .98-1 1.72 0 1.1.9 2 2 2s2-.9 2-2c0-.74-.4-1.37-1-1.72V8h3v8H8V8h2V6H6v12h12V6z"/></svg>
</button>

<!-- NFC Overlay -->
<div class="nfc-overlay" id="nfcOverlay" onclick="if(event.target===this)closeNfcOverlay()">
    <div class="nfc-rings" id="nfcRings">
        <div class="nfc-ring"></div>
        <div class="nfc-ring"></div>
        <div class="nfc-ring"></div>
        <div class="nfc-rings-icon" id="nfcRingsIcon">
            <svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 18H4V4h16v16zM18 6h-5c-1.1 0-2 .9-2 2v2.28c-.6.35-1 .98-1 1.72 0 1.1.9 2 2 2s2-.9 2-2c0-.74-.4-1.37-1-1.72V8h3v8H8V8h2V6H6v12h12V6z"/></svg>
        </div>
    </div>
    <div class="nfc-overlay-text" id="nfcOverlayText">Hold near another phone</div>
    <div class="nfc-overlay-sub" id="nfcOverlaySub">Place phones back to back</div>
    <div class="nfc-overlay-card" id="nfcOverlayCard"></div>
    <button class="nfc-overlay-cancel" id="nfcCancelBtn" onclick="closeNfcOverlay()">Cancel</button>
    <div class="nfc-fallback" id="nfcFallback" style="display:none">
        <div class="nfc-fallback-qr"><canvas id="nfcFallbackQr"></canvas></div>
        <div class="nfc-fallback-share">
            <button class="nfc-share-link" onclick="shareNfcLink()">Share Link</button>
            <button class="nfc-close-fb" onclick="closeNfcOverlay()">Close</button>
        </div>
    </div>
</div>

<!-- Install Modal -->
<div class="install-modal" id="installModal" onclick="if(event.target===this)closeInstallModal()">
    <div class="install-modal-content" id="installModalContent"></div>
</div>


<!-- Card Switcher Bottom Sheet -->
<div class="cs-backdrop" id="csBackdrop"></div>
<div class="cs-sheet" id="csSheet">
    <div class="cs-handle" id="csHandle"></div>
    <div class="cs-header">
        <span class="cs-title">Switch Card</span>
        <button class="cs-close-btn" onclick="closeCardSwitcher()">&times;</button>
    </div>
    <div class="cs-list" id="csList"></div>
</div>

<!-- Guided Tour -->
<div class="tour-overlay" id="tourOverlay" style="display:none">
    <div class="tour-spotlight" id="tourSpotlight"></div>
    <div class="tour-tooltip" id="tourTooltip">
        <div class="tour-tooltip-text" id="tourText"></div>
        <div class="tour-tooltip-actions">
            <button class="tour-skip" onclick="endTour()">Skip</button>
            <span class="tour-step-count" id="tourStepCount"></span>
            <button class="tour-next" onclick="nextTourStep()">Next</button>
        </div>
    </div>
</div>

</body>
</html>
