<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Card Admin</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="preconnect" href="https://visiting-cards-8020e-default-rtdb.firebaseio.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.4/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
        html{height:100%;overflow:hidden}
        body{
            font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
            background:#0f172a;
            color:#fff;
            height:100%;
            overflow:hidden;
            -webkit-font-smoothing:antialiased;
            -webkit-text-size-adjust:100%;
            -webkit-tap-highlight-color:transparent;
            line-height:1.5;
        }
        button,a,input,select{-webkit-tap-highlight-color:transparent;touch-action:manipulation}

        /* â”€â”€ Screens â”€â”€ */
        .screen{
            position:fixed;
            inset:0;
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
            padding:24px;
            padding-top:calc(24px + env(safe-area-inset-top));
            padding-bottom:calc(24px + env(safe-area-inset-bottom));
            transition:opacity .25s ease-out,transform .25s ease-out;
        }
        .screen.hidden{opacity:0;pointer-events:none;transform:scale(.97)}

        /* â”€â”€ Idle Screen â”€â”€ */
        #idle .pulse-ring{
            width:88px;
            height:88px;
            border-radius:50%;
            border:2px solid rgba(255,255,255,.1);
            display:flex;
            align-items:center;
            justify-content:center;
            position:relative;
            margin-bottom:20px;
        }
        #idle .pulse-ring::before{
            content:'';
            position:absolute;
            inset:0;
            border-radius:50%;
            border:2px solid rgba(255,255,255,.08);
            animation:pulse 2s ease-out infinite;
        }
        @keyframes pulse{0%{transform:scale(1);opacity:.5}100%{transform:scale(1.6);opacity:0}}
        #idle .nfc-icon svg{width:36px;height:36px;fill:rgba(255,255,255,.4)}
        #idle h2{font-size:17px;font-weight:600;color:rgba(255,255,255,.8);margin-bottom:4px}
        #idle p{font-size:13px;color:rgba(255,255,255,.4)}

        .tap-stats{margin-top:16px;display:flex;gap:24px}
        .stat{text-align:center}
        .stat .num{font-size:28px;font-weight:700;color:rgba(255,255,255,.7)}
        .stat .lbl{font-size:11px;color:rgba(255,255,255,.3);margin-top:2px}

        .qs-badge{
            margin-top:12px;
            font-size:12px;
            padding:6px 14px;
            border-radius:8px;
            background:rgba(99,102,241,.15);
            color:#a5b4fc;
            display:none;
        }
        .qs-badge.show{display:inline-block}

        /* â”€â”€ QR Section â”€â”€ */
        .qr-section{
            margin-top:24px;
            text-align:center;
            width:100%;
            max-width:280px;
        }
        .qr-picker{
            display:flex;
            align-items:center;
            justify-content:center;
            gap:8px;
            margin-bottom:14px;
        }
        .qr-picker select{
            background:rgba(255,255,255,.08) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='rgba(255,255,255,0.6)'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E") no-repeat right 12px center;
            color:#fff;
            border:1px solid rgba(255,255,255,.15);
            border-radius:10px;
            padding:12px 36px 12px 16px;
            font-family:inherit;
            font-size:14px;
            font-weight:500;
            outline:none;
            -webkit-appearance:none;
            appearance:none;
            cursor:pointer;
            min-width:200px;
        }
        .qr-picker select:focus{border-color:rgba(255,255,255,.3);background-color:rgba(255,255,255,.12)}
        .qr-picker select option{background:#1e293b;color:#fff;padding:10px}
        .qr-canvas-wrap{
            background:#fff;
            border-radius:16px;
            padding:16px;
            display:inline-block;
            cursor:pointer;
            box-shadow:0 4px 24px rgba(0,0,0,.3);
        }
        .qr-canvas-wrap:active{transform:scale(.96)}
        .qr-canvas-wrap canvas{display:block}
        .qr-actions{display:flex;gap:8px;margin-top:12px;justify-content:center}
        .qr-action-btn{
            font-size:13px;
            padding:10px 16px;
            border-radius:10px;
            cursor:pointer;
            border:none;
            font-family:inherit;
            font-weight:500;
            background:rgba(255,255,255,.08);
            color:rgba(255,255,255,.6);
            display:flex;
            align-items:center;
            gap:6px;
        }
        .qr-action-btn:active{transform:scale(.95);opacity:.8}
        .qr-action-btn svg{width:16px;height:16px;fill:currentColor}
        .qr-action-btn.copied{background:rgba(34,197,94,.15);color:#4ade80}

        /* â”€â”€ Buttons Row â”€â”€ */
        .idle-btns{display:flex;gap:8px;margin-top:24px;flex-wrap:wrap;justify-content:center}
        .idle-btn{
            font-size:13px;
            padding:10px 18px;
            border-radius:10px;
            cursor:pointer;
            border:none;
            font-family:inherit;
            font-weight:500;
        }
        .idle-btn:active{transform:scale(.95)}
        .notif-on{background:rgba(34,197,94,.15);color:#4ade80}
        .notif-off{background:rgba(255,255,255,.08);color:rgba(255,255,255,.5)}
        .leads-btn{background:rgba(255,255,255,.08);color:rgba(255,255,255,.6)}
        .qs-btn{background:rgba(99,102,241,.15);color:#818cf8}
        .qs-active{background:rgba(99,102,241,.25);color:#a5b4fc}
        .analytics-btn{background:rgba(251,191,36,.12);color:#fbbf24}
        .storage-btn{background:rgba(20,184,166,.12);color:#2dd4bf}
        .review-btn{background:rgba(249,115,22,.12);color:#fb923c}
        .review-btn.has-items{background:rgba(249,115,22,.25);color:#fdba74;position:relative}
        .review-badge{position:absolute;top:-4px;right:-4px;background:#f97316;color:#fff;font-size:10px;font-weight:700;min-width:18px;height:18px;border-radius:9px;display:flex;align-items:center;justify-content:center;padding:0 5px}
        .default-btn{background:rgba(236,72,153,.12);color:#f472b6}
        .default-active{background:rgba(236,72,153,.2);color:#f9a8d4}

        .default-badge{
            margin-top:8px;
            font-size:12px;
            padding:6px 14px;
            border-radius:8px;
            background:rgba(236,72,153,.15);
            color:#f472b6;
            display:none;
        }
        .default-badge.show{display:inline-block}

        /* â”€â”€ Fullscreen QR â”€â”€ */
        .qr-fullscreen{
            position:fixed;
            inset:0;
            background:rgba(0,0,0,.9);
            display:none;
            align-items:center;
            justify-content:center;
            z-index:200;
            flex-direction:column;
            gap:24px;
        }
        .qr-fullscreen.show{display:flex}
        .qr-fullscreen .qr-full-wrap{background:#fff;border-radius:20px;padding:24px}
        .qr-fullscreen .qr-full-wrap canvas{display:block}
        .qr-fullscreen .qr-card-name{color:#fff;font-size:18px;font-weight:600}
        .qr-fullscreen .qr-close{
            background:rgba(255,255,255,.1);
            border:none;
            color:#fff;
            font-size:15px;
            padding:12px 28px;
            border-radius:12px;
            cursor:pointer;
            font-family:inherit;
            font-weight:500;
        }
        .qr-fullscreen .qr-close:active{opacity:.7}

        /* â”€â”€ Picker Screen â”€â”€ */
        #picker{background:linear-gradient(180deg,#0f172a,#1e293b)}
        .pick-alert{
            font-size:12px;
            color:rgba(255,255,255,.5);
            text-transform:uppercase;
            letter-spacing:2px;
            margin-bottom:6px;
        }
        .pick-title{font-size:22px;font-weight:700;margin-bottom:6px}
        .pick-visitor{font-size:13px;color:rgba(255,255,255,.4);margin-bottom:28px}
        .pick-cards{display:flex;flex-direction:column;gap:12px;width:100%;max-width:360px}
        .pick-btn{
            width:100%;
            padding:18px 20px;
            border-radius:14px;
            border:none;
            color:#fff;
            font-family:inherit;
            font-size:16px;
            font-weight:600;
            cursor:pointer;
            text-align:left;
            position:relative;
        }
        .pick-btn:active{transform:scale(.97);opacity:.9}
        .pick-btn small{display:block;font-weight:400;font-size:12px;opacity:.7;margin-top:2px}
        .pick-btn::after{content:'\2192';position:absolute;right:18px;top:50%;transform:translateY(-50%);font-size:16px;opacity:.5}

        /* â”€â”€ Sent Screen â”€â”€ */
        #sent .check{
            width:72px;
            height:72px;
            border-radius:50%;
            background:rgba(34,197,94,.15);
            display:flex;
            align-items:center;
            justify-content:center;
            margin-bottom:20px;
        }
        #sent .check svg{width:36px;height:36px;fill:#4ade80}
        #sent h2{font-size:20px;font-weight:600;margin-bottom:4px}
        #sent .sent-sub{font-size:14px;color:rgba(255,255,255,.5)}
        .sent-auto{font-size:12px;color:rgba(255,255,255,.3);margin-top:4px}
        .lead-card{
            background:rgba(255,255,255,.05);
            border-radius:14px;
            padding:18px;
            text-align:left;
            margin-top:20px;
            max-width:340px;
            width:100%;
        }
        .lead-card .lc-label{font-size:11px;text-transform:uppercase;letter-spacing:1px;color:rgba(255,255,255,.4);margin-bottom:8px}
        .lead-card .lc-name{font-size:17px;font-weight:600}
        .lead-card .lc-company{font-size:14px;color:rgba(255,255,255,.5);margin-top:2px}
        .lead-card .lc-contact{margin-top:10px;font-size:14px}
        .lead-card a{color:#4ade80;text-decoration:none}
        .lead-card a:active{opacity:.7}
        .lead-card img{width:100%;border-radius:10px;margin-top:12px;max-height:200px;object-fit:contain}

        /* â”€â”€ Leads Dashboard â”€â”€ */
        #leads{
            position:fixed;
            inset:0;
            background:#0f172a;
            overflow-y:auto;
            -webkit-overflow-scrolling:touch;
            display:none;
            padding:0;
            padding-bottom:calc(40px + env(safe-area-inset-bottom));
        }
        #leads.show{display:block}
        .leads-header{
            position:sticky;
            top:0;
            background:rgba(15,23,42,.95);
            backdrop-filter:blur(12px);
            -webkit-backdrop-filter:blur(12px);
            padding:16px 20px;
            padding-top:calc(16px + env(safe-area-inset-top));
            display:flex;
            align-items:center;
            gap:12px;
            border-bottom:1px solid rgba(255,255,255,.06);
            z-index:10;
        }
        .leads-back{
            width:40px;
            height:40px;
            border-radius:50%;
            background:rgba(255,255,255,.08);
            border:none;
            display:flex;
            align-items:center;
            justify-content:center;
            cursor:pointer;
        }
        .leads-back:active{transform:scale(.9);opacity:.8}
        .leads-back svg{width:20px;height:20px;fill:rgba(255,255,255,.6)}
        .leads-header h2{font-size:18px;font-weight:600}
        .leads-header span{font-size:13px;color:rgba(255,255,255,.4);margin-left:auto}

        .leads-toolbar{
            position:sticky;
            top:73px;
            background:rgba(15,23,42,.95);
            backdrop-filter:blur(12px);
            -webkit-backdrop-filter:blur(12px);
            padding:12px 20px;
            display:flex;
            gap:10px;
            z-index:10;
            border-bottom:1px solid rgba(255,255,255,.04);
        }
        .leads-search{
            flex:1;
            min-width:100px;
            padding:12px 16px;
            border:1px solid rgba(255,255,255,.1);
            border-radius:12px;
            background:rgba(255,255,255,.05);
            color:#fff;
            font-family:inherit;
            font-size:14px;
            outline:none;
        }
        .leads-search::placeholder{color:rgba(255,255,255,.3)}
        .leads-search:focus{border-color:rgba(255,255,255,.2);background:rgba(255,255,255,.08)}
        .csv-btn{
            padding:12px 18px;
            border:none;
            border-radius:12px;
            background:rgba(99,102,241,.15);
            color:#818cf8;
            font-family:inherit;
            font-size:13px;
            font-weight:600;
            cursor:pointer;
        }
        .csv-btn:active{transform:scale(.95)}

        /* â”€â”€ Filter Bar â”€â”€ */
        .filter-bar{
            position:sticky;
            top:122px;
            background:rgba(15,23,42,.95);
            backdrop-filter:blur(8px);
            -webkit-backdrop-filter:blur(8px);
            padding:8px 20px 12px;
            display:flex;
            gap:8px;
            z-index:10;
            overflow-x:auto;
            scrollbar-width:none;
        }
        .filter-bar::-webkit-scrollbar{display:none}
        .filter-chip{
            font-size:12px;
            padding:8px 14px;
            border-radius:20px;
            border:1px solid rgba(255,255,255,.1);
            background:transparent;
            color:rgba(255,255,255,.5);
            cursor:pointer;
            white-space:nowrap;
            font-family:inherit;
            flex-shrink:0;
        }
        .filter-chip:active{transform:scale(.95)}
        .filter-chip.active{background:rgba(99,102,241,.2);border-color:rgba(99,102,241,.4);color:#a5b4fc}

        /* â”€â”€ Reminder Banner â”€â”€ */
        .reminder-banner{display:none;padding:14px 20px;background:rgba(251,146,60,.1);border-bottom:1px solid rgba(251,146,60,.2)}
        .reminder-banner.show{display:block}
        .reminder-banner-title{font-size:13px;font-weight:600;color:#fb923c;margin-bottom:8px}
        .reminder-item{font-size:13px;color:rgba(255,255,255,.6);padding:6px 0;display:flex;justify-content:space-between;align-items:center}
        .reminder-item a{color:#fb923c;text-decoration:none;font-weight:500}
        .reminder-dismiss{background:none;border:none;color:rgba(255,255,255,.4);font-size:12px;cursor:pointer;padding:4px 8px;font-family:inherit}

        /* â”€â”€ Lead Item â”€â”€ */
        .lead-item{padding:18px 20px;border-bottom:1px solid rgba(255,255,255,.04)}
        .lead-item:active{background:rgba(255,255,255,.02)}
        .lead-item .li-top{display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
        .lead-item .li-name{font-size:16px;font-weight:600}
        .lead-item .li-company{font-size:13px;color:rgba(255,255,255,.5);margin-top:2px}
        .lead-item .li-card-badge{font-size:11px;padding:4px 10px;border-radius:8px;background:rgba(255,255,255,.08);color:rgba(255,255,255,.5)}
        .lead-item .li-contact{margin-top:10px;font-size:14px;color:rgba(255,255,255,.6)}
        .lead-item .li-contact a{color:#4ade80;text-decoration:none}
        .lead-item .li-time{font-size:12px;color:rgba(255,255,255,.3);margin-top:8px}
        .lead-item .li-source{font-size:10px;color:rgba(255,255,255,.25);margin-left:8px;text-transform:uppercase}
        .lead-item .li-photo{width:100%;max-height:160px;object-fit:contain;border-radius:10px;margin-top:12px}
        .leads-empty{text-align:center;padding:60px 24px;color:rgba(255,255,255,.4);font-size:15px}

        /* â”€â”€ Status Badge â”€â”€ */
        .status-badge{
            font-size:11px;
            padding:4px 10px;
            border-radius:8px;
            font-weight:600;
            cursor:pointer;
            border:none;
            font-family:inherit;
        }
        .status-badge:active{transform:scale(.9)}
        .status-new{background:rgba(59,130,246,.15);color:#60a5fa}
        .status-contacted{background:rgba(251,191,36,.15);color:#fbbf24}
        .status-qualified{background:rgba(168,85,247,.15);color:#c084fc}
        .status-won{background:rgba(34,197,94,.15);color:#4ade80}
        .status-lost{background:rgba(239,68,68,.12);color:#f87171}

        /* â”€â”€ Tags â”€â”€ */
        .tag-row{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
        .tag-chip{font-size:11px;padding:4px 10px;border-radius:12px;background:rgba(99,102,241,.12);color:#a5b4fc;cursor:pointer;border:none;font-family:inherit}
        .tag-chip:active{transform:scale(.93)}
        .add-tag-btn{font-size:11px;padding:4px 10px;border-radius:12px;background:rgba(255,255,255,.05);color:rgba(255,255,255,.4);cursor:pointer;border:1px dashed rgba(255,255,255,.15);font-family:inherit}
        .add-tag-btn:active{transform:scale(.95)}

        /* â”€â”€ Notes â”€â”€ */
        .lead-note{margin-top:10px}
        .lead-note textarea{
            width:100%;
            padding:10px 12px;
            border:1px solid rgba(255,255,255,.1);
            border-radius:10px;
            background:rgba(255,255,255,.04);
            color:rgba(255,255,255,.8);
            font-family:inherit;
            font-size:13px;
            resize:vertical;
            min-height:40px;
            outline:none;
        }
        .lead-note textarea::placeholder{color:rgba(255,255,255,.25)}
        .lead-note textarea:focus{border-color:rgba(255,255,255,.2);background:rgba(255,255,255,.06)}
        .lead-note-saved{font-size:11px;color:rgba(34,197,94,.7);display:none;margin-top:4px}

        /* â”€â”€ Reminder â”€â”€ */
        .lead-reminder{margin-top:8px;display:flex;align-items:center;gap:8px}
        .lead-reminder input[type="date"]{
            background:rgba(255,255,255,.06);
            border:1px solid rgba(255,255,255,.1);
            border-radius:8px;
            color:rgba(255,255,255,.7);
            font-family:inherit;
            font-size:12px;
            padding:6px 10px;
            outline:none;
        }
        .lead-reminder input[type="date"]::-webkit-calendar-picker-indicator{filter:invert(.6)}
        .remind-btn{font-size:12px;padding:6px 12px;border-radius:8px;border:none;background:rgba(251,146,60,.12);color:#fb923c;cursor:pointer;font-family:inherit}
        .remind-set{font-size:11px;color:#fb923c}

        /* â”€â”€ Lead Actions â”€â”€ */
        .lead-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
        .save-lead-btn{
            display:inline-flex;
            align-items:center;
            gap:6px;
            padding:10px 16px;
            border:none;
            border-radius:10px;
            background:rgba(74,222,128,.15);
            color:#4ade80;
            font-family:inherit;
            font-size:13px;
            font-weight:600;
            cursor:pointer;
        }
        .save-lead-btn:active{transform:scale(.96)}
        .save-lead-btn svg{width:16px;height:16px;fill:#4ade80}
        .del-lead-btn{
            display:inline-flex;
            align-items:center;
            gap:6px;
            padding:10px 14px;
            border:none;
            border-radius:10px;
            background:rgba(239,68,68,.1);
            color:#f87171;
            font-family:inherit;
            font-size:13px;
            font-weight:600;
            cursor:pointer;
        }
        .del-lead-btn:active{transform:scale(.96)}
        .del-lead-btn svg{width:14px;height:14px;fill:#f87171}

        /* â”€â”€ Quick Send Modal â”€â”€ */
        .qs-modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:flex-end;justify-content:center;z-index:100}
        .qs-modal.show{display:flex}
        .qs-sheet{
            background:#1e293b;
            border-radius:20px 20px 0 0;
            width:100%;
            max-width:480px;
            padding:28px 20px calc(28px + env(safe-area-inset-bottom));
        }
        .qs-sheet h3{font-size:18px;font-weight:600;margin-bottom:6px}
        .qs-sheet .qs-sub{font-size:13px;color:rgba(255,255,255,.4);margin-bottom:20px}
        .qs-opt{
            width:100%;
            padding:16px 18px;
            border:1px solid rgba(255,255,255,.08);
            border-radius:14px;
            background:rgba(255,255,255,.04);
            color:#fff;
            font-family:inherit;
            font-size:15px;
            font-weight:500;
            cursor:pointer;
            margin-bottom:10px;
            text-align:left;
        }
        .qs-opt:active{transform:scale(.98)}
        .qs-opt.selected{border-color:rgba(99,102,241,.5);background:rgba(99,102,241,.12)}
        .qs-opt small{display:block;font-size:12px;font-weight:400;color:rgba(255,255,255,.4);margin-top:3px}
        .qs-off{
            text-align:center;
            padding:14px;
            border:none;
            background:none;
            color:rgba(255,255,255,.4);
            font-family:inherit;
            font-size:14px;
            cursor:pointer;
            width:100%;
            margin-top:8px;
        }
        .qs-off:active{color:rgba(255,255,255,.6)}

        /* â”€â”€ Tag Modal â”€â”€ */
        .tag-modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:flex-end;justify-content:center;z-index:100}
        .tag-modal.show{display:flex}
        .tag-sheet{
            background:#1e293b;
            border-radius:20px 20px 0 0;
            width:100%;
            max-width:480px;
            padding:28px 20px calc(28px + env(safe-area-inset-bottom));
        }
        .tag-sheet h3{font-size:18px;font-weight:600;margin-bottom:16px}
        .tag-options{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:20px}
        .tag-option{
            padding:10px 18px;
            border-radius:20px;
            border:1px solid rgba(255,255,255,.1);
            background:rgba(255,255,255,.04);
            color:rgba(255,255,255,.6);
            font-family:inherit;
            font-size:14px;
            cursor:pointer;
        }
        .tag-option:active{transform:scale(.95)}
        .tag-option.selected{border-color:rgba(99,102,241,.5);background:rgba(99,102,241,.15);color:#a5b4fc}
        .tag-custom{display:flex;gap:10px;margin-bottom:20px}
        .tag-custom input{
            flex:1;
            padding:12px 16px;
            border:1px solid rgba(255,255,255,.1);
            border-radius:12px;
            background:rgba(255,255,255,.05);
            color:#fff;
            font-family:inherit;
            font-size:14px;
            outline:none;
        }
        .tag-custom input::placeholder{color:rgba(255,255,255,.3)}
        .tag-custom input:focus{border-color:rgba(255,255,255,.2)}
        .tag-custom button{
            padding:12px 20px;
            border:none;
            border-radius:12px;
            background:rgba(99,102,241,.2);
            color:#818cf8;
            font-family:inherit;
            font-size:14px;
            font-weight:600;
            cursor:pointer;
        }
        .tag-custom button:active{transform:scale(.95)}
        .tag-done{
            width:100%;
            padding:14px;
            border:none;
            border-radius:12px;
            background:rgba(34,197,94,.15);
            color:#4ade80;
            font-family:inherit;
            font-size:15px;
            font-weight:600;
            cursor:pointer;
        }
        .tag-done:active{transform:scale(.97)}

        /* â”€â”€ Analytics Dashboard â”€â”€ */
        #analytics{
            position:fixed;
            inset:0;
            background:#0f172a;
            overflow-y:auto;
            -webkit-overflow-scrolling:touch;
            display:none;
            padding:0;
            padding-bottom:calc(40px + env(safe-area-inset-bottom));
        }
        #analytics.show{display:block}
        .analytics-header{
            position:sticky;
            top:0;
            background:rgba(15,23,42,.95);
            backdrop-filter:blur(12px);
            -webkit-backdrop-filter:blur(12px);
            padding:16px 20px;
            padding-top:calc(16px + env(safe-area-inset-top));
            display:flex;
            align-items:center;
            gap:12px;
            border-bottom:1px solid rgba(255,255,255,.06);
            z-index:10;
        }
        .analytics-header h2{font-size:18px;font-weight:600}
        .analytics-content{padding:20px}
        .analytics-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:24px}
        .analytics-card{background:rgba(255,255,255,.04);border-radius:14px;padding:20px;text-align:center}
        .analytics-card .ac-num{font-size:32px;font-weight:700;color:rgba(255,255,255,.85)}
        .analytics-card .ac-label{font-size:12px;color:rgba(255,255,255,.4);margin-top:4px}
        .analytics-section{margin-bottom:28px}
        .analytics-section h3{font-size:15px;font-weight:600;color:rgba(255,255,255,.6);margin-bottom:14px}
        .analytics-bar{display:flex;align-items:center;gap:12px;margin-bottom:10px}
        .analytics-bar .ab-label{font-size:13px;color:rgba(255,255,255,.5);width:90px;flex-shrink:0}
        .analytics-bar .ab-track{flex:1;height:8px;background:rgba(255,255,255,.06);border-radius:4px;overflow:hidden}
        .analytics-bar .ab-fill{height:100%;border-radius:4px}
        .analytics-bar .ab-count{font-size:13px;color:rgba(255,255,255,.5);width:40px;text-align:right;flex-shrink:0}
        .chart-container{background:rgba(255,255,255,.04);border-radius:14px;padding:20px;margin-bottom:24px}
        .chart-container canvas{width:100%;height:180px}
        .card-perf-item{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid rgba(255,255,255,.04)}
        .card-perf-item:last-child{border-bottom:none}
        .card-perf-name{font-size:14px;font-weight:500}
        .card-perf-stats{font-size:13px;color:rgba(255,255,255,.4)}

        /* â”€â”€ Storage Dashboard â”€â”€ */
        #storage{
            position:fixed;
            inset:0;
            background:#0f172a;
            overflow-y:auto;
            -webkit-overflow-scrolling:touch;
            display:none;
            padding:0;
            padding-bottom:calc(40px + env(safe-area-inset-bottom));
        }
        #storage.show{display:block}
        .storage-card{background:rgba(255,255,255,.04);border-radius:14px;padding:20px;margin-bottom:16px}
        .storage-card h4{font-size:14px;font-weight:600;color:rgba(255,255,255,.7);margin-bottom:12px}
        .storage-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.04)}
        .storage-row:last-child{border-bottom:none}
        .storage-label{font-size:13px;color:rgba(255,255,255,.5)}
        .storage-value{font-size:14px;font-weight:600;color:rgba(255,255,255,.8)}
        .storage-bar{margin-top:12px}
        .storage-bar-track{height:8px;background:rgba(255,255,255,.08);border-radius:4px;overflow:hidden}
        .storage-bar-fill{height:100%;border-radius:4px;background:linear-gradient(90deg,#2dd4bf,#14b8a6)}
        .storage-bar-label{display:flex;justify-content:space-between;font-size:11px;color:rgba(255,255,255,.4);margin-top:6px}
        .cost-free{color:#4ade80}
        .cost-paid{color:#fbbf24}
        .storage-note{font-size:12px;color:rgba(255,255,255,.35);margin-top:16px;line-height:1.6}

        /* â”€â”€ Review Queue â”€â”€ */
        #reviewQueue{
            position:fixed;
            inset:0;
            background:#0f172a;
            overflow-y:auto;
            -webkit-overflow-scrolling:touch;
            display:none;
            padding:0;
            padding-bottom:calc(40px + env(safe-area-inset-bottom));
        }
        #reviewQueue.show{display:block}
        .review-item{padding:20px;border-bottom:1px solid rgba(255,255,255,.06)}
        .review-img{width:100%;max-height:250px;object-fit:contain;border-radius:12px;background:rgba(0,0,0,.3);margin-bottom:16px}
        .review-ocr-btn{
            width:100%;
            padding:12px;
            border:none;
            border-radius:10px;
            background:rgba(99,102,241,.15);
            color:#818cf8;
            font-family:inherit;
            font-size:14px;
            font-weight:600;
            cursor:pointer;
            margin-bottom:16px;
            display:flex;
            align-items:center;
            justify-content:center;
            gap:8px;
        }
        .review-ocr-btn:active{transform:scale(.97)}
        .review-ocr-btn.scanning{opacity:.7}
        .review-ocr-btn svg{width:18px;height:18px;fill:currentColor}
        .review-field{margin-bottom:10px}
        .review-field label{display:block;font-size:11px;color:rgba(255,255,255,.4);margin-bottom:4px;text-transform:uppercase;letter-spacing:.5px}
        .review-field input{
            width:100%;
            padding:12px 14px;
            border:1px solid rgba(255,255,255,.1);
            border-radius:10px;
            background:rgba(255,255,255,.05);
            color:#fff;
            font-family:inherit;
            font-size:14px;
            outline:none;
        }
        .review-field input:focus{border-color:rgba(255,255,255,.25);background:rgba(255,255,255,.08)}
        .review-field input::placeholder{color:rgba(255,255,255,.25)}
        .review-actions{display:flex;gap:10px;margin-top:16px}
        .review-save{
            flex:1;
            padding:14px;
            border:none;
            border-radius:10px;
            background:rgba(34,197,94,.15);
            color:#4ade80;
            font-family:inherit;
            font-size:14px;
            font-weight:600;
            cursor:pointer;
        }
        .review-save:active{transform:scale(.97)}
        .review-skip{
            padding:14px 20px;
            border:none;
            border-radius:10px;
            background:rgba(255,255,255,.06);
            color:rgba(255,255,255,.5);
            font-family:inherit;
            font-size:14px;
            font-weight:500;
            cursor:pointer;
        }
        .review-skip:active{transform:scale(.97)}
        .review-time{font-size:11px;color:rgba(255,255,255,.3);margin-bottom:12px}
    </style>
</head>
<body>

    <div id="idle" class="screen">
        <div class="pulse-ring"><div class="nfc-icon"><svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 18H4V4h16v16zM18 6h-5c-1.1 0-2 .9-2 2v2.28c-.6.35-1 .98-1 1.72 0 1.1.9 2 2 2s2-.9 2-2c0-.74-.4-1.37-1-1.72V8h3v8H8V8h2V6H8c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2z"/></svg></div></div>
        <h2>Waiting for taps...</h2>
        <p>Keep open or add to home screen</p>
        <div class="tap-stats" id="tapStats"></div>
        <div class="qs-badge" id="qsBadge"></div>
        <div class="default-badge" id="defaultBadge"></div>

        <div class="qr-section" id="qrSection">
            <div class="qr-picker">
                <select id="qrCardSelect" onchange="generateQR()">
                    <option value="eximwala">Eximwala Solutions</option>
                    <option value="shippingbaba">ShippingBaba</option>
                    <option value="viexports">Vi Exports India</option>
                    <option value="devasya">Devasya City Center</option>
                </select>
            </div>
            <div class="qr-canvas-wrap" onclick="showFullscreenQR()">
                <canvas id="qrCanvas"></canvas>
            </div>
            <div class="qr-actions">
                <button class="qr-action-btn" id="copyLinkBtn" onclick="copyCardLink()">
                    <svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                    Copy Link
                </button>
                <button class="qr-action-btn" onclick="shareCardLink()">
                    <svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/></svg>
                    Share
                </button>
            </div>
        </div>

        <div class="idle-btns">
            <button class="idle-btn notif-off" id="notifBtn" onclick="requestNotif()">Enable notifications</button>
            <button class="idle-btn qs-btn" id="qsBtn" onclick="openQuickSend()">Quick Send</button>
            <button class="idle-btn default-btn" id="defaultBtn" onclick="openDefaultCard()">Default Card</button>
            <button class="idle-btn leads-btn" onclick="showLeads()">View leads</button>
            <button class="idle-btn analytics-btn" onclick="showAnalytics()">Analytics</button>
            <button class="idle-btn storage-btn" onclick="showStorage()">Storage</button>
            <button class="idle-btn review-btn" id="reviewBtn" onclick="showReviewQueue()">Review Cards</button>
        </div>
    </div>

    <div id="picker" class="screen hidden">
        <div class="pick-alert">NEW TAP</div>
        <div class="pick-title">Someone tapped your card!</div>
        <div class="pick-visitor" id="visitor-info"></div>
        <div class="pick-cards">
            <button class="pick-btn" style="background:linear-gradient(135deg,#1B1464,#0D0D3B)" onclick="selectCard('eximwala')">Eximwala Solutions<small>Director â€” Singapore</small></button>
            <button class="pick-btn" style="background:linear-gradient(135deg,#0E7490,#064E5E)" onclick="selectCard('shippingbaba')">ShippingBaba<small>Founder & CEO â€” Shipping</small></button>
            <button class="pick-btn" style="background:linear-gradient(135deg,#065F46,#043F2E)" onclick="selectCard('viexports')">Vi Exports India<small>Managing Director â€” Rice & Agri</small></button>
            <button class="pick-btn" style="background:linear-gradient(135deg,#8B6914,#5C4409)" onclick="selectCard('devasya')">Devasya City Center<small>Director â€” Real Estate, Delhi</small></button>
        </div>
    </div>

    <div id="sent" class="screen hidden">
        <div class="check"><svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg></div>
        <h2>Card sent!</h2>
        <div class="sent-sub" id="sent-detail"></div>
        <div class="sent-auto" id="sent-auto"></div>
        <div id="lead-display"></div>
        <button class="idle-btn leads-btn" style="margin-top:24px" onclick="show('idle');loadStats()">Back to waiting</button>
    </div>

    <!-- Leads Dashboard -->
    <div id="leads">
        <div class="leads-header">
            <button class="leads-back" onclick="hideLeads()"><svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg></button>
            <h2>Leads</h2>
            <span id="leads-count"></span>
        </div>
        <div class="leads-toolbar">
            <input class="leads-search" id="leadSearch" type="text" placeholder="Search leads, notes..." oninput="filterLeads()">
            <button class="csv-btn" onclick="exportCSV()">Export CSV</button>
        </div>
        <div class="filter-bar" id="filterBar">
            <button class="filter-chip active" data-filter="all" onclick="setFilter('all')">All</button>
            <button class="filter-chip" data-filter="status-new" onclick="setFilter('status-new')">New</button>
            <button class="filter-chip" data-filter="status-contacted" onclick="setFilter('status-contacted')">Contacted</button>
            <button class="filter-chip" data-filter="status-qualified" onclick="setFilter('status-qualified')">Qualified</button>
            <button class="filter-chip" data-filter="status-won" onclick="setFilter('status-won')">Won</button>
            <button class="filter-chip" data-filter="status-lost" onclick="setFilter('status-lost')">Lost</button>
            <button class="filter-chip" data-filter="tag-Hot Lead" onclick="setFilter('tag-Hot Lead')">Hot Lead</button>
            <button class="filter-chip" data-filter="tag-Follow Up" onclick="setFilter('tag-Follow Up')">Follow Up</button>
        </div>
        <div class="reminder-banner" id="reminderBanner"></div>
        <div id="leads-list"></div>
    </div>

    <!-- Analytics Dashboard -->
    <div id="analytics">
        <div class="analytics-header">
            <button class="leads-back" onclick="hideAnalytics()"><svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg></button>
            <h2>Analytics</h2>
        </div>
        <div class="analytics-content" id="analyticsContent">
            <div class="leads-empty">Loading analytics...</div>
        </div>
    </div>

    <!-- Storage Dashboard -->
    <div id="storage">
        <div class="analytics-header">
            <button class="leads-back" onclick="hideStorage()"><svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg></button>
            <h2>Firebase Storage</h2>
        </div>
        <div class="analytics-content" id="storageContent">
            <div class="leads-empty">Loading storage info...</div>
        </div>
    </div>

    <!-- Review Queue -->
    <div id="reviewQueue">
        <div class="analytics-header">
            <button class="leads-back" onclick="hideReviewQueue()"><svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg></button>
            <h2>Card Review Queue</h2>
            <span id="reviewCount"></span>
        </div>
        <div id="reviewList"></div>
    </div>

    <!-- Fullscreen QR -->
    <div class="qr-fullscreen" id="qrFullscreen" onclick="if(event.target===this)closeFullscreenQR()">
        <div class="qr-card-name" id="qrFullName"></div>
        <div class="qr-full-wrap">
            <canvas id="qrFullCanvas"></canvas>
        </div>
        <button class="qr-close" onclick="closeFullscreenQR()">Close</button>
    </div>

    <!-- Quick Send Modal -->
    <div class="qs-modal" id="qsModal" onclick="if(event.target===this)closeQuickSend()">
        <div class="qs-sheet">
            <h3>Quick Send</h3>
            <p class="qs-sub">Auto-send a card when someone taps â€” no picking needed</p>
            <button class="qs-opt" data-card="eximwala" onclick="setQuickSend('eximwala')">Eximwala Solutions<small>Director â€” Singapore</small></button>
            <button class="qs-opt" data-card="shippingbaba" onclick="setQuickSend('shippingbaba')">ShippingBaba<small>Founder & CEO â€” Shipping</small></button>
            <button class="qs-opt" data-card="viexports" onclick="setQuickSend('viexports')">Vi Exports India<small>Managing Director â€” Rice & Agri</small></button>
            <button class="qs-opt" data-card="devasya" onclick="setQuickSend('devasya')">Devasya City Center<small>Director â€” Real Estate, Delhi</small></button>
            <button class="qs-off" onclick="setQuickSend('')">Turn off Quick Send</button>
        </div>
    </div>

    <!-- Default Card Modal -->
    <div class="qs-modal" id="defaultModal" onclick="if(event.target===this)closeDefaultCard()">
        <div class="qs-sheet">
            <h3>Default Timeout Card</h3>
            <p class="qs-sub">Card shown to visitors if you don't respond in 45 seconds</p>
            <button class="qs-opt" data-default="eximwala" onclick="setDefaultCard('eximwala')">Eximwala Solutions<small>Director â€” Singapore</small></button>
            <button class="qs-opt" data-default="shippingbaba" onclick="setDefaultCard('shippingbaba')">ShippingBaba<small>Founder & CEO â€” Shipping</small></button>
            <button class="qs-opt" data-default="viexports" onclick="setDefaultCard('viexports')">Vi Exports India<small>Managing Director â€” Rice & Agri</small></button>
            <button class="qs-opt" data-default="devasya" onclick="setDefaultCard('devasya')">Devasya City Center<small>Director â€” Real Estate, Delhi</small></button>
            <button class="qs-off" onclick="setDefaultCard('')">No default (visitor waits)</button>
        </div>
    </div>

    <!-- Tag Modal -->
    <div class="tag-modal" id="tagModal" onclick="if(event.target===this)closeTagModal()">
        <div class="tag-sheet">
            <h3>Add Tags</h3>
            <div class="tag-options" id="tagOptions"></div>
            <div class="tag-custom">
                <input type="text" id="customTagInput" placeholder="Custom tag...">
                <button onclick="addCustomTag()">Add</button>
            </div>
            <button class="tag-done" onclick="saveTagsAndClose()">Done</button>
        </div>
    </div>

<script>
var DB = 'https://visiting-cards-8020e-default-rtdb.firebaseio.com';
var NAMES = {eximwala:'Eximwala Solutions',shippingbaba:'ShippingBaba',viexports:'Vi Exports India',devasya:'Devasya City Center'};
var CARD_COLORS = {eximwala:'#1B1464',shippingbaba:'#0E7490',viexports:'#065F46',devasya:'#8B6914'};
var BASE_URL = 'https://card.berryhuman.in';
var PRESET_TAGS = ['Hot Lead','Follow Up','Customer','Partner','Event'];
var STATUS_OPTIONS = ['new','contacted','qualified','won','lost'];
var STATUS_LABELS = {new:'New',contacted:'Contacted',qualified:'Qualified',won:'Won',lost:'Lost'};

var currentSession = null;
var ready = false;
var allLeads = [];
var activeFilter = 'all';
var tagModalLeadId = null;
var tagModalTags = [];

function show(id) {
    document.querySelectorAll('.screen').forEach(function(s){ s.classList.add('hidden'); });
    document.getElementById(id).classList.remove('hidden');
}

// â”€â”€ Wake Lock â”€â”€
var wakeLock = null;
function requestWakeLock() {
    if (!('wakeLock' in navigator)) return;
    navigator.wakeLock.request('screen').then(function(wl){ wakeLock = wl; }).catch(function(){});
}
document.addEventListener('visibilitychange', function(){
    if (document.visibilityState === 'visible') requestWakeLock();
});
requestWakeLock();

// â”€â”€ Notifications (Safari-compatible) â”€â”€
function requestNotif() {
    if (!('Notification' in window)) {
        alert('Notifications not supported on this device');
        return;
    }

    // If already denied, show instructions
    if (Notification.permission === 'denied') {
        var isIOS = /iPhone|iPad|iPod/.test(navigator.userAgent);
        var isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);
        var msg = 'Notifications are blocked.\n\nTo enable:\n';
        if (isIOS && isSafari) {
            msg += '1. Open Settings app\n2. Scroll to Safari\n3. Tap Notifications\n4. Allow for this website';
        } else if (/Android/.test(navigator.userAgent)) {
            msg += '1. Tap the lock icon (ðŸ”’) in the URL bar\n2. Tap "Site settings"\n3. Set Notifications to "Allow"';
        } else {
            msg += '1. Click the lock icon (ðŸ”’) in the URL bar\n2. Find "Notifications"\n3. Change to "Allow"';
        }
        alert(msg);
        return;
    }

    // Safari uses callback, others use Promise
    var result = Notification.requestPermission(function(permission) {
        updateNotifUI(permission);
    });
    // Modern browsers return Promise
    if (result && result.then) {
        result.then(updateNotifUI);
    }
}

function updateNotifUI(permission) {
    var perm = permission || (('Notification' in window) ? Notification.permission : 'default');
    var b = document.getElementById('notifBtn');
    if (perm === 'granted') {
        b.className = 'idle-btn notif-on';
        b.textContent = 'Notifications on';
    } else if (perm === 'denied') {
        b.className = 'idle-btn notif-off';
        b.textContent = 'Blocked in settings';
    } else {
        // 'default' - not yet asked
        b.className = 'idle-btn notif-off';
        b.textContent = 'Enable notifications';
    }
}

function notify(title, body) {
    if (!('Notification' in window) || Notification.permission !== 'granted') return;
    if (navigator.serviceWorker && navigator.serviceWorker.controller) {
        navigator.serviceWorker.ready.then(function(reg) {
            reg.showNotification(title || 'Someone tapped your card!', {
                body: body || 'Tap to select which card to share',
                vibrate: [100,50,100,50,200],
                tag: 'nfc-tap',
                requireInteraction: true,
                renotify: true
            });
        });
    } else {
        var n = new Notification(title, {body:body,tag:'nfc-tap',requireInteraction:true});
        n.onclick = function(){ window.focus(); n.close(); };
    }
}

function buzz() {
    if (navigator.vibrate) navigator.vibrate([100,50,100,50,200]);
    try {
        var ctx = new (window.AudioContext||window.webkitAudioContext)();
        var o = ctx.createOscillator(), g = ctx.createGain();
        o.connect(g); g.connect(ctx.destination);
        o.frequency.value = 880; o.type = 'sine'; g.gain.value = 0.3;
        o.start(); g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.3);
        o.stop(ctx.currentTime+0.3);
    } catch(e){}
}

// â”€â”€ Tap Stats â”€â”€
function loadStats() {
    fetch(DB+'/leads.json?shallow=true').then(function(r){return r.json()}).then(function(data) {
        var count = data ? Object.keys(data).length : 0;
        document.getElementById('tapStats').innerHTML = '<div class="stat"><div class="num">'+count+'</div><div class="lbl">Total Leads</div></div>';
    }).catch(function(){});
}
loadStats();

// â”€â”€ QR Code Generation â”€â”€
function generateQR() {
    var cardId = document.getElementById('qrCardSelect').value;
    var url = BASE_URL + '?c=' + cardId;
    var canvas = document.getElementById('qrCanvas');
    QRCode.toCanvas(canvas, url, {width:180,margin:1,color:{dark:'#1B1464',light:'#ffffff'}}, function(err){
        if(err) console.log(err);
    });
}

function showFullscreenQR() {
    var cardId = document.getElementById('qrCardSelect').value;
    var url = BASE_URL + '?c=' + cardId;
    document.getElementById('qrFullName').textContent = NAMES[cardId];
    var canvas = document.getElementById('qrFullCanvas');
    QRCode.toCanvas(canvas, url, {width:280,margin:1,color:{dark:'#1B1464',light:'#ffffff'}}, function(err){
        if(err) console.log(err);
    });
    document.getElementById('qrFullscreen').classList.add('show');
}

function closeFullscreenQR() {
    document.getElementById('qrFullscreen').classList.remove('show');
}

function copyCardLink() {
    var cardId = document.getElementById('qrCardSelect').value;
    var url = BASE_URL + '?c=' + cardId;
    navigator.clipboard.writeText(url).then(function(){
        var btn = document.getElementById('copyLinkBtn');
        btn.classList.add('copied');
        btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>Copied!';
        setTimeout(function(){
            btn.classList.remove('copied');
            btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>Copy Link';
        },2000);
    });
}

function shareCardLink() {
    var cardId = document.getElementById('qrCardSelect').value;
    var url = BASE_URL + '?c=' + cardId;
    if (navigator.share) {
        navigator.share({title:NAMES[cardId]+' â€” Digital Card',url:url}).catch(function(){});
    } else {
        copyCardLink();
    }
}

setTimeout(generateQR, 100);

// â”€â”€ Quick Send â”€â”€
function getQuickSend() { return localStorage.getItem('quickSendCard') || ''; }
function updateQsBadge() {
    var qs = getQuickSend();
    var badge = document.getElementById('qsBadge');
    var btn = document.getElementById('qsBtn');
    if (qs && NAMES[qs]) {
        badge.textContent = 'Auto: ' + NAMES[qs];
        badge.classList.add('show');
        btn.className = 'idle-btn qs-active';
        btn.textContent = 'Quick Send: ON';
    } else {
        badge.classList.remove('show');
        btn.className = 'idle-btn qs-btn';
        btn.textContent = 'Quick Send';
    }
    document.querySelectorAll('.qs-opt').forEach(function(o){
        o.classList.toggle('selected', o.dataset.card === qs);
    });
}
function openQuickSend() { document.getElementById('qsModal').classList.add('show'); updateQsBadge(); }
function closeQuickSend() { document.getElementById('qsModal').classList.remove('show'); }
function setQuickSend(card) {
    if (card) localStorage.setItem('quickSendCard', card);
    else localStorage.removeItem('quickSendCard');
    updateQsBadge();
    closeQuickSend();
}
updateQsBadge();

// â”€â”€ Default Card (for timeout) â”€â”€
var currentDefaultCard = '';
function loadDefaultCard() {
    fetch(DB+'/settings/defaultCard.json').then(function(r){return r.json()}).then(function(card) {
        currentDefaultCard = card || '';
        updateDefaultBadge();
    }).catch(function(){});
}
function updateDefaultBadge() {
    var badge = document.getElementById('defaultBadge');
    var btn = document.getElementById('defaultBtn');
    if (currentDefaultCard && NAMES[currentDefaultCard]) {
        badge.textContent = 'Timeout: ' + NAMES[currentDefaultCard];
        badge.classList.add('show');
        btn.className = 'idle-btn default-active';
        btn.textContent = 'Default: ON';
    } else {
        badge.textContent = 'Timeout: No default';
        badge.classList.add('show');
        btn.className = 'idle-btn default-btn';
        btn.textContent = 'Default Card';
    }
    document.querySelectorAll('[data-default]').forEach(function(o){
        o.classList.toggle('selected', o.dataset.default === currentDefaultCard);
    });
}
function openDefaultCard() { document.getElementById('defaultModal').classList.add('show'); updateDefaultBadge(); }
function closeDefaultCard() { document.getElementById('defaultModal').classList.remove('show'); }
function setDefaultCard(card) {
    currentDefaultCard = card;
    fetch(DB+'/settings/defaultCard.json',{method:'PUT',body:JSON.stringify(card || null)});
    updateDefaultBadge();
    closeDefaultCard();
}
loadDefaultCard();

// â”€â”€ Listen for taps â”€â”€
var es = new EventSource(DB+'/latest.json');
es.addEventListener('put', function(e) {
    var d = JSON.parse(e.data);
    var val = d.data;
    if (!val || !val.sessionId) return;
    if (!ready) { ready = true; return; }

    currentSession = val.sessionId;
    var vi = val.visitor;
    document.getElementById('visitor-info').textContent = vi ? (vi.device+' Â· '+vi.browser) : '';
    buzz();

    var qs = getQuickSend();
    if (qs && NAMES[qs]) {
        notify('Card auto-sent!', NAMES[qs]+' shared via Quick Send');
        selectCard(qs, true);
        return;
    }

    notify('Someone tapped your card!','Tap to select which card to share');
    show('picker');
});

// â”€â”€ Select card â”€â”€
function selectCard(cardId, auto) {
    if (!currentSession) return;
    fetch(DB+'/taps/'+currentSession+'.json',{method:'PATCH',body:JSON.stringify({card:cardId,status:'selected'})});
    fetch(DB+'/leads/'+currentSession+'/card.json',{method:'PUT',body:JSON.stringify(cardId)});

    document.getElementById('sent-detail').textContent = NAMES[cardId]+' card shared';
    document.getElementById('sent-auto').textContent = auto ? '(Quick Send)' : '';
    document.getElementById('lead-display').innerHTML = '';
    show('sent');
    loadStats();

    var sid = currentSession;
    var leadES = new EventSource(DB+'/leads/'+sid+'.json');
    function handleLead(ev) {
        var d = JSON.parse(ev.data);
        var lead = d.data;
        if (!lead) return;
        if (typeof lead === 'string') return;
        if (!lead.name && !lead.phone && !lead.email) return;
        leadES.close();
        buzz();
        notify('Lead received!', lead.name + (lead.company?' â€” '+lead.company:''));

        var html = '<div class="lead-card"><div class="lc-label">Lead received</div>';
        if (lead.name) html += '<div class="lc-name">'+lead.name+'</div>';
        if (lead.company) html += '<div class="lc-company">'+lead.company+'</div>';
        html += '<div class="lc-contact">';
        if (lead.phone) html += '<div><a href="tel:'+lead.phone+'">'+lead.phone+'</a></div>';
        if (lead.email) html += '<div><a href="mailto:'+lead.email+'">'+lead.email+'</a></div>';
        html += '</div>';
        if (lead.photo) html += '<img src="'+lead.photo+'">';
        html += '<div class="lead-actions"><button class="save-lead-btn" onclick="saveLead(\''+esc(lead.name||'')+'\',\''+esc(lead.phone||'')+'\',\''+esc(lead.email||'')+'\',\''+esc(lead.company||'')+'\')"><svg viewBox="0 0 24 24"><path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2v9.67z"/></svg>Save to Contacts</button></div>';
        html += '</div>';
        document.getElementById('lead-display').innerHTML = html;
    }
    leadES.addEventListener('put', handleLead);
    leadES.addEventListener('patch', handleLead);
    setTimeout(function(){ leadES.close(); },60000);
}

// â”€â”€ Leads Dashboard â”€â”€
function showLeads() {
    var panel = document.getElementById('leads');
    panel.classList.add('show');
    panel.style.display = 'block';
    document.getElementById('leads-list').innerHTML = '<div class="leads-empty">Loading...</div>';
    document.getElementById('leadSearch').value = '';
    activeFilter = 'all';
    document.querySelectorAll('.filter-chip').forEach(function(c){ c.classList.toggle('active', c.dataset.filter === 'all'); });

    fetch(DB+'/leads.json').then(function(r){return r.json()}).then(function(data) {
        if (!data) { allLeads=[]; renderLeads([]); return; }

        var items = [];
        for (var k in data) {
            var l = data[k];
            if (!l || (!l.name && !l.phone && !l.email)) continue;
            l._id = k;
            if (!l.status) l.status = 'new';
            if (!l.tags) l.tags = [];
            if (typeof l.tags === 'string') l.tags = [l.tags];
            items.push(l);
        }

        items.sort(function(a,b){ return (b.ts||0)-(a.ts||0); });
        allLeads = items;
        renderLeads(items);
        checkReminders();
    }).catch(function(){
        document.getElementById('leads-list').innerHTML = '<div class="leads-empty">Failed to load</div>';
    });
}

function renderLeads(items) {
    var list = document.getElementById('leads-list');
    document.getElementById('leads-count').textContent = items.length+' total';
    if (items.length === 0) { list.innerHTML = '<div class="leads-empty">No leads yet</div>'; return; }

    var html = '';
    items.forEach(function(l) {
        var statusClass = 'status-'+(l.status||'new');
        var statusLabel = STATUS_LABELS[l.status||'new'] || 'New';

        html += '<div class="lead-item" data-id="'+l._id+'"><div class="li-top"><div>';
        if (l.name) html += '<div class="li-name">'+l.name+'</div>';
        if (l.company) html += '<div class="li-company">'+l.company+'</div>';
        html += '</div><div style="display:flex;gap:6px;align-items:center">';
        if (l.card && NAMES[l.card]) html += '<span class="li-card-badge">'+NAMES[l.card]+'</span>';
        html += '<button class="status-badge '+statusClass+'" onclick="cycleStatus(\''+l._id+'\')">'+statusLabel+'</button>';
        html += '</div></div>';

        html += '<div class="li-contact">';
        if (l.phone) html += '<div><a href="tel:'+l.phone+'">'+l.phone+'</a></div>';
        if (l.email) html += '<div><a href="mailto:'+l.email+'">'+l.email+'</a></div>';
        html += '</div>';

        if (l.ts) {
            var d = new Date(l.ts);
            html += '<div class="li-time">'+d.toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'})+' '+d.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'});
            if (l.source) html += '<span class="li-source">'+l.source+'</span>';
            html += '</div>';
        }

        html += '<div class="tag-row">';
        if (l.tags && l.tags.length) {
            l.tags.forEach(function(t){
                html += '<span class="tag-chip" onclick="removeTag(\''+l._id+'\',\''+esc(t)+'\')">'+t+' Ã—</span>';
            });
        }
        html += '<button class="add-tag-btn" onclick="openTagModal(\''+l._id+'\')">+ Tag</button></div>';

        html += '<div class="lead-note"><textarea placeholder="Add notes..." onblur="saveNote(\''+l._id+'\',this)" rows="1">'+(l.notes||'')+'</textarea><div class="lead-note-saved" id="note-saved-'+l._id+'">Saved</div></div>';

        html += '<div class="lead-reminder">';
        if (l.reminder && l.reminder.date && !l.reminder.done) {
            html += '<span class="remind-set">Reminder: '+l.reminder.date+'</span>';
            html += '<button class="remind-btn" onclick="dismissReminder(\''+l._id+'\')">Done</button>';
        } else {
            html += '<input type="date" id="remind-date-'+l._id+'">';
            html += '<button class="remind-btn" onclick="setReminder(\''+l._id+'\')">Remind me</button>';
        }
        html += '</div>';

        if (l.photo) html += '<img class="li-photo" src="'+l.photo+'">';

        html += '<div class="lead-actions">';
        html += '<button class="save-lead-btn" onclick="saveLead(\''+esc(l.name||'')+'\',\''+esc(l.phone||'')+'\',\''+esc(l.email||'')+'\',\''+esc(l.company||'')+'\')"><svg viewBox="0 0 24 24"><path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2v9.67z"/></svg>Save</button>';
        html += '<button class="del-lead-btn" onclick="deleteLead(\''+l._id+'\')"><svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>Delete</button>';
        html += '</div></div>';
    });
    list.innerHTML = html;
}

function filterLeads() {
    var q = document.getElementById('leadSearch').value.toLowerCase().trim();
    var filtered = allLeads;

    if (activeFilter !== 'all') {
        if (activeFilter.indexOf('status-') === 0) {
            var st = activeFilter.replace('status-','');
            filtered = filtered.filter(function(l){ return (l.status||'new') === st; });
        } else if (activeFilter.indexOf('tag-') === 0) {
            var tag = activeFilter.replace('tag-','');
            filtered = filtered.filter(function(l){ return l.tags && l.tags.indexOf(tag) !== -1; });
        }
    }

    if (q) {
        filtered = filtered.filter(function(l){
            return (l.name||'').toLowerCase().indexOf(q)!==-1 ||
                   (l.company||'').toLowerCase().indexOf(q)!==-1 ||
                   (l.phone||'').indexOf(q)!==-1 ||
                   (l.email||'').toLowerCase().indexOf(q)!==-1 ||
                   (l.notes||'').toLowerCase().indexOf(q)!==-1;
        });
    }
    renderLeads(filtered);
}

function setFilter(f) {
    activeFilter = f;
    document.querySelectorAll('.filter-chip').forEach(function(c){ c.classList.toggle('active', c.dataset.filter === f); });
    filterLeads();
}

function cycleStatus(id) {
    var lead = allLeads.find(function(l){ return l._id === id; });
    if (!lead) return;
    var idx = STATUS_OPTIONS.indexOf(lead.status||'new');
    var next = STATUS_OPTIONS[(idx+1) % STATUS_OPTIONS.length];
    lead.status = next;
    fetch(DB+'/leads/'+id+'/status.json',{method:'PUT',body:JSON.stringify(next)});
    filterLeads();
}

function saveNote(id, textarea) {
    var note = textarea.value.trim();
    var lead = allLeads.find(function(l){ return l._id === id; });
    if (lead) lead.notes = note;
    fetch(DB+'/leads/'+id+'/notes.json',{method:'PUT',body:JSON.stringify(note)});
    var saved = document.getElementById('note-saved-'+id);
    if (saved) { saved.style.display = 'block'; setTimeout(function(){ saved.style.display = 'none'; },1500); }
}

function openTagModal(id) {
    tagModalLeadId = id;
    var lead = allLeads.find(function(l){ return l._id === id; });
    tagModalTags = lead && lead.tags ? lead.tags.slice() : [];

    var html = '';
    PRESET_TAGS.forEach(function(t){
        var sel = tagModalTags.indexOf(t) !== -1 ? ' selected' : '';
        html += '<button class="tag-option'+sel+'" onclick="toggleTagOption(this,\''+esc(t)+'\')">'+t+'</button>';
    });
    document.getElementById('tagOptions').innerHTML = html;
    document.getElementById('customTagInput').value = '';
    document.getElementById('tagModal').classList.add('show');
}
function closeTagModal() { document.getElementById('tagModal').classList.remove('show'); }

function toggleTagOption(btn, tag) {
    var idx = tagModalTags.indexOf(tag);
    if (idx !== -1) { tagModalTags.splice(idx,1); btn.classList.remove('selected'); }
    else { tagModalTags.push(tag); btn.classList.add('selected'); }
}

function addCustomTag() {
    var input = document.getElementById('customTagInput');
    var tag = input.value.trim();
    if (!tag || tagModalTags.indexOf(tag) !== -1) return;
    tagModalTags.push(tag);
    input.value = '';
    var opts = document.getElementById('tagOptions');
    opts.innerHTML += '<button class="tag-option selected" onclick="toggleTagOption(this,\''+esc(tag)+'\')">'+tag+'</button>';
}

function saveTagsAndClose() {
    if (!tagModalLeadId) return;
    var lead = allLeads.find(function(l){ return l._id === tagModalLeadId; });
    if (lead) lead.tags = tagModalTags.slice();
    fetch(DB+'/leads/'+tagModalLeadId+'/tags.json',{method:'PUT',body:JSON.stringify(tagModalTags)});
    closeTagModal();
    filterLeads();
}

function removeTag(id, tag) {
    var lead = allLeads.find(function(l){ return l._id === id; });
    if (!lead || !lead.tags) return;
    var idx = lead.tags.indexOf(tag);
    if (idx !== -1) lead.tags.splice(idx,1);
    fetch(DB+'/leads/'+id+'/tags.json',{method:'PUT',body:JSON.stringify(lead.tags)});
    filterLeads();
}

function setReminder(id) {
    var input = document.getElementById('remind-date-'+id);
    if (!input || !input.value) return;
    var reminder = {date:input.value, done:false};
    var lead = allLeads.find(function(l){ return l._id === id; });
    if (lead) lead.reminder = reminder;
    fetch(DB+'/leads/'+id+'/reminder.json',{method:'PUT',body:JSON.stringify(reminder)});
    filterLeads();
}

function dismissReminder(id) {
    var lead = allLeads.find(function(l){ return l._id === id; });
    if (lead && lead.reminder) lead.reminder.done = true;
    fetch(DB+'/leads/'+id+'/reminder.json',{method:'PUT',body:JSON.stringify({date:lead.reminder.date,done:true})});
    filterLeads();
    checkReminders();
}

function checkReminders() {
    var today = new Date().toISOString().slice(0,10);
    var overdue = allLeads.filter(function(l){
        return l.reminder && l.reminder.date && !l.reminder.done && l.reminder.date <= today;
    });
    var banner = document.getElementById('reminderBanner');
    if (overdue.length === 0) { banner.classList.remove('show'); banner.innerHTML = ''; return; }

    var html = '<div class="reminder-banner-title">Overdue Reminders ('+overdue.length+')</div>';
    overdue.forEach(function(l){
        html += '<div class="reminder-item"><span>'+(l.name||'Unknown')+' â€” '+l.reminder.date+'</span><button class="reminder-dismiss" onclick="dismissReminder(\''+l._id+'\')">Dismiss</button></div>';
    });
    banner.innerHTML = html;
    banner.classList.add('show');

    if ('Notification' in window && Notification.permission === 'granted' && overdue.length > 0) {
        notify('Follow-up Reminder', overdue.length+' lead(s) need follow-up today');
    }
}

setInterval(function(){
    if (allLeads.length > 0) checkReminders();
}, 60000);

function deleteLead(id) {
    if (!confirm('Delete this lead?')) return;
    fetch(DB+'/leads/'+id+'.json',{method:'DELETE'}).then(function(){
        var el = document.querySelector('.lead-item[data-id="'+id+'"]');
        if (el) { el.style.opacity='0'; setTimeout(function(){el.remove()},200); }
        allLeads = allLeads.filter(function(l){ return l._id !== id; });
        document.getElementById('leads-count').textContent = allLeads.length+' total';
        if (allLeads.length === 0) document.getElementById('leads-list').innerHTML = '<div class="leads-empty">No leads yet</div>';
        loadStats();
    });
}

function exportCSV() {
    if (!allLeads.length) { alert('No leads to export'); return; }
    var rows = [['Name','Phone','Email','Company','Card','Status','Tags','Notes','Source','Date']];
    allLeads.forEach(function(l){
        var date = l.ts ? new Date(l.ts).toISOString() : '';
        rows.push([
            '"'+(l.name||'').replace(/"/g,'""')+'"',
            '"'+(l.phone||'')+'"',
            '"'+(l.email||'')+'"',
            '"'+(l.company||'').replace(/"/g,'""')+'"',
            '"'+(NAMES[l.card]||l.card||'')+'"',
            '"'+(STATUS_LABELS[l.status]||'New')+'"',
            '"'+((l.tags||[]).join(', ')).replace(/"/g,'""')+'"',
            '"'+(l.notes||'').replace(/"/g,'""')+'"',
            '"'+(l.source||'nfc')+'"',
            '"'+date+'"'
        ]);
    });
    var csv = rows.map(function(r){return r.join(',')}).join('\n');
    var blob = new Blob([csv],{type:'text/csv;charset=utf-8'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url; a.download = 'leads_'+new Date().toISOString().slice(0,10)+'.csv';
    document.body.appendChild(a); a.click();
    setTimeout(function(){ document.body.removeChild(a); URL.revokeObjectURL(url); },100);
}

function hideLeads() {
    document.getElementById('leads').style.display = 'none';
    document.getElementById('leads').classList.remove('show');
}

// â”€â”€ Analytics Dashboard â”€â”€
function showAnalytics() {
    var panel = document.getElementById('analytics');
    panel.classList.add('show');
    panel.style.display = 'block';
    document.getElementById('analyticsContent').innerHTML = '<div class="leads-empty">Loading analytics...</div>';
    loadAnalyticsData();
}

function hideAnalytics() {
    document.getElementById('analytics').style.display = 'none';
    document.getElementById('analytics').classList.remove('show');
}

function loadAnalyticsData() {
    Promise.all([
        fetch(DB+'/analytics.json').then(function(r){return r.json()}),
        fetch(DB+'/leads.json').then(function(r){return r.json()})
    ]).then(function(results) {
        var analytics = results[0] || {};
        var leads = results[1] || {};
        renderAnalytics(analytics, leads);
    }).catch(function(){
        document.getElementById('analyticsContent').innerHTML = '<div class="leads-empty">Failed to load analytics</div>';
    });
}

function renderAnalytics(analytics, leads) {
    var totalViews = 0, totalClicks = 0, totalLeads = 0;
    var sourceCount = {nfc:0,qr:0,link:0,timeout:0};
    var clickCount = {call:0,email:0,whatsapp:0,linkedin:0,instagram:0,twitter:0,save_contact:0,website:0};
    var cardViews = {};
    var cardClicks = {};
    var dailyViews = {};

    for (var k in leads) {
        if (leads[k] && (leads[k].name || leads[k].phone || leads[k].email)) totalLeads++;
    }

    var cardIds = ['eximwala','shippingbaba','viexports','devasya'];
    cardIds.forEach(function(cid) {
        var cardData = analytics[cid] || {};
        cardViews[cid] = 0;
        cardClicks[cid] = 0;

        var views = cardData.views || {};
        for (var vk in views) {
            totalViews++;
            cardViews[cid]++;
            var v = views[vk];
            if (v.source && sourceCount.hasOwnProperty(v.source)) sourceCount[v.source]++;
            if (v.ts) {
                var day = new Date(v.ts).toISOString().slice(0,10);
                dailyViews[day] = (dailyViews[day]||0) + 1;
            }
        }

        var clicks = cardData.clicks || {};
        for (var ck in clicks) {
            totalClicks++;
            cardClicks[cid]++;
            var cl = clicks[ck];
            if (cl.action && clickCount.hasOwnProperty(cl.action)) clickCount[cl.action]++;
        }
    });

    var convRate = totalViews > 0 ? Math.round((totalLeads/totalViews)*100) : 0;

    var html = '';
    html += '<div class="analytics-grid">';
    html += '<div class="analytics-card"><div class="ac-num">'+totalViews+'</div><div class="ac-label">Total Views</div></div>';
    html += '<div class="analytics-card"><div class="ac-num">'+totalClicks+'</div><div class="ac-label">Total Clicks</div></div>';
    html += '<div class="analytics-card"><div class="ac-num">'+totalLeads+'</div><div class="ac-label">Leads Captured</div></div>';
    html += '<div class="analytics-card"><div class="ac-num">'+convRate+'%</div><div class="ac-label">Conversion Rate</div></div>';
    html += '</div>';

    html += '<div class="chart-container"><canvas id="viewsChart" width="400" height="180"></canvas></div>';

    html += '<div class="analytics-section"><h3>Views by Source</h3>';
    var maxSource = Math.max(sourceCount.nfc, sourceCount.qr, sourceCount.link, 1);
    html += makeBar('NFC', sourceCount.nfc, maxSource, '#60a5fa');
    html += makeBar('QR Code', sourceCount.qr, maxSource, '#a78bfa');
    html += makeBar('Direct Link', sourceCount.link, maxSource, '#34d399');
    html += makeBar('Timeout', sourceCount.timeout, maxSource, '#fb923c');
    html += '</div>';

    html += '<div class="analytics-section"><h3>Click Breakdown</h3>';
    var actions = ['call','whatsapp','email','website','linkedin','save_contact'];
    var actionLabels = {call:'Call',whatsapp:'WhatsApp',email:'Email',website:'Website',linkedin:'LinkedIn',save_contact:'Save Contact'};
    var maxClick = Math.max.apply(null, actions.map(function(a){return clickCount[a]||0}).concat([1]));
    var actionColors = {call:'#60a5fa',whatsapp:'#4ade80',email:'#fbbf24',website:'#a78bfa',linkedin:'#38bdf8',save_contact:'#f472b6'};
    actions.forEach(function(a){
        html += makeBar(actionLabels[a], clickCount[a]||0, maxClick, actionColors[a]||'#60a5fa');
    });
    html += '</div>';

    html += '<div class="analytics-section"><h3>Card Performance</h3>';
    cardIds.forEach(function(cid){
        html += '<div class="card-perf-item"><span class="card-perf-name" style="color:'+CARD_COLORS[cid]+'">'+NAMES[cid]+'</span><span class="card-perf-stats">'+
            (cardViews[cid]||0)+' views Â· '+(cardClicks[cid]||0)+' clicks</span></div>';
    });
    html += '</div>';

    document.getElementById('analyticsContent').innerHTML = html;
    setTimeout(function(){ drawDailyChart(dailyViews); }, 50);
}

function makeBar(label, count, max, color) {
    var pct = max > 0 ? Math.round((count/max)*100) : 0;
    return '<div class="analytics-bar"><span class="ab-label">'+label+'</span><div class="ab-track"><div class="ab-fill" style="width:'+pct+'%;background:'+color+'"></div></div><span class="ab-count">'+count+'</span></div>';
}

function drawDailyChart(dailyViews) {
    var canvas = document.getElementById('viewsChart');
    if (!canvas) return;
    var ctx = canvas.getContext('2d');
    var w = canvas.parentElement.clientWidth - 40;
    canvas.width = w * 2;
    canvas.height = 180 * 2;
    canvas.style.width = w + 'px';
    canvas.style.height = '180px';
    ctx.scale(2,2);

    var days = [];
    var labels = [];
    var values = [];
    for (var i = 6; i >= 0; i--) {
        var d = new Date();
        d.setDate(d.getDate() - i);
        var key = d.toISOString().slice(0,10);
        days.push(key);
        labels.push(d.toLocaleDateString('en-IN',{day:'numeric',month:'short'}));
        values.push(dailyViews[key] || 0);
    }

    var maxVal = Math.max.apply(null, values.concat([1]));
    var chartW = w - 50;
    var chartH = 140;
    var startX = 40;
    var startY = 10;

    ctx.strokeStyle = 'rgba(255,255,255,0.06)';
    ctx.lineWidth = 0.5;
    for (var g = 0; g <= 4; g++) {
        var gy = startY + chartH - (g/4)*chartH;
        ctx.beginPath();
        ctx.moveTo(startX, gy);
        ctx.lineTo(startX + chartW, gy);
        ctx.stroke();
    }

    ctx.fillStyle = 'rgba(255,255,255,0.3)';
    ctx.font = '10px Inter';
    ctx.textAlign = 'right';
    for (var g = 0; g <= 4; g++) {
        var val = Math.round((g/4)*maxVal);
        var gy = startY + chartH - (g/4)*chartH;
        ctx.fillText(val, startX - 8, gy + 3);
    }

    var barW = chartW / 7;
    ctx.beginPath();
    var points = [];
    for (var i = 0; i < 7; i++) {
        var x = startX + barW * i + barW/2;
        var y = startY + chartH - (values[i]/maxVal)*chartH;
        points.push({x:x,y:y});
        if (i === 0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
    }
    ctx.strokeStyle = '#60a5fa';
    ctx.lineWidth = 2;
    ctx.stroke();

    ctx.lineTo(points[6].x, startY + chartH);
    ctx.lineTo(points[0].x, startY + chartH);
    ctx.closePath();
    var gradient = ctx.createLinearGradient(0, startY, 0, startY + chartH);
    gradient.addColorStop(0, 'rgba(96,165,250,0.2)');
    gradient.addColorStop(1, 'rgba(96,165,250,0)');
    ctx.fillStyle = gradient;
    ctx.fill();

    points.forEach(function(p){
        ctx.beginPath();
        ctx.arc(p.x, p.y, 4, 0, Math.PI*2);
        ctx.fillStyle = '#60a5fa';
        ctx.fill();
    });

    ctx.fillStyle = 'rgba(255,255,255,0.35)';
    ctx.font = '10px Inter';
    ctx.textAlign = 'center';
    for (var i = 0; i < 7; i++) {
        ctx.fillText(labels[i], startX + barW*i + barW/2, startY + chartH + 18);
    }
}

// â”€â”€ Storage Dashboard â”€â”€
function showStorage() {
    var panel = document.getElementById('storage');
    panel.classList.add('show');
    panel.style.display = 'block';
    document.getElementById('storageContent').innerHTML = '<div class="leads-empty">Calculating storage...</div>';
    loadStorageData();
}

function hideStorage() {
    document.getElementById('storage').style.display = 'none';
    document.getElementById('storage').classList.remove('show');
}

function loadStorageData() {
    // Fetch all data to calculate size
    Promise.all([
        fetch(DB+'/leads.json').then(function(r){return r.text()}),
        fetch(DB+'/taps.json').then(function(r){return r.text()}),
        fetch(DB+'/analytics.json').then(function(r){return r.text()}),
        fetch(DB+'/settings.json').then(function(r){return r.text()}),
        fetch(DB+'/latest.json').then(function(r){return r.text()})
    ]).then(function(results) {
        var leadsData = results[0] || '{}';
        var tapsData = results[1] || '{}';
        var analyticsData = results[2] || '{}';
        var settingsData = results[3] || '{}';
        var latestData = results[4] || '{}';

        // Calculate sizes in bytes
        var leadsSize = new Blob([leadsData]).size;
        var tapsSize = new Blob([tapsData]).size;
        var analyticsSize = new Blob([analyticsData]).size;
        var settingsSize = new Blob([settingsData]).size;
        var latestSize = new Blob([latestData]).size;
        var totalSize = leadsSize + tapsSize + analyticsSize + settingsSize + latestSize;

        // Count records
        var leads = JSON.parse(leadsData) || {};
        var taps = JSON.parse(tapsData) || {};
        var leadsCount = Object.keys(leads).length;
        var tapsCount = Object.keys(taps).length;

        // Firebase free tier: 1 GB storage, 10 GB/month download
        var freeStorageLimit = 1024 * 1024 * 1024; // 1 GB
        var freeDownloadLimit = 10 * 1024 * 1024 * 1024; // 10 GB
        var storagePercent = (totalSize / freeStorageLimit) * 100;

        // Estimated monthly downloads (rough: assume 100 page loads * total data)
        var estimatedMonthlyDownload = totalSize * 100;
        var downloadPercent = (estimatedMonthlyDownload / freeDownloadLimit) * 100;

        // Cost calculation (Blaze plan: $5/GB stored, $1/GB downloaded beyond free tier)
        var storageCost = totalSize > freeStorageLimit ? ((totalSize - freeStorageLimit) / (1024*1024*1024)) * 5 : 0;
        var downloadCost = estimatedMonthlyDownload > freeDownloadLimit ? ((estimatedMonthlyDownload - freeDownloadLimit) / (1024*1024*1024)) * 1 : 0;
        var totalCost = storageCost + downloadCost;

        renderStorage({
            leadsSize: leadsSize,
            tapsSize: tapsSize,
            analyticsSize: analyticsSize,
            settingsSize: settingsSize,
            totalSize: totalSize,
            leadsCount: leadsCount,
            tapsCount: tapsCount,
            storagePercent: storagePercent,
            downloadPercent: downloadPercent,
            estimatedMonthlyDownload: estimatedMonthlyDownload,
            storageCost: storageCost,
            downloadCost: downloadCost,
            totalCost: totalCost,
            freeStorageLimit: freeStorageLimit,
            freeDownloadLimit: freeDownloadLimit
        });
    }).catch(function(err){
        document.getElementById('storageContent').innerHTML = '<div class="leads-empty">Failed to load storage data</div>';
    });
}

function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    var k = 1024;
    var sizes = ['B', 'KB', 'MB', 'GB'];
    var i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function renderStorage(data) {
    var html = '';

    // Storage Overview
    html += '<div class="storage-card"><h4>Storage Used</h4>';
    html += '<div class="storage-row"><span class="storage-label">Leads data</span><span class="storage-value">'+formatBytes(data.leadsSize)+'</span></div>';
    html += '<div class="storage-row"><span class="storage-label">Tap sessions</span><span class="storage-value">'+formatBytes(data.tapsSize)+'</span></div>';
    html += '<div class="storage-row"><span class="storage-label">Analytics</span><span class="storage-value">'+formatBytes(data.analyticsSize)+'</span></div>';
    html += '<div class="storage-row"><span class="storage-label">Settings</span><span class="storage-value">'+formatBytes(data.settingsSize)+'</span></div>';
    html += '<div class="storage-row" style="border-top:1px solid rgba(255,255,255,.1);padding-top:12px;margin-top:8px"><span class="storage-label" style="font-weight:600;color:rgba(255,255,255,.7)">Total</span><span class="storage-value" style="color:#2dd4bf">'+formatBytes(data.totalSize)+'</span></div>';
    html += '</div>';

    // Records Count
    html += '<div class="storage-card"><h4>Records</h4>';
    html += '<div class="storage-row"><span class="storage-label">Total leads</span><span class="storage-value">'+data.leadsCount+'</span></div>';
    html += '<div class="storage-row"><span class="storage-label">Total tap sessions</span><span class="storage-value">'+data.tapsCount+'</span></div>';
    html += '</div>';

    // Free Tier Usage
    html += '<div class="storage-card"><h4>Free Tier Usage</h4>';
    html += '<div class="storage-bar"><div class="storage-bar-track"><div class="storage-bar-fill" style="width:'+Math.min(data.storagePercent, 100)+'%"></div></div>';
    html += '<div class="storage-bar-label"><span>Storage: '+formatBytes(data.totalSize)+' / 1 GB</span><span>'+data.storagePercent.toFixed(4)+'%</span></div></div>';
    html += '<div class="storage-bar" style="margin-top:16px"><div class="storage-bar-track"><div class="storage-bar-fill" style="width:'+Math.min(data.downloadPercent, 100)+'%"></div></div>';
    html += '<div class="storage-bar-label"><span>Est. downloads: '+formatBytes(data.estimatedMonthlyDownload)+' / 10 GB</span><span>'+data.downloadPercent.toFixed(4)+'%</span></div></div>';
    html += '</div>';

    // Cost Estimate
    html += '<div class="storage-card"><h4>Estimated Monthly Cost</h4>';
    if (data.totalCost === 0) {
        html += '<div class="storage-row"><span class="storage-label">Status</span><span class="storage-value cost-free">Within free tier</span></div>';
        html += '<div class="storage-row"><span class="storage-label">Monthly cost</span><span class="storage-value cost-free">$0.00</span></div>';
    } else {
        html += '<div class="storage-row"><span class="storage-label">Storage overage</span><span class="storage-value cost-paid">$'+data.storageCost.toFixed(2)+'</span></div>';
        html += '<div class="storage-row"><span class="storage-label">Download overage</span><span class="storage-value cost-paid">$'+data.downloadCost.toFixed(2)+'</span></div>';
        html += '<div class="storage-row"><span class="storage-label">Total</span><span class="storage-value cost-paid">$'+data.totalCost.toFixed(2)+'/mo</span></div>';
    }
    html += '</div>';

    // Info Note
    html += '<p class="storage-note">Firebase Spark (free) plan includes 1 GB storage and 10 GB/month downloads. Blaze plan charges $5/GB stored and $1/GB downloaded beyond free limits. Download estimate assumes ~100 page loads/month.</p>';

    document.getElementById('storageContent').innerHTML = html;
}

// â”€â”€ Review Queue â”€â”€
var reviewItems = [];

function checkReviewQueue() {
    fetch(DB+'/leads.json?orderBy="needsReview"&equalTo=true').then(function(r){return r.json()}).then(function(data) {
        var count = data ? Object.keys(data).length : 0;
        var btn = document.getElementById('reviewBtn');
        if (count > 0) {
            btn.className = 'idle-btn review-btn has-items';
            btn.innerHTML = 'Review Cards <span class="review-badge">'+count+'</span>';
        } else {
            btn.className = 'idle-btn review-btn';
            btn.innerHTML = 'Review Cards';
        }
    }).catch(function(){});
}

function showReviewQueue() {
    var panel = document.getElementById('reviewQueue');
    panel.classList.add('show');
    panel.style.display = 'block';
    document.getElementById('reviewList').innerHTML = '<div class="leads-empty">Loading...</div>';
    loadReviewItems();
}

function hideReviewQueue() {
    document.getElementById('reviewQueue').style.display = 'none';
    document.getElementById('reviewQueue').classList.remove('show');
    checkReviewQueue();
}

function loadReviewItems() {
    fetch(DB+'/leads.json').then(function(r){return r.json()}).then(function(data) {
        if (!data) { reviewItems = []; renderReviewItems(); return; }

        var items = [];
        for (var k in data) {
            var l = data[k];
            if (l && l.needsReview && l.cardImage) {
                l._id = k;
                items.push(l);
            }
        }
        items.sort(function(a,b){ return (b.ts||0)-(a.ts||0); });
        reviewItems = items;
        renderReviewItems();
    }).catch(function(){
        document.getElementById('reviewList').innerHTML = '<div class="leads-empty">Failed to load</div>';
    });
}

function renderReviewItems() {
    var list = document.getElementById('reviewList');
    document.getElementById('reviewCount').textContent = reviewItems.length + ' pending';

    if (reviewItems.length === 0) {
        list.innerHTML = '<div class="leads-empty">No cards to review</div>';
        return;
    }

    var html = '';
    reviewItems.forEach(function(item, idx) {
        var timeStr = item.ts ? new Date(item.ts).toLocaleString('en-IN', {day:'numeric',month:'short',hour:'2-digit',minute:'2-digit'}) : '';

        html += '<div class="review-item" data-id="'+item._id+'" data-idx="'+idx+'">';
        html += '<div class="review-time">'+timeStr+' Â· '+(item.visitor?item.visitor.device:'Unknown')+'</div>';
        html += '<img class="review-img" src="'+item.cardImage+'" id="reviewImg'+idx+'">';
        html += '<button class="review-ocr-btn" onclick="runOCR('+idx+')" id="ocrBtn'+idx+'"><svg viewBox="0 0 24 24"><path d="M9.5 6.5v3h-3v-3h3M11 5H5v6h6V5zm-1.5 9.5v3h-3v-3h3M11 13H5v6h6v-6zm6.5-6.5v3h-3v-3h3M19 5h-6v6h6V5z"/></svg>Extract text with OCR</button>';
        html += '<div class="review-field"><label>Name</label><input type="text" id="revName'+idx+'" placeholder="Name"></div>';
        html += '<div class="review-field"><label>Phone</label><input type="tel" id="revPhone'+idx+'" placeholder="Phone"></div>';
        html += '<div class="review-field"><label>Email</label><input type="email" id="revEmail'+idx+'" placeholder="Email"></div>';
        html += '<div class="review-field"><label>Company</label><input type="text" id="revCompany'+idx+'" placeholder="Company"></div>';
        html += '<div class="review-actions">';
        html += '<button class="review-save" onclick="saveReview('+idx+')">Save & Delete Image</button>';
        html += '<button class="review-skip" onclick="skipReview('+idx+')">Skip</button>';
        html += '</div></div>';
    });
    list.innerHTML = html;
}

function runOCR(idx) {
    var item = reviewItems[idx];
    if (!item) return;

    var btn = document.getElementById('ocrBtn'+idx);
    btn.classList.add('scanning');
    btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M9.5 6.5v3h-3v-3h3M11 5H5v6h6V5zm-1.5 9.5v3h-3v-3h3M11 13H5v6h6v-6zm6.5-6.5v3h-3v-3h3M19 5h-6v6h6V5z"/></svg>Scanning...';

    Tesseract.recognize(item.cardImage, 'eng', {
        logger: function(m) {
            if (m.status === 'recognizing text') {
                var pct = Math.round(m.progress * 100);
                btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M9.5 6.5v3h-3v-3h3M11 5H5v6h6V5zm-1.5 9.5v3h-3v-3h3M11 13H5v6h6v-6zm6.5-6.5v3h-3v-3h3M19 5h-6v6h6V5z"/></svg>'+pct+'%';
            }
        }
    }).then(function(result) {
        var text = result.data.text;
        parseAndFillReview(idx, text);
        btn.classList.remove('scanning');
        btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>Done! Edit below.';
    }).catch(function(err) {
        console.error('OCR error:', err);
        btn.classList.remove('scanning');
        btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M9.5 6.5v3h-3v-3h3M11 5H5v6h6V5z"/></svg>OCR failed - fill manually';
    });
}

function parseAndFillReview(idx, text) {
    var lines = text.split('\n').map(function(l){ return l.trim(); }).filter(function(l){ return l.length > 0; });
    var fullText = text.replace(/\n/g, ' ');

    // Extract email
    var emailMatch = fullText.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/);
    if (emailMatch) {
        document.getElementById('revEmail'+idx).value = emailMatch[0].toLowerCase();
    }

    // Extract phone
    var phonePatterns = [
        /(?:\+?91[-.\s]?)?[6-9]\d{9}/,
        /(?:\+?1[-.\s]?)?\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}/,
        /(?:\+?\d{1,3}[-.\s]?)?\d{2,4}[-.\s]?\d{3,4}[-.\s]?\d{3,4}/
    ];
    for (var i = 0; i < phonePatterns.length; i++) {
        var phoneMatch = fullText.match(phonePatterns[i]);
        if (phoneMatch) {
            var phone = phoneMatch[0].replace(/[^\d+]/g, '');
            if (phone.length >= 10) {
                document.getElementById('revPhone'+idx).value = phoneMatch[0].trim();
                break;
            }
        }
    }

    // Extract name
    var skipWords = ['pvt','ltd','llc','inc','corp','limited','private','company','solutions','technologies','services','www','http','email','phone','tel','fax','address'];
    for (var i = 0; i < Math.min(lines.length, 5); i++) {
        var line = lines[i];
        var lower = line.toLowerCase();
        if (line.indexOf('@') !== -1) continue;
        if (lower.indexOf('www') !== -1) continue;
        if (/\d{5,}/.test(line)) continue;
        var hasSkipWord = skipWords.some(function(w){ return lower.indexOf(w) !== -1; });
        if (hasSkipWord) continue;
        var words = line.split(/\s+/).filter(function(w){ return w.length > 1; });
        if (words.length >= 2 && words.length <= 4) {
            var letterRatio = (line.replace(/[^a-zA-Z\s]/g, '').length / line.length);
            if (letterRatio > 0.8) {
                document.getElementById('revName'+idx).value = line;
                break;
            }
        }
    }

    // Extract company
    var companyKeywords = ['pvt','ltd','llc','inc','corp','limited','private','company','solutions','technologies','services','group','enterprises','industries'];
    for (var i = 0; i < lines.length; i++) {
        var line = lines[i];
        var lower = line.toLowerCase();
        if (line.indexOf('@') !== -1) continue;
        var hasCompanyWord = companyKeywords.some(function(w){ return lower.indexOf(w) !== -1; });
        if (hasCompanyWord && line.length > 3) {
            document.getElementById('revCompany'+idx).value = line;
            break;
        }
    }
}

function saveReview(idx) {
    var item = reviewItems[idx];
    if (!item) return;

    var name = document.getElementById('revName'+idx).value.trim();
    var phone = document.getElementById('revPhone'+idx).value.trim();
    var email = document.getElementById('revEmail'+idx).value.trim();
    var company = document.getElementById('revCompany'+idx).value.trim();

    // Update lead with extracted data, remove image, mark as reviewed
    var updateData = {
        name: name,
        phone: phone,
        email: email,
        company: company,
        needsReview: null, // delete this field
        cardImage: null,   // delete image to save space
        reviewedAt: {'.sv':'timestamp'}
    };

    fetch(DB+'/leads/'+item._id+'.json', {method:'PATCH', body:JSON.stringify(updateData)}).then(function() {
        // Remove from list
        reviewItems.splice(idx, 1);
        renderReviewItems();
        loadStats();
    });
}

function skipReview(idx) {
    var item = reviewItems[idx];
    if (!item) return;

    // Just remove needsReview flag but keep the image
    fetch(DB+'/leads/'+item._id+'/needsReview.json', {method:'DELETE'}).then(function() {
        reviewItems.splice(idx, 1);
        renderReviewItems();
    });
}

// Check review queue on load
checkReviewQueue();
setInterval(checkReviewQueue, 30000); // Check every 30 seconds

function esc(s) { return s.replace(/\\/g,'\\\\').replace(/'/g,"\\'"); }

function saveLead(name, phone, email, company) {
    var parts = name.split(' ');
    var last = parts.length > 1 ? parts.pop() : '';
    var first = parts.join(' ') || name;
    var lines = ['BEGIN:VCARD','VERSION:3.0'];
    if (name) { lines.push('N:'+last+';'+first+';;;'); lines.push('FN:'+name); }
    if (company) lines.push('ORG:'+company);
    if (phone) lines.push('TEL;TYPE=CELL:'+phone);
    if (email) lines.push('EMAIL;TYPE=INTERNET:'+email);
    lines.push('END:VCARD');
    var blob = new Blob([lines.join('\n')], {type:'text/vcard;charset=utf-8'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = (name||'contact').replace(/\s/g,'_')+'.vcf';
    document.body.appendChild(a); a.click();
    setTimeout(function(){ document.body.removeChild(a); URL.revokeObjectURL(url); },100);
}

// Init
updateNotifUI();
if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(function(){});
</script>
</body>
</html>
